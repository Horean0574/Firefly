This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
assets/images/avatar.avif
assets/images/cover.avif
assets/images/DesktopWallpaper/d1.avif
assets/images/DesktopWallpaper/d2.avif
assets/images/DesktopWallpaper/d3.avif
assets/images/DesktopWallpaper/d4.avif
assets/images/DesktopWallpaper/d5.avif
assets/images/DesktopWallpaper/d6.avif
assets/images/firefly.png
assets/images/MobileWallpaper/m1.avif
assets/images/MobileWallpaper/m2.avif
assets/images/MobileWallpaper/m3.avif
assets/images/MobileWallpaper/m4.avif
assets/images/MobileWallpaper/m5.avif
assets/images/MobileWallpaper/m6.avif
components/analytics/GoogleAnalytics.astro
components/analytics/MicrosoftClarity.astro
components/comment/Artalk.astro
components/comment/Disqus.astro
components/comment/Giscus.astro
components/comment/index.astro
components/comment/Twikoo.astro
components/comment/Waline.astro
components/common/ButtonLink.astro
components/common/ButtonTag.astro
components/common/ClientPagination.astro
components/common/CoverImage.astro
components/common/DropdownItem.astro
components/common/DropdownItem.svelte
components/common/DropdownPanel.astro
components/common/DropdownPanel.svelte
components/common/FloatingButton.astro
components/common/Icon.svelte
components/common/ImageWrapper.astro
components/common/Markdown.astro
components/common/Pagination.astro
components/common/PioMessageBox.astro
components/common/WidgetLayout.astro
components/controls/ArchivePanel.svelte
components/controls/BackToHome.astro
components/controls/BackToTop.astro
components/controls/DisplaySettings.svelte
components/controls/DisplaySettingsIntegrated.svelte
components/controls/FloatingControls.astro
components/controls/FloatingTOC.astro
components/controls/LayoutSwitchButton.svelte
components/controls/LightDarkSwitch.svelte
components/controls/Search.svelte
components/controls/WallpaperSwitch.svelte
components/features/FancyboxManager.astro
components/features/FontManager.astro
components/features/KatexManager.astro
components/features/Live2DWidget.astro
components/features/MusicManager.astro
components/features/MusicPlayer.astro
components/features/SakuraEffect.astro
components/features/SpineModel.astro
components/features/TypewriterText.astro
components/layout/CategoryBar.astro
components/layout/ConfigCarrier.astro
components/layout/DropdownMenu.astro
components/layout/Footer.astro
components/layout/Navbar.astro
components/layout/NavMenuPanel.astro
components/layout/PostCard.astro
components/layout/PostMeta.astro
components/layout/PostPage.astro
components/layout/SideBar.astro
components/misc/License.astro
components/misc/SharePoster.svelte
components/pages/AdvancedSearch.svelte
components/pages/bangumi/BangumiSection.astro
components/pages/bangumi/Card.astro
components/pages/bangumi/FilterControls.astro
components/pages/bangumi/TabNav.astro
components/README.md
components/widget/Advertisement.astro
components/widget/Announcement.astro
components/widget/Calendar.astro
components/widget/Categories.astro
components/widget/Live2DWidget.astro
components/widget/Music.astro
components/widget/Profile.astro
components/widget/SidebarTOC.astro
components/widget/SiteStats.astro
components/widget/SpineModel.astro
components/widget/Tags.astro
config/adConfig.ts
config/announcementConfig.ts
config/backgroundWallpaper.ts
config/commentConfig.ts
config/coverImageConfig.ts
config/expressiveCodeConfig.ts
config/fontConfig.ts
config/FooterConfig.html
config/footerConfig.ts
config/friendsConfig.ts
config/index.ts
config/licenseConfig.ts
config/momentsConfig.ts
config/musicConfig.ts
config/navBarConfig.ts
config/pioConfig.ts
config/profileConfig.ts
config/README.md
config/sakuraConfig.ts
config/sidebarConfig.ts
config/siteConfig.ts
config/sponsorConfig.ts
constants/constants.ts
constants/icon.ts
constants/icons.ts
constants/link-presets.ts
content.config.ts
content/posts/【实用技巧】-如何解决双重根式化简.md
content/posts/【探究】含60°角的三角形.md
content/posts/【习题解析】-如何解决双重根式化简.md
content/posts/2023 TYOI 暑假集训游记.md
content/posts/2023年CSP比赛游记.md
content/posts/2025-Weekly-Diary-1st.md
content/posts/关于一道高一上压轴题的深度解析.md
content/posts/好题评估——2025-广州中考第-25-题.md
content/posts/几何之利刃——反演变换（1）.md
content/posts/看透多动点的本质——旋心.md
content/posts/老师二三事.md
content/posts/浅谈圆幂定理.md
content/posts/数据迁移之「从 Waline 到 Twikoo」.md
content/posts/双动线段比例最值问题——反演变换（2）.md
content/posts/我的个人主页搭建记录.md
content/posts/新高一，新题型.md
content/posts/GitHub-PicGo-搭建一个属于自己的图床.md
content/posts/Hexo-Redefine-Theme-踩过的坑.md
content/posts/Horean-的持续创作-爱发电-的注册.md
content/posts/LeanCloud停止对外服务&第一次博客迁移.md
content/posts/luogu-HXOI-U330374-密室逃脱.md
content/posts/luogu-HXOI-U331150-密室逃脱2.md
content/posts/luogu-HXOI-U332989-身高.md
content/posts/oiClass-puji-P1278-树和数tree.md
content/posts/oiClass-puji-P21120-征兵.md
content/spec/about.md
content/spec/friends.md
content/spec/guestbook.md
content/spec/moments.md
env.d.ts
global.d.ts
i18n/i18nKey.ts
i18n/languages/en.ts
i18n/languages/ja.ts
i18n/languages/ru.ts
i18n/languages/zh_CN.ts
i18n/languages/zh_TW.ts
i18n/translation.ts
layouts/Layout.astro
layouts/MainGridLayout.astro
pages/[...page].astro
pages/404.astro
pages/about.astro
pages/api/calendar.json.ts
pages/archive.astro
pages/bangumi.astro
pages/friends.astro
pages/guestbook.astro
pages/moments.astro
pages/og/[...slug].png.ts
pages/posts/[...slug].astro
pages/robots.txt.ts
pages/rss.astro
pages/rss.xml.ts
pages/search.astro
pages/sponsor.astro
plugins/mermaid-render-script.js
plugins/rehype-component-github-card.mjs
plugins/rehype-email-protection.mjs
plugins/rehype-external-links.mjs
plugins/rehype-figure.mjs
plugins/rehype-mermaid.mjs
plugins/remark-directive-rehype.js
plugins/remark-excerpt.js
plugins/remark-mermaid.js
plugins/remark-reading-time.mjs
styles/banner-title.css
styles/custom-scrollbar.css
styles/expressive-code.css
styles/fancybox-custom.css
styles/layout-styles.css
styles/main.css
styles/markdown-extend.styl
styles/markdown.css
styles/navbar.css
styles/photoswipe.css
styles/scrollbar.css
styles/toc.css
styles/transition.css
styles/twikoo.css
styles/variables.styl
styles/waves.css
styles/widget-responsive.css
types/bangumi.ts
types/config.ts
utils/content-utils.ts
utils/date-utils.ts
utils/icon-loader.ts
utils/image-utils.ts
utils/language-utils.ts
utils/layout-utils.ts
utils/navigation-utils.ts
utils/responsive-utils.ts
utils/sakura-manager.ts
utils/setting-utils.ts
utils/tocUtils.ts
utils/url-utils.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="components/analytics/GoogleAnalytics.astro">
---
interface Props {
	analyticsId: string;
}

const { analyticsId } = Astro.props;
---

<!-- Google tag (gtag.js) -->
<script is:inline data-swup-ignore-script async src={`https://www.googletagmanager.com/gtag/js?id=${analyticsId}`}></script>
<script is:inline data-swup-ignore-script define:vars={{analyticsId}}>window.dataLayer = window.dataLayer || [];

function gtag() {
    dataLayer.push(arguments);
}

gtag('js', new Date());
gtag('config', analyticsId);
</script>
</file>

<file path="components/analytics/MicrosoftClarity.astro">
---
interface Props {
	clarityId: string;
}

const { clarityId } = Astro.props;
---

<script is:inline data-swup-ignore-script define:vars={{ clarityId }}>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", clarityId);
</script>
</file>

<file path="components/comment/Artalk.astro">
---
import { commentConfig, siteConfig } from "@/config";

interface Props {
	path: string;
}

const config = {
	...commentConfig.artalk,
	el: "#artalk",
	site: siteConfig.title,
	pageKey: Astro.props.path,
	dark: "html.dark",
	pageTitle: "",
	...(commentConfig.artalk?.visitorCount ? { pageview: true } : {}),
};
---
<!-- Artalk -->
<div class="relative w-full">
    <!-- 挂载点 -->
    <div id="artalk" style="--at-color-main: var(--primary); --at-color-bg: var(--card-bg); --at-color-border: var(--line-divider);"></div>

    <!-- 引入 Artalk 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/artalk/dist/Artalk.css"/>

    <!-- 脚本逻辑 -->
    <script type="module" is:inline define:vars={{config}}>
        import Artalk from 'https://unpkg.com/artalk/dist/Artalk.mjs';

        // 初始化 Artalk
        const artalk = Artalk.init(config);

        // 深色模式
        function updateTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            artalk.setDarkMode(isDark);
        }

        updateTheme();

        const observer = new MutationObserver((_mutations) => {
            updateTheme();
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class'],
        });
    </script>
</div>
</file>

<file path="components/comment/Disqus.astro">
---
import { commentConfig } from "@/config";

interface Props {
	identifier: string;
	url: string;
	title: string;
}

const { identifier, url, title } = Astro.props;

if (!commentConfig || !commentConfig.disqus) {
	throw new Error("Disqus comments are not configured");
}
const shortname = commentConfig.disqus.shortname;
---

<div id="disqus_thread"></div>

<script is:inline define:vars={{ shortname, identifier, url, title }}>
  // @ts-ignore
  window.disqus_config = function () {
    this.page.url = url
    this.page.identifier = identifier
    this.page.title = title
  }

  ;(function () {
    var d = document,
      s = d.createElement('script')
    s.src = 'https://' + shortname + '.disqus.com/embed.js'
    s.setAttribute('data-timestamp', new Date().toString())
    ;(d.head || d.body).appendChild(s)
  })()
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<style is:global></style>
</file>

<file path="components/comment/Giscus.astro">
---
import { commentConfig } from "@/config";

if (!commentConfig || !commentConfig.giscus) {
	throw new Error("Giscus comments are not configured");
}

const giscus = commentConfig.giscus;
const lightTheme = "light";
const darkTheme = "dark";
---

<script is:inline type="module" src="https://esm.sh/giscus"></script>

<!-- 
  Giscus 官方Web Component用法，兼容Astro静态输出，无需import包，无需NPM依赖！
  参考：https://giscus.app/ 详情配置说明
-->
<giscus-widget
  id="comments"
  repo={giscus.repo}
  repoId={giscus.repoId}
  category={giscus.category}
  categoryId={giscus.categoryId}
  mapping={giscus.mapping}
  strict={giscus.strict}
  reactionsEnabled={giscus.reactionsEnabled}
  emitMetadata={giscus.emitMetadata}
  inputPosition={giscus.inputPosition}
  theme={lightTheme}
  lang={giscus.lang}
  loading={giscus.loading}
/>

<script is:inline define:vars={{ lightTheme, darkTheme }}>
  function updateGiscusTheme() {
    const isDark = document.documentElement.classList.contains('dark');
    const theme = isDark ? darkTheme : lightTheme;
    const widget = document.querySelector('giscus-widget');
    if (widget) {
      widget.setAttribute('theme', theme);
    }
  }

  // Initial update
  updateGiscusTheme();

  // Clean up previous observer if exists
  if (window.giscusThemeObserver) {
    window.giscusThemeObserver.disconnect();
  }

  // Create new observer
  window.giscusThemeObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        updateGiscusTheme();
      }
    });
  });

  window.giscusThemeObserver.observe(document.documentElement, { attributes: true });
</script>
</file>

<file path="components/comment/index.astro">
---
import type { CollectionEntry } from "astro:content";
import { commentConfig } from "@/config/commentConfig";
import Key from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { removeFileExtension } from "@/utils/url-utils";
import Artalk from "./Artalk.astro";
import Disqus from "./Disqus.astro";
import Giscus from "./Giscus.astro";
import Twikoo from "./Twikoo.astro";
import Waline from "./Waline.astro";

interface Props {
	post: CollectionEntry<"posts"> | CollectionEntry<"spec">;
	customPath?: string;
}

const { post, customPath } = Astro.props;
const { id } = post;

// 根据页面类型确定路径
const slug = removeFileExtension(id);
const path =
	customPath || (post.collection === "posts" ? `/posts/${slug}` : `/${slug}`);
const url = `${Astro.site?.href}${path}`;

// 强制commentService类型为string，避免类型不兼容警告
let commentService: string = commentConfig?.type || "none";
---

{
  commentService !== "none" && (
    <div class="card-base p-8 mb-6 relative overflow-hidden">
      <!-- 评论区装饰性背景 -->
      <div class="absolute top-0 right-0 w-32 h-32 opacity-5 pointer-events-none">
        <svg viewBox="0 0 100 100" class="w-full h-full">
          <circle cx="50" cy="50" r="40" fill="currentColor" class="text-(--primary)" />
          <circle cx="50" cy="50" r="25" fill="none" stroke="currentColor" stroke-width="2" class="text-(--primary)" />
          <circle cx="50" cy="50" r="10" fill="currentColor" class="text-(--primary)" />
        </svg>
      </div>
      <!-- 评论区标题 -->
      <div class="relative z-10 mb-6">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-1 h-6 bg-linear-to-b from-(--primary) to-transparent rounded-full"></div>
          <h3 class="text-xl font-bold text-(--btn-content)">{i18n(Key.commentSection)}</h3>
        </div>
        <p class="text-sm text-(--content-meta) ml-4">{i18n(Key.commentSubtitle)}</p>
      </div>
      <!-- 评论内容区域 -->
      <div class="relative z-10">
        {commentService === "twikoo" && <Twikoo path={path} />}
        {commentService === "waline" && <Waline path={path} />}
        {commentService === "giscus" && <Giscus />}
        {commentService === "disqus" && <Disqus identifier={slug} url={url} title={'title' in post.data ? post.data.title : slug} />}
          {commentService === "artalk" && <Artalk path={path} />}
        {commentService === "none" && (
          <div class="text-center py-8 text-(--content-meta)">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-(--btn-regular-bg) flex items-center justify-center">
              <svg class="w-8 h-8 text-(--primary)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
            </div>
            <p>{i18n(Key.commentNotConfigured)}</p>
          </div>
        )}
      </div>
    </div>
  )
}
</file>

<file path="components/comment/Twikoo.astro">
---
import { commentConfig } from "@/config/commentConfig";
import { url } from "@/utils/url-utils";
import "@/styles/twikoo.css";

interface Props {
	path: string;
}

const config = {
	...commentConfig.twikoo,
	el: "#tcomment",
	path: Astro.props.path,
};
---

<div id="tcomment"></div>
<!-- 使用自编译的 Twikoo 文件，避免点赞等按钮导致页面触发滚动回顶部 https://github.com/twikoojs/twikoo/issues/721 -->
<script is:inline src={url("/assets/js/firefly-twikoo-1.6.44.all.min.js")}></script>
<script is:inline define:vars={{ config }}>
  // 获取当前页面路径
  function getCurrentPath() {
    const pathname = window.location.pathname;
    return pathname.endsWith("/") && pathname.length > 1
      ? pathname.slice(0, -1)
      : pathname;
  }

  // 动态创建配置对象
  function createTwikooConfig() {
    return {
      ...config,
      path: getCurrentPath(),
      el: "#tcomment",
    };
  }

  // 初始化 Twikoo
  function initTwikoo() {
    if (typeof twikoo !== "undefined") {
      const commentEl = document.getElementById("tcomment");
      if (commentEl) {
        commentEl.innerHTML = "";

        const dynamicConfig = createTwikooConfig();
        console.log("[Twikoo] 初始化配置:", dynamicConfig);

        twikoo
          .init(dynamicConfig)
          .then(() => {
            console.log("[Twikoo] 初始化完成");
          })
          .catch((error) => {
            console.error("[Twikoo] 初始化失败:", error);
          });
      }
    } else {
      // 如果 Twikoo 未加载，稍后重试
      setTimeout(initTwikoo, 500);
    }
  }

  // 页面加载时初始化
  document.addEventListener("DOMContentLoaded", initTwikoo);

  // Swup 页面切换后重新初始化
  if (window.swup && window.swup.hooks) {
    window.swup.hooks.on("content:replace", function () {
      setTimeout(initTwikoo, 200);
    });
  } else {
    document.addEventListener("swup:enable", function () {
      if (window.swup && window.swup.hooks) {
        window.swup.hooks.on("content:replace", function () {
          setTimeout(initTwikoo, 200);
        });
      }
    });
  }

  // 自定义事件监听
  document.addEventListener("firefly:page:loaded", function () {
    const commentEl = document.getElementById("tcomment");
    if (commentEl) {
      console.log("[Twikoo] 通过自定义事件重新初始化");
      initTwikoo();
    }
  });
</script>
</file>

<file path="components/comment/Waline.astro">
---
import { commentConfig } from "@/config";

interface Props {
	path: string;
}

const config = {
	...commentConfig.waline,
	el: "#waline",
	path: Astro.props.path,
	dark: "html.dark",
	wordLimit: ["2", "300"],
	...(commentConfig.waline?.visitorCount ? { pageview: true } : {}),
};
---
<!-- Waline -->
<div class="relative w-full">
  <div id="waline"></div>
  <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
  <script type="module" is:inline define:vars={{ config }}>
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init(config);
  </script>
</div>
</file>

<file path="components/common/ButtonLink.astro">
---
interface Props {
	badge?: string;
	url?: string;
	label?: string;
}
const { badge, url, label } = Astro.props;
---
<a href={url} aria-label={label}>
    <button
        class:list={`
            w-full
            h-10
            rounded-lg
            bg-none
            hover:bg-(--btn-plain-bg-hover)
            active:bg-(--btn-plain-bg-active)
            transition-all
            pl-2
            hover:pl-3
            
            text-neutral-700
            hover:text-(--primary)
            dark:text-neutral-300
            dark:hover:text-(--primary)
        `
        }
    >
        <div class="flex items-center justify-between relative mr-2">
            <div class="overflow-hidden text-left whitespace-nowrap text-ellipsis  ">
                <slot></slot>
            </div>
            { badge !== undefined && badge !== null && badge !== '' &&
                <div class="transition px-2 h-7 ml-4 min-w-8 rounded-lg text-sm font-bold
                    text-(--btn-content) dark:text-(--deep-text)
                    bg-[oklch(0.95_0.025_var(--hue))] dark:bg-(--primary)
                    flex items-center justify-center">
                    { badge }
                </div>
            }
        </div>
    </button>
</a>
</file>

<file path="components/common/ButtonTag.astro">
---
interface Props {
	size?: string;
	dot?: boolean;
	href?: string;
	label?: string;
}
const { dot, href, label }: Props = Astro.props;
---
<a href={href} aria-label={label} class="btn-regular h-8 text-sm px-3 rounded-lg">
    {dot && <div class="h-1 w-1 bg-(--btn-content) dark:bg-(--card-bg) transition rounded-md mr-2"></div>}
    <slot></slot>
</a>
</file>

<file path="components/common/ClientPagination.astro">
---
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

interface Props {
	totalItems: number;
	itemsPerPage: number;
	currentPage: number;
	sectionId: string;
}

const { totalItems, itemsPerPage, currentPage, sectionId } = Astro.props;
const totalPages = Math.ceil(totalItems / itemsPerPage);

// 生成智能分页页码数组
function generatePageNumbers(current: number, total: number) {
	const delta = 2; // 当前页左右显示的页码数量
	const range: number[] = [];
	const rangeWithDots: (number | string)[] = [];

	// 如果总页数小于等于7，显示所有页码
	if (total <= 7) {
		for (let i = 1; i <= total; i++) {
			range.push(i);
		}
		return range;
	}

	// 计算显示范围
	const left = Math.max(2, current - delta);
	const right = Math.min(total - 1, current + delta);

	// 始终显示第一页
	rangeWithDots.push(1);

	// 如果左边界大于2，添加省略号
	if (left > 2) {
		rangeWithDots.push("...");
	}

	// 添加中间页码
	for (let i = left; i <= right; i++) {
		rangeWithDots.push(i);
	}

	// 如果右边界小于最后一页-1，添加省略号
	if (right < total - 1) {
		rangeWithDots.push("...");
	}

	// 始终显示最后一页（如果总页数大于1）
	if (total > 1) {
		rangeWithDots.push(total);
	}

	return rangeWithDots;
}

const pageNumbers = generatePageNumbers(currentPage, totalPages);
---

{totalPages > 1 && (
  <div class="responsive-pagination flex justify-center items-center mt-8" data-pagination-section={sectionId}>
    <!-- 移动端简化版分页 -->
    <div class="mobile-pagination items-center gap-3">
      <button
        type="button"
        class="btn-card overflow-hidden rounded-lg text-(--primary) w-11 h-11 disabled:opacity-50 disabled:cursor-not-allowed"
        data-page="prev"
        data-section={sectionId}
        disabled={currentPage === 1}
        aria-label={i18n(I18nKey.bangumiPrevPage)}
      >
        <Icon name="material-symbols:chevron-left-rounded" class="text-[1.75rem]" />
      </button>

      <!-- 移动端页码信息 -->
      <div class="bg-(--card-bg) flex items-center rounded-lg px-4 h-11 gap-1.5">
        <span class="mobile-current-page text-base font-bold text-(--primary)">{currentPage}</span>
        <span class="text-sm text-neutral-500 dark:text-neutral-500">/</span>
        <span class="mobile-total-pages text-base font-bold text-neutral-700 dark:text-neutral-300">{totalPages}</span>
      </div>

      <button
        type="button"
        class="btn-card overflow-hidden rounded-lg text-(--primary) w-11 h-11 disabled:opacity-50 disabled:cursor-not-allowed"
        data-page="next"
        data-section={sectionId}
        disabled={currentPage === totalPages}
        aria-label={i18n(I18nKey.bangumiNextPage)}
      >
        <Icon name="material-symbols:chevron-right-rounded" class="text-[1.75rem]" />
      </button>
    </div>

    <!-- 桌面端完整版分页 -->
    <div class="desktop-pagination items-center gap-3">
      <button
        type="button"
        class="btn-card overflow-hidden rounded-lg text-(--primary) w-11 h-11 disabled:opacity-50 disabled:cursor-not-allowed"
        data-page="prev"
        data-section={sectionId}
        disabled={currentPage === 1}
        aria-label={i18n(I18nKey.bangumiPrevPage)}
      >
        <Icon name="material-symbols:chevron-left-rounded" class="text-[1.75rem]" />
      </button>

      <div class="bg-(--card-bg) flex flex-row rounded-lg items-center text-neutral-700 dark:text-neutral-300 font-bold" data-page-numbers={sectionId}>
        {pageNumbers.map((pageItem) => (
          pageItem === '...' ? (
            <Icon name="material-symbols:more-horiz" class="mx-1" />
          ) : (
            <button
              type="button"
              class:list={[
                "rounded-lg overflow-hidden w-11 h-11 flex items-center justify-center font-bold",
                {
                  "bg-(--primary) text-white dark:text-black/70": pageItem === currentPage,
                  "btn-card active:scale-[0.85]": pageItem !== currentPage
                }
              ]}
              data-page={pageItem}
              data-section={sectionId}
              aria-label={`${pageItem}`}
              aria-current={pageItem === currentPage ? "page" : undefined}
            >
              {pageItem}
            </button>
          )
        ))}
      </div>

      <button
        type="button"
        class="btn-card overflow-hidden rounded-lg text-(--primary) w-11 h-11 disabled:opacity-50 disabled:cursor-not-allowed"
        data-page="next"
        data-section={sectionId}
        disabled={currentPage === totalPages}
        aria-label={i18n(I18nKey.bangumiNextPage)}
      >
        <Icon name="material-symbols:chevron-right-rounded" class="text-[1.75rem]" />
      </button>
    </div>
  </div>
)}

<script is:inline define:vars={{ itemsPerPage, sectionId }}>
  function initPagination() {
    let currentPage = 1;

    const pagination = document.querySelector(`[data-pagination-section="${sectionId}"]`);
    if (!pagination) return;

    // 更新移动端页码显示
    function updateMobileDisplay() {
      const mobileCurrentPage = pagination.querySelector('.mobile-current-page');
      if (mobileCurrentPage) {
        mobileCurrentPage.textContent = currentPage.toString();
      }
    }

    const pageButtons = pagination.querySelectorAll('[data-page]');

    pageButtons.forEach(button => {
      button.addEventListener('click', function() {
        const page = this.dataset.page;

        if (page === 'prev') {
          currentPage = Math.max(1, currentPage - 1);
        } else if (page === 'next') {
          const items = document.querySelectorAll(`[data-item-section="${sectionId}"]:not(.hidden)`);
          const totalPages = Math.ceil(items.length / itemsPerPage);
          currentPage = Math.min(totalPages, currentPage + 1);
        } else {
          currentPage = parseInt(page);
        }

        updatePage();
        updateMobileDisplay();
      });
    });

    // Listen for filter updates
    if (pagination) {
      pagination.addEventListener('updatePagination', function(_event) {
        currentPage = 1;
        updatePage();
        updateMobileDisplay();
      });
    }

    function updatePage() {
      const items = document.querySelectorAll(`[data-item-section="${sectionId}"]:not(.hidden)`);
      const totalPages = Math.ceil(items.length / itemsPerPage);

      // Hide all items first
      for (const item of items) {
        item.style.display = 'none';
      }

      // Show items for current page
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      for (let i = startIndex; i < endIndex && i < items.length; i++) {
        items[i].style.display = 'block';
      }

      // Update pagination buttons
      updatePaginationButtons(totalPages);
    }

    // 生成智能分页页码数组的JavaScript版本
    function generatePageNumbers(current, total) {
      const delta = 2; // 当前页左右显示的页码数量
      const rangeWithDots = [];

      // 如果总页数小于等于7，显示所有页码
      if (total <= 7) {
        for (let i = 1; i <= total; i++) {
          rangeWithDots.push(i);
        }
        return rangeWithDots;
      }

      // 计算显示范围
      const left = Math.max(2, current - delta);
      const right = Math.min(total - 1, current + delta);

      // 始终显示第一页
      rangeWithDots.push(1);

      // 如果左边界大于2，添加省略号
      if (left > 2) {
        rangeWithDots.push('...');
      }

      // 添加中间页码
      for (let i = left; i <= right; i++) {
        rangeWithDots.push(i);
      }

      // 如果右边界小于最后一页-1，添加省略号
      if (right < total - 1) {
        rangeWithDots.push('...');
      }

      // 始终显示最后一页（如果总页数大于1）
      if (total > 1) {
        rangeWithDots.push(total);
      }

      return rangeWithDots;
    }

    function updatePaginationButtons(totalPages) {
      // 更新所有的上一页和下一页按钮（移动端和桌面端）
      const prevButtons = pagination.querySelectorAll('[data-page="prev"]');
      const nextButtons = pagination.querySelectorAll('[data-page="next"]');
      const pageNumbersContainer = pagination.querySelector(`[data-page-numbers="${sectionId}"]`);

      prevButtons.forEach(btn => {
        btn.disabled = currentPage === 1;
      });

      nextButtons.forEach(btn => {
        btn.disabled = currentPage === totalPages;
      });

      if (pageNumbersContainer) {
        pageNumbersContainer.innerHTML = '';
        const pageNumbers = generatePageNumbers(currentPage, totalPages);

        pageNumbers.forEach(pageItem => {
          if (pageItem === '...') {
            // 创建省略号图标
            const iconContainer = document.createElement('span');
            iconContainer.innerHTML = '<svg class="mx-1" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>';
            pageNumbersContainer.appendChild(iconContainer.firstChild);
          } else {
            const button = document.createElement('button');
            button.className = pageItem === currentPage
              ? 'rounded-lg overflow-hidden w-11 h-11 flex items-center justify-center font-bold bg-(--primary) text-white dark:text-black/70'
              : 'rounded-lg overflow-hidden w-11 h-11 flex items-center justify-center font-bold btn-card active:scale-[0.85]';
            button.dataset.page = pageItem.toString();
            button.dataset.section = sectionId;
            button.textContent = pageItem.toString();
            button.addEventListener('click', function() {
              currentPage = pageItem;
              updatePage();
              updateMobileDisplay();
            });
            pageNumbersContainer.appendChild(button);
          }
        });
      }
    }

    // Initial page setup
    updatePage();
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPagination);
  } else {
    initPagination();
  }
</script>

<style>
  .responsive-pagination {
    /* 确保在所有设备上都能正确显示 */
    max-width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* 移动端样式 (< 768px) */
  .mobile-pagination {
    display: flex;
    padding: 0 1rem;
  }

  .desktop-pagination {
    display: none;
  }

  /* 桌面端样式 (>= 768px) */
  @media (min-width: 768px) {
    .mobile-pagination {
      display: none;
    }

    .desktop-pagination {
      display: flex;
    }
  }

  /* 小屏手机优化 */
  @media (max-width: 640px) {
    .mobile-pagination {
      padding: 0 0.5rem;
    }
    .mobile-pagination button {
      padding: 0.25rem;
    }
  }

  /* 超小屏优化 */
  @media (max-width: 480px) {
    .mobile-pagination {
      padding: 0 0.25rem;
    }
    .mobile-pagination .space-x-1 > * + * {
      margin-left: 0.125rem;
    }
  }

  /* 平滑过渡效果 */
  .responsive-pagination button {
    transition: all 0.2s ease-in-out;
  }

  /* 高对比度模式支持 */
  @media (prefers-contrast: high) {
    .responsive-pagination button {
      border: 1px solid currentColor;
    }
  }

  /* 减少动画偏好支持 */
  @media (prefers-reduced-motion: reduce) {
    .responsive-pagination button {
      transition: none;
    }
  }

  /* 触摸设备优化 */
  @media (hover: none) and (pointer: coarse) {
    .responsive-pagination button {
      min-height: 44px; /* iOS建议的最小触摸目标 */
      min-width: 44px;
    }

    /* 移动端触摸优化 */
    .mobile-pagination button {
      min-height: 40px;
      min-width: 40px;
    }
  }

  /* 横屏手机优化 */
  @media (max-width: 768px) and (orientation: landscape) {
    .mobile-pagination {
      padding: 0 0.5rem;
    }

    .mobile-pagination button {
      padding: 0.25rem;
    }
  }
</style>
</file>

<file path="components/common/CoverImage.astro">
---
import { Picture } from "astro:assets";
import * as path from "node:path";
import type { ImageMetadata } from "astro";
import { coverImageConfig } from "@/config/coverImageConfig";
import type { ImageFormat, ResponsiveImageLayout } from "@/types/config";
import {
	getFallbackFormat,
	getImageFormats,
	getImageQuality,
} from "@/utils/image-utils";
import { url } from "@/utils/url-utils";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
	preview?: boolean;
	layout?: ResponsiveImageLayout;
	formats?: ImageFormat[];
	loading?: "lazy" | "eager";
	apiUrls?: string[];
}

const {
	id,
	src,
	alt,
	position = "center",
	basePath = "/",
	preview = false,
	layout = "constrained",
	formats = getImageFormats(),
	loading = "lazy",
	apiUrls = [],
} = Astro.props;

const configQuality = getImageQuality();
const fallbackFormat = getFallbackFormat();
const className = Astro.props.class;

// 判断图片类型
const isLocal = !(
	src.startsWith("/") ||
	src.startsWith("http") ||
	src.startsWith("https") ||
	src.startsWith("data:")
);
const isPublic = src.startsWith("/");

// 动态导入本地图片
let img: ImageMetadata | null = null;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>(
		"../../**/*.{png,jpg,jpeg,webp,avif}",
		{
			import: "default",
		},
	);
	const normalizedPath = path
		.normalize(path.join("../../", basePath, src))
		.replace(/\\/g, "/");
	const file = files[normalizedPath];
	if (file) {
		img = await file();
	} else {
		console.error(
			`[ERROR] Image not found: ${normalizedPath.replace("../../", "src/")}`,
		);
	}
}

// 加载回退图片
let fallbackImg: ImageMetadata | null = null;
const fallbackPath = coverImageConfig.randomCoverImage.fallback;
const isFallbackPublic = fallbackPath?.startsWith("/");
if (fallbackPath && !isLocal && !isFallbackPublic) {
	const files = import.meta.glob<ImageMetadata>(
		"../../**/*.{png,jpg,jpeg,webp,avif}",
		{
			import: "default",
		},
	);
	const normalizedFallbackPath = path
		.normalize(path.join("../../", fallbackPath))
		.replace(/\\/g, "/");
	const file = files[normalizedFallbackPath];
	if (file) {
		fallbackImg = await file();
	}
}

// 图片样式
const imageClass = "w-full h-full object-cover";
const imageStyle = `object-position: ${position};`;

// 响应式配置
const widths = preview ? [320, 480, 640, 960] : [800, 1200, 1600, 2000];
const sizes = preview
	? "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 320px"
	: "(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px";
const quality = preview ? Math.round(configQuality * 0.9) : configQuality;

// 是否显示加载动画
const showLoading = coverImageConfig.randomCoverImage.showLoading ?? true;
---

<div
	id={id}
	class:list={[className, "cover-image-container overflow-hidden relative"]}
	data-loading={showLoading ? "true" : "false"}
	data-api-urls={apiUrls.length > 0 ? JSON.stringify(apiUrls) : undefined}
>
	<!-- 加载动画 -->
	{showLoading && (
		<div class="loading-spinner absolute inset-0 flex items-center justify-center z-10" style="background-color: var(--card-bg);">
			<div class="spinner"></div>
		</div>
	)}

	<!-- 错误提示（覆盖在回退图片上） -->
	<div class="error-message absolute inset-0 flex items-center justify-center z-20 hidden pointer-events-none">
		<span class="text-white text-sm px-3 py-1 rounded bg-black/50">Image API Error</span>
	</div>

	<!-- 回退图片（错误时显示） -->
	{fallbackImg && (
		<div class="fallback-image absolute inset-0 hidden">
			<Picture
				src={fallbackImg}
				alt="Fallback cover"
				class={imageClass}
				style={imageStyle}
				width={preview ? 400 : 1200}
				height={preview ? 300 : 800}
				loading="lazy"
				formats={formats}
				fallbackFormat={fallbackFormat}
				quality={quality}
				widths={widths}
				sizes={sizes}
				layout={layout}
			/>
		</div>
	)}
	{!fallbackImg && isFallbackPublic && fallbackPath && (
		<div class="fallback-image absolute inset-0 hidden">
			<img
				src={url(fallbackPath)}
				alt="Fallback cover"
				class={imageClass}
				style={imageStyle}
				loading="lazy"
				decoding="async"
			/>
		</div>
	)}

	<!-- 本地图片 -->
	{isLocal && img && (
		<Picture
			src={img}
			alt={alt || ""}
			class={imageClass}
			style={imageStyle}
			width={preview ? 400 : 1200}
			height={preview ? 300 : 800}
			loading={loading}
			formats={formats}
			fallbackFormat={fallbackFormat}
			quality={quality}
			widths={widths}
			sizes={sizes}
			layout={layout}
			data-cover-img
		/>
	)}

	<!-- 远程图片 -->
	{!isLocal && (
		<img
			src={isPublic ? url(src) : src}
			alt={alt || ""}
			class={imageClass}
			style={imageStyle}
			loading={loading}
			decoding="async"
			data-cover-img
			data-remote="true"
		/>
	)}
</div>

<style>
	.cover-image-container {
		min-height: 150px;
	}

	@media (min-width: 768px) {
		.cover-image-container {
			min-height: 0;
		}
	}

	/* 加载动画容器 */
	.loading-spinner {
		transition: opacity 0.3s ease-out;
	}

	/* 加载完成后隐藏 */
	.cover-image-container[data-loading="false"] .loading-spinner {
		opacity: 0;
		pointer-events: none;
	}

	/* 错误状态隐藏加载动画 */
	.cover-image-container[data-error="true"] .loading-spinner {
		display: none;
	}

	/* 错误状态显示错误信息和回退图片 */
	.cover-image-container[data-error="true"] .error-message {
		display: flex;
	}

	.cover-image-container[data-error="true"] .fallback-image {
		display: block;
	}

	/* 错误状态隐藏失败的远程图片 */
	.cover-image-container[data-error="true"] img[data-remote="true"] {
		display: none;
	}

	/* 旋转加载动画 */
	.spinner {
		width: 40px;
		height: 40px;
		border: 3px solid oklch(0.9 0.05 var(--hue));
		border-top-color: oklch(0.6 0.15 var(--hue));
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	/* 图片样式 */
	.cover-image-container img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
</style>

<script>
	function initCoverImages() {
		const containers = document.querySelectorAll('.cover-image-container');
		containers.forEach((container) => {
			if (container.hasAttribute('data-initialized')) return;
			container.setAttribute('data-initialized', 'true');

			const img = container.querySelector('img[data-cover-img]') as HTMLImageElement | null;
			if (!img) return;

			// 解析API URL列表，用于按顺序重试
			let apiUrls: string[] = [];
			let currentApiIndex = 1; // 0号已由服务端设为img.src
			const apiUrlsAttr = container.getAttribute('data-api-urls');
			if (apiUrlsAttr) {
				try { apiUrls = JSON.parse(apiUrlsAttr); } catch (_e) { /* ignore */ }
			}

			const hideLoading = () => {
				container.setAttribute('data-loading', 'false');
			};

			const showError = () => {
				container.setAttribute('data-loading', 'false');
				container.setAttribute('data-error', 'true');
			};

			// 统一的错误处理：尝试下一个API或显示回退
			const onError = () => {
				if (img.dataset.remote !== 'true') return;

				if (currentApiIndex < apiUrls.length) {
					// 先绑定好事件，再更换src
					img.addEventListener('load', hideLoading, { once: true });
					img.addEventListener('error', onError, { once: true });
					img.src = apiUrls[currentApiIndex];
					currentApiIndex++;
				} else {
					showError();
				}
			};

			if (img.complete) {
				if (img.naturalWidth > 0) {
					hideLoading();
				} else {
					onError();
				}
			} else {
				img.addEventListener('load', hideLoading, { once: true });
				img.addEventListener('error', onError, { once: true });
			}
		});
	}

	initCoverImages();
	document.addEventListener('astro:page-load', initCoverImages);
</script>
</file>

<file path="components/common/DropdownItem.astro">
---
/**
 * 公共下拉面板选项组件
 * 用于下拉面板中的选项项
 */
interface Props {
	href?: string;
	target?: string;
	isActive?: boolean;
	isLast?: boolean;
	class?: string;
	onclick?: string;
}

const {
	href,
	target,
	isActive = false,
	isLast = false,
	class: className,
	onclick,
} = Astro.props;

const baseClasses =
	"flex transition whitespace-nowrap items-center justify-start! w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95";
const spacingClass = isLast ? "" : "mb-0.5";
const activeClass = isActive ? "current-theme-btn" : "";
const allClasses =
	`${baseClasses} ${spacingClass} ${activeClass} ${className || ""}`.trim();

const Tag = href ? "a" : "button";
---

<Tag 
	href={href}
	target={target}
	class={allClasses}
	onclick={onclick}
>
	<slot />
</Tag>
</file>

<file path="components/common/DropdownItem.svelte">
<script lang="ts">
/**
 * 公共下拉面板选项组件 (Svelte 5 版本)
 * 用于下拉面板中的选项项
 */
import type { Snippet } from "svelte";

interface Props {
	isActive?: boolean;
	isLast?: boolean;
	class?: string;
	onclick?: (event: MouseEvent) => void;
	role?: string;
	children?: Snippet;
}

let {
	isActive = false,
	isLast = false,
	class: className = "",
	onclick,
	role,
	children,
	...restProps
}: Props = $props();

const baseClasses =
	"flex transition whitespace-nowrap items-center justify-start! w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95";

// 使用 $derived 使类名响应式
const allClasses = $derived.by(() => {
	const spacingClass = isLast ? "" : "mb-0.5";
	const activeClass = isActive ? "current-theme-btn" : "";
	return `${baseClasses} ${spacingClass} ${activeClass} ${className}`.trim();
});
</script>

<button
	class={allClasses}
	{onclick}
	{role}
	{...restProps}
>
	{#if children}
		{@render children()}
	{/if}
</button>
</file>

<file path="components/common/DropdownPanel.astro">
---
/**
 * 公共下拉面板组件
 * 用于壁纸切换、亮暗色切换、导航栏菜单等下拉面板
 */
interface Props {
	class?: string;
}

const { class: className } = Astro.props;
---

<div class:list={["float-panel p-2", className]} role="none">
	<slot />
</div>
</file>

<file path="components/common/DropdownPanel.svelte">
<script lang="ts">
/**
 * 公共下拉面板组件 (Svelte 5 版本)
 * 用于壁纸切换、亮暗色切换等下拉面板
 */
import type { Snippet } from "svelte";

interface Props {
	class?: string;
	children?: Snippet;
}

let { class: className = "", children, ...restProps }: Props = $props();
</script>

<div class={`float-panel p-2 ${className}`.trim()} role="none" {...restProps}>
	{#if children}
		{@render children()}
	{/if}
</div>
</file>

<file path="components/common/FloatingButton.astro">
---
import { Icon } from "astro-icon/components";

/****
 * FloatingButton 组件
 * 用于创建一个悬浮按钮，支持图标、点击事件和可选的辅助标签。
 */

interface Props {
	id: string;
	icon: string;
	ariaLabel?: string;
	onclick?: string;
	class?: string;
}

const { id, icon, ariaLabel, onclick, class: className = "" } = Astro.props;
---

<div
  id={id}
  class:list={["floating-btn", className, "flex items-center rounded-2xl overflow-hidden transition"]}
  onclick={onclick}
>
  <button
    aria-label={ariaLabel}
    class="h-full w-full rounded-2xl"
  >
    <Icon name={icon} class="mx-auto" />
  </button>
</div>

<style lang="stylus">
.floating-btn
    color: var(--primary)
    font-size: 2.25rem
    font-weight: bold
    width: 4rem
    height: 4rem
    
    opacity: 1
    cursor: pointer
    pointer-events: auto
    /* 默认状态（显示）：各属性平滑过渡 */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1)
    border-radius: 1rem
    backdrop-filter: blur(12px)
    background-color: var(--card-bg)
    border: 1px solid rgba(0, 0, 0, 0.1)
    flex-shrink: 0
    overflow: hidden
    
    /* 图标样式 */
    :global(svg)
        font-size: 1.75rem
        opacity: 1
        transition: opacity 0.2s ease 0.1s /* 显示时：延迟出现，通过 delay 避免"先出现icon" */

    &.hide
        /* 隐藏状态：缩小并收起布局 */
        transform: scale(0.5)
        opacity: 0
        pointer-events: none
        
        /* 强制收缩布局占用 */
        height: 0 !important
        width: 0 !important
        margin: 0 !important
        border-width: 0 !important
        padding: 0 !important
        
        /* 隐藏时：不需要 delay，与布局同时（或稍快）消失 */
        /* 由于 width/height 也在变，all cover全部。关键是 inner element 必须快 */
        
        :global(svg)
            opacity: 0
            transition: opacity 0.1s ease /* 隐藏时：立即消失，解决"icon最后消失" */
        
    &:active
        transform: scale(0.9)
        
    &:hover
        transform: scale(1.05)
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15)
        background-color: rgba(255, 255, 255, 0.95)
        border-color: rgba(0, 0, 0, 0.2)

/* 暗色主题样式 */
:global(.dark) .floating-btn
    background-color: var(--card-bg)
    border: 1px solid rgba(255, 255, 255, 0.15)
    color: var(--primary, #60a5fa)
    
    &:hover
        background-color: var(--card-bg)
        border-color: rgba(255, 255, 255, 0.3)
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3)

/* 响应式调整 */
@media (max-width: 768px)
    .floating-btn
        width: 3rem
        height: 3rem
        font-size: 1.5rem
        border-radius: 0.75rem
        :global(svg)
            font-size: 1.25rem

@media (max-width: 480px)
    .floating-btn
        width: 2.5rem
        height: 2.5rem
        font-size: 1.25rem
        border-radius: 0.5rem
        :global(svg)
            font-size: 1rem

@media (max-width: 360px)
    .floating-btn
        width: 2rem
        height: 2rem
        font-size: 1rem
        border-radius: 0.375rem
        :global(svg)
            font-size: 0.875rem

@media (max-width: 320px)
    .floating-btn
        width: 1.75rem
        height: 1.75rem
        font-size: 0.875rem
        border-radius: 0.25rem
        :global(svg)
            font-size: 0.75rem

/* 确保按钮始终在可视区域内 */
.floating-btn
    min-width: 0
    min-height: 0
    padding: 0.25rem
    border-radius: 1rem !important
    
    &.hide
        padding: 0

/* 高DPI屏幕优化 */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi)
    .floating-btn
        image-rendering: -webkit-optimize-contrast
        image-rendering: crisp-edges
</style>
</file>

<file path="components/common/Icon.svelte">
<script lang="ts">
/**
 * 统一的图标组件 - 构建时内联 SVG
 * 用于 Svelte 组件
 *
 * 图标在构建时由 scripts/generate-icons.js 自动扫描并内联
 * 无需运行时 API 请求，零延迟加载
 *
 * 因为如果使用@iconify/svelte搭配unplugin-icons的方式会导致使用方法繁琐了，所以改为这种预构建内联SVG的方式。
 */
import { getIconSvg, hasIcon } from "@/constants/icons";

interface Props {
	icon: string;
	class?: string;
	style?: string;
	size?: "xs" | "sm" | "md" | "lg" | "xl" | "2xl";
	color?: string;
}

let {
	icon,
	class: className = "",
	style = "",
	size = "md",
	color,
}: Props = $props();

// 尺寸映射
const sizeClasses: Record<string, string> = {
	xs: "text-xs",
	sm: "text-sm",
	md: "text-base",
	lg: "text-lg",
	xl: "text-xl",
	"2xl": "text-2xl",
};

const sizeClass = $derived(sizeClasses[size] || sizeClasses.md);
const colorStyle = $derived(color ? `color: ${color};` : "");
const combinedStyle = $derived(`${colorStyle}${style}`);
const combinedClass = $derived(`${sizeClass} ${className}`.trim());

// 获取内联 SVG
const svgContent = $derived(getIconSvg(icon));
const iconExists = $derived(hasIcon(icon));
</script>

{#if iconExists && svgContent}
  <!-- 使用预加载的内联 SVG -->
  <span
    class="inline-icon inline-flex items-center justify-center {combinedClass}"
    style={combinedStyle}
    aria-hidden="true"
  >
    {@html svgContent}
  </span>
{:else}
  <!-- 回退：图标未找到时显示占位符 -->
  <span
    class="inline-icon inline-flex items-center justify-center {combinedClass}"
    style={combinedStyle}
    aria-hidden="true"
    title="Icon not found: {icon}"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" opacity="0.3"/>
    </svg>
  </span>
{/if}

<style>
  .inline-icon :global(svg) {
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: middle;
    fill: currentColor;
  }
</style>
</file>

<file path="components/common/ImageWrapper.astro">
---
import { Image, Picture } from "astro:assets";
import * as path from "node:path";
import type { ImageMetadata } from "astro";
import type { ImageFormat, ResponsiveImageLayout } from "@/types/config";
import {
	getFallbackFormat,
	getImageFormats,
	getImageQuality,
} from "@/utils/image-utils";
import { url } from "@/utils/url-utils";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
	loading?: "lazy" | "eager";
	fetchpriority?: "high" | "low" | "auto";
	// 响应式图像属性
	layout?: ResponsiveImageLayout;
	usePicture?: boolean;
	formats?: ImageFormat[];
	widths?: number[];
	sizes?: string;
	quality?: number;
}

const {
	id,
	src,
	alt,
	position = "center",
	basePath = "/",
	loading = "lazy",
	fetchpriority = "auto",
	layout = "constrained",
	usePicture = true,
	formats = getImageFormats(),
	widths,
	sizes,
	quality = getImageQuality(),
} = Astro.props;

const fallbackFormat = getFallbackFormat();
const className = Astro.props.class;

const isLocal = !(
	src.startsWith("/") ||
	src.startsWith("http") ||
	src.startsWith("https") ||
	src.startsWith("data:")
);
const isPublic = src.startsWith("/");

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
let img: ImageMetadata | null = null;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>(
		"../../**/*.{png,jpg,jpeg,webp,avif}",
		{
			import: "default",
		},
	);
	let normalizedPath = path
		.normalize(path.join("../../", basePath, src))
		.replace(/\\/g, "/");
	const file = files[normalizedPath];
	if (!file) {
		console.error(
			`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
		);
	} else {
		img = await file();
	}
}

const imageClass = "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;

// 构建响应式图像属性
const responsiveProps = {
	...(layout && { layout }),
	...(widths && { widths }),
	...(sizes && { sizes }),
	...(quality && { quality }),
};
---
<div id={id} class:list={[className, 'overflow-hidden relative']}>
    <div class="transition absolute inset-0 dark:bg-black/10 pointer-events-none"></div>
    {isLocal && img && usePicture && (
        <Picture
            src={img}
            alt={alt || ""}
            class={imageClass}
            style={imageStyle}
            loading={loading}
            fetchpriority={fetchpriority}
            formats={formats}
            fallbackFormat={fallbackFormat}
            {...responsiveProps}
        />
    )}
    {isLocal && img && !usePicture && (
        <Image
            src={img}
            alt={alt || ""}
            class={imageClass}
            style={imageStyle}
            loading={loading}
            fetchpriority={fetchpriority}
            {...responsiveProps}
        />
    )}
    {!isLocal && <img src={isPublic ? url(src) : src} alt={alt || ""} class={imageClass} style={imageStyle} loading={loading} fetchpriority={fetchpriority} />}
</div>
</file>

<file path="components/common/Markdown.astro">
---
// 只加载基础的等宽字体，减少加载时间
import "@fontsource-variable/jetbrains-mono";

interface Props {
	class: string;
}
const className = Astro.props.class;
---
<div data-pagefind-body class={`prose dark:prose-invert prose-base max-w-none! custom-md ${className}`}>
    <slot/>
</div>
</file>

<file path="components/common/Pagination.astro">
---
import type { Page } from "astro";
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { url } from "@/utils/url-utils";

interface Props {
	page: Page;
	class?: string;
	style?: string;
}

const { page, style } = Astro.props;

const HIDDEN = -1;

const className = Astro.props.class;

const ADJ_DIST = 2;
const VISIBLE = ADJ_DIST * 2 + 1;

// for test
let count = 1;
let l = page.currentPage;
let r = page.currentPage;
while (0 < l - 1 && r + 1 <= page.lastPage && count + 2 <= VISIBLE) {
	count += 2;
	l--;
	r++;
}
while (0 < l - 1 && count < VISIBLE) {
	count++;
	l--;
}
while (r + 1 <= page.lastPage && count < VISIBLE) {
	count++;
	r++;
}

let pages: number[] = [];
if (l > 1) pages.push(1);
if (l === 3) pages.push(2);
if (l > 3) pages.push(HIDDEN);
for (let i = l; i <= r; i++) pages.push(i);
if (r < page.lastPage - 2) pages.push(HIDDEN);
if (r === page.lastPage - 2) pages.push(page.lastPage - 1);
if (r < page.lastPage) pages.push(page.lastPage);

const getPageUrl = (p: number) => {
	if (p === 1) return "/";
	return `/${p}/`;
};
---

<div class:list={[className, "flex flex-col gap-4 items-center"]} style={style}>
  <!-- 分页信息 - 已禁用 -->
  <!--
  {
    page.lastPage > 1 && (
      <div class="text-sm text-(--text-secondary) text-center">
        第 {page.currentPage} 页，共 {page.lastPage} 页
      </div>
    )
  }
  -->

  <!-- 分页控件 -->
  <div class="flex flex-row gap-3 justify-center" role="navigation" aria-label={i18n(I18nKey.postList)}>
    <a
      href={page.url.prev || "#"}
      aria-label={i18n(I18nKey.paginationPrev)}
      aria-disabled={page.url.prev === undefined ? "true" : "false"}
      tabindex={page.url.prev === undefined ? "-1" : "0"}
      class:list={[
        "btn-card overflow-hidden rounded-lg text-(--primary) w-11 h-11",
        { disabled: page.url.prev == undefined },
      ]}
    >
      <Icon
        name="material-symbols:chevron-left-rounded"
        class="text-[1.75rem]"
        aria-hidden="true"
      />
    </a>
    <div
      class="bg-(--card-bg) flex flex-row rounded-lg items-center text-neutral-700 dark:text-neutral-300 font-bold"
    >
      {
        pages.map((p) => {
          if (p == HIDDEN)
            return <Icon name="material-symbols:more-horiz" class="mx-1" aria-hidden="true" />;
          if (p == page.currentPage)
            return (
              <div
                class="h-11 w-11 rounded-lg bg-(--primary) flex items-center justify-center
                        font-bold text-white dark:text-black/70"
                aria-current="page"
              >
                {p}
              </div>
            );
          return (
            <a
              href={url(getPageUrl(p))}
              aria-label={`${i18n(I18nKey.paginationPage)} ${p}`}
              class="btn-card w-11 h-11 rounded-lg overflow-hidden active:scale-[0.85]"
            >
              {p}
            </a>
          );
        })
      }
    </div>
    <a
      href={page.url.next || "#"}
      aria-label={i18n(I18nKey.paginationNext)}
      aria-disabled={page.url.next === undefined ? "true" : "false"}
      tabindex={page.url.next === undefined ? "-1" : "0"}
      class:list={[
        "btn-card overflow-hidden rounded-lg text-(--primary) w-11 h-11",
        { disabled: page.url.next == undefined },
      ]}
    >
      <Icon
        name="material-symbols:chevron-right-rounded"
        class="text-[1.75rem]"
        aria-hidden="true"
      />
    </a>
  </div>
</div>
</file>

<file path="components/common/PioMessageBox.astro">
---
// 消息框公共组件
// 用于Live2D和Spine模型的消息显示
---

<script>
  // 全局变量，跟踪当前显示的消息容器和隐藏定时器
  let currentMessageContainer: HTMLDivElement | null = null;
  let hideMessageTimer: number | null = null;

  // 消息显示函数
  export function showMessage(message: string, options: { containerId?: string; displayTime?: number } = {}) {
    // 防止空消息或重复调用
    if (!message || !message.trim()) {
      return;
    }

    // 立即清除之前的消息
    if (currentMessageContainer) {
      if (hideMessageTimer !== null) {
        clearTimeout(hideMessageTimer);
      }
      if (currentMessageContainer.parentNode) {
        currentMessageContainer.parentNode.removeChild(currentMessageContainer);
      }
      currentMessageContainer = null;
    }

    // 确保DOM中没有残留的消息容器
    const existingMessages = document.querySelectorAll(
      ".model-message-container"
    );
    existingMessages.forEach((msg) => {
      if (msg.parentNode) {
        msg.parentNode.removeChild(msg);
      }
    });

    // 检测暗色主题
    const isDarkMode =
      document.documentElement.classList.contains("dark") ||
      window.matchMedia("(prefers-color-scheme: dark)").matches;

    // 创建消息容器
    const messageContainer = document.createElement("div");
    messageContainer.className = "model-message-container";

    // 创建消息元素
    const messageEl = document.createElement("div");
    messageEl.className = "model-message";
    messageEl.textContent = message;

    // 创建箭头元素
    const arrowEl = document.createElement("div");
    arrowEl.className = "model-message-arrow";

    // 设置容器样式
    Object.assign(messageContainer.style, {
      position: "fixed",
      zIndex: "1001",
      pointerEvents: "none",
      opacity: "0",
      transform: "translateY(15px) translateX(-50%) scale(0.9)",
      transition: "all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)",
    });

    // 设置消息框美化样式（支持暗色主题）
    const messageStyles = {
      position: "relative",
      background: isDarkMode
        ? "linear-gradient(135deg, rgba(45, 55, 72, 0.95), rgba(26, 32, 44, 0.9))"
        : "linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 248, 255, 0.9))",
      color: isDarkMode ? "#e2e8f0" : "#2c3e50",
      padding: "12px 16px",
      borderRadius: "16px",
      fontSize: "14px",
      fontWeight: "500",
      fontFamily:
        '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      maxWidth: "240px",
      minWidth: "100px",
      wordWrap: "break-word",
      textAlign: "center",
      whiteSpace: "pre-wrap",
      boxShadow: isDarkMode
        ? "0 8px 32px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2)"
        : "0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08)",
      border: isDarkMode
        ? "1px solid rgba(255, 255, 255, 0.1)"
        : "1px solid rgba(255, 255, 255, 0.6)",
      backdropFilter: "blur(12px)",
      letterSpacing: "0.3px",
      lineHeight: "1.4",
    };
    Object.assign(messageEl.style, messageStyles);

    // 设置箭头样式（居中显示）
    Object.assign(arrowEl.style, {
      position: "absolute",
      top: "100%",
      left: "50%",
      transform: "translateX(-50%)", // 箭头居中
      width: "0",
      height: "0",
      borderLeft: "8px solid transparent",
      borderRight: "8px solid transparent",
      borderTop: isDarkMode
        ? "8px solid rgba(45, 55, 72, 0.95)"
        : "8px solid rgba(255, 255, 255, 0.95)",
      filter: "drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))",
    });

    // 组装消息框元素
    messageEl.appendChild(arrowEl);
    messageContainer.appendChild(messageEl);

    // 添加到页面并保存引用
    document.body.appendChild(messageContainer);
    currentMessageContainer = messageContainer;

    // 将消息显示在模型头顶居中
    const container = document.getElementById(options.containerId || "model-container");
    if (container) {
      const rect = container.getBoundingClientRect();

      // 消息框居中显示在模型上方
      const containerCenterX = rect.left + rect.width / 2;

      // 使用估算的消息框尺寸进行初步定位
      const estimatedMessageWidth = 240; // 使用maxWidth作为估算
      const estimatedMessageHeight = 60; // 估算高度
      const screenPadding = 10; // 距离屏幕边缘的最小距离

      // 计算消息框的实际位置（考虑translateX(-50%)的影响）
      let messageX = containerCenterX;
      let messageY = rect.top - estimatedMessageHeight - 25; // 距离模型顶部25px

      // 屏幕边界检查 - 水平方向
      const minX = screenPadding + estimatedMessageWidth / 2; // 考虑translateX(-50%)
      const maxX =
        window.innerWidth - screenPadding - estimatedMessageWidth / 2;

      if (messageX < minX) {
        messageX = minX;
      } else if (messageX > maxX) {
        messageX = maxX;
      }

      // 屏幕边界检查 - 垂直方向
      const minY = screenPadding;
      const maxY = window.innerHeight - estimatedMessageHeight - screenPadding;

      if (messageY < minY) {
        // 如果上方空间不够，显示在模型下方
        messageY = rect.bottom + 25;
        // 调整箭头方向（显示在下方）
        arrowEl.style.top = "0";
        arrowEl.style.bottom = "auto";
        arrowEl.style.borderTop = "none";
        arrowEl.style.borderBottom = isDarkMode
          ? "8px solid rgba(45, 55, 72, 0.95)"
          : "8px solid rgba(255, 255, 255, 0.95)";
      } else if (messageY > maxY) {
        messageY = maxY;
      }

      // 设置位置
      messageContainer.style.left = messageX + "px";
      messageContainer.style.top = messageY + "px";

      // 在消息框渲染后，进行精确的边界调整
      setTimeout(() => {
        const actualMessageRect = messageContainer.getBoundingClientRect();
        const actualWidth = actualMessageRect.width;
        const actualHeight = actualMessageRect.height;

        // 重新计算水平位置
        let adjustedX = containerCenterX;
        const actualMinX = screenPadding + actualWidth / 2;
        const actualMaxX = window.innerWidth - screenPadding - actualWidth / 2;

        if (adjustedX < actualMinX) {
          adjustedX = actualMinX;
        } else if (adjustedX > actualMaxX) {
          adjustedX = actualMaxX;
        }

        // 重新计算垂直位置
        let adjustedY = rect.top - actualHeight - 25;
        const actualMinY = screenPadding;
        const actualMaxY = window.innerHeight - actualHeight - screenPadding;
        let isAboveModel = true; // 标记消息框是否在模型上方

        if (adjustedY < actualMinY) {
          adjustedY = rect.bottom + 25;
          isAboveModel = false;
        } else if (adjustedY > actualMaxY) {
          adjustedY = actualMaxY;
        }

        // 计算箭头应该指向的位置（模型中心）
        const modelCenterX = rect.left + rect.width / 2;
        const messageCenterX = adjustedX; // 消息框中心位置
        const arrowOffsetX = modelCenterX - messageCenterX; // 箭头相对于消息框中心的偏移

        // 限制箭头偏移范围，避免超出消息框边界
        const maxOffset = actualWidth / 2 - 20; // 留出20px边距
        const clampedOffsetX = Math.max(
          -maxOffset,
          Math.min(maxOffset, arrowOffsetX)
        );

        // 根据最终位置调整箭头方向和位置
        if (isAboveModel) {
          // 消息框在模型上方，箭头向下
          Object.assign(arrowEl.style, {
            position: "absolute",
            top: "100%",
            left: "50%",
            bottom: "auto",
            transform: `translateX(calc(-50% + ${clampedOffsetX}px))`,
            width: "0",
            height: "0",
            borderLeft: "8px solid transparent",
            borderRight: "8px solid transparent",
            borderTop: isDarkMode
              ? "8px solid rgba(45, 55, 72, 0.95)"
              : "8px solid rgba(255, 255, 255, 0.95)",
            borderBottom: "none",
            filter: "drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))",
          });
        } else {
          // 消息框在模型下方，箭头向上
          Object.assign(arrowEl.style, {
            position: "absolute",
            top: "0",
            left: "50%",
            bottom: "auto",
            transform: `translateX(calc(-50% + ${clampedOffsetX}px))`,
            width: "0",
            height: "0",
            borderLeft: "8px solid transparent",
            borderRight: "8px solid transparent",
            borderTop: "none",
            borderBottom: isDarkMode
              ? "8px solid rgba(45, 55, 72, 0.95)"
              : "8px solid rgba(255, 255, 255, 0.95)",
            filter: "drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))",
          });
        }

        // 应用调整后的位置
        messageContainer.style.left = adjustedX + "px";
        messageContainer.style.top = adjustedY + "px";
      }, 50); // 增加延迟确保消息框完全渲染
    }

    // 显示动画
    setTimeout(() => {
      messageContainer.style.opacity = "1";
      messageContainer.style.transform =
        "translateY(0) translateX(-50%) scale(1)";
    }, 100); // 延迟到边界调整完成后

    // 自动隐藏
    const displayTime = options.displayTime || 3000;
    hideMessageTimer = window.setTimeout(() => {
      messageContainer.style.opacity = "0";
      messageContainer.style.transform =
        "translateY(-15px) translateX(-50%) scale(0.95)";
      setTimeout(() => {
        if (messageContainer.parentNode) {
          messageContainer.parentNode.removeChild(messageContainer);
        }
        // 清除引用
        if (currentMessageContainer === messageContainer) {
          currentMessageContainer = null;
        }
      }, 400);
    }, displayTime);
  }

  // 清理消息函数
  export function clearMessage() {
    if (currentMessageContainer) {
      if (hideMessageTimer !== null) {
        clearTimeout(hideMessageTimer);
      }
      if (currentMessageContainer.parentNode) {
        currentMessageContainer.parentNode.removeChild(currentMessageContainer);
      }
      currentMessageContainer = null;
    }

    // 清理所有消息容器
    const existingMessages = document.querySelectorAll(
      ".model-message-container"
    );
    existingMessages.forEach((msg) => {
      if (msg.parentNode) {
        msg.parentNode.removeChild(msg);
      }
    });
  }

  // 将函数暴露到全局作用域
  (window as any).showModelMessage = showMessage;
  (window as any).clearModelMessage = clearMessage;
</script>
</file>

<file path="components/common/WidgetLayout.astro">
---
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

interface Props {
	id: string;
	name?: string;
	isCollapsed?: boolean;
	collapsedHeight?: string;
	class?: string;
	style?: string;
}
const { id, name, isCollapsed, collapsedHeight, style } = Astro.props;
const className = Astro.props.class;
---
<widget-layout data-id={id} data-is-collapsed={String(isCollapsed)} class={"pb-4 card-base " + className} style={style}>
    {name && (
        <div class="widget-title font-bold transition text-lg text-neutral-900 dark:text-neutral-100 relative ml-8 mt-4 mb-2
            before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
            before:absolute before:left-[-16px] before:top-[5.5px] flex items-center justify-between">
            <span class="widget-name">{name}</span>
            <slot name="title-icon" />
        </div>
    )}
    <div id={id} class:list={["collapse-wrapper px-4 overflow-hidden", {"collapsed": isCollapsed, "pt-4": !name}]}>
        <slot></slot>
    </div>
    {isCollapsed && <div class="expand-btn px-4 -mb-2">
        <button class="btn-plain rounded-lg w-full h-9" title={i18n(I18nKey.more)} aria-label={i18n(I18nKey.more)}>
            <div class="text-(--primary) flex items-center justify-center gap-2 -translate-x-2">
                <Icon name="material-symbols:more-horiz" class="text-[1.75rem]" aria-hidden="true"></Icon> {i18n(I18nKey.more)}
            </div>
        </button>
    </div>}
</widget-layout>

<style define:vars={{ collapsedHeight }}>
    .collapsed {
        height: var(--collapsedHeight);
    }
</style>

<script>
    class WidgetLayout extends HTMLElement {
        constructor() {
            super();

            if (this.dataset.isCollapsed !== "true")
                return;

            const id = this.dataset.id;
            const btn = this.querySelector('.expand-btn');
            const wrapper = this.querySelector(`#${id}`)
            btn!.addEventListener('click', () => {
                wrapper!.classList.remove('collapsed');
                btn!.classList.add('hidden');
            })
        }
    }

    if (!customElements.get("widget-layout")) {
        customElements.define("widget-layout", WidgetLayout);
    }
</script>
</file>

<file path="components/controls/ArchivePanel.svelte">
<script lang="ts">
import { onMount } from "svelte";

import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getPostUrlBySlug } from "@/utils/url-utils";

export let tags: string[] = [];
export let categories: string[] = [];
export let sortedPosts: Post[] = [];

const params = new URLSearchParams(window.location.search);
tags = params.has("tag") ? params.getAll("tag") : [];
categories = params.has("category") ? params.getAll("category") : [];
const uncategorized = params.get("uncategorized");

interface Post {
	id: string;
	data: {
		title: string;
		tags: string[];
		category?: string | null;
		published: Date;
	};
}

interface Group {
	year: number;
	posts: Post[];
}

let groups: Group[] = [];

function formatDate(date: Date) {
	const month = (date.getMonth() + 1).toString().padStart(2, "0");
	const day = date.getDate().toString().padStart(2, "0");
	return `${month}-${day}`;
}

function formatTag(tagList: string[]) {
	return tagList.map((t) => `#${t}`).join(" ");
}

onMount(async () => {
	let filteredPosts: Post[] = sortedPosts;

	if (tags.length > 0) {
		filteredPosts = filteredPosts.filter(
			(post) =>
				Array.isArray(post.data.tags) &&
				post.data.tags.some((tag) => tags.includes(tag)),
		);
	}

	if (categories.length > 0) {
		filteredPosts = filteredPosts.filter(
			(post) => post.data.category && categories.includes(post.data.category),
		);
	}

	if (uncategorized) {
		filteredPosts = filteredPosts.filter((post) => !post.data.category);
	}

	// 按发布时间倒序排序，确保不受置顶影响
	filteredPosts = filteredPosts
		.slice()
		.sort((a, b) => b.data.published.getTime() - a.data.published.getTime());

	const grouped = filteredPosts.reduce(
		(acc, post) => {
			const year = post.data.published.getFullYear();
			if (!acc[year]) {
				acc[year] = [];
			}
			acc[year].push(post);
			return acc;
		},
		{} as Record<number, Post[]>,
	);

	const groupedPostsArray = Object.keys(grouped).map((yearStr) => ({
		year: Number.parseInt(yearStr, 10),
		posts: grouped[Number.parseInt(yearStr, 10)],
	}));

	groupedPostsArray.sort((a, b) => b.year - a.year);

	groups = groupedPostsArray;
});
</script>

<div class="card-base px-8 py-6">
    {#each groups as group}
        <div>
            <div class="flex flex-row w-full items-center h-15">
                <div class="w-[15%] md:w-[10%] transition text-2xl font-bold text-right text-75">
                    {group.year}
                </div>
                <div class="w-[15%] md:w-[10%]">
                    <div
                            class="h-3 w-3 bg-none rounded-full outline outline-(--primary) mx-auto
                  -outline-offset-2 z-50 outline-3"
                    ></div>
                </div>
                <div class="w-[70%] md:w-[80%] transition text-left text-50">
                    {group.posts.length} {i18n(group.posts.length === 1 ? I18nKey.postCount : I18nKey.postsCount)}
                </div>
            </div>

            {#each group.posts as post}
                <a
                        href={getPostUrlBySlug(post.id)}
                        aria-label={post.data.title}
                        class="group btn-plain block! h-10 w-full rounded-lg hover:text-[initial]"
                >
                    <div class="flex flex-row justify-start items-center h-full">
                        <!-- date -->
                        <div class="w-[15%] md:w-[10%] transition text-sm text-right text-50">
                            {formatDate(post.data.published)}
                        </div>

                        <!-- dot and line -->
                        <div class="w-[15%] md:w-[10%] relative dash-line h-full flex items-center">
                            <div
                                    class="transition-all mx-auto w-1 h-1 rounded group-hover:h-5
                       bg-[oklch(0.5_0.05_var(--hue))] group-hover:bg-(--primary)
                       outline outline-4 z-50
                       outline-(--card-bg)
                       group-hover:outline-(--btn-plain-bg-hover)
                       group-active:outline-(--btn-plain-bg-active)"
                            ></div>
                        </div>

                        <!-- post title -->
                        <div
                                class="w-[70%] md:max-w-[65%] md:w-[65%] text-left font-bold
                     group-hover:translate-x-1 transition-all group-hover:text-(--primary)
                     text-75 pr-8 whitespace-nowrap text-ellipsis overflow-hidden"
                        >
                            {post.data.title}
                        </div>

                        <!-- tag list -->
                        <div
                                class="hidden md:block md:w-[15%] text-left text-sm transition
                     whitespace-nowrap text-ellipsis overflow-hidden text-30"
                        >
                            {formatTag(post.data.tags)}
                        </div>
                    </div>
                </a>
            {/each}
        </div>
    {/each}
</div>
</file>

<file path="components/controls/BackToHome.astro">
---
import FloatingButton from "@/components/common/FloatingButton.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { url } from "@/utils/url-utils";
---


<FloatingButton
  id="back-to-home-btn"
  icon="material-symbols:home-outline-rounded"
  ariaLabel={i18n(I18nKey.home)}
  onclick="backToHome()"
  class="hide"
/>



<script is:raw is:inline define:vars={{ homeUrl: url("/")}}>
  window.backToHome = function() {
    const url = homeUrl;
    if (window.swup) {
      window.swup.navigate(url);
    } else {
      window.location.href = url;
    }
  };
</script>

<script is:inline define:vars={{ homeUrl: url("/") }}>
  function updateBackToHomeVisibility() {
    const btn = document.getElementById("back-to-home-btn");
    if (!btn) return;

    const path = window.location.pathname.replace(/\/$/, "") || "/";
    const homePath = homeUrl.replace(/\/$/, "") || "/";
    if (path === homePath) {
      btn.classList.add("hide");
    } else {
      btn.classList.remove("hide");
    }
  }

  // Initial check
  updateBackToHomeVisibility();
  
  // Re-check on view transitions or swup navigation
  document.addEventListener("astro:page-load", updateBackToHomeVisibility);
  document.addEventListener("swup:contentReplaced", updateBackToHomeVisibility);
</script>
</file>

<file path="components/controls/BackToTop.astro">
---
import FloatingButton from "@/components/common/FloatingButton.astro";
---

<!-- There can't be a filter on parent element, or it will break `fixed` -->
<FloatingButton
  id="back-to-top-btn"
  icon="material-symbols:keyboard-arrow-up-rounded"
  ariaLabel="Back to Top"
  onclick="backToTop()"
  class="hide" 
/>

<script is:raw is:inline>
  function backToTop() {
    // 直接使用原生滚动，避免OverlayScrollbars冲突
    window.scroll({ top: 0, behavior: "smooth" });
  }

  // 响应式返回顶部按钮管理器
  if (typeof window.BackToTopManager === "undefined") {
    window.BackToTopManager = class BackToTopManager {
      constructor() {
        this.button = document.getElementById("back-to-top-btn");
        this.init();
      }

      init() {
        if (!this.button) return; // wrapper checks removed as it is now flexible

        this.setupScrollListener();
      }

      setupScrollListener() {
        const updateVisibility = () => {
          const scrollTop =
            window.pageYOffset || document.documentElement.scrollTop;

          // 当滚动超过200px时显示按钮
          if (scrollTop > 200) {
            this.button.classList.remove("hide");
          } else {
            this.button.classList.add("hide");
          }
        };

        window.addEventListener("scroll", updateVisibility, { passive: true });
      }
    };
  }
  // ... existing initialization logic ...
  // 页面加载完成后初始化
  document.addEventListener("DOMContentLoaded", () => {
    new BackToTopManager();
  });

  // 如果页面已经加载完成，立即初始化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      new BackToTopManager();
    });
  } else {
    new BackToTopManager();
  }
</script>
</file>

<file path="components/controls/DisplaySettings.svelte">
<script lang="ts">
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { getDefaultHue, getHue, setHue } from "@utils/setting-utils";
import Icon from "@/components/common/Icon.svelte";

/**
 * 主题色设置面板
 * 目前已弃用，已集成至DisplaySettingsIntegrated.svelte，当前文件保留以备将来可能的单独使用
 */

let hue = getHue();
const defaultHue = getDefaultHue();

function resetHue() {
	hue = getDefaultHue();
}

$: if (hue || hue === 0) {
	setHue(hue);
}
</script>

<div id="display-setting" class="float-panel float-panel-closed absolute transition-all w-80 right-4 px-4 py-4">
    <div class="flex flex-row gap-2 mb-3 items-center justify-between">
        <div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3
            before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
            before:absolute before:-left-3 before:top-[0.33rem]"
        >
            {i18n(I18nKey.themeColor)}
            <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md  active:scale-90"
                    class:opacity-0={hue === defaultHue} class:pointer-events-none={hue === defaultHue} on:click={resetHue}>
                <div class="text-(--btn-content)">
                    <Icon icon="fa7-solid:arrow-rotate-left" class="text-[0.875rem]"></Icon>
                </div>
            </button>
        </div>
        <div class="flex gap-1">
            <div id="hueValue" class="transition bg-(--btn-regular-bg) w-10 h-7 rounded-md flex justify-center
            font-bold text-sm items-center text-(--btn-content)">
                {hue}
            </div>
        </div>
    </div>
    <div class="w-full h-6 px-1 bg-[oklch(0.80_0.10_0)] dark:bg-[oklch(0.70_0.10_0)] rounded select-none">
        <input aria-label={i18n(I18nKey.themeColor)} type="range" min="0" max="360" bind:value={hue}
               class="slider" id="colorSlider" step="5" style="width: 100%">
    </div>
</div>


<style lang="stylus">
    #display-setting
      input[type="range"]
        -webkit-appearance none
        height 1.5rem
        background-image var(--color-selection-bar)
        transition background-image 0.15s ease-in-out

        /* Input Thumb */
        &::-webkit-slider-thumb
          -webkit-appearance none
          height 1rem
          width 0.5rem
          border-radius 0.125rem
          background rgba(255, 255, 255, 0.7)
          box-shadow none
          &:hover
            background rgba(255, 255, 255, 0.8)
          &:active
            background rgba(255, 255, 255, 0.6)

        &::-moz-range-thumb
          -webkit-appearance none
          height 1rem
          width 0.5rem
          border-radius 0.125rem
          border-width 0
          background rgba(255, 255, 255, 0.7)
          box-shadow none
          &:hover
            background rgba(255, 255, 255, 0.8)
          &:active
            background rgba(255, 255, 255, 0.6)

        &::-ms-thumb
          -webkit-appearance none
          height 1rem
          width 0.5rem
          border-radius 0.125rem
          background rgba(255, 255, 255, 0.7)
          box-shadow none
          &:hover
            background rgba(255, 255, 255, 0.8)
          &:active
            background rgba(255, 255, 255, 0.6)

</style>
</file>

<file path="components/controls/DisplaySettingsIntegrated.svelte">
<script lang="ts">
import {
	WALLPAPER_BANNER,
	WALLPAPER_NONE,
	WALLPAPER_OVERLAY,
} from "@constants/constants";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import {
	getDefaultBannerTitleEnabled,
	getDefaultHue,
	getDefaultWavesEnabled,
	getHue,
	getStoredBannerTitleEnabled,
	getStoredWallpaperMode,
	getStoredWavesEnabled,
	setBannerTitleEnabled,
	setHue,
	setWallpaperMode,
	setWavesEnabled,
} from "@utils/setting-utils";
import { onMount } from "svelte";
import Icon from "@/components/common/Icon.svelte";
import { backgroundWallpaper, siteConfig } from "@/config";
import type { WALLPAPER_MODE } from "@/types/config";

let hue = $state(getHue());
const defaultHue = getDefaultHue();
let wallpaperMode: WALLPAPER_MODE = $state(backgroundWallpaper.mode);
const defaultWallpaperMode = backgroundWallpaper.mode;
let currentLayout: "list" | "grid" = $state("list");
const defaultLayout = siteConfig.postListLayout.defaultMode;
let mounted = $state(false);
let isSmallScreen = $state(
	typeof window !== "undefined" ? window.innerWidth < 1200 : false,
);
let isSwitching = $state(false);
let wavesEnabled = $state(true);
const defaultWavesEnabled = getDefaultWavesEnabled();
let bannerTitleEnabled = $state(true);
const defaultBannerTitleEnabled = getDefaultBannerTitleEnabled();

const isWallpaperSwitchable = backgroundWallpaper.switchable ?? true;
const allowLayoutSwitch = siteConfig.postListLayout.allowSwitch;
const showThemeColor = !siteConfig.themeColor.fixed;
// 是否允许用户切换水波纹动画（只看 switchable 配置）
const isWavesSwitchable =
	backgroundWallpaper.banner?.waves?.switchable ?? false;
// 检查是否启用横幅标题配置
const isBannerTitleEnabled =
	backgroundWallpaper.banner?.homeText?.enable ?? false;
// 是否允许用户切换横幅标题
const isBannerTitleSwitchable =
	isBannerTitleEnabled &&
	(backgroundWallpaper.banner?.homeText?.switchable ?? false);
// 是否有任何横幅设置可显示（后续添加新设置时在此处添加条件）
const hasBannerSettings = isWavesSwitchable || isBannerTitleSwitchable;
// 横幅设置是否全部为默认值（用于控制恢复默认按钮的显隐）
let bannerSettingsIsDefault = $derived(
	(!isBannerTitleSwitchable ||
		bannerTitleEnabled === defaultBannerTitleEnabled) &&
		(!isWavesSwitchable || wavesEnabled === defaultWavesEnabled),
);
const hasAnyContent =
	showThemeColor ||
	isWallpaperSwitchable ||
	allowLayoutSwitch ||
	hasBannerSettings;

function resetHue() {
	hue = getDefaultHue();
}

function resetWallpaperMode() {
	wallpaperMode = defaultWallpaperMode;
	setWallpaperMode(defaultWallpaperMode);
}

function resetLayout() {
	currentLayout = defaultLayout;
	localStorage.setItem("postListLayout", defaultLayout);

	// 触发自定义事件，通知页面布局已改变
	const event = new CustomEvent("layoutChange", {
		detail: { layout: defaultLayout },
	});
	window.dispatchEvent(event);
}

function resetWavesEnabled() {
	wavesEnabled = defaultWavesEnabled;
	setWavesEnabled(defaultWavesEnabled);
}

function resetBannerSettings() {
	if (
		isBannerTitleSwitchable &&
		bannerTitleEnabled !== defaultBannerTitleEnabled
	) {
		bannerTitleEnabled = defaultBannerTitleEnabled;
		setBannerTitleEnabled(defaultBannerTitleEnabled);
	}
	if (isWavesSwitchable && wavesEnabled !== defaultWavesEnabled) {
		wavesEnabled = defaultWavesEnabled;
		setWavesEnabled(defaultWavesEnabled);
	}
}

function toggleWavesEnabled() {
	wavesEnabled = !wavesEnabled;
	setWavesEnabled(wavesEnabled);
}

function toggleBannerTitleEnabled() {
	bannerTitleEnabled = !bannerTitleEnabled;
	setBannerTitleEnabled(bannerTitleEnabled);
}

function switchWallpaperMode(newMode: WALLPAPER_MODE) {
	wallpaperMode = newMode;
	setWallpaperMode(newMode);
}

function checkScreenSize() {
	isSmallScreen = window.innerWidth < 1200;
	if (isSmallScreen) {
		currentLayout = "list";
	}
}

function switchLayout() {
	if (!mounted || isSmallScreen || isSwitching) return;

	isSwitching = true;
	currentLayout = currentLayout === "list" ? "grid" : "list";
	localStorage.setItem("postListLayout", currentLayout);

	// 触发自定义事件，通知页面布局已改变
	const event = new CustomEvent("layoutChange", {
		detail: { layout: currentLayout },
	});
	window.dispatchEvent(event);

	// 动画完成后重置状态
	setTimeout(() => {
		isSwitching = false;
	}, 500);
}

onMount(() => {
	mounted = true;
	checkScreenSize();

	// 从localStorage读取保存的壁纸模式
	wallpaperMode = getStoredWallpaperMode();

	// 从localStorage读取水波纹动画状态
	wavesEnabled = getStoredWavesEnabled();

	// 从localStorage读取横幅标题状态
	bannerTitleEnabled = getStoredBannerTitleEnabled();

	// 从localStorage读取用户偏好布局
	const savedLayout = localStorage.getItem("postListLayout");
	if (savedLayout && (savedLayout === "list" || savedLayout === "grid")) {
		currentLayout = savedLayout;
	} else {
		currentLayout = siteConfig.postListLayout.defaultMode;
	}

	// 监听窗口大小变化
	window.addEventListener("resize", checkScreenSize);

	return () => {
		window.removeEventListener("resize", checkScreenSize);
	};
});

// 监听布局变化事件
onMount(() => {
	const handleCustomEvent = (event: Event) => {
		const customEvent = event as CustomEvent<{ layout: "list" | "grid" }>;
		currentLayout = customEvent.detail.layout;
	};

	window.addEventListener("layoutChange", handleCustomEvent);

	return () => {
		window.removeEventListener("layoutChange", handleCustomEvent);
	};
});

$effect(() => {
	if (hue || hue === 0) {
		setHue(hue);
	}
});
</script>

{#if hasAnyContent}
<div id="display-setting" class="float-panel float-panel-closed absolute transition-all w-80 right-4 px-4 py-2">
    <!-- Theme Color Section -->
    {#if showThemeColor}
    <div class="mt-2 mb-2">
        <div class="flex flex-row gap-2 mb-2 items-center justify-between">
            <div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3
                before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
                before:absolute before:-left-3 before:top-1/2 before:-translate-y-1/2"
            >
                {i18n(I18nKey.themeColor)}
                <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md  active:scale-90"
                        class:opacity-0={hue === defaultHue} class:pointer-events-none={hue === defaultHue} onclick={resetHue}>
                    <div class="text-(--btn-content)">
                        <Icon icon="fa7-solid:arrow-rotate-left" class="text-[0.875rem]"></Icon>
                    </div>
                </button>
            </div>
            <div class="flex gap-1">
                <div id="hueValue" class="transition bg-(--btn-regular-bg) w-10 h-7 rounded-md flex justify-center
                font-bold text-sm items-center text-(--btn-content)">
                    {hue}
                </div>
            </div>
        </div>
        <div class="w-full h-6 px-1 bg-[oklch(0.80_0.10_0)] dark:bg-[oklch(0.70_0.10_0)] rounded select-none">
            <input aria-label={i18n(I18nKey.themeColor)} type="range" min="0" max="360" bind:value={hue}
                   class="slider" id="colorSlider" step="5" style="width: 100%">
        </div>
    </div>
    {/if}

    <!-- Wallpaper Mode Section -->
    {#if isWallpaperSwitchable}
        <div class="mt-2 mb-2">
            <div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3 mb-2
                before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
                before:absolute before:-left-3 before:top-1/2 before:-translate-y-1/2"
            >
                {i18n(I18nKey.wallpaperMode)}
                <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md  active:scale-90"
                        class:opacity-0={wallpaperMode === defaultWallpaperMode} class:pointer-events-none={wallpaperMode === defaultWallpaperMode} onclick={resetWallpaperMode}>
                    <div class="text-(--btn-content)">
                        <Icon icon="fa7-solid:arrow-rotate-left" class="text-[0.875rem]"></Icon>
                    </div>
                </button>
            </div>
            <div class="space-y-1 px-1">
                <button
                    class="w-full btn-regular rounded-md py-2 px-3 flex items-center gap-3 text-left active:scale-95 transition-all relative overflow-hidden"
                    class:opacity-60={wallpaperMode !== WALLPAPER_BANNER}
                    class:bg-(--btn-regular-bg-hover)={wallpaperMode === WALLPAPER_BANNER}
                    onclick={() => switchWallpaperMode(WALLPAPER_BANNER)}
                >
                    <Icon icon="material-symbols:image-outline" class="text-[1.25rem] shrink-0"></Icon>
                    <span class="text-sm flex-1">{i18n(I18nKey.wallpaperBannerMode)}</span>
                    {#if wallpaperMode === WALLPAPER_BANNER}
                        <Icon icon="material-symbols:check-circle" class="text-[1rem] shrink-0 text-(--primary)"></Icon>
                    {/if}
                </button>
                <button
                    class="w-full btn-regular rounded-md py-2 px-3 flex items-center gap-3 text-left active:scale-95 transition-all relative overflow-hidden"
                    class:opacity-60={wallpaperMode !== WALLPAPER_OVERLAY}
                    class:bg-(--btn-regular-bg-hover)={wallpaperMode === WALLPAPER_OVERLAY}
                    onclick={() => switchWallpaperMode(WALLPAPER_OVERLAY)}
                >
                    <Icon icon="material-symbols:wallpaper" class="text-[1.25rem] shrink-0"></Icon>
                    <span class="text-sm flex-1">{i18n(I18nKey.wallpaperOverlayMode)}</span>
                    {#if wallpaperMode === WALLPAPER_OVERLAY}
                        <Icon icon="material-symbols:check-circle" class="text-[1rem] shrink-0 text-(--primary)"></Icon>
                    {/if}
                </button>
                <button
                    class="w-full btn-regular rounded-md py-2 px-3 flex items-center gap-3 text-left active:scale-95 transition-all relative overflow-hidden"
                    class:opacity-60={wallpaperMode !== WALLPAPER_NONE}
                    class:bg-(--btn-regular-bg-hover)={wallpaperMode === WALLPAPER_NONE}
                    onclick={() => switchWallpaperMode(WALLPAPER_NONE)}
                >
                    <Icon icon="material-symbols:hide-image-outline" class="text-[1.25rem] shrink-0"></Icon>
                    <span class="text-sm flex-1">{i18n(I18nKey.wallpaperNoneMode)}</span>
                    {#if wallpaperMode === WALLPAPER_NONE}
                        <Icon icon="material-symbols:check-circle" class="text-[1rem] shrink-0 text-(--primary)"></Icon>
                    {/if}
                </button>
            </div>
        </div>
    {/if}

    <!-- Banner Settings Section -->
    {#if wallpaperMode === WALLPAPER_BANNER && hasBannerSettings}
        <div class="mt-2 mb-2">
            <div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3 mb-2
                before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
                before:absolute before:-left-3 before:top-1/2 before:-translate-y-1/2"
            >
                {i18n(I18nKey.bannerSettings)}
                <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md  active:scale-90"
                        class:opacity-0={bannerSettingsIsDefault} class:pointer-events-none={bannerSettingsIsDefault} onclick={resetBannerSettings}>
                    <div class="text-(--btn-content)">
                        <Icon icon="fa7-solid:arrow-rotate-left" class="text-[0.875rem]"></Icon>
                    </div>
                </button>
            </div>
            <div class="space-y-1 px-1">
                <!-- Banner Title Switch -->
                {#if isBannerTitleSwitchable}
                <button
                    class="w-full btn-regular rounded-md py-2 px-3 flex items-center gap-3 text-left active:scale-95 transition-all relative overflow-hidden"
                    class:bg-(--btn-regular-bg-hover)={bannerTitleEnabled}
                    onclick={toggleBannerTitleEnabled}
                >
                    <Icon icon="material-symbols:titlecase-rounded" class="text-[1.25rem] shrink-0"></Icon>
                    <span class="text-sm flex-1">{i18n(I18nKey.bannerTitle)}</span>
                    <div class="w-10 h-5 rounded-full transition-all duration-200 relative"
                         class:bg-(--primary)={bannerTitleEnabled}
                         class:bg-(--btn-regular-bg-active)={!bannerTitleEnabled}>
                        <div class="absolute top-0.5 w-4 h-4 bg-white rounded-full shadow transition-all duration-200"
                             class:left-0.5={!bannerTitleEnabled}
                             class:left-5={bannerTitleEnabled}></div>
                    </div>
                </button>
                {/if}
                <!-- Waves Animation Switch -->
                {#if isWavesSwitchable}
                <button
                    class="w-full btn-regular rounded-md py-2 px-3 flex items-center gap-3 text-left active:scale-95 transition-all relative overflow-hidden"
                    class:bg-(--btn-regular-bg-hover)={wavesEnabled}
                    onclick={toggleWavesEnabled}
                >
                    <Icon icon="material-symbols:airwave-rounded" class="text-[1.25rem] shrink-0"></Icon>
                    <span class="text-sm flex-1">{i18n(I18nKey.wavesAnimation)}</span>
                    <div class="w-10 h-5 rounded-full transition-all duration-200 relative"
                         class:bg-(--primary)={wavesEnabled}
                         class:bg-(--btn-regular-bg-active)={!wavesEnabled}>
                        <div class="absolute top-0.5 w-4 h-4 bg-white rounded-full shadow transition-all duration-200"
                             class:left-0.5={!wavesEnabled}
                             class:left-5={wavesEnabled}></div>
                    </div>
                </button>
                {/if}
            </div>
        </div>
    {/if}

    <!-- Layout Switch Section -->
    {#if allowLayoutSwitch && !isSmallScreen}
        <div class="mt-2 mb-2">
            <div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3 mb-2
                before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
                before:absolute before:-left-3 before:top-1/2 before:-translate-y-1/2"
            >
                {i18n(I18nKey.postListLayout)}
                <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md  active:scale-90"
                        class:opacity-0={currentLayout === defaultLayout} class:pointer-events-none={currentLayout === defaultLayout} onclick={resetLayout}>
                    <div class="text-(--btn-content)">
                        <Icon icon="fa7-solid:arrow-rotate-left" class="text-[0.875rem]"></Icon>
                    </div>
                </button>
            </div>
            <div class="flex gap-2">
                <button
                    aria-label={i18n(I18nKey.postListLayoutList)}
                    class="flex-1 btn-regular rounded-md py-2 px-3 flex items-center justify-center gap-2 active:scale-95 transition-all relative overflow-hidden"
                    class:opacity-60={currentLayout !== 'list'}
                    class:bg-(--btn-regular-bg-hover)={currentLayout === 'list'}
                    disabled={isSwitching}
                    onclick={switchLayout}
                    title={i18n(I18nKey.postListLayoutList)}
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                    </svg>
                    <span class="text-xs font-medium">{i18n(I18nKey.postListLayoutList)}</span>
                    {#if currentLayout === 'list'}
                        <Icon icon="material-symbols:check-circle" class="text-[1rem] shrink-0 text-(--primary)"></Icon>
                    {/if}
                </button>
                <button
                    aria-label={i18n(I18nKey.postListLayoutGrid)}
                    class="flex-1 btn-regular rounded-md py-2 px-3 flex items-center justify-center gap-2 active:scale-95 transition-all relative overflow-hidden"
                    class:opacity-60={currentLayout !== 'grid'}
                    class:bg-(--btn-regular-bg-hover)={currentLayout === 'grid'}
                    disabled={isSwitching}
                    onclick={switchLayout}
                    title={i18n(I18nKey.postListLayoutGrid)}
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 3h7v7H3V3zm0 11h7v7H3v-7zm11-11h7v7h-7V3zm0 11h7v7h-7v-7z"/>
                    </svg>
                    <span class="text-xs font-medium">{i18n(I18nKey.postListLayoutGrid)}</span>
                    {#if currentLayout === 'grid'}
                        <Icon icon="material-symbols:check-circle" class="text-[1rem] shrink-0 text-(--primary)"></Icon>
                    {/if}
                </button>
            </div>
        </div>
    {/if}
</div>
{/if}


<style lang="stylus">
    #display-setting
      input[type="range"]
        -webkit-appearance none
        height 1.5rem
        background-image var(--color-selection-bar)
        transition background-image 0.15s ease-in-out

        /* Input Thumb */
        &::-webkit-slider-thumb
          -webkit-appearance none
          height 1rem
          width 0.5rem
          border-radius 0.125rem
          background rgba(255, 255, 255, 0.7)
          box-shadow none
          &:hover
            background rgba(255, 255, 255, 0.8)
          &:active
            background rgba(255, 255, 255, 0.6)

        &::-moz-range-thumb
          -webkit-appearance none
          height 1rem
          width 0.5rem
          border-radius 0.125rem
          border-width 0
          background rgba(255, 255, 255, 0.7)
          box-shadow none
          &:hover
            background rgba(255, 255, 255, 0.8)
          &:active
            background rgba(255, 255, 255, 0.6)

        &::-ms-thumb
          -webkit-appearance none
          height 1rem
          width 0.5rem
          border-radius 0.125rem
          background rgba(255, 255, 255, 0.7)
          box-shadow none
          &:hover
            background rgba(255, 255, 255, 0.8)
          &:active
            background rgba(255, 255, 255, 0.6)

</style>
</file>

<file path="components/controls/FloatingControls.astro">
---
import type { MarkdownHeading } from "astro";
import BackToHome from "./BackToHome.astro";
import BackToTop from "./BackToTop.astro";
import FloatingTOC from "./FloatingTOC.astro";

interface Props {
	headings?: MarkdownHeading[];
}

const { headings } = Astro.props;
---

<div class="floating-controls-container">
  <FloatingTOC headings={headings ?? []} />
  <BackToHome />
  <BackToTop />
</div>

<style>
  .floating-controls-container {
    position: fixed;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-end; /* 右对齐 */
    pointer-events: none; /* 容器不阻挡点击 */
    
    /* 默认桌面端位置 - 对应 BackToTop 的位置 */
    right: 1rem;
    bottom: 4rem;
  }

  /* 响应式调整 - 保持原有的位置逻辑 */
  @media (max-width: 1024px) {
    .floating-controls-container {
      right: 1rem;
      bottom: 4rem;
    }
  }

  @media (max-width: 768px) {
    .floating-controls-container {
      right: 0.75rem;
      bottom: 4rem;
      gap: 0.5rem;
    }
  }

  @media (max-width: 480px) {
    .floating-controls-container {
      right: 0.5rem;
      bottom: 4rem;
    }
  }

  /* 高缩放比例适配 */
  @media (min-resolution: 2dppx) {
    .floating-controls-container {
      right: max(0.5rem, 2rem - 2vw);
      bottom: max(3rem, 4rem - 5vh);
    }
  }
  
  /* 横屏模式适配 */
  @media (orientation: landscape) and (max-height: 500px) {
    .floating-controls-container {
      bottom: 4rem; 
    }
  }

  /* 极低分辨率适配 */
  @media (max-width: 320px) {
    .floating-controls-container {
        right: 0.125rem;
        bottom: 4rem;
    }
  }
</style>
</file>

<file path="components/controls/FloatingTOC.astro">
---
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";
import FloatingButton from "@/components/common/FloatingButton.astro";
import { sidebarLayoutConfig } from "@/config/sidebarConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import "@/styles/toc.css";

interface Props {
	headings: MarkdownHeading[];
}

let { headings: _ = [] } = Astro.props;
// ... (保留之前的逻辑)
// 检查侧边栏目录组件是否启用
const sidebarTocComponent = sidebarLayoutConfig.rightComponents?.find(
	(c) => c.type === "sidebarToc",
);
const isSidebarTocEnabled = sidebarTocComponent?.enable ?? false;
const sidebarPosition = sidebarLayoutConfig.position;
---

<!-- 悬浮TOC按钮 -->
<div id="floating-toc-wrapper" class="floating-toc-wrapper" data-is-sidebar-toc-enabled={String(isSidebarTocEnabled)} data-sidebar-position={sidebarPosition} data-show-both-sidebars-on-post={String(sidebarLayoutConfig.showBothSidebarsOnPostPage ?? false)}>
  <FloatingButton
    id="floating-toc-btn"
    icon="material-symbols:format-list-bulleted"
    ariaLabel="Table of Contents"
    onclick="window.toggleFloatingTOC()"
    class="hide"
  />
  
  <!-- 悬浮TOC面板 - 移到 Wrapper 内部以便相对定位 -->
  <div
    id="floating-toc-panel"
    class="floating-toc-panel hide w-80 max-h-96 overflow-hidden rounded-2xl shadow-2xl backdrop-blur-lg border border-white/20 bg-white/60 dark:bg-black/60 dark:border-white/10 md:w-80 w-[calc(100vw-2rem)] md:max-h-96 max-h-[calc(100vh-8rem)]"
    style="background-color: rgba(var(--card-bg-rgb, 255, 255, 255), 0.6);"
    >
    <div
        class="p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 backdrop-blur-xs z-10"
        style="background-color: rgba(var(--card-bg-rgb, 255, 255, 255), 0.6);"
    >
        <div class="flex items-center justify-between">
        <h3
            class="text-lg font-bold text-(--primary) flex items-center gap-2"
        >
            {i18n(I18nKey.tableOfContents)}
        </h3>
        <button
            onclick="window.toggleFloatingTOC()"
            aria-label="Close TOC"
            class="btn-plain rounded-lg h-8 w-8 active:scale-90"
        >
            <Icon name="material-symbols:close" class="text-lg" />
        </button>
        </div>
    </div>

    <div class="toc-scroll-container p-4">
        <div
        class="toc-content"
        id="floating-toc-content"
        style="width: 100%; max-width: 100%;"
        >
        <!-- TOC内容将由JavaScript动态生成 -->
        </div>
    </div>
  </div>
</div>

<style lang="stylus">
.floating-toc-wrapper
	position: relative
	z-index: 999
	overflow: visible

.floating-toc-panel
	position: absolute
	bottom: calc(100% + 1rem)
	right: 0
	transition: all 0.3s ease
	transform: translateY(20px)
	opacity: 0
	pointer-events: none
	overflow: hidden
	box-sizing: border-box
	backdrop-filter: blur(20px)
	-webkit-backdrop-filter: blur(20px)
	z-index: 1001
	
	&.show
		transform: translateY(0)
		opacity: 1
		pointer-events: auto
		
	&.hide
		transform: translateY(20px)
		opacity: 0
		pointer-events: none
		visibility: hidden
		
.toc-scroll-container
	max-height: calc(24rem - 5rem)
	
	@media (max-width: 768px)
		max-height: calc(24rem - 5rem)

/* 移动端隐藏活动指示器 */
@media (max-width: 768px)
	#floating-active-indicator
		display: none

/* 响应式调整 - 仅保留 Panel 尺寸调整 */
@media (max-width: 1024px)
	.floating-toc-panel
		width: calc(100vw - 2rem)
		max-width: 20rem
		max-height: 20rem

@media (max-width: 768px)
	.floating-toc-panel
		width: calc(100vw - 1.5rem)
		max-width: 20rem
		max-height: 28rem
		bottom: calc(100% + 1rem)

/* 暗色主题半透明效果 */
:global(.dark) .floating-toc-panel
	background-color: rgba(0, 0, 0, 0.6) !important
	backdrop-filter: blur(20px)
	-webkit-backdrop-filter: blur(20px)

:global(.dark) .floating-toc-panel .p-4
	background-color: rgba(0, 0, 0, 0.8) !important
</style>

<script>
  import { TOCManager, isPostPage } from "@/utils/tocUtils";

  // 从 data 属性读取配置
  const wrapper = document.querySelector('.floating-toc-wrapper');
  const isSidebarTocEnabled = wrapper?.getAttribute('data-is-sidebar-toc-enabled') === 'true';

  if (typeof window.FloatingTOC === "undefined") {
    window.FloatingTOC = {
      btn: null,
      panel: null,
      manager: null,
      isPostPage: isPostPage // 使用导入的工具函数
    };
  }

  // 切换 TOC 面板
  window.toggleFloatingTOC = function () {
    const panel = window.FloatingTOC.panel;
    if (!panel) return;

    const isHidden = panel.classList.contains("hide");
    if (isHidden) {
      panel.classList.remove("hide");
      panel.classList.add("show");
    } else {
      panel.classList.remove("show");
      panel.classList.add("hide");
    }
  };

  // 关闭 TOC 面板
  function closeTOC() {
    const panel = window.FloatingTOC.panel;
    if (panel && !panel.classList.contains("hide")) {
      panel.classList.add("hide");
      panel.classList.remove("show");
    }
  }

  // 设置自动关闭功能
  function setupAutoClose() {
    // 监听页面卸载和隐藏
    window.addEventListener("beforeunload", closeTOC);
    window.addEventListener("pagehide", closeTOC);
    window.addEventListener("popstate", closeTOC);
    
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) closeTOC();
    });

    // 监听 Astro 页面切换
    document.addEventListener("astro:page-load", closeTOC);
    document.addEventListener("astro:before-preparation", closeTOC);

    // 监听 hashchange（排除TOC内部导航）
    window.addEventListener("hashchange", () => {
      if (!window.tocInternalNavigation) {
        closeTOC();
      }
      window.tocInternalNavigation = false;
    });

    // 监听外部链接点击
    document.addEventListener("click", (e) => {
      const target = e.target as Element | null;
      const link = target?.closest("a");
      if (!link || !link.href) return;

      const href = link.getAttribute("href");
      const isExternalLink = href && !href.startsWith("#") && !href.startsWith("javascript:");
      
      if (isExternalLink && !window.tocInternalNavigation) {
        const tocPanel = document.getElementById("floating-toc-panel");
        if (!tocPanel || !tocPanel.contains(link)) {
          closeTOC();
        }
      }
    });

    // 拦截 history API
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;

    history.pushState = function (...args) {
      closeTOC();
      return originalPushState.apply(this, args);
    };

    history.replaceState = function (...args) {
      closeTOC();
      return originalReplaceState.apply(this, args);
    };
  }

  // 检查是否应该显示悬浮目录
  function shouldShowFloatingTOC() {
    // 检查是否为文章页面
    if (!window.FloatingTOC.isPostPage()) {
      return false;
    }

    const wrapper = document.querySelector('.floating-toc-wrapper');
    const sidebarPosition = wrapper?.getAttribute('data-sidebar-position') || 'left';
    const showBothSidebarsOnPost = wrapper?.getAttribute('data-show-both-sidebars-on-post') === 'true';

    // 双侧边栏模式（含文章页临时双侧栏）：小屏幕或侧边栏目录未启用时显示悬浮目录
    const effectiveIsBothSidebars = sidebarPosition === 'both' || showBothSidebarsOnPost;
    if (effectiveIsBothSidebars) {
      const isSmallScreen = window.innerWidth < 1280;
      return isSmallScreen || !isSidebarTocEnabled;
    }

    // 单侧边栏模式（left或right），对侧没有侧边栏目录，始终显示悬浮目录
    return true;
  }

  // 更新悬浮目录的显示状态
  function updateFloatingTOCVisibility() {
    const btn = window.FloatingTOC.btn;
    if (!btn) return;

    if (shouldShowFloatingTOC()) {
      btn.classList.remove("hide");
    } else {
      btn.classList.add("hide");
      // 同时关闭面板
      closeTOC();
    }
  }

  // 初始化 FloatingTOC
  async function initFloatingTOC() {
    window.FloatingTOC.btn = document.getElementById("floating-toc-btn");
    window.FloatingTOC.panel = document.getElementById("floating-toc-panel");

    if (!window.FloatingTOC.btn || !window.FloatingTOC.panel) {
      return;
    }

    // 更新显示状态
    updateFloatingTOCVisibility();

    try {
      // 清理旧实例
      if (window.FloatingTOC.manager) {
        window.FloatingTOC.manager.cleanup();
      }

      // 创建新实例
      window.FloatingTOC.manager = new TOCManager({
        contentId: "floating-toc-content",
        indicatorId: "floating-active-indicator",
        maxLevel: 3,
        scrollOffset: 80,
      });

      // 初始化
      window.FloatingTOC.manager.init();

      // 设置点击事件 - 标记为 TOC 内部导航
      const tocContent = document.getElementById("floating-toc-content");
      if (tocContent) {
        tocContent.addEventListener("click", (e) => {
          const target = e.target as Element | null;
          const anchor = target?.closest('a[href^="#"]');
          if (anchor) {
            window.tocInternalNavigation = true;
          }
        }, { capture: true });
      }

      // 设置自动关闭
      setupAutoClose();
    } catch (error) {
      console.error("Failed to load TOCManager:", error);
    }
  }

  // 初始化
  initFloatingTOC();

  // 监听页面切换事件
  if (typeof window !== "undefined" && !window.floatingTOCListenersInitialized) {
    window.floatingTOCListenersInitialized = true;

    // Swup 路由切换
    document.addEventListener("swup:contentReplaced", () => {
      setTimeout(initFloatingTOC, 100);
    });
    
    // Astro 页面切换事件
    document.addEventListener("astro:page-load", () => {
      setTimeout(initFloatingTOC, 100);
    });
    
    // 浏览器导航事件
    window.addEventListener("popstate", () => {
      setTimeout(initFloatingTOC, 200);
    });

    // 监听布局模式切换（通过自定义事件）
    window.addEventListener('layoutChange', () => {
      updateFloatingTOCVisibility();
    });

    // 监听窗口大小变化
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        updateFloatingTOCVisibility();
      }, 300);
    });
  }
</script>
</file>

<file path="components/controls/LayoutSwitchButton.svelte">
<script lang="ts">
import { onMount } from "svelte";
import { siteConfig } from "@/config";

export let currentLayout: "list" | "grid" = "list";

/**
 * 文章列表布局切换按钮
 * 目前已弃用，已集成至DisplaySettingsIntegrated.svelte，当前文件保留以备将来可能的单独使用
 */

let mounted = false;
let isSmallScreen = false;
let isSwitching = false;

function checkScreenSize() {
	isSmallScreen = window.innerWidth < 1200;
	if (isSmallScreen) {
		currentLayout = "list";
	}
}

onMount(() => {
	mounted = true;
	checkScreenSize();

	// 从localStorage读取用户偏好，如果没有则使用传入的默认值
	const savedLayout = localStorage.getItem("postListLayout");
	if (savedLayout && (savedLayout === "list" || savedLayout === "grid")) {
		currentLayout = savedLayout;
	} else {
		// 如果没有保存的偏好，使用传入的默认布局（从props）
		// currentLayout已经在声明时设置了默认值
	}

	// 监听窗口大小变化
	window.addEventListener("resize", checkScreenSize);

	return () => {
		window.removeEventListener("resize", checkScreenSize);
	};
});

function switchLayout() {
	if (!mounted || isSmallScreen || isSwitching) return;

	isSwitching = true;
	currentLayout = currentLayout === "list" ? "grid" : "list";
	localStorage.setItem("postListLayout", currentLayout);

	// 触发自定义事件，通知父组件布局已改变
	const event = new CustomEvent("layoutChange", {
		detail: { layout: currentLayout },
	});
	window.dispatchEvent(event);

	// 动画完成后重置状态
	setTimeout(() => {
		isSwitching = false;
	}, 500);
}

// 监听布局变化事件
onMount(() => {
	const handleCustomEvent = (event: Event) => {
		const customEvent = event as CustomEvent<{ layout: "list" | "grid" }>;
		currentLayout = customEvent.detail.layout;
	};

	window.addEventListener("layoutChange", handleCustomEvent);

	return () => {
		window.removeEventListener("layoutChange", handleCustomEvent);
	};
});

// 监听PostPage的布局初始化事件
onMount(() => {
	const handleLayoutInit = () => {
		// 从PostPage获取当前布局状态
		const postListContainer = document.getElementById("post-list-container");
		if (postListContainer) {
			const isGridMode = postListContainer.classList.contains("grid-mode");
			currentLayout = isGridMode ? "grid" : "list";
		}
	};

	// 延迟执行，确保PostPage已经初始化
	setTimeout(handleLayoutInit, 100);

	return () => {
		// 清理函数
	};
});
</script>

{#if mounted && siteConfig.postListLayout.allowSwitch && !isSmallScreen}
  <button 
    aria-label="切换文章列表布局" 
    class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90 flex items-center justify-center theme-switch-btn {isSwitching ? 'switching' : ''}" 
    on:click={switchLayout}
    disabled={isSwitching}
    title={currentLayout === 'list' ? '切换到网格模式' : '切换到列表模式'}
  >
      {#if currentLayout === 'list'}
        <!-- 列表图标 -->
        <svg class="w-5 h-5 icon-transition" fill="currentColor" viewBox="0 0 24 24">
          <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
        </svg>
    {:else}
      <!-- 网格图标 -->
      <svg class="w-5 h-5 icon-transition" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 3h7v7H3V3zm0 11h7v7H3v-7zm11-11h7v7h-7V3zm0 11h7v7h-7v-7z"/>
      </svg>
    {/if}
  </button>
{/if}

<style>
    /* 确保主题切换按钮的背景色即时更新 */
    .theme-switch-btn::before {
        transition: transform 75ms ease-out, background-color 0ms !important;
    }

    /* 图标过渡动画 */
    .icon-transition {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    }

    /* 切换中的按钮动画 */
    .switching {
        pointer-events: none;
    }

    .switching .icon-transition {
        animation: iconRotate 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes iconRotate {
        0% {
            transform: rotate(0deg) scale(1);
            opacity: 1;
        }
        50% {
            transform: rotate(180deg) scale(0.8);
            opacity: 0.5;
        }
        100% {
            transform: rotate(360deg) scale(1);
            opacity: 1;
        }
    }

    /* 悬停效果增强 */
    .theme-switch-btn:not(.switching):hover .icon-transition {
        transform: scale(1.1);
    }

    /* 按钮禁用状态 */
    .theme-switch-btn:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }
</style>
</file>

<file path="components/controls/LightDarkSwitch.svelte">
<script lang="ts">
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { onMount } from "svelte";
import DropdownItem from "@/components/common/DropdownItem.svelte";
import DropdownPanel from "@/components/common/DropdownPanel.svelte";
import Icon from "@/components/common/Icon.svelte";
import { DARK_MODE, LIGHT_MODE, SYSTEM_MODE } from "@/constants/constants";
import type { LIGHT_DARK_MODE } from "@/types/config.ts";
import {
	applyThemeToDocument,
	getStoredTheme,
	setTheme,
} from "@/utils/setting-utils";

// Define Swup type for window object
interface SwupHooks {
	on(event: string, callback: () => void): void;
}

interface SwupInstance {
	hooks?: SwupHooks;
}

type WindowWithSwup = Window & { swup?: SwupInstance };

let mode: LIGHT_DARK_MODE = $state(LIGHT_MODE);
let displayedMode: LIGHT_DARK_MODE = $state(LIGHT_MODE); // 显示的实际主题（在system模式下会随系统变化）

function switchScheme(newMode: LIGHT_DARK_MODE) {
	mode = newMode;
	setTheme(newMode);
}

// 更新显示的主题（用于显示当前实际主题）
function updateDisplayedMode() {
	if (mode === SYSTEM_MODE) {
		// 如果是system模式，显示实际的系统主题
		const isSystemDark = window.matchMedia(
			"(prefers-color-scheme: dark)",
		).matches;
		displayedMode = isSystemDark ? DARK_MODE : LIGHT_MODE;
	} else {
		displayedMode = mode;
	}
}

// 使用onMount确保在组件挂载后正确初始化
onMount(() => {
	// 立即获取并设置正确的主题
	const storedTheme = getStoredTheme();
	mode = storedTheme;
	updateDisplayedMode();

	// 确保DOM状态与存储的主题一致（只对非system模式检查）
	if (storedTheme !== SYSTEM_MODE) {
		const currentTheme = document.documentElement.classList.contains("dark")
			? DARK_MODE
			: LIGHT_MODE;
		if (storedTheme !== currentTheme) {
			applyThemeToDocument(storedTheme);
		}
	}

	// 如果是system模式，监听系统主题变化
	if (storedTheme === SYSTEM_MODE) {
		const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
		const handleSystemChange = () => {
			updateDisplayedMode();
		};
		mediaQuery.addEventListener("change", handleSystemChange);
	}

	// 添加Swup监听
	const handleContentReplace = () => {
		const newTheme = getStoredTheme();
		mode = newTheme;
		updateDisplayedMode();
	};

	// 检查Swup是否已经加载
	const win = window as WindowWithSwup;
	if (win.swup?.hooks) {
		win.swup.hooks.on("content:replace", handleContentReplace);
	} else {
		document.addEventListener("swup:enable", () => {
			const w = window as WindowWithSwup;
			if (w.swup?.hooks) {
				w.swup.hooks.on("content:replace", handleContentReplace);
			}
		});
	}

	// 监听主题变化事件
	const handleThemeChange = () => {
		// 只有当mode不是system模式时才更新mode
		// system模式下，mode应该保持为SYSTEM_MODE，displayedMode会自动更新
		if (mode !== SYSTEM_MODE) {
			const newTheme = getStoredTheme();
			mode = newTheme;
			updateDisplayedMode();
		} else {
			// system模式下只需要更新displayedMode
			updateDisplayedMode();
		}
	};

	window.addEventListener("theme-change", handleThemeChange);

	// 清理函数
	return () => {
		window.removeEventListener("theme-change", handleThemeChange);
	};
});
</script>

<div class="relative z-50">
    <button aria-label="Light/Dark Mode" aria-haspopup="menu" class="relative btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="scheme-switch">
        <div class="absolute inset-0 flex items-center justify-center" class:opacity-0={displayedMode !== LIGHT_MODE}>
            <Icon icon="material-symbols:wb-sunny-outline-rounded" class="text-[1.25rem]"></Icon>
        </div>
        <div class="absolute inset-0 flex items-center justify-center" class:opacity-0={displayedMode !== DARK_MODE}>
            <Icon icon="material-symbols:dark-mode-outline-rounded" class="text-[1.25rem]"></Icon>
        </div>
    </button>
    <div id="theme-mode-panel" class="absolute transition float-panel-closed top-11 -right-2 pt-5 z-50" role="menu" aria-labelledby="scheme-switch">
        <DropdownPanel>
            <DropdownItem
                role="menuitem"
                isActive={mode === LIGHT_MODE}
                isLast={false}
                onclick={() => switchScheme(LIGHT_MODE)}
            >
                <Icon icon="material-symbols:wb-sunny-outline-rounded" class="text-[1.25rem] mr-3"></Icon>
                {i18n(I18nKey.lightMode)}
            </DropdownItem>
            <DropdownItem
                role="menuitem"
                isActive={mode === DARK_MODE}
                isLast={false}
                onclick={() => switchScheme(DARK_MODE)}
            >
                <Icon icon="material-symbols:dark-mode-outline-rounded" class="text-[1.25rem] mr-3"></Icon>
                {i18n(I18nKey.darkMode)}
            </DropdownItem>
            <DropdownItem
                role="menuitem"
                isActive={mode === SYSTEM_MODE}
                isLast={true}
                onclick={() => switchScheme(SYSTEM_MODE)}
            >
                <Icon icon="material-symbols:brightness-auto-outline-rounded" class="text-[1.25rem] mr-3"></Icon>
                {i18n(I18nKey.systemMode)}
            </DropdownItem>
        </DropdownPanel>
    </div>
</div>
</file>

<file path="components/controls/Search.svelte">
<script lang="ts">
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { navigateToPage } from "@utils/navigation-utils";
import { onMount } from "svelte";
import Icon from "@/components/common/Icon.svelte";
import type { SearchResult } from "@/global";
import { url as formatUrl, getSearchUrl } from "@/utils/url-utils";

// --- State ---
let keywordDesktop = "";
let keywordMobile = "";
let result: SearchResult[] = [];
let isSearching = false;
let initialized = false;
let debounceTimer: NodeJS.Timeout;

// --- Mocks for Dev Mode ---
const fakeResult: SearchResult[] = [
	{
		url: formatUrl("/"),
		meta: { title: "This Is a Fake Search Result" },
		excerpt:
			"Because Pagefind cannot work in the <mark>dev</mark> environment.",
	},
	{
		url: formatUrl("/"),
		meta: { title: "If You Want to Test the Search" },
		excerpt: "Try running <mark>npm build && npm preview</mark> instead.",
	},
];

// --- UI Logic ---
const togglePanel = () => {
	document
		.getElementById("search-panel")
		?.classList.toggle("float-panel-closed");
};

const setPanelVisibility = (show: boolean, isDesktop: boolean): void => {
	const panel = document.getElementById("search-panel");
	if (
		!panel ||
		(isDesktop && !keywordDesktop) ||
		(!isDesktop && !keywordMobile)
	)
		return;
	show
		? panel.classList.remove("float-panel-closed")
		: panel.classList.add("float-panel-closed");
};

const closeSearchPanel = (): void => {
	document.getElementById("search-panel")?.classList.add("float-panel-closed");
	keywordDesktop = "";
	keywordMobile = "";
	result = [];
};

const handleResultClick = (event: Event, url: string): void => {
	event.preventDefault();
	closeSearchPanel();
	navigateToPage(url);
};

// --- Core Search Logic ---
const search = async (keyword: string, isDesktop: boolean): Promise<void> => {
	if (!keyword) {
		setPanelVisibility(false, isDesktop);
		result = [];
		return;
	}
	if (!initialized) return;

	isSearching = true;

	clearTimeout(debounceTimer);
	debounceTimer = setTimeout(async () => {
		try {
			let searchResults: SearchResult[] = [];

			if (import.meta.env.PROD && window.pagefind) {
				const response = await window.pagefind.search(keyword);
				searchResults = await Promise.all(
					response.results.map((item) => item.data()),
				);
			} else if (import.meta.env.DEV) {
				searchResults = fakeResult;
			}

			result = searchResults;
			setPanelVisibility(true, isDesktop);
		} catch (error) {
			console.error("Search error:", error);
			result = [];
			setPanelVisibility(false, isDesktop);
		} finally {
			isSearching = false;
		}
	}, 300); // 300ms debounce
};

// --- Initialization onMount ---
onMount(() => {
	const initializePagefind = () => {
		initialized = true;
		if (keywordDesktop) search(keywordDesktop, true);
		if (keywordMobile) search(keywordMobile, false);
	};

	if (import.meta.env.DEV) {
		console.log("Pagefind mock enabled in development mode.");
		initializePagefind();
	} else {
		if (window.pagefind) {
			// If script already loaded
			initializePagefind();
		} else {
			// Listen for the event
			document.addEventListener("pagefindready", initializePagefind, {
				once: true,
			});
			document.addEventListener("pagefindloaderror", initializePagefind, {
				once: true,
			});
		}
	}
});

// --- Reactive Statements ---
$: if (initialized && (keywordDesktop || keywordDesktop === "")) {
	search(keywordDesktop, true);
}
$: if (initialized && (keywordMobile || keywordMobile === "")) {
	search(keywordMobile, false);
}
</script>

<!-- search bar for desktop view -->
<div id="search-bar" class="hidden lg:flex transition-all items-center h-11 mr-2 rounded-lg
      bg-black/4 hover:bg-black/6 focus-within:bg-black/6
      dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
">
    <Icon icon="material-symbols:search"
          class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30"></Icon>
    <input placeholder="{i18n(I18nKey.search)}" bind:value={keywordDesktop}
           on:focus={() => search(keywordDesktop, true)}
           class="transition-all pl-10 text-sm bg-transparent outline-0
         h-full w-40 active:w-60 focus:w-60 text-black/50 dark:text-white/50"
    >
</div>

<!-- toggle btn for phone/tablet view -->
<button on:click={togglePanel} aria-label="Search Panel" id="search-switch"
        class="btn-plain scale-animation lg:hidden! rounded-lg w-11 h-11 active:scale-90">
    <Icon icon="material-symbols:search" class="text-[1.25rem]"></Icon>
</button>

<!-- search panel -->
<div id="search-panel" class="float-panel float-panel-closed search-panel absolute md:w-120
top-20 left-4 md:left-[unset] right-4 shadow-2xl rounded-2xl p-2">

    <!-- search bar inside panel for phone/tablet -->
    <div id="search-bar-inside" class="flex relative lg:hidden transition-all items-center h-11 rounded-xl
      bg-black/4 hover:bg-black/6 focus-within:bg-black/6
      dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
  ">
        <Icon icon="material-symbols:search"
              class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30"></Icon>
        <input placeholder={i18n(I18nKey.search)} bind:value={keywordMobile}
               class="pl-10 absolute inset-0 text-sm bg-transparent outline-0
               focus:w-60 text-black/50 dark:text-white/50"
        >
    </div>

    <!-- search results -->
    {#if isSearching}
        <div class="transition first-of-type:mt-2 lg:first-of-type:mt-0 block rounded-xl text-lg px-3 py-2 text-50">
            {i18n(I18nKey.searchLoading)}
        </div>
    {:else if result.length > 0}
        {#each result.slice(0, 5) as item}
            <a href={item.url}
               on:click={(e) => handleResultClick(e, item.url)}
               class="transition first-of-type:mt-2 lg:first-of-type:mt-0 group block
           rounded-xl text-lg px-3 py-2 hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active)">
                <div class="transition text-90 inline-flex font-bold group-hover:text-(--primary)">
                    {@html item.meta.title}
                    <Icon icon="fa7-solid:chevron-right"
                          class="transition text-[0.75rem] translate-x-1 my-auto text-(--primary)"></Icon>
                </div>
                {#if item.excerpt.includes('<mark>')}
                    <div class="transition text-sm text-50" style="display: flex; align-items: flex-start; margin-top: 0.1rem">
                        <span style="display: inline-block; background-color: var(--btn-plain-bg-hover); color: var(--primary); padding: 0.1em 0.4em; border-radius: 5px; font-size: 0.75em; font-weight: 600; margin-right: 0.5em; shrink: 0;">
                            {i18n(I18nKey.searchSummary)}
                        </span>
                        <div>
                            {@html item.excerpt}
                        </div>
                    </div>
                {/if}

                {#if item.content && item.content.includes('<mark>')}
                    <div class="transition text-sm text-30" style="display: flex; align-items: flex-start; margin-top: 0.1rem">
                        <span style="display: inline-block; background-color: var(--btn-plain-bg-active); color: var(--primary); padding: 0.1em 0.4em; border-radius: 5px; font-size: 0.75em; font-weight: 600; margin-right: 0.5em; shrink: 0;">
                            {i18n(I18nKey.searchContent)}
                        </span>
                        <div>
                            {@html item.content}
                        </div>
                    </div>
                {/if}
            </a>
        {/each}
        {#if result.length > 5}
            <a href={getSearchUrl(keywordDesktop || keywordMobile)}
               on:click={(e) => handleResultClick(e, getSearchUrl(keywordDesktop || keywordMobile))}
               class="transition first-of-type:mt-2 lg:first-of-type:mt-0 group block rounded-xl text-lg px-3 py-2 hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) text-(--primary) font-bold text-center">
                <span class="inline-flex items-center">
                    {i18n(I18nKey.searchViewMore).replace('{count}', (result.length - 5).toString())}
                    <Icon icon="fa7-solid:arrow-right" class="transition text-[0.75rem] ml-1"></Icon>
                </span>
            </a>
        {/if}
    {:else if result.length === 0}
        <div class="transition first-of-type:mt-2 lg:first-of-type:mt-0 block rounded-xl text-lg px-3 py-2 text-50">
            {i18n(I18nKey.searchNoResults)}
        </div>
    {:else if keywordDesktop || keywordMobile}
        <div class="transition first-of-type:mt-2 lg:first-of-type:mt-0 block rounded-xl text-lg px-3 py-2 text-50">
            {i18n(I18nKey.searchTypeSomething)}
        </div>
    {/if}
</div>

<style>
    input:focus {
        outline: 0;
    }

    .search-panel {
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
</style>
</file>

<file path="components/controls/WallpaperSwitch.svelte">
<script lang="ts">
import {
	WALLPAPER_BANNER,
	WALLPAPER_NONE,
	WALLPAPER_OVERLAY,
} from "@constants/constants";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { getStoredWallpaperMode, setWallpaperMode } from "@utils/setting-utils";
import { onMount } from "svelte";
import DropdownItem from "@/components/common/DropdownItem.svelte";
import DropdownPanel from "@/components/common/DropdownPanel.svelte";
import Icon from "@/components/common/Icon.svelte";
import { backgroundWallpaper } from "@/config";
import type { WALLPAPER_MODE } from "@/types/config";

/**
 * 壁纸模式切换按钮
 * 目前已弃用，已集成至DisplaySettingsIntegrated.svelte，当前文件保留以备将来可能的单独使用
 */

let mode: WALLPAPER_MODE = $state(backgroundWallpaper.mode);

// 在组件挂载时从localStorage读取保存的模式
onMount(() => {
	mode = getStoredWallpaperMode();
});

function switchWallpaperMode(newMode: WALLPAPER_MODE) {
	mode = newMode;
	setWallpaperMode(newMode);
}
</script>

<!-- z-50 make the panel higher than other float panels -->
<div class="relative z-50">
	<button aria-label="Wallpaper Mode" aria-haspopup="menu" class="relative btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="wallpaper-mode-switch">
		<div class="absolute inset-0 flex items-center justify-center" class:opacity-0={mode !== WALLPAPER_BANNER}>
			<Icon icon="material-symbols:image-outline" class="text-[1.25rem]"></Icon>
		</div>
		<div class="absolute inset-0 flex items-center justify-center" class:opacity-0={mode !== WALLPAPER_OVERLAY}>
			<Icon icon="material-symbols:wallpaper" class="text-[1.25rem]"></Icon>
		</div>
		<div class="absolute inset-0 flex items-center justify-center" class:opacity-0={mode !== WALLPAPER_NONE}>
			<Icon icon="material-symbols:hide-image-outline" class="text-[1.25rem]"></Icon>
		</div>
	</button>
	<div id="wallpaper-mode-panel" class="absolute transition float-panel-closed top-11 -right-2 pt-5 z-50" role="menu" aria-labelledby="wallpaper-mode-switch">
		<DropdownPanel>
			<DropdownItem
				role="menuitem"
				isActive={mode === WALLPAPER_BANNER}
				isLast={false}
				onclick={() => switchWallpaperMode(WALLPAPER_BANNER)}
			>
				<Icon icon="material-symbols:image-outline" class="text-[1.25rem] mr-3"></Icon>
				{i18n(I18nKey.wallpaperBannerMode)}
			</DropdownItem>
			<DropdownItem
				role="menuitem"
				isActive={mode === WALLPAPER_OVERLAY}
				isLast={false}
				onclick={() => switchWallpaperMode(WALLPAPER_OVERLAY)}
			>
				<Icon icon="material-symbols:wallpaper" class="text-[1.25rem] mr-3"></Icon>
				{i18n(I18nKey.wallpaperOverlayMode)}
			</DropdownItem>
			<DropdownItem
				role="menuitem"
				isActive={mode === WALLPAPER_NONE}
				isLast={true}
				onclick={() => switchWallpaperMode(WALLPAPER_NONE)}
			>
				<Icon icon="material-symbols:hide-image-outline" class="text-[1.25rem] mr-3"></Icon>
				{i18n(I18nKey.wallpaperNoneMode)}
			</DropdownItem>
		</DropdownPanel>
	</div>
</div>
</file>

<file path="components/features/FancyboxManager.astro">
---
import "@fancyapps/ui/dist/fancybox/fancybox.css";
import "@/styles/fancybox-custom.css";
// Fancybox 管理器组件
---

<script>
  let Fancybox: any;

  async function setup() {
    const selectors = [
      ".custom-md img, #post-cover img, .moment-images img",
      ".moment-images a[data-fancybox]",
      "[data-fancybox]:not(.moment-images a)"
    ];

    // 检查页面是否存在需要 Fancybox 的元素
    const hasElements = selectors.some(selector => document.querySelector(selector));

    if (!hasElements) return;

    // 动态导入资源
    if (!Fancybox) {
      const mod = await import("@fancyapps/ui");
      Fancybox = mod.Fancybox;
    }

    // 通用配置
    const commonOptions = {
      Thumbs: {
        autoStart: true,
        showOnStart: "yes",
      },
      Toolbar: {
        display: {
          left: ["infobar"],
          middle: [
            "zoomIn",
            "zoomOut",
            "toggle1to1",
            "rotateCCW",
            "rotateCW",
            "flipX",
            "flipY",
          ],
          right: ["slideshow", "thumbs", "close"],
        },
      },
      animated: true,
      dragToClose: true,
      keyboard: {
        Escape: "close",
        Delete: "close",
        Backspace: "close",
        PageUp: "next",
        PageDown: "prev",
        ArrowUp: "next",
        ArrowDown: "prev",
        ArrowRight: "next",
        ArrowLeft: "prev",
      },
      fitToView: true,
      preload: 3,
      infinite: true,
      Panzoom: {
        maxScale: 3,
        minScale: 1,
      },
      caption: false,
    };

    // 绑定图片
    Fancybox.bind(".custom-md img, #post-cover img, .moment-images img", {
      ...commonOptions,
      groupAll: true,
      Carousel: {
        transition: "slide",
        preload: 2,
      },
    });

    // 绑定链接
    Fancybox.bind(".moment-images a[data-fancybox]", {
      ...commonOptions,
      source: (el: any) => el.getAttribute("data-src") || el.getAttribute("href"),
    });

    // 绑定其他
    Fancybox.bind("[data-fancybox]:not(.moment-images a)", commonOptions);
  }

  function cleanupFancybox() {
    if (Fancybox) {
      Fancybox.close();
      Fancybox.unbind(document.body);
    }
  }

  // 初始化
  setup();

  // Swup 生命周期整合
  document.addEventListener("swup:content:replace", setup);
  document.addEventListener("swup:visit:start", cleanupFancybox);
</script>
</file>

<file path="components/features/FontManager.astro">
---
import { siteConfig } from "@/config";

const { font: fontConfig } = siteConfig;

// 获取选中的字体
const getSelectedFonts = () => {
	if (!fontConfig.enable || !fontConfig.selected) return [];

	const selectedIds = Array.isArray(fontConfig.selected)
		? fontConfig.selected
		: [fontConfig.selected];

	return selectedIds
		.map((id) => fontConfig.fonts[id])
		.filter((font) => font?.src); // 过滤掉系统字体和不存在的字体
};

const selectedFonts = getSelectedFonts();

// 生成字体CSS类名
const generateFontClasses = () => {
	if (!fontConfig.enable) return [];

	const selectedIds = Array.isArray(fontConfig.selected)
		? fontConfig.selected
		: [fontConfig.selected];

	return selectedIds.map((id) => `font-${id}-enabled`);
};

const fontClasses = generateFontClasses();

// 生成font-family回退样式
const generateFontFamilyStyle = () => {
	if (!fontConfig.enable || !fontConfig.selected) return "";

	const selectedIds = Array.isArray(fontConfig.selected)
		? fontConfig.selected
		: [fontConfig.selected];

	const selectedFontFamilies = selectedIds
		.map((id) => fontConfig.fonts[id])
		.filter((font) => font)
		.map((font) => `"${font.family}"`);

	if (selectedFontFamilies.length === 0) return "";

	const fallbacks = fontConfig.fallback || [];
	const allFonts = [...selectedFontFamilies, ...fallbacks];

	return `font-family: ${allFonts.join(", ")};`;
};

const fontFamilyStyle = generateFontFamilyStyle();
---

<!-- 字体样式表链接 -->{
  selectedFonts.map((font) => {
    // 判断是否为外部链接
    const isExternalUrl =
      font.src.startsWith("http://") ||
      font.src.startsWith("https://") ||
      font.src.startsWith("//");

    if (isExternalUrl) {
      // 外部字体链接 (如 Google Fonts, CDN等)
      return <link rel="stylesheet" href={font.src} />;
    } else {
      // 本地字体文件
      return (
        <style
          set:html={`
        @font-face {
          font-family: "${font.family}";
          src: url("${font.src}") ${font.format ? `format("${font.format}")` : ""};
          ${font.weight ? `font-weight: ${font.weight};` : ""}
          ${font.style ? `font-style: ${font.style};` : ""}
          ${font.display ? `font-display: ${font.display};` : ""}
          ${font.unicodeRange ? `unicode-range: ${font.unicodeRange};` : ""}
        }
      `}
        />
      );
    }
  })
}

<!-- 字体预加载链接 -->
{
  fontConfig.enable &&
    fontConfig.preload &&
    selectedFonts
      .filter((font) => !font.src.startsWith("http"))
      .map((font) => (
        <link
          rel="preload"
          href={font.src}
          as="font"
          type={`font/${font.format || "woff2"}`}
          crossorigin
        />
      ))
}

<!-- 全局字体样式 -->
{
  fontConfig.enable && fontFamilyStyle && (
    <style
      set:html={`
    :root {
      --font-family-custom: ${selectedFonts.map((font) => `"${font.family}"`).join(", ")};
      --font-family-fallback: ${(fontConfig.fallback || []).join(", ")};
    }
    
    /* 应用自定义字体到body */
    body {
      ${fontFamilyStyle}
    }
    
    /* 为每个选中的字体生成对应的CSS类 */
    ${selectedFonts
      .map((font) => {
        return `
        .font-${font.id},
        .font-${font.id} * {
          font-family: "${font.family}", var(--font-family-fallback) !important;
        }
      `;
      })
      .join("\n")}
    
    /* 为整体启用字体的body添加类名 */
    ${fontClasses.map((className) => `.${className}`).join(",\n")} {
      /* 字体相关的全局样式可以在这里添加 */
    }
  `}
    />
  )
}

<script>
  // 字体加载优化和错误处理
  if (document.fonts && typeof document.fonts.ready !== "undefined") {
    document.fonts.ready
      .then(() => {
        console.log("All fonts have been loaded");

        // 触发自定义事件，通知字体加载完成
        document.dispatchEvent(new CustomEvent("fontsLoaded"));
      })
      .catch((error: Error) => {
        console.warn("Font loading failed:", error);
      });
  }

  // 字体加载性能监控
  if (typeof PerformanceObserver !== "undefined") {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === "resource") {
          // console.log(`Font resource loaded: ${entry.name} (${entry.duration.toFixed(2)}ms)`);
        }
      });
    });

    try {
      observer.observe({ entryTypes: ["resource"] });
    } catch (e) {
      // 浏览器不支持时静默失败
    }
  }
</script>
</file>

<file path="components/features/KatexManager.astro">
---
// KaTeX CSS - 直接在文章页加载
import "katex/dist/katex.min.css";
---
</file>

<file path="components/features/Live2DWidget.astro">
---
import MessageBox from "@/components/common/PioMessageBox.astro";
import type { Live2DModelConfig } from "@/types/config";
import { url } from "@/utils/url-utils";

interface Props {
	config: Live2DModelConfig;
}

const { config } = Astro.props;

// 获取位置和尺寸配置
const position = config.position || {
	corner: "bottom-right" as const,
	offsetX: 20,
	offsetY: 20,
};
const size = config.size || { width: 280, height: 250 };
---

<div
  id="live2d-widget"
  class="live2d-widget"
  style={`
    width: ${size.width}px;
    height: ${size.height}px;
    ${position.corner?.includes("right") ? "right" : "left"}: ${position.offsetX}px;
    ${position.corner?.includes("top") ? "top" : "bottom"}: ${position.offsetY}px;
  `}
>
  <canvas id="live2d-canvas" width={size.width} height={size.height}></canvas>
</div>

<!-- 引入消息框组件 -->
<MessageBox />

<script is:inline define:vars={{ config, modelPathUrl: url(config.model.path), sdkPath: url("/pio/static/live2d-sdk/live2d.min.js") }}>
  let motionGroups = {};
  let hitAreas = {};
  let currentMotionGroup = "idle";
  let currentMotionIndex = 0;

  // Use loadlive2d function from the working project
  function initLive2D() {
    if (!window.loadlive2d) {
      console.error("loadlive2d function not available");
      return;
    }

    if (!config.model || !config.model.path) {
      console.error("No model path configured");
      return;
    }

    const modelPath = modelPathUrl; // 使用重命名后的变量

    // Load model data first to get motion groups and hit areas
    fetch(modelPath)
      .then((response) => response.json())
      .then((data) => {
        motionGroups = data.motions || {};
        hitAreas = data.hit_areas_custom || data.hit_areas || {};

        console.log("Loaded model data:", {
          motionGroups: Object.keys(motionGroups),
          hitAreas: Object.keys(hitAreas),
        });

        // Load the model using loadlive2d
        window.loadlive2d("live2d-canvas", modelPath);

        // Setup interactions after a delay to ensure model is loaded
        setTimeout(() => {
          setupInteractions();
        }, 2000);
      })
      .catch((error) => {
        console.error("Failed to load model data:", error);
      });
  }

  // Setup click interactions and drag functionality
  function setupInteractions() {
    const canvas = document.getElementById("live2d-canvas");
    const container = document.getElementById("live2d-widget");
    if (!canvas || !container) return;

    canvas.addEventListener("click", handleClick);

    // 添加拖拽功能
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let containerStart = { x: 0, y: 0 };

    // 鼠标事件
    container.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return; // 只响应左键
      isDragging = true;
      dragStart = { x: e.clientX, y: e.clientY };

      const rect = container.getBoundingClientRect();
      containerStart = { x: rect.left, y: rect.top };

      container.style.cursor = "grabbing";
      e.preventDefault();
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;

      const deltaX = e.clientX - dragStart.x;
      const deltaY = e.clientY - dragStart.y;

      const newX = containerStart.x + deltaX;
      const newY = containerStart.y + deltaY;

      // 边界检查
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;

      const clampedX = Math.max(0, Math.min(newX, maxX));
      const clampedY = Math.max(0, Math.min(newY, maxY));

      container.style.left = clampedX + "px";
      container.style.right = "auto";
      container.style.top = clampedY + "px";
      container.style.bottom = "auto";
    });

    document.addEventListener("mouseup", () => {
      if (isDragging) {
        isDragging = false;
        container.style.cursor = "grab";
      }
    });

    // 触摸事件（移动端支持）
    container.addEventListener("touchstart", (e) => {
      if (e.touches.length !== 1) return;
      isDragging = true;
      const touch = e.touches[0];
      dragStart = { x: touch.clientX, y: touch.clientY };

      const rect = container.getBoundingClientRect();
      containerStart = { x: rect.left, y: rect.top };

      e.preventDefault();
    });

    document.addEventListener("touchmove", (e) => {
      if (!isDragging || e.touches.length !== 1) return;

      const touch = e.touches[0];
      const deltaX = touch.clientX - dragStart.x;
      const deltaY = touch.clientY - dragStart.y;

      const newX = containerStart.x + deltaX;
      const newY = containerStart.y + deltaY;

      // 边界检查
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;

      const clampedX = Math.max(0, Math.min(newX, maxX));
      const clampedY = Math.max(0, Math.min(newY, maxY));

      container.style.left = clampedX + "px";
      container.style.right = "auto";
      container.style.top = clampedY + "px";
      container.style.bottom = "auto";

      e.preventDefault();
    });

    document.addEventListener("touchend", () => {
      isDragging = false;
    });

    // 设置初始光标样式
    container.style.cursor = "grab";

    // 窗口大小变化时重新检查边界
    window.addEventListener("resize", () => {
      const rect = container.getBoundingClientRect();
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;

      if (rect.left > maxX) {
        container.style.left = maxX + "px";
        container.style.right = "auto";
      }
      if (rect.top > maxY) {
        container.style.top = maxY + "px";
        container.style.bottom = "auto";
      }
    });

    console.log("Live2D interactions and drag functionality setup complete");
  }

  // Handle click events
  function handleClick(event) {
    if (!motionGroups || Object.keys(motionGroups).length === 0) {
      console.log("No motion groups available");
      return;
    }

    const rect = event.target.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    // Convert to normalized coordinates
    const normalizedX = (x / rect.width) * 2 - 1;
    const normalizedY = -((y / rect.height) * 2 - 1);

    console.log("Click at:", { x: normalizedX, y: normalizedY });

    // Determine which motion to play based on hit areas
    let motionGroup = "tap_body"; // default

    // Check head area
    if (hitAreas.head_x && hitAreas.head_y) {
      const [headXMin, headXMax] = hitAreas.head_x;
      const [headYMin, headYMax] = hitAreas.head_y;

      if (
        normalizedX >= headXMin &&
        normalizedX <= headXMax &&
        normalizedY >= headYMin &&
        normalizedY <= headYMax
      ) {
        motionGroup = "flick_head";
        console.log("Head area clicked - playing flick_head motion");
      }
    }

    // Check body area (if not head)
    if (motionGroup === "tap_body" && hitAreas.body_x && hitAreas.body_y) {
      const [bodyXMin, bodyXMax] = hitAreas.body_x;
      const [bodyYMin, bodyYMax] = hitAreas.body_y;

      if (
        normalizedX >= bodyXMin &&
        normalizedX <= bodyXMax &&
        normalizedY >= bodyYMin &&
        normalizedY <= bodyYMax
      ) {
        console.log("Body area clicked - playing tap_body motion");
      }
    }

    // Play motion
    playMotion(motionGroup);

    // Show message
    showMessage();
  }

  // 消息框功能已移至公共组件 MessageBox.astro

  // Show random message using the common MessageBox component
  function showMessage() {
    const messages = config.interactive?.clickMessages || [
      "你好！伊利雅~",
      "有什么需要帮助的吗？",
      "今天天气真不错呢！",
      "要不要一起玩游戏？",
      "记得按时休息哦！",
    ];

    const randomMessage = messages[Math.floor(Math.random() * messages.length)];

    // 使用公共消息框组件
    if (window.showModelMessage) {
      window.showModelMessage(randomMessage, {
        containerId: "live2d-widget",
        displayTime: config.interactive?.messageDisplayTime || 3000
      });
    }
  }

  // Play motion from a specific group
  function playMotion(groupName) {
    if (!motionGroups[groupName] || motionGroups[groupName].length === 0) {
      console.log(`No motions available for group: ${groupName}`);
      // Fallback to any available motion group
      const availableGroups = Object.keys(motionGroups).filter(
        (key) => motionGroups[key].length > 0
      );
      if (availableGroups.length > 0) {
        groupName = availableGroups[0];
        console.log(`Using fallback group: ${groupName}`);
      } else {
        return;
      }
    }

    const motions = motionGroups[groupName];
    let motionIndex;

    if (groupName === currentMotionGroup) {
      // Cycle through motions in the same group
      currentMotionIndex = (currentMotionIndex + 1) % motions.length;
      motionIndex = currentMotionIndex;
    } else {
      // Random motion from new group
      motionIndex = Math.floor(Math.random() * motions.length);
      currentMotionIndex = motionIndex;
    }

    currentMotionGroup = groupName;

    console.log(`Playing motion ${motionIndex} from group ${groupName}`);

    // Trigger motion change by reloading model with different parameters
    // This is a workaround since we can't directly control motions in loadlive2d
    const canvas = document.getElementById("live2d-canvas");
    if (canvas && window.loadlive2d) {
      // Add motion info to canvas data for potential future use
      canvas.dataset.currentMotionGroup = groupName;
      canvas.dataset.currentMotionIndex = motionIndex;

      // Trigger a visual feedback
      canvas.style.transform = "scale(1.05)";
      setTimeout(() => {
        canvas.style.transform = "scale(1)";
      }, 150);
    }
  }

  // Load Live2D and initialize
  function loadLive2DSDK() {
    // 检查移动端显示设置，如果隐藏则不加载运行时
    if (
      config.responsive?.hideOnMobile &&
      window.innerWidth <= (config.responsive.mobileBreakpoint || 768)
    ) {
      console.log("📱 Mobile device detected, skipping Live2D model initialization");
      const widget = document.getElementById("live2d-widget");
      if (widget) widget.style.display = "none";
      return;
    }

    // Check if Live2D SDK is already loaded
    if (window.loadlive2d) {
      initLive2D();
      return;
    }

    // Load Live2D SDK
    const script = document.createElement("script");
    script.src = sdkPath;
    script.onload = () => {
      // Wait a bit for the SDK to initialize
      setTimeout(() => {
        if (window.loadlive2d) {
          initLive2D();
        } else {
          console.error("loadlive2d function not found after loading SDK");
        }
      }, 100);
    };
    script.onerror = () => {
      console.error("Failed to load Live2D SDK");
    };
    document.head.appendChild(script);
  }

  // Handle responsive display
  function handleResponsive() {
    const widget = document.getElementById("live2d-widget");
    if (!widget) return;

    const responsive = config.responsive;
    if (responsive?.hideOnMobile) {
      const breakpoint = responsive.mobileBreakpoint || 768;
      if (window.innerWidth <= breakpoint) {
        widget.style.display = "none";
      } else {
        widget.style.display = "block";
      }
    }
  }

  // Initialize when ready (only once)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      // 检查是否已经初始化
      if (!window.live2dModelInitialized) {
        loadLive2DSDK();
        window.live2dModelInitialized = true;
      }
      handleResponsive();
    });
  } else {
    // 检查是否已经初始化
    if (!window.live2dModelInitialized) {
      loadLive2DSDK();
      window.live2dModelInitialized = true;
    }
    handleResponsive();
  }

  // Handle window resize for responsive behavior
  window.addEventListener("resize", handleResponsive);

  // 监听 Swup 页面切换事件（如果使用了 Swup）
  if (typeof window.swup !== "undefined" && window.swup.hooks) {
    window.swup.hooks.on("content:replace", () => {
      // 只更新响应式显示，不重新创建模型
      setTimeout(() => {
        handleResponsive();
      }, 100);
    });
  } else {
    // 如果 Swup 还未加载，监听启用事件
    document.addEventListener("swup:enable", () => {
      if (window.swup && window.swup.hooks) {
        window.swup.hooks.on("content:replace", () => {
          setTimeout(() => {
            handleResponsive();
          }, 100);
        });
      }
    });
  }
</script>

<style>
  .live2d-widget {
    position: fixed;
    z-index: 999;
    pointer-events: auto; /* 启用指针事件以支持拖拽 */
    cursor: grab; /* 默认显示拖拽光标 */
  }

  #live2d-canvas {
    pointer-events: auto;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    height: 100%;
  }

  .live2d-widget:hover #live2d-canvas {
    opacity: 1;
  }

  /* 拖拽时的光标样式 */
  .live2d-widget:active {
    cursor: grabbing;
  }
</style>
</file>

<file path="components/features/MusicManager.astro">
---
import { musicPlayerConfig } from "@/config/musicConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { url } from "@/utils/url-utils";

const config = musicPlayerConfig;

const localPlaylist =
	config.mode === "local" && config.local?.playlist
		? config.local.playlist.map((song) => {
				const isFullUrl = (path: string) => /^https?:\/\//.test(path);
				return {
					name: song.name,
					artist: song.artist,
					url: isFullUrl(song.url) ? song.url : url(song.url),
					pic: song.cover
						? isFullUrl(song.cover)
							? song.cover
							: url(song.cover)
						: undefined,
					lrc: song.lrc
						? isFullUrl(song.lrc)
							? song.lrc
							: url(song.lrc)
						: undefined,
				};
			})
		: [];

const managerConfigStr = JSON.stringify({
	mode: config.mode,
	meting: config.meting,
	localPlaylist: localPlaylist,
	volume: config.volume ?? 0.7,
	playMode: config.playMode ?? "list",
	showLyrics: config.showLyrics ?? true,
	i18n: {
		noPlaying: i18n(I18nKey.musicNoPlaying),
		lyrics: i18n(I18nKey.musicLyrics),
		volume: i18n(I18nKey.musicVolume),
		playMode: i18n(I18nKey.musicPlayMode),
		prev: i18n(I18nKey.musicPrev),
		next: i18n(I18nKey.musicNext),
		playlist: i18n(I18nKey.musicPlaylist),
		noLyrics: i18n(I18nKey.musicNoLyrics),
		loadingLyrics: i18n(I18nKey.musicLoadingLyrics),
		failedLyrics: i18n(I18nKey.musicFailedLyrics),
		noSongs: i18n(I18nKey.musicNoSongs),
		error: i18n(I18nKey.musicError),
		play: i18n(I18nKey.musicPlay),
		pause: i18n(I18nKey.musicPause),
		progress: i18n(I18nKey.musicProgress),
		noCover: i18n(I18nKey.musicNoCover),
	},
});
---

<script is:inline data-swup-ignore-script define:vars={{ managerConfigStr }}>
(function () {
    // Singleton guard – only create once
    if (window.__fireflyMusic) return;

    var config = JSON.parse(managerConfigStr);

    // ── Helpers ──────────────────────────────────────────────
    function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        var min = Math.floor(seconds / 60);
        var sec = Math.floor(seconds % 60);
        return min + ':' + (sec < 10 ? '0' : '') + sec;
    }

    function parseLRC(lrc) {
        if (!lrc) return [];
        var lines = lrc.split('\n');
        var result = [];
        var timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g;
        lines.forEach(function (line) {
            var matches = Array.from(line.matchAll(timeReg));
            if (matches.length > 0) {
                var text = line.replace(timeReg, '').trim();
                if (text) {
                    matches.forEach(function (match) {
                        var m = parseInt(match[1]);
                        var s = parseInt(match[2]);
                        var ms = parseInt(match[3]);
                        var time = m * 60 + s + ms / (match[3].length === 3 ? 1000 : 100);
                        result.push({ time: time, text: text });
                    });
                }
            }
        });
        return result.sort(function (a, b) { return a.time - b.time; });
    }

    // ── Audio element (persistent, attached to body) ────────
    var audio = document.createElement('audio');
    audio.crossOrigin = 'anonymous';
    audio.style.display = 'none';
    document.body.appendChild(audio);

    // ── State ────────────────────────────────────────────────
    var state = {
        playlist: [],
        currentIndex: 0,
        isPlaying: false,
        playMode: 0, // 0: list, 1: one, 2: random
        volume: localStorage.getItem('music-player-volume') !== null
            ? parseFloat(localStorage.getItem('music-player-volume'))
            : (config.volume || 0.7),
        isMuted: false,
        lyrics: [],
        currentLrcIndex: -1,
        initialized: false,
        initializing: false,
        error: null
    };

    // Map config playMode string to number
    if (config.playMode === 'random') state.playMode = 2;
    else if (config.playMode === 'one') state.playMode = 1;
    else state.playMode = 0;

    // ── Event helpers ────────────────────────────────────────
    function emit(name, detail) {
        window.dispatchEvent(new CustomEvent(name, { detail: detail || {} }));
    }

    // ── Meting fetch ─────────────────────────────────────────
    async function fetchMetingData() {
        if (!config.meting) return;
        var m = config.meting;
        var apis = [m.api].concat(m.fallbackApis || []);

        for (var i = 0; i < apis.length; i++) {
            var baseApi = apis[i];
            if (!baseApi) continue;
            try {
                var fetchUrl = baseApi
                    .replace(':server', m.server)
                    .replace(':type', m.type)
                    .replace(':id', m.id)
                    .replace(':r', Math.random());
                if (m.auth) fetchUrl += '&auth=' + m.auth;

                var res = await fetch(fetchUrl);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                var data = await res.json();

                if (Array.isArray(data) && data.length > 0) {
                    state.playlist = data.map(function (item) {
                        return {
                            name: item.title || item.name || 'Unknown',
                            artist: item.author || item.artist || 'Unknown',
                            url: item.url,
                            pic: item.pic || item.cover || '',
                            lrc: item.lrc
                        };
                    });
                    return;
                }
            } catch (e) {
                console.warn('Meting API failed for ' + baseApi, e);
            }
        }
        throw new Error('All Meting APIs failed');
    }

    // ── Lyrics ───────────────────────────────────────────────
    function loadLyrics(track) {
        state.lyrics = [];
        state.currentLrcIndex = -1;

        if (!track.lrc) {
            emit('fm:lyrics', { lyrics: [], status: 'none' });
            return;
        }

        var isLrcUrl = /^(https?:)?\/\//.test(track.lrc)
            || track.lrc.startsWith('/')
            || /\.(lrc|txt)(\?|#|$)/i.test(track.lrc);

        if (isLrcUrl) {
            emit('fm:lyrics', { lyrics: [], status: 'loading' });
            fetch(track.lrc)
                .then(function (r) { return r.text(); })
                .then(function (text) {
                    state.lyrics = parseLRC(text);
                    emit('fm:lyrics', { lyrics: state.lyrics, status: 'loaded' });
                })
                .catch(function () {
                    state.lyrics = [];
                    emit('fm:lyrics', { lyrics: [], status: 'failed' });
                });
        } else {
            state.lyrics = parseLRC(track.lrc);
            emit('fm:lyrics', { lyrics: state.lyrics, status: state.lyrics.length > 0 ? 'loaded' : 'none' });
        }
    }

    // ── Track loading ────────────────────────────────────────
    function loadTrack(index, autoPlay) {
        if (index < 0 || index >= state.playlist.length) return;
        state.currentIndex = index;
        var track = state.playlist[index];

        audio.src = track.url;

        loadLyrics(track);

        emit('fm:track', { index: index, track: track, autoPlay: !!autoPlay });

        if (autoPlay) {
            audio.play().then(function () {
                state.isPlaying = true;
                emit('fm:play-state', { isPlaying: true });
            }).catch(function (e) {
                console.warn('Autoplay blocked:', e);
            });
        } else {
            state.isPlaying = false;
            emit('fm:play-state', { isPlaying: false });
        }
    }

    // ── Playback controls ────────────────────────────────────
    function togglePlay() {
        if (audio.paused) {
            audio.play().then(function () {
                state.isPlaying = true;
                emit('fm:play-state', { isPlaying: true });
            });
        } else {
            audio.pause();
            state.isPlaying = false;
            emit('fm:play-state', { isPlaying: false });
        }
    }

    function playNext(auto) {
        if (state.playMode === 1 && auto) {
            audio.currentTime = 0;
            audio.play();
            return;
        }
        var nextIndex;
        if (state.playMode === 2) {
            nextIndex = Math.floor(Math.random() * state.playlist.length);
        } else {
            nextIndex = (state.currentIndex + 1) % state.playlist.length;
        }
        loadTrack(nextIndex, true);
    }

    function playPrev() {
        var prevIndex;
        if (state.playMode === 2) {
            prevIndex = Math.floor(Math.random() * state.playlist.length);
        } else {
            prevIndex = (state.currentIndex - 1 + state.playlist.length) % state.playlist.length;
        }
        loadTrack(prevIndex, true);
    }

    function setPlayMode(mode) {
        state.playMode = mode;
        emit('fm:mode', { playMode: mode });
    }

    function cyclePlayMode() {
        setPlayMode((state.playMode + 1) % 3);
    }

    function setVolume(val) {
        val = Math.max(0, Math.min(1, val));
        state.volume = val;
        state.isMuted = false;
        audio.volume = val;
        audio.muted = false;
        localStorage.setItem('music-player-volume', val.toString());
        emit('fm:volume', { volume: val, isMuted: false });
    }

    function toggleMute() {
        state.isMuted = !state.isMuted;
        audio.muted = state.isMuted;
        emit('fm:volume', { volume: state.volume, isMuted: state.isMuted });
    }

    function seek(percent) {
        if (!audio.duration) return;
        audio.currentTime = Math.max(0, Math.min(1, percent)) * audio.duration;
    }

    function seekToTime(time) {
        if (!audio.duration) return;
        audio.currentTime = Math.max(0, Math.min(time, audio.duration));
    }

    function playTrackByIndex(index) {
        if (index === state.currentIndex && !audio.paused) {
            togglePlay();
        } else {
            loadTrack(index, true);
        }
    }

    // ── Audio events → broadcast ─────────────────────────────
    audio.addEventListener('timeupdate', function () {
        if (isNaN(audio.duration)) return;
        var ct = audio.currentTime;
        var dur = audio.duration;
        var pct = (ct / dur) * 100;

        emit('fm:time', {
            currentTime: ct,
            duration: dur,
            progress: pct,
            currentTimeStr: formatTime(ct),
            durationStr: formatTime(dur)
        });

        // Lyrics sync
        if (state.lyrics.length > 0) {
            var idx = -1;
            for (var i = 0; i < state.lyrics.length; i++) {
                if (ct >= state.lyrics[i].time) idx = i;
                else break;
            }
            if (idx !== state.currentLrcIndex) {
                state.currentLrcIndex = idx;
                emit('fm:lrc-index', { index: idx });
            }
        }
    });

    audio.addEventListener('ended', function () {
        playNext(true);
    });

    audio.addEventListener('error', function () {
        state.error = 'Audio playback error';
        emit('fm:error', { message: state.error });
    });

    // ── Init (idempotent) ────────────────────────────────────
    async function init() {
        if (state.initialized || state.initializing) return;
        state.initializing = true;

        try {
            if (config.mode === 'meting' && config.meting) {
                await fetchMetingData();
            } else if (config.mode === 'local') {
                state.playlist = config.localPlaylist || [];
            }

            if (state.playlist.length > 0) {
                // Apply volume
                audio.volume = state.volume;

                var startIndex = 0;
                if (state.playMode === 2) {
                    startIndex = Math.floor(Math.random() * state.playlist.length);
                }

                state.initialized = true;

                emit('fm:init', {
                    playlist: state.playlist,
                    playMode: state.playMode,
                    volume: state.volume,
                    isMuted: state.isMuted
                });

                loadTrack(startIndex, false);
            } else {
                state.initialized = true;
                emit('fm:init', {
                    playlist: [],
                    playMode: state.playMode,
                    volume: state.volume,
                    isMuted: state.isMuted
                });
                emit('fm:error', { message: config.i18n.noSongs });
            }
        } catch (e) {
            console.error('Music Manager init error:', e);
            state.initialized = true;
            emit('fm:init', {
                playlist: [],
                playMode: state.playMode,
                volume: state.volume,
                isMuted: state.isMuted
            });
            emit('fm:error', { message: config.i18n.error });
        } finally {
            state.initializing = false;
        }
    }

    // ── Public API ───────────────────────────────────────────
    window.__fireflyMusic = {
        init: init,
        getState: function () {
            var track = state.playlist[state.currentIndex] || null;
            return {
                playlist: state.playlist,
                currentIndex: state.currentIndex,
                track: track,
                isPlaying: state.isPlaying,
                playMode: state.playMode,
                volume: state.volume,
                isMuted: state.isMuted,
                currentTime: audio.currentTime,
                duration: audio.duration || 0,
                progress: audio.duration ? (audio.currentTime / audio.duration) * 100 : 0,
                currentTimeStr: formatTime(audio.currentTime),
                durationStr: formatTime(audio.duration),
                lyrics: state.lyrics,
                currentLrcIndex: state.currentLrcIndex,
                initialized: state.initialized,
                error: state.error,
                config: config
            };
        },
        togglePlay: togglePlay,
        playNext: function () { playNext(false); },
        playPrev: playPrev,
        cyclePlayMode: cyclePlayMode,
        setVolume: setVolume,
        toggleMute: toggleMute,
        seek: seek,
        seekToTime: seekToTime,
        playTrackByIndex: playTrackByIndex,
        loadTrack: loadTrack
    };
})();
</script>
</file>

<file path="components/features/MusicPlayer.astro">
---
import { Icon } from "astro-icon/components";
import { musicPlayerConfig } from "@/config/musicConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

interface Props {
	class?: string;
	style?: string;
	id?: string;
}
const { class: className, style, id } = Astro.props;

const config = musicPlayerConfig;

const viewConfigStr = JSON.stringify({
	showLyrics: config.showLyrics ?? true,
	i18n: {
		noPlaying: i18n(I18nKey.musicNoPlaying),
		lyrics: i18n(I18nKey.musicLyrics),
		noLyrics: i18n(I18nKey.musicNoLyrics),
		loadingLyrics: i18n(I18nKey.musicLoadingLyrics),
		failedLyrics: i18n(I18nKey.musicFailedLyrics),
		noSongs: i18n(I18nKey.musicNoSongs),
		error: i18n(I18nKey.musicError),
		play: i18n(I18nKey.musicPlay),
		pause: i18n(I18nKey.musicPause),
		noCover: i18n(I18nKey.musicNoCover),
		music: i18n(I18nKey.music),
	},
});

const widgetId =
	id || `music-widget-${Math.random().toString(36).substring(2, 9)}`;
---

<div id={widgetId} class:list={["music-player-widget w-full relative transition-all duration-300", className]} style={style} role="region" aria-label={i18n(I18nKey.music)}>

    <!-- Top Row: Cover & Info -->
<div class="flex items-center gap-2 mb-2 px-1">
    <!-- Circular Cover -->
    <div class="relative shrink-0 w-14 h-14 group">
            <div class="w-full h-full rounded-full overflow-hidden shadow-lg border-2 border-white dark:border-neutral-700 relative z-10 bg-[var(--primary)]/10 flex items-center justify-center">
            <Icon name="material-symbols:music-note-rounded" class="text-2xl text-[var(--primary)] opacity-40 absolute" aria-hidden="true" />
            <img class="music-cover w-full h-full object-cover animate-spin-slow relative z-10 opacity-0 transition-opacity duration-300" src="" alt={i18n(I18nKey.musicCover)} style="animation-play-state: paused;" />
            </div>
    </div>

    <!-- Info Section -->
    <div class="flex-1 min-w-0 flex flex-col overflow-hidden">
        <div class="flex items-center justify-between overflow-hidden gap-2">
            <div class="flex-1 min-w-0 overflow-hidden relative">
                <h3 class="music-title font-bold text-base text-neutral-800 dark:text-neutral-100 leading-tight truncate">
                    {i18n(I18nKey.music)}
                </h3>
            </div>
            <!-- Top Right: Lyric Toggle -->
            <button class={`btn-lrc-toggle hover:text-[var(--primary)] transition-all duration-300 p-0.5 pr-2 transform active:scale-95 text-neutral-400 shrink-0 ${!config.showLyrics ? 'hidden' : ''}`} title={i18n(I18nKey.musicLyrics)} aria-label={i18n(I18nKey.musicLyrics)}>
                <Icon name="material-symbols:subtitles-off-outline-rounded" class="icon-lrc-off text-xl" aria-hidden="true" />
                <Icon name="material-symbols:subtitles-outline-rounded" class="icon-lrc-on text-xl hidden" aria-hidden="true" />
            </button>
        </div>

        <div class="min-w-0 overflow-hidden">
            <p class="music-artist text-xs font-medium text-neutral-500 dark:text-neutral-400 truncate">
                {i18n(I18nKey.musicNoPlaying)}
            </p>
        </div>

        <!-- Time Display & Volume -->
        <div class="flex items-center gap-3 text-neutral-400 h-5">
            <div class="text-[10px] font-mono flex items-center gap-1 shrink-0 h-full" aria-live="polite">
                <span class="current-time">0:00</span>
                <span class="opacity-50" aria-hidden="true">/</span>
                <span class="total-time">0:00</span>
            </div>

            <!-- Volume (Always visible) -->
            <div class="flex items-center gap-1 bg-transparent h-full">
                <button class="btn-mute hover:text-[var(--primary)] transition-colors p-0.5 rounded-md flex items-center" title={i18n(I18nKey.musicVolume)} aria-label={i18n(I18nKey.musicVolume)}>
                    <Icon name="material-symbols:volume-up-rounded" class=" icon-vol-high text-lg" aria-hidden="true" />
                    <Icon name="material-symbols:volume-off-rounded" class="icon-vol-mute text-lg hidden" aria-hidden="true" />
                </button>
                <div class="w-16 transition-all duration-300 ease-out flex items-center">
                    <div class="vol-container h-1 w-16 bg-neutral-200 dark:bg-neutral-600 rounded-full cursor-pointer relative ml-1" role="slider" aria-label={i18n(I18nKey.musicVolume)} aria-valuemin="0" aria-valuemax="100" aria-valuenow="70">
                        <div class="vol-bar absolute left-0 top-0 h-full bg-[var(--primary)] rounded-full w-[70%]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar (Slim) -->
<div class="progress-container relative w-full h-1 bg-neutral-100 dark:bg-neutral-700/50 rounded-full cursor-pointer touch-none mb-2 group mt-2" role="slider" aria-label={i18n(I18nKey.musicProgress)} aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
    <div class="progress-bar absolute left-0 top-0 h-full bg-[var(--primary)] rounded-full w-0 transition-[width] duration-100"></div>
    <!-- Hover Thumb -->
    <div class="progress-thumb absolute top-1/2 -mt-1.5 -ml-1.5 w-3 h-3 bg-[var(--primary)] ring-2 ring-white dark:ring-neutral-800 rounded-full shadow-sm scale-0 group-hover:scale-100 transition-transform duration-200"></div>
</div>

<!-- Controls Row -->
<div class="flex items-center justify-between px-1 select-none">
    <!-- Repeat Mode -->
    <button class="btn-repeat text-neutral-300 dark:text-neutral-600 hover:text-[var(--primary)] transition-colors p-2 active:scale-95" title={i18n(I18nKey.musicPlayMode)} aria-label={i18n(I18nKey.musicPlayMode)}>
        <Icon name="material-symbols:repeat-rounded" class="icon-repeat text-xl" aria-hidden="true" />
        <Icon name="material-symbols:repeat-one-rounded" class="icon-repeat-one text-xl hidden" aria-hidden="true" />
        <Icon name="material-symbols:shuffle-rounded" class="icon-shuffle text-xl hidden" aria-hidden="true" />
    </button>

    <!-- Prev -->
    <button class="btn-prev text-neutral-600 dark:text-neutral-300 hover:text-[var(--primary)] transition-colors p-2 active:scale-95" title={i18n(I18nKey.musicPrev)} aria-label={i18n(I18nKey.musicPrev)}>
        <Icon name="material-symbols:skip-previous-rounded" class="text-3xl" aria-hidden="true" />
    </button>

    <!-- Play/Pause (Feature) -->
    <button class="btn-play w-12 h-12 bg-[var(--btn-regular-bg)] hover:bg-[var(--btn-regular-bg-hover)] active:bg-[var(--btn-regular-bg-active)] text-[var(--primary)] rounded-full flex items-center justify-center transition-all duration-300" title={i18n(I18nKey.musicPlay)} aria-label={i18n(I18nKey.musicPlay)}>
        <Icon name="material-symbols:play-arrow-rounded" class="icon-play text-3xl ml-0.5" aria-hidden="true" />
        <Icon name="material-symbols:pause-rounded" class="icon-pause text-3xl hidden" aria-hidden="true" />
    </button>

    <!-- Next -->
    <button class="btn-next text-neutral-600 dark:text-neutral-300 hover:text-[var(--primary)] transition-colors p-2 active:scale-95" title={i18n(I18nKey.musicNext)} aria-label={i18n(I18nKey.musicNext)}>
        <Icon name="material-symbols:skip-next-rounded" class="text-3xl" aria-hidden="true" />
    </button>

    <!-- Playlist Toggle Arrow -->
    <button class="btn-drawer-toggle text-neutral-400 hover:text-[var(--primary)] transition-all duration-300 p-2 transform active:scale-95" title={i18n(I18nKey.musicPlaylist)} aria-label={i18n(I18nKey.musicPlaylist)}>
        <Icon name="mdi:playlist-music" class="text-xl" aria-hidden="true" />
    </button>
</div>

<!-- Lyrics Drawer -->
<div class="lrc-drawer grid transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] grid-rows-[0fr] opacity-0">
    <div class="overflow-hidden min-h-0">
        <div class="mt-2 pt-2 border-t border-neutral-100 dark:border-white/5 mx-1">
            <div class="lrc-container h-48 overflow-y-auto custom-scrollbar flex flex-col items-center gap-2 p-4 py-24 text-center relative scroll-smooth" role="listbox" aria-label={i18n(I18nKey.musicLyrics)}>
                <div class="text-neutral-400 text-sm py-10" role="option">{i18n(I18nKey.musicNoLyrics)}</div>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Drawer (Accordion) -->
<div class="playlist-drawer grid transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] grid-rows-[0fr] opacity-0">
    <div class="overflow-hidden min-h-0">
            <div class="mt-2 pt-2 border-t border-neutral-100 dark:border-white/5 mx-1">
            <div class="playlist-container max-h-48 overflow-y-auto custom-scrollbar pr-1 pb-1 flex flex-col gap-1" role="listbox" aria-label={i18n(I18nKey.musicPlaylist)}>
                <!-- Items -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
    <div class="music-loading absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/60 dark:bg-[#1e1e1e]/60 backdrop-blur-[2px] transition-opacity duration-300 opacity-0 pointer-events-none rounded-xl" aria-busy="true" aria-hidden="true">
    <div class="w-8 h-8 text-[var(--primary)] animate-spin">
        <Icon name="material-symbols:sync-rounded" class="text-3xl" aria-hidden="true" />
    </div>
</div>
</div>

<template id={`playlist-item-template-${widgetId}`}>
<div class="playlist-item flex items-center gap-3 p-2 rounded-lg cursor-pointer hover:bg-neutral-50 dark:hover:bg-white/5 transition-colors group">
    <div class="w-8 h-8 rounded-md overflow-hidden shrink-0 relative bg-neutral-200 dark:bg-neutral-700">
        <img src="" class="item-cover w-full h-full object-cover" loading="lazy" alt="" />
        <!-- Active Indicator overlay -->
        <div class="item-active-overlay absolute inset-0 bg-[var(--primary)]/20 hidden items-center justify-center">
                <Icon name="material-symbols:graphic-eq-rounded" class="text-[var(--primary)] text-sm" />
        </div>
    </div>
    <div class="flex-1 min-w-0">
        <div class="item-title text-xs font-bold text-neutral-700 dark:text-neutral-200 truncate group-hover:text-[var(--primary)] transition-colors"></div>
        <div class="item-artist text-[10px] text-neutral-400 truncate"></div>
    </div>
</div>
</template>

<script define:vars={{ viewConfigStr, widgetId }} is:inline>
(function () {
    var cfg = JSON.parse(viewConfigStr);
    var widget = document.getElementById(widgetId);
    if (!widget) return;

    var mgr = window.__fireflyMusic;
    if (!mgr) return;

    // ── UI element refs ──────────────────────────────────────
    var ui = {
        widget: widget,
        loading: widget.querySelector('.music-loading'),
        cover: widget.querySelector('.music-cover'),
        title: widget.querySelector('.music-title'),
        artist: widget.querySelector('.music-artist'),
        progressBar: widget.querySelector('.progress-bar'),
        progressThumb: widget.querySelector('.progress-thumb'),
        progressContainer: widget.querySelector('.progress-container'),
        currentTime: widget.querySelector('.current-time'),
        totalTime: widget.querySelector('.total-time'),
        btnPlay: widget.querySelector('.btn-play'),
        iconPlay: widget.querySelector('.icon-play'),
        iconPause: widget.querySelector('.icon-pause'),
        btnPrev: widget.querySelector('.btn-prev'),
        btnNext: widget.querySelector('.btn-next'),
        btnRepeat: widget.querySelector('.btn-repeat'),
        iconRepeat: widget.querySelector('.icon-repeat'),
        iconRepeatOne: widget.querySelector('.icon-repeat-one'),
        iconShuffle: widget.querySelector('.icon-shuffle'),
        btnMute: widget.querySelector('.btn-mute'),
        iconVolHigh: widget.querySelector('.icon-vol-high'),
        iconVolMute: widget.querySelector('.icon-vol-mute'),
        volContainer: widget.querySelector('.vol-container'),
        volBar: widget.querySelector('.vol-bar'),
        btnLrc: widget.querySelector('.btn-lrc-toggle'),
        iconLrcOn: widget.querySelector('.icon-lrc-on'),
        iconLrcOff: widget.querySelector('.icon-lrc-off'),
        lrcDrawer: widget.querySelector('.lrc-drawer'),
        lrcContainer: widget.querySelector('.lrc-container'),
        btnDrawer: widget.querySelector('.btn-drawer-toggle'),
        playlistDrawer: widget.querySelector('.playlist-drawer'),
        playlistContainer: widget.querySelector('.playlist-container'),
        itemTemplate: document.getElementById('playlist-item-template-' + widgetId)
    };

    // Verify critical elements
    var _critical = [ui.btnPlay, ui.btnRepeat, ui.btnMute, ui.volContainer,
        ui.btnDrawer, ui.btnLrc, ui.lrcDrawer, ui.lrcContainer,
        ui.progressContainer, ui.btnNext, ui.btnPrev, ui.loading,
        ui.cover, ui.title, ui.artist, ui.playlistContainer, ui.itemTemplate];
    if (_critical.some(function(el) { return !el; })) return;

    // ── Local state (drawers, user scrolling) ────────────────
    var local = {
        isUserScrolling: false,
        scrollTimeout: null,
        currentLrcIndex: -1
    };

    // ── UI update functions ──────────────────────────────────
    function setLoading(bool) {
        if (bool) {
            ui.loading.classList.remove('opacity-0', 'pointer-events-none');
        } else {
            ui.loading.classList.add('opacity-0', 'pointer-events-none');
        }
    }

    function updatePlayStateUI(isPlaying) {
        if (isPlaying) {
            ui.btnPlay.classList.add('bg-[var(--primary)]', 'text-white', 'hover:brightness-110');
            ui.btnPlay.classList.remove('bg-[var(--btn-regular-bg)]', 'hover:bg-[var(--btn-regular-bg-hover)]', 'active:bg-[var(--btn-regular-bg-active)]', 'text-[var(--primary)]');
            ui.iconPlay.classList.add('hidden');
            ui.iconPause.classList.remove('hidden');
            ui.cover.style.animationPlayState = 'running';
            ui.btnPlay.setAttribute('aria-label', cfg.i18n.pause);
            ui.btnPlay.title = cfg.i18n.pause;
        } else {
            ui.btnPlay.classList.remove('bg-[var(--primary)]', 'text-white', 'hover:brightness-110');
            ui.btnPlay.classList.add('bg-[var(--btn-regular-bg)]', 'hover:bg-[var(--btn-regular-bg-hover)]', 'active:bg-[var(--btn-regular-bg-active)]', 'text-[var(--primary)]');
            ui.iconPlay.classList.remove('hidden');
            ui.iconPause.classList.add('hidden');
            ui.cover.style.animationPlayState = 'paused';
            ui.btnPlay.setAttribute('aria-label', cfg.i18n.play);
            ui.btnPlay.title = cfg.i18n.play;
        }
    }

    function updateModeUI(playMode) {
        var primaryColor = 'text-[var(--primary)]';
        if (playMode === 0) {
            ui.btnRepeat.className = 'p-2 active:scale-95 transition-colors text-neutral-300 dark:text-neutral-600 hover:text-[var(--primary)]';
            ui.iconRepeat.classList.remove('hidden');
            ui.iconRepeatOne.classList.add('hidden');
            ui.iconShuffle.classList.add('hidden');
        } else if (playMode === 1) {
            ui.btnRepeat.className = 'p-2 active:scale-95 transition-colors ' + primaryColor;
            ui.iconRepeat.classList.add('hidden');
            ui.iconRepeatOne.classList.remove('hidden');
            ui.iconShuffle.classList.add('hidden');
        } else {
            ui.btnRepeat.className = 'p-2 active:scale-95 transition-colors ' + primaryColor;
            ui.iconRepeat.classList.add('hidden');
            ui.iconRepeatOne.classList.add('hidden');
            ui.iconShuffle.classList.remove('hidden');
        }
    }

    function updateVolumeUI(volume, isMuted) {
        var pct = isMuted ? 0 : volume * 100;
        ui.volBar.style.width = pct + '%';
        ui.volContainer.setAttribute('aria-valuenow', Math.round(pct).toString());
        if (isMuted || volume === 0) {
            ui.iconVolHigh.classList.add('hidden');
            ui.iconVolMute.classList.remove('hidden');
        } else {
            ui.iconVolHigh.classList.remove('hidden');
            ui.iconVolMute.classList.add('hidden');
        }
    }

    function updateTrackUI(track) {
        if (!track) return;
        ui.title.innerText = track.name;
        ui.title.title = track.name;
        ui.artist.innerText = track.artist;
        ui.artist.title = track.artist;

        if (track.pic) {
            ui.cover.classList.add('opacity-0');
            ui.cover.src = track.pic;
            ui.cover.alt = track.name + ' - ' + track.artist;
        } else {
            ui.cover.src = '';
            ui.cover.classList.add('opacity-0');
            ui.cover.alt = cfg.i18n.noCover;
        }

        // Reset cover rotation
        ui.cover.classList.remove('animate-spin-slow');
        void ui.cover.offsetWidth;
        ui.cover.classList.add('animate-spin-slow');
        ui.cover.style.animationPlayState = 'paused';

        // Reset progress
        ui.progressBar.style.width = '0%';
        ui.progressThumb.style.left = '0%';
        ui.progressContainer.setAttribute('aria-valuenow', '0');
        ui.currentTime.innerText = '0:00';
        ui.totalTime.innerText = '0:00';
    }

    function renderPlaylist(playlist, currentIndex) {
        ui.playlistContainer.innerHTML = '';
        playlist.forEach(function (track, idx) {
            var clone = ui.itemTemplate.content.cloneNode(true);
            var itemEl = clone.querySelector('.playlist-item');
            var img = clone.querySelector('.item-cover');
            var title = clone.querySelector('.item-title');
            var artist = clone.querySelector('.item-artist');

            img.src = track.pic || '';
            img.alt = track.name + ' - ' + track.artist;
            title.innerText = track.name;
            artist.innerText = track.artist;

            itemEl.dataset.index = idx;
            itemEl.setAttribute('role', 'option');
            itemEl.setAttribute('aria-label', track.name + ' - ' + track.artist);
            itemEl.onclick = function () {
                mgr.playTrackByIndex(idx);
            };
            ui.playlistContainer.appendChild(clone);
        });
        updatePlaylistActiveUI(currentIndex);
    }

    function updatePlaylistActiveUI(currentIndex) {
        var items = ui.playlistContainer.querySelectorAll('.playlist-item');
        items.forEach(function (el) {
            var idx = parseInt(el.dataset.index);
            var overlay = el.querySelector('.item-active-overlay');
            var title = el.querySelector('.item-title');
            if (idx === currentIndex) {
                el.classList.add('bg-neutral-100', 'dark:bg-white/10');
                el.setAttribute('aria-current', 'true');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                title.classList.add('text-[var(--primary)]');
            } else {
                el.classList.remove('bg-neutral-100', 'dark:bg-white/10');
                el.removeAttribute('aria-current');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                title.classList.remove('text-[var(--primary)]');
            }
        });
    }

    function renderLyricsUI(lyrics, status) {
        local.currentLrcIndex = -1;
        ui.lrcContainer.innerHTML = '';
        if (status === 'loading') {
            ui.lrcContainer.innerHTML = '<div class="text-neutral-400 text-sm py-10">' + cfg.i18n.loadingLyrics + '</div>';
            return;
        }
        if (status === 'failed') {
            ui.lrcContainer.innerHTML = '<div class="text-neutral-400 text-sm py-10">' + cfg.i18n.failedLyrics + '</div>';
            return;
        }
        if (!lyrics || lyrics.length === 0) {
            ui.lrcContainer.innerHTML = '<div class="text-neutral-400 text-sm py-10" role="option">' + cfg.i18n.noLyrics + '</div>';
            return;
        }
        lyrics.forEach(function (line, index) {
            var lineEl = document.createElement('div');
            lineEl.className = 'lrc-line transition-all duration-300 text-sm text-neutral-400 py-1 cursor-pointer hover:text-[var(--primary)]';
            lineEl.innerText = line.text;
            lineEl.dataset.index = index;
            lineEl.setAttribute('role', 'option');
            lineEl.setAttribute('aria-label', line.text);
            lineEl.onclick = function () {
                mgr.seekToTime(line.time);
            };
            ui.lrcContainer.appendChild(lineEl);
        });
    }

    function updateLrcHighlight(index) {
        if (index === local.currentLrcIndex) return;
        local.currentLrcIndex = index;

        var lines = ui.lrcContainer.querySelectorAll('.lrc-line');
        lines.forEach(function (line, i) {
            if (i === index) {
                line.classList.add('text-[var(--primary)]', 'font-bold', 'text-base');
                line.classList.remove('text-neutral-400', 'text-sm');
            } else {
                line.classList.remove('text-[var(--primary)]', 'font-bold', 'text-base');
                line.classList.add('text-neutral-400', 'text-sm');
            }
        });

        // Auto-scroll unless user is scrolling
        if (index !== -1 && !local.isUserScrolling) {
            var line = ui.lrcContainer.querySelector('.lrc-line[data-index="' + index + '"]');
            if (line) {
                var containerHeight = ui.lrcContainer.clientHeight;
                var lineOffset = line.offsetTop;
                var lineHeight = line.offsetHeight;
                var targetScroll = lineOffset - (containerHeight / 2) + (lineHeight / 2);
                ui.lrcContainer.scrollTo({ top: targetScroll, behavior: 'smooth' });
            }
        }
    }

    // ── Full sync from manager state (for late-mount) ────────
    function syncAll() {
        var s = mgr.getState();
        if (!s.initialized) return;

        // Loading off
        setLoading(false);

        if (s.playlist.length === 0) {
            ui.title.innerText = s.error || cfg.i18n.noSongs;
            return;
        }

        renderPlaylist(s.playlist, s.currentIndex);
        if (s.track) updateTrackUI(s.track);
        updatePlayStateUI(s.isPlaying);
        updateModeUI(s.playMode);
        updateVolumeUI(s.volume, s.isMuted);

        // Progress
        if (s.duration > 0) {
            ui.progressBar.style.width = s.progress + '%';
            ui.progressThumb.style.left = s.progress + '%';
            ui.progressContainer.setAttribute('aria-valuenow', Math.round(s.progress).toString());
            ui.currentTime.innerText = s.currentTimeStr;
            ui.totalTime.innerText = s.durationStr;
        }

        // Lyrics
        renderLyricsUI(s.lyrics, s.lyrics.length > 0 ? 'loaded' : 'none');
        if (s.currentLrcIndex >= 0) updateLrcHighlight(s.currentLrcIndex);

        // Cover image: if already set, show it
        if (s.track && s.track.pic && ui.cover.src && ui.cover.complete && ui.cover.naturalWidth > 0) {
            ui.cover.classList.remove('opacity-0');
        }
        // Update cover animation state to match play state
        ui.cover.style.animationPlayState = s.isPlaying ? 'running' : 'paused';
    }

    // ── Event listeners (fm:* from manager) ──────────────────
    var handlers = {};

    function on(name, fn) {
        handlers[name] = fn;
        window.addEventListener(name, fn);
    }

    on('fm:init', function (e) {
        var d = e.detail;
        setLoading(false);
        if (d.playlist.length > 0) {
            renderPlaylist(d.playlist, 0);
            updateModeUI(d.playMode);
            updateVolumeUI(d.volume, d.isMuted);
        } else {
            ui.title.innerText = cfg.i18n.noSongs;
        }
    });

    on('fm:track', function (e) {
        var d = e.detail;
        updateTrackUI(d.track);
        updatePlaylistActiveUI(d.index);
    });

    on('fm:play-state', function (e) {
        updatePlayStateUI(e.detail.isPlaying);
    });

    on('fm:time', function (e) {
        var d = e.detail;
        ui.progressBar.style.width = d.progress + '%';
        ui.progressThumb.style.left = d.progress + '%';
        ui.progressContainer.setAttribute('aria-valuenow', Math.round(d.progress).toString());
        ui.currentTime.innerText = d.currentTimeStr;
        ui.totalTime.innerText = d.durationStr;
    });

    on('fm:volume', function (e) {
        updateVolumeUI(e.detail.volume, e.detail.isMuted);
    });

    on('fm:mode', function (e) {
        updateModeUI(e.detail.playMode);
    });

    on('fm:lyrics', function (e) {
        renderLyricsUI(e.detail.lyrics, e.detail.status);
    });

    on('fm:lrc-index', function (e) {
        updateLrcHighlight(e.detail.index);
    });

    on('fm:error', function (e) {
        ui.title.innerText = e.detail.message || cfg.i18n.error;
    });

    // ── Button click delegates ───────────────────────────────
    ui.btnPlay.addEventListener('click', function () { mgr.togglePlay(); });
    ui.btnNext.addEventListener('click', function () { mgr.playNext(); });
    ui.btnPrev.addEventListener('click', function () { mgr.playPrev(); });
    ui.btnRepeat.addEventListener('click', function () { mgr.cyclePlayMode(); });
    ui.btnMute.addEventListener('click', function () { mgr.toggleMute(); });

    ui.volContainer.addEventListener('click', function (e) {
        var rect = ui.volContainer.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var val = Math.max(0, Math.min(1, x / rect.width));
        mgr.setVolume(val);
    });

    ui.progressContainer.addEventListener('click', function (e) {
        var rect = ui.progressContainer.getBoundingClientRect();
        var clickX = e.clientX - rect.left;
        var percent = Math.min(Math.max(clickX / rect.width, 0), 1);
        mgr.seek(percent);
    });

    // ── Drawer logic (local state) ───────────────────────────
    ui.btnLrc.addEventListener('click', function () {
        var isOpen = ui.lrcDrawer.style.gridTemplateRows === '1fr';
        if (isOpen) {
            ui.lrcDrawer.style.gridTemplateRows = '0fr';
            ui.lrcDrawer.classList.remove('opacity-100');
            ui.lrcDrawer.classList.add('opacity-0');
            ui.btnLrc.classList.remove('text-[var(--primary)]');
            ui.btnLrc.classList.add('text-neutral-400');
            ui.iconLrcOn.classList.add('hidden');
            ui.iconLrcOff.classList.remove('hidden');
        } else {
            // Close playlist if open
            ui.playlistDrawer.style.gridTemplateRows = '0fr';
            ui.playlistDrawer.classList.remove('opacity-100');
            ui.playlistDrawer.classList.add('opacity-0');
            ui.btnDrawer.classList.remove('text-[var(--primary)]');
            ui.btnDrawer.classList.add('text-neutral-400');

            ui.lrcDrawer.style.gridTemplateRows = '1fr';
            ui.lrcDrawer.classList.add('opacity-100');
            ui.lrcDrawer.classList.remove('opacity-0');
            ui.btnLrc.classList.add('text-[var(--primary)]');
            ui.btnLrc.classList.remove('text-neutral-400');
            ui.iconLrcOn.classList.remove('hidden');
            ui.iconLrcOff.classList.add('hidden');
        }
    });

    ui.btnDrawer.addEventListener('click', function () {
        var isOpen = ui.playlistDrawer.style.gridTemplateRows === '1fr';
        if (isOpen) {
            ui.playlistDrawer.style.gridTemplateRows = '0fr';
            ui.playlistDrawer.classList.remove('opacity-100');
            ui.playlistDrawer.classList.add('opacity-0');
            ui.btnDrawer.classList.add('text-neutral-400');
            ui.btnDrawer.classList.remove('text-[var(--primary)]');
        } else {
            // Close lyrics if open
            ui.lrcDrawer.style.gridTemplateRows = '0fr';
            ui.lrcDrawer.classList.remove('opacity-100');
            ui.lrcDrawer.classList.add('opacity-0');
            ui.btnLrc.classList.remove('text-[var(--primary)]');
            ui.btnLrc.classList.add('text-neutral-400');

            ui.playlistDrawer.style.gridTemplateRows = '1fr';
            ui.playlistDrawer.classList.add('opacity-100');
            ui.playlistDrawer.classList.remove('opacity-0');
            ui.btnDrawer.classList.remove('text-neutral-400');
            ui.btnDrawer.classList.add('text-[var(--primary)]');
        }
    });

    // ── Lyrics user scroll detection ─────────────────────────
    function resetScrollTimeout() {
        clearTimeout(local.scrollTimeout);
        local.scrollTimeout = setTimeout(function () {
            local.isUserScrolling = false;
            // Snap back to current lyric
            var s = mgr.getState();
            if (s.currentLrcIndex >= 0) {
                var line = ui.lrcContainer.querySelector('.lrc-line[data-index="' + s.currentLrcIndex + '"]');
                if (line) {
                    var containerHeight = ui.lrcContainer.clientHeight;
                    var lineOffset = line.offsetTop;
                    var lineHeight = line.offsetHeight;
                    var targetScroll = lineOffset - (containerHeight / 2) + (lineHeight / 2);
                    ui.lrcContainer.scrollTo({ top: targetScroll, behavior: 'auto' });
                }
            }
        }, 3000);
    }

    ui.lrcContainer.addEventListener('wheel', function () {
        local.isUserScrolling = true;
        resetScrollTimeout();
    });
    ui.lrcContainer.addEventListener('touchstart', function () {
        local.isUserScrolling = true;
        resetScrollTimeout();
    });

    // ── Cover image events ───────────────────────────────────
    ui.cover.addEventListener('load', function () {
        ui.cover.classList.remove('opacity-0');
    });
    ui.cover.addEventListener('error', function () {
        ui.cover.classList.add('opacity-0');
    });

    // ── Cleanup on DOM removal ───────────────────────────────
    var observer = new MutationObserver(function (mutations) {
        for (var i = 0; i < mutations.length; i++) {
            var removed = mutations[i].removedNodes;
            for (var j = 0; j < removed.length; j++) {
                if (removed[j] === widget || (removed[j].contains && removed[j].contains(widget))) {
                    // Widget removed from DOM – clean up event listeners
                    Object.keys(handlers).forEach(function (name) {
                        window.removeEventListener(name, handlers[name]);
                    });
                    observer.disconnect();
                    clearTimeout(local.scrollTimeout);
                    return;
                }
            }
        }
    });
    if (widget.parentNode) {
        observer.observe(widget.parentNode, { childList: true });
    }

    // ── Init: either sync existing state or trigger init ─────
    var currentState = mgr.getState();
    if (currentState.initialized) {
        // Manager already initialized (late mount) – sync all UI
        syncAll();
    } else {
        // First widget to mount – show loading and trigger init
        setLoading(true);
        mgr.init();
    }
})();
</script>

<style>
    @keyframes spin-slow {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin-slow {
        animation: spin-slow 10s linear infinite;
    }
</style>
</file>

<file path="components/features/SakuraEffect.astro">
---
import { sakuraConfig } from "@/config";

const config = sakuraConfig;
---

{sakuraConfig?.enable && (
	<script is:inline define:vars={{ sakuraConfig: config }}>
		let windowWidth = window.innerWidth;
		let windowHeight = window.innerHeight;

		// 樱花对象类
		class Sakura {
			constructor(x, y, s, r, a, fn, idx, img, limitArray, config) {
				this.x = x;
				this.y = y;
				this.s = s;
				this.r = r;
				this.a = a;
				this.fn = fn;
				this.idx = idx;
				this.img = img;
				this.limitArray = limitArray;
				this.config = config;
			}

			draw(cxt) {
				cxt.save();
				cxt.translate(this.x, this.y);
				cxt.rotate(this.r);
				cxt.globalAlpha = this.a;
				cxt.drawImage(this.img, 0, 0, 40 * this.s, 40 * this.s);
				cxt.restore();
			}

			update() {
				this.x = this.fn.x(this.x, this.y);
				this.y = this.fn.y(this.y, this.y);
				this.r = this.fn.r(this.r);
				this.a = this.fn.a(this.a);
				// 如果樱花越界，重新调整位置
				if (
					this.x > windowWidth ||
					this.x < 0 ||
					this.y > windowHeight ||
					this.y < 0 ||
					this.a <= 0
				) {
					// 如果樱花不做限制
					if (this.limitArray[this.idx] === -1) {
						this.resetPosition();
					}
					// 否则樱花有限制
					else {
						if (this.limitArray[this.idx] > 0) {
							this.resetPosition();
							this.limitArray[this.idx]--;
						}
					}
				}
			}

			resetPosition() {
				this.r = getRandom('fnr', this.config);
				if (Math.random() > 0.4) {
					this.x = getRandom('x', this.config);
					this.y = 0;
					this.s = getRandom('s', this.config);
					this.r = getRandom('r', this.config);
					this.a = getRandom('a', this.config);
				} else {
					this.x = windowWidth;
					this.y = getRandom('y', this.config);
					this.s = getRandom('s', this.config);
					this.r = getRandom('r', this.config);
					this.a = getRandom('a', this.config);
				}
			}
		}

		// 樱花列表类
		class SakuraList {
			constructor() {
				this.list = [];
			}

			push(sakura) {
				this.list.push(sakura);
			}

			update() {
				for (let i = 0, len = this.list.length; i < len; i++) {
					this.list[i].update();
				}
			}

			draw(cxt) {
				for (let i = 0, len = this.list.length; i < len; i++) {
					this.list[i].draw(cxt);
				}
			}

			get(i) {
				return this.list[i];
			}

			size() {
				return this.list.length;
			}
		}

		// 获取随机值的函数
		function getRandom(option, config) {
			let ret;
			let random;

			switch (option) {
				case 'x':
					ret = Math.random() * windowWidth;
					break;
				case 'y':
					ret = Math.random() * windowHeight;
					break;
				case 's':
					ret = config.size.min + Math.random() * (config.size.max - config.size.min);
					break;
				case 'r':
					ret = Math.random() * 6;
					break;
				case 'a':
					ret = config.opacity.min + Math.random() * (config.opacity.max - config.opacity.min);
					break;
				case 'fnx':
					random = config.speed.horizontal.min + Math.random() * (config.speed.horizontal.max - config.speed.horizontal.min);
					ret = function (x, _y) {
						return x + random;
					};
					break;
				case 'fny':
					random = config.speed.vertical.min + Math.random() * (config.speed.vertical.max - config.speed.vertical.min);
					ret = function (_x, y) {
						return y + random;
					};
					break;
				case 'fnr':
					ret = function (r) {
						return r + config.speed.rotation;
					};
					break;
				case 'fna':
					ret = function (alpha) {
						return alpha - config.speed.fadeSpeed * 0.01;
					};
					break;
			}
			return ret;
		}

		// 樱花管理器类
		class SakuraManager {
			constructor(config) {
				this.config = config;
				this.canvas = null;
				this.ctx = null;
				this.sakuraList = null;
				this.animationId = null;
				this.img = null;
				this.isRunning = false;
			}

			// 初始化樱花特效
			async init() {
				if (!this.config.enable || this.isRunning) {
					return;
				}

				// 创建图片对象
				this.img = new Image();
				this.img.src = '/assets/images/sakura.png'; // 使用樱花图片

				// 等待图片加载完成
				await new Promise((resolve, reject) => {
					if (this.img) {
						this.img.onload = () => resolve();
						this.img.onerror = () => reject(new Error('Failed to load sakura image'));
					}
				});

				this.createCanvas();
				this.createSakuraList();
				this.startAnimation();
				this.isRunning = true;
			}

			// 创建画布
			createCanvas() {
				this.canvas = document.createElement('canvas');
				this.canvas.height = windowHeight;
				this.canvas.width = windowWidth;
				this.canvas.setAttribute('style', `position: fixed; left: 0; top: 0; pointer-events: none; z-index: ${this.config.zIndex}; transform: translateZ(0);`);
				this.canvas.setAttribute('id', 'canvas_sakura');
				document.body.appendChild(this.canvas);
				this.ctx = this.canvas.getContext('2d');

				// 监听窗口大小变化
				window.addEventListener('resize', this.handleResize.bind(this));
			}

			// 创建樱花列表
			createSakuraList() {
				if (!this.img || !this.ctx) return;

				this.sakuraList = new SakuraList();
				const limitArray = new Array(this.config.sakuraNum).fill(this.config.limitTimes);

				for (let i = 0; i < this.config.sakuraNum; i++) {
					const randomX = getRandom('x', this.config);
					const randomY = getRandom('y', this.config);
					const randomS = getRandom('s', this.config);
					const randomR = getRandom('r', this.config);
					const randomA = getRandom('a', this.config);
					const randomFnx = getRandom('fnx', this.config);
					const randomFny = getRandom('fny', this.config);
					const randomFnR = getRandom('fnr', this.config);
					const randomFnA = getRandom('fna', this.config);

					const sakura = new Sakura(
						randomX,
						randomY,
						randomS,
						randomR,
						randomA,
						{
							x: randomFnx,
							y: randomFny,
							r: randomFnR,
							a: randomFnA,
						},
						i,
						this.img,
						limitArray,
						this.config
					);

					sakura.draw(this.ctx);
					this.sakuraList.push(sakura);
				}
			}

			// 开始动画
			startAnimation() {
				if (!this.ctx || !this.canvas || !this.sakuraList) return;

				const animate = () => {
					if (!this.ctx || !this.canvas || !this.sakuraList) return;

					this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
					this.sakuraList.update();
					this.sakuraList.draw(this.ctx);
					this.animationId = requestAnimationFrame(animate);
				};

				this.animationId = requestAnimationFrame(animate);
			}

			// 处理窗口大小变化
			handleResize() {
				windowWidth = window.innerWidth;
				windowHeight = window.innerHeight;
				if (this.canvas) {
					this.canvas.width = windowWidth;
					this.canvas.height = windowHeight;
				}
			}

			// 停止樱花特效
			stop() {
				if (this.animationId) {
					cancelAnimationFrame(this.animationId);
					this.animationId = null;
				}

				if (this.canvas) {
					document.body.removeChild(this.canvas);
					this.canvas = null;
				}

				window.removeEventListener('resize', this.handleResize.bind(this));
				this.isRunning = false;
			}

			// 切换樱花特效
			toggle() {
				if (this.isRunning) {
					this.stop();
				} else {
					this.init();
				}
			}

			// 更新配置
			updateConfig(newConfig) {
				const wasRunning = this.isRunning;
				if (wasRunning) {
					this.stop();
				}
				this.config = newConfig;
				if (wasRunning && newConfig.enable) {
					this.init();
				}
			}

			// 获取运行状态
			getIsRunning() {
				return this.isRunning;
			}
		}

		// 创建全局樱花管理器实例
		let globalSakuraManager = null;

		// 初始化樱花特效
		function initSakura(config) {
			if (globalSakuraManager) {
				globalSakuraManager.updateConfig(config);
			} else {
				globalSakuraManager = new SakuraManager(config);
				if (config.enable) {
					globalSakuraManager.init();
				}
			}
		}

		// 樱花特效初始化
		(function() {
			// 全局标记，确保樱花特效只初始化一次
			if (window.sakuraInitialized) {
				return;
			}
			
			// 初始化樱花特效的函数
			const setupSakura = () => {
				if (sakuraConfig.enable && !window.sakuraInitialized) {
					initSakura(sakuraConfig);
					window.sakuraInitialized = true;
				}
			};
			
			// 页面加载完成后初始化樱花特效
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', setupSakura);
			} else {
				setupSakura();
			}
		})();
	</script>
)}
</file>

<file path="components/features/SpineModel.astro">
---
import MessageBox from "@/components/common/PioMessageBox.astro";
import { spineModelConfig } from "@/config/pioConfig";
import { url } from "@/utils/url-utils";
---

<!-- Spine Web Player CSS 将在 script 中动态加载 -->{
  spineModelConfig.enable && (
    <div
      id="spine-model-container"
      style={`
      position: fixed;
      ${spineModelConfig.position.corner.includes("right") ? "right" : "left"}: ${spineModelConfig.position.offsetX}px;
      ${spineModelConfig.position.corner.includes("top") ? "top" : "bottom"}: ${spineModelConfig.position.offsetY}px;
      width: ${spineModelConfig.size.width}px;
      height: ${spineModelConfig.size.height}px;
      pointer-events: auto;
      z-index: 1000;
    `}
    >
      <div id="spine-player-container" style="width: 100%; height: 100%;" />
      <div id="spine-error" style="display: none;" />
    </div>
  )
}

<!-- 引入消息框组件 -->
<MessageBox />

<script is:inline define:vars={{ spineModelConfig, modelPath: url(spineModelConfig.model.path), atlasPath: url(spineModelConfig.model.path.replace(".json", ".atlas")), cssPath: url("/pio/static/spine-player.min.css"), jsPath: url("/pio/static/spine-player.min.js") }}>
  // 动态加载 Spine CSS（带本地备用）
  function loadSpineCSS() {
    if (!spineModelConfig.enable) return;

    // 检查是否已经加载
    const existingLink = document.querySelector('link[href*="spine-player"]');
    if (existingLink) return;

    // 首先尝试加载 CDN CSS
    const cdnLink = document.createElement("link");
    cdnLink.rel = "stylesheet";
    cdnLink.href =
      "https://unpkg.com/@esotericsoftware/spine-player@4.2.*/dist/spine-player.min.css";

    // 监听加载失败事件，自动回退到本地文件
    cdnLink.onerror = function () {
      console.warn("⚠️ Spine CSS CDN failed, trying local fallback...");

      // 移除失败的 CDN link
      if (cdnLink.parentNode) {
        cdnLink.parentNode.removeChild(cdnLink);
      }

      // 创建本地备用 CSS link
      const localLink = document.createElement("link");
      localLink.rel = "stylesheet";
      localLink.href = cssPath;
      localLink.onerror = function () {
        console.error("❌ Failed to load Spine CSS");
      };

      document.head.appendChild(localLink);
    };

    document.head.appendChild(cdnLink);
  }

  // 消息框功能已移至公共组件 MessageBox.astro
  let isClickProcessing = false; // 防止重复点击的标志
  let lastClickTime = 0; // 记录最后一次点击时间

  // 全局变量，防止重复初始化
  window.spineModelInitialized = window.spineModelInitialized || false;
  window.spinePlayerInstance = window.spinePlayerInstance || null;

  // 消息显示函数 - 使用公共消息框组件
  function showMessage(message) {
    // 使用公共消息框组件
    if (window.showModelMessage) {
      window.showModelMessage(message, {
        containerId: "spine-model-container",
        displayTime: spineModelConfig.interactive.messageDisplayTime || 3000
      });
    }
  }

  // 更新响应式显示
  function updateResponsiveDisplay() {
    if (!spineModelConfig.enable) return;

    const container = document.getElementById("spine-model-container");
    if (!container) return;

    // 检查移动端显示设置
    if (
      spineModelConfig.responsive.hideOnMobile &&
      window.innerWidth <= spineModelConfig.responsive.mobileBreakpoint
    ) {
      container.style.display = "none";
    } else {
      container.style.display = "block";
    }
  }

  // 清理函数
  function cleanupSpineModel() {
    console.log("🧹 Cleaning up existing Spine model...");

    // 清理消息显示（使用公共组件）
    if (window.clearModelMessage) {
      window.clearModelMessage();
    }

    // 清理现有的播放器实例
    if (window.spinePlayerInstance) {
      try {
        if (window.spinePlayerInstance.dispose) {
          window.spinePlayerInstance.dispose();
        }
      } catch (e) {
        console.warn("Error disposing spine player:", e);
      }
      window.spinePlayerInstance = null;
    }

    // 清理容器内容
    const playerContainer = document.getElementById("spine-player-container");
    if (playerContainer) {
      playerContainer.innerHTML = "";
    }

    // 重置初始化标志
    window.spineModelInitialized = false;
  }

  async function initSpineModel() {
    if (!spineModelConfig.enable) return;

    // 检查移动端显示设置，如果隐藏则不加载运行时
    if (
      spineModelConfig.responsive.hideOnMobile &&
      window.innerWidth <= spineModelConfig.responsive.mobileBreakpoint
    ) {
      console.log("📱 Mobile device detected, skipping Spine model initialization");
      const container = document.getElementById("spine-model-container");
      if (container) container.style.display = "none";
      return;
    }

    // 检查是否已经初始化
    if (window.spineModelInitialized) {
      console.log("⏭️ Spine model already initialized, skipping...");
      return;
    }

    console.log("🎯 Initializing Spine Model...");

    // 先清理可能存在的旧实例
    cleanupSpineModel();

    // 首先加载 CSS
    loadSpineCSS();

    // 加载 Spine Web Player 运行时
    const loadSpineRuntime = () => {
      return new Promise((resolve, reject) => {
        if (typeof window.spine !== "undefined") {
          console.log("✅ Spine runtime already loaded");
          resolve();
          return;
        }

        console.log("📦 Loading Spine runtime...");
        const script = document.createElement("script");
        script.src =
          "https://unpkg.com/@esotericsoftware/spine-player@4.2.*/dist/iife/spine-player.min.js";
        script.onload = () => {
          console.log("✅ Spine runtime loaded from CDN");
          resolve();
        };
        script.onerror = (_error) => {
          console.warn("⚠️ CDN failed, trying local fallback...");

          // 尝试本地回退
          const fallbackScript = document.createElement("script");
          fallbackScript.src = jsPath;
          fallbackScript.onload = () => {
            console.log("✅ Spine runtime loaded from local fallback");
            resolve();
          };
          fallbackScript.onerror = () => {
            reject(new Error("Failed to load Spine runtime"));
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      });
    };

    // 等待 Spine 库加载
    const waitForSpine = () => {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;

        const check = () => {
          attempts++;
          if (typeof window.spine !== "undefined" && window.spine.SpinePlayer) {
            console.log("✅ Spine runtime loaded");
            resolve();
          } else if (attempts >= maxAttempts) {
            reject(new Error("Spine runtime loading timeout"));
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });
    };

    try {
      // 首先加载 Spine 运行时
      await loadSpineRuntime();

      // 然后等待 Spine 对象可用
      await waitForSpine();

      // 标记为已初始化
      window.spineModelInitialized = true;

      // 创建 SpinePlayer
      new window.spine.SpinePlayer("spine-player-container", {
        skeleton: modelPath,
        atlas: atlasPath,
        animation: "idle",
        backgroundColor: "#00000000", // 透明背景
        showControls: false, // 隐藏控件
        alpha: true,
        premultipliedAlpha: false,
        success: (player) => {
          console.log("🎉 Spine model loaded successfully!");

          // 保存播放器实例引用
          window.spinePlayerInstance = player;

          // 初始化完成后设置默认姿态
          setTimeout(() => {
            if (player.skeleton) {
              try {
                player.skeleton.updateWorldTransform();
                player.skeleton.setToSetupPose();
              } catch (e) {
                console.warn("Error positioning skeleton:", e);
              }
            }
          }, 500);

          // 设置交互功能
          if (spineModelConfig.interactive.enabled) {
            const canvas = document.querySelector(
              "#spine-player-container canvas"
            );
            if (canvas) {
              canvas.addEventListener("click", () => {
                // 防抖处理：防止重复点击
                const currentTime = Date.now();
                if (isClickProcessing || currentTime - lastClickTime < 500) {
                  return; // 500ms 内重复点击忽略
                }

                isClickProcessing = true;
                lastClickTime = currentTime;

                // 随机播放点击动画
                const clickAnims =
                  spineModelConfig.interactive.clickAnimations ||
                  (spineModelConfig.interactive.clickAnimation
                    ? [spineModelConfig.interactive.clickAnimation]
                    : []);

                if (clickAnims.length > 0) {
                  try {
                    const randomClickAnim =
                      clickAnims[Math.floor(Math.random() * clickAnims.length)];
                    player.setAnimation(randomClickAnim, false);

                    // 动画播放完成后回到待机状态
                    setTimeout(() => {
                      const idleAnims =
                        spineModelConfig.interactive.idleAnimations;
                      const randomIdle =
                        idleAnims[Math.floor(Math.random() * idleAnims.length)];
                      player.setAnimation(randomIdle, true);
                    }, 2000);
                  } catch (e) {
                    console.warn("Failed to play click animation:", e);
                  }
                }

                // 显示随机消息
                const messages = spineModelConfig.interactive.clickMessages;
                if (messages && messages.length > 0) {
                  const randomMessage =
                    messages[Math.floor(Math.random() * messages.length)];
                  showMessage(randomMessage);
                }

                // 500ms 后重置防抖标志
                setTimeout(() => {
                  isClickProcessing = false;
                }, 500);
              });

              // 设置待机动画循环
              if (spineModelConfig.interactive.idleAnimations.length > 1) {
                setInterval(() => {
                  try {
                    const idleAnims =
                      spineModelConfig.interactive.idleAnimations;
                    const randomIdle =
                      idleAnims[Math.floor(Math.random() * idleAnims.length)];
                    player.setAnimation(randomIdle, true);
                  } catch (e) {
                    console.warn("Failed to play idle animation:", e);
                  }
                }, spineModelConfig.interactive.idleInterval);
              }
            }
          }

          console.log("✅ Spine model setup complete!");
        },
        error: (_player, reason) => {
          console.error("❌ Spine model loading error:", reason);

          const errorDiv = document.getElementById("spine-error");
          if (errorDiv) {
            errorDiv.style.display = "block";
            errorDiv.innerHTML = `
              <div style="color: #ff4444; padding: 20px; text-align: center; font-size: 14px;">
                <div>⚠️ Spine 模型加载失败</div>
                <div style="font-size: 12px; margin-top: 8px; color: #888;">${reason}</div>
              </div>
            `;
          }

          const canvas = document.getElementById("spine-canvas");
          if (canvas) canvas.style.display = "none";
        },
      });
    } catch (error) {
      console.error("Spine model initialization error:", error);

      // 重置初始化标志，允许重试
      window.spineModelInitialized = false;

      const errorDiv = document.getElementById("spine-error");
      if (errorDiv) {
        errorDiv.style.display = "block";
        errorDiv.innerHTML = `
          <div style="color: #ff4444; padding: 20px; text-align: center; font-size: 14px;">
            <div>⚠️ Spine 运行时加载失败</div>
            <div style="font-size: 12px; margin-top: 8px; color: #888;">${error instanceof Error ? error.message : "未知错误"}</div>
          </div>
        `;
      }
    }
  }

  // 监听页面卸载事件，清理资源
  window.addEventListener("beforeunload", cleanupSpineModel);

  // 监听 Swup 页面切换事件（如果使用了 Swup）
  if (typeof window.swup !== "undefined" && window.swup.hooks) {
    window.swup.hooks.on("content:replace", () => {
      // 只更新响应式显示，不重新创建模型
      setTimeout(() => {
        updateResponsiveDisplay();
      }, 100);
    });
  }

  // 监听 popstate 事件（浏览器前进后退）
  window.addEventListener("popstate", () => {
    setTimeout(() => {
      updateResponsiveDisplay();
    }, 100);
  });

  // 监听窗口大小变化
  window.addEventListener("resize", updateResponsiveDisplay);

  // 页面加载完成后初始化（只初始化一次）
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSpineModel);
  } else {
    initSpineModel();
  }
</script>
</file>

<file path="components/features/TypewriterText.astro">
---
export interface Props {
	text: string | string[];
	speed?: number;
	deleteSpeed?: number;
	pauseTime?: number;
	class?: string;
}

const {
	text,
	speed = 100,
	deleteSpeed = 50,
	pauseTime = 2000,
	class: className = "",
} = Astro.props;
const textData = Array.isArray(text) ? JSON.stringify(text) : text;
---

<span
  class={`typewriter ${className}`}
  data-text={textData}
  data-speed={speed}
  data-delete-speed={deleteSpeed}
  data-pause-time={pauseTime}></span>

<script>
  class TypewriterEffect {
    private element: HTMLElement;
    private texts: string[];
    private currentTextIndex: number = 0;
    private speed: number;
    private deleteSpeed: number;
    private pauseTime: number;
    private currentIndex: number = 0;
    private isDeleting: boolean = false;
    private timeoutId: number | null = null;

    constructor(element: HTMLElement) {
      this.element = element;
      const textData = element.dataset.text || "";

      // 尝试解析为JSON数组，如果失败则作为单个字符串处理
      try {
        const parsed = JSON.parse(textData);
        this.texts = Array.isArray(parsed) ? parsed : [textData];
      } catch {
        this.texts = [textData];
      }

      this.speed = parseInt(element.dataset.speed || "100");
      this.deleteSpeed = parseInt(element.dataset.deleteSpeed || "50");
      this.pauseTime = parseInt(element.dataset.pauseTime || "2000");

      // 如果有多条文本且未启用打字机效果，随机显示一条
      if (this.texts.length > 1 && !this.isTypewriterEnabled()) {
        this.showRandomText();
      } else {
        this.start();
      }
    }

    private isTypewriterEnabled(): boolean {
      // 检查是否有打字机相关的数据属性
      return (
        this.element.dataset.speed !== undefined ||
        this.element.dataset.deleteSpeed !== undefined ||
        this.element.dataset.pauseTime !== undefined
      );
    }

    private showRandomText() {
      const randomIndex = Math.floor(Math.random() * this.texts.length);
      this.element.textContent = this.texts[randomIndex];
    }

    private start() {
      if (this.texts.length === 0) return;
      this.type();
    }

    private getCurrentText(): string {
      return this.texts[this.currentTextIndex] || "";
    }

    private type() {
      const currentText = this.getCurrentText();
      const segments = this.segmentText(currentText);

      if (this.isDeleting) {
        // 删除字符
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.element.textContent = segments
            .slice(0, this.currentIndex)
            .join("");

          this.timeoutId = window.setTimeout(
            () => this.type(),
            this.deleteSpeed
          );
        } else {
          // 删除完成，切换到下一条文本
          this.isDeleting = false;
          this.currentTextIndex =
            (this.currentTextIndex + 1) % this.texts.length;
          this.timeoutId = window.setTimeout(() => this.type(), this.speed);
        }
      } else {
        if (this.currentIndex < segments.length) {
          this.currentIndex++;
          this.element.textContent = segments
            .slice(0, this.currentIndex)
            .join("");

          this.timeoutId = window.setTimeout(() => this.type(), this.speed);
        } else {
          // 打字完成，暂停后开始删除（如果有多条文本）
          if (this.texts.length > 1) {
            this.isDeleting = true;
            this.timeoutId = window.setTimeout(
              () => this.type(),
              this.pauseTime
            );
          }
          // 如果只有一条文本，保持显示不删除
        }
      }
    }

    public destroy() {
      if (this.timeoutId) {
        clearTimeout(this.timeoutId);
      }
    }

    private segmentText(text: string): string[] {
      const segmenter = new Intl.Segmenter(undefined, { granularity: "grapheme" });
      return Array.from(segmenter.segment(text), s => s.segment);
    }

  }

  function initTypewriterElements() {
    const typewriterElements = document.querySelectorAll(".typewriter");
    typewriterElements.forEach((element) => {
      const el = element as HTMLElement & { __typewriterInstance?: TypewriterEffect };
      if (el.__typewriterInstance) {
        el.__typewriterInstance.destroy();
      }
      el.textContent = "";
      el.__typewriterInstance = new TypewriterEffect(el);
    });
  }

  // 初始化所有打字机效果
  function runInitWithDelay() {
    initTypewriterElements();
    // 兼容 banner 显隐晚于内容替换的场景
    setTimeout(initTypewriterElements, 220);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", runInitWithDelay);
  } else {
    runInitWithDelay();
  }

  // 支持页面切换时重新初始化（兼容不同 swup 事件名）
  document.addEventListener("swup:contentReplaced", runInitWithDelay);
  document.addEventListener("swup:content:replace", runInitWithDelay);
  document.addEventListener("swup:page:view", runInitWithDelay);

  // swup hooks（若可用）
  if (typeof window !== "undefined" && window.swup?.hooks) {
    window.swup.hooks.on("content:replace", runInitWithDelay);
    window.swup.hooks.on("page:view", runInitWithDelay);
  }
</script>

<style>
  .typewriter {
    position: relative;
  }

  .typewriter::after {
    content: "|";
    animation: blink 1s infinite;
    margin-left: 2px;
  }

  @keyframes blink {
    0%,
    50% {
      opacity: 1;
    }
    51%,
    100% {
      opacity: 0;
    }
  }
</style>
</file>

<file path="components/layout/CategoryBar.astro">
---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { Icon } from "astro-icon/components";
import { getCategoryList, getSortedPostsList } from "@/utils/content-utils";
import { url } from "@/utils/url-utils";

const categories = await getCategoryList();
const totalPosts = (await getSortedPostsList()).length;
const homeUrl = url("/");
const archiveUrl = url("/archive/");
---

<div class="card-base category-bar p-3 onload-animation" id="category-bar" data-home-path={homeUrl} data-archive-path={archiveUrl}>
  <div class="category-bar-inner flex gap-2">
    <a
      href={homeUrl}
      class="category-pill text-sm px-2 py-1 rounded-lg flex-shrink-0
             transition-colors duration-200 flex items-center justify-center"
      data-category-name=""
      aria-label={i18n(I18nKey.home)}
    >
      <Icon name="material-symbols:home" class="text-lg" />
    </a>
    <a
      href={archiveUrl}
      class="category-pill text-sm px-3 py-1 rounded-lg whitespace-nowrap flex-shrink-0
             transition-colors duration-200 flex items-center justify-center"
      data-category-name="__archive__"
    >
      {i18n(I18nKey.archive)}
      <span class="text-xs opacity-60 ml-1">{totalPosts}</span>
    </a>
    <div class="category-divider flex-shrink-0"></div>
    <div class="scroll-area relative">
      <div class="scroll-fade scroll-fade-left" aria-hidden="true"></div>
      <div class="category-scroll flex gap-2 overflow-x-auto">
        {
          categories.map((cat) => (
            <a
              href={cat.url}
              class="category-pill text-sm px-3 py-1 rounded-lg whitespace-nowrap
                     transition-colors duration-200 flex items-center justify-center"
              data-category-name={cat.name}
            >
              {cat.name}
              <span class="text-xs opacity-60 ml-1">{cat.count}</span>
            </a>
          ))
        }
      </div>
      <div class="scroll-fade scroll-fade-right" aria-hidden="true"></div>
    </div>
  </div>
</div>

<style>
  .category-bar {
    margin-bottom: 1rem;
  }
  .category-divider {
    width: 1px;
    align-self: stretch;
    background: var(--line-divider);
  }
  .scroll-area {
    flex: 1;
    min-width: 0;
    position: relative;
  }
  .scroll-fade {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2.5rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 300ms ease-in-out;
    z-index: 1;
  }
  .scroll-fade[data-visible] {
    opacity: 1;
  }
  .scroll-fade-left {
    left: 0;
    background: linear-gradient(to left, transparent, var(--card-bg));
  }
  .scroll-fade-right {
    right: 0;
    background: linear-gradient(to right, transparent, var(--card-bg));
  }
  :global(body.wallpaper-transparent) .scroll-fade {
    display: none;
  }
  .category-scroll {
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
  }
  .category-scroll::-webkit-scrollbar {
    display: none;
  }
  .category-pill {
    border: 1.5px solid var(--line-divider);
    color: var(--btn-content);
    background: transparent;
  }
  .category-pill:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: transparent;
  }
  .category-pill[data-active] {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }
  .category-pill[data-active]:hover {
    background: var(--primary);
    border-color: var(--primary);
    opacity: 0.9;
  }
</style>

<script>
  function updateCategoryBar() {
    const bar = document.getElementById("category-bar");
    if (!bar) return;

    const pathname = window.location.pathname.replace(/\/$/, "");
    const homePath = (bar.getAttribute("data-home-path") || "/").replace(/\/$/, "");
    const archivePath = (bar.getAttribute("data-archive-path") || "/archive").replace(/\/$/, "");
    const isHome = pathname === homePath || pathname === "" || pathname === "/";
    const isArchive = pathname === archivePath;

    // 只在首页和归档页显示
    if (!isHome && !isArchive) {
      bar.style.display = "none";
      return;
    }
    bar.style.display = "";

    // 高亮当前分类
    const pills = bar.querySelectorAll<HTMLAnchorElement>(".category-pill");
    const params = new URLSearchParams(window.location.search);
    const activeCategory = params.get("category") || "";
    const hasTag = params.has("tag");
    const hasUncategorized = params.has("uncategorized");

    pills.forEach((pill) => pill.removeAttribute("data-active"));

    if (isHome) {
      bar.querySelector<HTMLAnchorElement>('.category-pill[data-category-name=""]')
        ?.setAttribute("data-active", "");
    } else if (activeCategory) {
      pills.forEach((pill) => {
        if (pill.getAttribute("data-category-name") === activeCategory) {
          pill.setAttribute("data-active", "");
        }
      });
    } else if (isArchive && !hasTag && !hasUncategorized) {
      bar.querySelector<HTMLAnchorElement>('.category-pill[data-category-name="__archive__"]')
        ?.setAttribute("data-active", "");
    }

    // 自动滚动到当前高亮的分类
    const activePill = bar.querySelector<HTMLAnchorElement>('.category-pill[data-active]');
    const scroll = bar.querySelector<HTMLElement>(".category-scroll");
    if (activePill && scroll) {
      const scrollLeft = activePill.offsetLeft - scroll.offsetLeft - (scroll.clientWidth - activePill.offsetWidth) / 2;
      scroll.scrollTo({ left: Math.max(0, scrollLeft), behavior: "smooth" });
    }

    // 更新横幅标题：归档页有分类筛选时显示分类名
    if (isArchive && activeCategory) {
      const bannerTitle = document.querySelector(".banner-page-title-text");
      if (bannerTitle) {
        bannerTitle.textContent = decodeURIComponent(activeCategory);
      }
    }
  }

  function initScrollFeatures() {
    const bar = document.getElementById("category-bar");
    if (!bar) return;

    const scroll = bar.querySelector<HTMLElement>(".category-scroll");
    if (!scroll) return;

    // 鼠标滚轮横向滚动
    scroll.addEventListener("wheel", (e) => {
      if (scroll.scrollWidth <= scroll.clientWidth) return;
      e.preventDefault();
      scroll.scrollLeft += e.deltaY;
    }, { passive: false });

    // 监听滚动更新提示图标
    scroll.addEventListener("scroll", updateScrollHint);
    window.addEventListener("resize", updateScrollHint);
    updateScrollHint();
  }

  function updateScrollHint() {
    const bar = document.getElementById("category-bar");
    if (!bar) return;
    const scroll = bar.querySelector<HTMLElement>(".category-scroll");
    const fadeLeft = bar.querySelector<HTMLElement>(".scroll-fade-left");
    const fadeRight = bar.querySelector<HTMLElement>(".scroll-fade-right");
    if (!scroll || !fadeLeft || !fadeRight) return;

    const hasOverflow = scroll.scrollWidth > scroll.clientWidth + 1;
    const atStart = scroll.scrollLeft <= 1;
    const atEnd = scroll.scrollLeft + scroll.clientWidth >= scroll.scrollWidth - 1;

    if (hasOverflow && !atStart) {
      fadeLeft.setAttribute("data-visible", "");
    } else {
      fadeLeft.removeAttribute("data-visible");
    }

    if (hasOverflow && !atEnd) {
      fadeRight.setAttribute("data-visible", "");
    } else {
      fadeRight.removeAttribute("data-visible");
    }
  }

  updateCategoryBar();
  initScrollFeatures();
  document.addEventListener("astro:page-load", () => {
    updateCategoryBar();
    initScrollFeatures();
  });
  document.addEventListener("swup:contentReplaced", updateCategoryBar);
</script>
</file>

<file path="components/layout/ConfigCarrier.astro">
---
import { backgroundWallpaper, siteConfig } from "@/config";
---

<!-- 全局配置载体 -->
<div
  id="config-carrier"
  data-hue={siteConfig.themeColor.hue}
  data-wallpaper-mode={backgroundWallpaper.mode}
>
</div>
</file>

<file path="components/layout/DropdownMenu.astro">
---
import { Icon } from "astro-icon/components";
import DropdownItem from "@/components/common/DropdownItem.astro";
import DropdownPanel from "@/components/common/DropdownPanel.astro";
import { LinkPresets } from "@/constants/link-presets";
import { LinkPreset, type NavBarLink } from "@/types/config";
import { url } from "@/utils/url-utils";

interface Props {
	link: NavBarLink;
	class?: string;
}

const { link, class: className } = Astro.props;

// 检查 link 是否存在
if (!link) {
	return null;
}

// 转换子菜单中的LinkPreset为NavBarLink
const processedLink = {
	...link,
	children: link.children
		?.map((child: NavBarLink | LinkPreset): NavBarLink | null => {
			if (typeof child === "number") {
				// 检查 LinkPreset 是否存在于 LinkPresets 中
				if (child in LinkPresets) {
					return LinkPresets[child as LinkPreset];
				}
				return null;
			}
			return child;
		})
		.filter((child): child is NavBarLink => child !== null),
};

const hasChildren = processedLink.children && processedLink.children.length > 0;
---

<div class:list={["dropdown-container", className]} data-dropdown>
	{hasChildren ? (
		<button 
			class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 dropdown-trigger"
			aria-expanded="false"
			aria-haspopup="true"
			data-dropdown-trigger
		>
			<div class="flex items-center">
				{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] mr-2 navbar-icon" />}
				{processedLink.name}
				<Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-[1.25rem] transition-transform duration-200 dropdown-arrow ml-1" />
			</div>
		</button>
		<div class="dropdown-menu" data-dropdown-menu>
			<DropdownPanel class="dropdown-content">
				{processedLink.children?.map((child, index) => (
					<DropdownItem
						href={child.external ? child.url : url(child.url)}
						target={child.external ? "_blank" : undefined}
						isLast={index === (processedLink.children?.length || 0) - 1}
						class="dropdown-item"
					>
						{child.icon && <Icon name={child.icon} class="text-[1.25rem] mr-3 navbar-icon" />}
						<span>{child.name}</span>
						{child.external && (
							<Icon name="fa7-solid:arrow-up-right-from-square" class="text-[0.75rem] text-black/25 dark:text-white/25 ml-auto" />
						)}
					</DropdownItem>
				))}
			</DropdownPanel>
		</div>
	) : (
		<a 
			aria-label={processedLink.name} 
			href={processedLink.external ? processedLink.url : url(processedLink.url)} 
			target={processedLink.external ? "_blank" : null}
			class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95"
		>
			<div class="flex items-center">
				{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] mr-2 navbar-icon" />}
				{processedLink.name}
				{processedLink.external && <Icon name="fa7-solid:arrow-up-right-from-square" class="text-[0.875rem] transition -translate-y-px ml-1 text-black/20 dark:text-white/20" />}
			</div>
		</a>
	)}
</div>

<style>
	@reference "../../styles/main.css";

	.dropdown-container {
		@apply relative;
	}

	.dropdown-menu {
		@apply absolute top-full left-0 pt-2 opacity-0 invisible pointer-events-none transition-all duration-200 ease-out transform translate-y-[-8px] z-50;
	}

	.dropdown-container:hover .dropdown-menu,
	.dropdown-container:focus-within .dropdown-menu {
		@apply opacity-100 visible pointer-events-auto translate-y-0;
	}

	.dropdown-container:hover .dropdown-arrow,
	.dropdown-container:focus-within .dropdown-arrow {
		@apply rotate-180;
	}

	.dropdown-content {
		@apply min-w-[12rem];
	}

	/* 移动端隐藏下拉菜单 */
	@media (max-width: 768px) {
		.dropdown-container {
			@apply hidden;
		}
	}
</style>

<script>
	// 键盘导航支持
	document.addEventListener('DOMContentLoaded', function() {
		const dropdowns = document.querySelectorAll('[data-dropdown]');
		
		dropdowns.forEach(dropdown => {
			const trigger = dropdown.querySelector('[data-dropdown-trigger]') as HTMLElement | null;
			const menu = dropdown.querySelector('[data-dropdown-menu]');
			const items = dropdown.querySelectorAll('.dropdown-item') as NodeListOf<HTMLElement>;
			
			if (!trigger || !menu) return;
			
			// 键盘事件处理
			trigger.addEventListener('keydown', function(e: KeyboardEvent) {
				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					toggleDropdown(dropdown, trigger, menu);
				} else if (e.key === 'ArrowDown') {
					e.preventDefault();
					openDropdown(dropdown, trigger, menu);
					if (items.length > 0) {
						items[0].focus();
					}
				} else if (e.key === 'Escape') {
					closeDropdown(dropdown, trigger, menu);
				}
			});
			
			// 菜单项键盘导航
			items.forEach((item, index) => {
				item.addEventListener('keydown', function(e: KeyboardEvent) {
					if (e.key === 'ArrowDown') {
						e.preventDefault();
						const nextIndex = (index + 1) % items.length;
						items[nextIndex].focus();
					} else if (e.key === 'ArrowUp') {
						e.preventDefault();
						const prevIndex = (index - 1 + items.length) % items.length;
						items[prevIndex].focus();
					} else if (e.key === 'Escape') {
						closeDropdown(dropdown, trigger, menu);
						trigger.focus();
					}
				});
			});
		});
		
		// 点击外部关闭下拉菜单
		document.addEventListener('click', function(e) {
			dropdowns.forEach(dropdown => {
				if (!dropdown.contains(e.target as Node)) {
					const trigger = dropdown.querySelector('[data-dropdown-trigger]');
					const menu = dropdown.querySelector('[data-dropdown-menu]');
					if (trigger && menu) {
						closeDropdown(dropdown, trigger, menu);
					}
				}
			});
		});
	});
	
	function toggleDropdown(_dropdown: Element, trigger: Element, menu: Element) {
		const isOpen = trigger.getAttribute('aria-expanded') === 'true';
		if (isOpen) {
			closeDropdown(_dropdown, trigger, menu);
		} else {
			openDropdown(_dropdown, trigger, menu);
		}
	}
	
	function openDropdown(_dropdown: Element, trigger: Element, menu: Element) {
		trigger.setAttribute('aria-expanded', 'true');
		menu.classList.remove('opacity-0', 'invisible', 'pointer-events-none', 'translate-y-[-8px]');
		menu.classList.add('opacity-100', 'visible', 'pointer-events-auto', 'translate-y-0');
	}
	
	function closeDropdown(_dropdown: Element, trigger: Element, menu: Element) {
		trigger.setAttribute('aria-expanded', 'false');
		menu.classList.add('opacity-0', 'invisible', 'pointer-events-none', 'translate-y-[-8px]');
		menu.classList.remove('opacity-100', 'visible', 'pointer-events-auto', 'translate-y-0');
	}
</script>
</file>

<file path="components/layout/Footer.astro">
---
import fs from "node:fs";
import path from "node:path";
import { footerConfig, profileConfig } from "@/config";
import { url } from "@/utils/url-utils";

const currentYear = new Date().getFullYear();

// 读取FooterConfig.html文件内容
let customFooterHtml = "";
if (footerConfig.enable) {
	try {
		const footerConfigPath = path.join(
			process.cwd(),
			"src",
			"config",
			"FooterConfig.html",
		);
		customFooterHtml = fs.readFileSync(footerConfigPath, "utf-8");
		// 移除HTML注释
		customFooterHtml = customFooterHtml.replace(/<!--[\s\S]*?-->/g, "").trim();
	} catch (error) {
		console.warn("FooterConfig.html文件读取失败:", error.message);
	}
}
---


<div
  class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-32"
>
</div>

<div
  class="transition border-dashed border-[oklch(85%_0.01_var(--hue))] dark:border-white/15 rounded-2xl mb-12 flex flex-col items-center justify-center px-6"
>
  <div class="transition text-50 text-sm text-center">
    <div class="mb-2">
      {customFooterHtml && <div set:html={customFooterHtml} />}
    </div>
    <div class="m-0.5">
      &copy; <span id="copyright-year">{currentYear}</span>
      {profileConfig.name}. All Rights Reserved. /
      <a
        class="transition link text-(--primary) font-medium"
        target="_blank"
        href={url("rss.xml")}>RSS</a
      > /
      <a
        class="transition link text-(--primary) font-medium"
        target="_blank"
        href={url("sitemap-index.xml")}>Sitemap</a
      >
    </div>
    <div class="m-0.5">
      Powered by
      <a
        class="transition link text-(--primary) font-medium"
        target="_blank"
        href="https://astro.build">Astro</a
      > &
      <a
        class="transition link text-(--primary) font-medium"
        target="_blank"
        href="https://github.com/CuteLeaf/Firefly">Firefly</a
      >
    </div>
    <!-- 
      注意：请勿随意修改或删除 "Powered by Astro & Firefly" 部分，这是对开源项目的尊重和支持。
      如果您需要在底部增加内容，请在src/config/footerConfig.ts中修改enable属性为true，然后编辑src/config/FooterConfig.html文件。
      您可以随意在src/config/FooterConfig.html中随意添加自定义内容，不需要修改Footer.astro文件。
    -->
  </div>
</div>
</file>

<file path="components/layout/Navbar.astro">
---
import { Picture } from "astro:assets";
import * as path from "node:path";
import type { ImageMetadata } from "astro";
import { Icon } from "astro-icon/components";
import DisplaySettings from "@/components/controls/DisplaySettingsIntegrated.svelte";
import LightDarkSwitch from "@/components/controls/LightDarkSwitch.svelte";
import Search from "@/components/controls/Search.svelte";
import MusicPlayer from "@/components/features/MusicPlayer.astro";
import { backgroundWallpaper, navBarConfig, siteConfig } from "@/config";
import { musicPlayerConfig } from "@/config/musicConfig";
import { LinkPresets } from "@/constants/link-presets";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { LinkPreset, type NavBarLink } from "@/types/config";
import { getFallbackFormat, getImageFormats } from "@/utils/image-utils";
import { isHomePage } from "@/utils/layout-utils";
import { url } from "@/utils/url-utils";
import DropdownMenu from "./DropdownMenu.astro";
import NavMenuPanel from "./NavMenuPanel.astro";

const className = Astro.props.class;

// 获取导航栏透明模式配置
const navbarTransparentMode =
	backgroundWallpaper.mode === "banner"
		? backgroundWallpaper.banner?.navbar?.transparentMode || "semi"
		: "semi";

// 获取导航栏毛玻璃效果配置
const navbarEnableBlur =
	backgroundWallpaper.mode === "banner"
		? (backgroundWallpaper.banner?.navbar?.enableBlur ?? true)
		: false;

// 获取导航栏模糊度
const navbarBlur =
	backgroundWallpaper.mode === "banner"
		? (backgroundWallpaper.banner?.navbar?.blur ?? 20)
		: 0;

// 获取导航栏标题，如果没有设置则使用 siteConfig.title
const navbarTitle = siteConfig.navbar.title || siteConfig.title;

// 获取导航栏宽度配置
const navbarWidthFull = siteConfig.navbar.widthFull ?? false;

// 检查是否为首页
const isHomePageCheck = isHomePage(Astro.url.pathname);

// 检查是否有任何显示设置可用
const showThemeColor = !siteConfig.themeColor.fixed;
const isWallpaperSwitchable = backgroundWallpaper.switchable ?? true;
const allowLayoutSwitch = siteConfig.postListLayout.allowSwitch;
const hasDisplaySettings =
	showThemeColor || isWallpaperSwitchable || allowLayoutSwitch;

let links: NavBarLink[] = navBarConfig.links.map(
	(item: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		return item;
	},
);

// 处理导航栏 Logo 图片
const logoValue = siteConfig.navbar.logo?.value || "";
const isLocalSrcLogo =
	siteConfig.navbar.logo?.type === "image" &&
	logoValue &&
	!logoValue.startsWith("/") &&
	!logoValue.startsWith("http");
let logoImg: ImageMetadata | null = null;

if (isLocalSrcLogo) {
	const files = import.meta.glob<ImageMetadata>(
		"../../**/*.{png,jpg,jpeg,webp,avif,gif,svg}",
		{ import: "default" },
	);
	const normalizedPath = path
		.normalize(path.join("../../", logoValue))
		.replace(/\\/g, "/");
	const file = files[normalizedPath];
	if (file) {
		logoImg = await file();
	}
}
---
<div id="navbar" class="z-50" style={`--navbar-glass-blur: ${navbarBlur}px;`} data-transparent-mode={navbarTransparentMode} data-enable-blur={String(navbarEnableBlur)} data-is-home={isHomePageCheck} data-full-width={navbarWidthFull}>
    <div class:list={[
        className,
        "overflow-visible! h-18 mx-auto flex items-center px-4",
        navbarWidthFull ? "" : "justify-between max-w-(--page-width)"
    ]}>
        <a href={url('/')} class="btn-plain scale-animation rounded-lg h-13 px-5 font-bold active:scale-95">
            <div class:list={[
                "flex flex-row items-center text-md",
                siteConfig.navbar.followTheme ? "text-(--primary)" : "dark:text-white text-black"
            ]}>
                                {siteConfig.navbar.logo?.type === "icon" ? (
                                    <Icon name={siteConfig.navbar.logo.value || "material-symbols:home-pin-outline"} class="text-[1.75rem] mb-1 mr-2" />
                                ) : siteConfig.navbar.logo?.type === "image" && logoImg ? (
                                    <Picture
                                        src={logoImg}
                                        alt={siteConfig.navbar.logo.alt || siteConfig.title}
                                        class="h-7 w-7 mb-1 mr-2 object-contain"
                                        formats={getImageFormats()}
                                        fallbackFormat={getFallbackFormat()}
                                        widths={[28, 56]}
                                        loading="eager"
                                        fetchpriority="high"
                                    />
                                ) : siteConfig.navbar.logo?.type === "image" ? (
                                    <img src={url(siteConfig.navbar.logo.value)} alt={siteConfig.navbar.logo.alt || siteConfig.title} class="h-7 w-7 mb-1 mr-2 object-contain" fetchpriority="high" />
                                ) : siteConfig.navbar.logo?.type === "url" ? (
                                    <img src={siteConfig.navbar.logo.value} alt={siteConfig.navbar.logo.alt || siteConfig.title} class="h-7 w-7 mb-1 mr-2 object-contain" fetchpriority="high" />
                                ) : (
                                    <Icon name="material-symbols:home-pin-outline" class="text-[1.75rem] mb-1 mr-2" />
                                )}
                {navbarTitle}
            </div>
        </a>
        <div class="hidden lg:flex items-center space-x-1">
            {links.map((l) => {
                return <DropdownMenu link={l} />;
            })}
        </div>
        <div class:list={["flex", navbarWidthFull ? "ml-auto" : ""]}>
            <!--<SearchPanel client:load>-->
            <Search
                client:load
            />
            {musicPlayerConfig.showInNavbar && (
                <button aria-label={i18n(I18nKey.music)} class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="music-player-switch">
                    <Icon name="material-symbols:music-note-rounded" class="text-[1.25rem]"></Icon>
                </button>
            )}
            {hasDisplaySettings && (
                    <button aria-label="Display Settings" class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="display-settings-switch">
                        <Icon name="material-symbols:palette-outline" class="text-[1.25rem]"></Icon>
                    </button>
            )}
            {/* @ts-ignore */}
            <LightDarkSwitch client:load></LightDarkSwitch>
            <button aria-label="Menu" name="Nav Menu" class="btn-plain scale-animation rounded-lg w-11 h-11 active:scale-90 lg:hidden!" id="nav-menu-switch">
                <Icon name="material-symbols:menu-rounded" class="text-[1.25rem]"></Icon>
            </button>
        </div>
        {musicPlayerConfig.showInNavbar && (
            <div id="music-nav-panel" class="float-panel float-panel-closed absolute transition-all right-16 p-2 pt-4.5 w-80 z-50">
                <MusicPlayer />
            </div>
        )}
        <NavMenuPanel links={links}></NavMenuPanel>
        <DisplaySettings client:load></DisplaySettings>
    </div>
</div>

<script>
function loadButtonScript() {
    let settingBtn = document.getElementById("display-settings-switch");
    if (settingBtn) {
        settingBtn.onclick = function () {
            let settingPanel = document.getElementById("display-setting");
            if (settingPanel) {
                settingPanel.classList.toggle("float-panel-closed");
            }
        };
    }

    let menuBtn = document.getElementById("nav-menu-switch");
    if (menuBtn) {
        menuBtn.onclick = function () {
            let menuPanel = document.getElementById("nav-menu-panel");
            if (menuPanel) {
                menuPanel.classList.toggle("float-panel-closed");
            }
        };
    }

    let musicBtn = document.getElementById("music-player-switch");
    if (musicBtn) {
        musicBtn.onclick = function () {
            let musicPanel = document.getElementById("music-nav-panel");
            if (musicPanel) {
                musicPanel.classList.toggle("float-panel-closed");
            }
        };
    }

    let themeSwitchBtn = document.getElementById("scheme-switch");
    if (themeSwitchBtn) {
        themeSwitchBtn.onclick = function () {
            let themePanel = document.getElementById("theme-mode-panel");
            if (themePanel) {
                themePanel.classList.toggle("float-panel-closed");
            }
        };
    }

    document.addEventListener("click", function(event) {
        const panels = ["display-setting", "nav-menu-panel", "music-nav-panel", "theme-mode-panel"];
        const buttons = ["display-settings-switch", "nav-menu-switch", "music-player-switch", "scheme-switch"];

        panels.forEach((id, index) => {
            const panel = document.getElementById(id);
            const button = document.getElementById(buttons[index]);
            if (panel && button && !panel.classList.contains("float-panel-closed")) {
                if (event.target instanceof Node && !panel.contains(event.target) && !button.contains(event.target)) {
                    panel.classList.add("float-panel-closed");
                }
            }
        });
    });
}

loadButtonScript();

// 为semifull模式添加滚动检测逻辑
function initSemifullScrollDetection() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;

    const transparentMode = navbar.getAttribute('data-transparent-mode');
    if (transparentMode !== 'semifull') return;

    // 无论首页/非首页，semifull 都由滚动位置决定是否进入 scrolled 状态
    // 先移除之前的滚动监听器，避免重复绑定
    if (window.semifullScrollHandler) {
        window.removeEventListener('scroll', window.semifullScrollHandler as () => void);
        window.semifullScrollHandler = undefined;
    }

    // 初始状态不强制加 scrolled，保持透明；滚动后再切换
    navbar.classList.remove('scrolled');

    let ticking = false;

    function updateNavbarState() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const threshold = 50; // 滚动阈值，可以根据需要调整
        // 使用批量DOM操作优化性能
        if (scrollTop > threshold) {
            navbar!.classList.add('scrolled');
        } else {
            navbar!.classList.remove('scrolled');
        }

        ticking = false;
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(updateNavbarState);
            ticking = true;
        }
    }

    // 移除之前的滚动事件监听器（如果存在）
    if (window.semifullScrollHandler) {
        window.removeEventListener('scroll', window.semifullScrollHandler as () => void);
    }

    // 保存新的事件处理器引用
    window.semifullScrollHandler = requestTick as unknown as (() => void);

    // 监听滚动事件
    window.addEventListener('scroll', requestTick, { passive: true });

    // 初始化状态
    updateNavbarState();
}

// 将函数暴露到全局对象，供页面切换时调用
window.initSemifullScrollDetection = initSemifullScrollDetection;

// 页面加载完成后初始化滚动检测
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSemifullScrollDetection);
} else {
    initSemifullScrollDetection();
}
</script>

{
    import.meta.env.PROD && (
        <script is:inline data-swup-ignore-script define:vars={{ scriptUrl: url('/pagefind/pagefind.js') }}>
            {/* 你的 loadPagefind 函数的完整内容放在这里 */}
            async function loadPagefind() {
                try {
                    const response = await fetch(scriptUrl, { method: 'HEAD' });
                    if (!response.ok) {
                        throw new Error(`Pagefind script not found: ${response.status}`);
                    }
                    const pagefind = await import(scriptUrl);
                    await pagefind.options({
                        excerptLength: 20
                    });
                    window.pagefind = pagefind;
                    document.dispatchEvent(new CustomEvent('pagefindready'));
                    console.log('Pagefind loaded and initialized successfully, event dispatched.');
                } catch (error) {
                    console.error('Failed to load Pagefind:', error);
                    window.pagefind = {
                        search: () => Promise.resolve({ results: [] }),
                        options: () => Promise.resolve(),
                    };
                    document.dispatchEvent(new CustomEvent('pagefindloaderror'));
                    console.log('Pagefind load error, event dispatched.');
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadPagefind);
            } else {
                loadPagefind();
            }
        </script>
    )
}
</file>

<file path="components/layout/NavMenuPanel.astro">
---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "@/constants/link-presets";
import { LinkPreset, type NavBarLink } from "@/types/config";
import { url } from "@/utils/url-utils";

interface Props {
	links: NavBarLink[];
}

// 处理links中的LinkPreset转换
const processedLinks = Astro.props.links.map((link: NavBarLink) => ({
	...link,
	children: link.children?.map((child: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof child === "number") {
			return LinkPresets[child];
		}
		return child;
	}),
}));
---
<div id="nav-menu-panel" class:list={["float-panel float-panel-closed absolute transition-all fixed right-4 px-2 py-2 max-h-[80vh] overflow-y-auto"]}>
    {processedLinks.map((link) => (
        <div class="mobile-menu-item">
            {link.children && link.children.length > 0 ? (
                <!-- 有子菜单的项目 -->
                <div class="mobile-dropdown" data-mobile-dropdown>
                    <button 
                        class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-8 w-full text-left
                            hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) transition"
                        data-mobile-dropdown-trigger
                        aria-expanded="false"
                    >
                        <div class="flex items-center transition text-black/75 dark:text-white/75 font-bold group-hover:text-(--primary) group-active:text-(--primary)">
                            {link.icon && <Icon name={link.icon} class="text-[1.1rem] mr-2" />}
                            {link.name}
                        </div>
                        <Icon name="material-symbols:keyboard-arrow-down-rounded"
                              class="transition text-[1.25rem] text-(--primary) mobile-dropdown-arrow duration-200"
                        />
                    </button>
                    <div class="mobile-submenu" data-mobile-submenu>
                        {link.children.map((child) => (
                            <a href={child.external ? child.url : url(child.url)} 
                               class="group flex justify-between items-center py-2 pl-6 pr-1 rounded-lg gap-8
                                   hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) transition"
                               target={child.external ? "_blank" : null}
                            >
                                <div class="flex items-center transition text-black/60 dark:text-white/60 font-medium group-hover:text-(--primary) group-active:text-(--primary)">
                                    {child.icon && <Icon name={child.icon} class="text-[1.1rem] mr-2" />}
                                    {child.name}
                                </div>
                                {child.external && <Icon name="fa7-solid:arrow-up-right-from-square"
                                      class="transition text-[0.75rem] text-black/25 dark:text-white/25 -translate-x-1"
                                />}
                            </a>
                        ))}
                    </div>
                </div>
            ) : (
                <!-- 普通链接项目 -->
                <a href={link.external ? link.url : url(link.url)} class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-8
                    hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) transition
                "
                   target={link.external ? "_blank" : null}
                >
                    <div class="flex items-center transition text-black/75 dark:text-white/75 font-bold group-hover:text-(--primary) group-active:text-(--primary)">
                        {link.icon && <Icon name={link.icon} class="text-[1.1rem] mr-2" />}
                        {link.name}
                    </div>
                    {!link.external && <Icon name="material-symbols:chevron-right-rounded"
                          class="transition text-[1.25rem] text-(--primary)"
                    />}
                    {link.external && <Icon name="fa7-solid:arrow-up-right-from-square"
                          class="transition text-[0.75rem] text-black/25 dark:text-white/25 -translate-x-1"
                    />}
                </a>
            )}
        </div>
    ))}
</div>

<style>
    @reference "../../styles/main.css";

    .mobile-submenu {
        @apply max-h-0 overflow-hidden transition-all duration-300 ease-in-out;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-submenu {
        @apply max-h-96;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-dropdown-arrow {
        @apply rotate-180;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mobileDropdowns = document.querySelectorAll('[data-mobile-dropdown]');
        
        mobileDropdowns.forEach(dropdown => {
            const trigger = dropdown.querySelector('[data-mobile-dropdown-trigger]');
            const submenu = dropdown.querySelector('[data-mobile-submenu]');
            
            if (!trigger || !submenu) return;
            
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                const isExpanded = dropdown.getAttribute('data-expanded') === 'true';
                
                // 关闭其他打开的下拉菜单
                mobileDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        otherDropdown.setAttribute('data-expanded', 'false');
                        const otherTrigger = otherDropdown.querySelector('[data-mobile-dropdown-trigger]');
                        if (otherTrigger) {
                            otherTrigger.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                
                // 切换当前下拉菜单
                const newState = !isExpanded;
                dropdown.setAttribute('data-expanded', newState.toString());
                trigger.setAttribute('aria-expanded', newState.toString());
            });
        });
    });
</script>
</file>

<file path="components/layout/PostCard.astro">
---
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import { Icon } from "astro-icon/components";
import CoverImage from "@/components/common/CoverImage.astro";
import PostMetadata from "@/components/layout/PostMeta.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrlList, processCoverImageSync } from "@/utils/image-utils";
import { getFileDirFromPath, getTagUrl } from "@/utils/url-utils";

interface Props {
	class?: string;
	entry: CollectionEntry<"posts">;
	title: string;
	url: string;
	published: Date;
	updated?: Date;
	tags: string[];
	category: string | null;
	image: string;
	description: string;
	draft: boolean;
	pinned?: boolean;
	style: string;
	loading?: "lazy" | "eager";
}
const {
	entry,
	title,
	url,
	published,
	updated,
	tags,
	category,
	image,
	description,
	pinned,
	style,
	loading = "lazy",
} = Astro.props;
const className = Astro.props.class;

// 处理随机图：如果image为"api"，则从配置的API获取随机图
const processedImage = processCoverImageSync(image, entry.id);
const apiUrls = getApiUrlList(image, entry.id);
const hasCover =
	processedImage !== undefined &&
	processedImage !== null &&
	processedImage !== "";

const coverWidth = "30%";

const { remarkPluginFrontmatter } = await render(entry);
---

<div
  class:list={[
    "post-card-wrapper",
    hasCover ? "has-cover" : "no-cover",
    pinned ? "pinned" : "",
    "card-base flex flex-col-reverse md:flex-col w-full rounded-(--radius-large) overflow-hidden relative",
    className,
  ]}
  style={style}
>
  <!-- pinned icon -->
  <div
    class:list={[
      "post-card-content",
      "pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 md:pb-7 relative flex flex-col h-full",
      {
        "w-full md:w-[calc(100%-52px-12px)]": !hasCover,
        "w-full md:w-[calc(100%-var(--coverWidth)-1.5rem)]": hasCover,
      },
    ]}
  >


    <a
      href={url}
      class="post-card-title transition group w-full block font-bold mb-3 text-3xl text-90
        hover:text-(--primary) dark:hover:text-(--primary)
        active:text-(--title-active) dark:active:text-(--title-active)
        before:w-1 before:h-5 before:rounded-md before:bg-(--primary)
        before:absolute before:top-[35px] before:left-[18px] before:hidden md:before:block"
    >
      {title}<Icon
        class="inline text-[2rem] text-(--primary) md:hidden align-middle -translate-y-[2px] -ml-1"
        name="material-symbols:chevron-right-rounded"
      />
    </a>

    <!-- metadata -->
    <PostMetadata
      published={published}
      updated={updated}
      tags={tags}
      category={category || undefined}
      hideTagsForMobile={true}
      hideUpdateDate={true}
      words={remarkPluginFrontmatter.words}
      minutes={remarkPluginFrontmatter.minutes}
      showWordCount={true}
      pinned={pinned}
      className="mb-4 post-meta"
    />

    <!-- description -->
    <div
      class:list={[
        "transition text-75 mb-3.5 md:pr-4 description grow",
        { "line-clamp-2 md:line-clamp-1": !description },
      ]}
    >
      {description || remarkPluginFrontmatter.excerpt}
    </div>

    <!-- tags -->
    <div
      class="text-sm text-black/30 dark:text-white/30 flex flex-wrap gap-2 transition stats mt-auto"
    >
      {
        tags &&
          tags.length > 0 &&
          tags.map((tag, _i) => (
            <a
              href={getTagUrl(tag)}
              aria-label={`View all posts with the ${tag.trim()} tag`}
              class="btn-regular h-6 text-xs px-2 py-1 rounded-md 
                    transition-all duration-200 hover:scale-105 active:scale-95"
            >
              #{tag.trim()}
            </a>
          ))
      }
      {
        !(tags && tags.length > 0) && (
          <span class="text-(--content-meta) text-xs">
            #{i18n(I18nKey.noTags)}
          </span>
        )
      }
    </div>
  </div>

  {
    hasCover && (
      <a
        href={url}
        aria-label={title}
        class:list={[
          "post-card-image",
          "group",
          "w-full md:w-(--coverWidth)",
          "aspect-2/1 md:aspect-auto",
          "relative md:absolute md:top-4 md:bottom-4 md:right-4",
          "rounded-t-(--radius-large) md:rounded-xl overflow-hidden",
        ]}
      >
        <div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition" />
        <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center ">
          <Icon
            name="material-symbols:chevron-right-rounded"
            class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl"
          />
        </div>
        <CoverImage
          src={processedImage}
          basePath={getFileDirFromPath(entry.filePath || '')}
          alt="Cover Image of the Post"
          class="w-full h-full transition-transform duration-300 group-hover:scale-110 group-active:scale-115"
          preview={true}
          loading={loading}
          apiUrls={apiUrls}
        />
      </a>
    )
  }

  {
    !hasCover && (
      <a
        href={url}
        aria-label={title}
        class:list={[
          "post-card-enter-btn",
          "hidden md:flex btn-regular w-13",
          "absolute right-3 top-3 bottom-3 rounded-xl bg-(--enter-btn-bg)",
          "hover:bg-(--enter-btn-bg-hover) active:bg-(--enter-btn-bg-active) active:scale-95",
        ]}
      >
        <Icon
          name="material-symbols:chevron-right-rounded"
          class="transition text-(--primary) text-4xl mx-auto"
        />
      </a>
    )
  }
</div>

<style define:vars={{ coverWidth }}>
  /* Grid Mode Styles */
  :global(.grid-mode) .post-card-wrapper {
    flex-direction: column-reverse !important;
    height: 100% !important;
    justify-content: flex-end !important;
  }

  :global(.grid-mode) .post-card-content {
    width: 100% !important;
    height: auto !important;
    flex-grow: 1 !important;
  }

  :global(.grid-mode) .post-card-image {
    position: relative !important;
    top: auto !important;
    bottom: auto !important;
    right: auto !important;
    width: 100% !important;
    margin: 0 !important;
    border-radius: var(--radius-large) var(--radius-large) 0 0 !important;
    max-height: none !important;
    aspect-ratio: 2/1 !important;
  }

  :global(.grid-mode) .description {
    flex-grow: 0 !important;
  }

  :global(.grid-mode) .stats {
    margin-top: auto !important;
  }

  :global(.grid-mode) .has-cover .post-card-content {
    padding-top: 0.8rem !important;
  }
  :global(.grid-mode) .has-cover .post-card-title::before {
    top: 1.3rem !important;
  }

</style>
</file>

<file path="components/layout/PostMeta.astro">
---
import { Icon } from "astro-icon/components";
import { commentConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { formatDateToYYYYMMDD } from "@/utils/date-utils";
import { getCategoryUrl, getTagUrl } from "@/utils/url-utils";

export interface Props {
	published: Date;
	updated?: Date;
	category?: string;
	tags?: string[];
	hideUpdateDate?: boolean;
	hideTagsForMobile?: boolean;
	isHome?: boolean;
	className?: string;
	id?: string;
	words?: number;
	minutes?: number;
	showWordCount?: boolean; // 是否显示字数统计，默认false显示标签
	customPath?: string;
	pinned?: boolean;
}

const {
	published,
	updated,
	category,
	tags,
	hideUpdateDate,
	hideTagsForMobile,
	isHome,
	className = "",
	id,
	words,
	minutes,
	showWordCount = false,
	customPath,
	pinned,
} = Astro.props;

const path = customPath || (id ? `/posts/${id}` : "");
---

<div
  class:list={[
    "flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2",
    className,
  ]}
>
  <!-- pinned -->
  {
    pinned && (
      <div class="pinned-btn flex items-center gap-1 bg-(--btn-regular-bg) text-(--btn-content) rounded-md px-2 py-1.5 font-bold">
        <Icon name="material-symbols:pinboard" class="text-xl" />
        <span class="text-sm">{i18n(I18nKey.pinned)}</span>
      </div>
    )
  }

  <!-- publish date -->
  <div class="flex items-center">
    <div class="meta-icon">
      <Icon
        name="material-symbols:calendar-today-outline-rounded"
        class="text-xl"
      />
    </div>
    <span class="text-50 text-sm font-medium"
      >{formatDateToYYYYMMDD(published)}</span
    >
  </div>

  <!-- update date -->
  {
    !hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
      <div class="flex items-center">
        <div class="meta-icon">
          <Icon
            name="material-symbols:edit-calendar-outline-rounded"
            class="text-xl"
          />
        </div>
        <span class="text-50 text-sm font-medium">
          {formatDateToYYYYMMDD(updated)}
        </span>
      </div>
    )
  }

  <!-- categories -->
  <div class="flex items-center">
    <div class="meta-icon">
      <Icon name="material-symbols:book-2-outline-rounded" class="text-xl" />
    </div>
    <div class="flex flex-row flex-nowrap items-center">
      <a
        href={getCategoryUrl(category || "")}
        aria-label={`View all posts in the ${category} category`}
        class="link-lg transition text-50 text-sm font-medium
                            hover:text-(--primary) dark:hover:text-(--primary) whitespace-nowrap"
      >
        {category || i18n(I18nKey.uncategorized)}
      </a>
    </div>
  </div>

   <!-- word count and read time (only for post list) -->
   {
     showWordCount && words !== undefined && minutes !== undefined && (
       <>
         <!-- word count -->
         <div class="flex items-center">
           <div class="meta-icon">
             <Icon
               name="material-symbols:article-outline-rounded"
               class="text-xl"
             />
           </div>
           <div class="text-50 text-sm font-medium">
             {words}
             {" " + i18n(words === 1 ? I18nKey.wordCount : I18nKey.wordsCount)}
           </div>
         </div>
         
{/*          <!-- read time -->
         <div class="flex items-center">
           <div class="meta-icon">
             <Icon
               name="material-symbols:schedule-outline-rounded"
               class="text-xl"
             />
           </div>
           <div class="text-50 text-sm font-medium">
             {minutes}
             {" " +
               i18n(minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
           </div>
         </div> */}
       </>
     )
   }

   <!-- tags (only for post detail page) -->
   {
     !showWordCount && (
       <div class:list={["items-center", {"flex": !hideTagsForMobile, "hidden md:flex": hideTagsForMobile}]}>
         <div class="meta-icon">
           <Icon name="material-symbols:tag-rounded" class="text-xl" />
         </div>
         <div class="flex flex-row flex-nowrap items-center">
           {(tags && tags.length > 0) && tags.map((tag, i) => (
             <div class:list={[{"hidden": i == 0}, "mx-1.5 text-(--meta-divider) text-sm"]}>/</div>
             <a href={getTagUrl(tag)} aria-label={`View all posts with the ${tag.trim()} tag`}
                class="link-lg transition text-50 text-sm font-medium
                             hover:text-(--primary) dark:hover:text-(--primary) whitespace-nowrap">
               {tag.trim()}
             </a>
           ))}
           {!(tags && tags.length > 0) && <div class="transition text-50 text-sm font-medium">{i18n(I18nKey.noTags)}</div>}
         </div>
       </div>
     )
   }

  <!-- Twikoo访问量统计（首页不显示，且文章访问量统计启用时显示） -->
  {
    !isHome &&
      commentConfig.type === 'twikoo' &&
      commentConfig.twikoo?.visitorCount &&
      id && (
        <div class="flex items-center">
          <div class="meta-icon">
            <Icon
              name="material-symbols:visibility-outline-rounded"
              class="text-xl"
            />
          </div>
          <span class="text-50 text-sm font-medium mr-1">
            {i18n(I18nKey.pageViews)}
          </span>
          <span class="text-50 text-sm font-medium" id="twikoo_visitors">
            {i18n(I18nKey.pageViewsLoading)}
          </span>
        </div>
      )
  }
  <!-- Waline访问量统计（首页不显示、仅type为waline时显示） -->
  {
    !isHome &&
      commentConfig.type === 'waline' &&
      commentConfig.waline?.visitorCount &&
      id && (
        <div class="flex items-center">
          <div class="meta-icon">
            <Icon name="material-symbols:visibility-outline-rounded" class="text-xl" />
          </div>
          <span class="text-50 text-sm font-medium mr-1">
            {i18n(I18nKey.pageViews)}
          </span>
          <span class="text-50 text-sm font-medium waline-pageview-count" data-path={path}>{i18n(I18nKey.pageViewsLoading)}</span>
        </div>
      )
  }
    <!-- artalk访问量统计（首页不显示、仅type为artalk时显示） -->
    {
        !isHome &&
        commentConfig.type === 'artalk' &&
        commentConfig.waline?.visitorCount &&
        id && (
                    <div class="flex items-center">
                        <div class="meta-icon">
                            <Icon name="material-symbols:visibility-outline-rounded" class="text-xl" />
                        </div>
                        <span class="text-50 text-sm font-medium mr-1">
                            {i18n(I18nKey.pageViews)}
                        </span>
                        <span class="text-50 text-sm font-medium artalk-pv-count" data-path={path}>{i18n(I18nKey.pageViewsLoading)}</span>
                    </div>
        )
    }
</div>
</file>

<file path="components/layout/PostPage.astro">
---
import type { CollectionEntry } from "astro:content";
import { getPostUrlBySlug } from "@utils/url-utils";
import PostCard from "@/components/layout/PostCard.astro";
import { sidebarLayoutConfig, siteConfig } from "@/config";

const { page } = Astro.props;

let delay = 0;
const interval = 50;

// 类型别名避免Fragment语法问题
type PostEntry = CollectionEntry<"posts">;

// 检查是否启用双侧边栏
const isBothSidebars = sidebarLayoutConfig.position === "both";
const masonryEnabled = siteConfig.postListLayout.grid.masonry;
const gridColumns = siteConfig.postListLayout.grid.columns || 2;

// 根据配置设置初始布局模式，避免闪烁
const defaultLayout = siteConfig.postListLayout.defaultMode || "list";
const gridCols =
	!isBothSidebars && gridColumns === 3
		? "md:grid-cols-2 lg:grid-cols-3"
		: "md:grid-cols-2";
const initialLayoutClass =
	defaultLayout === "grid"
		? `grid grid-cols-1 ${gridCols} gap-4 grid-mode`
		: "flex flex-col gap-4 md:gap-4 list-mode";
---

<div
  id="post-list-container"
  class={`transition-all duration-500 ease-in-out mb-4 ${initialLayoutClass}`}
  data-default-layout={defaultLayout}
  data-both-sidebars={isBothSidebars}
  data-masonry-enabled={masonryEnabled}
  data-grid-columns={gridColumns}
>
  {
    page.data.map((entry: PostEntry, index: number) => (
      <PostCard
        entry={entry}
        title={entry.data.title}
        tags={entry.data.tags}
        category={entry.data.category}
        published={entry.data.published}
        updated={entry.data.updated}
        url={getPostUrlBySlug(entry.id)}
        image={entry.data.image}
        description={entry.data.description}
        draft={entry.data.draft}
        pinned={entry.data.pinned}
        loading={index < 2 ? "eager" : "lazy"}
        class:list="onload-animation post-card-item"
        style={`animation-delay: calc(var(--content-delay) + ${delay++ * interval}ms);`}
      />
    ))
  }
</div>

<!-- 立即执行脚本：防止刷新时的布局闪烁 -->
<script is:inline define:vars={{ defaultLayout, isBothSidebars, gridColumns }}>
  (function() {
    const savedLayout = localStorage.getItem('postListLayout');

    // 如果有保存的布局且与默认布局不同，更新容器布局
    if (savedLayout && savedLayout !== defaultLayout) {
      const container = document.getElementById('post-list-container');

      if (container) {
        // 禁用过渡动画
        container.style.transition = 'none';

        // 移除所有布局类
        container.classList.remove('list-mode', 'grid-mode', 'flex', 'flex-col', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-4', 'md:gap-4');

        if (savedLayout === 'grid') {
          container.classList.add('grid-mode', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4');
          if (!isBothSidebars && gridColumns === 3) {
            container.classList.add('lg:grid-cols-3');
          }
        } else {
          container.classList.add('list-mode', 'flex', 'flex-col', 'gap-4', 'md:gap-4');
        }

        // 强制重排后恢复过渡动画
        container.offsetHeight;
        container.style.transition = '';
      }
    }
  })();
</script>

<script>
  // 动态布局切换脚本
  function initLayout() {
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;

    // 检查屏幕宽度
    const screenWidth = window.innerWidth;
    const isSmallScreen = screenWidth < 1200;

    // 从localStorage读取用户偏好
    const savedLayout = localStorage.getItem("postListLayout");
    const defaultLayout =
      postListContainer.getAttribute("data-default-layout") || "list";
    let currentLayout = savedLayout || defaultLayout;

    // 如果屏幕宽度小于1200px，强制使用列表模式
    if (isSmallScreen) {
      currentLayout = "list";
    }

    // 应用布局
    updatePostListLayout(currentLayout);
  }

  function updatePostListLayout(layout: string) {
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;

    // Check current layout state
    const isCurrentGrid = postListContainer.classList.contains("grid-mode");
    const isCurrentList = postListContainer.classList.contains("list-mode");
    const currentLayout = isCurrentGrid ? "grid" : (isCurrentList ? "list" : null);

    // Common logic vars
    const isBothSidebars = postListContainer.getAttribute("data-both-sidebars") === "true";
    const masonryEnabled = postListContainer.getAttribute("data-masonry-enabled") === "true";
    const gridColumns = parseInt(postListContainer.getAttribute("data-grid-columns") || "2");

    // Helper to apply layout classes (Pure logic, no animation)
    const applyClasses = () => {
        postListContainer.classList.remove("list-mode", "grid-mode");
        if (layout === "grid") {
            postListContainer.classList.add("grid-mode");
            postListContainer.classList.remove("flex", "flex-col");
            if (masonryEnabled) {
                postListContainer.classList.remove("grid", "grid-cols-1", "md:grid-cols-2", "lg:grid-cols-3", "gap-4");
                applyMasonryLayout();
            } else {
                postListContainer.classList.add("grid", "grid-cols-1", "md:grid-cols-2", "gap-4");
                if (!isBothSidebars && gridColumns === 3) {
                    postListContainer.classList.add("lg:grid-cols-3");
                }
                resetMasonryLayout();
            }
        } else {
            postListContainer.classList.add("list-mode");
            postListContainer.classList.add("flex", "flex-col", "gap-4", "md:gap-4");
            postListContainer.classList.remove("grid", "grid-cols-1", "md:grid-cols-2", "lg:grid-cols-3");
            resetMasonryLayout();
        }
    };

    // Case 1: First run (Initialization) - No animation
    if (!currentLayout) {
        applyClasses();
        return;
    }

    // Case 2: Same layout (e.g. Resize) - No animation, just refresh masonry
    if (currentLayout === layout) {
        if (layout === "grid" && masonryEnabled) {
            applyMasonryLayout();
        }
        return;
    }

    // Case 3: Layout Change - Smooth Animation
    // 1. Fade OUT
    postListContainer.classList.add("layout-switching");
    
    // 2. Change Layout after fade out (200ms match CSS)
    setTimeout(() => {
        applyClasses();

        // 3. Fade IN (Short delay to ensure DOM update)
        requestAnimationFrame(() => {
            postListContainer.classList.remove("layout-switching");
        });
    }, 200);
  }

  function resetMasonryLayout() {
    const container = document.getElementById("post-list-container");
    if (!container) return;
    
    container.style.height = "";
    container.style.position = "";
    container.style.display = "";
    
    const items = container.querySelectorAll(".post-card-item");
    items.forEach((item) => {
      // @ts-ignore
      item.style.position = "";
      // @ts-ignore
      item.style.top = "";
      // @ts-ignore
      item.style.left = "";
      // @ts-ignore
      item.style.width = "";
    });
  }

  function applyMasonryLayout() {
    const container = document.getElementById("post-list-container");
    if (!container) return;
    
    const masonryEnabled = container.getAttribute("data-masonry-enabled") === "true";
    if (!masonryEnabled) return;
    
    // 仅在 grid 模式下应用
    if (!container.classList.contains("grid-mode")) return;

    const items = Array.from(container.querySelectorAll(".post-card-item"));
    if (items.length === 0) return;

    // 瀑布流配置
    const gap = 16; // 1rem = 16px
    const isBothSidebars = container.getAttribute("data-both-sidebars") === "true";
    const gridColumns = parseInt(container.getAttribute("data-grid-columns") || "2");
    let colCount = 2;
    if (!isBothSidebars && gridColumns === 3 && window.innerWidth >= 1024) {
        colCount = 3;
    }
    
    // 重置容器样式以允许绝对定位
    container.style.position = "relative";
    container.style.display = "block"; // 覆盖 grid display

    // 使用 offsetWidth 避免 transform: scale 的影响
    const containerWidth = container.offsetWidth;
    const itemWidth = (containerWidth - (colCount - 1) * gap) / colCount;
    
    const colHeights = new Array(colCount).fill(0);
    
    items.forEach((item, index) => {
      const colIndex = index % colCount; // Z字形分布：左右交替
      
      // @ts-ignore
      item.style.position = "absolute";
      // @ts-ignore
      item.style.width = `${itemWidth}px`;
      // @ts-ignore
      item.style.setProperty('height', 'auto', 'important');
      
      // 获取高度，优先使用 offsetHeight 避免 transform 影响
      // @ts-ignore
      const height = item.offsetHeight;
      
      const top = colHeights[colIndex];
      const left = colIndex * (itemWidth + gap);
      
      // @ts-ignore
      item.style.top = `${top}px`;
      // @ts-ignore
      item.style.left = `${left}px`;
      
      colHeights[colIndex] += height + gap;
    });
    
    container.style.height = `${Math.max(...colHeights)}px`;
  }

  // 页面加载时初始化布局
  document.addEventListener("DOMContentLoaded", function () {
    // 延迟一点确保DOM完全加载
    setTimeout(initLayout, 50);
    
    // 监听图片加载以重新计算布局
    const imgs = document.querySelectorAll('#post-list-container img');
    imgs.forEach(img => {
        // @ts-ignore
        if(img.complete) return;
        img.addEventListener('load', () => {
            applyMasonryLayout();
        });
    });
  });

  // 页面显示时也初始化布局（处理页面切换）
  document.addEventListener("visibilitychange", function () {
    if (!document.hidden) {
      setTimeout(initLayout, 100);
    }
  });

  // 监听布局变化事件
  window.addEventListener("layoutChange", function (event) {
    // @ts-ignore
    const newLayout = event.detail.layout;
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;
    
    // 检查屏幕宽度，如果小于1200px则强制使用列表模式
    const screenWidth = window.innerWidth;
    const isSmallScreen = screenWidth < 1200;

    if (isSmallScreen) {
      updatePostListLayout("list");
    } else {
      updatePostListLayout(newLayout);
    }
  });

  // 监听窗口大小变化
  let resizeTimeout: any;
  window.addEventListener("resize", function () {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function () {
      initLayout();
    }, 250);
  });

  // 监听页面导航事件（Astro的客户端路由）
  document.addEventListener("astro:page-load", function () {
    setTimeout(initLayout, 50);
    
    // 监听图片加载
    const imgs = document.querySelectorAll('#post-list-container img');
    imgs.forEach(img => {
        // @ts-ignore
        if(img.complete) return;
        img.addEventListener('load', () => {
            applyMasonryLayout();
        });
    });
  });
  
  document.addEventListener("astro:after-swap", function () {
    setTimeout(initLayout, 50);
  });

  // 立即执行一次（处理页面刷新）
  setTimeout(initLayout, 0);
</script>

<style>
  /* 布局切换动画 */
  #post-list-container {
    /* 限制过渡属性为 opacity 和 transform，避免响应父元素位置变化 */
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* 文章卡片的过渡动画 */
  #post-list-container > :global(*) {
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* 布局切换时的动画效果 */
  #post-list-container {
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
  }
  
  #post-list-container.layout-switching {
    opacity: 0;
    transform: translateY(10px);
  }

  /* 移除特定模式下的子元素动画，避免布局计算冲突 */
  /*
  #post-list-container.layout-switching > :global(*) {
    transform: scale(0.98);
  }

  #post-list-container.list-mode > :global(*) {
    animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }
  */

  /* List Mode Customization */
  #post-list-container.list-mode :global(.post-card-title) {
    font-size: 1.5rem !important;
    line-height: 2rem !important;
  }

  #post-list-container.list-mode :global(.post-card-title::before) {
    top: 2.25rem !important;
    height: 1rem !important;
  }

  /* 列表模式下，有封面的文章，摘要最多显示两行 */
  #post-list-container.list-mode :global(.has-cover .description) {
    display: -webkit-box !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
    -webkit-line-clamp: 2 !important;
    line-clamp: 2 !important;
  }

  /* Grid Mode Customization */
  #post-list-container.grid-mode :global(.post-card-wrapper) {
    flex-direction: column-reverse !important;
  }

  #post-list-container.grid-mode :global(.post-card-image) {
    width: 100% !important;
    position: relative !important;
    top: auto !important;
    right: auto !important;
    bottom: auto !important;
    border-radius: var(--radius-large) var(--radius-large) 0 0 !important;
    /*aspect-ratio: 16/9 !important;*/
  }

  #post-list-container.grid-mode :global(.post-card-content) {
    width: 100% !important;
    padding: 1rem !important;
  }

  #post-list-container.grid-mode :global(.no-cover .post-card-content) {
    padding-right: 4.5rem !important;
  }

  #post-list-container.grid-mode :global(.post-card-title) {
    font-size: 1.125rem !important;
    line-height: 1.75rem !important;
    margin-bottom: 0.5rem !important;
  }

  #post-list-container.grid-mode :global(.post-card-title::before) {
    display: none !important;
  }

  #post-list-container.grid-mode :global(.description) {
    font-size: 0.875rem !important;
    margin-bottom: 0.75rem !important;
    padding-right: 0 !important;
  }
  /* 网格模式下，有封面的文章，摘要最多显示两行 */
  #post-list-container.grid-mode :global(.has-cover .description) {
    display: -webkit-box !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
    -webkit-line-clamp: 3 !important;
    line-clamp: 3 !important;
  }

  #post-list-container.grid-mode :global(.post-meta) {
    margin-bottom: 0.5rem !important;
    gap: 0.5rem !important;
  }

  #post-list-container.grid-mode :global(.post-meta .text-xl) {
    font-size: 1rem !important;
    line-height: 1.25rem !important;
  }

  #post-list-container.grid-mode :global(.meta-icon) {
    width: 1.5rem !important;
    height: 1.5rem !important;
    margin-right: 0.25rem !important;
  }

  #post-list-container.grid-mode :global(.post-meta .text-sm) {
    font-size: 0.75rem !important;
    line-height: 1rem !important;
  }

  #post-list-container.grid-mode :global(.post-meta .pinned-btn) {
    padding: 0.25rem 0.375rem !important;
  }

</style>
</file>

<file path="components/layout/SideBar.astro">
---
import type { MarkdownHeading } from "astro";
import Advertisement from "@/components/widget/Advertisement.astro";
import Announcement from "@/components/widget/Announcement.astro";
import Calendar from "@/components/widget/Calendar.astro";
import Categories from "@/components/widget/Categories.astro";
import Music from "@/components/widget/Music.astro";
import Profile from "@/components/widget/Profile.astro";
import SidebarTOC from "@/components/widget/SidebarTOC.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Tags from "@/components/widget/Tags.astro";
import { sidebarLayoutConfig } from "@/config";
import type {
	MobileBottomComponentConfig,
	WidgetComponentConfig,
	WidgetComponentType,
} from "@/types/config";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
	side?: "left" | "right" | "bottom";
}

// 侧边栏位置常量
const SIDEBAR_SIDE = {
	LEFT: "left",
	RIGHT: "right",
	BOTTOM: "bottom",
} as const;

// 组件位置常量
const COMPONENT_POSITION = {
	TOP: "top",
	STICKY: "sticky",
} as const;

// 动画延迟配置
const ANIMATION_DELAY_UNIT = 50; // ms

// 组件映射表
const componentMap = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	sidebarToc: SidebarTOC,
	advertisement: Advertisement,
	stats: SiteStats,
	calendar: Calendar,
	music: Music,
} satisfies Record<WidgetComponentType, typeof Profile>;

// 获取侧边栏位置
const side = (Astro.props.side ||
	SIDEBAR_SIDE.LEFT) as (typeof SIDEBAR_SIDE)[keyof typeof SIDEBAR_SIDE];
const className = Astro.props.class;

// 根据 side 属性获取对应的组件列表
const getComponents = (): (
	| WidgetComponentConfig
	| MobileBottomComponentConfig
)[] => {
	if (side === SIDEBAR_SIDE.LEFT) {
		return sidebarLayoutConfig.leftComponents;
	}
	if (side === SIDEBAR_SIDE.RIGHT) {
		return sidebarLayoutConfig.rightComponents;
	}
	if (side === SIDEBAR_SIDE.BOTTOM) {
		return sidebarLayoutConfig.mobileBottomComponents;
	}
	return [];
};

// 过滤并排序组件（不再进行 showOnPostPage 过滤，交由客户端处理）
const filterAndSortComponents = (
	components: (WidgetComponentConfig | MobileBottomComponentConfig)[],
) => {
	return components.filter((comp) => comp.enable);
};

// 分离 top 和 sticky 位置的组件（保持原始数组顺序）
const getComponentsByPosition = (
	components: (WidgetComponentConfig | MobileBottomComponentConfig)[],
) => {
	const topComponents = components.filter(
		(c) => "position" in c && c.position === COMPONENT_POSITION.TOP,
	) as WidgetComponentConfig[];
	const stickyComponents = components.filter(
		(c) => "position" in c && c.position === COMPONENT_POSITION.STICKY,
	) as WidgetComponentConfig[];
	return { topComponents, stickyComponents };
};

// 获取动画延迟（硬编码）
const getAnimationDelay = (index: number): string => {
	return `${index * ANIMATION_DELAY_UNIT}ms`;
};

// 判断当前页面是否为文章页面（服务端渲染时确定）
const isPostPage = Astro.url.pathname.includes("/posts/");

// 动态构建组件 props
const getComponentProps = (
	config: WidgetComponentConfig | MobileBottomComponentConfig,
	index: number,
): Record<string, unknown> => {
	const baseProps: Record<string, unknown> = {
		class: "onload-animation",
		style: `animation-delay: ${getAnimationDelay(index)}`,
	};

	// 添加 showOnPostPage 和 showOnNonPostPage 标记class（仅WidgetComponentConfig有这些属性）
	// 同时根据当前页面类型在服务端渲染时设置初始 hidden 状态，避免页面加载时闪烁
	if ("showOnPostPage" in config && config.showOnPostPage === false) {
		baseProps.class = `${baseProps.class} widget-hide-on-post`;
		if (isPostPage) {
			baseProps.class = `${baseProps.class} hidden`;
		}
	}
	if ("showOnNonPostPage" in config && config.showOnNonPostPage === false) {
		baseProps.class = `${baseProps.class} widget-hide-on-non-post`;
		if (!isPostPage) {
			baseProps.class = `${baseProps.class} hidden`;
		}
	}

	// 特殊处理 SidebarTOC 组件
	if (config.type === "sidebarToc") {
		return { ...baseProps, headings: Astro.props.headings || [] };
	}

	// 特殊处理 Advertisement 组件
	if (
		config.type === "advertisement" &&
		"configId" in config &&
		config.configId
	) {
		return { ...baseProps, configId: config.configId };
	}

	return baseProps;
};

// 获取所有需要渲染的组件
const allComponents = getComponents();
const filteredComponents = filterAndSortComponents(allComponents);

// 对于移动端底部组件，直接使用所有组件，不进行position分组
const isMobileBottom = side === SIDEBAR_SIDE.BOTTOM;
const { topComponents, stickyComponents } = !isMobileBottom
	? getComponentsByPosition(filteredComponents)
	: { topComponents: [], stickyComponents: [] };
const bottomComponents = isMobileBottom ? filteredComponents : [];
---

{
	(topComponents.length > 0 || stickyComponents.length > 0 || bottomComponents.length > 0) && (
		<div id={`${side}-sidebar`} class:list={[className, "flex flex-col w-full pt-0"]}>
			{/* Mobile bottom components - 直接渲染所有组件，不分组 */}
			{isMobileBottom ? (
				<div class="flex flex-col w-full gap-4">
					{bottomComponents.map((comp, index) => {
						const Component = componentMap[comp.type];
						if (!Component) return null;
						const props = getComponentProps(comp, index) as any;
						return <Component {...props} />;
					})}
				</div>
			) : (
				<>
					{/* Top components */}
					{topComponents.length > 0 && (
						<div class="flex flex-col w-full gap-4 mb-4">
							{topComponents.map((comp, index) => {
								const Component = componentMap[comp.type];
								if (!Component) return null;
								const props = getComponentProps(comp, index) as any;
								return <Component {...props} />;
							})}
						</div>
					)}

					{/* Sticky components */}
					{stickyComponents.length > 0 && (
						<div
							id={`${side}-sidebar-sticky`}
							class:list={[
								"transition-all duration-700 flex flex-col w-full mt-0",
								"sticky",
								topComponents.length > 0 ? "top-4 gap-4" : "top-0",
							]}
						>
							{stickyComponents.map((comp, index) => {
								const Component = componentMap[comp.type];
								if (!Component) return null;
								const props = getComponentProps(
									comp,
									topComponents.length + index
								) as any;
								return <Component {...props} />;
							})}
						</div>
					)}
				</>
			)}
		</div>
	)
}
</file>

<file path="components/misc/License.astro">
---
import { Icon } from "astro-icon/components";
import { licenseConfig } from "@/config/licenseConfig";
import { profileConfig } from "@/config/profileConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { formatDateToYYYYMMDD } from "@/utils/date-utils";

interface Props {
	title: string;
	id: string;
	pubDate: Date;
	class: string;
	author: string;
	sourceLink: string;
	licenseName: string;
	licenseUrl: string;
}

const { title, pubDate, author, sourceLink, licenseName, licenseUrl } =
	Astro.props;
const className = Astro.props.class;
const profileConf = profileConfig;
const licenseConf = licenseConfig;
const postUrl = sourceLink || decodeURIComponent(Astro.url.toString());
---

<div
  class={`relative transition overflow-hidden bg-(--license-block-bg) py-5 px-6 ${className}`}
>
  <div class="transition font-bold text-black/75 dark:text-white/75">
    {title}
  </div>
  <a href={postUrl} class="link text-(--primary)">
    {postUrl}
  </a>
  <div class="flex gap-6 mt-2">
    <div>
      <div class="transition text-black/30 dark:text-white/30 text-sm">
        {i18n(I18nKey.author)}
      </div>
      <div class="transition text-black/75 dark:text-white/75 line-clamp-2">
        {author || profileConf.name}
      </div>
    </div>
    <div>
      <div class="transition text-black/30 dark:text-white/30 text-sm">
        {i18n(I18nKey.publishedAt)}
      </div>
      <div class="transition text-black/75 dark:text-white/75 line-clamp-2">
        {formatDateToYYYYMMDD(pubDate)}
      </div>
    </div>
    <div>
      <div class="transition text-black/30 dark:text-white/30 text-sm">
        {i18n(I18nKey.license)}
      </div>
      <a
        href={licenseName ? licenseUrl || undefined : licenseConf.url}
        target="_blank"
        class="link text-(--primary) line-clamp-2"
        >{licenseName || licenseConf.name}</a
      >
    </div>
  </div>
  <Icon
    name="fa7-brands:creative-commons"
    class="transition text-[15rem] absolute pointer-events-none right-6 top-1/2 -translate-y-1/2 text-black/5 dark:text-white/5"
  />
</div>
</file>

<file path="components/misc/SharePoster.svelte">
<script lang="ts">
import QRCode from "qrcode";
import { onMount } from "svelte";
import Icon from "@/components/common/Icon.svelte";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";

export let title: string;
export let author: string;
export let description = "";
export let pubDate: string;
export let coverImage: string | null = null;
export let url: string;
export let siteTitle: string;
export let avatar: string | null = null;

let showModal = false;
let posterImage: string | null = null;
let generating = false;
let themeColor = "#558e88"; // Default blue

onMount(() => {
	// Get theme color from CSS variable
	const temp = document.createElement("div");
	temp.style.color = "var(--primary)";
	temp.style.display = "none";
	document.body.appendChild(temp);
	const computedColor = getComputedStyle(temp).color;
	document.body.removeChild(temp);

	if (computedColor) {
		themeColor = computedColor;
	}
});

function loadImage(src: string): Promise<HTMLImageElement | null> {
	return new Promise((resolve) => {
		const img = new Image();
		img.crossOrigin = "anonymous";
		img.onload = () => resolve(img);
		img.onerror = () => {
			if (!src.includes("images.weserv.nl")) {
				const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(src)}&output=png`;
				const proxyImg = new Image();
				proxyImg.crossOrigin = "anonymous";
				proxyImg.onload = () => resolve(proxyImg);
				proxyImg.onerror = () => {
					resolve(null);
				};
				proxyImg.src = proxyUrl;
			} else {
				resolve(null);
			}
		};
		img.src = src;
	});
}

function getLines(
	ctx: CanvasRenderingContext2D,
	text: string,
	maxWidth: number,
): string[] {
	const chars = text.split("");
	const lines: string[] = [];
	let currentLine = "";

	for (let i = 0; i < chars.length; i++) {
		const char = chars[i];
		const width = ctx.measureText(currentLine + char).width;
		if (width < maxWidth) {
			currentLine += char;
		} else {
			lines.push(currentLine);
			currentLine = char;
		}
	}
	if (currentLine) {
		lines.push(currentLine);
	}
	return lines;
}

function drawRoundedRect(
	ctx: CanvasRenderingContext2D,
	x: number,
	y: number,
	width: number,
	height: number,
	radius: number,
) {
	ctx.beginPath();
	ctx.moveTo(x + radius, y);
	ctx.lineTo(x + width - radius, y);
	ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
	ctx.lineTo(x + width, y + height - radius);
	ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
	ctx.lineTo(x + radius, y + height);
	ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
	ctx.lineTo(x, y + radius);
	ctx.quadraticCurveTo(x, y, x + radius, y);
	ctx.closePath();
}

async function generatePoster() {
	showModal = true;
	if (posterImage) return;

	generating = true;
	try {
		const scale = 2;
		const width = 425 * scale;
		const padding = 24 * scale;

		// 1. Prepare resources
		const qrCodeUrl = await QRCode.toDataURL(url, {
			margin: 1,
			width: 100 * scale,
			color: { dark: "#000000", light: "#ffffff" },
		});
		const [qrImg, coverImg, avatarImg] = await Promise.all([
			loadImage(qrCodeUrl),
			coverImage ? loadImage(coverImage) : Promise.resolve(null),
			avatar ? loadImage(avatar) : Promise.resolve(null),
		]);

		// 2. Setup Canvas for measuring
		const canvas = document.createElement("canvas");
		const ctx = canvas.getContext("2d");
		if (!ctx) throw new Error("Canvas context not available");

		canvas.width = width;
		// Initial height estimation, will be adjusted
		canvas.height = 1000 * scale;

		// 3. Layout Calculation
		const contentWidth = width - padding * 2;
		let currentY = 0;

		// Cover
		const coverHeight = (coverImage ? 200 : 120) * scale;
		currentY += coverHeight;
		currentY += padding; // Gap after cover

		// Meta (Date on Cover) - No extra height needed

		// Title
		ctx.font = `700 ${24 * scale}px 'Roboto', sans-serif`;
		const titleLines = getLines(ctx, title, contentWidth);
		const titleLineHeight = 30 * scale;
		const titleHeight = titleLines.length * titleLineHeight;
		currentY += titleHeight;
		currentY += 16 * scale; // Gap

		// Description
		let descHeight = 0;
		if (description) {
			ctx.font = `${14 * scale}px 'Roboto', sans-serif`;
			const descLines = getLines(ctx, description, contentWidth - 16 * scale); // minus border width and gap
			// Limit to 6 lines
			const maxDescLines = 6;
			const displayDescLines = descLines.slice(0, maxDescLines);
			const descLineHeight = 25 * scale; // 1.8 line-height approx
			descHeight = displayDescLines.length * descLineHeight;
			currentY += descHeight;
			// currentY += 24 * scale; // Gap to footer (Removed to reduce whitespace)
		} else {
			currentY += 8 * scale; // Smaller gap if no desc
		}

		// Footer (Author + QR)
		// Footer top border + padding
		currentY += 24 * scale;
		const footerHeight = 64 * scale; // Avatar/QR height
		currentY += footerHeight;
		currentY += padding; // Bottom padding

		// 4. Resize Canvas to fit content
		canvas.height = currentY;

		// 5. Draw Content
		// Fill Background
		ctx.fillStyle = "#ffffff";
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		// Draw Decorative Circles
		ctx.save();
		ctx.globalAlpha = 0.1;
		ctx.fillStyle = themeColor;

		// Top Right Circle
		// CSS: top: -50px, right: -50px, width: 150px, height: 150px
		// Radius = 75px
		// Center X = width + 50 - 75 = width - 25
		// Center Y = -50 + 75 = 25
		ctx.beginPath();
		ctx.arc(width - 25 * scale, 25 * scale, 75 * scale, 0, Math.PI * 2);
		ctx.fill();

		// Bottom Left Circle
		// Adjusted to cover the avatar
		ctx.beginPath();
		ctx.arc(10 * scale, canvas.height - 10 * scale, 50 * scale, 0, Math.PI * 2);
		ctx.fill();
		ctx.restore();

		// Parse Date
		let dateObj: { day: string; month: string; year: string } | null = null;
		try {
			const d = new Date(pubDate);
			if (!Number.isNaN(d.getTime())) {
				dateObj = {
					day: d.getDate().toString().padStart(2, "0"),
					month: (d.getMonth() + 1).toString().padStart(2, "0"),
					year: d.getFullYear().toString(),
				};
			}
		} catch (e) {}

		// Draw Cover
		if (coverImg) {
			// Object-fit: cover implementation
			const imgRatio = coverImg.width / coverImg.height;
			const targetRatio = width / coverHeight;
			let sx: number;
			let sy: number;
			let sWidth: number;
			let sHeight: number;

			if (imgRatio > targetRatio) {
				sHeight = coverImg.height;
				sWidth = sHeight * targetRatio;
				sx = (coverImg.width - sWidth) / 2;
				sy = 0;
			} else {
				sWidth = coverImg.width;
				sHeight = sWidth / targetRatio;
				sx = 0;
				sy = (coverImg.height - sHeight) / 2;
			}
			ctx.drawImage(
				coverImg,
				sx,
				sy,
				sWidth,
				sHeight,
				0,
				0,
				width,
				coverHeight,
			);
		} else {
			ctx.save();
			ctx.fillStyle = themeColor;
			ctx.globalAlpha = 0.2;
			ctx.fillRect(0, 0, width, coverHeight);
			ctx.restore();
		}

		// Draw Date Overlay
		if (dateObj) {
			const dateBoxW = 60 * scale;
			const dateBoxH = 60 * scale;
			const dateBoxX = padding;
			const dateBoxY = coverHeight - dateBoxH;

			// Background (Semi-transparent black)
			ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
			drawRoundedRect(ctx, dateBoxX, dateBoxY, dateBoxW, dateBoxH, 4 * scale);
			ctx.fill();

			// Day
			ctx.fillStyle = "#ffffff";
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";
			ctx.font = `700 ${30 * scale}px 'Roboto', sans-serif`;
			ctx.fillText(dateObj.day, dateBoxX + dateBoxW / 2, dateBoxY + 24 * scale);

			// Line
			ctx.beginPath();
			ctx.strokeStyle = "rgba(255, 255, 255, 0.6)";
			ctx.lineWidth = 1 * scale;
			ctx.moveTo(dateBoxX + 10 * scale, dateBoxY + 42 * scale);
			ctx.lineTo(dateBoxX + dateBoxW - 10 * scale, dateBoxY + 42 * scale);
			ctx.stroke();

			// Year Month
			ctx.font = `${10 * scale}px 'Roboto', sans-serif`;
			ctx.fillText(
				`${dateObj.year} ${dateObj.month}`,
				dateBoxX + dateBoxW / 2,
				dateBoxY + 51 * scale,
			);
		}

		// Reset Y for drawing
		let drawY = coverHeight + padding;

		// Draw Title
		ctx.textBaseline = "top";
		ctx.textAlign = "left";
		ctx.font = `700 ${24 * scale}px 'Roboto', sans-serif`;
		ctx.fillStyle = "#111827";
		titleLines.forEach((line) => {
			ctx.fillText(line, padding, drawY);
			drawY += titleLineHeight;
		});
		drawY += 16 * scale - (titleLineHeight - 24 * scale); // Adjust for line-height diff

		// Draw Description
		if (description) {
			// Draw vertical line
			ctx.fillStyle = "#e5e7eb";
			const descLineH = descHeight; // Approximate
			// Extend the line slightly above and below the text
			drawRoundedRect(
				ctx,
				padding,
				drawY - 8 * scale,
				4 * scale,
				descLineH + 8 * scale,
				2 * scale,
			);
			ctx.fill();

			ctx.font = `${14 * scale}px 'Roboto', sans-serif`;
			ctx.fillStyle = "#4b5563";
			const descLines = getLines(ctx, description, contentWidth - 16 * scale);
			const maxDescLines = 6;

			descLines.slice(0, maxDescLines).forEach((line) => {
				ctx.fillText(line, padding + 16 * scale, drawY);
				drawY += 25 * scale; // line height
			});
			// drawY += 24 * scale; // Removed to reduce whitespace
		} else {
			drawY += 8 * scale;
		}

		// Draw Footer Divider
		drawY += 24 * scale; // Spacing before line
		ctx.beginPath();
		ctx.strokeStyle = "#f3f4f6";
		ctx.lineWidth = 1 * scale;
		ctx.moveTo(padding, drawY);
		ctx.lineTo(width - padding, drawY);
		ctx.stroke();
		drawY += 24 * scale; // Spacing after line

		// Draw Footer Content
		const footerY = drawY;

		// Left: Author
		if (avatarImg) {
			ctx.save();
			const avatarSize = 64 * scale;
			const avatarX = padding;

			// Circle clip
			ctx.beginPath();
			ctx.arc(
				avatarX + avatarSize / 2,
				footerY + avatarSize / 2,
				avatarSize / 2,
				0,
				Math.PI * 2,
			);
			ctx.closePath();
			ctx.clip();

			ctx.drawImage(avatarImg, avatarX, footerY, avatarSize, avatarSize);
			ctx.restore();

			// Border for avatar
			ctx.beginPath();
			ctx.arc(
				avatarX + (64 * scale) / 2,
				footerY + (64 * scale) / 2,
				(64 * scale) / 2,
				0,
				Math.PI * 2,
			);
			ctx.strokeStyle = "#ffffff";
			ctx.lineWidth = 2 * scale;
			ctx.stroke();
		}

		const authorTextX = padding + (avatar ? 64 * scale + 16 * scale : 0);
		const textCenterY = footerY + 32 * scale;

		ctx.fillStyle = "#9ca3af";
		ctx.font = `${12 * scale}px 'Roboto', sans-serif`;
		ctx.fillText(i18n(I18nKey.author), authorTextX, textCenterY - 20 * scale);

		ctx.fillStyle = "#1f2937";
		ctx.font = `700 ${20 * scale}px 'Roboto', sans-serif`;
		ctx.fillText(author, authorTextX, textCenterY + 4 * scale);

		// Right: QR Code
		const qrSize = 64 * scale;
		const qrX = width - padding - qrSize;

		// QR Background/Shadow effect (simplified as border)
		ctx.fillStyle = "#ffffff";
		// Shadow simulation
		ctx.shadowColor = "rgba(0, 0, 0, 0.05)";
		ctx.shadowBlur = 4 * scale;
		ctx.shadowOffsetY = 2 * scale;
		drawRoundedRect(ctx, qrX, footerY, qrSize, qrSize, 4 * scale);
		ctx.fill();
		ctx.shadowColor = "transparent"; // Reset shadow

		// Draw QR
		const qrInnerSize = 56 * scale;
		const qrPadding = (qrSize - qrInnerSize) / 2;
		if (qrImg) {
			ctx.drawImage(
				qrImg,
				qrX + qrPadding,
				footerY + qrPadding,
				qrInnerSize,
				qrInnerSize,
			);
		}

		// Site Info (Left of QR)
		const siteInfoX = qrX - 16 * scale;
		ctx.textAlign = "right";

		ctx.fillStyle = "#9ca3af";
		ctx.font = `${12 * scale}px 'Roboto', sans-serif`;
		ctx.fillText(i18n(I18nKey.scanToRead), siteInfoX, textCenterY - 20 * scale);

		ctx.fillStyle = "#1f2937";
		ctx.font = `700 ${20 * scale}px 'Roboto', sans-serif`;
		ctx.fillText(siteTitle, siteInfoX, textCenterY + 4 * scale);

		// Finalize
		posterImage = canvas.toDataURL("image/png");
		generating = false;
	} catch (error) {
		console.error("Failed to generate poster:", error);
		generating = false;
	}
}

function downloadPoster() {
	if (posterImage) {
		const a = document.createElement("a");
		a.href = posterImage;
		a.download = `poster-${title.replace(/\s+/g, "-")}.png`;
		a.click();
	}
}

function closeModal() {
	showModal = false;
}

let copied = false;
function copyLink() {
	navigator.clipboard.writeText(url);
	copied = true;
	setTimeout(() => {
		copied = false;
	}, 2000);
}

function portal(node: HTMLElement) {
	document.body.appendChild(node);
	return {
		destroy() {
			if (node.parentNode) {
				node.parentNode.removeChild(node);
			}
		},
	};
}
</script>

<!-- Trigger Button -->
<button 
  class="btn-regular rounded-lg h-12 px-6 gap-2 hover:scale-105 active:scale-95 whitespace-nowrap"
  on:click={generatePoster}
  aria-label="Generate Share Poster"
>
  <Icon icon="material-symbols:share" size="md" />
  <span>{i18n(I18nKey.shareArticle)}</span>
</button>



<!-- Modal -->
{#if showModal}
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <!-- svelte-ignore a11y-no-static-element-interactions -->
  <div use:portal class="fixed inset-0 z-9999 flex items-center justify-center bg-black/60 backdrop-blur-xs p-4 transition-opacity" on:click={closeModal}>
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-[440px] w-full max-h-[90vh] overflow-y-auto flex flex-col shadow-2xl transform transition-all" on:click={(e) => e.stopPropagation()}>
      
      <div class="p-6 flex justify-center bg-gray-50 dark:bg-gray-900 min-h-[200px] items-center">
        {#if posterImage}
          <img src={posterImage} alt="Poster" class="max-w-full h-auto shadow-lg rounded-lg" />
        {:else}
           <div class="flex flex-col items-center gap-3">
             <div class="w-8 h-8 border-2 border-gray-200 rounded-full animate-spin" style="border-top-color: {themeColor}"></div>
             <span class="text-sm text-gray-500">{i18n(I18nKey.generatingPoster)}</span>
           </div>
        {/if}
      </div>
      
      <div class="p-4 border-t border-gray-100 dark:border-gray-700 grid grid-cols-2 gap-3">
        <button 
          class="py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 active:scale-[0.98] transition-all flex items-center justify-center gap-2"
          on:click={copyLink}
        >
          {#if copied}
            <Icon icon="material-symbols:check" size="md" />
            <span>{i18n(I18nKey.copied)}</span>
          {:else}
            <Icon icon="material-symbols:link" size="md" />
            <span>{i18n(I18nKey.copyLink)}</span>
          {/if}
        </button>
        <button 
          class="py-3 text-white rounded-xl font-medium active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed hover:brightness-90"
          style="background-color: {themeColor};"
          on:click={downloadPoster}
          disabled={!posterImage}
        >
          <Icon icon="material-symbols:download" size="md" />
          {i18n(I18nKey.savePoster)}
        </button>
      </div>
    </div>
  </div>
{/if}
</file>

<file path="components/pages/AdvancedSearch.svelte">
<script lang="ts">
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { onMount } from "svelte";
import Icon from "@/components/common/Icon.svelte";
import type { SearchResult } from "@/global";
import { url as formatUrl } from "@/utils/url-utils";

// --- Props ---
export let title = i18n(I18nKey.search);
export let description = "";

// --- State ---
let keyword = "";
let results: SearchResult[] = [];
let isSearching = false;
let initialized = false;

// 在客户端获取 URL 参数
const getInitialKeyword = (): string => {
	if (typeof window !== "undefined") {
		const searchParams = new URLSearchParams(window.location.search);
		return searchParams.get("q") || "";
	}
	return "";
};

// --- Mocks for Dev Mode ---
const fakeResult: SearchResult[] = [
	{
		url: formatUrl("/"),
		meta: { title: "Dev Mode Search Result 1" },
		excerpt: "This is a <mark>mock</mark> result for development.",
	},
	{
		url: formatUrl("/"),
		meta: { title: "Dev Mode Search Result 2" },
		excerpt: "Pagefind only works in <mark>production</mark> build.",
	},
];

// --- Core Search Logic ---
const search = async () => {
	if (!initialized || !keyword.trim()) {
		results = [];
		return;
	}
	isSearching = true;

	try {
		if (import.meta.env.PROD && window.pagefind) {
			const response = await window.pagefind.search(keyword);
			const rawResults = await Promise.all(
				response.results.map((item) => item.data()),
			);
			results = rawResults;
		} else if (import.meta.env.DEV) {
			// 开发模式下的模拟结果
			results = fakeResult.filter(
				(item) =>
					item.excerpt.toLowerCase().includes(keyword.toLowerCase()) ||
					item.meta.title.toLowerCase().includes(keyword.toLowerCase()),
			);
		}
	} catch (error) {
		console.error("Search error:", error);
		results = [];
	} finally {
		isSearching = false;
	}
};

// --- Initialization onMount ---
onMount(() => {
	const initialize = async () => {
		initialized = true;

		// 从 URL 获取初始关键词
		const initialKeyword = getInitialKeyword();
		if (initialKeyword) {
			keyword = initialKeyword;
		}

		// 如果有关键词，自动执行搜索
		if (keyword.trim()) {
			await search();
		}
	};

	// 开发环境直接初始化
	if (import.meta.env.DEV) {
		initialize();
	} else {
		// 生产环境等待 Pagefind 加载
		if (window.pagefind) {
			initialize();
		} else {
			document.addEventListener("pagefindready", initialize, {
				once: true,
			});
		}
	}
});

let debounceTimer: NodeJS.Timeout;
const handleInput = () => {
	clearTimeout(debounceTimer);
	debounceTimer = setTimeout(() => {
		search();
	}, 300);
};
</script>

<div class="card-base px-6 py-6 md:px-9 md:py-6 mb-4 rounded-(--radius-large)">
    <!-- Title Section -->
    <div class="mb-4">
        <div class="flex items-center gap-3 mb-3">
            <div class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70">
                <Icon icon="material-symbols:search" class="text-[1.5rem]"></Icon>
            </div>
            <h1 class="text-3xl font-bold text-90">
                {title}
            </h1>
        </div>
        {#if description}
            <p class="text-base text-50 leading-relaxed">
                {description}
            </p>
        {/if}
    </div>

    <!-- Search Bar -->
    <div class="relative flex">
        <div class="relative flex-1">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <Icon icon="material-symbols:search" class="text-2xl text-50" />
            </div>
            <input
                type="text"
                class="block w-full p-4 pl-10 text-sm bg-transparent border border-black/10 dark:border-white/10 rounded-lg focus:ring-2 focus:ring-(--primary) focus:border-(--primary) hover:border-black/20 dark:hover:border-white/20 text-75 placeholder:opacity-50 transition-colors outline-hidden"
                placeholder={i18n(I18nKey.search)}
                bind:value={keyword}
                on:input={handleInput}
            >
        </div>
    </div>
</div>

<div class="grid grid-cols-1 gap-4">
    <!-- Results Area -->
    <div>
        {#if isSearching}
            <div class="flex justify-center py-10">
                <Icon icon="svg-spinners:ring-resize" class="text-4xl text-(--primary)" />
            </div>
        {:else if results.length > 0}
            <div class="space-y-4">
                {#each results as result}
                    <div class="card-base p-6 block rounded-(--radius-large)">
                        <a href={result.url} class="block group">
                            <h5 class="mb-2 text-2xl font-bold tracking-tight text-90 group-hover:text-(--primary) transition-colors">
                                {@html result.meta.title}
                            </h5>
                            <p class="font-normal text-75">
                                {@html result.excerpt}
                            </p>
                        </a>
                    </div>
                {/each}
            </div>
        {:else if keyword}
            <div class="card-base p-10 text-center text-50 rounded-(--radius-large)">
                {i18n(I18nKey.searchNoResults)}
            </div>
        {:else}
             <div class="card-base p-10 text-center text-50 rounded-(--radius-large)">
                {i18n(I18nKey.searchTypeSomething)}
            </div>
        {/if}
    </div>
</div>

<style>
    /* 关键字高亮效果 - 主题色 */
    :global(mark) {
        background: transparent;
        color: var(--primary);
        font-weight: 600;
        padding: 0 0.1em;
    }
</style>
</file>

<file path="components/pages/bangumi/BangumiSection.astro">
---
import ClientPagination from "@/components/common/ClientPagination.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import type { UserSubjectCollection } from "@/types/bangumi";
import Card from "./Card.astro";
import FilterControls from "./FilterControls.astro";

interface Props {
	sectionId: string;
	items: UserSubjectCollection[];
	isActive: boolean;
	itemsPerPage?: number;
}

const { sectionId, items, isActive, itemsPerPage = 12 } = Astro.props;

// 状态映射
const statusMap = {
	1: "wish",
	2: "collect",
	3: "doing",
	4: "on_hold",
	5: "dropped",
};

// Get status filters with counts
const statusCounts = items.reduce(
	(acc, item) => {
		const status = statusMap[item.type as keyof typeof statusMap] || "unknown";
		acc[status] = (acc[status] || 0) + 1;
		return acc;
	},
	{} as Record<string, number>,
);

const isGame = sectionId === "game";
const isBook = sectionId === "book";
const isMusic = sectionId === "music";

const getFilterLabel = (type: "collect" | "doing" | "wish") => {
	if (isGame) {
		switch (type) {
			case "collect":
				return i18n(I18nKey.bangumiFilterGamePlayed);
			case "doing":
				return i18n(I18nKey.bangumiFilterGamePlaying);
			case "wish":
				return i18n(I18nKey.bangumiFilterGameWish);
		}
	}
	if (isBook) {
		switch (type) {
			case "collect":
				return i18n(I18nKey.bangumiFilterBookRead);
			case "doing":
				return i18n(I18nKey.bangumiFilterBookReading);
			case "wish":
				return i18n(I18nKey.bangumiFilterBookWish);
		}
	}
	if (isMusic) {
		switch (type) {
			case "collect":
				return i18n(I18nKey.bangumiFilterMusicListened);
			case "doing":
				return i18n(I18nKey.bangumiFilterMusicListening);
			case "wish":
				return i18n(I18nKey.bangumiFilterMusicWish);
		}
	}
	// Default (Anime/Real)
	switch (type) {
		case "collect":
			return i18n(I18nKey.bangumiFilterWatched);
		case "doing":
			return i18n(I18nKey.bangumiFilterWatching);
		case "wish":
			return i18n(I18nKey.bangumiFilterWish);
	}
};

const filters = [
	{ value: "all", label: i18n(I18nKey.bangumiFilterAll), count: items.length },
	{
		value: "collect",
		label: getFilterLabel("collect"),
		count: statusCounts.collect || 0,
	},
	{
		value: "doing",
		label: getFilterLabel("doing"),
		count: statusCounts.doing || 0,
	},
	{
		value: "wish",
		label: getFilterLabel("wish"),
		count: statusCounts.wish || 0,
	},
	{
		value: "on_hold",
		label: i18n(I18nKey.bangumiFilterOnHold),
		count: statusCounts.on_hold || 0,
	},
	{
		value: "dropped",
		label: i18n(I18nKey.bangumiFilterDropped),
		count: statusCounts.dropped || 0,
	},
].filter((filter) => filter.value === "all" || filter.count > 0);

const defaultFilter = "all"; // 默认显示全部，用户可以通过筛选器选择
---

<div class:list={["bangumi-section", { "hidden": !isActive }]} data-section={sectionId}>
  {items.length > 0 ? (
    <>
      <FilterControls
        filters={filters}
        activeFilter={defaultFilter}
        sectionId={sectionId}
      />

      <div class="grid grid-cols-2 md:grid-cols-3 gap-6 md:gap-8">
        {items.map((item) => (
          <div
            class="bangumi-item"
            data-item-section={sectionId}
            data-item-status={statusMap[item.type as keyof typeof statusMap] || "unknown"}
          >
            <Card item={item} />
          </div>
        ))}
      </div>

      <ClientPagination
        totalItems={items.length}
        itemsPerPage={itemsPerPage}
        currentPage={1}
        sectionId={sectionId}
      />
    </>
  ) : (
    <div class="text-center py-12">
      <h3 class="text-xl font-medium text-gray-600 dark:text-gray-400 mb-2">{i18n(I18nKey.bangumiNoData)}</h3>
      <p class="text-gray-500 dark:text-gray-500">{i18n(I18nKey.bangumiNoDataDescription)}</p>
    </div>
  )}
</div>
</file>

<file path="components/pages/bangumi/Card.astro">
---
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import type { UserSubjectCollection } from "@/types/bangumi";

interface Props {
	item: UserSubjectCollection;
}

const { item } = Astro.props;

const subject_base_url = "https://bgm.tv/subject/";

const getStatusColor = (type: number) => {
	switch (type) {
		case 1:
			return "bg-blue-500";
		case 2:
			return "bg-green-500";
		case 3:
			return "bg-yellow-500";
		case 4:
			return "bg-orange-500";
		case 5:
			return "bg-red-500";
		default:
			return "bg-gray-500";
	}
};

const getStatusText = (type: number) => {
	const subjectType = item.subject.type;
	// 1: Book, 2: Anime, 3: Music, 4: Game, 6: Real

	switch (type) {
		case 1: // Wish
			if (subjectType === 1) return i18n(I18nKey.bangumiStatusBookWish);
			if (subjectType === 3) return i18n(I18nKey.bangumiStatusMusicWish);
			if (subjectType === 4) return i18n(I18nKey.bangumiStatusGameWish);
			return i18n(I18nKey.bangumiStatusWish);
		case 2: // Collect (Played/Watched/Read/Listened)
			if (subjectType === 1) return i18n(I18nKey.bangumiStatusBookRead);
			if (subjectType === 3) return i18n(I18nKey.bangumiStatusMusicListened);
			if (subjectType === 4) return i18n(I18nKey.bangumiStatusGamePlayed);
			return i18n(I18nKey.bangumiStatusWatched);
		case 3: // Doing (Playing/Watching/Reading/Listening)
			if (subjectType === 1) return i18n(I18nKey.bangumiStatusBookReading);
			if (subjectType === 3) return i18n(I18nKey.bangumiStatusMusicListening);
			if (subjectType === 4) return i18n(I18nKey.bangumiStatusGamePlaying);
			return i18n(I18nKey.bangumiStatusWatching);
		case 4:
			return i18n(I18nKey.bangumiStatusOnHold);
		case 5:
			return i18n(I18nKey.bangumiStatusDropped);
		default:
			return i18n(I18nKey.bangumiStatusUnknown);
	}
};

// 获取标签：优先用户标签，否则使用条目标签
const displayTags =
	item.tags && item.tags.length > 0
		? item.tags
		: (item.subject.tags || []).map((t) => t.name).slice(0, 5);
---

<a
  href={`${subject_base_url}${item.subject.id}`}
  target="_blank"
  rel="noopener noreferrer nofollow"
  class="group relative overflow-hidden rounded-xl bg-white dark:bg-gray-800 shadow-lg hover:shadow-2xl transition-all duration-200 hover:scale-105 block"
>
  <div class="aspect-2/3 relative overflow-hidden" >
    {item.subject?.images?.medium ? (
      <img
        src={item.subject.images.medium}
        alt={item.subject.name_cn || item.subject.name}
        class="w-full h-full object-cover pointer-events-none"
        loading="lazy"
      />
    ) : (
      <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
        <div class="text-gray-400 text-4xl">📖</div>
      </div>
    )}

    <!-- Status badge -->
    <div class={`absolute top-2 left-2 px-2 py-1 rounded-full text-xs text-white font-medium ${getStatusColor(item.type)}`}>
      {getStatusText(item.type)}
    </div>
  </div>

  <!-- Info overlay on hover -->
  <div class="absolute inset-x-0 bottom-0 bg-black/80 text-white p-4 transform translate-y-full group-hover:translate-y-0 transition-transform duration-200">
    <h3 class="font-bold text-sm mb-1 line-clamp-2">
      {item.subject.name_cn || item.subject.name}
    </h3>

    {(item.subject.score || item.comment) && (
      <div class="flex items-center justify-between mb-2">
        {item.subject.score && (
          <div class="flex items-center gap-1">
            <div class="text-yellow-400">⭐</div>
            <span class="text-sm">{item.subject.score}</span>
          </div>
        )}

        {item.comment && (
          <div class="relative group/comment">
            <div class="text-sm text-gray-300 cursor-help">💬</div>
            <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover/comment:opacity-100 transition-opacity duration-150 w-32 sm:w-44 xl:w-52 z-10 pointer-events-none">
              {item.comment}
            </div>
          </div>
        )}
      </div>
    )}

    <!-- Tags display -->
    {displayTags && displayTags.length > 0 && (
      <div class="flex flex-wrap gap-1 mt-2">
        {displayTags.slice(0, 5).map((tag: string) => (
          <span class="text-xs px-2 py-0.5 bg-white/20 rounded-full text-white/90">
            {tag}
          </span>
        ))}
        {displayTags.length > 5 && (
          <span class="text-xs px-2 py-0.5 bg-white/20 rounded-full text-white/60">
            +{displayTags.length - 5}
          </span>
        )}
      </div>
    )}
  </div>
</a>
</file>

<file path="components/pages/bangumi/FilterControls.astro">
---
interface Filter {
	value: string;
	label: string;
	count?: number;
}

interface Props {
	filters: Filter[];
	activeFilter: string;
	sectionId: string;
}

const { filters, activeFilter, sectionId } = Astro.props;
---

<div class="flex flex-wrap gap-1.5 mb-4">
  {filters.map((filter) => (
    <button
      class:list={[
        "px-3 py-1 rounded-full text-xs font-medium transition-all duration-200",
        {
          "bg-(--primary) text-white shadow-md": filter.value === activeFilter,
          "bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600": filter.value !== activeFilter
        }
      ]}
      data-filter={filter.value}
      data-section={sectionId}
      type="button"
    >
      {filter.label}
      {filter.count !== undefined && (
        <span class="ml-1">({filter.count})</span>
      )}
    </button>
  ))}
</div>

<script is:inline define:vars={{ sectionId }}>
  function initFilterControls() {
    const filterButtons = document.querySelectorAll(`[data-section="${sectionId}"][data-filter]`);

    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const filter = this.dataset.filter;
        const currentSectionId = this.dataset.section;

        // Update active filter button for this section
        const sectionButtons = document.querySelectorAll(`[data-section="${currentSectionId}"][data-filter]`);
        sectionButtons.forEach(btn => {
          btn.classList.remove('bg-(--primary)', 'text-white', 'shadow-md');
          btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:hover:bg-gray-600');
        });

        this.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:hover:bg-gray-600');
        this.classList.add('bg-(--primary)', 'text-white', 'shadow-md');

        // Filter items
        const items = document.querySelectorAll(`[data-item-section="${currentSectionId}"]`);
        items.forEach(item => {
          const itemStatus = item.dataset.itemStatus;

          if (filter === 'all' || itemStatus === filter) {
            item.classList.remove('hidden');
            item.style.display = 'block';
          } else {
            item.classList.add('hidden');
            item.style.display = 'none';
          }
        });

        // Update pagination
        updatePagination(currentSectionId);
      });
    });
  }

  function updatePagination(sectionId) {
    const visibleItems = document.querySelectorAll(`[data-item-section="${sectionId}"]:not(.hidden)`);
    const pagination = document.querySelector(`[data-pagination-section="${sectionId}"]`);

    if (pagination) {
      // Trigger pagination update
      const event = new CustomEvent('updatePagination', {
        detail: { visibleCount: visibleItems.length }
      });
      pagination.dispatchEvent(event);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilterControls);
  } else {
    initFilterControls();
  }
</script>
</file>

<file path="components/pages/bangumi/TabNav.astro">
---
interface Tab {
	id: string;
	name: string;
	count?: number;
}

interface Props {
	tabs: Tab[];
	activeTab: string;
}

const { tabs, activeTab } = Astro.props;
---

<div class="border-b border-gray-200 dark:border-gray-700 mb-3">
  <nav class="flex space-x-8" aria-label="Tabs">
    {tabs.map((tab) => (
      <button
        class:list={[
          "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200",
          {
            "border-(--primary) text-(--primary)": tab.id === activeTab,
            "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300": tab.id !== activeTab
          }
        ]}
        data-tab={tab.id}
        type="button"
      >
        {tab.name}
        {tab.count !== undefined && (
          <span class="ml-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-0.5 px-2 rounded-full text-xs">
            {tab.count}
          </span>
        )}
      </button>
    ))}
  </nav>
</div>

<script>
  function initTabNavigation() {
    const tabButtons = document.querySelectorAll('[data-tab]');
    const sections = document.querySelectorAll('[data-section]');

    tabButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        const currentButton = event.currentTarget as HTMLButtonElement;
        const targetTab = currentButton.dataset.tab;

        // Update active tab
        tabButtons.forEach(btn => {
          btn.classList.remove('border-(--primary)', 'text-(--primary)');
          btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        });

        currentButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        currentButton.classList.add('border-(--primary)', 'text-(--primary)');

        // Show/hide sections
        sections.forEach(section => {
          const htmlSection = section as HTMLElement;
          if (htmlSection.dataset.section === targetTab) {
            htmlSection.classList.remove('hidden');
          } else {
            htmlSection.classList.add('hidden');
          }
        });
      });
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTabNavigation);
  } else {
    initTabNavigation();
  }
</script>
</file>

<file path="components/README.md">
# 📦 Components 组件目录

Firefly 项目中所有可复用组件的集中管理。组件按照功能和职责进行分类，提供清晰的架构和易于维护的代码组织。

## 📁 目录结构

### 🏗️ layout/ - 页面布局组件

负责整体页面框架和布局结构的组件。

- `CategoryBar.astro` - 分类栏组件
- `ConfigCarrier.astro` - 配置载体组件
- `DropdownMenu.astro` - 下拉菜单组件
- `Footer.astro` - 页脚组件
- `Navbar.astro` - 导航栏组件
- `NavMenuPanel.astro` - 导航菜单面板
- `PostCard.astro` - 文章卡片组件
- `PostMeta.astro` - 文章元数据组件
- `PostPage.astro` - 文章页面布局组件
- `SideBar.astro` - 侧边栏组件

### 🎮 controls/ - 导航和交互控件

页面导航和用户交互功能组件。

**导航控件**
- `BackToHome.astro` - 返回主页按钮
- `BackToTop.astro` - 返回顶部按钮
- `FloatingControls.astro` - 右下角悬浮控件容器
- `FloatingTOC.astro` - 浮动目录组件

**交互组件**
- `ArchivePanel.svelte` - 归档面板组件
- `DisplaySettings.svelte` - 显示设置组件
- `DisplaySettingsIntegrated.svelte` - 集成显示设置组件
- `LayoutSwitchButton.svelte` - 布局切换按钮
- `LightDarkSwitch.svelte` - 主题切换组件
- `Search.svelte` - 搜索功能组件
- `WallpaperSwitch.svelte` - 壁纸模式切换组件

### 🔧 common/ - 公共可复用组件

通用的 UI 组件和工具组件，支持跨项目复用。

**基础 UI 组件**
- `ButtonLink.astro` - 链接按钮
- `ButtonTag.astro` - 标签按钮
- `DropdownItem.astro`/`.svelte` - 下拉选项
- `DropdownPanel.astro`/`.svelte` - 下拉面板容器
- `FloatingButton.astro` - 悬浮按钮基础组件
- `Icon.svelte` - 图标组件（带加载状态和错误处理）
- `WidgetLayout.astro` - 小部件布局容器

**内容和展示组件**
- `CoverImage.astro` - 封面图组件（支持本地图片和随机图API）
- `ImageWrapper.astro` - 图片包装器（支持本地和远程图片）
- `Markdown.astro` - Markdown 内容样式包装器
- `PioMessageBox.astro` - 消息框组件（Live2D/Spine 消息显示）

**分页组件**
- `ClientPagination.astro` - 客户端分页（JavaScript 控制）
- `Pagination.astro` - 静态路由分页（Astro 原生）

### 🧩 widget/ - 小部件

侧边栏中使用的各种功能小部件。

- `Advertisement.astro` - 广告组件
- `Announcement.astro` - 公告组件
- `Calendar.astro` - 日历组件
- `Categories.astro` - 分类组件
- `Live2DWidget.astro` - Live2D 看板娘组件
- `Music.astro` - 音乐播放器小部件
- `Profile.astro` - 个人信息/社交链接小部件
- `SidebarTOC.astro` - 侧边栏目录组件
- `SiteStats.astro` - 站点统计组件
- `SpineModel.astro` - Spine 看板娘组件
- `Tags.astro` - 标签组件

### ✨ features/ - 全局功能特效组件

全局加载的功能增强和特效组件。

**管理器（初始化和管理功能）**
- `FancyboxManager.astro` - Fancybox 图片查看器管理
- `FontManager.astro` - 字体加载和管理
- `KatexManager.astro` - Katex 数学公式渲染管理
- `MusicManager.astro` - 全局音乐播放管理器（单例，管理唯一 audio 元素和播放状态，通过 CustomEvent 同步所有 MusicPlayer 视图实例）

**功能组件**
- `Live2DWidget.astro` - Live2D 看板娘组件
- `MusicPlayer.astro` - 音乐播放器 UI 视图控制器（纯 UI，委托 MusicManager 进行播放控制）
- `SakuraEffect.astro` - 樱花飘落特效
- `SpineModel.astro` - Spine 看板娘组件
- `TypewriterText.astro` - 打字机动画效果

### 📃 pages/ - 页面特定组件

特定页面使用的组件，不用于其他页面。

- `AdvancedSearch.svelte` - 高级搜索组件

**pages/bangumi/** - 番组计划页面组件
- `BangumiSection.astro` - 番组分类展示组件
- `Card.astro` - 番组卡片组件
- `FilterControls.astro` - 筛选控制组件
- `TabNav.astro` - 标签导航组件

### 💬 comment/ - 评论系统组件

第三方评论系统集成组件。

- `index.astro` - 评论主组件
- `Artalk.astro` - Artalk 评论集成
- `Disqus.astro` - Disqus 评论集成
- `Giscus.astro` - Giscus 评论集成（GitHub 讨论）
- `Twikoo.astro` - Twikoo 评论集成
- `Waline.astro` - Waline 评论集成

### 📊 analytics/ - 数据统计组件

网站分析和统计集成组件。

- `GoogleAnalytics.astro` - Google Analytics
- `MicrosoftClarity.astro` - Microsoft Clarity

### 🔧 misc/ - 杂项工具组件

其他辅助和工具类组件。

- `License.astro` - 许可证信息显示
- `SharePoster.svelte` - 分享海报生成

---

## 🗂️ 分类原则

| 分类 | 用途 | 特点 |
|------|------|------|
| **layout/** | 页面布局和结构 | 决定整体页面框架 |
| **controls/** | 导航和交互 | 用户交互功能 |
| **common/** | 通用可复用组件 | 跨多个页面/组件使用 |
| **widget/** | 侧边栏小部件 | 侧边栏特定组件 |
| **features/** | 全局功能特效 | 全局加载的增强功能 |
| **pages/** | 页面特定组件 | 仅在特定页面使用 |
| **comment/** | 评论系统 | 第三方服务集成 |
| **analytics/** | 数据统计 | 分析和统计服务 |
| **misc/** | 工具和辅助 | 其他杂项功能 |
</file>

<file path="components/widget/Advertisement.astro">
---
import { adConfig1, adConfig2 } from "@/config/adConfig";
import type { AdConfig } from "@/types/config";
import { url } from "@/utils/url-utils";

export interface Props {
	class?: string;
	configId?: string;
}

const { class: className = "", configId } = Astro.props as Props;

// 根据configId选择对应的广告配置
const getAdConfig = (id?: string): AdConfig => {
	switch (id) {
		case "ad1":
			return adConfig1;
		case "ad2":
			return adConfig2;
		default:
			return adConfig1; // 默认配置
	}
};

const currentAdConfig = getAdConfig(configId);

// 检查广告是否过期
const isExpired = currentAdConfig.expireDate
	? new Date() > new Date(currentAdConfig.expireDate)
	: false;

// 如果过期则不显示
if (isExpired) {
	return null;
}

// 处理自定义边距
const getPaddingStyle = () => {
	if (!currentAdConfig.padding) return "p-4"; // 默认边距

	if (currentAdConfig.padding.all !== undefined) {
		// 统一边距
		return currentAdConfig.padding.all === "0" ? "p-0" : "";
	}

	// 单独边距
	const { top, right, bottom, left } = currentAdConfig.padding;
	return (
		[
			top !== undefined ? `pt-[${top}]` : "",
			right !== undefined ? `pr-[${right}]` : "",
			bottom !== undefined ? `pb-[${bottom}]` : "",
			left !== undefined ? `pl-[${left}]` : "",
		]
			.filter(Boolean)
			.join(" ") || "p-4"
	);
};

const paddingClass = getPaddingStyle();
---

<div
  class:list={[
    "card-base",
    "advertisement-widget",
    "relative",
    "overflow-hidden",
    className,
  ]}
  data-display-count={currentAdConfig.displayCount}
  data-closable={currentAdConfig.closable}
>
  <!-- 关闭按钮 -->
  {
    currentAdConfig.closable && (
      <button
        class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center rounded-full bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600 text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200 transition-all duration-200 z-10 close-ad-btn"
        title="关闭广告"
        aria-label="关闭广告"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    )
  }

  <!-- 广告内容 -->
  <div class={paddingClass}>
    <!-- 标题 -->
    {
      currentAdConfig.title && (
        <h3 class="text-lg font-bold mb-3 text-center text-neutral-900 dark:text-neutral-50 transition">
          {currentAdConfig.title}
        </h3>
      )
    }

    <!-- 图片 -->
    {
      currentAdConfig.image && (
        <div
          class={
            currentAdConfig.title ||
            currentAdConfig.content ||
            currentAdConfig.link
              ? "mb-3"
              : ""
          }
        >
          {currentAdConfig.image.link ? (
            <a
              href={currentAdConfig.image.link}
              target={currentAdConfig.image.external ? "_blank" : "_self"}
              rel={currentAdConfig.image.external ? "noopener noreferrer" : ""}
              class="block group"
            >
              <img
                src={currentAdConfig.image.src.startsWith('/') ? url(currentAdConfig.image.src) : currentAdConfig.image.src}
                alt={currentAdConfig.image.alt || "广告图片"}
                class={`w-full h-auto transition-transform duration-300 group-hover:scale-105 ${
                  paddingClass === "p-0"
                    ? "rounded-(--radius-large)"
                    : "rounded-lg"
                }`}
                loading="lazy"
              />
            </a>
          ) : (
            <img
              src={currentAdConfig.image.src.startsWith('/') ? url(currentAdConfig.image.src) : currentAdConfig.image.src}
              alt={currentAdConfig.image.alt || "广告图片"}
              class={`w-full h-auto ${
                paddingClass === "p-0"
                  ? "rounded-(--radius-large)"
                  : "rounded-lg"
              }`}
              loading="lazy"
            />
          )}
        </div>
      )
    }

    <!-- 文本内容 -->
    {
      currentAdConfig.content && (
        <p class="text-sm text-center mb-3 leading-relaxed text-neutral-600 dark:text-neutral-300 transition">
          {currentAdConfig.content}
        </p>
      )
    }

    <!-- 链接按钮 -->
    {
      currentAdConfig.link && (
        <div class="text-center">
          <a
            href={currentAdConfig.link.url}
            target={currentAdConfig.link.external ? "_blank" : "_self"}
            rel={currentAdConfig.link.external ? "noopener noreferrer" : ""}
            class="inline-flex items-center gap-2 px-4 py-2 bg-[oklch(0.75_0.14_var(--hue))] hover:bg-[oklch(0.7_0.16_var(--hue))] text-white rounded-lg transition-all duration-200 font-medium text-sm shadow-lg shadow-[oklch(0.75_0.14_var(--hue))]/25 hover:shadow-xl hover:shadow-[oklch(0.75_0.14_var(--hue))]/30 hover:scale-105 transform"
          >
            <span>{currentAdConfig.link.text}</span>
            {currentAdConfig.link.external && (
              <svg
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            )}
          </a>
        </div>
      )
    }
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 清理旧的localStorage关闭状态，确保广告可以重新显示
    localStorage.removeItem("ad-closed");

    const adWidgets = document.querySelectorAll(
      ".advertisement-widget"
    ) as NodeListOf<HTMLElement>;

    adWidgets.forEach((widget) => {
      const closeBtn = widget.querySelector(".close-ad-btn");
      const displayCount = parseInt(
        widget.getAttribute("data-display-count") || "-1"
      );
      const isClosable = widget.getAttribute("data-closable") === "true";

      // 检查显示次数限制
      if (displayCount > 0) {
        const storageKey = "ad-display-count";
        const currentCount = parseInt(localStorage.getItem(storageKey) || "0");

        if (currentCount >= displayCount) {
          widget.style.display = "none";
          return;
        }

        localStorage.setItem(storageKey, (currentCount + 1).toString());
      }

      // 绑定关闭按钮事件（关闭后刷新页面会重新显示）
      if (closeBtn && isClosable) {
        closeBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          // 添加关闭动画
          widget.style.transform = "translateX(100%)";
          widget.style.opacity = "0";
          widget.style.transition = "all 0.3s ease-out";

          setTimeout(() => {
            widget.style.display = "none";
            
          }, 300);
        });
      }
    });
  });
</script>

<style>
  .advertisement-widget {
    /* 完全跟随主题的背景和边框 */
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    border-radius: var(--radius-large);
    color: var(--primary-text-color);
    /* padding由配置控制，不在CSS中设置 */
    transition: all 0.3s ease;

    /* 阴影效果跟随主题 */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);

    /* 深色模式下的特殊处理 */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* 深色模式阴影 */
  :global(.dark) .advertisement-widget {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }

  /* 文字颜色由Tailwind类处理，这里不需要额外的CSS */

  .advertisement-widget:hover {
    /* 浅色模式阴影 */
    box-shadow:
      0 4px 12px rgba(0, 0, 0, 0.08),
      0 0 0 1px var(--line-divider);
    transform: translateY(-2px);
    border-color: oklch(0.75 0.14 var(--hue));
  }

  /* 深色模式特殊效果 */
  :global(.dark) .advertisement-widget:hover {
    box-shadow:
      0 4px 20px rgba(0, 0, 0, 0.3),
      0 0 0 1px oklch(0.75 0.14 var(--hue));
    background: color-mix(
      in srgb,
      var(--card-bg),
      oklch(0.75 0.14 var(--hue)) 5%
    );
  }

  .close-ad-btn {
    opacity: 0;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
  }

  .advertisement-widget:hover .close-ad-btn {
    opacity: 1;
  }

  /* 主题色按钮效果 */
  .advertisement-widget a[class*="bg-[oklch"] {
    background: oklch(0.75 0.14 var(--hue));
    transition: all 0.2s ease;
  }

  .advertisement-widget a[class*="bg-[oklch"]:hover {
    background: oklch(0.7 0.16 var(--hue));
    box-shadow: 0 4px 12px
      color-mix(in srgb, oklch(0.75 0.14 var(--hue)), transparent 70%);
  }

  /* 图片悬停效果 */
  .advertisement-widget img {
    transition: all 0.3s ease;
  }

  .advertisement-widget:hover img {
    filter: brightness(1.05) saturate(1.1);
  }

  :global(.dark) .advertisement-widget:hover img {
    filter: brightness(1.1) saturate(1.15);
  }

  /* 响应式调整 */
  @media (max-width: 768px) {
    .advertisement-widget {
      margin: 0; /* 与其他组件保持一致的边距（由外层布局控制） */
      border-radius: var(--radius-large);
      /* 保持左右边框，避免与其他卡片不一致 */
      backdrop-filter: blur(8px);
    }

    .advertisement-widget:hover {
      transform: none;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.06),
        0 0 0 1px var(--line-divider);
    }

    :global(.dark) .advertisement-widget:hover {
      box-shadow:
        0 2px 12px rgba(0, 0, 0, 0.2),
        0 0 0 1px oklch(0.75 0.14 var(--hue));
    }
  }

  /* 高对比度模式支持 */
  @media (prefers-contrast: high) {
    .advertisement-widget {
      border-width: 2px;
    }

    .advertisement-widget:hover {
      border-color: oklch(0.6 0.2 var(--hue));
    }
  }

  /* 减少动画模式支持 */
  @media (prefers-reduced-motion: reduce) {
    .advertisement-widget,
    .close-ad-btn,
    .advertisement-widget img,
    .advertisement-widget a {
      transition: none;
    }

    .advertisement-widget:hover {
      transform: none;
    }
  }
</style>
</file>

<file path="components/widget/Announcement.astro">
---
import { Icon } from "astro-icon/components";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { announcementConfig } from "@/config/announcementConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

const config = announcementConfig;

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<!-- 组件显示现在由sidebarLayoutConfig统一控制，无需检查config.enable -->
<WidgetLayout
  name={config.title || i18n(I18nKey.announcement)}
  id="announcement"
  class={className}
  style={style}
>
  <div>
    <!-- 公告栏内容 -->
    <div class="text-neutral-600 dark:text-neutral-300 leading-relaxed mb-3">
      {config.content}
    </div>

    <!-- 可选链接和关闭按钮 -->
    <div class="flex items-center justify-between gap-3">
      <div>
        {
          config.link && config.link.enable !== false && (
            <a
              href={config.link.url}
              target={config.link.external ? "_blank" : "_self"}
              rel={config.link.external ? "noopener noreferrer" : undefined}
              class="btn-regular rounded-lg px-3 py-1.5 text-sm font-medium active:scale-95 transition-transform"
            >
              {config.link.text}
            </a>
          )
        }
      </div>

      {
        config.closable && (
          <button
            class="btn-regular rounded-lg h-8 w-8 text-sm hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
            onclick="closeAnnouncement()"
            aria-label={i18n(I18nKey.announcementClose)}
          >
            <Icon name="fa7-solid:xmark" class="text-sm" />
          </button>
        )
      }
    </div>
  </div>
</WidgetLayout>

<script>
  function closeAnnouncement() {
    // 通过data-id属性找到整个widget-layout元素
    const widgetLayout = document.querySelector(
      'widget-layout[data-id="announcement"]'
    ) as HTMLElement | null;
    if (widgetLayout) {
      // 隐藏整个widget-layout元素
      widgetLayout.style.display = "none";
     
    }
  }

  // 使公告栏函数全局可用
  window.closeAnnouncement = closeAnnouncement;
</script>
</file>

<file path="components/widget/Calendar.astro">
---
import { Icon } from "astro-icon/components";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { siteConfig } from "@/config/siteConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { url } from "@/utils/url-utils";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 月份名称（使用 i18n）
const monthNames = [
	i18n(I18nKey.calendarJanuary),
	i18n(I18nKey.calendarFebruary),
	i18n(I18nKey.calendarMarch),
	i18n(I18nKey.calendarApril),
	i18n(I18nKey.calendarMay),
	i18n(I18nKey.calendarJune),
	i18n(I18nKey.calendarJuly),
	i18n(I18nKey.calendarAugust),
	i18n(I18nKey.calendarSeptember),
	i18n(I18nKey.calendarOctober),
	i18n(I18nKey.calendarNovember),
	i18n(I18nKey.calendarDecember),
];

// 星期名称（简写，使用 i18n）
const weekDays = [
	i18n(I18nKey.calendarSunday),
	i18n(I18nKey.calendarMonday),
	i18n(I18nKey.calendarTuesday),
	i18n(I18nKey.calendarWednesday),
	i18n(I18nKey.calendarThursday),
	i18n(I18nKey.calendarFriday),
	i18n(I18nKey.calendarSaturday),
];

// 年份文本
const yearText = i18n(I18nKey.year);

// 获取当前语言
const currentLang = siteConfig.lang || "en";

const calendarDataUrl = url("/api/calendar.json");
const postUrlPrefix = url("/posts/");
---

<WidgetLayout id="calendar-widget" class={className} style={style}>
  <div class="calendar-container">
    <div class="flex justify-between items-center mb-4">
        <button id="prev-month-btn" class="btn-plain rounded-lg w-8 h-8 flex items-center justify-center hover:bg-(--btn-plain-bg-hover) transition-colors" aria-label="Previous Month">
            <Icon name="fa7-solid:chevron-left" class="text-sm" />
        </button>
        <div id="current-month-display" class="text-lg font-bold text-neutral-900 dark:text-neutral-100 cursor-pointer hover:text-(--primary) transition-colors select-none"></div>
        <div class="flex gap-2">
            <button id="reset-month-btn" class="btn-plain rounded-lg w-8 h-8 flex items-center justify-center hover:bg-(--btn-plain-bg-hover) transition-colors" aria-label="Back to Today">
                <Icon name="fa7-solid:arrow-rotate-left" class="text-sm" />
            </button>
            <button id="next-month-btn" class="btn-plain rounded-lg w-8 h-8 flex items-center justify-center hover:bg-(--btn-plain-bg-hover) transition-colors" aria-label="Next Month">
                <Icon name="fa7-solid:chevron-right" class="text-sm" />
            </button>
        </div>
    </div>
    
    <!-- 日历视图容器 -->
    <div id="calendar-view-container">
      <!-- 星期标题 -->
      <div class="weekdays grid grid-cols-7 gap-1 mb-2">
        {weekDays.map(day => (
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium">
            {day}
          </div>
        ))}
      </div>
      
      <!-- 日历格子（由客户端动态生成） -->
      <div class="calendar-grid grid grid-cols-7 gap-1" id="calendar-grid">
        <!-- 将由 JavaScript 填充 -->
      </div>
    </div>

    <!-- 月份选择视图 -->
    <div id="month-view-container" class="hidden grid grid-cols-3 gap-2">
      <!-- 将由 JavaScript 填充 -->
    </div>

    <!-- 年份选择视图 -->
    <div id="year-view-container" class="hidden grid grid-cols-3 gap-2">
      <!-- 将由 JavaScript 填充 -->
    </div>
    
    <!-- 文章列表 -->
    <div id="calendar-posts" class="mt-3">
      <div class="border-t border-neutral-200 dark:border-neutral-700 mb-2" id="calendar-posts-divider" style="display: none;"></div>
      <div class="flex flex-col gap-1 max-h-48 overflow-y-auto custom-scrollbar" id="calendar-posts-list">
        <!-- 将由 JavaScript 填充 -->
      </div>
    </div>
  </div>
</WidgetLayout>

<script is:inline data-swup-ignore-script define:vars={{ monthNames, weekDays, yearText, currentLang, calendarDataUrl, postUrlPrefix }}>
  // State variables
  let displayYear = new Date().getFullYear();
  let displayMonth = new Date().getMonth();
  let currentView = 'day'; // 'day' | 'month' | 'year'
  let postDateMap = {};
  let allPostsData = [];
  let availableYears = [];

  async function fetchData() {
    try {
      // 使用缓存避免 swup 导航时重复请求
      if (window.__calendarCache) {
        allPostsData = window.__calendarCache;
      } else {
        const response = await fetch(calendarDataUrl);
        allPostsData = await response.json();
        window.__calendarCache = allPostsData;
      }
      
      // Reconstruct postDateMap and availableYears
      postDateMap = {};
      const yearsSet = new Set();
      allPostsData.forEach(post => {
        const date = new Date(post.published);
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
        if (!postDateMap[dateKey]) {
          postDateMap[dateKey] = [];
        }
        postDateMap[dateKey].push({ id: post.id, title: post.title, published: post.published });
        yearsSet.add(date.getFullYear());
      });
      
      availableYears = Array.from(yearsSet).sort((a, b) => b - a);
      
      renderCalendar();
    } catch (error) {
      console.error("Failed to fetch calendar data", error);
    }
  }

  // 客户端动态渲染日历
  function renderCalendar() {
    const container = document.getElementById('calendar-view-container');
    const monthContainer = document.getElementById('month-view-container');
    const yearContainer = document.getElementById('year-view-container');
    const postsContainer = document.getElementById('calendar-posts');
    
    // Update visibility
    if (container) container.style.display = currentView === 'day' ? 'block' : 'none';
    if (monthContainer) monthContainer.style.display = currentView === 'month' ? 'grid' : 'none';
    if (yearContainer) yearContainer.style.display = currentView === 'year' ? 'grid' : 'none';
    if (postsContainer) postsContainer.style.display = currentView === 'day' ? 'block' : 'none';

    updateHeader();

    if (currentView === 'day') {
      renderDayView();
    } else if (currentView === 'month') {
      renderMonthView();
    } else if (currentView === 'year') {
      renderYearView();
    }
  }

  function updateHeader() {
    const navDisplay = document.getElementById('current-month-display');
    const resetBtn = document.getElementById('reset-month-btn');
    const prevBtn = document.getElementById('prev-month-btn');
    const nextBtn = document.getElementById('next-month-btn');
    
    if (navDisplay) {
      if (currentView === 'day') {
        if (currentLang.startsWith('zh') || currentLang.startsWith('ja')) {
            navDisplay.textContent = `${displayYear}${yearText}${monthNames[displayMonth]}`;
        } else {
            navDisplay.textContent = `${monthNames[displayMonth]} ${displayYear}`;
        }
      } else if (currentView === 'month') {
        navDisplay.textContent = `${displayYear}${yearText}`;
      } else if (currentView === 'year') {
        navDisplay.textContent = yearText;
      }
    }

    if (resetBtn) {
      const now = new Date();
      const isCurrent = displayYear === now.getFullYear() && displayMonth === now.getMonth();
      resetBtn.style.display = (currentView === 'day' && isCurrent) ? 'none' : 'flex';
    }
    
    // Hide prev/next buttons in year view as we show all years
    if (prevBtn) prevBtn.style.visibility = currentView === 'year' ? 'hidden' : 'visible';
    if (nextBtn) nextBtn.style.visibility = currentView === 'year' ? 'hidden' : 'visible';
  }

  function renderDayView() {
    const now = new Date();
    const currentYear = displayYear;
    const currentMonth = displayMonth;
    const currentDate = now.getDate();
    const isCurrentMonth = currentYear === now.getFullYear() && currentMonth === now.getMonth();
    
    // 获取月份的第一天是星期几
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
    
    // 获取当月天数
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    // 生成日历格子
    const calendarGrid = document.getElementById('calendar-grid');
    if (!calendarGrid) return;
    
    const calendarDays = [];
    
    // 添加空白格子（月初空白）
    for (let i = 0; i < firstDayOfMonth; i++) {
      calendarDays.push({ day: null, hasPost: false, count: 0, dateKey: "" });
    }
    
    // 添加每一天
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const posts = postDateMap[dateKey] || [];
      const count = posts.length;
      calendarDays.push({
        day,
        hasPost: count > 0,
        count,
        dateKey
      });
    }
    
    // 渲染日历格子
    calendarGrid.innerHTML = calendarDays.map(({day, hasPost, count, dateKey}) => {
      const isToday = day === currentDate && isCurrentMonth;
      const classes = [
        "calendar-day aspect-square flex items-center justify-center rounded text-sm relative cursor-pointer"
      ];
      
      if (!day) {
        classes.push("text-neutral-400 dark:text-neutral-600");
      } else if (!hasPost) {
        classes.push("text-neutral-700 dark:text-neutral-300");
      } else {
        classes.push("text-neutral-900 dark:text-neutral-100 font-bold");
      }
      
      if (isToday) {
        classes.push("ring-2 ring-(--primary)");
      }
      
      return `
        <div
          class="${classes.join(' ')}"
          data-date="${dateKey}"
          data-has-post="${hasPost}"
        >
          ${day || ''}
          ${hasPost ? '<span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-(--primary)"></span>' : ''}
          ${hasPost && count > 1 ? `<span class="absolute top-0 right-0 text-[10px] text-(--primary) font-bold">${count}</span>` : ''}
        </div>
      `;
    }).join('');
    
    // 获取当月所有文章
    const currentMonthPosts = allPostsData.filter(post => {
      const date = new Date(post.published);
      return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
    });
    
    // 显示当月文章列表
    showMonthlyPosts(currentMonthPosts);
    
    // 添加点击事件监听
    setupClickHandlers(currentMonthPosts);
  }

  function renderMonthView() {
    const container = document.getElementById('month-view-container');
    if (!container) return;

    // Calculate which months have posts for the currently displayed year
    const monthsWithPosts = new Set();
    allPostsData.forEach(post => {
        const date = new Date(post.published);
        if (date.getFullYear() === displayYear) {
            monthsWithPosts.add(date.getMonth());
        }
    });

    container.innerHTML = monthNames.map((name, index) => {
      const isCurrent = index === displayMonth;
      const hasPost = monthsWithPosts.has(index);
      const classes = [
        "p-2 text-center text-sm rounded cursor-pointer hover:bg-(--btn-plain-bg-hover) transition-colors relative"
      ];
      if (isCurrent) {
        classes.push("text-(--primary) font-bold bg-(--btn-plain-bg-hover)");
      } else {
        classes.push("text-neutral-700 dark:text-neutral-300");
      }
      
      const dotHtml = hasPost ? '<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-(--primary)"></span>' : '';
      
      return `<div class="${classes.join(' ')}" data-month="${index}">${name}${dotHtml}</div>`;
    }).join('');

    container.querySelectorAll('[data-month]').forEach(el => {
      el.addEventListener('click', () => {
        displayMonth = parseInt(el.getAttribute('data-month'));
        currentView = 'day';
        renderCalendar();
      });
    });
  }

  function renderYearView() {
    const container = document.getElementById('year-view-container');
    if (!container) return;

    container.innerHTML = availableYears.map(year => {
      const isCurrent = year === displayYear;
      const classes = [
        "p-2 text-center text-sm rounded cursor-pointer hover:bg-(--btn-plain-bg-hover) transition-colors relative"
      ];
      if (isCurrent) {
        classes.push("text-(--primary) font-bold bg-(--btn-plain-bg-hover)");
      } else {
        classes.push("text-neutral-700 dark:text-neutral-300");
      }
      return `<div class="${classes.join(' ')}" data-year="${year}">${year}<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-(--primary)"></span></div>`;
    }).join('');

    container.querySelectorAll('[data-year]').forEach(el => {
      el.addEventListener('click', () => {
        displayYear = parseInt(el.getAttribute('data-year'));
        currentView = 'month';
        renderCalendar();
      });
    });
  }
  
  // 显示当月所有文章
  function showMonthlyPosts(currentMonthPosts) {
    const postsList = document.getElementById('calendar-posts-list');
    const divider = document.getElementById('calendar-posts-divider');
    
    if (postsList) {
      postsList.innerHTML = currentMonthPosts.map(post => {
        const date = new Date(post.published);
        const dateStr = `${date.getMonth() + 1}-${date.getDate()}`;
        return `
        <a href="${postUrlPrefix}${post.id}/" class="flex justify-between items-center text-sm text-neutral-700 dark:text-neutral-300 hover:text-(--primary) dark:hover:text-(--primary) transition-colors px-2 py-1 rounded hover:bg-(--btn-plain-bg-hover)">
          <span class="truncate">${post.title}</span>
          <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-2 whitespace-nowrap">${dateStr}</span>
        </a>
      `}).join('');
      
      // 显示/隐藏分割线
      if (divider) {
        divider.style.display = currentMonthPosts.length > 0 ? 'block' : 'none';
      }
    }
  }
  
  // 设置日历格子点击事件
  function setupClickHandlers(currentMonthPosts) {
    const calendarDays = document.querySelectorAll('.calendar-day[data-date]');
    const postsList = document.getElementById('calendar-posts-list');
    const divider = document.getElementById('calendar-posts-divider');
    
    let currentSelectedDay = null;
    
    calendarDays.forEach(dayElement => {
      dayElement.addEventListener('click', () => {
        const dateKey = dayElement.getAttribute('data-date');
        const hasPost = dayElement.getAttribute('data-has-post') === 'true';
        
        if (!hasPost || !dateKey) return;
        
        // 切换选中状态
        if (currentSelectedDay === dayElement) {
          // 取消选中，恢复显示当月所有文章
          dayElement.classList.remove('calendar-day-selected');
          currentSelectedDay = null;
          showMonthlyPosts(currentMonthPosts);
          return;
        }
        
        // 移除之前选中的样式
        if (currentSelectedDay) {
          currentSelectedDay.classList.remove('calendar-day-selected');
        }
        
        // 添加选中样式
        dayElement.classList.add('calendar-day-selected');
        currentSelectedDay = dayElement;
        
        // 获取该日期的文章
        const posts = postDateMap[dateKey] || [];
        
        if (posts.length > 0 && postsList) {
          // 渲染文章列表
          postsList.innerHTML = posts.map(post => {
            const date = new Date(post.published);
            const dateStr = `${date.getMonth() + 1}-${date.getDate()}`;
            return `
            <a href="${postUrlPrefix}${post.id}/" class="flex justify-between items-center text-sm text-neutral-700 dark:text-neutral-300 hover:text-(--primary) dark:hover:text-(--primary) transition-colors px-2 py-1 rounded hover:bg-(--btn-plain-bg-hover)">
              <span class="truncate">${post.title}</span>
              <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-2 whitespace-nowrap">${dateStr}</span>
            </a>
          `}).join('');
          
          // 显示分割线
          if (divider) {
            divider.style.display = 'block';
          }
        }
      });
    });
  }

  function changeMonth(delta) {
    if (currentView === 'day') {
      displayMonth += delta;
      if (displayMonth > 11) {
          displayMonth = 0;
          displayYear++;
      } else if (displayMonth < 0) {
          displayMonth = 11;
          displayYear--;
      }
    } else if (currentView === 'month') {
      displayYear += delta;
    }
    renderCalendar();
  }

  function resetToToday() {
      const now = new Date();
      displayYear = now.getFullYear();
      displayMonth = now.getMonth();
      currentView = 'day';
      renderCalendar();
  }

  function initCalendar() {
      // Reset to current date on init
      const now = new Date();
      displayYear = now.getFullYear();
      displayMonth = now.getMonth();
      
      fetchData();
      
      // Bind events
      const prevBtn = document.getElementById('prev-month-btn');
      const nextBtn = document.getElementById('next-month-btn');
      const resetBtn = document.getElementById('reset-month-btn');
      const navDisplay = document.getElementById('current-month-display');
      
      if (prevBtn) prevBtn.onclick = () => changeMonth(-1);
      if (nextBtn) nextBtn.onclick = () => changeMonth(1);
      if (resetBtn) resetBtn.onclick = () => resetToToday();
      
      if (navDisplay) {
        navDisplay.onclick = () => {
          if (currentView === 'day') {
            currentView = 'month';
          } else if (currentView === 'month') {
            currentView = 'year';
          }
          renderCalendar();
        };
      }
  }
  
  // 页面加载时渲染日历
  initCalendar();

  // 页面切换时重新渲染
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(initCalendar, 100);
  });
</script>

<style>
  :global(.calendar-day) {
    transition: all 0.2s ease;
    min-height: 32px;
  }

  :global(.calendar-day[data-has-post="true"]:hover) {
    transform: translateY(-2px);
  }

  /* 自定义选中日期样式 */
  :global(.calendar-day-selected) {
    background-color: var(--btn-regular-bg);
    border-radius: 0.25rem;
  }
</style>
</file>

<file path="components/widget/Categories.astro">
---
import ButtonLink from "@/components/common/ButtonLink.astro";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { sidebarLayoutConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getCategoryList } from "@/utils/content-utils";
import { url } from "@/utils/url-utils";

const categories = await getCategoryList();

const COLLAPSED_HEIGHT = "7.5rem";

// 从配置中获取分类组件的折叠阈值
const categoriesComponent = [
	...sidebarLayoutConfig.leftComponents,
	...sidebarLayoutConfig.rightComponents,
	...sidebarLayoutConfig.mobileBottomComponents,
].find((c) => c.type === "categories");

const collapseThreshold = categoriesComponent?.responsive?.collapseThreshold;
const isCollapsed = collapseThreshold
	? categories.length > collapseThreshold
	: false;

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;

const archivePath = url("/archive/");
---

<WidgetLayout name={i18n(I18nKey.categories)} id="categories" isCollapsed={isCollapsed} collapsedHeight={COLLAPSED_HEIGHT}
                class={className} style={style}
>
    <div id="categories-widget-data" class="hidden" data-archive-path={archivePath}></div>
    {categories.map((c) =>
        <ButtonLink
            url={c.url}
            badge={String(c.count)}
            label={`View all posts in the ${c.name.trim()} category`}
        >
            {c.name.trim()}
        </ButtonLink>
    )}
</WidgetLayout>

<script>
  function updateBannerTitleFromCategory() {
    const data = document.getElementById("categories-widget-data");
    if (!data) return;

    const archivePath = (data.getAttribute("data-archive-path") || "/archive").replace(/\/$/, "");
    const pathname = window.location.pathname.replace(/\/$/, "");
    const isArchive = pathname === archivePath;

    if (!isArchive) return;

    const params = new URLSearchParams(window.location.search);
    const activeCategory = params.get("category") || "";

    if (activeCategory) {
      const bannerTitle = document.querySelector(".banner-page-title-text");
      if (bannerTitle) {
        bannerTitle.textContent = decodeURIComponent(activeCategory);
      }
    }
  }

  updateBannerTitleFromCategory();
  document.addEventListener("astro:page-load", updateBannerTitleFromCategory);
  document.addEventListener("swup:contentReplaced", updateBannerTitleFromCategory);
</script>
</file>

<file path="components/widget/Live2DWidget.astro">
---
import MessageBox from "@/components/common/PioMessageBox.astro";
import type { Live2DModelConfig } from "@/types/config";
import { url } from "@/utils/url-utils";

interface Props {
	config: Live2DModelConfig;
}

const { config } = Astro.props;

// 获取位置和尺寸配置
const position = config.position || {
	corner: "bottom-right" as const,
	offsetX: 20,
	offsetY: 20,
};
const size = config.size || { width: 280, height: 250 };
---

<div
  id="live2d-widget"
  class="live2d-widget"
  style={`
    width: ${size.width}px;
    height: ${size.height}px;
    ${position.corner?.includes("right") ? "right" : "left"}: ${position.offsetX}px;
    ${position.corner?.includes("top") ? "top" : "bottom"}: ${position.offsetY}px;
  `}
>
  <canvas id="live2d-canvas" width={size.width} height={size.height}></canvas>
</div>

<!-- 引入消息框组件 -->
<MessageBox />

<script is:inline define:vars={{ config, modelPathUrl: url(config.model.path), sdkPath: url("/pio/static/live2d-sdk/live2d.min.js") }}>
  let motionGroups = {};
  let hitAreas = {};
  let currentMotionGroup = "idle";
  let currentMotionIndex = 0;

  // Use loadlive2d function from the working project
  function initLive2D() {
    if (!window.loadlive2d) {
      console.error("loadlive2d function not available");
      return;
    }

    if (!config.model || !config.model.path) {
      console.error("No model path configured");
      return;
    }

    const modelPath = modelPathUrl; // 使用重命名后的变量

    // Load model data first to get motion groups and hit areas
    fetch(modelPath)
      .then((response) => response.json())
      .then((data) => {
        motionGroups = data.motions || {};
        hitAreas = data.hit_areas_custom || data.hit_areas || {};

        console.log("Loaded model data:", {
          motionGroups: Object.keys(motionGroups),
          hitAreas: Object.keys(hitAreas),
        });

        // Load the model using loadlive2d
        window.loadlive2d("live2d-canvas", modelPath);

        // Setup interactions after a delay to ensure model is loaded
        setTimeout(() => {
          setupInteractions();
        }, 2000);
      })
      .catch((error) => {
        console.error("Failed to load model data:", error);
      });
  }

  // Setup click interactions and drag functionality
  function setupInteractions() {
    const canvas = document.getElementById("live2d-canvas");
    const container = document.getElementById("live2d-widget");
    if (!canvas || !container) return;

    canvas.addEventListener("click", handleClick);

    // 添加拖拽功能
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let containerStart = { x: 0, y: 0 };

    // 鼠标事件
    container.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return; // 只响应左键
      isDragging = true;
      dragStart = { x: e.clientX, y: e.clientY };

      const rect = container.getBoundingClientRect();
      containerStart = { x: rect.left, y: rect.top };

      container.style.cursor = "grabbing";
      e.preventDefault();
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;

      const deltaX = e.clientX - dragStart.x;
      const deltaY = e.clientY - dragStart.y;

      const newX = containerStart.x + deltaX;
      const newY = containerStart.y + deltaY;

      // 边界检查
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;

      const clampedX = Math.max(0, Math.min(newX, maxX));
      const clampedY = Math.max(0, Math.min(newY, maxY));

      container.style.left = clampedX + "px";
      container.style.right = "auto";
      container.style.top = clampedY + "px";
      container.style.bottom = "auto";
    });

    document.addEventListener("mouseup", () => {
      if (isDragging) {
        isDragging = false;
        container.style.cursor = "grab";
      }
    });

    // 触摸事件（移动端支持）
    container.addEventListener("touchstart", (e) => {
      if (e.touches.length !== 1) return;
      isDragging = true;
      const touch = e.touches[0];
      dragStart = { x: touch.clientX, y: touch.clientY };

      const rect = container.getBoundingClientRect();
      containerStart = { x: rect.left, y: rect.top };

      e.preventDefault();
    });

    document.addEventListener("touchmove", (e) => {
      if (!isDragging || e.touches.length !== 1) return;

      const touch = e.touches[0];
      const deltaX = touch.clientX - dragStart.x;
      const deltaY = touch.clientY - dragStart.y;

      const newX = containerStart.x + deltaX;
      const newY = containerStart.y + deltaY;

      // 边界检查
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;

      const clampedX = Math.max(0, Math.min(newX, maxX));
      const clampedY = Math.max(0, Math.min(newY, maxY));

      container.style.left = clampedX + "px";
      container.style.right = "auto";
      container.style.top = clampedY + "px";
      container.style.bottom = "auto";

      e.preventDefault();
    });

    document.addEventListener("touchend", () => {
      isDragging = false;
    });

    // 设置初始光标样式
    container.style.cursor = "grab";

    // 窗口大小变化时重新检查边界
    window.addEventListener("resize", () => {
      const rect = container.getBoundingClientRect();
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;

      if (rect.left > maxX) {
        container.style.left = maxX + "px";
        container.style.right = "auto";
      }
      if (rect.top > maxY) {
        container.style.top = maxY + "px";
        container.style.bottom = "auto";
      }
    });

    console.log("Live2D interactions and drag functionality setup complete");
  }

  // Handle click events
  function handleClick(event) {
    if (!motionGroups || Object.keys(motionGroups).length === 0) {
      console.log("No motion groups available");
      return;
    }

    const rect = event.target.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    // Convert to normalized coordinates
    const normalizedX = (x / rect.width) * 2 - 1;
    const normalizedY = -((y / rect.height) * 2 - 1);

    console.log("Click at:", { x: normalizedX, y: normalizedY });

    // Determine which motion to play based on hit areas
    let motionGroup = "tap_body"; // default

    // Check head area
    if (hitAreas.head_x && hitAreas.head_y) {
      const [headXMin, headXMax] = hitAreas.head_x;
      const [headYMin, headYMax] = hitAreas.head_y;

      if (
        normalizedX >= headXMin &&
        normalizedX <= headXMax &&
        normalizedY >= headYMin &&
        normalizedY <= headYMax
      ) {
        motionGroup = "flick_head";
        console.log("Head area clicked - playing flick_head motion");
      }
    }

    // Check body area (if not head)
    if (motionGroup === "tap_body" && hitAreas.body_x && hitAreas.body_y) {
      const [bodyXMin, bodyXMax] = hitAreas.body_x;
      const [bodyYMin, bodyYMax] = hitAreas.body_y;

      if (
        normalizedX >= bodyXMin &&
        normalizedX <= bodyXMax &&
        normalizedY >= bodyYMin &&
        normalizedY <= bodyYMax
      ) {
        console.log("Body area clicked - playing tap_body motion");
      }
    }

    // Play motion
    playMotion(motionGroup);

    // Show message
    showMessage();
  }

  // 消息框功能已移至公共组件 MessageBox.astro

  // Show random message using the common MessageBox component
  function showMessage() {
    const messages = config.interactive?.clickMessages || [
      "你好！伊利雅~",
      "有什么需要帮助的吗？",
      "今天天气真不错呢！",
      "要不要一起玩游戏？",
      "记得按时休息哦！",
    ];

    const randomMessage = messages[Math.floor(Math.random() * messages.length)];

    // 使用公共消息框组件
    if (window.showModelMessage) {
      window.showModelMessage(randomMessage, {
        containerId: "live2d-widget",
        displayTime: config.interactive?.messageDisplayTime || 3000
      });
    }
  }

  // Play motion from a specific group
  function playMotion(groupName) {
    if (!motionGroups[groupName] || motionGroups[groupName].length === 0) {
      console.log(`No motions available for group: ${groupName}`);
      // Fallback to any available motion group
      const availableGroups = Object.keys(motionGroups).filter(
        (key) => motionGroups[key].length > 0
      );
      if (availableGroups.length > 0) {
        groupName = availableGroups[0];
        console.log(`Using fallback group: ${groupName}`);
      } else {
        return;
      }
    }

    const motions = motionGroups[groupName];
    let motionIndex;

    if (groupName === currentMotionGroup) {
      // Cycle through motions in the same group
      currentMotionIndex = (currentMotionIndex + 1) % motions.length;
      motionIndex = currentMotionIndex;
    } else {
      // Random motion from new group
      motionIndex = Math.floor(Math.random() * motions.length);
      currentMotionIndex = motionIndex;
    }

    currentMotionGroup = groupName;

    console.log(`Playing motion ${motionIndex} from group ${groupName}`);

    // Trigger motion change by reloading model with different parameters
    // This is a workaround since we can't directly control motions in loadlive2d
    const canvas = document.getElementById("live2d-canvas");
    if (canvas && window.loadlive2d) {
      // Add motion info to canvas data for potential future use
      canvas.dataset.currentMotionGroup = groupName;
      canvas.dataset.currentMotionIndex = motionIndex;

      // Trigger a visual feedback
      canvas.style.transform = "scale(1.05)";
      setTimeout(() => {
        canvas.style.transform = "scale(1)";
      }, 150);
    }
  }

  // Load Live2D and initialize
  function loadLive2DSDK() {
    // 检查移动端显示设置，如果隐藏则不加载运行时
    if (
      config.responsive?.hideOnMobile &&
      window.innerWidth <= (config.responsive.mobileBreakpoint || 768)
    ) {
      console.log("📱 Mobile device detected, skipping Live2D model initialization");
      const widget = document.getElementById("live2d-widget");
      if (widget) widget.style.display = "none";
      return;
    }

    // Check if Live2D SDK is already loaded
    if (window.loadlive2d) {
      initLive2D();
      return;
    }

    // Load Live2D SDK
    const script = document.createElement("script");
    script.src = sdkPath;
    script.onload = () => {
      // Wait a bit for the SDK to initialize
      setTimeout(() => {
        if (window.loadlive2d) {
          initLive2D();
        } else {
          console.error("loadlive2d function not found after loading SDK");
        }
      }, 100);
    };
    script.onerror = () => {
      console.error("Failed to load Live2D SDK");
    };
    document.head.appendChild(script);
  }

  // Handle responsive display
  function handleResponsive() {
    const widget = document.getElementById("live2d-widget");
    if (!widget) return;

    const responsive = config.responsive;
    if (responsive?.hideOnMobile) {
      const breakpoint = responsive.mobileBreakpoint || 768;
      if (window.innerWidth <= breakpoint) {
        widget.style.display = "none";
      } else {
        widget.style.display = "block";
      }
    }
  }

  // Initialize when ready (only once)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      // 检查是否已经初始化
      if (!window.live2dModelInitialized) {
        loadLive2DSDK();
        window.live2dModelInitialized = true;
      }
      handleResponsive();
    });
  } else {
    // 检查是否已经初始化
    if (!window.live2dModelInitialized) {
      loadLive2DSDK();
      window.live2dModelInitialized = true;
    }
    handleResponsive();
  }

  // Handle window resize for responsive behavior
  window.addEventListener("resize", handleResponsive);

  // 监听 Swup 页面切换事件（如果使用了 Swup）
  if (typeof window.swup !== "undefined" && window.swup.hooks) {
    window.swup.hooks.on("content:replace", () => {
      // 只更新响应式显示，不重新创建模型
      setTimeout(() => {
        handleResponsive();
      }, 100);
    });
  } else {
    // 如果 Swup 还未加载，监听启用事件
    document.addEventListener("swup:enable", () => {
      if (window.swup && window.swup.hooks) {
        window.swup.hooks.on("content:replace", () => {
          setTimeout(() => {
            handleResponsive();
          }, 100);
        });
      }
    });
  }
</script>

<style>
  .live2d-widget {
    position: fixed;
    z-index: 999;
    pointer-events: auto; /* 启用指针事件以支持拖拽 */
    cursor: grab; /* 默认显示拖拽光标 */
  }

  #live2d-canvas {
    pointer-events: auto;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    height: 100%;
  }

  .live2d-widget:hover #live2d-canvas {
    opacity: 1;
  }

  /* 拖拽时的光标样式 */
  .live2d-widget:active {
    cursor: grabbing;
  }
</style>
</file>

<file path="components/widget/Music.astro">
---
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import MusicPlayer from "@/components/features/MusicPlayer.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

interface Props {
	class?: string;
	style?: string;
}
const { class: className, style } = Astro.props;

const widgetId = `music-widget-${Math.random().toString(36).substring(2, 9)}`;
---

<WidgetLayout id={`${widgetId}-layout`} class={className} style={style} name={i18n(I18nKey.music)}>
    <MusicPlayer id={widgetId} />
</WidgetLayout>
</file>

<file path="components/widget/Profile.astro">
---
import { Icon } from "astro-icon/components";
import ImageWrapper from "@/components/common/ImageWrapper.astro";
import { profileConfig } from "@/config/profileConfig";
import { url } from "@/utils/url-utils";
---

<div class="card-base p-3">
  <a
    aria-label="Go to About Page"
    href={url("/about/")}
    class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3
       max-w-48 lg:max-w-none overflow-hidden rounded-xl active:scale-95"
  >
    <div
      class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50
        w-full h-full z-50 flex items-center justify-center"
    >
      <Icon
        name="fa7-regular:address-card"
        class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl"
      />
    </div>
    <ImageWrapper
      src={profileConfig.avatar || ""}
      alt="Profile Image of the Author"
      class="mx-auto lg:w-full h-full lg:mt-0"
      loading="eager"
      fetchpriority="high"
      widths={[350]}
      sizes="350px"
    />
  </a>
  <div class="px-2">
    <div
      class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition"
    >
      {profileConfig.name}
    </div>
    <div
      class="h-1 w-5 bg-(--primary) mx-auto rounded-full mb-2 transition"
    >
    </div>
    <div class="text-center text-neutral-400 mb-2.5 transition">
      {profileConfig.bio}
    </div>
        <div class="flex flex-wrap gap-2 justify-center mb-1">
            {profileConfig.links.length > 1 && profileConfig.links.map(item =>
                    {
                    const showName = item.showName;
                    const className = showName 
                        ? "btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95" 
                        : "btn-regular rounded-lg h-10 w-10 active:scale-90";

                    if (item.url.startsWith("mailto:")) {
                        const encodedEmail = Buffer.from(item.url.replace("mailto:", "")).toString("base64");
                        return <a rel="me" aria-label={item.name} href="#" data-encoded-email={encodedEmail} onclick={`
                                            (function() {
                                                const encodedEmail = this.getAttribute('data-encoded-email');
                                                const decodedEmail = atob(encodedEmail);
                                                this.href = 'mailto:' + decodedEmail;
                                                this.removeAttribute('data-encoded-email');
                                                this.removeAttribute('onclick');
                                                this.click();
                                                return false;
                                            }).call(this);
                                        `.replace(/\s+/g, " ").trim()
                                    },
                                    class={className}>
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {showName && item.name}
                        </a>
                    } else {
                        return <a rel="me" aria-label={item.name} href={item.url} target="_blank" class={className}>
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {showName && item.name}
                        </a>
                    }
                    }
            )}
            {profileConfig.links.length == 1 && (function(item){
                if (item.url.startsWith("mailto:")) {
                        const encodedEmail = Buffer.from(item.url.replace("mailto:", "")).toString("base64");
                        return <a rel="me" aria-label={item.name} href="#" data-encoded-email={encodedEmail} onclick={`
                                            (function() {
                                                const encodedEmail = this.getAttribute('data-encoded-email');
                                                const decodedEmail = atob(encodedEmail);
                                                this.href = 'mailto:' + decodedEmail;
                                                this.removeAttribute('data-encoded-email');
                                                this.removeAttribute('onclick');
                                                this.click();
                                                return false;
                                            }).call(this);
                                        `.replace(/\s+/g, " ").trim()
                                    },
                                    class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {item.name}
                        </a>
                    } else {
                        return <a rel="me" aria-label={item.name} href={item.url} target="_blank"
                                            class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
                                <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                                {item.name}
                            </a>
                    }
            })(profileConfig.links[0])}
        </div>
  </div>
</div>
</file>

<file path="components/widget/SidebarTOC.astro">
---
import type { MarkdownHeading } from "astro";
import "@/styles/toc.css";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

interface Props {
	headings: MarkdownHeading[];
	class?: string;
	style?: string;
}

const { headings: _headings = [], class: className, style } = Astro.props;
---

<WidgetLayout 
  name={i18n(I18nKey.tableOfContents)} 
  id="sidebar-toc"
  class={className}
  style={style}
>
  <div class="toc-scroll-container custom-scrollbar">
    <div
      class="toc-content"
      id="sidebar-toc-content"
    >
      <!-- TOC内容将由JavaScript动态生成 -->
    </div>
  </div>
</WidgetLayout>

<style lang="stylus">
/* SidebarTOC 特定样式 */
.toc-scroll-container
	max-height: calc(100vh - 20rem)
</style>

<script>
  import { TOCManager } from "@/utils/tocUtils";

  if (typeof window.SidebarTOC === "undefined") {
    window.SidebarTOC = {
      manager: null
    };
  }

  async function initSidebarTOC() {
    const tocContent = document.getElementById("sidebar-toc-content");
    if (!tocContent) return;


    try {
      // 清理旧实例
      if (window.SidebarTOC.manager) {
        window.SidebarTOC.manager.cleanup();
      }

      // 创建新实例
      window.SidebarTOC.manager = new TOCManager({
        contentId: "sidebar-toc-content",
        indicatorId: "sidebar-active-indicator",
        maxLevel: 3,
        scrollOffset: 80,
      });

      // 初始化
      window.SidebarTOC.manager.init();
    } catch (error) {
      console.error("Failed to load TOCManager for SidebarTOC:", error);
    }
  }

  // 初始化
  // 确保 DOM 准备好后再执行
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSidebarTOC);
  } else {
    initSidebarTOC();
  }

  // 页面切换时重新初始化
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(initSidebarTOC, 100);
  });
  
  // Astro 页面切换事件
  document.addEventListener("astro:page-load", () => {
    setTimeout(initSidebarTOC, 100);
  });
  
  // 浏览器导航事件
  window.addEventListener("popstate", () => {
    setTimeout(initSidebarTOC, 200);
  });
  
  // 监听 hashchange（但排除 TOC 内部导航）
  window.addEventListener("hashchange", () => {
    if (!window.tocInternalNavigation) {
      setTimeout(initSidebarTOC, 100);
    }
    window.tocInternalNavigation = false;
  });
</script>
</file>

<file path="components/widget/SiteStats.astro">
---
import { Icon } from "astro-icon/components";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "@/utils/content-utils";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		// 移除代码块和内联代码后计算字数
		let text = post.body
			.replace(/```[\s\S]*?```/g, "") // 移除代码块
			.replace(/`[^`]*`/g, "") // 移除内联代码
			.replace(/\s+/g, " ") // 合并空白
			.trim();

		// 分别计算中文字符和英文字符
		const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
		const englishChars = text.match(/[a-zA-Z]/g) || [];

		totalWords += chineseChars.length + englishChars.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（用于客户端计算）
const latestPost = posts.reduce((latest, post) => {
	if (!latest) return post;
	return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

const todayText = i18n(I18nKey.today);

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
		dynamic: true,
		id: "last-update",
	},
];
---

<WidgetLayout name={i18n(I18nKey.siteStats)} id="site-stats" class={className} style={style}>
  <div class="flex flex-col gap-2">
    {stats.map((stat) => (
      <div class="flex items-center justify-between px-3 py-1.5">
        <div class="flex items-center gap-2.5">
          <div class="text-(--primary) text-xl">
            <Icon name={stat.icon} />
          </div>
          <span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm">
            {stat.label}
          </span>
        </div>
        <div class="flex items-center">
          <span 
            class="text-base font-bold text-neutral-900 dark:text-neutral-100"
            data-stat-id={stat.id}
          >
            {stat.formatted ? formatNumber(stat.value) : stat.value}
          </span>
          {stat.suffix && (
            <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
              {stat.suffix}
            </span>
          )}
        </div>
      </div>
    ))}
  </div>
</WidgetLayout>

<script is:inline define:vars={{ siteStartDate, lastPostDate, todayText }}>
  function updateDynamicStats() {
    const today = new Date();

    // 更新运行天数
    const startDate = new Date(siteStartDate);
    const diffTime = Math.abs(today.getTime() - startDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    const runningDaysElements = document.querySelectorAll('[data-stat-id="running-days"]');
    runningDaysElements.forEach((element) => {
      element.textContent = diffDays.toString();
    });

    // 更新最后活动时间
    if (lastPostDate) {
      const lastPost = new Date(lastPostDate);
      const timeSinceLastPost = Math.abs(today.getTime() - lastPost.getTime());
      const daysSinceLastUpdate = Math.floor(timeSinceLastPost / (1000 * 60 * 60 * 24));

      const lastUpdateElements = document.querySelectorAll('[data-stat-id="last-update"]');
      lastUpdateElements.forEach((element) => {
        if (daysSinceLastUpdate === 0) {
          element.textContent = todayText;
          if (element.nextElementSibling) {
            element.nextElementSibling.style.display = 'none';
          }
        } else {
          element.textContent = daysSinceLastUpdate.toString();
          if (element.nextElementSibling) {
            element.nextElementSibling.style.display = '';
          }
        }
      });
    }
  }

  // 页面加载时更新
  updateDynamicStats();

  // 页面切换时重新更新
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(updateDynamicStats, 100);
  });
</script>
</file>

<file path="components/widget/SpineModel.astro">
---
import MessageBox from "@/components/common/PioMessageBox.astro";
import { spineModelConfig } from "@/config/pioConfig";
import { url } from "@/utils/url-utils";
---

<!-- Spine Web Player CSS 将在 script 中动态加载 -->{
  spineModelConfig.enable && (
    <div
      id="spine-model-container"
      style={`
      position: fixed;
      ${spineModelConfig.position.corner.includes("right") ? "right" : "left"}: ${spineModelConfig.position.offsetX}px;
      ${spineModelConfig.position.corner.includes("top") ? "top" : "bottom"}: ${spineModelConfig.position.offsetY}px;
      width: ${spineModelConfig.size.width}px;
      height: ${spineModelConfig.size.height}px;
      pointer-events: auto;
      z-index: 1000;
    `}
    >
      <div id="spine-player-container" style="width: 100%; height: 100%;" />
      <div id="spine-error" style="display: none;" />
    </div>
  )
}

<!-- 引入消息框组件 -->
<MessageBox />

<script is:inline define:vars={{ spineModelConfig, modelPath: url(spineModelConfig.model.path), atlasPath: url(spineModelConfig.model.path.replace(".json", ".atlas")), cssPath: url("/pio/static/spine-player.min.css"), jsPath: url("/pio/static/spine-player.min.js") }}>
  // 动态加载 Spine CSS（带本地备用）
  function loadSpineCSS() {
    if (!spineModelConfig.enable) return;

    // 检查是否已经加载
    const existingLink = document.querySelector('link[href*="spine-player"]');
    if (existingLink) return;

    // 首先尝试加载 CDN CSS
    const cdnLink = document.createElement("link");
    cdnLink.rel = "stylesheet";
    cdnLink.href =
      "https://unpkg.com/@esotericsoftware/spine-player@4.2.*/dist/spine-player.min.css";

    // 监听加载失败事件，自动回退到本地文件
    cdnLink.onerror = function () {
      console.warn("⚠️ Spine CSS CDN failed, trying local fallback...");

      // 移除失败的 CDN link
      if (cdnLink.parentNode) {
        cdnLink.parentNode.removeChild(cdnLink);
      }

      // 创建本地备用 CSS link
      const localLink = document.createElement("link");
      localLink.rel = "stylesheet";
      localLink.href = cssPath;
      localLink.onerror = function () {
        console.error("❌ Failed to load Spine CSS");
      };

      document.head.appendChild(localLink);
    };

    document.head.appendChild(cdnLink);
  }

  // 消息框功能已移至公共组件 MessageBox.astro
  let isClickProcessing = false; // 防止重复点击的标志
  let lastClickTime = 0; // 记录最后一次点击时间

  // 全局变量，防止重复初始化
  window.spineModelInitialized = window.spineModelInitialized || false;
  window.spinePlayerInstance = window.spinePlayerInstance || null;

  // 消息显示函数 - 使用公共消息框组件
  function showMessage(message) {
    // 使用公共消息框组件
    if (window.showModelMessage) {
      window.showModelMessage(message, {
        containerId: "spine-model-container",
        displayTime: spineModelConfig.interactive.messageDisplayTime || 3000
      });
    }
  }

  // 更新响应式显示
  function updateResponsiveDisplay() {
    if (!spineModelConfig.enable) return;

    const container = document.getElementById("spine-model-container");
    if (!container) return;

    // 检查移动端显示设置
    if (
      spineModelConfig.responsive.hideOnMobile &&
      window.innerWidth <= spineModelConfig.responsive.mobileBreakpoint
    ) {
      container.style.display = "none";
    } else {
      container.style.display = "block";
    }
  }

  // 清理函数
  function cleanupSpineModel() {
    console.log("🧹 Cleaning up existing Spine model...");

    // 清理消息显示（使用公共组件）
    if (window.clearModelMessage) {
      window.clearModelMessage();
    }

    // 清理现有的播放器实例
    if (window.spinePlayerInstance) {
      try {
        if (window.spinePlayerInstance.dispose) {
          window.spinePlayerInstance.dispose();
        }
      } catch (e) {
        console.warn("Error disposing spine player:", e);
      }
      window.spinePlayerInstance = null;
    }

    // 清理容器内容
    const playerContainer = document.getElementById("spine-player-container");
    if (playerContainer) {
      playerContainer.innerHTML = "";
    }

    // 重置初始化标志
    window.spineModelInitialized = false;
  }

  async function initSpineModel() {
    if (!spineModelConfig.enable) return;

    // 检查移动端显示设置，如果隐藏则不加载运行时
    if (
      spineModelConfig.responsive.hideOnMobile &&
      window.innerWidth <= spineModelConfig.responsive.mobileBreakpoint
    ) {
      console.log("📱 Mobile device detected, skipping Spine model initialization");
      const container = document.getElementById("spine-model-container");
      if (container) container.style.display = "none";
      return;
    }

    // 检查是否已经初始化
    if (window.spineModelInitialized) {
      console.log("⏭️ Spine model already initialized, skipping...");
      return;
    }

    console.log("🎯 Initializing Spine Model...");

    // 先清理可能存在的旧实例
    cleanupSpineModel();

    // 首先加载 CSS
    loadSpineCSS();

    // 加载 Spine Web Player 运行时
    const loadSpineRuntime = () => {
      return new Promise((resolve, reject) => {
        if (typeof window.spine !== "undefined") {
          console.log("✅ Spine runtime already loaded");
          resolve();
          return;
        }

        console.log("📦 Loading Spine runtime...");
        const script = document.createElement("script");
        script.src =
          "https://unpkg.com/@esotericsoftware/spine-player@4.2.*/dist/iife/spine-player.min.js";
        script.onload = () => {
          console.log("✅ Spine runtime loaded from CDN");
          resolve();
        };
        script.onerror = (_error) => {
          console.warn("⚠️ CDN failed, trying local fallback...");

          // 尝试本地回退
          const fallbackScript = document.createElement("script");
          fallbackScript.src = jsPath;
          fallbackScript.onload = () => {
            console.log("✅ Spine runtime loaded from local fallback");
            resolve();
          };
          fallbackScript.onerror = () => {
            reject(new Error("Failed to load Spine runtime"));
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      });
    };

    // 等待 Spine 库加载
    const waitForSpine = () => {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;

        const check = () => {
          attempts++;
          if (typeof window.spine !== "undefined" && window.spine.SpinePlayer) {
            console.log("✅ Spine runtime loaded");
            resolve();
          } else if (attempts >= maxAttempts) {
            reject(new Error("Spine runtime loading timeout"));
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });
    };

    try {
      // 首先加载 Spine 运行时
      await loadSpineRuntime();

      // 然后等待 Spine 对象可用
      await waitForSpine();

      // 标记为已初始化
      window.spineModelInitialized = true;

      // 创建 SpinePlayer
      new window.spine.SpinePlayer("spine-player-container", {
        skeleton: modelPath,
        atlas: atlasPath,
        animation: "idle",
        backgroundColor: "#00000000", // 透明背景
        showControls: false, // 隐藏控件
        alpha: true,
        premultipliedAlpha: false,
        success: (player) => {
          console.log("🎉 Spine model loaded successfully!");

          // 保存播放器实例引用
          window.spinePlayerInstance = player;

          // 初始化完成后设置默认姿态
          setTimeout(() => {
            if (player.skeleton) {
              try {
                player.skeleton.updateWorldTransform();
                player.skeleton.setToSetupPose();
              } catch (e) {
                console.warn("Error positioning skeleton:", e);
              }
            }
          }, 500);

          // 设置交互功能
          if (spineModelConfig.interactive.enabled) {
            const canvas = document.querySelector(
              "#spine-player-container canvas"
            );
            if (canvas) {
              canvas.addEventListener("click", () => {
                // 防抖处理：防止重复点击
                const currentTime = Date.now();
                if (isClickProcessing || currentTime - lastClickTime < 500) {
                  return; // 500ms 内重复点击忽略
                }

                isClickProcessing = true;
                lastClickTime = currentTime;

                // 随机播放点击动画
                const clickAnims =
                  spineModelConfig.interactive.clickAnimations ||
                  (spineModelConfig.interactive.clickAnimation
                    ? [spineModelConfig.interactive.clickAnimation]
                    : []);

                if (clickAnims.length > 0) {
                  try {
                    const randomClickAnim =
                      clickAnims[Math.floor(Math.random() * clickAnims.length)];
                    player.setAnimation(randomClickAnim, false);

                    // 动画播放完成后回到待机状态
                    setTimeout(() => {
                      const idleAnims =
                        spineModelConfig.interactive.idleAnimations;
                      const randomIdle =
                        idleAnims[Math.floor(Math.random() * idleAnims.length)];
                      player.setAnimation(randomIdle, true);
                    }, 2000);
                  } catch (e) {
                    console.warn("Failed to play click animation:", e);
                  }
                }

                // 显示随机消息
                const messages = spineModelConfig.interactive.clickMessages;
                if (messages && messages.length > 0) {
                  const randomMessage =
                    messages[Math.floor(Math.random() * messages.length)];
                  showMessage(randomMessage);
                }

                // 500ms 后重置防抖标志
                setTimeout(() => {
                  isClickProcessing = false;
                }, 500);
              });

              // 设置待机动画循环
              if (spineModelConfig.interactive.idleAnimations.length > 1) {
                setInterval(() => {
                  try {
                    const idleAnims =
                      spineModelConfig.interactive.idleAnimations;
                    const randomIdle =
                      idleAnims[Math.floor(Math.random() * idleAnims.length)];
                    player.setAnimation(randomIdle, true);
                  } catch (e) {
                    console.warn("Failed to play idle animation:", e);
                  }
                }, spineModelConfig.interactive.idleInterval);
              }
            }
          }

          console.log("✅ Spine model setup complete!");
        },
        error: (_player, reason) => {
          console.error("❌ Spine model loading error:", reason);

          const errorDiv = document.getElementById("spine-error");
          if (errorDiv) {
            errorDiv.style.display = "block";
            errorDiv.innerHTML = `
              <div style="color: #ff4444; padding: 20px; text-align: center; font-size: 14px;">
                <div>⚠️ Spine 模型加载失败</div>
                <div style="font-size: 12px; margin-top: 8px; color: #888;">${reason}</div>
              </div>
            `;
          }

          const canvas = document.getElementById("spine-canvas");
          if (canvas) canvas.style.display = "none";
        },
      });
    } catch (error) {
      console.error("Spine model initialization error:", error);

      // 重置初始化标志，允许重试
      window.spineModelInitialized = false;

      const errorDiv = document.getElementById("spine-error");
      if (errorDiv) {
        errorDiv.style.display = "block";
        errorDiv.innerHTML = `
          <div style="color: #ff4444; padding: 20px; text-align: center; font-size: 14px;">
            <div>⚠️ Spine 运行时加载失败</div>
            <div style="font-size: 12px; margin-top: 8px; color: #888;">${error instanceof Error ? error.message : "未知错误"}</div>
          </div>
        `;
      }
    }
  }

  // 监听页面卸载事件，清理资源
  window.addEventListener("beforeunload", cleanupSpineModel);

  // 监听 Swup 页面切换事件（如果使用了 Swup）
  if (typeof window.swup !== "undefined" && window.swup.hooks) {
    window.swup.hooks.on("content:replace", () => {
      // 只更新响应式显示，不重新创建模型
      setTimeout(() => {
        updateResponsiveDisplay();
      }, 100);
    });
  }

  // 监听 popstate 事件（浏览器前进后退）
  window.addEventListener("popstate", () => {
    setTimeout(() => {
      updateResponsiveDisplay();
    }, 100);
  });

  // 监听窗口大小变化
  window.addEventListener("resize", updateResponsiveDisplay);

  // 页面加载完成后初始化（只初始化一次）
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSpineModel);
  } else {
    initSpineModel();
  }
</script>
</file>

<file path="components/widget/Tags.astro">
---

import ButtonTag from "@/components/common/ButtonTag.astro";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { sidebarLayoutConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getTagList } from "@/utils/content-utils";
import { getTagUrl } from "@/utils/url-utils";

const tags = await getTagList();

const COLLAPSED_HEIGHT = "7.5rem";

// 从配置中获取标签组件的折叠阈值
const tagsComponent = [
	...sidebarLayoutConfig.leftComponents,
	...sidebarLayoutConfig.rightComponents,
	...sidebarLayoutConfig.mobileBottomComponents,
].find((c) => c.type === "tags");

const collapseThreshold = tagsComponent?.responsive?.collapseThreshold;
const isCollapsed = collapseThreshold ? tags.length > collapseThreshold : false;

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---
<WidgetLayout name={i18n(I18nKey.tags)} id="tags" isCollapsed={isCollapsed} collapsedHeight={COLLAPSED_HEIGHT} class={className} style={style}>
    <div class="flex gap-2 flex-wrap">
        {tags.map(t => (
            <ButtonTag href={getTagUrl(t.name)} label={`View all posts with the ${t.name.trim()} tag`}>
                {t.name.trim()}
            </ButtonTag>
        ))}
    </div>
</WidgetLayout>
</file>

<file path="config/adConfig.ts">
import type { AdConfig } from "../types/config";

// 这里只是配置广告内容，如果要开关请在sidebarConfig.ts中控制侧边栏组件的的启用组件即可

// 广告配置1 - 纯图片广告（无边距）
export const adConfig1: AdConfig = {
	image: {
		src: "assets/images/cover.avif",
		alt: "广告横幅",
		link: "#",
		external: true,
	},

	// 是否允许关闭广告
	closable: true,

	// 显示次数限制，-1为无限制
	displayCount: -1,

	// 组件内边距配置，可通过取消注释生效
	padding: {
		// 零边距，图片占满整个组件
		all: "0",

		// 四边1rem边距
		// all: "1rem",

		// 顶部无边距
		// top: "0",

		// 右侧无边距
		// right: "1rem",

		// 底部无边距
		// bottom: "1rem",

		// 左侧无边距
		// left: "1rem",
	},
};

// 广告配置2 - 完整内容广告
export const adConfig2: AdConfig = {
	title: "支持博主",
	content:
		"如果您觉得本站内容对您有帮助，欢迎支持我们的创作！您的支持是我们持续更新的动力。",
	image: {
		src: "assets/images/cover.avif",
		alt: "支持博主",
		link: "about/",
		external: false,
	},
	link: {
		text: "支持一下",
		url: "about/",
		external: false,
	},
	closable: true,
	displayCount: -1,
	padding: {
		// all: "1rem",
	},
};
</file>

<file path="config/announcementConfig.ts">
import type { AnnouncementConfig } from "../types/config";

export const announcementConfig: AnnouncementConfig = {
	// 公告标题
	title: "公告",

	// 公告内容
	content: "调对频率的人，会找到这里。",

	// 是否允许用户关闭公告
	closable: false,

	link: {
		// 启用链接
		enable: false,
		// 链接文本
		text: "了解更多",
		// 链接 URL
		url: "/about/",
		// 内部链接
		external: false,
	},
};
</file>

<file path="config/backgroundWallpaper.ts">
import type { BackgroundWallpaperConfig } from "@/types/config";

export const backgroundWallpaper: BackgroundWallpaperConfig = {
    // 壁纸模式："banner" 横幅壁纸，"overlay" 全屏透明，"none" 纯色背景无壁纸
    mode: "overlay",
    // 是否允许用户通过导航栏切换壁纸模式，设为false可提升性能（只渲染当前模式）
    switchable: false,
    /**
     * 背景图片配置
     * 图片路径支持三种格式：
     * 1. public 目录（以 "/" 开头，不优化）："/assets/images/banner.avif"
     * 2. src 目录（不以 "/" 开头，自动优化但会增加构建时间，推荐）："assets/images/banner.avif"
     * 3. 远程 URL："https://example.com/banner.jpg"
     * 注意：远程URL和public目录的图片不会被优化，请确保图片体积足够小以免影响加载速度
     *
     * 建议不要替换d1-d6，m1-m6这些默认示例图片，但你可以删除掉节省空间
     * 因为以后可能会更换示例图片，导致你自定义的图片被覆盖
     * 所以建议使用自己的图片的时候命名为其他名称，不要使用d1-d6，m1-m6这些名称
     *
     * 如果只使用一张图片或者使用随机图API，推荐直接使用字符串格式：
     * desktop: "https://t.alcy.cc/pc",   // 随机图API
     * desktop: "assets/images/DesktopWallpaper/d1.avif", // 单张图片
     *
     * mobile: "https://t.alcy.cc/mp", // 随机图API
     * mobile: "assets/images/MobileWallpaper/m1.avif", // 单张图片
     *
     * 支持配置多张图片（数组），每次刷新页面随机显示一张：
     * desktop: [
     * "assets/images/DesktopWallpaper/d1.avif",
     * "assets/images/DesktopWallpaper/d2.avif",
     * ],
     *
     * mobile:[
     *   "assets/images/MobileWallpaper/m1.avif",
     *   "assets/images/MobileWallpaper/m2.avif",
     * ],
     */
    src: {
        // 桌面背景图片（支持单张或多张随机）
        // desktop: "assets/images/DesktopWallpaper/d1.avif",
        desktop: "https://img.hxrch.top/20260209232736315.webp",
        desktopDark: "https://img.hxrch.top/20260216100844103.webp",
        // 移动背景图片（支持单张或多张随机）
        // mobile: "assets/images/MobileWallpaper/m1.avif",
        mobile: "https://img.hxrch.top/20260209232736315.webp",
        mobileDark: "https://img.hxrch.top/20260216100844103.webp",
    },
    // Banner模式特有配置
    banner: {
        // 图片位置
        // 支持所有CSS object-position值，如: 'top', 'center', 'bottom', 'left top', 'right bottom', '25% 75%', '10px 20px'..
        // 如果不知道怎么配置百分百之类的配置，推荐直接使用：'center'居中，'top'顶部居中，'bottom' 底部居中，'left'左侧居中，'right'右侧居中
        position: "0% 20%",

        // 主页横幅文字
        homeText: {
            // 是否启用主页横幅文字
            enable: true,
            // 是否允许用户通过控制面板切换横幅标题显示
            switchable: true,
            // 主页横幅主标题
            title: "Lovely firefly!",
            // 主页横幅主标题字体大小
            titleSize: "3.8rem",
            // 主页横幅副标题
            subtitle: [
                "In Reddened Chrysalis, I Once Rest",
                "From Shattered Sky, I Free Fall",
                "Amidst Silenced Stars, I Deep Sleep",
                "Upon Lighted Fyrefly, I Soon Gaze",
                "From Undreamt Night, I Thence Shine",
                "In Finalized Morrow, I Full Bloom",
            ],
            // 主页横幅副标题字体大小
            subtitleSize: "1.5rem",
            typewriter: {
                // 是否启用打字机效果
                // 打字机开启 → 循环显示所有副标题
                // 打字机关闭 → 每次刷新随机显示一条副标题
                enable: true,
                // 打字速度（毫秒）
                speed: 100,
                // 删除速度（毫秒）
                deleteSpeed: 50,
                // 完全显示后的暂停时间（毫秒）
                pauseTime: 2000,
            },
        },
        // 图片来源
        credit: {
            enable: {
                // 桌面端显示横幅图片来源文本
                desktop: true,
                // 移动端显示横幅图片来源文本
                mobile: true,
            },
            text: {
                // 桌面端要显示的来源文本
                desktop: "Pixiv - 晚晚喵",
                // 移动端要显示的来源文本
                mobile: "Pixiv - KiraraShss",
            },
            url: {
                // 桌面端原始艺术品或艺术家页面的 URL 链接
                desktop: "https://www.pixiv.net/users/108801776",
                // 移动端原始艺术品或艺术家页面的 URL 链接
                mobile: "https://www.pixiv.net/users/42715864",
            },
        },
        // 横幅导航栏配置
        navbar: {
            // 横幅导航栏透明模式："semi" 半透明，"full" 完全透明，"semifull" 动态透明
            transparentMode: "semifull",
            // 是否开启毛玻璃模糊效果，开启可能会影响页面性能，如果不开启则是半透明，请根据自己的喜好开启
            enableBlur: true,
            // 毛玻璃模糊度
            blur: 3,
        },
        // 水波纹动画效果配置，开启会影响页面性能，请根据自己的喜好开启
        waves: {
            enable: {
                // 桌面端是否启用水波纹动画效果
                desktop: true,
                // 移动端是否启用水波纹动画效果
                mobile: true,
            },
            // 是否允许用户通过控制面板切换水波纹动画
            switchable: true,
        },
    },
    // 全屏透明覆盖模式特有配置
    overlay: {
        // 层级，确保壁纸在背景层
        zIndex: -1,
        // 壁纸透明度
        opacity: 0.8,
        // 背景模糊程度
        blur: 0.6,
    },
};
</file>

<file path="config/commentConfig.ts">
import type { CommentConfig } from "../types/config";

export const commentConfig: CommentConfig = {
	// 评论系统类型: none, twikoo, waline, giscus, disqus, artalk，默认为none，即不启用评论系统
	type: "twikoo",

	//twikoo评论系统配置
	twikoo: {
		envId: "https://blog-twikoo.hxrch.top",
		// 设置 Twikoo 评论系统语言
		lang: "zh-CN",
		// 是否启用文章访问量统计功能
		visitorCount: true,
	},

	//waline评论系统配置
	waline: {
		// waline 后端服务地址
		serverURL: "https://waline.vercel.app",
		// 设置 Waline 评论系统语言
		lang: "zh-CN",
		// 评论登录模式。可选值如下：
		//   'enable'   —— 默认，允许访客匿名评论和用第三方 OAuth 登录评论，兼容性最佳。
		//   'force'    —— 强制必须登录后才能评论，适合严格社区，关闭匿名评论。
		//   'disable'  —— 禁止所有登录和 OAuth，仅允许匿名评论（填写昵称/邮箱），适用于极简留言。
		login: "enable",
		// 是否启用文章访问量统计功能
		visitorCount: true,
	},

	// artalk评论系统配置
	artalk: {
		// artalk后端程序 API 地址
		server: "https://artalk.example.com/",
		// 设置 Artalk 语言
		locale: "zh-CN",
		// 是否启用文章访问量统计功能
		visitorCount: true,
	},

	//giscus评论系统配置
	giscus: {
		// 设置 Giscus 评论系统仓库
		repo: "CuteLeaf/Firefly",
		// 设置 Giscus 评论系统仓库ID
		repoId: "R_kgD2gfdFGd",
		// 设置 Giscus 评论系统分类
		category: "General",
		// 获取 Giscus 评论系统分类ID
		categoryId: "DIC_kwDOKy9HOc4CegmW",
		// 获取 Giscus 评论系统映射方式
		mapping: "title",
		// 获取 Giscus 评论系统严格模式
		strict: "0",
		// 获取 Giscus 评论系统反应功能
		reactionsEnabled: "1",
		// 获取 Giscus 评论系统元数据功能
		emitMetadata: "1",
		// 获取 Giscus 评论系统输入位置
		inputPosition: "top",
		// 获取 Giscus 评论系统语言
		lang: "zh-CN",
		// 获取 Giscus 评论系统加载方式
		loading: "lazy",
	},

	//disqus评论系统配置
	disqus: {
		// 获取 Disqus 评论系统
		shortname: "firefly",
	},
};
</file>

<file path="config/coverImageConfig.ts">
import type { CoverImageConfig } from "../types/config";

/**
 * 文章封面图配置
 *
 * enableInPost - 是否在文章详情页显示封面图
 *
 * 随机封面图使用说明：
 * 1. 在文章的 Frontmatter 中添加 image: "api" 即可使用随机图功能
 * 2. 系统会依次尝试所有配置的 API，全部失败后使用备用图片
 *
 * // 文章 Frontmatter 示例：
 * ---
 * title: 文章标题
 * image: "api"
 * ---
 */
export const coverImageConfig: CoverImageConfig = {
	// 是否在文章详情页显示封面图
	enableInPost: true,

	randomCoverImage: {
		// 随机封面图功能开关
		enable: false,
		// 封面图API列表
		apis: [
			"https://t.alcy.cc/pc",
			"https://www.dmoe.cc/random.php",
			"https://uapis.cn/api/v1/random/image?category=acg&type=pc",
		],
		// API失败时的回退图片路径（相对于src目录或以/开头的public目录路径）
		fallback: "assets/images/cover.avif",
		// 是否显示加载动画
		showLoading: false,
	},
};
</file>

<file path="config/expressiveCodeConfig.ts">
import type { ExpressiveCodeConfig } from "../types/config";

/**
 * expressive-code配置
 * @see https://expressive-code.com/
 * 修改本配置后需要重启Astro开发服务器才能生效
 */

export const expressiveCodeConfig: ExpressiveCodeConfig = {
	// 暗色主题（用于暗色模式）
	darkTheme: "one-dark-pro",

	// 亮色主题（用于亮色模式）
	lightTheme: "one-light",

	// 更多样式请看expressive-code的官方文档
	// https://expressive-code.com/guides/themes/

	// 代码块折叠插件配置
	pluginCollapsible: {
		enable: true, // 启用折叠功能
		lineThreshold: 15, // 当代码行数超过15行时显示折叠按钮
		previewLines: 8, // 折叠时显示前8行
		defaultCollapsed: true, // 默认折叠长代码块
	},
};
</file>

<file path="config/fontConfig.ts">
// 字体配置
export const fontConfig = {
    // 是否启用自定义字体功能
    enable: true,
    // 是否预加载字体文件
    preload: true,
    // 当前选择的字体，支持多个字体组合
    selected: ["harmonyos-sans-sc"],

    // 字体列表
    // 推荐使用可靠的 CDN 服务商提供的字体链接，它天然做了按需分片加载，且性能较好
    //
    // 也可以使用本地字体文件，需自行进行字体子集化处理，否则会因为字体文件庞大增加带宽负担导致页面加载缓慢甚至无法加载
    // 如果进行字体子集化处理，会导致动态内容（如评论，Bangumi等）无法正确显示字体，因此不推荐使用本地字体文件
    fonts: {
        // 系统字体
        system: {
            id: "system",
            name: "系统字体",
            src: "", // 系统字体无需 src
            family:
                "system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif",
        },

        // Google Fonts - Zen Maru Gothic
        "zen-maru-gothic": {
            id: "zen-maru-gothic",
            name: "Zen Maru Gothic",
            src: "https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap",
            family: "Zen Maru Gothic",
            display: "swap" as const,
        },

        // Google Fonts - Inter
        inter: {
            id: "inter",
            name: "Inter",
            src: "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap",
            family: "Inter",
            display: "swap" as const,
        },

        // 小米字体 - MiSans Normal
        "misans-normal": {
            id: "misans-normal",
            name: "MiSans Normal",
            src: "https://unpkg.com/misans@4.1.0/lib/Normal/MiSans-Normal.min.css",
            family: "MiSans",
            weight: 400,
            display: "swap" as const,
        },

        // 小米字体 - MiSans Regular
        "misans-regular": {
            id: "misans-regular",
            name: "MiSans Regular",
            src: "https://unpkg.com/misans@4.1.0/lib/Normal/MiSans-Regular.min.css",
            family: "MiSans",
            weight: 500,
            display: "swap" as const,
        },

        // 小米字体 - MiSans Semibold
        "misans-semibold": {
            id: "misans-semibold",
            name: "MiSans Semibold",
            src: "https://unpkg.com/misans@4.1.0/lib/Normal/MiSans-Semibold.min.css",
            family: "MiSans",
            weight: 600,
            display: "swap" as const,
        },

        "harmonyos-sans-sc": {
            id: "harmonyos-sans-sc",
            name: "HarmonyOS Sans SC",
            src: "https://cdn.xrbk.cn/fonts/HarmonyOS_Sans_SC/result.css",
            family: "HarmonyOS Sans SC",
            weight: 400,
            display: "swap" as const,
        },
    },

    // 全局字体回退
    fallback: [
        "system-ui",
        "-apple-system",
        "BlinkMacSystemFont",
        "Segoe UI",
        "Roboto",
        "sans-serif",
    ],
};
</file>

<file path="config/FooterConfig.html">
<div class="flex flex-wrap flex-row gap-2 justify-center mt-2">
  <a href="https://www.travellings.cn/go.html" target="_blank" title="开往 | 友链接力">
    <img src="https://img.hxrch.top/travellings.svg" alt="开往 | 友链接力">
  </a>
  <a href="https://icp.gov.moe/?keyword=20251935" target="_blank" title="萌ICP备20251935号">
    <img src="https://img.hxrch.top/moe1935.svg" alt="萌ICP备20251935号">
  </a>
  <!--<a href="https://icp.ekucat.com/beian/2025081935.html" title="KUCAT盟2025081935号" target="_blank">
    <img style="height:20px;margin-bottom:5px;display:inline;" src="https://icp.ekucat.com/images/icologo.png">KUCAT盟2025081935号
  </a>-->
  <a href="https://icp.redcha.cn/beian/ICP-2025080030.html" target="_blank" title="茶ICP备2025080030号">
    <img src="https://img.hxrch.top/cha080030.svg" alt="茶ICP备2025080030号">
  </a>
</div>
<script data-swup-ignore-script defer src="https://umami.hxrch.top/script.js" data-website-id="c8264979-a2fb-495d-925f-ad5333917f87"></script>
</file>

<file path="config/footerConfig.ts">
import type { FooterConfig } from "../types/config";

export const footerConfig: FooterConfig = {
	// 是否启用Footer HTML注入功能
	enable: true,
};

// 直接编辑 config/FooterConfig.html 文件来添加备案号等自定义内容
</file>

<file path="config/friendsConfig.ts">
import type { FriendLink, FriendsPageConfig } from "../types/config";

// 可以在src/content/spec/friends.md中编写友链页面下方的自定义内容

// 友链页面配置
export const friendsPageConfig: FriendsPageConfig = {
    // 显示列数：2列或3列
    columns: 2,
};

// 友链配置
export const friendsConfig: FriendLink[] = [
    {
        title: "夏夜流萤",
        imgurl: "https://q1.qlogo.cn/g?b=qq&nk=7618557&s=640",
        desc: "飞萤之火自无梦的长夜亮起，绽放在终竟的明天。",
        siteurl: "https://blog.cuteleaf.cn",
        tags: ["博客"],
        weight: 10, // 权重，数字越大排序越靠前
        enabled: true, // 是否启用
    },
    {
        title: "Firefly Docs",
        imgurl: "https://docs-firefly.cuteleaf.cn/logo.png",
        desc: "Firefly主题模板文档",
        siteurl: "https://docs-firefly.cuteleaf.cn",
        tags: ["文档"],
        weight: 10,
        enabled: true,
    },
    {
        title: "Astro",
        imgurl: "https://avatars.githubusercontent.com/u/44914786?v=4&s=640",
        desc: "The web framework for content-driven websites. ⭐️ Star to support our work!",
        siteurl: "https://github.com/withastro/astro",
        tags: ["框架"],
        weight: 10,
        enabled: true,
    },
    {
        title: "开往 | 友链接力",
        imgurl: "https://img.hxrch.top/travellings_favicon.webp",
        desc: "让传统友链“活跃”，让网页相互接力，让流量相互流动，让网络开放起来",
        siteurl: "https://www.travellings.cn",
        tags: ["博客收录"],
        weight: 9,
        enabled: true,
    },
    {
        title: "博客圈",
        imgurl: "https://bokequan.cn/wp-content/uploads/2024/10/1730017489-logo.png",
        desc: "致力于个人独立博客",
        siteurl: "https://bokequan.cn",
        tags: ["博客收录"],
        weight: 9,
        enabled: true,
    },
    {
        title: "个站商店",
        imgurl: "https://upload.storeweb.cn/image/logo.png",
        desc: "一个精致的，带社交元素的个人网站发布平台，博客收录网站",
        siteurl: "https://storeweb.cn",
        tags: ["博客收录"],
        weight: 9,
        enabled: true,
    },
    {
        title: "小改学习志",
        imgurl: "https://cn.cravatar.com/avatar/14e584196d31262ea144ab4d75d4c083?s=450&r=g",
        desc: "从此刻开始，什么都不晚。",
        siteurl: "https://www.haoyu233.com",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "路明笔记",
        imgurl: "https://cn.cravatar.com/avatar/302380667bdaf4e1390800e62494d4af?s=500&r=X",
        desc: "不慌张，不绝望，不狂妄，不投降。",
        siteurl: "https://luming.cool",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "我的技术成长笔记",
        imgurl: "https://blog.longdahuasheng.top/logo.jpg",
        desc: "零基础入门到进阶实战，记录每一步成长的思考。",
        siteurl: "https://blog.longdahuasheng.top",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "ZYBlog",
        imgurl: "https://blog.pljzy.top/_astro/logo.BxIxyJV1_Z19cEQW.webp",
        desc: "一个技术探索与分享的平台",
        siteurl: "https://blog.pljzy.top",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "SLHAF's blog",
        imgurl: "https://blog.slhaf.work/upload/favicon.png",
        desc: "SLHAF的个人博客",
        siteurl: "https://blog.slhaf.work",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "Anson",
        imgurl: "https://ansonq.com/src/tx.png",
        desc: "Anson国际导航页",
        siteurl: "https://ansonq.com",
        tags: ["导航"],
        weight: 1,
        enabled: true,
    },
    {
        title: "天码行空的小破站",
        imgurl: "https://bu.dusays.com/2026/02/05/6984096009670.jpeg",
        desc: "路漫漫其修远兮，吾将上下而求索",
        siteurl: "https://cs.gt.tc",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "默小班",
        imgurl: "https://wmimg.com/i/780/2025/07/68677fe53c2d1.png",
        desc: "一个初中生的小站点。",
        siteurl: "https://www.memxb.top",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "Ad_closeNN's Blog",
        imgurl: "https://adclosenn.top/assets/avatar.jpg",
        desc: "Ad_closeNN 的小站，时不时会刷新一些野生东西",
        siteurl: "https://adclosenn.top",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "Rownix's Blog",
        imgurl: "https://xapi.rownix.dev/8bec399a8d697bf4db49df6073b263795760a2a9.jpg",
        desc: "慢即是快，快即是慢，致力于为大家提供最好的内容",
        siteurl: "https://www.rownix.dev",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "静かな森",
        imgurl: "https://avatars.githubusercontent.com/u/41265413?v=4",
        desc: "致虚极，守静笃。",
        siteurl: "https://innei.in",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
    {
        title: "Ksable's 小屋",
        imgurl: "https://weavatar.com/avatar/abd826c253cc22fb954ec7567526f9a1211deb9905b8477c5b2875e20a2adb0b?s=500",
        desc: "身在无间，心在桃源",
        siteurl: "https://blog.ksable.top",
        tags: ["博客"],
        weight: 1,
        enabled: true,
    },
];

// 获取启用的友链并按权重排序
export const getEnabledFriends = (): FriendLink[] => {
    return friendsConfig
        .filter((friend) => friend.enabled)
        .sort((a, b) => b.weight - a.weight);
};
</file>

<file path="config/index.ts">
// 配置索引文件 - 统一导出所有配置
// 这样组件可以一次性导入多个相关配置，减少重复的导入语句

// 类型导出
export type {
    AnnouncementConfig,
    BackgroundWallpaperConfig,
    CommentConfig,
    CoverImageConfig,
    ExpressiveCodeConfig,
    FooterConfig,
    LicenseConfig,
    MusicPlayerConfig,
    NavBarConfig,
    ProfileConfig,
    SakuraConfig,
    SidebarLayoutConfig,
    SiteConfig,
    SponsorConfig,
    SponsorItem,
    SponsorMethod,
    WidgetComponentConfig,
    WidgetComponentType,
} from "../types/config";
export { adConfig1, adConfig2 } from "./adConfig"; // 广告配置
export { announcementConfig } from "./announcementConfig"; // 公告配置
// 样式配置
export { backgroundWallpaper } from "./backgroundWallpaper"; // 背景壁纸配置
// 功能配置
export { commentConfig } from "./commentConfig"; // 评论系统配置
export { coverImageConfig } from "./coverImageConfig"; // 封面图配置
export { expressiveCodeConfig } from "./expressiveCodeConfig"; // 代码高亮配置
export { fontConfig } from "./fontConfig"; // 字体配置
export { footerConfig } from "./footerConfig"; // 页脚配置
export { friendsPageConfig, getEnabledFriends } from "./friendsConfig"; // 友链配置
export { dayjsInit, memosConfig, getMoments, loadMoreMoments, getMomentsHTML, getLoadMoreBtnHTML } from "./momentsConfig";
export { licenseConfig } from "./licenseConfig"; // 许可证配置
// 组件配置
export { musicPlayerConfig } from "./musicConfig"; // 音乐播放器配置
export { navBarConfig, navBarSearchConfig } from "./navBarConfig"; // 导航栏配置与搜索配置
export { live2dModelConfig, spineModelConfig } from "./pioConfig"; // 看板娘配置
export { profileConfig } from "./profileConfig"; // 用户资料配置
export { sakuraConfig } from "./sakuraConfig"; // 樱花特效配置
// 布局配置
export { sidebarLayoutConfig } from "./sidebarConfig"; // 侧边栏布局配置
// 核心配置
export { siteConfig } from "./siteConfig"; // 站点基础配置
export { sponsorConfig } from "./sponsorConfig"; // 赞助配置
</file>

<file path="config/licenseConfig.ts">
import type { LicenseConfig } from "../types/config";

export const licenseConfig: LicenseConfig = {
	// 是否启用文章顶部许可证信息显示
	enable: true,

	// 许可证名称及链接
	name: "CC BY-NC-SA 4.0",
	url: "https://creativecommons.org/licenses/by-nc-sa/4.0/",
};
</file>

<file path="config/momentsConfig.ts">
import type { MomentItem, MomentsLoadResult, MemosConfig } from "../types/config";
import { profileConfig } from "../config";
import dayjs from "dayjs";
import relativeTime from "dayjs/plugin/relativeTime";
import weekday from "dayjs/plugin/weekday";
import "dayjs/locale/zh-cn";

export const memosConfig: MemosConfig = {
    host: "memos.hxrch.top",
    pageLimit: 10,
};

export const dayjsInit = (): void => {
    dayjs.extend(relativeTime);
    dayjs.extend(weekday);
    dayjs.locale("zh-cn");
};

function customCalendar(date: dayjs.Dayjs | string, referenceDay: dayjs.Dayjs | string = dayjs()) {
    const ref = dayjs(referenceDay);
    const target = dayjs(date);
    const diffHours = ref.diff(target, "hour");
    if (diffHours < 7) return target.from(ref);

    const specify = (prefix: string, dt: dayjs.Dayjs) => {
        return `${prefix} ${dt.format("H:mm")}`;
    };
    const diffDays = ref.startOf("day").diff(target.startOf("day"), "day");
    switch (diffDays) {
        case 0:
            return specify("今天", target);
        case 1:
            return specify("昨天", target);
        case 2:
            return specify("前天", target);
        case -1:
            return specify("明天", target);
        case -2:
            return specify("后天", target);
    }

    const thisMonday = ref.weekday(0);
    const thisSunday = ref.weekday(6);
    const lastSunday = thisMonday.subtract(1, "day");
    const nextMonday = thisSunday.add(1, "day");
    const beforeLastMonday = lastSunday.subtract(7, "day");
    const afterNextSunday = nextMonday.add(7, "day");
    const weekdayName = target.format("dd");
    if (target.isAfter(lastSunday, "day") && target.isBefore(nextMonday, "day")) {
        return specify(`周${weekdayName}`, target);
    } else if (target.isAfter(beforeLastMonday, "day") && target.isBefore(thisMonday, "day")) {
        return specify(`上周${weekdayName}`, target);
    } else if (target.isAfter(thisSunday, "day") && target.isBefore(afterNextSunday, "day")) {
        return specify(`下周${weekdayName}`, target);
    }

    if (target.year() === ref.year()) {
        return specify(target.format("M月D日"), target);
    }

    return specify(target.format("YYYY年M月D日"), target);
}

const fetchMoments = async (API_URL: string): Promise<MomentsLoadResult> => {
    const items: MomentItem[] = [];
    try {
        const resp = await fetch(API_URL);
        if (!resp.ok) return { items: [], nextToken: "" };
        const data = await resp.json();
        data.memos.forEach((mem: any): void => {
            items.push({
                name: mem.name,
                content: mem.content,
                created: customCalendar(mem.createTime),
            });
        });
        return { items: items, nextToken: data.nextPageToken };
    } catch {
        return { items: [], nextToken: "" };
    }
};

export const getMoments = async (): Promise<MomentsLoadResult> => {
    return fetchMoments(`https://${memosConfig.host}/api/v1/memos?pageSize=${memosConfig.pageLimit}`);
};

export const loadMoreMoments = async (token: string): Promise<MomentsLoadResult> => {
    return fetchMoments(`https://${memosConfig.host}/api/v1/memos?pageSize=${memosConfig.pageLimit}&pageToken=${token}`);
};

export const getMomentsHTML = (items: MomentItem[], initial: boolean = true): string => {
    return items.map((item: MomentItem, i) => {
        const name = item.name.split("/")[1];
        return "<div>" + (i > 0 || !initial ? `<hr class="my-6 border-dashed" style="border-color: var(--line-divider);">` : ``)
            + `<div class="flex gap-3.5">
                <img src=${profileConfig.avatar} alt="🍃" class="w-10 h-10 rounded-md">
                <section>
                    <p class="font-bold text-base text-gray-950 dark:text-gray-50">${profileConfig.name}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${item.created}</p>
                    <p class="custom-md mt-2.5 text-gray-900 dark:text-gray-100">${item.content}</p>
                </section>
            </div>
            <div class="mt-6 text-right">
                <button class="toggle-comments-btn inline-block h-7.5 px-3.5 py-0 border-(--line-divider) border-solid border rounded-lg
                    text-sm text-center text-(--btn-content) bg-transparent hover:border-(--primary)
                    hover:bg-(--btn-regular-bg-hover) active:bg-(--btn-regular-bg-active) transition-all duration-300"
                style="box-shadow: 0 1px 2px #0000000d;" data-name="${name}">
                    <svg width="1em" height="1em" viewBox="0 0 640 640" class="inline text-[0.825rem]" data-icon="fa7-solid:comment-dots">
                        <use href="#ai:fa7-solid:comment-dots"></use>
                    </svg>
                    <span class="align-middle text-[0.75rem]">评论</span>
                </button>
            </div>
            <div class="flex gap-2.5">
                <span class="inline-block w-8 h-8 opacity-0">Lorem ipsum.</span>
                <section class="mm-comments-wrapper" data-name="${name}"></section>
            </div>` + "</div>";
    }).join("");
};

export const getLoadMoreBtnHTML = (token: string): string => {
    return token === ""
        ? `<p class="text-gray-400 text-[0.75rem]">---------------&nbsp;已经到底了哦&nbsp;---------------</p>`
        : `<button id="load-more-btn" class="inline-block h-10 px-6 py-2 border-none rounded-lg text-sm text-center
                text-(--btn-content) bg-(--btn-regular-bg) hover:scale-105 hover:bg-(--btn-regular-bg-hover)
                active:bg-(--btn-regular-bg-active) active:scale-95 transition-all duration-300"
            style="box-shadow: 0 1px 2px #0000000d;">
                加载更多……
            </button>`;
};
</file>

<file path="config/musicConfig.ts">
import type { MusicPlayerConfig } from "../types/config";

// 音乐播放器配置
export const musicPlayerConfig: MusicPlayerConfig = {
	// 禁用音乐播放器方法：
	// 模板默认侧边栏和导航栏两个都显示
	// 1. 侧边栏：在sidebarConfig.ts侧边栏配置把音乐组件enable设为false禁用即可
	// 2. 导航栏：在本配置文件把showInNavbar设为false禁用即可

	// 是否在导航栏显示音乐播放器入口
	showInNavbar: false,

	// 使用方式："meting" 使用 Meting API，"local" 使用本地音乐列表
	mode: "meting",

	// 默认音量 (0-1)
	volume: 0.7,

	// 播放模式：'list'=列表循环, 'one'=单曲循环, 'random'=随机播放
	playMode: "list",

	// 是否显启用歌词
	showLyrics: true,

	// Meting API 配置
	meting: {
		// Meting API 地址
		// 默认使用官方 API，也可以使用自定义 API
		api: "https://api.i-meto.com/meting/api?server=:server&type=:type&id=:id&r=:r",
		// 音乐平台：netease=网易云音乐, tencent=QQ音乐, kugou=酷狗音乐, xiami=虾米音乐, baidu=百度音乐
		server: "netease",
		// 类型：song=单曲, playlist=歌单, album=专辑, search=搜索, artist=艺术家
		type: "playlist",
		// 歌单/专辑/单曲 ID 或搜索关键词
		id: "10046455237",
		// 认证 token（可选）
		auth: "",
		// 备用 API 配置（当主 API 失败时使用）
		fallbackApis: [
			"https://api.injahow.cn/meting/?server=:server&type=:type&id=:id",
			"https://api.moeyao.cn/meting/?server=:server&type=:type&id=:id",
		],
	},

	// 本地音乐配置（当 mode 为 'local' 时使用）
	// 1. 支持传入歌词文件的路径
	// lrc: "/assets/music/lrc/使一颗心免于哀伤-哼唱.lrc",
	// 2. 或者直接填入歌词字符串内容
	// lrc: "[00:00.00]歌词内容...",
	local: {
		playlist: [
			{
				name: "使一颗心免于哀伤",
				artist: "知更鸟 / HOYO-MiX / Chevy",
				url: "/assets/music/使一颗心免于哀伤-哼唱.mp3",
				cover: "/assets/music/cover/109951169585655912.webp",
				lrc: "",
			},
		],
	},
};
</file>

<file path="config/navBarConfig.ts">
import {
    LinkPreset,
    type NavBarConfig,
    type NavBarLink,
    type NavBarSearchConfig,
    NavBarSearchMethod,
} from "../types/config";
import { siteConfig } from "./siteConfig";

// 根据页面开关动态生成导航栏配置
const getDynamicNavBarConfig = (): NavBarConfig => {
    // 基础导航栏链接
    const links: (NavBarLink | LinkPreset)[] = [
        // 主页
        LinkPreset.Home,

        // 归档
        LinkPreset.Archive,
    ];

    // 自定义导航栏链接,并且支持多级菜单
    /*links.push({
        name: "链接",
        url: "/links/",
        icon: "material-symbols:link",

        // 子菜单
        children: [
            {
                name: "GitHub",
                url: "https://github.com/CuteLeaf/Firefly",
                external: true,
                icon: "fa7-brands:github",
            },
            {
                name: "Bilibili",
                url: "https://space.bilibili.com/38932988",
                external: true,
                icon: "fa7-brands:bilibili",
            },
        ],
    });*/

    // 友链
    links.push(LinkPreset.Friends);

    // 根据配置决定是否添加留言板，在siteConfig关闭pages.guestbook时导航栏不显示留言板
    if (siteConfig.pages.guestbook) {
        links.push(LinkPreset.Guestbook);
    }

    // 关于及其子菜单
    links.push({
        name: "关于",
        url: "/content/",
        icon: "material-symbols:info",
        children: [
            // 根据配置决定是否添加赞助，在siteConfig关闭pages.sponsor时导航栏不显示赞助
            ...(siteConfig.pages.sponsor ? [LinkPreset.Sponsor] : []),

            // 关于页面
            LinkPreset.About,

            // 根据配置决定是否添加番组计划，在siteConfig关闭pages.bangumi时导航栏不显示番组计划
            ...(siteConfig.pages.bangumi ? [LinkPreset.Bangumi] : []),

            // 片刻页面
            LinkPreset.Moments,

            {
                name: "状态监控",
                url: "https://status.hxrch.top",
                external: true,
                icon: "material-symbols:monitoring-rounded",
            },
        ],
    });

    links.push({
        name: "接力",
        url: "/relay/",
        icon: "fa7-solid:paper-plane",
        children: [
            {
                name: "开往",
                url: "https://www.travellings.cn/go.html",
                external: true,
                icon: "material-symbols:subway",
            },
            {
                name: "异次元之旅",
                url: "https://travel.moe/go.html",
                external: true,
                icon: "material-symbols:planet",
            },
        ],
    });

    // 仅返回链接，其它导航搜索相关配置在模块顶层常量中独立导出
    return { links } as NavBarConfig;
};

// 导航搜索配置
export const navBarSearchConfig: NavBarSearchConfig = {
    method: NavBarSearchMethod.PageFind,
};

export const navBarConfig: NavBarConfig = getDynamicNavBarConfig();
</file>

<file path="config/pioConfig.ts">
import type { Live2DModelConfig, SpineModelConfig } from "../types/config";

// Spine 看板娘配置
export const spineModelConfig: SpineModelConfig = {
	// Spine 看板娘开关
	enable: false,

	// Spine模型配置
	model: {
		// Spine模型文件路径
		path: "/pio/models/spine/firefly/1310.json",
		// 模型缩放比例
		scale: 1.0,
		// X轴偏移
		x: 0,
		// Y轴偏移
		y: 0,
	},

	// 位置配置
	position: {
		// 显示位置 bottom-left，bottom-right，top-left，top-right，注意：在右下角可能会挡住返回顶部按钮
		corner: "bottom-left",
		// 距离边缘0px
		offsetX: 0,
		// 距离下边缘0px
		offsetY: 0,
	},

	// 尺寸配置
	size: {
		// 容器宽度
		width: 135,
		// 容器高度
		height: 165,
	},

	// 交互配置
	interactive: {
		// 交互功能开关
		enabled: true,
		// 点击时随机播放的动画列表
		clickAnimations: [
			"emoji_0",
			"emoji_1",
			"emoji_2",
			"emoji_3",
			"emoji_4",
			"emoji_5",
			"emoji_6",
		],
		// 点击时随机显示的文字消息
		clickMessages: [
			"你好呀！我是流萤~",
			"今天也要加油哦！✨",
			"想要一起去看星空吗？🌟",
			"记得要好好休息呢~",
			"有什么想对我说的吗？💫",
			"让我们一起探索未知的世界吧！🚀",
			"每一颗星星都有自己的故事~⭐",
			"希望能带给你温暖和快乐！💖",
		],
		// 文字显示时间（毫秒）
		messageDisplayTime: 3000,
		// 待机动画列表
		idleAnimations: ["idle", "emoji_0", "emoji_1", "emoji_3", "emoji_4"],
		// 待机动画切换间隔（毫秒）
		idleInterval: 8000,
	},

	// 响应式配置
	responsive: {
		// 在移动端隐藏
		hideOnMobile: true,
		// 移动端断点
		mobileBreakpoint: 768,
	},

	// 层级
	zIndex: 1000, // 层级

	// 透明度
	opacity: 1.0,
};

// Live2D 看板娘配置
export const live2dModelConfig: Live2DModelConfig = {
	// Live2D 看板娘开关
	enable: false,
	// Live2D模型配置
	model: {
		// Live2D模型文件路径
		path: "/pio/models/live2d/snow_miku/model.json",
		// path: "/pio/models/live2d/illyasviel/illyasviel.model.json",
	},

	// 位置配置
	position: {
		// 显示位置 bottom-left，bottom-right，top-left，top-right，注意：在右下角可能会挡住返回顶部按钮
		corner: "bottom-left",
		// 距离边缘0px
		offsetX: 0,
		// 距离下边缘0px
		offsetY: 0,
	},

	// 尺寸配置
	size: {
		// 容器宽度
		width: 135,
		// 容器高度
		height: 165,
	},

	// 交互配置
	interactive: {
		// 交互功能开关
		enabled: true,
		// 点击时随机显示的文字消息，motions 和 expressions 将从模型 JSON 文件中自动读取
		clickMessages: [
			"你好！我是Miku~",
			"有什么需要帮助的吗？",
			"今天天气真不错呢！",
			"要不要一起玩游戏？",
			"记得按时休息哦！",
		],
		// 随机显示的文字消息显示时间（毫秒）
		messageDisplayTime: 3000,
	},

	// 响应式配置
	responsive: {
		// 在移动端隐藏
		hideOnMobile: true,
		// 移动端断点
		mobileBreakpoint: 768,
	},
};
</file>

<file path="config/profileConfig.ts">
import type { ProfileConfig } from "../types/config";

export const profileConfig: ProfileConfig = {
	// 头像
	// 图片路径支持三种格式：
	// 1. public 目录（以 "/" 开头，不优化）："/assets/images/avatar.webp"
	// 2. src 目录（不以 "/" 开头，自动优化但会增加构建时间，推荐）："assets/images/avatar.webp"
	// 3. 远程 URL："https://example.com/avatar.jpg"
	avatar: "https://img.hxrch.top/avatar512.webp",

	// 名字
	name: "Horean",

	// 个人签名
	bio: "Before was was was, was was is.",

	// 链接配置
	// 已经预装的图标集：fa7-brands，fa7-regular，fa7-solid，material-symbols，simple-icons
	// 访问https://icones.js.org/ 获取图标代码，
	// 如果想使用尚未包含相应的图标集，则需要安装它
	// `pnpm add @iconify-json/<icon-set-name>`
	// showName: true 时显示图标和名称，false 时只显示图标
	links: [
		{
			name: "GitHub",
			icon: "fa7-brands:github",
			url: "https://github.com/Horean0574/",
			showName: false,
		},
		{
			name: "Bilibli",
			icon: "fa7-brands:bilibili",
			url: "https://space.bilibili.com/524301886/",
			showName: false,
		},
		{
			name: "Email",
			icon: "fa7-solid:envelope",
			url: "mailto:hi@hxrch.top",
			showName: false,
		},
		{
			name: "RSS",
			icon: "fa7-solid:rss",
			url: "/rss/",
			showName: false,
		},
	],
};
</file>

<file path="config/README.md">
# 配置文件说明

本目录包含 Firefly 主题的所有配置文件，采用模块化设计，每个文件负责特定的功能模块。

## 📁 配置文件结构

```
src/config/
├── index.ts              # 配置索引文件 - 统一导出
├── siteConfig.ts         # 站点基础配置
├── backgroundWallpaper.ts # 背景壁纸配置
├── profileConfig.ts      # 用户资料配置
├── musicConfig.ts        # 音乐播放器配置
├── sakuraConfig.ts       # 樱花特效配置
├── commentConfig.ts      # 评论系统配置
├── announcementConfig.ts # 公告配置
├── licenseConfig.ts      # 许可证配置
├── footerConfig.ts       # 页脚配置
├── expressiveCodeConfig.ts # 代码高亮配置
├── fontConfig.ts         # 字体配置
├── sidebarConfig.ts      # 侧边栏配置
├── navBarConfig.ts       # 导航栏配置
├── pioConfig.ts          # Pio 模型配置
├── adConfig.ts           # 广告配置
├── friendsConfig.ts      # 友链配置
├── sponsorConfig.ts      # 赞助配置
├── coverImageConfig.ts   # 封面图配置
└── README.md             # 本文件
```

## 🚀 使用方式

### 推荐：使用配置索引（统一导入）
```typescript
import { siteConfig, profileConfig } from '../config';
```

### 直接导入单个配置
```typescript
import { siteConfig } from '../config/siteConfig';
import { profileConfig } from '../config/profileConfig';
```

## 📋 配置文件列表

- `siteConfig.ts` - 站点基础配置（标题、描述、主题色等）
- `backgroundWallpaper.ts` - 背景壁纸配置（壁纸模式、图片、横幅文字等）
- `profileConfig.ts` - 用户资料配置（头像、姓名、社交链接等）
- `musicConfig.ts` - 音乐播放器配置（支持本地音乐和 Meting API）
- `sakuraConfig.ts` - 樱花特效配置（数量、速度、尺寸等）
- `commentConfig.ts` - 评论系统配置（Twikoo 评论和文章访问量统计）
- `announcementConfig.ts` - 公告配置（标题、内容、链接等）
- `licenseConfig.ts` - 许可证配置（CC 协议等）
- `footerConfig.ts` - 页脚配置（HTML 注入等）
- `expressiveCodeConfig.ts` - 代码高亮配置（主题等）
- `fontConfig.ts` - 字体配置（字体族、大小等）
- `sidebarConfig.ts` - 侧边栏配置（组件布局等）
- `navBarConfig.ts` - 导航栏配置（链接、样式等）
- `pioConfig.ts` - Pio 模型配置（Spine、Live2D 等）
- `adConfig.ts` - 广告配置（广告位设置等）
- `friendsConfig.ts` - 友链配置（友链列表等）
- `sponsorConfig.ts` - 赞助配置（赞助方式、二维码等）
- `coverImageConfig.ts` - 封面图配置（随机封面图列表等）


```
</file>

<file path="config/sakuraConfig.ts">
import type { SakuraConfig } from "../types/config";

export const sakuraConfig: SakuraConfig = {
	// 是否启用樱花特效
	enable: false,

	// 樱花数量
	sakuraNum: 21,

	// 樱花越界限制次数，-1为无限循环
	limitTimes: -1,

	// 樱花尺寸
	size: {
		// 樱花最小尺寸倍数
		min: 0.5,
		// 樱花最大尺寸倍数
		max: 1.1,
	},

	// 樱花不透明度
	opacity: {
		// 樱花最小不透明度
		min: 0.3,
		// 樱花最大不透明度
		max: 0.9,
	},

	// 樱花移动速度
	speed: {
		// 水平移动
		horizontal: {
			// 水平移动速度最小值
			min: -1.7,
			// 水平移动速度最大值
			max: -1.2,
		},
		// 垂直移动
		vertical: {
			// 垂直移动速度最小值
			min: 1.5,
			// 垂直移动速度最大值
			max: 2.2,
		},
		// 旋转速度
		rotation: 0.03,
		// 消失速度，不应大于最小不透明度
		fadeSpeed: 0.03,
	},

	// 层级，确保樱花在合适的层级显示
	zIndex: 100,
};
</file>

<file path="config/sidebarConfig.ts">
import type { SidebarLayoutConfig } from "../types/config";

/**
 * 侧边栏布局配置
 */
export const sidebarLayoutConfig: SidebarLayoutConfig = {
	// 是否启用侧边栏功能
	enable: true,

	// 侧边栏位置：
	// left: 仅显示左侧边栏
	// right: 仅显示右侧边栏
	// both: 双侧边栏，1280px以上同时显示左右，769-1279px根据tabletSidebar配置显示其中一侧
	position: "both",

	// 平板端(769-1279px)显示哪侧侧边栏，仅position为both时生效
	// left: 平板端显示左侧边栏
	// right: 平板端显示右侧边栏
	tabletSidebar: "left",

	// 使用单侧栏(position为left或right)时，是否在文章详情页显示双侧边栏
	// 当position为left时开启此项，文章详情页将额外显示右侧边栏
	// 当position为right时开启此项，文章详情页将额外显示左侧边栏
	// 适用在只想用单侧栏，但在文章详情页想用对侧栏的目录等组件的场景
	showBothSidebarsOnPostPage: true,

	// 左侧边栏组件配置列表
	// 组件的渲染顺序完全取决于它们在配置数组中出现的顺序，但top的组件会优先于sticky位置的组件渲染
	// type 组件类型
	// enable 是否启用该组件
	// position 组件位置：top固定顶部，sticky粘性定位(会跟随页面滚动)
	// showOnPostPage 是否在文章详情页显示该组件
	// showOnNonPostPage 是否在非文章详情页显示该组件（除文章详情页外都显示）
	// configId 组件配置ID（目前仅广告组件使用），用于区分不同的广告配置
	// responsive 响应式配置（部分组件可用，可用来设定部分组件需要的参数）
	leftComponents: [
		{
			// 组件类型：用户资料组件
			type: "profile",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "top",
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：公告组件
			type: "announcement",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "top",
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：音乐播放器
			type: "music",
			// 是否启用该组件
			enable: false,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：分类组件
			type: "categories",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 响应式配置
			responsive: {
				// 折叠阈值：当分类数量超过>5个时自动折叠
				collapseThreshold: 5,
			},
		},
		{
			// 组件类型：标签组件
			type: "tags",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 响应式配置
			responsive: {
				// 折叠阈值：当标签数量超过>20个时自动折叠
				collapseThreshold: 20,
			},
		},
		{
			// 组件类型：广告栏组件 1
			type: "advertisement",
			// 是否启用该组件
			enable: false,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 配置ID：使用第一个广告配置
			configId: "ad1",
		},
	],

	// 右侧边栏组件配置列表
	rightComponents: [
		{
			// 组件类型：站点统计组件
			type: "stats",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "top",
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：日历组件
			type: "calendar",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: false,
		},
		{
			// 组件类型：侧边栏目录组件（只在文章详情页显示）
			type: "sidebarToc",
			// 是否启用该组件
			enable: true,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 是否在非文章详情页显示
			showOnNonPostPage: false,
		},
		{
			// 组件类型：广告栏组件 2
			type: "advertisement",
			// 是否启用该组件
			enable: false,
			// 组件位置
			position: "sticky",
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 配置ID：使用第二个广告配置
			configId: "ad2",
		},
	],

	// 移动端底部组件配置列表
	// 这些组件只在移动端(<768px)显示在页面底部，独立于左右侧边栏配置
	mobileBottomComponents: [
		{
			// 组件类型：用户资料组件
			type: "profile",
			// 是否启用该组件
			enable: true,
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：公告组件
			type: "announcement",
			// 是否启用该组件
			enable: true,
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：音乐播放器
			type: "music",
			// 是否启用该组件
			enable: false,
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
		{
			// 组件类型：分类组件
			type: "categories",
			// 是否启用该组件
			enable: true,
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 响应式配置
			responsive: {
				// 折叠阈值：当分类数量超过5个时自动折叠
				collapseThreshold: 5,
			},
		},
		{
			// 组件类型：标签组件
			type: "tags",
			// 是否启用该组件
			enable: true,
			// 是否在文章详情页显示
			showOnPostPage: true,
			// 响应式配置
			responsive: {
				// 折叠阈值：当标签数量超过20个时自动折叠
				collapseThreshold: 20,
			},
		},
		{
			// 组件类型：站点统计组件
			type: "stats",
			// 是否启用该组件
			enable: true,
			// 是否在文章详情页显示
			showOnPostPage: true,
		},
	],
};
</file>

<file path="config/siteConfig.ts">
import type { SiteConfig } from "@/types/config";
import { fontConfig } from "./fontConfig";

// 定义站点语言
// 语言代码，例如：'zh_CN', 'zh_TW', 'en', 'ja', 'ru'。
const SITE_LANG = "zh_CN";

export const siteConfig: SiteConfig = {
    // 站点标题
    title: "Horean",

    // 站点副标题
    subtitle: "Spread the knowledge wisely & widely.",

    // 站点 URL
    site_url: "https://blog.hxrch.top",

    // 站点描述
    description:
        "Horean's Blog - Spread the knowledge wisely and widely.",

    // 站点关键词
    keywords: [
        "Firefly",
        "Fuwari",
        "Astro",
        "ACGN",
        "博客",
        "技术博客",
        "静态博客",
        "Horean",
        "Blog",
    ],

    // 主题色
    themeColor: {
        // 主题色的默认色相，范围从 0 到 360。例如：红色：0，青色：200，蓝绿色：250，粉色：345
        hue: 165,
        // 是否对访问者隐藏主题色选择器
        fixed: true,
        // 默认模式："light" 亮色，"dark" 暗色，"system" 跟随系统
        defaultMode: "system",
    },

    // 页面整体宽度（单位：rem）
    // 数值越大可以让页面内容区域更宽
    pageWidth: 100,

    // 网站Card样式配置
    card: {
        // 是否开启卡片边框和阴影，开启后让网站更有立体感
        border: true,
    },

    // Favicon 配置
    favicon: [
        {
            // 图标文件路径
            src: "https://img.hxrch.top/brfav64.webp",
            // 可选，指定主题 'light' | 'dark'
            // theme: "light",
            // 可选，图标大小
            // sizes: "32x32",
        },
    ],

    // 导航栏配置
    navbar: {
        // 导航栏Logo
        // 支持三种类型：
        // 1. Astro图标库: { type: "icon", value: "material-symbols:home-pin-outline" }
        // 2. 本地图片（public目录，不优化）: { type: "image", value: "/assets/images/logo.webp", alt: "Logo" }
        // 3. 本地图片（src目录，自动优化但会增加构建时间，推荐）: { type: "image", value: "assets/images/logo.webp", alt: "Logo" }
        // 4. 网络图片: { type: "url", value: "https://example.com/logo.png", alt: "Logo" }
        logo: {
            type: "url",
            value: "https://img.hxrch.top/brfav64.webp",
            alt: "🍀",
        },
        // 导航栏标题
        title: "Horean's Blog",
        // 全宽导航栏，导航栏是否占满屏幕宽度，true：占满，false：不占满
        widthFull: false,
        // 导航栏图标和标题是否跟随主题色
        followTheme: false,
    },

    // 站点开始日期，用于统计运行天数
    siteStartDate: "2023-05-27 17:26:47",

    // 站点时区（IANA 时区字符串），用于格式化bangumi、rss里的构建日期时间等等..
    // 示例："Asia/Shanghai", "UTC", 如果为空，则按照构建服务器的时区进行时区转换
    timezone: "Asia/Shanghai",

    // 提醒框（Admonitions）配置，修改后需要重启开发服务器才能生效
    // 主题：'github' | 'obsidian' | 'vitepress'，每个主题风格和语法不同，可根据喜好选择
    rehypeCallouts: {
        theme: "obsidian",
    },

    // 文章页底部的"上次编辑时间"卡片开关
    showLastModified: true,

    // 文章过期阈值（天数），超过此天数才显示"上次编辑"卡片
    outdatedThreshold: 90,

    // 是否开启分享海报生成功能
    sharePoster: true,

    // OpenGraph图片功能,注意开启后要渲染很长时间，不建议本地调试的时候开启
    generateOgImages: false,

    // bangumi配置
    bangumi: {
        // Bangumi用户ID
        userId: "1217246",
    },

    // 页面开关配置 - 控制特定页面的访问权限，设为false会返回404
    // bangumi的数据为编译时获取的，所以不是实时数据，请配置bangumi.userId
    pages: {
        // 赞助页面开关
        sponsor: true,
        // 留言板页面开关，需要配置评论系统
        guestbook: true,
        // 番组计划页面开关，含追番、游戏、书籍和音乐，dev调试时只获取一页数据，build才会获取全部数据
        bangumi: false,
    },

    // 分类导航栏开关，在首页和归档页顶部显示分类快捷导航
    categoryBar: true,

    // 文章列表布局配置
    postListLayout: {
        // 默认布局模式："list" 列表模式（单列布局），"grid" 网格模式（多列布局）
        defaultMode: "list",
        // 是否允许用户切换布局
        allowSwitch: false,
        // 网格布局配置，仅在 defaultMode 为 "grid" 或允许切换布局时生效
        grid: {
            // 是否开启瀑布流布局，同时有封面图和无封面图的混合文章推荐开启
            masonry: false,
            // 网格模式列数：2 或 3
            // 2列是默认模式，在任何侧边栏配置下均可生效
            // 3列模式仅在单侧边栏（或无侧边栏）时生效，
            columns: 3,
        },
    },

    // 分页配置
    pagination: {
        // 每页显示的文章数量
        postsPerPage: 10,
    },

    // 统计分析
    analytics: {
        // Google Analytics ID
        googleAnalyticsId: "",
        // Microsoft Clarity ID
        microsoftClarityId: "",
    },

    // 图像优化及响应式配置
    // 图像优化压缩只保留avif或webp
    // 响应式图像是为在不同设备上提高性能而调整的图像。这些图像可以调整大小以适应其容器，并且可以根据访问者的屏幕尺寸和分辨率以不同的大小提供。
    // Astro 仅能对 src 目录下的图像进行优化，src 目录下的图像越多，构建时间会越长
    // Astro 图像文档 https://docs.astro.build/zh-cn/guides/images/
    imageOptimization: {
        // 输出图片格式
        // - "avif": 仅输出 AVIF 格式（最新技术，最小体积，目前兼容性较低）
        // - "webp": 仅输出 WebP 格式（体积适中，兼容性好）
        // - "both": 同时输出 AVIF 和 WebP（推荐，浏览器自动选择最佳格式）
        formats: "webp",
        // 图片压缩质量 (1-100)，值越低体积越小但质量越差，推荐 70-85
        quality: 85,
    },

    // 字体配置
    // 在src/config/fontConfig.ts中配置具体字体
    font: fontConfig,

    // 站点语言，在本配置文件顶部SITE_LANG定义
    lang: SITE_LANG,
};
</file>

<file path="config/sponsorConfig.ts">
import type { SponsorConfig } from "../types/config";

export const sponsorConfig: SponsorConfig = {
	// 页面标题，如果留空则使用 i18n 中的翻译
	title: "",

	// 页面描述文本，如果留空则使用 i18n 中的翻译
	description: "",

	// 赞助用途说明
	usage:
		"您的赞助将用于服务器维护、内容创作和功能开发，帮助我持续提供优质内容。",

	// 是否显示赞助者列表
	showSponsorsList: true,

	// 是否在文章详情页底部显示赞助按钮
	showButtonInPost: true,

	// 赞助方式列表
	methods: [
		{
			name: "支付宝",
			icon: "fa7-brands:alipay",
			// 收款码图片路径（需要放在 public 目录下）
			qrCode: "/assets/images/sponsor/alipay0.png",
			link: "",
			description: "使用 支付宝 扫码赞助",
			enabled: true,
		},
		{
			name: "微信",
			icon: "fa7-brands:weixin",
			qrCode: "/assets/images/sponsor/wechat0.png",
			link: "",
			description: "使用 微信 扫码赞助",
			enabled: true,
		},
		{
			name: "ko-fi",
			icon: "simple-icons:kofi",
			qrCode: "",
			link: "https://ko-fi.com/horean/",
			description: "Buy a Coffee for Horean",
			enabled: false,
		},
		{
			name: "爱发电",
			icon: "simple-icons:afdian",
			qrCode: "",
			link: "https://afdian.com/a/Horean0574",
			description: "通过 爱发电 进行赞助",
			enabled: true,
		},
	],

	// 赞助者列表（可选）
	sponsors: [
		/*// 示例：已实名赞助者
		{
			name: "夏叶",
			amount: "¥50",
			date: "2025-10-01",
			message: "感谢分享！",
		},

		// 示例：匿名赞助者
		{
			name: "匿名用户",
			amount: "¥20",
			date: "2025-10-01",
		},*/
	],
};
</file>

<file path="constants/constants.ts">
export const PAGE_SIZE = 8;

export const LIGHT_MODE = "light",
	DARK_MODE = "dark",
	SYSTEM_MODE = "system";
export const DEFAULT_THEME = LIGHT_MODE; // 仅作为向后兼容的默认值，实际使用 siteConfig.themeColor.defaultMode

// Wallpaper modes
export const WALLPAPER_BANNER = "banner",
	WALLPAPER_OVERLAY = "overlay",
	WALLPAPER_NONE = "none";

// Banner height unit: vh
export const BANNER_HEIGHT = 35;
export const BANNER_HEIGHT_EXTEND = 30;
export const BANNER_HEIGHT_HOME = BANNER_HEIGHT + BANNER_HEIGHT_EXTEND;

// The height the main panel overlaps the banner, unit: rem
export const MAIN_PANEL_OVERLAPS_BANNER_HEIGHT = 3.5;

// Page width: rem
export const PAGE_WIDTH = 100;

// Category constants
export const UNCATEGORIZED = "uncategorized";
</file>

<file path="constants/icon.ts">
import type { Favicon } from "@/types/config.ts";

export const defaultFavicons: Favicon[] = [
	{
		src: "/favicon/favicon-light-32.png",
		theme: "light",
		sizes: "32x32",
	},
	{
		src: "/favicon/favicon-light-128.png",
		theme: "light",
		sizes: "128x128",
	},
	{
		src: "/favicon/favicon-light-180.png",
		theme: "light",
		sizes: "180x180",
	},
	{
		src: "/favicon/favicon-light-192.png",
		theme: "light",
		sizes: "192x192",
	},
	{
		src: "/favicon/favicon-dark-32.png",
		theme: "dark",
		sizes: "32x32",
	},
	{
		src: "/favicon/favicon-dark-128.png",
		theme: "dark",
		sizes: "128x128",
	},
	{
		src: "/favicon/favicon-dark-180.png",
		theme: "dark",
		sizes: "180x180",
	},
	{
		src: "/favicon/favicon-dark-192.png",
		theme: "dark",
		sizes: "192x192",
	},
];
</file>

<file path="constants/icons.ts">
/**
 * 自动生成的图标数据文件
 * 由 scripts/generate-icons.js 在构建时生成
 * 请勿手动编辑此文件
 */

const iconSvgData: Record<string, string> = {
	"fa7-solid:arrow-right":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 640 640"><path fill="currentColor" d="M566.6 342.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L466.7 288H96c-17.7 0-32 14.3-32 32s14.3 32 32 32h370.7L361.3 457.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/></svg>',
	"fa7-solid:arrow-rotate-left":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 640 640"><path fill="currentColor" d="M320 128c-56.8 0-107.9 24.7-143.1 64H224c17.7 0 32 14.3 32 32s-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V96c0-17.7 14.3-32 32-32s32 14.3 32 32v54.7C174.9 97.6 243.5 64 320 64c141.4 0 256 114.6 256 256S461.4 576 320 576c-87 0-163.9-43.4-210.1-109.7c-10.1-14.5-6.6-34.4 7.9-44.6s34.4-6.6 44.6 7.9c34.8 49.8 92.4 82.3 157.6 82.3c106 0 192-86 192-192S426 128 320 128"/></svg>',
	"fa7-solid:chevron-right":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 640 640"><path fill="currentColor" d="M471.1 297.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L403.2 320L233.9 150.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/></svg>',
	"material-symbols:airwave-rounded":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M18.75 8.65q-.675.675-1.55 1.025t-1.75.35t-1.725-.337T12.2 8.65l-1.875-1.875q-.375-.375-.85-.562T8.5 6.025t-.975.188t-.85.562L5.5 7.95q-.3.3-.7.288t-.7-.313t-.3-.712t.3-.713l1.15-1.15q.675-.675 1.525-1.012T8.5 4t1.713.337t1.512 1.013L13.6 7.225q.4.4.875.588T15.45 8t.988-.187t.887-.588L18.5 6.05q.3-.3.713-.3t.712.3t.3.713t-.3.712zm0 5q-.675.675-1.537 1.013T15.474 15t-1.737-.337T12.2 13.65l-1.875-1.875q-.375-.375-.85-.562t-.975-.188t-.975.188t-.85.562L5.5 12.95q-.275.275-.687.288T4.1 12.95q-.3-.275-.312-.7t.287-.725L5.25 10.35q.675-.675 1.525-1.012T8.5 9t1.713.338t1.512 1.012l1.875 1.875q.4.4.875.588t.975.187t.988-.187t.887-.588L18.5 11.05q.3-.3.713-.3t.712.3t.3.713t-.3.712zm-.025 5q-.675.675-1.525 1.013T15.475 20t-1.737-.337T12.2 18.65l-1.9-1.875q-.375-.375-.85-.562t-.975-.188t-.975.188t-.85.562L5.475 17.95q-.275.275-.687.288t-.713-.288q-.275-.275-.275-.7t.275-.7l1.175-1.2q.675-.675 1.525-1.012T8.5 14t1.713.338t1.512 1.012l1.875 1.875q.4.4.888.588t.987.187t.975-.187t.875-.588L18.5 16.05q.3-.3.7-.288t.7.313q.275.3.288.7t-.288.7z"/></svg>',
	"material-symbols:brightness-auto-outline-rounded":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M10.2 13.7h3.65l.625 1.825q.075.2.263.338t.412.137q.375 0 .588-.312t.087-.663l-2.85-7.55q-.075-.225-.275-.35T12.275 7h-.55q-.225 0-.425.125t-.275.35L8.175 15q-.125.35.088.675t.612.325q.25 0 .438-.137t.262-.363zm.45-1.3l1.3-3.75h.1l1.3 3.75zm-2 7.6H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12t.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5t.738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737t-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5t-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"/></svg>',
	"material-symbols:check":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m9.55 18l-5.7-5.7l1.425-1.425L9.55 15.15l9.175-9.175L20.15 7.4z"/></svg>',
	"material-symbols:check-circle":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m10.6 16.6l7.05-7.05l-1.4-1.4l-5.65 5.65l-2.85-2.85l-1.4 1.4zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"/></svg>',
	"material-symbols:dark-mode-outline-rounded":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21q-3.775 0-6.387-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.325-.05.575.088t.4.362t.163.525t-.188.575q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.275-.175.563-.162t.512.137q.25.125.388.375t.087.6q-.35 3.45-2.937 5.725T12 21m0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19m-.25-6.75"/></svg>',
	"material-symbols:download":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m12 16l-5-5l1.4-1.45l2.6 2.6V4h2v8.15l2.6-2.6L17 11zm-6 4q-.825 0-1.412-.587T4 18v-3h2v3h12v-3h2v3q0 .825-.587 1.413T18 20z"/></svg>',
	"material-symbols:hide-image-outline":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m21 18.15l-2-2V5H7.85l-2-2H19q.825 0 1.413.588T21 5zm-1.2 4.45L18.2 21H5q-.825 0-1.412-.587T3 19V5.8L1.4 4.2l1.4-1.4l18.4 18.4zM6 17l3-4l2.25 3l.825-1.1L5 7.825V19h11.175l-2-2zm4.6-3.6"/></svg>',
	"material-symbols:image-outline":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h14q.825 0 1.413.588T21 5v14q0 .825-.587 1.413T19 21zm0-2h14V5H5zm1-2h12l-3.75-5l-3 4L9 13zm-1 2V5z"/></svg>',
	"material-symbols:link":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 17H7q-2.075 0-3.537-1.463T2 12t1.463-3.537T7 7h4v2H7q-1.25 0-2.125.875T4 12t.875 2.125T7 15h4zm-3-4v-2h8v2zm5 4v-2h4q1.25 0 2.125-.875T20 12t-.875-2.125T17 9h-4V7h4q2.075 0 3.538 1.463T22 12t-1.463 3.538T17 17z"/></svg>',
	"material-symbols:search":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"/></svg>',
	"material-symbols:share":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M17 22q-1.25 0-2.125-.875T14 19q0-.15.075-.7L7.05 14.2q-.4.375-.925.588T5 15q-1.25 0-2.125-.875T2 12t.875-2.125T5 9q.6 0 1.125.213t.925.587l7.025-4.1q-.05-.175-.062-.337T14 5q0-1.25.875-2.125T17 2t2.125.875T20 5t-.875 2.125T17 8q-.6 0-1.125-.213T14.95 7.2l-7.025 4.1q.05.175.063.338T8 12t-.012.363t-.063.337l7.025 4.1q.4-.375.925-.587T17 16q1.25 0 2.125.875T20 19t-.875 2.125T17 22"/></svg>',
	"material-symbols:titlecase-rounded":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M8.6 16.925V8.6H6.425q-.35 0-.588-.225T5.6 7.8t.237-.575T6.425 7H12.5q.35 0 .575.225t.225.575t-.225.575t-.575.225h-2.2v8.325q0 .35-.25.588t-.6.237t-.6-.238t-.25-.587m6.25-5.375h-.625q-.3 0-.512-.213t-.213-.512t.213-.512t.512-.213h.625V8.75q0-.35.238-.587t.587-.238t.588.238t.237.587v1.35h1.125q.3 0 .513.213t.212.512t-.213.513t-.512.212H16.5v3.7q0 .575.263.9t.712.325h.225q.275-.025.488.187t.212.513q0 .35-.187.55t-.513.25q-.125.025-.25.025h-.25q-1.1 0-1.725-.638T14.85 15.6z"/></svg>',
	"material-symbols:wallpaper":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19v-6h2v6h6v2zm8 0v-2h6v-6h2v6q0 .825-.587 1.413T19 21zm-7-4l3-4l2.25 3l3-4L18 17zm-3-6V5q0-.825.588-1.412T5 3h6v2H5v6zm16 0V5h-6V3h6q.825 0 1.413.588T21 5v6zm-4.575-1.425Q14 9.15 14 8.5t.425-1.075T15.5 7t1.075.425T17 8.5t-.425 1.075T15.5 10t-1.075-.425"/></svg>',
	"material-symbols:wb-sunny-outline-rounded":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 3V2q0-.425.288-.712T12 1t.713.288T13 2v1q0 .425-.288.713T12 4t-.712-.288T11 3m0 19v-1q0-.425.288-.712T12 20t.713.288T13 21v1q0 .425-.288.713T12 23t-.712-.288T11 22m11-9h-1q-.425 0-.712-.288T20 12t.288-.712T21 11h1q.425 0 .713.288T23 12t-.288.713T22 13M3 13H2q-.425 0-.712-.288T1 12t.288-.712T2 11h1q.425 0 .713.288T4 12t-.288.713T3 13m16.75-7.325l-.35.35q-.275.275-.687.275T18 6q-.275-.275-.288-.687t.263-.713l.375-.375q.275-.3.7-.3t.725.3t.288.725t-.313.725M6.025 19.4l-.375.375q-.275.3-.7.3t-.725-.3t-.288-.725t.313-.725l.35-.35q.275-.275.688-.275T6 18q.275.275.288.688t-.263.712m12.3.35l-.35-.35q-.275-.275-.275-.687T18 18q.275-.275.688-.287t.712.262l.375.375q.3.275.3.7t-.3.725t-.725.288t-.725-.313M4.6 6.025l-.375-.375q-.3-.275-.3-.7t.3-.725t.725-.288t.725.313l.35.35q.275.275.275.688T6 6q-.275.275-.687.288T4.6 6.025M7.75 16.25Q6 14.5 6 12t1.75-4.25T12 6t4.25 1.75T18 12t-1.75 4.25T12 18t-4.25-1.75m7.088-1.412Q16 13.675 16 12t-1.162-2.838T12 8T9.162 9.163T8 12t1.163 2.838T12 16t2.838-1.162M12 12"/></svg>',
	"svg-spinners:ring-resize":
		'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g stroke="currentColor"><circle cx="12" cy="12" r="9.5" fill="none" stroke-linecap="round" stroke-width="3"><animate attributeName="stroke-dasharray" calcMode="spline" dur="1.5s" keySplines="0.42,0,0.58,1;0.42,0,0.58,1;0.42,0,0.58,1" keyTimes="0;0.475;0.95;1" repeatCount="indefinite" values="0 150;42 150;42 150;42 150"/><animate attributeName="stroke-dashoffset" calcMode="spline" dur="1.5s" keySplines="0.42,0,0.58,1;0.42,0,0.58,1;0.42,0,0.58,1" keyTimes="0;0.475;0.95;1" repeatCount="indefinite" values="0;-16;-59;-59"/></circle><animateTransform attributeName="transform" dur="2s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></g></svg>'
};

/**
 * 根据 iconify 格式的图标名获取内联 SVG HTML
 * @param iconName 图标名称，如 "material-symbols:search"
 * @returns SVG HTML 字符串
 */
export function getIconSvg(iconName: string): string {
	return iconSvgData[iconName] || "";
}

/**
 * 检查图标是否可用
 */
export function hasIcon(iconName: string): boolean {
	return iconName in iconSvgData;
}

/**
 * 获取所有可用图标名称
 */
export function getAvailableIcons(): string[] {
	return Object.keys(iconSvgData);
}

export default iconSvgData;
</file>

<file path="constants/link-presets.ts">
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { LinkPreset, type NavBarLink } from "@/types/config";

export const LinkPresets: { [key in LinkPreset]: NavBarLink } = {
	[LinkPreset.Home]: {
		name: i18n(I18nKey.home),
		url: "/",
		icon: "material-symbols:home",
	},
	[LinkPreset.About]: {
		name: i18n(I18nKey.about),
		url: "/about/",
		icon: "material-symbols:person",
	},
	[LinkPreset.Archive]: {
		name: i18n(I18nKey.archive),
		url: "/archive/",
		icon: "material-symbols:archive",
	},
	[LinkPreset.Friends]: {
		name: i18n(I18nKey.friends),
		url: "/friends/",
		icon: "material-symbols:group",
	},
	[LinkPreset.Sponsor]: {
		name: i18n(I18nKey.sponsor),
		url: "/sponsor/",
		icon: "material-symbols:favorite",
	},
	[LinkPreset.Guestbook]: {
		name: i18n(I18nKey.guestbook),
		url: "/guestbook/",
		icon: "material-symbols:chat",
	},
	[LinkPreset.Bangumi]: {
		name: i18n(I18nKey.bangumi),
		url: "/bangumi/",
		icon: "material-symbols:movie",
	},
	[LinkPreset.Moments]: {
		name: i18n(I18nKey.moments),
		url: "/moments/",
		icon: "material-symbols:android-chat-outline",
	},
};
</file>

<file path="content.config.ts">
import { defineCollection } from "astro:content";
import { glob } from "astro/loaders";
import { z } from "astro/zod";

const postsCollection = defineCollection({
	loader: glob({ pattern: "**/*.{md,mdx}", base: "./src/content/posts" }),
	schema: z.object({
		title: z.string(),
		published: z.date(),
		updated: z.date().optional(),
		draft: z.boolean().optional().default(false),
		description: z.string().optional().default(""),
		image: z.string().optional().default(""),
		tags: z.array(z.string()).optional().default([]),
		category: z.string().optional().nullable().default(""),
		lang: z.string().optional().default(""),
		pinned: z.boolean().optional().default(false),
		author: z.string().optional().default(""),
		sourceLink: z.string().optional().default(""),
		licenseName: z.string().optional().default(""),
		licenseUrl: z.string().optional().default(""),
		comment: z.boolean().optional().default(true),

		/* For internal use */
		prevTitle: z.string().default(""),
		prevSlug: z.string().default(""),
		nextTitle: z.string().default(""),
		nextSlug: z.string().default(""),
	}),
});

const specCollection = defineCollection({
	loader: glob({ pattern: "**/*.{md,mdx}", base: "./src/content/spec" }),
	schema: z.object({}),
});

export const collections = {
	posts: postsCollection,
	spec: specCollection,
};
</file>

<file path="content/posts/【实用技巧】-如何解决双重根式化简.md">
---
title: 【实用技巧】 如何解决双重根式化简
published: 2025-05-03
updated: 2025-07-09
draft: false
tags: [数学, 代数, 二次根式, 化简]
category: 数学
image: https://img.hxrch.top/202507202322932.webp
description: 这篇文章详细介绍了初高中常见的双重根式化简方法，特别是在三角函数计算中的应用。作者通过待定系数法说明如何将一般形式的双重根式化简。文章提供了模型分析、实例讲解和练习题，帮助读者理解化简过程以及判别双重根式是否可化简的条件。
---

> 这篇文章我会详细介绍初高中常见的双重根式化简问题，这尤其常见于三角函数计算中。

先来看可化简双重根式的一般形式：$S=\sqrt{a\pm\sqrt{b}}$

那么该式中如何去掉最外层的根号呢，或者说检验它可否被化简，以下我将运用**待定系数法**来讲解。

---

## 模型分析及证明

首先观察原式，有 $a,b$ 为正有理数，亦可知 $S$ 化简后应为 $\sqrt{m}\pm\sqrt{n}$ 的形式，且 $m,n$ 为正有理数，那么我们可以令 $\sqrt{m}\pm\sqrt{n}=\sqrt{a\pm\sqrt{b}}$

等式两边同时平方即得 $m+n\pm2\sqrt{mn}=a\pm\sqrt{b}$

因为 $m,n,a,b$ 都为正有理数，所以不妨令 $\begin{cases}m+n=a,\\\pm2\sqrt{mn}=\pm\sqrt{b}\end{cases}$ <small style="color: gray;">（待定系数法）</small>

化简即 $\begin{cases}m+n=a,\\mn=\frac{b}{4}\end{cases}$

看到这样一个方程组，想必大家都很熟悉，这不就是韦达定理么。

所以下一步是构造一个关于 $x$ 的一元二次方程，使 $m,n$ 为其两根，则有 $\begin{aligned}x^2-ax+\frac{b}{4}=0\end{aligned}$

其判别式为 $\begin{aligned}\Delta =(-a)^2-4\times 1\cdot \frac{b}{4}=a^2-b\end{aligned}$

则 $\begin{aligned}x=\frac{a\pm \sqrt{a^2-b}}{2\times 1}\end{aligned}$，得 $\begin{aligned}m=\frac{a+\sqrt{a^2-b}}{2},n=\frac{a-\sqrt{a^2-b}}{2}\end{aligned}$

因为 $m,n$ 为正有理数，所以**条件为判别式 $\Delta=a^2-b$ 为可开尽方的有理数**

最后即可得 $\begin{aligned}\sqrt{a\pm\sqrt{b}}=\sqrt{\frac{a+\sqrt{a^2-b}}{2}}\pm\sqrt{\frac{a-\sqrt{a^2-b}}{2}}\end{aligned}$

---

## 例题精讲

接下来我们看几道例题。

1. 化简 $\sqrt{8+4\sqrt{3}}$ .

   $解：由题，知\Delta=8^2-4^2\times3=16$

   $\begin{aligned}\therefore 原式&=\sqrt{\frac{8+\sqrt{16}}{2}}+\sqrt{\frac{8-\sqrt{16}}{2}}\\&=\sqrt{6}+\sqrt{2}\end{aligned}$

2. 化简 $\sqrt{7-3\sqrt{5}}$ .

   $解：由题，知\Delta=7^2-3^2\times 5=4$

   $\begin{aligned}\therefore 原式&=\sqrt{\frac{7+\sqrt{4}}{2}}-\sqrt{\frac{7-\sqrt{4}}{2}}\\&=\sqrt{\frac{9}{2}}-\sqrt{\frac{5}{2}}\\&=\frac{3\sqrt{2}-\sqrt{10}}{2}\end{aligned}$

---

## 习题检验

最后，给大家留几道习题。

1. 判断 $\sqrt{5+2\sqrt{5}}$ 能否被化简：若能，则写出化简后的结果；若不能，请说明理由.
2. 判断 $\sqrt{37-12\sqrt{7}}$ 能否被化简：若能，则写出化简后的结果；若不能，请说明理由.
3. 已知 $\cos\theta=\frac{3\sqrt{2}}{5}$，运用公式 $\tan\frac{\theta}{2}=\sqrt{\frac{1-\cos\theta}{1+\cos\theta}}$，计算 $\tan(90\degree -\frac{\theta}{2})$ 的值.

> 习题的过程及答案将会另篇揭晓，留心关注哦~
</file>

<file path="content/posts/【探究】含60°角的三角形.md">
---
title: 【探究】 含60°角的三角形
tags: [数学, 几何, 平面几何, 三角形, 60°, 等边三角形, 圆, 三角函数]
category: 数学
image: https://img.hxrch.top/202408160818466.webp
description: 在这篇文章中，作者探讨了一个几何问题，即在三角形ABC中，如果∠A=60°，则仅在ABC为等边三角形时满足AB + AC = 2BC。作者提供了两种证明方法，首先通过构造等边三角形进行边角关系的比较，其次通过圆和三角函数的方法推导出结论。文章呼吁读者用发散性思维来解决数学问题。
published: 2024-07-29 15:19:19+08
updated: 2025-05-24 20:45:47+08
---


>  这边也是很久没有更新博客了，今天水一个博客顶一顶

# 前言

就在不久前的一次数学测试中：我发现了一道稍有难度而又不失乐趣的题目，我把其中的一个步骤抽象成了这样一道几何题：

$在\triangle ABC中，\angle A=60\degree，求证：仅当\triangle ABC为等边三角形时，满足AB+AC=2BC.$

![](https://img.hxrch.top/202408160818466.webp)

# 经过

然而，在经过我 ~~一夜未寝~~ 的奋斗后，我给出了两种证明方法。见下。

## 证明方法1 - 从特殊三角形出发

> 构造等边三角形，再比较 (AB+AC) 与 2BC 的平方间的关系.

![](https://img.hxrch.top/202408160819989.webp)

### 辅助线

$在\triangle ABC内构造等边三角形ABD，点D在线段AC上，过点B作BH\perp AC于点H.$

### 证明过程

$设AB=a, CD=b$

$在等边\triangle ABC中, AB=BD$

$\because BH \perp AD$

$\therefore AH=DH=\frac{1}{2}AD=\frac{1}{2}a$

$\therefore CH=DH+CD=\frac{1}{2}a+b$

$在Rt\triangle ABH中, \angle BAH=60\degree$

$\therefore BH=AH\cdot \tan{60\degree}=\frac{1}{2}a\cdot \sqrt{3}=\frac{\sqrt{3}}{2}a$

$在Rt\triangle BCH中,根据勾股定理,$

$BC^2=BH^2+CH^2=(\frac{\sqrt{3}}{2}a)^2+(\frac{1}{2}a+b)^2=a^2+b^2+ab$

$\therefore (2BC)^2=4BC^2=4(a^2+b^2+ab)=4a^2+4b^2+4ab$

$\because (AB+AC)^2=(a+a+b)^2=4a^2+b^2+4ab$

$\therefore (2BC)^2-(AB+AC)^2=3b^2\neq 0$

$\therefore 原命题得证.$

### 小结 

利用特殊三角形的特殊角度证明普通三角形的边角关系，从已知到未知，是一种很值得锻炼的数学思维。

## 证明方法2 - 遇事不决，圆来解决！

> 作这个含60°角的三角形的外接圆，利用三角函数表示三个弦长之间的关系

![](https://img.hxrch.top/202408161012123.webp)

### 辅助线

$作\triangle ABC的外接圆O，连接OA，OB，OC，$

$过点O作OP\perp AB于点P，OQ\perp BC于点Q，OR\perp AC于点R.$

### 证明过程

$设\odot O的半径长为r，\angle AOB=2\alpha ，\angle AOC=2\beta$

$在\odot O中，\because \angle A=60\degree$

$\therefore \angle BOC=2\angle A=120\degree$

$\because OB=OC,OQ\perp BC$

$\therefore \angle BOQ=\frac{1}{2}\angle BOC=60\degree,BC=2BQ$

$\therefore BC=2BQ=2(OB\cdot \sin{60\degree})=2(r\cdot \frac{\sqrt{3}}{2})=\sqrt{3}r$

$同理AB=2r\cdot \sin{\alpha},AC=2r\cdot \sin{\beta}$

$\because \angle AOB+\angle AOC+\angle BOC=360\degree$

$即2\alpha +2\beta +120\degree=360\degree$

$\therefore \alpha + \beta = 120\degree$

$则AB+AC=2r\cdot (\sin{\alpha}+\sin(120\degree -\alpha))=2\sqrt{3}r\cdot \sin(\alpha +30\degree)$

$令AB+AC=2BC,即2\sqrt{3}r\cdot \sin(\alpha +30\degree)=2\sqrt{3}r$

$又\because \alpha >0\degree,\therefore 解得\alpha =60\degree$

$此时\angle AOB=\angle AOC=120\degree 即\triangle ABC为等边三角形$

$\therefore 仅当\triangle 为等边三角形时，才满足AB+AC=2BC$

$\therefore 原命题得证$

### 小结

只要有一定的知识储备量，没有什么事情是圆和三角函数解决不了的！

## 总结

这道命题需要大家发散思维，~~努力回顾初高中所学~~，不断打磨自己......
</file>

<file path="content/posts/【习题解析】-如何解决双重根式化简.md">
---
title: 【习题解析】 如何解决双重根式化简
tags: [数学, 代数, 二次根式, 化简, 解析]
category: 数学
published: 2025-07-05 14:05:49+08
updated: 2025-07-05 14:14:47+08
---


## 习题完整解析

1. 判断 $\sqrt{5+2\sqrt{5}}$ 能否被化简：若能，则写出化简后的结果；若不能，请说明理由.

   $解：由题，知\Delta=5^2-2^2\times5=5$

   $\because5不是可开尽方的有理数$

   $\therefore原式不能被化简$

2. 判断 $\sqrt{37-12\sqrt{7}}$ 能否被化简：若能，则写出化简后的结果；若不能，请说明理由.

   $解：由题，知\Delta=37^2-12^2\times7=361=19^2$

   $\begin{aligned}\therefore 原式&=\sqrt{\frac{37+19}{2}}-\sqrt{\frac{37-19}{2}}\\&=\sqrt{\frac{56}{2}}-\sqrt{\frac{18}{2}}\\&=2\sqrt{7}-3\end{aligned}$

3. 已知 $\cos\theta=\frac{3\sqrt{2}}{5}$，运用公式 $\tan\frac{\theta}{2}=\sqrt{\frac{1-\cos\theta}{1+\cos\theta}}$，计算 $\tan(90\degree -\frac{\theta}{2})$ 的值.

   $\begin{aligned}解：由题，得\tan{\frac{\theta}{2}}&=\sqrt{\frac{1-\frac{3\sqrt{2}}{5}}{1+\frac{3\sqrt{2}}{5}}}\\&=\sqrt{\frac{5-3\sqrt{2}}{5+3\sqrt{2}}}\\&=\sqrt{\frac{43-30\sqrt{2}}{7}}\\&=\sqrt{\frac{1}{7}}\times\sqrt{43-30\sqrt{2}}\end{aligned}$

   $\therefore \Delta=43^2-900\times2=49=7^2$

   $\begin{aligned}\therefore \tan{\frac{\theta}{2}}&=\sqrt{\frac{1}{7}}\times(\sqrt{\frac{43+7}{2}}-\sqrt{\frac{43-7}{2}})\\&=\sqrt{\frac{1}{7}}(5-3\sqrt{2})\\&=\frac{5-3\sqrt{2}}{\sqrt{7}}\end{aligned}$

   $\begin{aligned}\therefore \tan{(90\degree-\frac{\theta}{2})}&=\frac{1}{\tan{\frac{\theta}{2}}}\\&=\frac{\sqrt{7}}{5-3\sqrt{2}}\\&=\frac{5\sqrt{7}+3\sqrt{14}}{7}\end{aligned}$
</file>

<file path="content/posts/2023 TYOI 暑假集训游记.md">
---
title: 2023 TYOI 暑假集训游记
tags: ["2023", TYOI, 游记]
category: 生活
description: 在一个温暖的八月，我有幸踏入了广州市某重点中学，开始了为期三周的集训之旅。这段充实而愉快的时光，让我感受到了知识的魅力和团队的力量，成为了我成长道路上的宝贵财富。
published: 2023-08-26 11:52:37+08
updated: 2024-08-16 16:09:41+08
---



在一个温暖的八月，我有幸踏入了广州市某重点中学，开始了为期三周的集训之旅。这段充实而愉快的时光，让我感受到了知识的魅力和团队的力量，成为了我成长道路上的宝贵财富。

## Activities

### Week 1

第一周的集训，像是一个带着未知色彩的启程。初到广州市某重点中学，我对未来三周的集训生活充满了期待。阳光透过窗户洒在宿舍的桌椅上，一天新的开始即将展开。

我们的第一周以一种欢乐的氛围拉开了序幕。在星期一、三、五的早晨，我们聚集在教室，老师们为我们呈现了差分约束系统、强连通分量、割点与桥等知识的精彩世界。清晰的板书，引人入胜的例题，仿佛在一幅画卷中，我们逐步揭开了计算机算法的神秘面纱。而在课间，同学们互相讨论，不仅分享了自己的理解，也互相启发着新的思考。

而在星期二、四、六的机房时光中，我们的学习变得更加生动。机房里，键盘的敲击声交织成了一曲激情四溢的乐章。每一次的对决都是一次知识的比拼，也是友谊的升华。紧张的气氛中，我们不断解题、思索，时不时地传来阵阵欢笑声。这些时刻，既是对知识的挑战，也是对团队协作和应对压力的锻炼。

而在宿舍内的夜晚，我们的欢声笑语也不曾停歇。其中，有一晚，我们玩起了一种名叫UNO的牌游戏。昏黄的灯光下，桌上摆满了五彩斑斓的UNO牌，每一张都饱含着无限的乐趣。我们一边玩牌，一边聊天，分享着彼此的趣事和经历。那一刻，欢声笑语在宿舍内回荡，仿佛把紧张的学习氛围完全驱散了。游戏中的互动，让我们更加亲近，也为整个集训增添了一份轻松和温馨。

在这个渐渐熟悉的环境中，我们渐渐融入了集训的节奏。第一周的感受，就像是一篇绚丽多彩的开篇，铺展开了我们后续三周的精彩旅程。每一个细节，都刻画着我们的成长和情感，留下了难以磨灭的记忆。

### Week 2

第二周的集训，如同一幅迷人的风景画，充满了新奇和欢乐的元素。时光在指尖流转，我们仿佛被吸引进了一个无限精彩的世界。

周一的早晨，我们再度聚集在教室，迎来了全新的知识。这周，老师们为我们呈现了并查集、最小生成树等算法。沉浸在老师的讲解中，我们仿佛置身于一个精彩的故事中，一步步地探索着知识的边界。而这一周，课程的设置更注重实践，每天的新知识都将在接下来的比赛中得到应用，这种有机融合，让学习更有意义。

星期二的机房时间，我们的学习之旅延续了下去。在那个宽敞明亮的空间里，键盘的敲击声如同一支鼓点，引领着我们进入了算法的竞技场。每一次的比赛都是一次智力的对决，也是一次对自己实力的检验。解题、分析、优化，每一个环节都要经历思考与实践的交织。而与此同时，机房里也充满了友情的味道，同学们互相鼓励、互相帮助，营造出一种积极向上的氛围。

然而，这周的精彩不仅仅限于课程和比赛。一个令人难以忘怀的时刻发生在星期天的傍晚。有同学带来了扑克牌，我们在宿舍内展开了一场扑克牌的盛宴。灯光昏黄，桌上铺满了五彩斑斓的牌，我们激烈地角逐着，笑声和惊呼此起彼伏。这种不同寻常的娱乐，仿佛为我们带来了一份难得的轻松，让我们在紧张的学习之余也能享受一份欢乐。

然而，第二周的集训时光如流水般流逝，转瞬即逝。在我们短暂而美好的相处中，我们交流着知识，分享着快乐，共同创造了一段难以磨灭的记忆。这周的每一个瞬间，都成为了我心中最珍贵的宝藏，无论是课堂上的启发，还是机房内的拼搏，抑或是宿舍内的嬉笑，都在这幅风景画中留下了鲜明的一笔。

### Week 3

第三周的集训，如同一首深情的乐曲，渐入佳境。时间的脚步匆匆，我们似乎被吸引进了一个令人陶醉的梦境。

在这周初的清晨，我站在窗前，感受着微风轻拂，似乎能够察觉到知识的气息。周一的课堂中，我们仍然在学习有关最小生成树的更多内容。老师们的讲解让这些抽象的概念变得通俗易懂，每一个知识点都如同一颗珍珠，被我们串联成了一串美丽的项链。而在星期二、三、四、五，我们投入到了紧张的比赛中，每一场的角逐都是一次思维的碰撞，也是对前期学习成果的检验。

然而，正是在这周，我们更深刻地感受到了时光的宝贵。周二的傍晚，夕阳的余辉映照下，我们聚在一起，共同度过了最后的集体学习时光。教室里，灯光温柔，同学们笔耕不辍，互相督促，临近集训结束，我们都感受到了对这段时光的珍惜。

周三，我们迎来了最后一次的比赛。在机房内，键盘的声音仿佛弹奏出了一曲壮美的乐章，每一个解题的瞬间都充满了成就感。然而，与此同时，我也能感受到一丝淡淡的离别之情。每一次的比赛都像是一个节点，将我们从一个阶段引向了另一个。我看着同学们认真的表情，仿佛能够看到彼此在这段时光里的成长。

而在这个周末的傍晚，我们走进了一片草坪，展开了一场难忘的集体活动。欢声笑语中，我们一起跑步，一起参加各种有趣的游戏。其中，捕鱼游戏尤为引人注目。大家手拉手围成一张网，活跃在规定的区域内，捕捉着彼此。这个游戏不仅锻炼了我们的团队协作能力，也增强了彼此之间的亲近感。

随着最后一天的到来，集训的画卷也即将收尾。我们合了一张珍贵的合影，记录下了这段美好的时光。而在离别的时刻，我们用游戏、欢笑和拥抱，表达出对彼此的祝愿和惜别之情。这周的每一个瞬间，都让我感受到了时光的珍贵，也让我明白了珍惜友情和每一次相聚的重要性。

第三周的集训时光短暂而美好，就像是一首感人的乐章，用欢笑、汗水和泪水交织编织而成。在这个旅程的终点，我们不仅积累了知识，更培养了坚持、合作和珍惜的品质。这段时光，定会成为我心中难以磨灭的记忆，激励着我在未来的道路上不断前行，追求更高的目标。

## Contests

| 比赛                        | 排名 | 分数 | 意外程度 |
| :-------------------------: | :--: | :--: | :-------------------------: |
| **2023 tyoi 普及模拟训练01** | $18$ | $190$ | $0.5$ |
| **2023 tyoi 普及模拟训练02** | $28$ | $260$ | $0.7$ |
| **2023 tyoi 普及模拟训练03** | $8$ | $290$ | $0.2$ |
| **2023 tyoi 普及模拟训练（B-->C）** | $5$ |$180$| $0.6$ |
| **2023 tyoi 普及模拟训练04** | $26$ | $136$ | $0.8$ |
| **2023 tyoi 普及模拟训练05** | $33$ | $110$ | $1$ |
| **2023 tyoi 普及模拟训练06** | $31$ | $37$ | $0.4$ |
| **2023 tyoi 普及模拟训练（B-->C）（LJY）** | $35$ | $140$ | $0.7$ |
| **2023 tyoi 普及模拟训练07** | $33$ | $20$ | $0.6$ |
| **2023 tyoi 普及模拟训练08** | $4$  | $220$ | $0.3$ |
| **2023 tyoi 普及模拟训练09** | $20$ | $100$ | $0.4$ |
| **平均** | - | $153$ | $0.56$ |
| **总和** | - | $1683$ | - |

对于全部的11场比赛，我不是很满意，尤其是 **2023 tyoi 普及模拟训练05**，由于前三题开了文件读写没关，痛失300分……

在 **2023 tyoi 普及模拟训练01** 中，第三题本来应该是很简单的，但是我用了差分约束系统来解决，不仅多余，而且还没有AC。其次，在第二场比赛中，第四题是考我们的思维能力，需要我们去推理。

## Knowledges

1. **差分约束系统。**
2. **强联通分量。**
3. **割点与桥。**
4. **并查集。**
5. **最小生成树。**

## Summary

除了学术方面的提升，集训也让我在团队合作和人际交往中有了更多的收获。在这段时间里，我与同学们一起吃饭、玩游戏，分享着彼此的心得和快乐。每周的体育锻炼更是让我们更亲近，通过一起跑步、锻炼肢体，我们不仅保持了身体健康，还培养了团结协作的意识。体育锻炼期间的游戏，如捕鱼和翻扑克，更是增添了欢笑和友情。捕鱼游戏中，我们手拉手围成网，体验着协作的乐趣，这让我深刻地感受到了团队的力量。

回顾这三周的集训，我感受颇深。不仅在学术上有了显著的进步，更重要的是，我领悟到了团队协作、坚持不懈的重要性。在与同学们的交流中，我学到了很多解题技巧和方法，也结交了许多志同道合的朋友。这段集训经历不仅让我在算法领域有了更扎实的基础，也培养了我坚持学习和不断进步的精神。我相信，这些收获将伴随着我在未来的学习和生活中，为我铺就更加广阔的道路。



> ChatGPT yyds...
</file>

<file path="content/posts/2023年CSP比赛游记.md">
---
title: 2023年CSP比赛游记
tags: ["2023", 游记]
category: 生活
published: 2023-09-16 22:43:49+08
updated: 2024-08-16 14:51:49+08
---

考前一天晚上，我本来用心地复习过了 _CSP_ 的主要考点啊，但是……

也许是我的能力有待提高，奥信队的老师们给我推荐报名的只有CSP的Junior组别，也就是我们常说的普及组。而我也傻乎乎地只报名了 _CSP-J_ ，失去了一次原本报名 _CSP-S_ 可能通过的机会，但过去终究是过去了，当时只能做的是眼前的未来。

考试当天，坐在车上，我心里焦躁不安，看着车窗外走过的一棵有一棵的树，一直很担心这次 _CSP-J_ 初赛不能通过，这样就更加不能指望有 _CSP-J_ 一等奖了。

一开始我还找错了考场地点，本是“广州大学附属中学大学城校区”，我却来到了“广州大学”，这使得我更加焦虑了，不过好在时间还是充足的，我顺利地来到了考场。

考场门前人山人海，好不容易找到了我们学校的团队，但我越是离考场近，我就越担心我的成绩，直至工作人员检查准考证前一秒，心里都还念叨着这次考试一定不能出错。但当我踏进教室的瞬间，我发现我所在的考场竟然有 **5位** 我们学校的同学，这次我总算是放心了一点，开始严肃面对这次考试。

今年的单项选择题与往年似乎有些差异，这次考题并没有涉及计算机的发明和由来等基础知识，而是主要考察了进制转换和类似栈、队、堆等数据类型以及图论的内容，这让我在考试时直冒冷汗，信心倍减。但这次最令我烦恼的是哈夫曼树以及树的前序、中序和后序遍历的转换，我终于意识到我最近的复习还不够深入，悔恨万分，但我也只能够面对接下来这残酷的考试。

到了阅读程序部分，总体上来说还好，并没有什么大问题；但是到了完善程序部分，我感受到了巨大的压力，尤其是第二篇的二分查找的完善代码，考察二分的细节，选项包含 `left = mid + 1` 及 `left = mid` 等等，确实很让人头疼。

总结一下，我认为今年的初赛试题要比去年的难度要高一些，对于这次 _CSP-J_ 初赛能否通过，我并没有抱有太大的希望，现在能做的只有把这件事情置之脑后。
</file>

<file path="content/posts/2025-Weekly-Diary-1st.md">
---
title: 2025 Weekly Diary 1st
tags: [英语, 周记, 生活, 作文篇章]
category: 生活
image: https://img.hxrch.top/202509062320976.webp
description: 新高一开学第一周的全英周记呢~还是有许多新鲜事情哒，欢迎前来阅读哦！
published: 2025-09-06 22:58:13+08
updated: 2025-09-06 22:58:38+08
---


> 这篇文章亦为新高一开学第一周的~~英语作业~~（老师说周记还配不上作业），要求写一篇英文周记，日后也会成为常规作业，所以每周都要写新的周记。以下为博主所著原版。

It's somewhere familiar to me. The campus didn't vary a lot but my attitude towards school has changed. It's the truth I cannot evit that I must be well prepared to confront the coming life of senior high.

Although the first week has gone and certainly it won't come back, a variety of events happened within this week are still vivid in my mind. Of all those things, I appreciate the maths class of Mr. Zhong most for the reason that he always has lessons in a genuinely fun way, which makes the whole class veiled under a convivial atmosphere. What impressed me most in Mr. Zhong's class were the "triangle into square" event while learning the necessary and sufficient condition. He just wrote a silly statement by mistake!

Some other things that fascinated me are also related to my new teacher, Doris. Leaping to the eyes were five enormous  letters DORIS carved on the screen the moment Doris switches to the next slide of PPT. They separately stand for five different meanings. Those are determination, optimistic, resilience, inspiration and success. It's said additionally that if we perform the first four ones well, we'll easily receive the last one "success"! However, I still have a question about why the last one isn't some of the advanced vocabulary?

These are all the content of my first weekly diary in the brand new semester. Look forward to the better future!

---

> 为了进一步提高我的英语写作水平，我把这篇短文交给了[DeepL Write](https://www.deepl.com/zh/write)，让它来提出一些修改建议，如下（包括修改截图和修改后的文章）。

![修改截图](https://img.hxrch.top/202509062236810.webp)

- **改后文章：**

It's a place that feels familiar to me. The campus hasn't changed much, but my attitude towards school has. I cannot deny that I must be well prepared for the challenges of senior high school life.

Although the first week has gone, the variety of events that happened this week are still vivid in my mind, even though it certainly won't come back. Of all of these, I enjoyed Mr Zhong's maths class the most because he always teaches in a genuinely fun way, creating a convivial atmosphere in the whole class. The "triangle into square" event while learning the necessary and sufficient condition impressed me the most in Mr Zhong's class. He made a silly mistake and wrote something incorrect!

Other things that fascinated me are also related to my new teacher, Doris. The moment Doris switched to the next slide of PPT, five enormous letters spelling DORIS leapt into view. They stand for five different meanings: These are determination, optimism, resilience, inspiration and success. It's also said that if we perform well in the first four areas, success will easily follow! However, I still have a question: why isn't the last one considered advanced vocabulary?

This is all the content of my first weekly diary in the brand new semester. I look forward to a better future!

---

> 这一周就先这样收尾吧（虽然还有明天周日一天），期待精彩的下一周！
</file>

<file path="content/posts/关于一道高一上压轴题的深度解析.md">
---
title: 关于一道高一上压轴题的深度解析
tags: [数学, 晚测, 高一, 代数, 函数, 代几综合, 几何, 函数图像, 方程组, 分类讨论, 一题多解]
category: 数学
description: 这篇文章深入探讨了一道高一数学晚测的压轴题，特别聚焦于题目的第三问及其三种解法。内容涵盖了题目的背景、函数图像的绘制、各个问题的解答，以及对解法优缺点的分析。通过研究函数的性质、构造方程组和推导不等式，展示了如何求解这类题目的零点、单调性和取值范围。
image: https://img.hxrch.top/20260102160050201.webp
published: 2026-01-02 07:45:23+08
updated: 2026-01-02 15:27:34+08
---


> 已经非常非常久没有更新博客了，上一次还是在开学第一周，~~虽然那一次一次性更了三篇~~。
>
> 所以在今天，迎接2026新年的第二天，我来简单弥补一下吧。

直接进入正题！

这是我校最近一道比较有意思的数学晚测题目，这篇文章将介绍其第(3)问的三种解法，各有优劣，题面如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
18.&\enspace 已知定义在区间(0,+\infty)上的函数f(x)=|x+\frac{4}{x}-5|.\\
&(1)\enspace 求函数f(x)的零点;\\
&(2)\enspace 若方程f(x)=m(m>0)有四个不等实根x_1,x_2,x_3,x_4，求证：x_1\cdot x_2\cdot x_3\cdot x_4=16;\\
&(3)\enspace 在区间[1,4]上是否存在实数a,b(a<b)，使得函数f(x)在区间[a,b]上单调，且f(x)的值域为[ma,mb]，若存在，求出m的取值范围；若不存在，请说明理由.
\end{align}
$$


## 函数图像的绘制

这道题的前两问还是是挺简单的，这里就略过了，主要是我们需要先把 $f(x)$ 的函数图像画出来，大致如下：

![函数图像](https://img.hxrch.top/20260102081710852.svg)

当然，这个函数图像还是相当好画的，而且也只用画 $x\in(0,+\infty)$ 上的图像。

具体来看，如果去掉绝对值，那这个函数本质上就是平移过后的“对勾函数”，所以最后加上绝对值时只需要把原来“对勾函数”图像的$x$轴下方的部分翻转上来即可。

## 第(1)(2)问的解答

有函数图像即可知，第(1)问的答案应为 $1$ 和 $4$。

第(2)问，我们不妨设 $x_1<x_2<x_3<x_4$，那么就只需要将四个不等实根分为两组（$x_1,x_4$ 和 $x_2,x_3$），对其分别运用韦达定理即可。

## 第(3)问

我们首先来分析一下这道题的大致解题思路：我们观察题目给定区间 $[1,4]$ 上的函数图像，仅为一段连续的曲线，且在 $[1,2]$ 上单调递增，在 $[2.4]$ 上单调递减，恰好题目又要求 $a,b\in [1,4]\enspace(a<b)$ 且 $[a,b]$ 上的函数图像**单调**。由此观之，这题逃不开**分类讨论**，对此，我们需要在解题时分为两种情况：
$$
\boldsymbol{Ⅰ.\enspace[a,b]\subseteq[1,2]}
$$

$$
\boldsymbol{Ⅱ.\enspace[a,b]\subseteq[2,4]}
$$

其次，需要注意的是，在区间 $[1,4]$ 上，函数 $f(x)$ 的解析式应写为：
$$
f(x)=-x-\frac{4}{x}+5,\enspace x\in[1,4]
$$
因为 $[1,4]$ 这段区间内的函数图像是从$x$轴下方翻转上来的，所以我们在去绝对值时需要给解析式整体取相反数。

### 方法一：纯真代数

#### Ⅰ. 若 $[a,b]\subseteq[1,2]$：

我们不难注意到，在区间 $[1,2]$ 上 $f(x)$ 的函数图像是**单调递增**的，既然 $a<b$ ，那么必然有 $f(a)<f(b)$；同时在区间 $[a,b]$ 上函数 $f(x)$ 的值域为 $[ma,mb]$，所以我们可以得到：$\left\{\begin{aligned}&f(a)=ma,\\&f(b)=mb.\end{aligned}\right.\enspace$ 即：
$$
\left\{\begin{aligned}
&-a-\frac{4}{a}+5=ma,\enspaceⅰ\\
&-b-\frac{4}{b}+5=mb.\enspaceⅱ
\end{aligned}\right.
$$
由ⅰ式，不难得到
$$
m=-\frac{4}{a^2}+\frac{5}{a}-1\enspace\enspaceⅲ
$$
既然题目要求的是 $m$ 的取值范围，那我们不难联想到可以通过 ⅲ式中 $a$ 的取值范围来确定 $m$ 的取值范围，这里我们只需要将 $\frac{1}{a}$ 当做一个整体，然后 $m$ 就是关于 $\frac{1}{a}$ 的**二次函数**了，即可利用初中知识简单求解啦。

但是现在的问题就是，我们如何求解 $\boldsymbol{a}$ **的取值范围**呢？

这时候我们再次审视题目条件，并结合此分类依据，可得一条重要的不等式链：
$$
1\leq a\lt b\leq 2
$$
到这一步思路就已经很清晰了，显然，我们需要**用** $\boldsymbol{a}$ **来表示** $\boldsymbol{b}$，这样我们就可以得到一条只含未知数 $a$ 的不等式链了，那么求解 $a$ 的取值范围不就轻而易举了吗？

为此，我们再回到最初的方程组，我们发现这两个方程形式相近，很难不想把它们相加或相减，所以我们进行以下操作：

- **ⅰ + ⅱ**，得 $-a-b-\frac{4}{a}-\frac{4}{b}+10=ma+mb$，即 $-(a+b)-\frac{4(a+b)}{ab}+10=m(a+b)$，此时再将等式两边同除以 $(a+b)$，整理得：
  $$
  m=-1-\frac{4}{ab}+\frac{10}{a+b}\enspace\enspaceⅳ
  $$
  
- **ⅰ - ⅱ**，得 $-a+b-\frac{4}{a}+\frac{4}{b}=ma-mb$，即 $-(a-b)+\frac{4(a-b)}{ab}=m(a-b)$，此时再将等式两边同除以 $(a-b)$，整理得：

$$
m=-1+\frac{4}{ab}\enspace\enspaceⅴ
$$

这时候我们通过 ⅳ式和 ⅴ式的等量代换，可以轻松得到 $-1-\frac{4}{ab}+\frac{10}{a+b}=-1+\frac{4}{ab}$，整理得：
$$
b=\frac{4a}{5a-4}
$$
将这一结果**代入刚才的不等式链**，得：
$$
1\leq a\lt\frac{4a}{5a-4}\leq 2
$$
解这一不等式链，最终可得：
$$
\frac{4}{3}\leq a\lt\frac{8}{5}
$$
所以：
$$
\frac{5}{8}\lt\frac{1}{a}\leq\frac{3}{4}
$$
此时我们已经求出 $\frac{1}{a}$ 的取值范围了！将其代入 ⅲ式的二次函数，可得：
$$
\boxed{\frac{1}{2}\leq m\lt\frac{9}{16}}
$$
<span id="surprise"></span>

#### Ⅱ. 若 $[a,b]\subseteq[2,4]$：

区别于第 Ⅰ 类，由于 $f(x)$ 的函数图像在区间 $[2,4]$ 上是单调递减的，所以最初的方程组应为 $\left\{\begin{aligned}&f(a)=mb,\\&f(b)=ma.\end{aligned}\right.\enspace$ 即：
$$
\left\{\begin{aligned}
&-a-\frac{4}{a}+5=mb,\enspaceⅵ\\
&-b-\frac{4}{b}+5=ma.\enspaceⅶ
\end{aligned}\right.
$$
但这时候，我们很难像第 Ⅰ 类一样迅速用 $a$ 表示出 $m$ 了，看起来目标就不太明确了——但是别急！虽然第一步完成不了，但这依旧不妨碍我们先做后面的步骤。

同样地，我们有：
$$
2\leq a\lt b\leq 4
$$

- **ⅵ + ⅶ**，整理得：

$$
m=-1-\frac{4}{ab}+\frac{10}{a+b}\enspace\enspaceⅷ
$$

- **ⅵ - ⅶ**，整理得：
  $$
  -m=-1+\frac{4}{ab}\enspace\enspaceⅸ
  $$
  

**ⅷ + ⅸ**，整理得：
$$
\boxed{a+b=5}
$$
天啊😱，我们惊奇地发现 $a$ 与 $b$ 的和竟然是个常数！这可是天大的好消息啊，如此一来，我们就可以用 $b$ 代换 $a$，也可以用 $a$ 来代换 $b$ 了。

那么 ⅵ式就可以转化为：
$$
-a-\frac{4}{a}+5=m(5-a)
$$
用 $a$ 来表示 $m$，即：
$$
m=1+\frac{4}{a^2-5a}\enspace\enspaceⅹ
$$
同时我们将 $b=a-5$ **代入上面的不等式链**，可得：
$$
2\leq a\lt 5-a\leq 4
$$
解得：
$$
2\leq a\lt\frac{5}{2}
$$
根据**二次函数**的性质，可得：
$$
-6\leq a^2-5a\lt -\frac{25}{4}
$$
代入 ⅹ式，最终可得：
$$
\boxed{\frac{1}{3}\leq m\lt\frac{9}{25}}
$$

#### 综上所述：

我们已经分类讨论完了两种不同情况，最后将两种情况的结果**取并集**，得到整道题的最终答案：
$$
\boxed{\large{m\in[\frac{1}{3},\frac{9}{25})\cup[\frac{1}{2},\frac{9}{16})}}
$$

### 方法二：同构方程

<span id="same"></span>

#### Ⅰ. 若 $[a,b]\subseteq[1,2]$：

与方法一类似，我们不难得到这样一组方程：
$$
\left\{\begin{aligned}
&-a-\frac{4}{a}+5=ma,\\
&-b-\frac{4}{b}+5=mb.
\end{aligned}\right.
$$
接下来，区别于方法一的点在于，我们不直接用其中一个未知量去表示另一个，而是——**构建一个新的一元二次方程**！为什么可以这样呢？因为我们发现这个方程组中两个方程的**形式完全一样**，只有未知量不同，所以我们可以把这两个未知量 $a$ 和 $b$ 看作是如下方程的**两个不等实根**：
$$
-x-\frac{4}{x}+5=mx
$$
将它整理为我们熟悉的一元二次方程，此处同时设该方程一般式等号左边为新函数 $g(x)$：
$$
g(x)=(m+1)x^2-5x+4=0
$$
这时候这道题就已经转化为**一元二次方程中根的分布**的问题了，在此题条件下，该一元二次方程要在区间 $[1,2]$ 中有两个不等实根。

到这里，又由于 $m\geq0$（因为在区间 $[1,2]$ 上函数 $f(x)$ 的图像在$x$轴上或其上方即 $f(a)=ma\geq 0,f(b)=mb\geq 0$，又因为 $a,b$ 为正数，所以 $m\geq 0$），所以该方程二次项系数为正，那么我们就可以直接列出下列不等式组啦：（其中 $-\frac{-5}{2(m+1)}$ 为 $g(x)$ 函数图像即抛物线的对称轴的横坐标）
$$
\left\{\begin{aligned}
&\Delta\gt 0,\\
&g(1)\geq 0,\\
&g(2)\geq 0,\\
&1\lt -\frac{-5}{2(m+1)}\lt 2.
\end{aligned}\right.
$$
解该不等式组，可得：
$$
\boxed{\frac{1}{2}\leq m\lt\frac{9}{16}}
$$

<span id="same2"></span>

#### Ⅱ. 若 $[a,b]\subseteq[2,4]$：

同样地，我们先列出方程组：
$$
\left\{\begin{aligned}
&-a-\frac{4}{a}+5=mb,\\
&-b-\frac{4}{b}+5=ma.
\end{aligned}\right.
$$
与[*方法一的第 Ⅱ 类情况*](#surprise)相同，我们可以得到：
$$
\boxed{a+b=5}
$$
经过代换，于是：
$$
\left\{\begin{aligned}
&-a-\frac{4}{a}+5=m(5-a),\\
&-b-\frac{4}{b}+5=m(5-b).
\end{aligned}\right.
$$
同构：
$$
-x-\frac{4}{x}+5=m(5-x)
$$
整理并设该一元二次方程一般式等号左边为新函数 $h(x)$：
$$
h(x)=(m-1)x^2-5(m-1)x-4=0
$$
与第 Ⅰ 类不同的是，我们现在不能马上判断出该方程二次项系数 $m-1$ 的正负，所以——这里我们可以尝试利用**反证法**的思路。

- 假设 $m=1$：

  则 $h(x)=-4\neq 0$，与题意矛盾，故 $m\neq 1$

- 假设 $m>1$：

  因为 $a+b=5,\enspace a,b\in[2,4],\enspace a\lt b$，所以不妨取 $a=2,b=3$，又因为 $f(a)=mb$，所以 $f(2)=3m\gt 3$；

  而由 $f(x)$ 原解析式 $f(x)=|x+\frac{4}{x}-5|$ 可知 $f(2)=1\lt 3$；

  两者矛盾，故 $m\leq 1$

综上所述，$m<1$ 即 $m-1<0$.

至此，我们已较为简便地判断出了该方程二次项系数为负，接下来就同第 Ⅰ 类，可以直接列出下列**一元二次方程根的分布**不等式组了：（其中 $-\frac{-5(m-1)}{2(m-1)}$ 为 $h(x)$ 函数图像即抛物线的对称轴的横坐标）
$$
\left\{\begin{aligned}
&\Delta\gt 0\\
&h(2)\leq0\\
&h(4)\leq0\\
&2\lt -\frac{-5(m-1)}{2(m-1)}\lt 4
\end{aligned}\right.
$$
解该不等式组，可得：
$$
\boxed{\frac{1}{3}\leq m\lt\frac{9}{25}}
$$

#### 综上所述：

分类讨论结束后，我们同样对两个结果**取并集**：
$$
\boxed{\large{m\in[\frac{1}{3},\frac{9}{25})\cup[\frac{1}{2},\frac{9}{16})}}
$$

### 方法三：数形结合

> 这一种方法的名字一听就很特别吧，那当然——因为这一方法**是我博主本人想到的**！在班上分享完后还被老师夸了呢！

这一种方法不需要几何脑，也不需要代数脑，几何代数它都只各沾了一点边，所以用这种方法就可以~~嘲讽出题老师没有水平~~显得这道题比较简单。

分类讨论之前，我们不妨先在 $f(x)$ 的函数图像上取两个点 $A(a,f(a)),\enspace B(b,f(b))$.（$a,b$ 均为题中所给的未知量）

#### Ⅰ. 若 $[a,b]\subseteq[1,2]$：

因为在此区间内 $f(x)$ **单调递增**，所以 $\left\{\begin{aligned}&f(a)=ma,\\&f(b)=mb.\end{aligned}\right.$，那么就有：
$$
A(a,ma),\enspace B(b,mb)
$$
可以得到直线 $AB$ 的解析式为：
$$
l_{AB}:y=mx
$$
不难发现，直线 $AB$ **始终经过原点**，为正比例函数，而且其斜率为 $m$。那么接下来就好办了，我们只需要让直线 $AB$ 与 $y=f(x),\enspace x\in[1,2]$ 的图像（这一段图像下文简称“曲线”）**恰好有两个交点**，即符合题意。那我们不妨先把草图画出来：

![方法三-第 Ⅰ 类](https://img.hxrch.top/20260102144516831.svg)

通过草图，我们可以发现：在直线 $AB$ 与曲线相切时其斜率取到**最大值**，在经过点 $(2,1)$ 时其斜率取到**最小值**。

这么看来，我们只需要分别求出直线 $AB$ 在与曲线相切和经过点 $(2,1)$ 时的斜率即可求出 $m$ 的取值范围。

- 与曲线相切：
  $$
  mx=f(x),\enspace x\in[1,2]
  $$
  转化为一元二次方程，即：
  $$
  (m+1)x^2-5x+4=0
  $$
  这个方程看起来是不是有点眼熟？没错，它就是[*方法二第 Ⅰ 类*](#same)所构造出的方程！但是在这里，我们只需要**令其判别式等于零**即可求出相切情况的斜率。

  最终解得：
  $$
  \boxed{m=\frac{9}{16}}
  $$

- 经过点 $(2,1)$：
  $$
  2m=1
  $$
  解得：
  $$
  \boxed{m=\frac{1}{2}}
  $$

最后⚠️注意一下边界情况：相切时直线 $AB$ 与曲线有且仅有一个交点，不合题意，所以 $m$ 不能取到 $\frac{9}{16}$；相对地，当直线 $AB$ 经过点 $(2,1)$ 时，它与曲线仍有两个交点，所以 $m$ 可以取到 $\frac{1}{2}$.

所以：
$$
\boxed{\frac{1}{2}\leq m\lt\frac{9}{16}}
$$

#### Ⅱ. 若 $[a,b]\subseteq[2,4]$：

此区间内 $f(x)$ **单调递减**，所以有：
$$
A(a,mb),\enspace B(b,ma)
$$
同样可以得到直线 $AB$ 的解析式：
$$
l_{AB}:y=-mx+m(a+b)
$$
这时候我们发现，这一个解析式只是看上去的话，并没有什么特别的，也不过什么定点之类的。然而，你应该也已经知道了，我们前两种方法都有提到如下等式：
$$
\boxed{a+b=5}
$$
没错，这时候我们的思路仍然同[*方法一的第 Ⅱ 类情况*](#surprise)，即可得到上面 $a+b=5$ 这个恒等式。接下来就简单很多啦，把 $a+b=5$ 代入直线 $AB$ 的解析式并整理，可得：
$$
l_{AB}:y=-m(x-5)
$$
我们同样惊奇地发现：直线 $AB$ **经过定点** $\boldsymbol{(5,0)}$，而且其斜率为 $-m$，好办了！依照题意，我们同样只需要让直线 $AB$ 和 $y=f(x),\enspace x\in[2,4]$ 的函数图像（这段图像下文简称曲线）恰好有两个交点。所以先把草图画出来：

![方法三-第 Ⅱ 类](https://img.hxrch.top/20260102150340656.svg)

与第 Ⅰ 类类似，我们可以发现：在直线 $AB$ 与曲线相切时其**斜率的绝对值**取到**最大值**，在经过点 $(2,1)$ 时其**斜率的绝对值**取到**最小值**。

分别如下：

- 与曲线相切：
  $$
  -m(x-5)=f(x)
  $$
  转化为一元二次方程，即：
  $$
  (m-1)x^2-5(m-1)x-4=0
  $$
  这个方程依然与[*方法二第 Ⅱ 类*](#same2)所构造出的方程相同！同样我们只需令其判别式等于零，解得：
  $$
  \boxed{m=\frac{9}{25}}
  $$

- 经过点 $(2,1)$：
  $$
  -m(2-5)=1
  $$
  解得：
  $$
  \boxed{m=\frac{1}{3}}
  $$

边界情况：根据草图，可以得知同样为相切时的 $\frac{9}{25}$ 不能取，而经过点 $(2,1)$ 时的 $\frac{1}{3}$ 可以取到。

所以：
$$
\boxed{\frac{1}{3}\leq m\lt\frac{9}{25}}
$$

#### 综上所述：

对两类情况的结果**取并集**，得到最终答案：
$$
\boxed{\large{m\in[\frac{1}{3},\frac{9}{25})\cup[\frac{1}{2},\frac{9}{16})}}
$$

## 后记

这道题的三种解法到这里就分享完了，它们都各有优劣：

- 对于方法一：这一种方法通常适合有计算天赋的同学，其优点是无需过多思考，仅计算；缺点就是对于数学计算功底不佳的同学不友好。
- 对于方法二：该方法适合思维灵活的同学使用，通过观察多条方程式之间的关系与特点来构造新的方程，属于创新了，但其对思维灵活性要求较高。
- 对于方法三：这种方法适合思维比较灵活或擅长几何的同学使用，需要善于发现代数式与图像之间的联系，但通常计算量最小。

总体来说，这一道题目的价值还是非常高的，对同学们的思维训练效果极佳，值得同学们一试！

---

Typora这里显示这篇文章已经四千六百多词了，算是到目前我写过的最长的文章了，但是真的太累了！！！花了我差不多半天时间才写完，结果还要制作封面，生成摘要等等……好苦啊😭😭😭

不过想想这才是2026年的第二天，时间换来质量，我相信这一篇高质量文章一定会给未来带来好运的！💪
</file>

<file path="content/posts/好题评估——2025-广州中考第-25-题.md">
---
title: 好题评估——2025 广州中考第 25 题
tags: [数学, 几何, 平面几何, 好题评估, 相似三角形, 圆, 辅助圆, 倍长中线, 最值问题]
category: 数学
description: 本文针对2025年广州中考第25题，做了深入分析。先回顾了题目，然后逐步解析各小题，重点在于如何论证三角形相似以及找动点轨迹。对于第二小题，提供了两种解法，并归纳了解题思路和方法，希望能帮考生更好地应对这类问题。
image: https://img.hxrch.top/202508081115500.webp
published: 2025-08-08 10:52:28+08
updated: 2025-08-08 11:16:46+08
---


## 写在前面

> 首先我想对大家说一声抱歉哈，这篇文章我已经拖了非常非常久了，因为是中考题，所以其实我早就定稿这篇文章了，只是最近忙这些其他事情没来得及在博客上发布。今天好不容易有空，就想着先把这篇文章给补了。

> 这一道题是2025年的广州市中考真题，也因为我恰好就是2025届广州中考生，才更能体会这道题的含金量，于是考虑记录此篇。

在正式阅读本篇文章之前，建议提前学习[双动线段比例最值问题——反演变换（2）](/posts/双动线段比例最值问题反演变换2/)。

## 真题再现

以下2025年广州市中考第25题题面。

![真题展示](https://img.hxrch.top/202508050757032.webp)

第（1）问太简单了，就是个尺规作图题，这里不做过多介绍了。

### 第（2）题第①小问

其中第（2）问呢，又被分为两个小问①②，那我们就先来看第①小问：是一道证明题，要求我们证明两个三角形相似。既然是这样，那无非就是“两角”“两边夹一角”和“边边边”了，但是由于题目中已经给出了一对现成的相似三角形 $\triangle ABC\backsim\triangle FCE$，所以我们需要先把角导明白，毕竟能直接用角相等证明相似肯定比用边要方便很多。

那我们不妨设 $\angle BAC=\alpha,\angle ACB=\beta$，由题目中所给的相似，可得 $\angle CFE=\alpha,\angle CEF=\beta$，再由外角的性质，可得 $\angle ACE=\alpha+\beta$，所以 $\angle BCE=\angle ACE-\angle ACB=(\alpha+\beta)-\beta=\alpha$，到了这时候，我们不难发现需要证明相似的两个三角形已经被推出一个角相等了，那这道题就算是完成 $\frac{1}{3}$ 了，接下来该怎么做呢？

应该很容易发现，除了刚刚的 $\angle BCE$，我们无法进一步推导出其他 $\triangle CBE$ 中的角了，所以我们得换种思路，来看最开始提到的证明两个三角形相似的三种方法，其中“两角”和“边边边”都已经被排除了，所以将目光锁定在“两边夹一角”身上，目前我们所需要做的就是证明与这个角相邻的两条边与对应三角形的两条边分别成比例，（这句话可能有点长，我来用数学语言描述一下，即需要证明 $\frac{AB}{CB}=\frac{AC}{CE}$），如何呢？

还是题目所给的相似三角形，只需提取其中有关边的条件即可，即由 $\triangle ABC\backsim\triangle FCE$，得 $\frac{AB}{CF}=\frac{BC}{CE}$，将该比例等式进行变形，得到 $\frac{AB}{CB}=\frac{CF}{CE}$。

诶？为什么我感觉我们所得到的比例式与需要证明的极其相似，但……还是不一样？

——原来是我们遗漏了一个重要条件！$CF=AC$！这样一来，我们即可通过“两边夹一角”证明这道题啦~

来看一下完整过程：

<span class="mathjax-align-left"></span>
$$
\begin{align}
&设\angle BAC=\alpha,\angle ACB=\beta\\
&\because\triangle ABC\backsim\triangle FCE\\
&\therefore\angle CFE=\angle BAC=\alpha,\angle CEF=\angle BCA=\beta\\
&\therefore\angle ACE=\angle F+\angle CEF=\alpha +\beta\\
&\therefore\angle BCE=\angle ACE-\angle ACB=(\alpha +\beta)-\beta=\alpha\\
&\because\triangle ABC\backsim\triangle FCE\\
&\therefore\frac{AB}{CF}=\frac{BC}{CE}\\
&即\frac{AB}{CB}=\frac{CF}{CE}\\
&又\because CF=AC\\
&\therefore\frac{AB}{CB}=\frac{AC}{CE}\\
&又\because\angle BAC=\angle BCE=\alpha\\
&\therefore\triangle ABC\backsim\triangle CBE
\end{align}
$$
小结一下第①小问，整体上还是相对简单的，只需要我们打开思维，灵活且充分地运用题目条件即可证明。

### 第（2）题第②小问

#### 方法Ⅰ

到了这一问，事情就开始复杂起来了。

这图形看上去的确是**一线三等角**模型，但是这似乎对我们解题并没有帮助，况且这类求动点运动轨迹的题目十分少见。

没办法，不是模型题，身处考场的我，只能开启**思维迸发**模式了——因为在开始做这一小问时，我只剩下10分钟左右的时间了。

我先从角的条件入手，企图可以直接求出点B的运动轨迹，但我很快发现，无论是从大题干给出的条件，还是上一小问所得的信息，都无法直接推出我想要的东西。此时已经过去了一两分钟了，在反复确认这个方法行不通后，我转变了新航道，把目光转移到“边”的身上，诶，还真就有新的发现！

因为需要利用边的条件，就只能从题目中所给出的相似三角形中推，而在第（2）问大题干中的一组相似 $\triangle ABC\backsim\triangle FCE$ 就已经可以推出一个很关键的条件：$CB=AC\cdot\frac{CE}{EF}$，又因为 $AC$ 是常量，所以 $CB=\frac{4CE}{EF}$，到这里，整道题的解法就已经初见端倪了——一条动线段 $CB$ 的长度被转化为另外两条共顶点动线段之比 $\frac{CE}{EF}$ 的倍数，是不是有点familiar（熟悉）的味道了呢？（参考[双动线段比例最值问题——反演变换（2）](/posts/双动线段比例最值问题反演变换2/)）

没错，到这一步这道题就基本上解决了，因为后面的步骤就是之前所讲的模型了！利用圆幂定理反A相似，即可顺利地将两个变量减少为一个，并且是建立在可以用已知运动轨迹的点 $E$ 上求解的单线段最值问题。下面就直接看完整过程吧。

![方法Ⅰ](https://img.hxrch.top/202508081036000.svg)

<span class="mathjax-align-left"></span>
$$
\begin{align}
&作\triangle ACE的外接圆\odot M交EF于点N，连接AM,AN,MN,CM.\\
&\because\triangle ABC\backsim\triangle FCE\\
&\therefore\frac{BC}{CE}=\frac{AC}{FE}\\
&即\frac{BC}{AC}=\frac{CE}{EF},BC=AC\cdot\frac{CE}{EF}=\frac{4CE}{EF}\\
&在\odot M中，\angle FAN=\angle FEC\\
&又\because\angle F=\angle F\\
&\therefore\triangle FAN\backsim\triangle FEC\\
&\therefore\frac{AF}{EF}=\frac{AN}{CE}\\
&即\frac{4CE}{EF}=\frac{4AN}{AF}\\
&\because CF=AC=4\\
&\therefore AF=CF+AC=4+4=8\\
&\therefore\frac{4CE}{EF}=\frac{4AN}{8}=\frac{AN}{2}\\
&已知点N在\odot M上运动\\
&\therefore 在\triangle AMN中，AN\leq AM+MN\\
&在\odot M中，\angle AEC=45\degree\\
&\therefore\angle AMC=2\angle AEC=2\times 45\degree=90\degree\\
&又\because AM=CM\\
&\therefore\angle MAC=45\degree\\
&\therefore 在\mathrm{Rt}\triangle AMC中，\cos{45\degree}=\frac{AM}{AC}=\frac{\sqrt{2}}{2}\\
&即AM=\frac{\sqrt{2}}{2}AC=\frac{\sqrt{2}}{2}\times 4=2\sqrt{2}\\
&\therefore MN=AM=2\sqrt{2}\\
&\therefore AN\leq AM+MN= 2\sqrt{2}+2\sqrt{2}=4\sqrt{2}\\
&即\frac{4CE}{EF}=\frac{AN}{2}\leq 2\sqrt{2}\\
&即CB\leq 2\sqrt{2}\\
&\therefore CB的最大值为2\sqrt{2}
\end{align}
$$
当然，以上还只是套用了模型的最初思路，虽然可以解出这道题，但还是有可以改进的点的：就如我们可以通过导角直接证明 $\triangle ABC\backsim\triangle FNA$，得到 $\frac{BC}{AN}=\frac{AC}{AF}=\frac{1}{2}AN$ 一步到位，可以极大地简化了步骤，进一步节约时间。

> 只可惜我在考场上并没有写完过程😭(┬＿┬)

#### 方法Ⅱ

鉴于官方做法为直接求出点 $B$ 的运动轨迹，以及互联网上大部分的解题思路也是如此，这里也就简单提一下。

在前面讲[方法Ⅰ](#方法ⅰ)的时候已经提到过，整个图形中并没有现成的与线段 $CB$ 相关的定角来求出点 $B$ 所在的轨迹圆（题目中没有说，但是这种情况下点 $B$ 的轨迹大概率就是一个圆了，考场上可以任取几点观察，因为目前中考几何题目中的动点运动轨迹只能是直线或圆），所以轮到我们添辅助线了~

注意到整道大题的第（1）问要求的尺规作图~~（注意力惊人）~~，本质上是**倍长中线**！其实相当于给了我们一个小小的提示，那么在这一小问当中，也可以连接并倍长线段 $BO$ 转化角的条件，最后其实是可以证明 $\angle OBC=45\degree$ 的，定弦定角便可以确定点 $B$ 的运动轨迹了！

请看完整过程。

![方法Ⅱ](https://img.hxrch.top/202508081036262.svg)

<span class="mathjax-align-left"></span>
$$
\begin{align}
&延长BO至点H，使得OH=OB，作\triangle OBC的外接圆\odot M，连接CH,OM,BM,CM.\\
&\because O为AC中点\\
&\therefore AO=CO\\
&\therefore 在\triangle AOB和\triangle COH中，\\
&\left\{\begin{aligned}
&AO=CO,\\
&\angle AOB=\angle COH,\\
&OB=OH
&\end{aligned}\right.\\
&\therefore\triangle AOB\cong\triangle COH(SAS)\\
&\therefore AB=CH,\angle BAO=\angle HCO\\
&\because\triangle ABC\backsim\triangle CBE\\
&\therefore\angle BAC=\angle BCE\\
&\therefore\angle HCO=\angle BCE\\
&\therefore\angle HCO+\angle ACB=\angle BCE+\angle ACB\\
&即\angle BCH=\angle ECA\\
&\because\triangle ABC\backsim\triangle FCE\\
&\therefore\frac{BC}{CE}=\frac{AB}{CF}\\
&又\because CF=AC,AB=CH\\
&\therefore\frac{BC}{CE}=\frac{CH}{AC}\\
&\therefore\triangle BCH\backsim\triangle ECA\\
&\therefore\angle CBH=\angle CEA=45\degree\\
&即\angle OBC=45\degree\\
&\therefore在\odot M中，\angle OMC=2\angle OBC=2\times 45\degree=90\degree\\
&\because OM=CM\\
&\therefore\angle MOC=45\degree\\
&\therefore在\mathrm{Rt}\triangle OMC中，\sin{45\degree}=\frac{CM}{OC}=\frac{\sqrt{2}}{2}\\
&\therefore CM=\frac{\sqrt{2}}{2}OC=\frac{\sqrt{2}}{2}\times\frac{1}{2}AC=\frac{\sqrt{2}}{2}\times\frac{1}{2}\times 4=\sqrt{2}\\
&\therefore BM=CM=\sqrt{2}\\
&在\triangle BCM中，CB\leq CM+BM=\sqrt{2}+\sqrt{2}=2\sqrt{2}\\
&即CB的最大值为2\sqrt{2}
\end{align}
$$

## 总结

那么广州中考第25题的评估就结束啦~

我们也可以从中得到一些启发，像这样一道压轴题，出题人肯定是会给我们一些提示的（但不保证100%），以后做题应仔细观察题面（审题），充分利用题目所给的条件和其他默认已知信息，往往可以事半功倍！
</file>

<file path="content/posts/几何之利刃——反演变换（1）.md">
---
title: 几何之利刃——反演变换（1）
tags: [数学, 几何, 平面几何, 变换, 动点, 最值问题, 反演变换, 相似三角形, 圆与直线, 初中数学]
category: 数学
image: https://img.hxrch.top/202507121716144.webp
description: 这篇文章介绍了几何变换中的反演变换，特别是在初中数学中的应用。文章首先给出了反演变换的基本概念，接着讲解了其性质以及在动态点轨迹求解中的应用，尤其是讨论了不同情况下动点的轨迹，包括线生线、线生圆、圆生线和圆生圆等。最后，文章强调了反演变换的重要性，并鼓励读者掌握这一知识。
published: 2025-07-12 14:46:40+08
updated: 2025-07-12 17:17:59+08
---


> 现在中考数学越来越爱考反演变换的题目了，于是……就有了这篇文章。

:::warning[提示]

本篇章阅读需要前置知识：[圆幂定理](/posts/浅谈圆幂定理/)，建议先阅读此篇章再回来，如已掌握请忽略。

:::

## 定义

反演变换与平移、旋转、对称变换等类似，也属于一种几何变换，但它更像是作一个图形关于圆的镜像。简单来讲，其定义如下：在同一平面内，有共线的三点 $A,O,A'$，其中 $O$ 为定点，且 $OA\cdot OA'=k$，其中 $k$ 为常数，则从点 $A$ 到点 $A'$ 的变换称为**“反演变换”**，记作 $I(O,k)$，那么定点 $O$ 即**反演中心**，常数 $k$ 为**反演幂**，点 $A'$ 被称为 $A$ 的**反点**。对于反演变换 $I(O,k)$，令 $r=\sqrt{k}$，则以反演中心 $O$ 为圆心，$r$ 为半径的圆称为反演变换 $I(O,k)$ 的**反演圆**或**基圆**，常数 $r$ 为**反演半径**。如下图所示。

![](https://img.hxrch.top/202507111147395.svg)

## 性质

> 反演变换的性质有很多条，由于篇幅有限，而且出于入门目的，这里仅简单列举两条易懂且常用的性质。

### 性质 1：反演变换可逆

由反演变换的定义可知，当 $A'$ 时 $A$ 的反点时，$A$ 也是 $A'$ 的反点，所以点 $A$ 与 $A'$ 互为反点。

### 性质 2：（每个点经过反演变换前后的位置关系）

- 位于反演圆**上**的点，其反点保持在<u>原处</u>。
- 位于反演圆**内**的点，其反点位于反演圆<u>外</u>。
- 位于反演圆**外**的点，其反点位于反演圆<u>内</u>。

## 应用

> 了解完反演变换的两条基本性质，那么就进入正题：反演变换在初中数学中的应用。

初中数学的反演变换通常会出现在求解**动点轨迹**的一类问题中，尤其是<u>双动点问题</u>（含一主动点和一从动点），当然部分求最值问题的本质也是求出<u>动点轨迹</u>。

根据[*反演变换的定义*](#定义)，主动点与从动点的关系必须要满足**“定积定角”**，需要区分<u>瓜豆原理</u>的“定比定角”。以下会举一个简单的例子进行说明。

>  平面内有一定点 $O$ 和两个动点 $P,Q$，其中点 $Q$ 随点 $P$ 的运动而运动，现已知点 $P$ 的运动轨迹，且 $OP\cdot OQ=k$，$\angle POQ=\theta$，其中 $k$ 为常数，$\theta$ 为定值，请求出点 $Q$ 的运动轨迹。

### 第Ⅰ类

> 点 $P$ 在过点 $O$ 的直线上运动（**线生线**）

![](https://img.hxrch.top/202507121412673.svg)

显然，由于此时 $\angle POQ$ 的一边 $OP$ 所在直线固定，则另一边 $OQ$ 所在直线也固定，故点 $Q$ 在如图所示蓝色直线（**过点 $O$ 的直线**）上运动。动图如下。

<img class="if-dark-invert" src="https://img.hxrch.top/202507121411740.gif">

这一类即所谓**线生线**。

### 第Ⅱ类

> 点 $P$ 在***不经过***点 $O$ 的直线上运动（**线生圆**）

<img src="https://img.hxrch.top/202507121412671.svg" style="zoom:200%;" />

肉眼可见地，这一类与上一类有了天差地别，点 $Q$ 地运动轨迹竟然是个圆！证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&过点O作OH\perp HP于点H，在平面内取一点G，使得\angle HOG=\angle POQ，且\angle OQG=90\degree，连接OG，QG，取OG中点M.\\
&\because \angle HOG=\angle POQ\\
&\therefore \angle HOG+\angle POG=\angle POQ+\angle POG\\
&即\angle POH=\angle GOQ\\
&\because OH\perp HP\\
&\therefore \angle PHO=90\degree=\angle GQO\\
&\therefore \triangle POH\backsim \triangle GOQ\\
&\therefore \frac{OP}{OG}=\frac{OH}{OQ}\\
&即OH\cdot OG=OP\cdot OQ=k\\
&\because OH为定值，k为常数\\
&\therefore OG为定值\\
&又\because \angle HOG=\angle POQ为定值，OH固定\\
&\therefore OG固定\\
&\because \angle OQG=90\degree 为定角\\
&\therefore 点Q在以OG为直径的圆上运动\\
&\color{red}{\boldsymbol{即点Q在以M为圆心，OM为半径的圆上运动（过点O的圆）}}\\
\end{align}
$$
动图如下。

![](https://img.hxrch.top/202507121412674.gif)

这一类即所谓**线生圆**。

### 第Ⅲ类

> 点 $P$ 在过点 $O$ 的圆 $M$ 上运动（**圆生线**）

<img src="https://img.hxrch.top/202507121419161.svg" style="zoom:200%;" />

这一类与第Ⅱ类十分类似，只是调换了以下顺序，所以其实时可以直接利用反演变换的[*性质1*](#性质-1反演变换可逆)（可逆性）来解释。完整证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&连接OM并延长交\odot M于点H，连接PH，在平面内取一点G，使得\angle HOG=\angle POQ，且\angle OGQ=90\degree，连接OG，QG.\\
&由题，知OH为直径\\
&\therefore\angle OPH=90\degree=\angle OGQ\\
&\because\angle HOG=\angle POQ\\
&\therefore HOG-\angle HOQ=\angle POQ-\angle HOQ\\
&即\angle GOQ=\angle POH\\
&又\because\angle OPH=\angle OGQ\\
&\therefore\triangle POH\backsim\triangle GOQ\\
&\therefore\frac{OP}{OG}=\frac{OH}{OQ}\\
&即OH\cdot OG=OP\cdot OQ=k\\
&\because OH为定值，k为常数\\
&\therefore OG为定值\\
&又\because\angle HOG=\angle POQ为定值，OH固定\\
&\therefore OG固定\\
&\because \angle OGQ=90\degree 为定角\\
&\therefore 点Q在过点G且垂直于OG的直线上运动\\
&\color{red}{\boldsymbol{即点Q在如图所示的蓝色直线上运动（不经过点O的直线）}}\\
\end{align}
$$
动图如下。

![](https://img.hxrch.top/202507121424458.gif)

这一类即所谓**圆生线**。

### 第Ⅳ类

> 点 $P$ 在***不经过***点 $O$ 的圆 $M$ 上运动（**圆生圆**）

![](https://img.hxrch.top/202507121419160.svg)

由图可知这一类的做法与前三组更是又显著差异。其实这里用到了“**转化**”的主要思想，通过将反演问题由**圆幂定理**进行转化，把题目变为简单的<u>“瓜豆”</u>题。其大致证明如下。

> 阅读此证明需要知识【圆幂定理】，[点我跳转](/posts/浅谈圆幂定理/)，如已掌握请忽略。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&连接OM，连接OP并延长交\odot M与点P'，连接MP'，在平面内取一点N，使得\angle MON=\angle POQ，\angle OQN=\angle OP'M，连接ON，QN.\\
&\because\angle MON=\angle POQ\\
&\therefore\angle MON-\angle P'ON=\angle POQ-\angle P'ON\\
&即\angle MOP'=\angle NOQ\\
&又\because\angle OQN=\angle OP'M\\
&\therefore\triangle MOP'\backsim\triangle NOQ\\
&\therefore\frac{OM}{ON}=\frac{MP'}{NQ}=\frac{OP'}{OQ}\\
&在\odot M中，记其半径为r，则根据圆幂定理\\
&得OP\cdot OP'=OM^2-r^2，记为a\\
&又OP\cdot OQ=k，记为b\\
&\therefore\frac{a}{b}，得\frac{OP'}{OQ}=\frac{OM^2-r^2}{k}\\
&\because OM,r,k都为定值\\
&\therefore \frac{OP'}{OQ}为定值\\
&\because\frac{OM}{ON}=\frac{MP'}{NQ}=\frac{OP'}{OQ}\\
&又\because OM,MP'为定值\\
&\therefore ON,NQ为定值\\
&又\because OM固定，\angle MON=\angle POQ为定值\\
&\therefore ON固定\\
&\color{red}{\boldsymbol{\therefore 点Q在以N为圆心，NQ为半径的圆上运动（不经过点O的圆）}}\\
\end{align}
$$
动图如下。

![](https://img.hxrch.top/202507121426333.gif)

## 总结

综上所述，反演变换的大多数题目都是由**相似**解决的，有些甚至还用到了**圆幂定理**，可见反演变换套路之复杂。当然，以上列举的还仅仅时反演变换最基础的内容，不过即便这样也足以解决 **90%** 的初中反演类型的题目了，就如<u>**2025年广东省广州市越秀区一模卷的第25题第(3)小问**</u>，恰好就是反演变换中[*线生圆*](#第ⅱ类)的模型题。所以这么重要的知识，还是得好好掌握啊。

读完这篇文章，你也应该差不多已经入门反演变换了，后续我还会出更多相关的内容，希望各位可以动动手指主动分享一下，扩大知识的传播面，让身边更多的人能够了解这些技巧。
</file>

<file path="content/posts/看透多动点的本质——旋心.md">
---
title: 看透多动点的本质——旋心
tags: [数学, 几何, 平面几何, 旋转, 相似三角形, 变换, 动点, 最值问题, 手拉手模型]
category: 数学
description: 本文深入探讨了旋心（相似不动点）的概念和构造方法，尤其在几何题中的应用。通过实例，文章展示如何通过旋转相似构造一些难题中的旋心，并引导观众理解其在求解最值问题中的重要性。本文还提供了多个练习题，以巩固观众对旋心构造方法的掌握。
image: https://img.hxrch.top/202505241959334.svg
published: 2025-05-11 15:00:00+08
updated: 2025-07-12 17:20:45+08
---

> 构造旋心是部分中考几何题的通用方法，学习后将有助于提升中考压轴题的做题效率。

**旋心**又称“相似不动点”，构造旋心解题的这类方法又被称作“逆瓜豆原理”。

## 引入

毕竟旋心也被叫做相似不动点，那么我们来看一下是如何构造相似的：

如图是两条线段 $AB$、$CD$，要求在平面内作一点 $S$，使得 $\triangle ABS\backsim\triangle CDS$. （可以尝试在图上画一画）

![引入-1](https://img.hxrch.top/202505241952244.svg)

聪明的你肯定发现，直接找一点 $S$ 不那么容易，所以你选择了从已知事物出发，开始研究起了旋转相似。

![引入-2](https://img.hxrch.top/202505241958934.svg)

由旋转相似，不难发现 $\angle AC'B'=\angle ACB$，于是你延长了 $C'B'$ 和 $CB$ 交于一点 $D$，然后得出 $A,C',C,D$ 四点共圆，并且进一步推出 $A,B',B,D$ 四点也共圆。所以你选择在原来的题目上做出如下操作：延长 $BA,DC$ 交于点 $E$，并分别做出 $\triangle ACE$ 和 $\triangle BDE$ 的外接圆相交于另一点 $S$。

![引入-3](https://img.hxrch.top/202505241959075.svg)

对，你就是发现了其中的规律，点 $S$ 就是旋转中心！连接剩余的4条边，便得到两个相似三角形。

![引入-4](https://img.hxrch.top/202505241959254.svg)

完美，接下来还有一道类似的题：在如下平面上作出一点 $S$，使得 $\triangle ABS\backsim\triangle DCS$.（再尝试画一画）

![引入-5](https://img.hxrch.top/202505241959579.svg)

你也肯定发现了，做法与上一道题十分相似，还是首先找到两条线段所在直线交点，记为 $E$。

![引入-6](https://img.hxrch.top/202505241959276.svg)

需要注意的是，这次相似中的第二个三角形对应点调换了一下，那么思路也变换一下，分别作 $\triangle ADE$ 和 $\triangle BCE$ 的外接圆，其交点就是我们要的点 $S$ ！

![引入-7](https://img.hxrch.top/202505241959005.svg)

那——如何证明呢？

虽然图的样子变了，但是仔细观察，还是可以发现图中有两个圆内接四边形 $ASDE$ 和 $BSCE$，只不过不在同一个圆中，那么事情就好办了，它们有公共角 $\angle BED$，所以它的对角都相等，即 $\angle ASD=\angle BSC$，减去公共角 $\angle ASC$，可得 $\angle ASB=\angle DSC$。第一组角相等有了，第二组也显而易见：在圆内接四边形 $ASDE$ 中，有 $\angle BAS=\angle D$，证毕！

其实按照这个方法，在另一个圆内接四边形中还有第三组角相等，只是我们不需要罢了。

为了使这样构造相似的方法更加通用，我们给予如下形式的定义：对于平面内任意两条有向线段 $\boldsymbol{AB}$ 和 $\boldsymbol{CD}$，两始点与平面内另一点 $S$ 构成的夹角 $\angle ASC$ 等于两条有向线段的夹角 $\theta$，两终点与该点 $S$ 构成的夹角 $\angle BSD$ 也等于 $\theta$ ，则该点 $S$ 即为有向线段 $\boldsymbol{AB}$ 和 $\boldsymbol{CD}$ 的**旋心**（相似不动点）。

> 有向线段的夹角即引入题 1 中的 $\angle AEC$ 和引入题 2 中的 $\angle AED$ 的补角，由两条有向线段的方向确定。

## 精讲

了解完旋心的定义，可以尝试思考一下：构造旋心这一手段在题目中有什么用呢？

欸，很对同学的第一反应应该是<u>逆等线</u>的题目吧，那么刚好，我们来看一道逆等线最值的经典题目。

**【例题 1】** 如下图，已知 $AB=4$，$\angle ACB=90\degree$，点 $D$ 在线段 $BC$ 上，且 $AC=BD$，求线段 $AD$ 的最小值。

![精讲-1](https://img.hxrch.top/202505241959782.svg)

这道题就是逆等线标准的模型题，如果说利用逆等线模型来解，大概是这样：

![精讲-2](https://img.hxrch.top/202505241959095.svg)

即构造三角形全等，$\triangle ACB\unicode{x224c}\triangle BDE$，得到定边 $BE$ 和定角 $\angle BDE$，定弦定角出定圆，最后一箭穿心即可。

当然了，这种题对于用旋心解法也是小菜一碟，为了找到旋心 $S$，需要先找到两个有向线段 $\boldsymbol{AC}$ 和 $\boldsymbol{BD}$，它们的夹角 $\theta =90\degree$，所以先作出 $\triangle ACB$ 的外接圆 $\odot M$，并在 $\odot M$ 上找一点，使得该点到 $A$ 和 $B$ 的距离相等。这时候我们就会发现该前提下有两个符合条件的点，那我们取哪一个呢？其实这里我们直观感受一下即可，当该点在 $AB$ 下方时会发现无法构造出旋转相似，所以 $AB$ 上方的点就是我们所需要的旋心 $S$。

在你找到了旋心之后，整道题就已经完成一半了。不难发现我们所构造的旋心 $S$ 是一个定点，又由旋转全等，就可以利用<u>瓜豆原理</u>来求出点 $D$ 的运动轨迹了，怎么样？是不是很直接，自然而然地答案就摆在了眼前，图解如下。

![精讲-3](https://img.hxrch.top/202505241959334.svg)

所以这道题的最终答案为：当 $A,D,F$ 三点共线时，$AD_{min}=AF-DF=2\sqrt{5}-2$。

那么我们这里就可以总结一下利用旋心解题的两大步骤：

1. 构造定角（例题 1 中的 $\angle ASB=\theta$）
2. 构造边成定比（例题 1 中的 $\frac{AS}{BS}=\frac{AC}{BD}=1$）

> 需要注意的点是：这样的构造方式通常会有两个符合条件的点，需根据题意排除其中一个。

## 练习

> 作为旋心篇章的末尾，这里整理了3道有意义的几何题，并且都可以利用旋心来解决，期待你精彩的解法！

**【习题 1】** 如图，在 $\triangle ABC$ 中，$\angle ACB=45\degree$，$AB=4$，$D$ 在线段 $BC$ 上且 $BD=AC$，$DE\perp AC$，若 $AC<BC$ 且点 $E$ 在线段 $AC$ 上，求 $DE$ 扫过的面积。

![练习-1](https://img.hxrch.top/202505242000974.svg)

**【习题 2】** 如图，在等边 $\triangle ABC$ 中，$D,E$ 分别是边 $AC,BC$ 上的动点，且 $BE=2AD$，若 $AB=4$，求 $AD+DE$ 的最小值。

![练习-2](https://img.hxrch.top/202505242000400.svg)

**【习题 3】** 如图，平面内有四个点 $A,B,C,D$，$AB=6$，$\angle CAB=\angle DBA=60\degree$，$E$ 是线段 $AB$ 上一动点，且满足 $\angle CED=90\degree$，$AE+BD=BE$，求 $CE+\sqrt{3}DE$ 的最小值。

![练习-3](https://img.hxrch.top/202505242000993.svg)

## 小结

总而言之，构造旋心是一类几何题的通用解法，但切记不要滥用，毕竟任何事物都是有双面性的，在思路简单无脑的同时换来的是大于其他几何做法的计算量和更加复杂的图示和解题步骤，所以博主这里建议如果一道题能够用其他更清晰明了的几何方法解决就不要用旋心来解决，不过平时做题用旋心来唤醒一下沉睡的几何思维也是可以的。

关于旋心的篇章就先到这里了，这可是~~花费了博主不少心血才做出来的成品~~啊。

上面留了3道习题，大家可以尝试着做一做，答案会在后期另篇发布。当然，也许你会发现难度与例题~~相差甚远~~，但这正是锻炼我们大脑的好机会呀，期待各位的精彩解答！
</file>

<file path="content/posts/老师二三事.md">
---
title: 老师二三事
tags: [作业, 语文, 作文篇章]
category: 作文篇章
description: 文章《老师二三事》是博主作为高中一年级学生的语文作业，透过对数学老师钟进均的课堂情境描述，展现了师生之间的幽默互动与课堂气氛。作者以生动的例子描绘了钟老师的教学风格和与学生之间的关系，表达了对未来三年学习生活的期待和对老师的敬意。
image: https://img.hxrch.top/202509062320402.webp
published: 2025-09-06 15:39:48+08
updated: 2025-09-06 15:40:40+08
---


> 《老师二三事》一篇为新高一第一周语文作业，完成后顺便以博客为载体发表，文章不长，浅读即可。

三角形如何成为正方形？这看上去十分可笑。不过这正是二十一班与钟老师的羁绊。

钟进均老师，高中数学正高级教师，已独立出版书籍五本，内容涵盖他在课上经常提到的“说数学”“写数学”等，同时作为我们年级的主任，见到他的机会自然不少。

但就相处的这一周来看，没有什么事情是比他的数学课堂更精彩的了！你可能很好奇，一个扁扁的椭园能代表什么？在其两侧添加一对花括号又是什么？那当然是“0”和“{0}”！一个数字零，一个含元素零的集合。就这样一件小事，不仅迅速地将同学们引入正题，同时达到了烘托班内学习氛围的效果。这，就是钟老师给人的第一印象。

钟老师似乎并不会在任何时候感到尴尬。究其原因：一次数学课堂上，同学们正积极地发表自己对一道习题的看法，当我们大声喊出意中所想的答案B时，却未曾料到钟老师以如此严肃的表情、干脆利落的话音喝道：“那就错！选C！”班内气氛忽然凝固起来。你猜怎么着？突如其来的死寂立刻被打破——因为这道题的答案十分显眼地摆在了屏幕上：就是选B！然而看似钟老师被PPT打脸了，实则他轻易化解了这道难题：“我是想告诉你们不要选了错误答案C！”这件事就这么过去了，到最后也没人笑出来。

当然最经典的还得属钟老师的必杀技：指鹿为马！在我们学充分条件和必要条件时，钟老师本是出于便于同学们理解的目的，为我们板书了一道命题。可这内容瞬间引得全班哄堂大笑：若ΔABC是正方形，则……这真是数学一大奇迹啊。
高中这段旅程才刚刚开始，接下来的三年还有待探索，属于钟老师和我们师生间的羁绊也才是建立初期，相信未来一定会更加有趣、更加美好！
</file>

<file path="content/posts/浅谈圆幂定理.md">
---
title: 浅谈圆幂定理
tags: [数学, 几何, 平面几何, 圆, 圆幂定理, 定理, 相似三角形, 弦, 切线, 割线, 弦切角]
category: 数学
description: 本文介绍了反演变换的基本概念和性质，反演变换是一种几何变换，类似于其他几何变换如平移和旋转。文章详细阐述了反演变换的定义、基本性质及其在初中数学中的应用，特别是在求解动点轨迹的问题上。通过各种例子，说明了反演变换与相似、圆幂定理等几何概念的关系，以及如何用反演变换解决相关的数学问题。
published: 2025-07-20 16:29:30+08
updated: 2025-07-20 22:31:11+08
---


> 考虑到有的同学可能没有了解过圆幂定理，特地花此篇章简易说明，更详细的内容请自行查阅互联网。

圆幂定理在网上的说法很纷杂，各种教科书上的表述也不尽相同。这里取其中常见的一种说法来讲解。

即**圆幂定理是<span style="color:red;">相交弦定理</span>、<span style="color:red;">切割线定理</span>和<span style="color:red;">割线定理</span>三者的统一**。

## 前置知识

在后文对**切割线定理**的证明叙述时需要利用<span style="color: red;">**弦切角定理**</span>，故在此予以证明。

顾名思义，弦切角定理的内容应该与圆上一弦和切线的夹角有关，以下先给出其定义。

> **（弦切角定理）** 平面上有一个圆心为 $O$、半径为 $r$ 的圆，$\odot O$ 外有一点 $P$，过点 $P$ 的直线切 $\odot O$ 于点 $T$，在 $\odot O$ 上取点 $A,B$，连接 $AB,AT,BT$，则有 $\angle ATP=\angle ABT$，如图所示.

![](https://img.hxrch.top/202507201202658.svg)

证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&延长AO交\odot O于点C，连接OT,CT.\\
&\because 点P切\odot O于点T\\
&\therefore\angle OTP=90\degree\\
&\because AC为直径\\
&\therefore\angle ATC=90\degree\\
&\therefore\angle OTP=\angle ATC\\
&即\angle OTP-\angle ATO=\angle ATC-\angle ATO\\
&\therefore\angle ATP=\angle OTC\\
&\because OC=OT\\
&\therefore\angle OCT=\angle OTC\\
&又\because\angle OCT=\angle ABT\\
&\therefore\angle ATP=\angle ABT
\end{align}
$$

## 定义

我们可以先来看**点对圆的幂**。

> 平面内有一 $\odot O$，其半径为 $r$，对平面上任意一点 $P$，记 $\mathrm{Pow}(P)=OP^2-r^2$ 为点P对 $\odot O$ 的幂。

通过这个定义，我们知道任意**点对圆的幂**可为*正负零*，还可以推出**点对圆的幂**与该点和圆的**位置关系**：

$\mathrm{Pow}(P)=OP^2-r^2\left\{\begin{aligned}&>0\iff点P在\odot O外\\&=0\iff点P在\odot O上\\&<0\iff点P在\odot O内\end{aligned}\right.$

当然也有一个很显然的结论：$\mathrm{Pow}(P)=\mathrm{Pow}(Q)\iff OP=OQ$.

由此一来，圆幂定理就可以这样表述：

> **（圆幂定理）** 给定 $\odot O$ 和点 $P$，过点 $P$ 作 $\odot O$ 的任意一条割线（或切线）$PAB$ 与 $\odot O$ 分别交于 $A,B$，则 $\overline{PA}\cdot\overline{PB}$ 是一个常量，而这个常量正是点 $P$ 对 $\odot O$ 的幂，即 $\overline{PA}\cdot\overline{PB}=\mathrm{Pow}(P)$.

## 证明

### Ⅰ.相交弦定理

> **（相交弦定理）** 如图所示，点 $P$ 在 $\odot O$ 内部，$AB,CD$ 为过点 $P$ 的两条弦，则有 $PA\cdot PB=PC\cdot PD$.

![](https://img.hxrch.top/202507201202190.svg)

证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&连接AD,BC.\\
&在\odot O中，\angle ADC=\angle ABC\\
&即\angle ADP=\angle CBP\\
&又\because\angle APD=\angle CPB\\
&\therefore\triangle APD\backsim\triangle CPB\\
&\therefore\frac{AP}{CP}=\frac{PD}{PB}\\
&即PA\cdot PB=PC\cdot PD
\end{align}
$$
那为什么会满足 $\mathrm{Pow}(P)=-PA\cdot PB=-PC\cdot PD$ 呢？

请读者看到第二幅图，当弦 $CD$ 为直径（即 $C_1D_1$）时，$P_1C_1\cdot P_1D_1=(O_1C_1-O_1P_1)(O_1D_1+O_1P_1)=(r-O_1P_1)(r+O_1P_1)=r^2-{O_1P_1}^2$，这里简单利用<u>平方差公式</u>，然后得到 $-P_1A_1\cdot P_1B_1={O_1P_1}^2-r^2=\mathrm{Pow}(P)$，即
$$
\large{\color{red}{\mathrm{Pow}(P)=-PA\cdot PB=-PC\cdot PD}}
$$


我们也可以由此得知对于任意在圆内的点 $P$，其对该圆的幂为常量。

### Ⅱ.切割线定理

> **（切割线定理）** 如图所示，点 $P$ 在 $\odot O$ 外，$PB$ 为过点 $P$ 的割线，$PT$ 为过点 $P$ 的切线，则有 $PA\cdot PB=PT^2$.

![](https://img.hxrch.top/202507201202044.svg)

证明如下（这里就需要用到上文[*前置知识*](#前置知识)所讲的**弦切角定理**来进行证明了）。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&连接AT,BT\\
&在\odot O中，由弦切角定理\\
&得\angle ATP=\angle ABT\\
&又\because\angle P=\angle P\\
&\therefore\triangle APT\backsim\triangle TPB\\
&\therefore\frac{AP}{TP}=\frac{PT}{PB}\\
&即PA\cdot PB=PT^2
\end{align}
$$
同上一类的相交弦定理，切割线定理与圆幂定理的联系就看第二幅图的特殊情况：割线 $P_1B_1$ 经过点 $O_1$，同样利用平方差公式，可得
$$
\large{\color{red}{\mathrm{Pow}(P)=PA\cdot PB=PT^2}}
$$

### Ⅲ.割线定理

> **（割线定理）** 如图所示，点 $P$ 在 $\odot O$ 外，$PB,PD$ 为过点 $P$ 的两条割线，则有 $PA\cdot PB=PC\cdot PD$.

![](https://img.hxrch.top/202507201202079.svg)

证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&连接AD,BC\\
&在\odot O中，\angle ADC=\angle ABC\\
&即\angle ADP=\angle CBP\\
&又\because\angle P=\angle P\\
&\therefore\triangle ADP\backsim\triangle CBP\\
&\therefore\frac{AP}{CP}=\frac{DP}{BP}\\
&即PA\cdot PB=PC\cdot PD
\end{align}
$$
与前两类相同，通过平方差公式，再结合图形的特殊情况，即 $P_1B_1$ 为过点 $O_1$ 的割线，则有
$$
\large{\color{red}{\mathrm{Pow}(P)=PA\cdot PB=PC\cdot PD}}
$$

## 总结

通过以上的讲解，大家应该都理解了这三大定理和圆幂定理的内容了。圆幂定理的应用常见于一些有关圆中线段转化或最值问题的几何题中，这些题目中运用圆幂定理有时可以迅速抓住解题关键，事半功倍！cdn
</file>

<file path="content/posts/数据迁移之「从 Waline 到 Twikoo」.md">
---
title: 数据迁移之「从 Waline 到 Twikoo」
published: 2026-02-20 21:26:27+08
description: '本文介绍了如何将博客的评论系统从 Waline 迁移到 Twikoo，重点在于分析两者的数据结构差异并自行编写迁移程序。文中首先回顾了前一篇文章中的相关背景，然后详细比较了 Waline 和 Twikoo 的数据格式，接着阐述了程序的构思、数据迁移的流程和实现，并提供了完整的迁移代码。'
tags: [技术, 博客, 迁移, 教程, 评论系统, Waline, Twikoo]
category: '开发'
draft: false
---

> 本文是对上一篇中提到的待解决问题给出的应对方案，可以点此阅读 [LeanCloud停止对外服务&第一次博客迁移](/posts/leancloud停止对外服务第一次博客迁移/)。

距离上一次发文已经有足足十二天了！这篇文章也大概拖了有一个多星期了，不过还是先不讲这么多废话了吧。

# 前言

上一篇文章其实是有提到我将博客评论系统从 [Waline](https://waline.js.org/) 迁移到 [Twikoo](https://twikoo.js.org/) 的，但是当时并没有迁移原来的评论数据，因为 [Twikoo](https://twikoo.js.org/) 的管理面板中并不支持直接从 [Waline](https://waline.js.org/) 导入，目前好像只支持从 [Valine](https://valine.js.org/)、[Disqus](https://disqus.com/)、[Artalk](https://artalk.js.org/) 和 [Twikoo](https://twikoo.js.org/) 本身导入；本来我还想着因为 [Waline](https://waline.js.org/) 是 [Valine](https://valine.js.org/) 的进化版，可不可以把 [Waline](https://waline.js.org/) 的评论数据通过 [Valine](https://valine.js.org/) 选项导入……但是非常不幸的是，**失败了**！看来这两者之间的数据格式还是与些许不兼容的。

——那么，正所谓“自己动手，丰衣足食”，既然前面的选项都无法直接导入，那就干脆自己从零开始制作一个程序把 [Waline](https://waline.js.org/) 格式的评论数据转换为 [Twikoo](https://twikoo.js.org/) 格式的评论数据然后通过 [Twikoo](https://twikoo.js.org/) 选项导入啦~（谁会想着自己一个一个手动迁移呢）

# 自己动手，丰衣足食

## 对比数据结构

迁移之前，当然要先充分了解 [Waline](https://waline.js.org/) 和 [Twikoo](https://twikoo.js.org/) 各自的数据结构特点，找出其中的相同和不同之处，才能更加系统地制作迁移程序。

### 总览全局

首先，放长眼光，总览全局，两者导出的数据都是 `JSON` 格式的文件：

不难发现 [Waline](https://waline.js.org/) 的数据结构大致是：

```json title="waline.json"
{
  "data": {
    "Comment": [
      {/*...*/},
      {/*...*/},
      {/*...*/},
    ],
    /*...*/
  },
}
```

而 [Twikoo](https://twikoo.js.org/) 的数据结构大致是：

```json title="twikoo.json"
[
  {/*...*/},
  {/*...*/},
  {/*...*/},
]
```

对比非常明显，[Twikoo](https://twikoo.js.org/) 的数据文件应该是要比 [Waline](https://waline.js.org/) 小很多的，而且结构也更加清晰。在仔细观察后，就会发现 [Twikoo](https://twikoo.js.org/) 的数据结构整体的这个数组就对应了 [Waline](https://waline.js.org/) 数据结构中的 `Comment` 字段的数组，而且这个数组中的每一个值都是一个对象，代表着每一条评论数据。

### 深入探究

其次，分析两者评论数据数组中的具体内容，请看下面两组例子（这里就拿我的博客的一些评论数据举例）：

1. 第一组（非回复评论）：

   ```json title="waline.json"
   {
     "nick": "静凇",
     "ip": "12.345.678.90",
     "like": 1,
     "mail": "abcdefg@example.com",
     "ua": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
     "insertedAt": "2023-12-27T13:29:58.613Z",
     "status": "approved",
     "link": "",
     "comment": "谢谢，帮了大忙了",
     "url": "/posts/hexo-redefine-theme-踩过的坑/",
     "objectId": "68799fea6e25c660f962a2c7",
     "createdAt": "2025-07-18T01:14:18.723Z",
     "updatedAt": "2025-07-18T01:14:18.723Z"
   },
   ```

   ```json title="twikoo.json"
   {
     "_id": "f34674e295fa49539b8984cb99a59f94",
     "nick": "静凇",
     "mail": "abcdefg@example.com",
     "link": "",
     "ua": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
     "ip": "12.345.678.90",
     "url": "/posts/hexo-redefine-theme-%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/",
     "comment": "<p>谢谢，帮了大忙了</p>",
     "uid": "8bc585221ed5410c8d73b2d629bd24a7",
     "mailMd5": "1a7ca9215b81484630893cb8d5f73e0f",
     "master": false,
     "href": "https://blog.hxrch.top/posts/hexo-redefine-theme-%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/",
     "isSpam": false,
     "created": 1703683798613,
     "updated": 1752801258723,
     "top": false
   },
   ```

 2. 第二组（回复评论）：

    ```json title="waline.json"
    {
      "nick": "Horean0574",
      "ip": "98.765.432.10",
      "mail": "uvwxyz@example.com",
      "ua": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
      "insertedAt": "2025-07-18T01:28:52.287Z",
      "pid": "68799fea6e25c660f962a2c7",
      "status": "approved",
      "link": "https://www.hxrch.top",
      "comment": "感谢您的认可<img class=\"wl-emoji\" src=\"//unpkg.com/@waline/emojis@1.2.0/bmoji/bmoji_unavailble_doge.png\" alt=\"bmoji_unavailble_doge\">",
      "url": "/posts/hexo-redefine-theme-踩过的坑/",
      "user_id": "64eabd5c7eac3a7867657e83",
      "rid": "68799fea6e25c660f962a2c7",
      "objectId": "6879a35413c0fe150872ea9e",
      "createdAt": "2025-07-18T01:28:52.561Z",
      "updatedAt": "2025-07-18T01:28:52.561Z"
    },
    ```

    ```json title="twikoo.json"
    {
      "_id": "6d26831b6dcf40f082d2f66d1c7e5c51",
      "nick": "Horean",
      "mail": "uvwxyz@example.com",
      "link": "https://www.hxrch.top",
      "ua": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
      "ip": "98.765.432.10",
      "url": "/posts/hexo-redefine-theme-%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/",
      "comment": "<p>感谢您的认可<img class=\"wl-emoji\" src=\"//unpkg.com/@waline/emojis@1.2.0/bmoji/bmoji_unavailble_doge.png\" alt=\"bmoji_unavailble_doge\"></p>",
      "pid": "f34674e295fa49539b8984cb99a59f94",
      "rid": "f34674e295fa49539b8984cb99a59f94",
      "uid": "51fa62a9deed478544da9e60663434d8",
      "mailMd5": "65b03c3c3cdd117c392cf74f5e588083",
      "master": true,
      "href": "https://blog.hxrch.top/posts/hexo-redefine-theme-%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/",
      "isSpam": false,
      "created": 1752802132287,
      "updated": 1752802132561,
      "top": false
    },
    ```

不知道大家有没有发现些什么，[Waline](https://waline.js.org/) 与 [Twikoo](https://twikoo.js.org/) 这两种评论系统的数据结构非常相似呢，例如 `nick`, `mail`, `comment` 等等；当然也有一些不一样的地方，比如 [Waline](https://waline.js.org/) 的 `objectId` 和 [Twikoo](https://twikoo.js.org/) 的 `_id`、 [Waline](https://waline.js.org/) 的 `status` 和 [Twikoo](https://twikoo.js.org/) 的 `isSpam`。

所以这里就需要我们逐个分析，一一对比，便可得到如下表格数据对应表格：

<style>
    #table-1 th, #table-1 td {
        text-align: center;
    }

    #table-1 tr td:first-child {
        font-weight: 600;
    }
    .tb1-hint {
    	color: gray;
    	margin-left: 4px;
    }
</style>

<table id="table-1" border="1">
<thead>
<tr><th>字段含义</th><th>Waline 字段名称</th><th>Twikoo 字段名称</th></tr>
</thead>
<tbody>
<tr><td>评论者昵称</td><td colspan="2">nick</td></tr>
<tr><td>评论者邮箱</td><td colspan="2">mail</td></tr>
<tr><td>评论者用户代理</td><td colspan="2">ua</td></tr>
<tr><td>评论者IP地址</td><td colspan="2">ip</td></tr>
<tr><td>评论内容</td><td colspan="2">comment</td></tr>
<tr><td>评论者网站</td><td colspan="2">link</td></tr>
<tr><td>评论地址资源路径</td><td colspan="2">url</td></tr>
<tr><td>回复的父评论ID</td><td colspan="2">pid<span class="tb1-hint">(null | 24位MongoDB ObjectId / UUID4)</span></td></tr>
<tr><td>回复的根评论ID</td><td colspan="2">rid<span class="tb1-hint">(null | 24位MongoDB ObjectId / UUID4)</span></td></tr>
<tr><td>点赞人数/列表</td><td colspan="2">like<span class="tb1-hint">(number / string[])</span></td></tr>
<tr><td>评论ID</td><td>objectId<span class="tb1-hint">(24位MongoDB ObjectId)</span></td><td>_id<span class="tb1-hint">(UUID4)</span></td></tr>
<tr><td>Twikoo中的用户ID</td><td>-</td><td>uid<span class="tb1-hint">(UUID4)</span></td></tr>
<tr><td>Waline中的用户ID</td><td>user_id<span class="tb1-hint">(24位MongoDB ObjectId)</span></td><td>-</td></tr>
<tr><td>评论者邮箱的MD5密文</td><td>-</td><td>mailMd5</td></tr>
<tr><td>是否博主评论</td><td>-</td><td>master<span class="tb1-hint">(boolean)</span></td></tr>
<tr><td>评论完整地址</td><td>-</td><td>href</td></tr>
<tr><td>评论状态</td><td>status<span class="tb1-hint">("approved" | "waiting" | "spam")</span></td><td>isSpam<span class="tb1-hint">(boolean)</span></td></tr>
<tr><td>评论插入/创建时间</td><td>insertedAt<span class="tb1-hint">(ISO 8601)</span></td><td>created<span class="tb1-hint">(UNIX 时间戳)</span></td></tr>
<tr><td>Waline中评论创建时间</td><td>createdAt<span class="tb1-hint">(ISO 8601)</span></td><td>-</td></tr>
<tr><td>评论更新时间</td><td>updatedAt<span class="tb1-hint">(ISO 8601)</span></td><td>updated<span class="tb1-hint">(UNIX 时间戳)</span></td></tr>
<tr><td>是否置顶</td><td>sticky<span class="tb1-hint">(number)</span></td><td>top<span class="tb1-hint">(boolean)</span></td></tr>
</tbody>
</table>

:::warning[注意]

非常重要的一点，这里需要注意相同字段在两种不同的评论系统下**数据类型可能不同**。

:::

## 程序构思

为了更好地编写迁移程序，我们需要在这之前梳理程序思路，思考这些数据的具体处理方式。

### 数据处理

> 以下条例中将用 **中括号[]** 代指 [Twikoo](https://twikoo.js.org/) 字段，用 **尖括号<>** 代指 [Waline](https://waline.js.org/) 字段。

- 完全照搬：`nick`, `mail`, `ua`, `ip`, `comment`, `link`, `url`.

- `[_id]` 与 `<objectId>`一一对应，直接生成新的 UUID4 作为`[_id]`.

- 当 `<status>` 为 **"waiting"** 或 **"spam"** 时，`[isSpam]` 为 true.

- 当 `<status>` 为 **"approved"** 时，`[isSpam]` 为 false.

- `[created]` 与 `<insertedAt>` 一一对应（需将 **ISO 8601** 时间转换为 **UNIX 时间戳**）.

  > 为什么不是与 `<createdAt>` 对应呢？因为 `<createdAt>` 可能会随 [Waline](https://waline.js.org/) 系统的更新而改变[我的推测]，而 `<insertedAt>` 代指这条评论插入数据库的时间，就不会受到影响。

- `[updated]` 与 `<updatedAt>` 一一对应（需将 **ISO 8601** 时间转换为 **UNIX 时间戳**）.

- `<url>` 中的非 ASCII 字符（如中文字符）需要进行**URL编码**后才可以存为 `[url]`，否则无效.

- `[href]` 由**博客域名**与 `[url]` 拼接而得.

- `[master]` 取决于评论者邮箱是否为博主邮箱.

- `[pid]`, `[rid]` 格式与 `[_id]` 相同，均为 UUID4 **或者当其为 *非回复评论* 时，其值为 null**.

- `<pid>`, `<rid>` 格式与 `<objectId>` 相同，均为 MongoDB ObjectId **或者当其为 *非回复评论* 时，则不存在**.

- `[mailMd5]` 由 `[mail]` 字段进行 MD5 加密而得，32位或64位皆可，这里取32位.

- `[top]` 与 `<sticky>` 一一对应，当 `<sticky>` 的值大于零时，`[top]` 的值为真.

- `[comment]` 应为 HTML 格式，而 `<comment>` 可以选择是否保留 HTML 标签，所以转换时需要把 `<comment>` 从 Markdown 进一步转换为 HTML.

:::note[提醒]

1. `<user_id>` 字段可以<u>完全不用理会</u>，因为未注册的用户没有这一属性，所以这里以 `<mail>` 作为判断是否为同一用户的依据。
2. `<like>` 字段也可以<u>不用理会</u>，因为 [Waline](https://waline.js.org/) 中的 `<like>` 字段存储数据为点赞总量，而 [Twikoo](https://twikoo.js.org/) 中的 `[like]` 字段则是一个包含点赞用户ID的数组，所以不兼容，只可从 [Twikoo](https://twikoo.js.org/) 到 [Waline](https://waline.js.org/) 单向转换。

:::

### 流程&算法

1. 最开始当然是先读取原来 [Waline](https://waline.js.org/) 的评论数据啦。
2. 第一次循环，遍历原评论数据。因为 `[_id]` 与 `<objectId>` 一一对应，而且需要根据 `<mail>` 确定 `[uid]`，又考虑到后面转换数据时可能有多层嵌套关系，所以第一次遍历原评论数据应该先**建立**以上字段的**映射**，以便后来使用。
3. 第二次遍历原评论数据。这一次则需要根据上文提到的表格进行数据转换，这里需要充分利用好刚才的映射。
4. 然后就可以将转换结果写入文件啦~

这样一来，我们就可以大致画出整个程序的流程图了：

<img src="https://img.hxrch.top/20260220171113316.svg" alt="程序流程图" style="width: 30%; min-width: 250px; margin: 0 auto;" />

## Coding!

数据和算法逻辑都有了，接下来就是纯手工活了——这里使用 [Python](https://www.python.org/) 为编程语言编写了这个迁移程序，依照上面的思路，我设计了一款交互式输入的迁移程序并部署至 [GitHub 仓库](https://github.com/Horean0574/waline2twikoo/)：

::github{repo="Horean0574/waline2twikoo"}

也可以直接在这里下载运行主要代码文件（更多详细说明还请参考 [GitHub 仓库](https://github.com/Horean0574/waline2twikoo/)）：

:::tip[注意]

根据以上流程，本程序需提前安装的第三方库：`click`, `Markdown`:

```bash
pip install click markdown
```

:::

```python title="main.py"
import json
import uuid
import hashlib
import click
from pathlib import Path
from datetime import datetime
from urllib.parse import quote
from markdown import markdown

cidMap = { }
uidMap = { }
res = []


def step_start(prompt):
    click.echo(prompt, nl=False)


def step_complete(another_newline=False):
    if another_newline:
        click.echo("  完成✅\n")
    else:
        click.echo("  完成✅")


def new_uuid():
    return str(uuid.uuid4()).replace("-", "")


def md5_encrypt(data):
    md5 = hashlib.md5()
    md5.update(data.encode("UTF-8"))
    return md5.hexdigest()


def iso2unix(iso):
    dt = datetime.fromisoformat(iso)
    return int(dt.timestamp() * 1000)


def get_converted(item, site_domain, master_mail):
    url = quote(item["url"])
    return {
        "nick": item["nick"],
        "mail": item["mail"],
        "link": item["link"],
        "ua": item["ua"],
        "ip": item["ip"],
        "url": url,
        "comment": markdown(item["comment"].replace("\n", "\n\n")),
        "pid": cidMap[item["pid"]] if "pid" in item else None,
        "rid": cidMap[item["rid"]] if "rid" in item else None,
        "_id": cidMap[item["objectId"]],
        "uid": uidMap[item["mail"]],
        "mailMd5": md5_encrypt(item["mail"]),
        "master": bool(item["mail"] == master_mail),
        "href": "https://" + site_domain + url,
        "isSpam": bool(item["status"] != "approved"),
        "created": iso2unix(item["insertedAt"]),
        "updated": iso2unix(item["updatedAt"]),
        "top": bool(item["sticky"] > 0) if "sticky" in item else False,
    }


def read_waline(read_file):
    step_start("读取 Waline 评论数据中……")
    with open(read_file, "r", encoding="UTF-8") as f:
        waline = json.load(f)["data"]["Comment"]
    total = len(waline)
    cnt = 0
    step_complete()
    return waline, total, cnt


def establish_map(waline):
    step_start("映射建立中……")
    for item in waline:
        cidMap[item["objectId"]] = new_uuid()
        if item["mail"] not in uidMap:
            uidMap[item["mail"]] = new_uuid()
    step_complete(True)


def convert_all(site_domain, master_mail, waline, total, cnt):
    for item in waline:
        cnt += 1
        step_start(f"{cnt}/{total}: 正在转换来自 [{item["nick"]}] 的评论……")
        res.append(get_converted(item, site_domain, master_mail))
        step_complete()


def write_twikoo(write_file):
    step_start("\n写入文件中……")
    output_path = Path(write_file)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    with open(write_file, "w", encoding="UTF-8") as f:
        json.dump(res, f, ensure_ascii=False, indent=2)
    step_complete()


def main(site_domain, master_mail, master_uid, read_file, write_file):
    global uidMap
    if master_uid != "":
        uidMap = { master_mail: master_uid }
    waline, total, cnt = read_waline(read_file)
    establish_map(waline)
    convert_all(site_domain, master_mail, waline, total, cnt)
    write_twikoo(write_file)


def interactive_input():
    site_domain = click.prompt("你的站点域名")
    bcf = click.prompt("你（博主）有在新的Twikoo评论系统上评论过吗？(y/N)", type=bool, default=False, show_default=False)
    if bcf:
        master_mail = click.prompt("你的电子邮件")
        master_uid = click.prompt("你的 Twikoo UID（可在导出 Twikoo 评论数据后看到）")
    else:
        master_mail = master_uid = ""
    read_file = click.prompt("原 Waline 评论数据文件路径（相对路径，JSON文件）")
    write_file = click.prompt("新的 Twikoo 评论数据文件存储路径（相对路径，JSON文件）")
    click.echo()
    main(site_domain, master_mail, master_uid, read_file, write_file)


if __name__ == '__main__':
    click.echo("Program started.\n")
    interactive_input()
    click.echo("\nProgram ended.")
```

# 后记

总结一下要点：自己制作一个评论数据迁移程序，大概就是 `分析数据结构`、`程序构思` 再到 `编码` 这三个过程，整体上来看难度不大，但是有点费时，不过写完并正确运行之后真的非常有成就感，就会觉得这段时间的功夫没有白费，想想就觉得舒服~ 同时也推荐大家自己去尝试编写这样一个程序。

如果觉得本项目不错的，欢迎在 [GitHub 仓库](https://github.com/Horean0574/waline2twikoo/) 上给个 **Star** 哦~ 感谢大家对本项目的支持！如有任何疑问或想法也欢迎在[仓库](https://github.com/Horean0574/waline2twikoo/)上提交 [Issue](https://github.com/Horean0574/waline2twikoo/issues/new) 或 [Pull request](https://github.com/Horean0574/waline2twikoo/compare)。
</file>

<file path="content/posts/双动线段比例最值问题——反演变换（2）.md">
---
title: 双动线段比例最值问题——反演变换（2）
tags: [数学, 几何, 平面几何, 反演变换, 相似三角形, 圆与直线, 圆幂定理, 转化思想, 动点, 最值问题, 分类讨论, 初中数学]
category: 数学
image: https://img.hxrch.top/202507121716144.webp
description: 本篇文章深入探讨了双动线段比例最值问题，并通过反演变换与相似三角形的概念提供了通解。文章以2025年广州市中考为启发，分为四类不同的运动轨迹情况下讨论，通过几何分析和数学模型转换，指导读者如何找出动点P在不同位置时线段AP与BP之间的最大值和最小值。
published: 2025-07-25 20:53:49+08
updated: 2025-07-25 20:57:15+08
---


> 这篇文章勉强算是反演变换的续章吧，建议提前阅读上一篇，[点我阅读](/posts/几何之利刃反演变换1/)。

受2025年广州市中考第25题第(3)小问启发，作此篇讲解“双动线段比例最值问题”的通解，当然后续也会出一篇文章单独讲解这一道题。

## 详解

本文所指的双动线段指的是两条有一公共动点为顶点、另一点为定点的线段，其中公共动点在一固定轨迹上（直线或圆）运动，数学语言表示如下。

**平面内有两定点 $A,B$ 和一动点 $P$，其中点 $P$ 的运动轨迹已知（直线或圆），连接 $AP,BP$，请求出 $\frac{AP}{BP}$ 的最大值和最小值.**

由题，我们可以将其分为以下四种情况讨论：

### 第Ⅰ类

> **点 $P$ 在<u>不经过</u> $A,B$ 的<span style="color: red;">直线 $l$ 上</span>运动**

![第Ⅰ类](https://img.hxrch.top/202507251219002.svg)

不要紧张，想必很多人刚看到这幅图，都会觉得惊讶：为什么看起来如此简单的线段比例求最值问题的图示这么复杂？

也请不要着急质疑，因为我也觉得这看起来有点小题大做了，不过请大家仔细往下看。

> **（解题思路）** 我们并没有学过在几何中如何求解动线段比例最值，那我们就可以考虑能否将这个未知而陌生的题目转化为我们已经掌握的模型呢？——其实是可以的：$\frac{AP}{BP}$ 的分子和分母都是两个变量，那其实可以考虑把其中一个变为常量，这样题目就被转化为一条线段的最值问题了！

思路很好，那如何实践？

那当然是构造相似三角形（母子相似）！

此时所求代数式已经由两个变量转化为一个变量了，但是图中会多出一个新的动点。要求解一条以该动点为顶点的线段的最值，只需将其运动轨迹求出来就行了，这时候只需要利用[<u>反演变换</u>](/posts/175ae3f9/)，这道题就易如反掌~

证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&在PB上取一点H，使得\angle BAH=\angle APB，连接AH,AB，过点B作BG\perp l于点G，并在其延长线上取一点K，使得\angle BHK=90\degree，取BK中点O，连接OH，射线AO交\odot O于点H_1,H_2.\\
&\because\angle ABH=\angle PBA,\angle BAH=\angle BPA\\
&\therefore\triangle ABH\backsim\triangle PBA\\
&\therefore\frac{AB}{PB}=\frac{BH}{AB},\frac{AH}{AP}=\frac{AB}{BP}\\
&即BH\cdot BP=AB^2,\frac{AP}{BP}=\frac{AH}{AB}\\
&\because\angle PBG=\angle KBH,\angle BGP=\angle BHK=90\degree\\
&\therefore\triangle PBG\backsim\triangle KBH\\
&\therefore\frac{PB}{KB}=\frac{BG}{BH}\\
&即BG\cdot BK=BH\cdot BP=AB^2\\
&\because A,B为定点\\
&\therefore AB^2为定值，BG\cdot BK为定值\\
&又\because BG为定值\\
&\therefore BK为定值\\
&在\mathrm{Rt}\triangle BHK中，O为BK中点\\
&\therefore OH=\frac{1}{2}BK=OB=OK\\
&\therefore 点H在以O为圆心，OB为半径的圆上运动\\
&\therefore 在\triangle AOH中，AH\leq AO+OH=OH_2,AH\geq AO-OH=AH\\
&即AH_{max}=AH_2,AH_{min}=AH_1\\
&\because\frac{AP}{BP}=\frac{AH}{AB}\\
&\color{red}{\therefore(\frac{AP}{BP})_{max}=\frac{AH_2}{AB},(\frac{AP}{BP})_{min}=\frac{AH_1}{AB}}
\end{align}
$$
看到这里，不知道你有什么感想，看似复杂的图形，实际上思路和步骤都非常简洁，并没有那么夸张。

有的同学就要说了，像这种题在坐标系里面代数不是很快就解决了吗？嗯，是这样的，但是这里分享几何做法主要是为了开拓大家的眼界和对此种题目的看法，真正遇到时拥有多一个选择，做到灵活运用。

但不可否认地，这一种利用相似转化和反演变换的做法不一定是几何做法中的最优解，但是我暂时没有找到比这更好的做法了，所以目前还是以此为标准几何法。

#### 特殊情况

如果有同学想知道若点 $A,B$ 分别在直线 $l$ 的两侧改怎么办，那就把“**将军饮马**”这四个字甩到他脸上^_^，因为只需要将其中一点关于直线 $l$ 作对称就可以了，这与将军饮马的思路完全没有差别。

### 第Ⅱ类

> **点 $P$ 在<u>不经过</u> $A,B$ 的 <span style="color: red;">$\odot M$ 上</span>运动**

![第Ⅱ类-复杂的做法](https://img.hxrch.top/202507251219613.svg)

是不是看起来更乱了？

这幅图其实是[*第Ⅰ类*](#第ⅰ类)解题方法的变体，思路可以说是完全一致，只是运用到的反演变换模型由“<u>线生线</u>”变成了“**圆生圆**”。

但是在这里，我们并不需要这么复杂地来解，因为对于这一类，有比直接运用反演变换求动点轨迹更简洁的方法，详情见下。当然如果你愿意，也可以照着[*第Ⅰ类*](#第ⅰ类)的思路理解它的原理。

![第Ⅱ类-更为简单的做法](https://img.hxrch.top/202507251557389.svg)

这一种做法并没有直接运用反演变换，而是汲取了反演变换的**转化思想**，同样是构造相似三角形，但不同点在于直接利用**圆幂定理**，不仅将两个变量减少为一个，还满足了变量所含动点的轨迹已知的完美条件，是天赐的好机会啊！

> 还不知道**圆幂定理**是什么的同学，那你一定没有看上一篇反演变换的文章💢，或者你想直接看[*有关圆幂定理的介绍*](/posts/acaa9919/)？

这种做法证明如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
&记射线AP与\odot M另一交点为P'，在射线AB上取一点H，使得\angle AP'H=\angle B，连接P'M,P'H，作射线HM交\odot M于点P'_1,P'_2.\\
&\because\angle P'AH=\angle BAP,\angle AP'H=\angle ABP\\
&\therefore\triangle P'AH\backsim\triangle BAP\\
&\therefore\frac{AP'}{AB}=\frac{AH}{AP}\\
&即AB\cdot AH=AP'\cdot AP\\
&在\odot M中，记其半径为r，根据圆幂定理\\
&得AP'\cdot AP=AM^2-r^2\\
&其中AM和r都是定值\\
&\therefore AP'\cdot AP为定值\\
&即AB\cdot AH为定值\\
&又\because AB为定值\\
&\therefore AH为定值\\
&\because\triangle P'AH\backsim\triangle BAP\\
&\therefore\frac{AH}{AP}=\frac{P'H}{BP}\\
&即\frac{AP}{BP}=\frac{AH}{P'H}\\
&在\triangle MP'H中，P'H\leq MP'+MH=P'_2H,P'H\geq MH-MP'=P'_1H\\
&\therefore (\frac{AH}{P'H})_{min}=\frac{AH}{P'_2H},(\frac{AH}{P'H})_{max}=\frac{AH}{P'_1H}\\
&\color{red}{即(\frac{AP}{BP})_{max}=\frac{AH}{P'_1H},(\frac{AP}{BP})_{min}=\frac{AH}{P'_2H}}
\end{align}
$$
总的来说，这一种做法巧妙地运用圆幂定理构造相似，以极大地减少步骤。

#### 特殊情况

相比[*第Ⅰ类*](#第ⅰ类)的特殊情况，这一类会稍微复杂一些，可能会出现**点 $A,B$ 都在 $\odot M$ 内**、**其中两点分别在圆内和圆外**两种情况。

经实践，发现其解决方案也大差不差，几乎没有改动，以上详细证明过程似乎仍然有效，见下图。

![第Ⅱ类-特殊情况](https://img.hxrch.top/202507251219808.svg)大家可以对照着普通情况的思路尝试自行推导，难度应该是不大的。

### 第Ⅲ类

> 点 $P$ 在**经过** $A,B$ 其中一点的圆或直线上运动

这一类看似困难，实则异常简单。

我们只需关注 $\frac{AP}{BP}$ 这一所求代数式：

- 若点 $A$ 在点 $P$ 的运动轨迹上，则按照前两类的对应方法正常求解。
- 若点 $B$ 在点 $P$ 的运动轨迹上，则代数式 $\frac{AP}{BP}$ 没有最大值，因为 $BP$ 可以无限趋近但不等于于 $0$，这会使得代数式 $\frac{AP}{BP}$ 的值无穷大。

### 第Ⅳ类

> 点 $P$ 在**经过** $A,B$ **两点**的圆或直线上运动

这一类就没必要讲了吧，与[*第Ⅲ类*](#第ⅲ类)的思路相近对所求代数式 $\frac{AP}{BP}$ 进行简单分析即可。

## 总结

这篇文章的知识应该不算难，大家可以多次食用，若有不懂之处可以在下方评论区相互讨论，也可发表问题，我将会在看到消息后第一时间回复。

其实，对于[*第Ⅰ类*](#第ⅰ类)的辅助线构造方式，我还编了一个小口诀**“弟弟心动”**，是谐音为*“顶定新动”*，意即<span style="color: red;">构造的母子相似的公共顶角应该靠在定边 $AB$ 上，构造出的新点 $H$ 应该在动边 $AP$ 或者 $BP$ 上</span>，这样可以省去做题时试错的时间，极大地减少做题失误，就可以提高我们的解题效率了！
</file>

<file path="content/posts/我的个人主页搭建记录.md">
---
title: 我的个人主页搭建记录
tags: [记录, 个人, 个人主页, 搭建]
category: 开发
image: https://img.hxrch.top/homepage_screenshot_cut.webp
description: 这篇文章记录了作者搭建个人主页的过程与心路历程。从最初的灵感到明确计划，作者经历了时间的拖延与个人兴趣的转变，最终在2025年7月29日顺利完成了自己的个人主页。文章中分享了灵感来源、所用模板、修改过程以及今后优化的计划，并附上了个人主页的链接和效果图。
published: 2025-08-01 08:08:12+08
updated: 2025-08-01 08:55:43+08
---


## 写在前面

> 终于迎来了这一天！
>
> 我拥有了自己的[个人主页](https://www.hxrch.top)~
>
> tips: `https://www.hxrch.top`

以下为内心独白：

:::tip[我想说的]

👉[点我访问](https://www.hxrch.top)👈

👉[点我跳转](https://www.hxrch.top)👈

👉[点我观摩](https://www.hxrch.top)👈

👉[点我欣赏](https://www.hxrch.top)👈

👉[点我模仿](https://www.hxrch.top)👈

👉<a id="taunt" href="https://www.hxrch.top" target="_blank" rel="noopener">点我**嘲讽**</a><i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i>👈

:::

---

~~嘲讽~~完了，现在来进入正题。

## 灵感💡

这件事情已经是拖了很久的了。自我个人博客刚在[Vercel](https://vercel.com)部署后的一两个月（2023.10左右），我就开始盘算着，何时我也能有一个属于自己的个人主页，相当于一个自己的互联网名片，当时就是觉得搭建一个个人主页可以大大提升我自身的成就感，且不亚于搭建个人博客所带来的。

但是这样的想法似乎并没有持续多久——因为当时我已经深深地被[florr.io](https://florr.io)这款页游深深的吸引住了，也是从那时起，我开始了为数不多的剪辑工作，在[B站](https://bilibili.com)投稿了我的第一条视频。在我沉迷这款游戏的那段日子里，我每次打开电脑时，身体都会不受控制地玩起了florr，可能是由于那种矛盾心理的存在，在做个人开发与玩游戏之间，相信大多数人也都会选择放弃个人开发，毕竟哪会有人能抵得住~~玩游戏这一比较放松的事情~~啊。为我自己开发一个个人主页网站的任务就这么被搁置了。

这一放，就是近乎两年。

早在2024年2月这个正值春节喜庆氛围的日子里，我的florr账号就已被`Permanently Ban`（永久封禁）了，原因是共号被举报了。我当时也确实没有明白凭什么一个小小的页游都要把共号这件事抓得这么严，甚至到了封号的地步，人家很多大型游戏都没有这样的限制，但这事过都过了，也没什么需要阐明的了。

账号被封了后，我特别难受，总感觉放不下这事，我当时又去测了一遍`MBTI`，我甚至直接从e人变成了i人！！（虽然我本来也并没有特别e）

而2025年开始，我就不得不忙于中考的备考事务了，中考前的八九个月我已全面停止开发及维护任何项目。换来的是还算不错的中考成绩。

虽然中考后的这个暑假是基本没有作业的（只是初中学校没有，高中学校还是稍微布置了一些，~~Emmm即便我初高中是在同一所学校~~），我正打算开发一个个人主页，但是由于我太热爱数学了，中考完后仍然不肯放下，即便不是数竞生也想表达一下自己~~（又菜又爱玩）~~，于是放假后接触电脑的时间大部分都花在了写数学相关的文章上面。到目前也就发表了三四篇文章，应该没什么人看，但是我个人觉得还是成就感满满的。

那么回到正题，为自己搭建个人主页这件事就这样一直拖延到了2025年7月29日的晚上，也就是三天前。最开始我在考虑是否需要我自己从零开始写代码：排版布局、做样式、写交互……然而我很快找到了反驳这一做法的至少三点理由：

1. 自己从零开始写代码耗时太长，耗费精力多，后续维护难度大；
2. 由于中考这一年我几乎没有写过代码，CSS样式等可能有所遗忘或技术退步；
3. 我当时还没有想明白具体要开发什么风格的个人主页，页面结构也还没有定稿；

现在选择就很明确了，我只能利用一些现成的个人主页模板或进行改编，在互联网上一番探索后，找到了一些我比较欣赏的：

- [权朝阳 | 矩阵革命](https://quancy.cn)，这位不得不提，真的是前端方面的大奆佬，尤其是TA的个人主页2.0版本的设计，通过3D立体视觉效应配合鼠标滚轮动画，绝对是一流的。相比之下，我的能力还是太太太有限了~~（其实并不能相提并论）~~。

![权朝阳 | 矩阵革命](https://img.hxrch.top/202508010720802.webp)

- [SimonAKing](https://simonaking.com)，这位的前端技术也比较强，尤其是TA主页的背景动画设计十分艳丽，而且还是交互式的，用户可以通过鼠标拖动来激活这些样式。

![SimonAKing](https://img.hxrch.top/202508010720101.webp)

- [Zyyo](https://zyyo.cc)，这一位的个人页面并没有很突出，但是各样式布局都还算是不错的，页面整体比较有规划。这也是我目前正在使用的一款开源项目，这款个人页面的开发者还提供了`加收¥20的带后台的PHP版本`，但我觉得我并不需要，~~就以我目前的前端能力来说~~。开源地址在这里：[https://github.com/ZYYO666/homepage/](https://github.com/ZYYO666/homepage/).

![Zyyo](https://img.hxrch.top/202508010726765.webp)

我的灵感💡由此迸发~

于是我就开始改造改项目，没有`Fork`，在原版的基础上稍微改了改一些样式：就如黑夜模式的背景逻辑被我改为不再是纯黑色，而是另一张背景图，我个人觉得还是不错的（虽然用的是本博客主页的黑夜模式的同一个背景图），加上了原有的*高斯模糊*，整个页面看起来还是挺秀的。

此外左下角的*个人事件时间轴*也花费了我很大心思。为了尽可能追根溯源我在互联网上的痕迹，我不得不去各大与开发相关的网站中寻找注册时间等等，甚至如[Vercel](https://vercel.com)这一种找不到注册时间的，只能回头翻我的邮箱收件箱了T_T，好在我几乎没有删过邮件，像这些验证码、注册的邮件的保存还是挺不错的。

当然还有许多我对这款个人主页的小改造，此处予以省略……

## 成果🍎

由此一来，[个人主页](https://www.hxrch.top)在经过我的修修补补后大功告成了！地址为`https://www.hxrch.top`，以下为效果图。

![Horean's Site](https://img.hxrch.top/homepage_screenshot.webp)

:::note[持续完善]

后续还会有对个人主页的持续优化，包括但不限于页面结构、页面样式等，大家记得常来呀٩(•̤̀ᵕ•̤́๑)ᵒᵏᵎᵎᵎᵎ

:::
</file>

<file path="content/posts/新高一，新题型.md">
---
title: 新高一，新题型
tags: [数学, 周测, 高一, 代数, 集合, 新题型, 分类讨论, 复盘]
category: 数学
description: 这篇文章讲述了博主在新高一在开学第一周参加数学周测的故事。紧张的军训结束后仍积极地面对高中的新生活。虽然这次周测的形式有些出乎意料，但考试的结果和过程都反映出学习中的重要问题。本文详细地分析了这次的周测试卷，讨论了各种题目的特点和解题方法，同时也反思了自己的错误和未来努力的方向。
image: https://img.hxrch.top/202509061201640.webp
published: 2025-09-06 11:23:49+08
updated: 2025-09-06 12:02:36+08
---


这是开学第一周，刚刚经历过七天军训和五天集训的同学们，似乎心中并无太大波澜，毕竟暑假的结束，并不是我不愿意、你不愿意就可以逃避了的。所以抱有最佳的精神状态迎接新的高中生活是非常有必要的。

按照本校惯例，新高一即便是开学第一周也需要进行周测——数学周测。怎么一上来就已经开始考验了？并没有人知晓，只是平静地随时间而去，人人都只想换来一份开门红，我亦不例外。

话都说到这儿了，这篇文章的主题应该十分明确吧——那就是对第一周数学周测卷的**全面复盘**！

这里可以先给大家看一下整一幅卷面：

![周测卷前两页](https://img.hxrch.top/202509052246385.webp)

![周测卷后一页](https://img.hxrch.top/202509052246430.webp)

因为通常数学周测是在周二下午进行的，所以实际上在本次周测前我只上了两节数学课，但得益于我们优秀的数学老师**钟老师**（高中正高级教师呢）的高效教学，集合这一块我们班只花了一节半课时便掌握了，~~足以证明我们班学习效率之高~~，当然另外半节课是作为新高一礼物的*吹水环节*。

忘记说了，整一份卷子的总分是90，其中还是有许多我没见过的新题型的，然而我仅仅只是达到了钟老师眼中的**及格线**80分往上一点，82分（~~比我预估中的满分差了一些😢~~），但人不可能总是完美的，所以适当给予自己一些容错空间也并非什么不好的事情，与此同时也暴露出了我的一些问题，包括做题习惯。

就如第11题，这道题其实对于普通学生来说也很简单，只需简单分类讨论即可解出，只不过是步骤麻烦了一些，同时也存在更大的局限性（？）——相比技巧**穿针引线法**来说逊色了不少：我们只需先令不等式左侧等于 $0$ 求出其根，然后开始*穿线*，这里就不再过多介绍了。这种方法是很容易掌握的，但是问题就出现在**读图**过程中，既然是要求**大于或等于** $0$ ，那么就必须考虑等于 $0$ 的情况，即当 $x=1$ 时。故这道小题的最终答案应为 $(-\infty,-1]\cup[3,+\infty)\cup\{1\}$。一道填空题5分啊啊啊啊啊，这分丢得太心痛了……

我的唯二失分中另一处就是第13题的第(2)小问了，这个的失分原因很简单，就是没有**检验**，没有真正做到所谓的**边做边检查**，以至于最后多写了范围……应为 $a\in (1,+\infty)$，就没有后面的 $-3$ 和 $\frac{9}{25}$ 了。

总之以上两道错题都可以归结为**非智力因素错误**，这是考试中最最最忌讳的情况，今后必须要尽可能减少这类错误，当然没有是再好不过的了！

最后其实还有一道题我比较想在这里提一下，就是14题的第(3)小问，虽然这一道题我拿了满分，但是我个人认为它还是比较有价值的，值得鉴赏。这一小问看似困难，实则只需要我们找到任意一个突破口即可轻松**拿捏**\~

这里再复述一下题面：

<span class="mathjax-align-left"></span>
$$
\begin{align}
14.&\enspace 已知集合A包含有n(n\in\mathbf{N^*})个元素，A^*=\{x+y|x,y\in A\}.\\
&(1)\enspace 若A=\{0,1,2\}，写出A^*;\\
&(2)\enspace 写出一个A^*，使得A=A^*;\\
&(3)\enspace 当n=4时，是否存在集合A，使得A^*=\{2,3,5,6,7,8,10\}\mathrm{？}若存在，请求出此时的集合A；若不存在，请说明理由.
\end{align}
$$
其中前两小问还算是比较简单的，不过要在第(1)小问拿到满分，就必须写全集合内容，**需要注意 $\boldsymbol{x}$ 和 $\boldsymbol{y}$ 是可以相等的**，其他内容就不再过多赘述了，答案如下。

<span class="mathjax-align-left"></span>
$$
\begin{align}
解\mathrm{：}&(1)\enspace A^*=\{0,1,2,3,4\}\\
&(2)\enspace 当A^*=\{0\}时，A=A^*
\end{align}
$$
接下来是第(3)小题，这篇文章我将介绍两种不同的解法，都有可学习之处和参考价值：

#### 解法 Ⅰ

> 这一类解法是老师同学们普遍认可的，其因是比较容易理解，步骤也较为简单。

根据题意，我们可以知道集合$A$中存在4个元素，那我们不妨设 $A=\{a,b,c,d\}\enspace(a,b,c,d\in\mathbf{R})$，使得 $a<b<c<d$，那么再根据不等关系，可得如下不等式链：
$$
2a<a+b<2b<b+c<2c<c+d<2d
$$
并且我们可以知道，对于集合$A^*$中的元素$t$，有 $t_{min}=2a,t_{max}=2d$，且次小的元素为 $a+b$，次大的元素为 $c+d$，由此我们可以列出如下方程组并解出 $a,b,c,d$ 的值：
$$
\left\{\begin{aligned}
&2a=2,\\
&a+b=3,\\
&c+d=8,\\
&2d=10
\end{aligned}\right.\Rightarrow
\left\{\begin{aligned}
&a=1,\\
&b=2,\\
&c=3,\\
&d=5
\end{aligned}\right.
$$
故此时集合$A$应为$\{1,2,3,5\}$，然而当我们取 $x=1,y=3$ 时，会得到 $x+y=4$，即应有 $4\in A^*$，但这与题目条件**矛盾**，所以**不存在**符合题意的集合$A$！

#### 解法 Ⅱ

> 这一种解法是博主本人在考场上想出来的，虽然并不比上一种解法简单，但是依然值得一看。

这一种做法的切入点就在于**二倍关系**，我们从题目条件中可知，集合$A$所有的元素的二倍都属于集合$A^*$（$x=y$ 时），数学语言表示如下：
$$
\forall a\in A,\enspace 2a\in A^*
$$
所以结合这个二倍关系和偶数的性质，我以集合$A$中的元素**是否全为整数**为依据进行如下分类讨论：

+ 当集合$A$中的元素全为整数，即 $\forall a\in A,\enspace a\in\mathbf{Z}$ 时，因为 $2a\in A^*$，所以集合$A^*$应该至少含有4个偶数，而我们又发现集合$A^*$中恰好含有4个偶数：$2,6,8,10$，故集合$A$可以确定下来，即

$$
A=\{1,3,4,5\}
$$

与上一种解法同理，当 $x=1,y=3$ 时，$x+y=4,\enspace 4\in A^*$，与题目条件**矛盾**，故此分类**不存在**对应集合$A$.

+ 当集合$A$中的元素不全为整数，即 $\exists a\in A,\enspace a\notin \mathbf{Z}$ 时，又因为 $2a\in A^*$，所以 $\exists 2a\in A^*,\enspace 2a\notin\{t|t=2m,m\in\mathbf{Z}\}$，用自然语言来描述即：我们在集合$A^*$中任选4个元素，但其中**至少**有一个元素**不是偶数**，则这些**元素的一半**的集合就是$A$，但是由于 $\mathrm{card}(A^*)=7$ （集合$A^*$的元素个数为7），且其中有且仅有3个**非偶数元素**，所以在满足条件的情况下，我们任选的4个元素之中有**至少**一个**偶数元素**，所以此时集合$A$中**至少**有一个**整数元素**，即 $\exists a\in A,\enspace a\in \mathbf{Z}$.

整合一下以上所得信息，可知此分类下的集合$A$中**至少存在一个整数元素，也至少存在一个非整数元素**，那么接下来我们只需令其中一个**整数元素**为 $x$，其中一个**非整数元素**记为 $y$，则必然有 $(x+y) \notin \mathbf{Z}$，即集合$A^*$中存在**非整数元素**，但这与题目条件**矛盾**，故此分类**不存在**对应集合$A$.

---

综上所述，**不存在**符合题意的集合$A$！



到这里，整张卷就复盘得差不多了，其中新题型确实不少，虽然大部分都做对了，但还是必须再次强调一下应尽量避免**非智力因素错误**的题目，这样失分实在太冤了！对于最后一题，第二种解法可能会更加难理解，这里可以作为一种思维的拓展，了解即可。

希望自己能够更上一层楼，期待下一周的周测！
</file>

<file path="content/posts/GitHub-PicGo-搭建一个属于自己的图床.md">
---
title: GitHub + PicGo 搭建一个属于自己的图床
tags: [GitHub, PicGo, 图床]
category: 开发
description: 手把手教你如何搭建一个完全属于自己的图床，完全免费，而且空间无限量！
published: 2023-09-01 13:40:21+08
updated: 2024-08-16 16:34:19+08
---


>  想必大家肯定都很想拥有一个完全属于自己的图床吧

那么今天，为了帮助大家实现这个愿望，我花了亿点时间写了一篇博客教程，喜欢的话可以向其他人推荐一下哦。

---

那么，进入正题：

在我们搭建图床之前，我想应该很多同学们都有过这样的经历：

- 花了很长时间在网上找免费图床的网站，但是却发现空间根本不够用。
- 本已经信任了很久的图床网站，却突然有一天崩掉了，一夜之间全部链接都无法显示。

为了解决这些问题，我们自然而然的就想到了自己搭建一个稳定的图床，详细步骤见下。

# 新建 Git 仓库

GitHub 账号应该就不用我多说了吧，如果还没有的请前往 [GitHub 主页](https://github.com) 注册 GitHub 账号。

1. 我们在 GitHub 控制面板找到右上角的 小加号，再点击 `New repository` 新建一个仓库。

![](https://img.hxrch.top/202309011356018.webp)

2. 在新建仓库的页面，我们在 `Repository name` 那里填上 `img-host` （也可以换成其他你喜欢的仓库名称），`Description` 那里填写上你的仓库描述。

{% notel red fa-circle-exclamation 注意 %}
一定要选择 Public 公开仓库，否则可能无法访问你存储的图片。
{% endnotel %}

![](https://img.hxrch.top/202309011356020.webp)

接着点击 `Create Repository` 创建仓库。

最后我们就可以手动把图片推送到仓库里面去啦，到时候访问仓库图片地址就可以了！

# 获取 GitHub Token

在 GitHub 主页，点击右上角你的头像，在出现的菜单里选择 `Settings` 进入设置。

![](https://img.hxrch.top/202309011356022.webp)

再在左侧菜单栏选择 `Developer settings` 进入开发者设置。

![](https://img.hxrch.top/202309011356024.webp)

然后在左侧选择 `Personal access tokens`，再选择 `Tokens (classic)`，进入以后，点击右上角 `Generate new token` 选择 `classic` 版生成新的密钥。

![](https://img.hxrch.top/202309011356025.webp)

接下来 GitHub 可能会让你输入密码以确定是本人操作，这里正常输入密码就行了。

然后 Token 名称自己能知道是什么就行，有效日期作者推荐无期限（No Expiration），不然每次到期还要再新建一个，还要更改配置，然后下面的 Token 权限选择只需要勾选 repo 就可以了，其他权限不需要用到。

![](https://img.hxrch.top/202309011356026.webp)

点击 `Generate token` 生成密钥，然后一定要记得复制生成的密钥，它只会显示一次！

![](https://img.hxrch.top/202309011356027.webp)

最后可以选择把复制的密钥存起来，而且不要被别人看到，以防丢失或泄露。

# 使用 PicGo 上传图片

但是我们直接手动推送图片到仓库的话，可能会有一系列麻烦的过程，所以，有请我们今天的主角：**PicGo**！

PicGo 可以帮助我们更方便地上传图片，[PicGo 下载链接](https://github.com/Molunerfinn/PicGo/releases)。

下载安装好后，我们打开 PicGo，在左侧导航栏选择 `图床设置`，然后选择 GitHub。

接下来是 GitHub 仓库设置的填写：

- `设定仓库名`：`<GitHub 用户名>/<图床仓库名>`。
- `设定分支名`：默认 `main` 就可以了。
- `设定Token`：上文提到的 GitHub Token，复制粘贴进去就行。
- `设定存储路径`：如果没有留空就行。
- `设定自定义域名`：此处我们选择用 `jsdelivr` 来加速访问，填写 `https://cdn.jsdelivr.net/gh/<GitHub 用户名>/<图床仓库名>`。

![](https://img.hxrch.top/202309011356021.webp)

最后选择左侧导航栏 `上传区`，可以把图片拖进去，或者是点击浏览选择文件，皆可上传成功！

上传成功后就可以到你的 GitHub 仓库查看啦，如果你按照上文使用了 `jsdelivr` 加速，那么访问地址为：`https://cdn.jsdelivr.net/gh/<GitHub 用户名>/<图床仓库名>/<存储路径>/<图片文件名>`，或者在左侧导航栏 `相册` 处找到图片复制链接，这样就不用担心你的博客没有一个可以依靠的图床啦！

# 可能会遇到的问题

如果你没有上传成功图片，那么可能是以下原因造成的。

1. `图床设置` > `GitHub` 没有调整好，可以仔细对照着你的 GitHub 仓库信息修改一下。

2. 如果你正在使用 `Watt Toolkit` （原名 `Steam++`） 加速的话，请尝试先暂停加速，再去上传试试，这次应该能够上传成功，如果嫌太麻烦的话，作者可以推荐另一个好用的加速器：[Dev Sidecar](https://github.com/docmirror/dev-sidecar/releases)，用 `Dev Sidecar` 加速时不会导致 PicGo 图片上传失败。

3. 如果你的图片文件名与之前上传的有重复，那么建议更改文件名或找到 PicGo 左侧导航栏 `PicGo设置` 处把 `时间戳重命名` 开关打开，这样就不用担心文件重名了，PicGo 会自动把上传后的文件名更改为当前时间戳。

如果你的问题还没有解决，那么请尝试在网络上查找解决方案。
</file>

<file path="content/posts/Hexo-Redefine-Theme-踩过的坑.md">
---
title: Hexo - Redefine Theme 踩过的坑
tags: [Hexo, 踩过的坑]
category: 开发
image: https://img.hxrch.top/202507210903988.webp
description: 本文介绍了使用 Hexo 建立个人博客时可能遇到的问题，尤其是针对 Redefine 主题在 Windows 系统中的具体配置步骤。文章详细讲解了 Hexo 的安装、项目初始化、主题安装与启用，以及一些常见的坑和解决方案，包括 Hexo 版本的选择和 LaTeX 渲染的配置。
published: 2023-08-30 11:16:08+08
updated: 2025-07-11 07:07:36+08
---


> 众所周知，在自建博客这一界有个很强的东西：[Hexo](https://hexo.io)
>
> 但这其中的**坑**，可谓是劝退了不少初学者……

所以，今天我就来帮大家避一下**坑**。

这篇文章的所有内容都是建立在 [Hexo](https://hexo.io) 的其中一个主题 [Redefine](https://github.com/EvanNotFound/hexo-theme-redefine) 上的，且仅针对 Windows 系统，原因嘛……就是我现在在用这款主题。

**PS:** 这篇文章的内容对于其他主题和其他操作系统是否有效暂时未知，本文仅供参考。



# 新手教程

## Hexo

### 安装

> 友情链接：[Hexo安装文档](https://hexo.io/zh-cn/docs/)

其实一开始和官网的教程差不多，可以直接 `npm` 全局安装。

如果有不了解 `Node.js` 的同学，我以后会单独出一篇教程来详细解说……

```bash
npm install -g hexo-cli
```

此外，如果你对 `npm` 熟悉一点，那么你可以仅局部安装 `Hexo`。

```bash
npm install hexo
```

### 初始化

`hexo-cli` 中初始化一个博客项目的命令为 `hexo init <folder>`，其中 `<folder>` 为目录名（亦为项目名）。

```bash
hexo init <folder>
cd <folder>
npm install
```

接下来更详细的初始化步骤见 [建站 | Hexo](https://hexo.io/zh-cn/docs/setup)。

### 启动

通过 `hexo s` 命令启动本地博客。

```bash
hexo s
```

## 主题：Redefine

> 友情链接：[Redefine官方文档](https://redefine-docs.ohevan.com/)

### 安装

```bash
npm install hexo-theme-redefine@latest
```

### 启用

在 Hexo 根目录下（也就是刚才所说的`<folder>`）的 `_config.yml`，把 `theme` 值修改为 `redefine`。

```yaml
theme: redefine
```

### 配置

在 Hexo 根目录下创建 `_config.redefine.yml` 文件，并将 [此处](https://github.com/EvanNotFound/hexo-theme-redefine/blob/main/_config.yml) 的所有内容复制进去。

本文件会自动覆盖主题的配置项，创建本文件的目的是为了方便你在升级主题时，不会丢失你的配置。

### 主题初始化完成

接下来你可以[启动](#启动) Hexo 看看效果。

## 踩过的坑

接下来是咱们今天的重点……

### Hexo 版本

Hexo 的版本一定要不能升到最新版（@7.0.0），就目前作者试验，最高可以升到 @6.3.0 版本，否则 tags 可能会报错 `site.tags.date is not iterable`，可以通过 `npm list` 查看当前所有包的版本，如果需要升级的，可以执行以下指令。

```bash
npm install hexo@6.3.0
```

### LaTeX 渲染

如果想要完整显示所有 LaTeX 公式，首先需要安装插件 `hexo-filter-mathjax`。

```bash
npm install hexo-filter-mathjax
```

然后在 Hexo 配置文件 `_config.yml` 最底下增加如下配置。

```yaml
mathjax:
  tags: none               # 或 'ams' 或 'all'
  single_dollars: true     # 启用单个美元符号作为内联（行内）数学公式定界符
  cjk_width: 0.9           # 相对 CJK 字符宽度
  normal_width: 0.6        # 相对正常（等宽）宽度
  append_css: true         # 将 CSS 添加到每个页面
  every_page: true         # 如果为 true，那么无论每篇文章的前题中的 `mathjax` 设置如何，每页都将由 mathjax 呈现
```

接着必须把 Hexo 原先内置的 Markdown 渲染工具 `hexo-renderer-marked` 卸载，其次安装 `hexo-renderer-pandoc` 。

```bash
npm uninstall hexo-renderer-marked
npm install hexo-renderer-pandoc
```

此时你可以尝试启动 Hexo 本地服务器看看效果，如果执行到 `hexo g` 时报错，那么你需要额外安装一个开源项目 `Pandoc`，仓库地址为 [Pandoc](https://github.com/jgm/pandoc/releases)，最后启动 Hexo 服务器，可以看到所有 LaTeX 及 数学公式 都显示出来了。



---

最后祝大家避过所有坑，走向成功！
</file>

<file path="content/posts/Horean-的持续创作-爱发电-的注册.md">
---
title: Horean 的持续创作 & 爱发电的注册~
tags: [AFD, 创作]
category: 开发
description: Horean 正努力创作HHH世界的各种产物，希望大家能够支持一下，您的支持是我们前进的动力，AFD 已经准备好向大家开放啦，十分感谢！
image: https://img.hxrch.top/202505250635553.webp
published: 2024-05-04 20:45:56+08
updated: 2025-05-25 06:39:25+08
---


> Horean 越来越享受创作的乐趣了，正在努力创作HHH世界的各种产物，感谢大家的支持！

正在开发的项目：

- [Horean 个人网站主页](https://hxrch.top)
- [老师快乐系统](https://tch-sys.hxrch.top)
- [Horean 个人网址导航](https://nav.hxrch.top)

另外，Horean 的 [AFD](https://afdian.com/a/Horean0574) 也已经准备就绪啦，希望大家多多支持，您的支持将会转化为我们前进的动力！

### 谢谢w~
</file>

<file path="content/posts/LeanCloud停止对外服务&第一次博客迁移.md">
---
title: LeanCloud停止对外服务&第一次博客迁移
published: 2026-02-08 21:50:43+08
updated: 2026-02-21 10:52:36+08
description: '本文讨论了因LeanCloud宣布停止对外服务而需要进行个人博客迁移的原因和过程。作者详细描述了选择新博客主题（Firefly）和评论系统（Twikoo）的方法与配置步骤，分享了在迁移过程中面临的问题与解决方案，并最终展示了博客迁移的完整配置过程，旨在帮助其他用户顺利完成类似的迁移。'
image: 'https://img.hxrch.top/20260209075222056.webp'
tags: [技术, 博客, 迁移, 教程, Hexo, Astro]
category: '开发'
draft: false
---

# 起因

哈喽大家好，又已经一个多月没有发表过文章了，毕竟高一的期末考备考也是很重要的，这直接关乎以后的分班（我们已经分完班啦——当然我还是在我校最优秀的那个班😁٩(•̤̀ᵕ•̤́๑)ᵒᵏᵎᵎᵎᵎ）

让我没想到的是，回来一看个人博客发现**天塌了**，我的博客评论系统 [Waline](https://waline.js.org/) 所使用的数据存储服务的提供商 [LeanCloud](https://leancloud.app/) 即将**停止对外服务**，其在[公告](https://docs.leancloud.app/sdk/announcements/sunset-announcement)中明确写出将于2027年1月12日正式停止所有对外服务（详见[停服公告原文](https://docs.leancloud.app/sdk/announcements/sunset-announcement)）。这真的是非常恐怖😱的一件事情，不然等到评论数据全部被销毁之后可就麻烦了。

虽然 [Waline](https://waline.js.org/) 官方有针对这一问题提出解决方案，就是利用如 [MongoDB AtLas](https://www.mongodb.com/products/platform/atlas-database) 等其他提供一定免费额度的数据库来替代原来 [LeanCloud](https://leancloud.app/) 的位置，按照这个步骤确实可以完美迁移评论数据。但是吧，鉴于目前已放寒假，时间稍微充足一些（仅充足一点点，作业非常非常多🤢），且我在一段时间以前就已经想把原来的博客主题 [Redefine](https://redefine.ohevan.com/) 换掉了（不能说不美观吧，也挺简洁的，就是总感觉哪里缺了点什么，整个界面看起来不太简约，总之就是风格我有点不太喜欢[我也不知道我之前为什么会选择这个主题🤔]），于是在种种因素的加持下，我选择了**更换主题**并迁移评论数据。

# 主题的选择

受到我的线上朋友 [小改学习志](https://www.haoyu233.com) 和 [Virelyx (现 路明笔记)](https://luming.cool) 的影响，一说到更换主题，我就在考虑是否可以购入一台云服务器并部署一款由 [神秘布偶猫](https://github.com/kannafay/)（[Oyiso](https://oyiso.cn/)）开发的[动态博客主题](https://oyiso.cn/buy)。但是仔细想想，还是觉得有些没必要，毕竟云服务器的购入成本不会很低，维护成本也不少，还不如继续用一款**静态**博客主题呢。

但是在 [Hexo](https://hexo.io/zh-cn/) 的主题花园中，我同样没有找到一款我个人认为比较优秀的主题，况且利用 [Hexo](https://hexo.io/zh-cn/) 部署个人博客，我发现在切换页面内容的次数多了之后整个页面就会变得很卡，相较之下美观与否就显得不那么重要了，因为性能才决定着体验！

于是我又将目光转向了 [Astro](https://astro.build/)，为什么呢？因为 [Astro](https://astro.build/) 区别于其他框架最大的一个特点就是：它是真的会尽量减少客户端 JavaScript 脚本文件的数量，将几乎所有动态任务交给服务端，以获得最佳的客户端性能体验。这么一看，不就对了吗——这正是我们想要的**性能优化**啊！当然，只有高性能而没有美观界面也肯定是不够的，这就要说到 [Astro](https://astro.build/) 最大的缺陷了：很多好看的主题需要付费，而免费主题大多数都没有好的效果——真的很难在成效与成本之间达到平衡😢。不过好在这真就让我挖到宝藏了！没错，就是 [Fuwari](https://github.com/saicaca/fuwari) 主题！当然我不是在之前没有讲过这个主题，而是真的找不到比它更加优秀的免费主题了，所以——直接开始迁移

<br>

——了吗？

显然不是，因为我很快就发现：原生 [Fuwari](https://github.com/saicaca/fuwari) 并不支持评论系统，而且我还需要更进一步的优化（例如文章目录、站点统计等等），这些都是原生 [Fuwari](https://github.com/saicaca/fuwari) 没有的，那么接下来就有两种选择：

1. 自己对 [Fuwari](https://github.com/saicaca/fuwari) 进行改造，实现想要的功能
2. 直接应用其他的二创主题模板

这应该不用说了，能偷懒肯定还是先偷懒啊（其实是因为自己还没有达到进行完美改造的水平），有别人造好的轮子能不用么？

所以，我最终选择了一款清新的基于 [Fuwari](https://github.com/saicaca/fuwari) 的二创主题 [Firefly](https://astro.build/themes/details/firefly/)，Git仓库地址在[此处](https://github.com/CuteLeaf/Firefly/)，演示站在[这里](https://firefly.cuteleaf.cn/)，它还配备有比较详细的[官方文档](https://docs-firefly.cuteleaf.cn/)，社区支持还不错吧，而且这里基本上有我想要的大部分功能。

简单来说，[Firefly](https://firefly.cuteleaf.cn) 是这样的一款主题：

:::info[Firefly 主题简介]

**Firefly** 是一款基于 **Astro** 框架和 **Fuwari** 模板开发的清新美观且现代化个人博客主题，专为技术爱好者和内容创作者设计。该主题融合了现代 Web 技术栈，提供了丰富的功能模块和高度可定制的界面，让您能够轻松打造出专业且美观的个人博客网站。

- ⚡ **静态站点生成**: 基于Astro的超快加载速度和SEO优化
- 🎨 **现代化设计**: 简洁美观的界面，支持自定义主题色
- 📱 **移动友好**: 完美的响应式体验，移动端专项优化
- 🔧 **高度可配置**: 大部分模块均可通过配置文件自定义

::github{repo="CuteLeaf/Firefly"}

::github{repo="saicaca/fuwari"}

:::

那么最终我选择迁移的主题就确定了：[Firefly](https://firefly.cuteleaf.cn)！这次是真的可以开始迁移了！

# 配置新主题

最开始肯定还是依照[官方文档](https://docs-firefly.cuteleaf.cn/guide/get-started/)的步骤，先把项目环境搭建好并[部署](https://docs-firefly.cuteleaf.cn/guide/deployment/)。接下来再进行项目配置的修改，[Firefly](https://firefly.cuteleaf.cn) 区别于 [Fuwari](https://github.com/saicaca/fuwari) 最明显的点是它的配置文件从 `src/content.config.ts` 单一文件变为了 `src/config/` 一整个文件夹📂里面分类整理好的不同配置文件，这样确实对提高配置效率有着明显帮助。

配置文件树结构大致如下：

```
src/
├── config/
│   ├── index.ts              # 配置索引文件
│   ├── siteConfig.ts         # 站点基础配置
│   ├── backgroundWallpaper.ts # 背景壁纸配置
│   ├── profileConfig.ts      # 用户资料配置
│   ├── commentConfig.ts      # 评论系统配置
│   ├── announcementConfig.ts # 公告配置
│   ├── licenseConfig.ts      # 许可证配置
│   ├── footerConfig.ts       # 页脚配置
│   ├── FooterConfig.html     # 页脚HTML内容
│   ├── expressiveCodeConfig.ts # 代码高亮配置
│   ├── sakuraConfig.ts       # 樱花特效配置
│   ├── fontConfig.ts         # 字体配置
│   ├── sidebarConfig.ts      # 侧边栏布局配置
│   ├── navBarConfig.ts       # 导航栏配置
│   ├── musicConfig.ts        # 音乐播放器配置
│   ├── pioConfig.ts          # 看板娘配置
│   ├── adConfig.ts           # 广告配置
│   ├── friendsConfig.ts      # 友链配置
│   ├── sponsorConfig.ts      # 赞助配置
│   └── coverImageConfig.ts  # 文章封面图配置
```

## 页脚配置

这上面的配置基本上都很轻松，但是我还得要为页脚再添加一些东西，如 [盟国ICP备案](https://icp.gov.moe) 的信息之类的，不然我的个人博客很有可能被取消备案（虽然对我也没有什么实质影响），那这里就要先把配置文件 `src/config/footerConfig.ts` 中 `enable` 改为 `true`：

```typescript title="src/config/footerConfig.ts" startLineNumber=3 "true"
export const footerConfig: FooterConfig = {
	// 是否启用Footer HTML注入功能
	enable: true,
};
```

接下来就要在 `src/config/FooterConfig.html` 中写上需要添加的页脚内容的HTML5代码：

```html title="src/config/FooterConfig.html"
<div class="flex flex-wrap flex-row gap-2 justify-center mt-2">
  <a href="https://www.travellings.cn/go.html" target="_blank" title="开往 | 友链接力">
    <img src="https://img.hxrch.top/travellings.svg" alt="开往 | 友链接力">
  </a>
  <a href="https://icp.gov.moe/?keyword=20251935" target="_blank" title="萌ICP备20251935号">
    <img src="https://img.hxrch.top/moe1935.svg" alt="萌ICP备20251935号">
  </a>
  <a href="https://icp.redcha.cn/beian/ICP-2025080030.html" target="_blank" title="茶ICP备2025080030号">
    <img src="https://img.hxrch.top/cha080030.svg" alt="茶ICP备2025080030号">
  </a>
</div>
```

## 评论配置

终于要开始配置评论系统了💬，我觉得这应该算是本次迁移过程中**难度最大**的一步了。

迈出第一步，正如文章开头提到的，目前的 [Waline](https://waline.js.org) 需要将存储服务从 [LeanCloud](https://leancloud.app) 更换为一种数据库，这看上去倒是没有什么问题。但是，就这么说吧，[Waline](https://waline.js.org) 不是不行，而是将其嵌入到这个新主题 [Firefly](https://firefly.cuteleaf.cn) 中感觉其外观有点不太协调——在我看来，[Waline](https://waline.js.org) 比较适合放在我原来的博客主题 [Redefine](https://redefine.ohevan.com) 中。所以从美观的角度上来讲，我就应该使用另外一种评论系统了，那到底该哪一种好呢？

嗯，没错，就是 [Twikoo](https://twikoo.js.org)！在经过对比之后，我发现 [Twikoo](https://twikoo.js.org) 可以完美适配 [Firefly](https://firefly.cuteleaf.cn) 这个主题，况且 [Twikoo](https://twikoo.js.org/) 在功能上与 [Waline](https://waline.js.org) 其实并没有太大差别，甚至在某种程度上可以说 [Twikoo](https://twikoo.js.org) 比 [Waline](https://waline.js.org) 的配置更加方便，并且 [Twikoo](https://twikoo.js.org) 的配置选项好像也更多一些。

到这里，就可以正式开始配置 [Twikoo](https://twikoo.js.org) 了。

### 第一步：配置 MongoDB Atlas

没错，与 [Waline](https://waline.js.org) 相同，[Twikoo](https://twikoo.js.org/) 也需要用 [MongoDB Atlas](https://www.mongodb.com/products/platform/atlas-database) 作为数据库，虽然有点麻烦，但是为了各位来访者们更佳的阅读体验，这还算不了什么！

> 这一步的配置过程与[官方文档](https://twikoo.js.org/mongodb-atlas.html)上的说明完全一致，这里就不再过多赘述，但是请务必记住保存 MongoDB 数据库连接字符串！后面的步骤需要用到。

### 第二步：云函数部署

这里官方提供了好多种部署方式，包括 [腾讯云](https://cloud.tencent.com)、[Vercel](https://vercel.com)、[Netlify](https://www.netlify.com)、[Railway](https://railway.com) 等等服务商，我这里选择的是 [Vercel](https://vercel.com)，因为我一直以来所有的线上服务都是部署在 [Vercel](https://vercel.com) 上的，比较习惯。

> 这一步与[官方文档](https://twikoo.js.org/backend.html#vercel-%E9%83%A8%E7%BD%B2)上的说明也完全一致，注意最后需要为这个服务绑定自己的域名以便国内访问，并记下该域名。

### 第三步：前端部署

到这里就可以完全把官方文档关掉啦！因为 [Firefly](https://firefly.cuteleaf.cn) 内置了 [Twikoo](https://twikoo.js.org) 的前端模板，所以我们只需要在配置文件 `src/config/commentConfig.ts` 中进行修改即可（其中评论系统类型 `type` 改为 `twikoo`，评论系统配置中的 `envId` 写上刚才在 [Vercel](https://vercel.com) 中为这个服务绑定的自定义域名）：

```typescript title="src/config/commentConfig.ts" startLineNumber=3 "\"twikoo\"" "\"https://blog-twikoo.hxrch.top\""
export const commentConfig: CommentConfig = {
	// 评论系统类型: none, twikoo, waline, giscus, disqus, artalk，默认为none，即不启用评论系统
	type: "twikoo",

	//twikoo评论系统配置
	twikoo: {
		envId: "https://blog-twikoo.hxrch.top",
		// 设置 Twikoo 评论系统语言
		lang: "zh-CN",
		// 是否启用文章访问量统计功能
		visitorCount: true,
	},
    
    /* ... */
};
```

### 第四步：配置 Twikoo

待 [Twikoo](https://twikoo.js.org) 在博客上成功部署后，就可以点击评论区右侧的小齿轮按钮对评论系统进一步配置啦！里面可以设置博主的昵称、邮箱以及网址，需要注意的是 [Twikoo](https://twikoo.js.org) 中的所有评论者的头像图片都源于 [WeAvatar](https://weavatar.com)（当然还可以在 [Firefly](https://firefly.cuteleaf.cn) 配置文件中更改为其他的头像储存商），要想自定义头像，需要在 [WeAvatar](https://weavatar.com) 注册并为相应的邮箱上传头像图片。

此外，配置博客评论系统当然还少不了配置**邮件通知**这一环节，这是**非常非常至关重要**的一步，是连接博主与访客的紧密桥梁，是优秀博客网站的极大体现。鉴于我的上一次博客网站并没有成功配置评论邮件通知，所以我这一次要狠狠地弥补这个遗憾！为了能够成功配置邮件通知，我总结了一下我之前失败的原因：要么是例如 [Outlook](https://www.microsoft.com/zh-cn/microsoft-365/outlook/email-and-calendar-software-microsoft-outlook) 这种已经完全关闭 SMTP 服务的邮箱不可行；要么是像 [网易免费企业邮箱](https://ym.163.com) 这种我无论怎么配置、怎么调试都行不通的邮箱（我觉得大概率还是我个人的技术原因吧[skill issue]）。

所以这一次，我打算选择另外一家企业邮箱服务商！

看到市面上这类服务商有很多，不论国内国际都一样，就例如 [Mailgun](https://www.mailgun.com)、[Mailjet](https://www.mailjet.com) 等等。而我也不知道为什么，我就找到了另外一家不太知名但是体验还不错的服务商 [Resend](https://resend.com)，它提供的免费额度（100条/天 且 3000条/月，详见 [Pricing · Resend](https://resend.com/pricing)）其实足够我这种小型博客网站了。那么在我注册账号、添加域名、添加域名DNS记录并**申请 API Key**（很重要，后面要用）等一系列操作之后，就应该在 [Twikoo](https://twikoo.js.org) 管理面板上配置其 SMTP 等内容了：在其 `配置管理` 选项卡下找到 `邮件通知`，在里面进行如下配置：

| 选项         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| SENDER_EMAIL | bot@hxrch.top（发送者邮箱，[@]后面需是刚刚在 [Resend](https://resend.com) 中绑定的域名） |
| SENDER_NAME  | 评论提醒 - Horean's Blog                                     |
| SMTP_HOST    | smtp.resend.com                                              |
| SMTP_PORT    | 465                                                          |
| SMTP_SECURE  | true                                                         |
| SMTP_USER    | resend                                                       |
| SMTP_PASS    | <刚刚申请的 API Key>                                         |

接下来就可以到 [Twikoo](https://twikoo.js.org) 管理面板中 `配置管理` 选项卡下的 `邮件通知测试` 中输入测试接收者邮箱进行邮件通知测试啦！

如果正确注册并配置 [Resend](https://resend.com) 账号并完全严格按照上面这个模板进行 SMTP 配置，那么不出意外，这里就应该会测试成功！

测试成功之后，就该关注访客评论和收到回复后收到邮件通知的内容啦！对此，[Twikoo](https://twikoo.js.org) 提供了一套相应的**模板变量**，包含评论者的昵称、邮箱、网址、IP地址等信息，所谓配置内容模板，就是要在充分利用这些模板变量的前提下做到页面美观（不追求美观就直接罗列模板变量即可😊）。内置模板变量如下：

| 模板字段          | 字段含义                        |
| ----------------- | ------------------------------- |
| ${SITE_URL}       | *站点地址（根目录，无资源路径） |
| ${SITE_NAME}      | *站点名称                       |
| ${NICK}           | *评论者/回复者昵称              |
| ${COMMENT}        | *评论者/回复者评论内容          |
| ${IMG}            | *评论者/回复者头像              |
| ${POST_URL}       | *评论博文地址                   |
| ${MAIL}           | 评论者/回复者邮箱               |
| ${PARENT_NICK}    | 被回复者昵称                    |
| ${PARENT_COMMENT} | 被回复者评论                    |
| ${PARENT_IMG}     | 被回复者头像                    |

:::tip[提示]

上述表格中 `字段含义` 前面标星号（*）代表评论和回复两个模式都包含这个字段

:::

接下来要做的便是写邮件HTML5模板，当然，我目前没有那么多精力完全由自己打造一款，所以我就在互联网上借鉴了一款邮件通知模板并稍作改进。成品参考图如下：

![邮件通知内容模板效果](https://img.hxrch.top/20260208205015434.webp)

实现代码大致如下（分为*评论模式[master]* 和 *回复模式[visitor]*）**（使用时请往下找到压缩版本以提升加载速度）**：

:::caution[注意]

代码中高亮部分需要替换为自己的博客图标地址！

:::

```html title="master.html" "https://img.hxrch.top/bfav256.webp"
<div class="page flex-col">
	<div class="box_3 flex-col" style="   display: flex;   position: relative;   width: 100%;   height: 206px;   background: #E0F4EACC;   top: 0;   left: 0;   justify-content: center; ">
		<div class="section_1 flex-col" style="   background-image: url('https://img.hxrch.top/bfav256.webp');   position: absolute;   border-radius: 50%;   width: 152px;   height: 152px;   display: flex;   top: 130px;   background-size: cover; "></div>
	</div>
	<div class="box_4 flex-col" style="   margin-top: 92px;   display: flex;   flex-direction: column;   align-items: center; ">
		<div class="text-group_5 flex-col justify-between" style="   display: flex;   flex-direction: column;   align-items: center;   margin: 0 20px; "> <span class="text_1"
				style="   font-size: 26px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #000000;   line-height: 37px;   text-align: center; ">🔔你在 ${SITE_NAME} 中收到了一条新评论！</span> <span class="text_2"
				style="   font-size: 16px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #00000030;   line-height: 22px;   margin-top: 21px;   text-align: center; ">${NICK} 在 ${SITE_NAME} 中发表了新评论</span> </div>
		<div class="box_2 flex-row" style="   margin: 0 20px;   min-height: 128px;   background: #E0F4EACC;    border-radius: 12px;   margin-top: 34px;   display: flex;   flex-direction: column;   align-items: flex-start;   padding: 32px 16px;   width: calc(100% - 40px); ">
			<div class="text-wrapper_4 flex-col justify-between" style="   display: flex;   flex-direction: column;   margin-left: 30px;   margin-bottom: 16px; "> <span class="text_3"
					style="   height: 22px;   font-size: 16px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #008760;    line-height: 22px; ">评论者信息：</span> <span class="text_4"
					style="   margin-top: 6px;   margin-right: 22px;   font-size: 16px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #000000;   line-height: 22px; ">
					<span>- 昵称：${NICK}</span><br>
					<span>- IP地址：${IP}</span><br>
					<span>- 邮箱：${MAIL}</span>
				</span> </div>
			<hr style="     display: flex;     position: relative;     border: 1px dashed #E0F4EACC;  box-sizing: content-box;     height: 0px;     overflow: visible;     width: 100%; ">
			<div class="text-wrapper_4 flex-col justify-between" style="   display: flex;   flex-direction: column;   margin-left: 30px; "> <span class="text_3"
					style="   height: 22px;   font-size: 16px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #008760;    line-height: 22px; ">${NICK} 的评论内容：</span> <span class="text_4"
					style="   margin-top: 6px;   margin-right: 22px;   font-size: 16px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #000000;   line-height: 22px; ">${COMMENT}</span> </div>
			<a class="text-wrapper_2 flex-col" style="   min-width: 106px;   height: 38px;   background: #C0E9D6;   border-radius: 32px;   display: flex;   align-items: center;   justify-content: center;   text-decoration: none;   margin: auto;   margin-top: 32px; " href="${POST_URL}"> <span
					class="text_5" style="   color: #008760;  ">查看详情</span> </a>
		</div>
		<div class="text-group_6 flex-col justify-between" style="   display: flex;   flex-direction: column;   align-items: center;   margin-top: 34px; "> <span class="text_6"
				style="   height: 17px;   font-size: 12px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #00000045;   line-height: 17px; ">此邮件由评论服务自动发出，直接回复无效。</span> <a class="text_7"
				style="   height: 17px;   font-size: 12px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #008760;   line-height: 17px;   margin-top: 6px;   text-decoration: none; " href="${SITE_URL}">前往博客</a> </div>
	</div>
</div>
```

```html title="visitor.html" "https://img.hxrch.top/bfav256.webp"
<div class="page flex-col">
	<div class="box_3 flex-col" style="   display: flex;   position: relative;   width: 100%;   height: 206px;   background: #E0F4EACC;   top: 0;   left: 0;   justify-content: center; ">
		<div class="section_1 flex-col" style="   background-image: url('https://img.hxrch.top/bfav256.webp');   position: absolute;   border-radius: 50%;   width: 152px;   height: 152px;   display: flex;   top: 130px;   background-size: cover; "></div>
	</div>
	<div class="box_4 flex-col" style="   margin-top: 92px;   display: flex;   flex-direction: column;   align-items: center; ">
		<div class="text-group_5 flex-col justify-between" style="   display: flex;   flex-direction: column;   align-items: center;   margin: 0 20px; "> <span class="text_1"
				style="   font-size: 26px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #000000;   line-height: 37px;   text-align: center; ">嘿！你在 ${SITE_NAME} 中收到一条新回复。</span> <span class="text_2"
				style="   font-size: 16px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #00000030;   line-height: 22px;   margin-top: 21px;   text-align: center; ">你之前在 ${SITE_NAME} 中的评论收到来自 ${NICK} 的回复</span> </div>
		<div class="box_2 flex-row" style="   margin: 0 20px;   min-height: 128px;   background: #E0F4EACC;    border-radius: 12px;   margin-top: 34px;   display: flex;   flex-direction: column;   align-items: flex-start;   padding: 32px 16px;   width: calc(100% - 40px); ">
			<div class="text-wrapper_4 flex-col justify-between" style="   display: flex;   flex-direction: column;   margin-left: 30px;   margin-bottom: 16px; "> <span class="text_3"
					style="   height: 22px;   font-size: 16px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #008760;    line-height: 22px; ">您发表的评论：</span> <span class="text_4"
					style="   margin-top: 6px;   margin-right: 22px;   font-size: 16px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #000000;   line-height: 22px; ">${PARENT_COMMENT}</span> </div>
			<hr style="     display: flex;     position: relative;     border: 1px dashed #E0F4EACC;  box-sizing: content-box;     height: 0px;     overflow: visible;     width: 100%; ">
			<div class="text-wrapper_4 flex-col justify-between" style="   display: flex;   flex-direction: column;   margin-left: 30px; "> <span class="text_3"
					style="   height: 22px;   font-size: 16px;   font-family: PingFang-SC-Bold, PingFang-SC;   font-weight: bold;   color: #008760;    line-height: 22px; ">${NICK} 给您回复啦：</span> <span class="text_4"
					style="   margin-top: 6px;   margin-right: 22px;   font-size: 16px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #000000;   line-height: 22px; ">${COMMENT}</span> </div> <a class="text-wrapper_2 flex-col"
				style="   min-width: 106px;   height: 38px;   background: #C0E9D6;   border-radius: 32px;   display: flex;   align-items: center;   justify-content: center;   text-decoration: none;   margin: auto;   margin-top: 32px; " href="${POST_URL}"> <span class="text_5"
					style="   color: #008760;  ">查看详情</span> </a>
		</div>
		<div class="text-group_6 flex-col justify-between" style="   display: flex;   flex-direction: column;   align-items: center;   margin-top: 34px; "> <span class="text_6"
				style="   height: 17px;   font-size: 12px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #00000045;   line-height: 17px; ">此邮件由评论服务自动发出，直接回复无效。</span> <a class="text_7"
				style="   height: 17px;   font-size: 12px;   font-family: PingFangSC-Regular, PingFang SC;   font-weight: 400;   color: #008760;   line-height: 17px;   margin-top: 6px;   text-decoration: none; " href="${SITE_URL}">前往博客</a> </div>
	</div>
</div>
```

压缩版本如下（请直接使用此版本以提升加载速度）：

```html title="master.min.html" "https://img.hxrch.top/bfav256.webp"
<div class="page flex-col"><div class="box_3 flex-col" style=" display: flex; position: relative; width: 100%; height: 206px; background: #E0F4EACC; top: 0; left: 0; justify-content: center; "><div class="section_1 flex-col" style=" background-image: url('https://img.hxrch.top/bfav256.webp'); position: absolute; border-radius: 50%; width: 152px; height: 152px; display: flex; top: 130px; background-size: cover; "></div></div><div class="box_4 flex-col" style=" margin-top: 92px; display: flex; flex-direction: column; align-items: center; "><div class="text-group_5 flex-col justify-between" style=" display: flex; flex-direction: column; align-items: center; margin: 0 20px; "> <span class="text_1"style=" font-size: 26px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #000000; line-height: 37px; text-align: center; ">🔔你在 ${SITE_NAME} 中收到了一条新评论！</span> <span class="text_2"style=" font-size: 16px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #00000030; line-height: 22px; margin-top: 21px; text-align: center; ">${NICK} 在 ${SITE_NAME} 中发表了新评论</span> </div><div class="box_2 flex-row" style=" margin: 0 20px; min-height: 128px; background: #E0F4EACC; border-radius: 12px; margin-top: 34px; display: flex; flex-direction: column; align-items: flex-start; padding: 32px 16px; width: calc(100% - 40px); "><div class="text-wrapper_4 flex-col justify-between" style=" display: flex; flex-direction: column; margin-left: 30px; margin-bottom: 16px; "> <span class="text_3"style=" height: 22px; font-size: 16px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #008760; line-height: 22px; ">评论者信息：</span> <span class="text_4"style=" margin-top: 6px; margin-right: 22px; font-size: 16px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #000000; line-height: 22px; "><span>- 昵称：${NICK}</span><br><span>- IP地址：${IP}</span><br><span>- 邮箱：${MAIL}</span></span> </div><hr style=" display: flex; position: relative; border: 1px dashed #E0F4EACC; box-sizing: content-box; height: 0px; overflow: visible; width: 100%; "><div class="text-wrapper_4 flex-col justify-between" style=" display: flex; flex-direction: column; margin-left: 30px; "> <span class="text_3"style=" height: 22px; font-size: 16px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #008760; line-height: 22px; ">${NICK} 的评论内容：</span> <span class="text_4"style=" margin-top: 6px; margin-right: 22px; font-size: 16px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #000000; line-height: 22px; ">${COMMENT}</span> </div><a class="text-wrapper_2 flex-col" style=" min-width: 106px; height: 38px; background: #C0E9D6; border-radius: 32px; display: flex; align-items: center; justify-content: center; text-decoration: none; margin: auto; margin-top: 32px; " href="${POST_URL}"> <spanclass="text_5" style=" color: #008760; ">查看详情</span> </a></div><div class="text-group_6 flex-col justify-between" style=" display: flex; flex-direction: column; align-items: center; margin-top: 34px; "> <span class="text_6"style=" height: 17px; font-size: 12px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #00000045; line-height: 17px; ">此邮件由评论服务自动发出，直接回复无效。</span> <a class="text_7"style=" height: 17px; font-size: 12px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #008760; line-height: 17px; margin-top: 6px; text-decoration: none; " href="${SITE_URL}">前往博客</a> </div></div></div>
```

```html title="visitor.min.html" "https://img.hxrch.top/bfav256.webp"
<div class="page flex-col"> <div class="box_3 flex-col" style=" display: flex; position: relative; width: 100%; height: 206px; background: #E0F4EACC; top: 0; left: 0; justify-content: center; "> <div class="section_1 flex-col" style=" background-image: url('https://img.hxrch.top/bfav256.webp'); position: absolute; border-radius: 50%; width: 152px; height: 152px; display: flex; top: 130px; background-size: cover; "></div> </div> <div class="box_4 flex-col" style=" margin-top: 92px; display: flex; flex-direction: column; align-items: center; "> <div class="text-group_5 flex-col justify-between" style=" display: flex; flex-direction: column; align-items: center; margin: 0 20px; "> <span class="text_1" style=" font-size: 26px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #000000; line-height: 37px; text-align: center; ">嘿！你在 ${SITE_NAME} 中收到一条新回复。</span> <span class="text_2" style=" font-size: 16px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #00000030; line-height: 22px; margin-top: 21px; text-align: center; ">你之前在 ${SITE_NAME} 中的评论收到来自 ${NICK} 的回复</span> </div> <div class="box_2 flex-row" style=" margin: 0 20px; min-height: 128px; background: #E0F4EACC; border-radius: 12px; margin-top: 34px; display: flex; flex-direction: column; align-items: flex-start; padding: 32px 16px; width: calc(100% - 40px); "> <div class="text-wrapper_4 flex-col justify-between" style=" display: flex; flex-direction: column; margin-left: 30px; margin-bottom: 16px; "> <span class="text_3" style=" height: 22px; font-size: 16px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #008760; line-height: 22px; ">您发表的评论：</span> <span class="text_4" style=" margin-top: 6px; margin-right: 22px; font-size: 16px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #000000; line-height: 22px; ">${PARENT_COMMENT}</span> </div> <hr style=" display: flex; position: relative; border: 1px dashed #E0F4EACC; box-sizing: content-box; height: 0px; overflow: visible; width: 100%; "> <div class="text-wrapper_4 flex-col justify-between" style=" display: flex; flex-direction: column; margin-left: 30px; "> <span class="text_3" style=" height: 22px; font-size: 16px; font-family: PingFang-SC-Bold, PingFang-SC; font-weight: bold; color: #008760; line-height: 22px; ">${NICK} 给您回复啦：</span> <span class="text_4" style=" margin-top: 6px; margin-right: 22px; font-size: 16px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #000000; line-height: 22px; ">${COMMENT}</span> </div> <a class="text-wrapper_2 flex-col" style=" min-width: 106px; height: 38px; background: #C0E9D6; border-radius: 32px; display: flex; align-items: center; justify-content: center; text-decoration: none; margin: auto; margin-top: 32px; " href="${POST_URL}"> <span class="text_5" style=" color: #008760; ">查看详情</span> </a> </div> <div class="text-group_6 flex-col justify-between" style=" display: flex; flex-direction: column; align-items: center; margin-top: 34px; "> <span class="text_6" style=" height: 17px; font-size: 12px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #00000045; line-height: 17px; ">此邮件由评论服务自动发出，直接回复无效。</span> <a class="text_7" style=" height: 17px; font-size: 12px; font-family: PingFangSC-Regular, PingFang SC; font-weight: 400; color: #008760; line-height: 17px; margin-top: 6px; text-decoration: none; " href="${SITE_URL}">前往博客</a> </div> </div></div>
```

有了邮件通知内容模板之后，就可以继续完善刚才的配置了：在 [Twikoo](https://twikoo.js.org) 管理面板中的`配置管理` 选项卡下的 `邮件通知` 中配置如下选项：

| 选项                | 内容                                     |
| ------------------- | ---------------------------------------- |
| MAIL_SUBJECT        | 您在 Horean's Blog 上的评论收到了新回复~ |
| MAIL_TEMPLATE       | <visitor.min.html中的内容>               |
| MAIL_SUBJECT_ADMIN  | Horean's Blog 上有新评论啦~              |
| MAIL_TEMPLATE_ADMIN | <master.min.html中的内容>                |

配置完成后博客的评论系统就应该可以正常运行了！可以在留言板试试评论和回复能否收到邮件通知~

---

> ~~遗憾的是，虽然 [Twikoo](https://twikoo.js.org) 管理面板中有 `导入` 功能，但是不支持从 [Waline](https://waline.js.org) 导入，所以之前的评论数据可能暂时无法迁移到这里，烦请大家谅解🙏~~
>
> 现在已经完成评论系统的数据迁移啦，详见 [数据迁移之「从 Waline 到 Twikoo」](/posts/数据迁移之从-waline-到-twikoo/)。

# 内容迁移

这一步就非常简单了，基本上是无脑搬运，我们只需要注意以下两点：

1. 新主题 [Firefly](https://firefly.cuteleaf.cn) 新建文章时 Frontmatter 的改变，详情参考[官方文档](https://docs-firefly.cuteleaf.cn/press/file/#frontmatter%E5%AD%97%E6%AE%B5%E8%AF%A6%E8%A7%A3)
2. 原主题 [Redefine](https://redefine.ohevan.com) 与新主题 [Firefly](https://firefly.cuteleaf.cn) 博文中 **警告/提示框等** 特殊组件的使用语法和格式的不同，详情参考[官网](https://firefly.cuteleaf.cn/posts/markdown-extended/#%E6%8F%90%E9%86%92%E6%A1%86admonitions%E9%85%8D%E7%BD%AE)

# 其他问题

## KaTeX 自动标记行数

该问题截图如下：

![KaTeX 渲染问题截图](https://img.hxrch.top/20260208210057022.webp)

对于我这种经常发表数学文章的博主来说，博文中数学公式的渲染效果十分重要，然而在上图中每一行的最后面都多了一个行数标签，很明显这不是我想要的效果！所以这个问题不容迟疑，必须迅速解决！

显然，解决思路就是将这个行数标签设置为不可见，这里使用CSS即可，只需在 `src/styles/markdown-extend.styl` 文件中添加如下两行代码：

```css title="src/styles/markdown-extend.styl" ins={1,2}
.eqn-num
  display: none !important
```

现在问题就应该解决了！

## 友链页面添加排序说明

[Firefly](https://firefly.cuteleaf.cn) 默认的友链页面的描述语句是 “**这里是我的朋友们，欢迎互相访问交流**”，我想在其下方添加说明：“**此处的友情链接均以添加至本站的时间先后顺序排列~**”。最开始我尝试着在原来描述语句中注入HTML代码，但是很快发现这条路不行，因为 [Firefly](https://firefly.cuteleaf.cn) 默认会把描述语句转换为纯文本，所以我只好找到了友链页面的源代码文件 `src/pages/friends.astro`，

```tsx title="src/pages/friends.astro" startLineNumber=33 ins={20-28}
<!-- 页面标题和描述 -->
<div class="mb-4">
  <div class="flex items-center gap-3 mb-3">
    <div
      class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70"
    >
      <Icon name="material-symbols:group" class="text-[1.5rem]" />
    </div>
    <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
      {title}
    </h1>
  </div>
  {
    description && (
      <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
        {description}
      </p>
    )
  }
  <div class="mb-8 p-4 rounded-lg bg-(--primary)/8 dark:bg-(--btn-regular-bg) border border-(--primary)/30 dark:border-none backdrop-blur-xs shadow-xs usage-info-box">
    <div class="flex items-start gap-2">
      <Icon name="material-symbols:info-outline" class="text-(--primary) text-lg shrink-0 mt-0.5" />
      <p class="text-sm text-neutral-700 dark:text-neutral-200 leading-relaxed">
        <span class="font-semibold text-(--primary)"></span>
        此处的友情链接均以添加至本站的时间先后顺序排列~
      </p>
    </div>
  </div>
</div>
```

这样就可以满足我想要的效果啦！

# 写在最后

这篇文章终于要结束了，不得不说，[Firefly](https://firefly.cuteleaf.cn) 这个主题确实很好看，也非常实用，在我心目中已经是很高的地位了。

同时也祝这篇文章能够真正帮到那些想将个人博客迁移至 [Firefly](https://firefly.cuteleaf.cn) 主题的同学们，期待各位同学的博客都能长久运行٩(•̤̀ᵕ•̤́๑)ᵒᵏᵎᵎᵎᵎ

---

> 如果说上一篇文章创下了内容最长纪录，那么这篇文章又将再次打破这个纪录！

这次写的文章真的比上次还要长好多，但是写起来并不会那么累——毕竟不是数学题了！

:::note[The End]

好的好的，2026年第二篇文章到此结束啦~

:::
</file>

<file path="content/posts/luogu-HXOI-U330374-密室逃脱.md">
---
title: luogu-HXOI U330374-密室逃脱
tags: [OI, HXOI, 搜索, 广搜，BFS]
category: 题解
description: 洛谷-HXOI U330374-密室逃脱 Std | 题解
published: 2023-08-23 08:19:24+08
updated: 2023-09-01 19:52:20+08
---

[原题链接](https://www.luogu.com.cn/problem/U330374)

Algorithms: `搜索` `广搜，BFS`

---

依照题意，不难发现这是一道很普通的广搜题，只不过是三维广搜。对于这种情况我们只需要添加  `dx`、`dy` 数组的值且再添加一个 `dz` 数组，值如下。

```cpp
dz[6] = {-1, 1, 0, 0, 0, 0};
dx[6] = {0, 0, -1, 0, 1, 0};
dy[6] = {0, 0, 0, 1, 0, -1};
```

在此题中，我们发现除了正常广搜之外，还有两个要点：

1. 小H 拥有一些体力值，某些时候会需要消耗体力拆卸陷阱；
2. 小H 手上的钥匙数量会变化，且可能会有需要钥匙开门的时候。

虽然题面看上去很复杂，但我们只需要仔细分析，其实可以发现：

- 当 小H 有足够的体力时，那么必须拆卸陷阱，否则不将当前状态入队。
- 当 小H 受伤有足够的钥匙时，那么必须开门，否则不将当前状态入队。

这样一来，我们广搜中也只是多了两个 ~~分支结构~~。

$Std$

```cpp title="std.cpp"
#include <iostream>
#include <queue>

#define endl '\n'

using namespace std;

struct Node {
	int z, x, y, t, k, v;
};

const int H = 165;
const int N = 405;

int h, n, m, v, w;
int a[H][N][N], sz, sx, sy;
queue<Node> q;
bool inq[H][N][N];
int dz[6]{-1, 1, 0, 0, 0, 0}, dx[6]{0, 0, -1, 0, 1, 0}, dy[6]{0, 0, 0, 1, 0, -1};

int bfs() {
	int k = a[sz][sx][sy] == 5 ? 1 : 0;
	q.push({sz, sx, sy, 0, k, v});
	inq[sz][sx][sy] = true;
	Node p;
	
	while (q.size()) {
		p = q.front();
		q.pop();
		
		for (int i = 0; i < 6; ++i) {
			int nz = p.z + dz[i];
			int nx = p.x + dx[i];
			int ny = p.y + dy[i];
			int nt = p.t + 1;
			int nk = p.k;
			int nv = p.v;
			
			if (nz < 1 || nz > h) continue;
			if (nx < 1 || nx > n || ny < 1 || ny > m) {
				return nt;
			}
			if (inq[nz][nx][ny]) continue;
			if (a[nz][nx][ny] == 2) continue;
			if (a[nz][nx][ny] == 3) {
				if (nv >= w) {
					nv -= w;
				} else {
					continue;
				}
			} else if (a[nz][nx][ny] == 4) {
				if (nk) {
					--nk;
				} else {
					continue;
				}
			} else if (a[nz][nx][ny] == 5) {
				++nk;
			}
			
			q.push({nz, nx, ny, nt, nk, nv});
			inq[nz][nx][ny] = true;
		}
	}
	
	return 0;
}

int main() {
	ios::sync_with_stdio(false);
	cin.tie(nullptr), cout.tie(nullptr);
	
	cin >> h >> n >> m;
	cin >> sz >> sx >> sy;
	cin >> v >> w;
	for (int k = 1; k <= h; ++k) {
		for (int i = 1; i <= n; ++i) {
			for (int j = 1; j <= m; ++j) {
				cin >> a[k][i][j];
			}
		}
	}
	
	int ans = bfs();
	if (!ans) {
		cout << "No";
	} else {
		cout << "Yes" << endl;
		cout << ans;
	}
}
```
</file>

<file path="content/posts/luogu-HXOI-U331150-密室逃脱2.md">
---
title: luogu-HXOI-U331150-密室逃脱2
tags: [OI, HXOI, 图论, 最小生成树]
category: 题解
description: 洛谷-HXOI U331150-密室逃脱2 Std | 题解
published: 2023-08-25 16:45:27+08
updated: 2023-09-01 19:51:10+08
---


[原题链接](https://www.luogu.com.cn/problem/U331150)

Algorithms: `图论` `最小生成树`

---

不要看题面花里胡哨的，实际上它意思已经很明确了，就是让你在若干个站点存放 **能量补给用具**，使得能量能够扩散到图内每个站点。说到这里应该有些同学觉得，那我存放一个 **能量补给用具** 不就行了吗，这应该都能联通到每个站点啊。

:::danger[警告]

那其实你就大错特错了！

:::

因为它还是要考虑消耗的体力最小啊，那这怎么办……

这时候就需要用上我们的最小生成树了！其实这道题只需要多建一个 **0号虚拟节点**，与其他各个节点相连，就不用考虑每个站点的消耗了，然后再跑一遍 $Kruskal$ 模板，就可以了。

$Std$

```cpp title="std.cpp"
#include <iostream>
#include <algorithm>

using namespace std;

typedef long long ll;

struct Edge {
	int u, v, w;
	
	bool operator < (const Edge &A) const {
		return w < A.w;
	}
};

const int N = 2e3 + 5;
const int M = N * (N - 1);

int n, m, fa[N];
ll ans;
struct Edge e[M];

inline void init() {
	for (int i = 1; i <= n; ++i) {
		fa[i] = i;
	}
}

inline int find(const int &x) {
	return fa[x] == x ? x : fa[x] = find(fa[x]);
}

int main() {
	ios::sync_with_stdio(false);
	cin.tie(nullptr), cout.tie(nullptr);
	
	cin >> n;
	init();
	for (int i = 1; i <= n; ++i) {
		int v;
		cin >> v;
		e[++m].u = 0;
		e[m].v = i;
		e[m].w = v;
	}
	for (int i = 1; i <= n; ++i) {
		for (int j = 1; j <= n; ++j) {
			int w;
			cin >> w;
			if (i != j) {
				e[++m].u = i;
				e[m].v = j;
				e[m].w = w;
			}
		}
	}
	
	sort(e + 1, e + m + 1);
	for (int i = 1; i <= m; ++i) {
		int fu = find(e[i].u);
		int fv = find(e[i].v);
		if (fu != fv) {
			fa[fu] = fv;
			ans += e[i].w;
		}
	}
	
	cout << ans;
}
```
</file>

<file path="content/posts/luogu-HXOI-U332989-身高.md">
---
title: luogu-HXOI U332989-身高
tags: [OI, HXOI, 倍增算法]
category: 题解
description: 洛谷-HXOI U332989-身高 Std | 题解
published: 2023-08-27 22:12:54+08
updated: 2023-08-30 22:31:14+08
---

[原题链接](https://www.luogu.com.cn/problem/U332989)

Algorithms: `倍增算法`

---

依照题意，我们需要每次求出区间 $[l, r]$ 中的最小值，再把他与 小H 的身高 $k$ 作比较。

但是看到数据范围，我们可以发现普通暴力的做法是绝对会超时的，所以考虑**倍增算法**，先用 $O(n \log n)$ 的时间复杂度初始化，以后每次查询都只需要 $O(1)$ 的时间复杂度。

$Std$

```cpp title="std.cpp"
#include <iostream>
#include <cmath>

#define endl '\n'

using namespace std;

const int N = 1e6 + 5;
const int LN = log2(N) + 5;

int k, n, t;
int logx[N], f[N][LN];

inline void init() {
	logx[0] = -1;
	for (int i = 1; i <= n; ++i) {
		logx[i] = logx[i / 2] + 1;
	}
	
	for (int j = 1; j <= logx[n]; ++j) {
		for (int i = 1; i + (1 << j) - 1 <= n; ++i) {
			f[i][j] = min(f[i][j - 1], f[i + (1 << (j - 1))][j - 1]);
		}
	}
}

inline int query(const int &x, const int &y) {
	int j = logx[y - x + 1];
	return min(f[x][j], f[y - (1 << j) + 1][j]);
}

int main() {
	ios::sync_with_stdio(false);
	cin.tie(nullptr), cout.tie(nullptr);
	
	cin >> k >> n;
	for (int i = 1; i <= n; ++i) {
		cin >> f[i][0];
	}
	init();
	cin >> t;
	while (t--) {
		int l, r;
		cin >> l >> r;
		if (k >= query(l, r)) {
			cout << "Yes" << endl;
		} else {
			cout << "No" << endl;
		}
	}
}
```
</file>

<file path="content/posts/oiClass-puji-P1278-树和数tree.md">
---
title: oiClass-puji P1278-树和数tree
tags: [OI, 树结构]
category: 题解
description: oiClass-puji P1278-树和数tree 题解
published: 2023-08-25 11:48:42+08
updated: 2023-08-30 21:24:25+08
---

[原题链接](http://oiclass.com/d/puji/p/1278)

Algorithms: `树结构`

---

## 很水的一道题

只需要判断如果 _**父节点的优先级**_  $\geq$ _**子节点的优先级**_ 就需要加括号。

但是当给左节点加括号时，且父节点与左节点的优先级相同时，括号可以省略。

$Ac Code$

```cpp title="AcCode.cpp"
#include <iostream>

using namespace std;

const int N = 1e5 + 5;

int n, m, a[N], ans;
int g[N][2];

void dfs(const int &u) {
    for (int i = 0; i < 2; ++i) {
        int v = g[u][i];
        if (!g[u][i]) continue;
        if (a[v] <= a[u]) {  // 需要括号
            ++ans;
        }
        if (a[v] == a[u] && !i) {  // 可以省略
            --ans;
        }
        dfs(v);
    }
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr), cout.tie(nullptr);

    cin >> n >> m;
    for (int i = 1; i <= n; ++i) {
        int l, r, x;
        cin >> l >> r >> x;
        g[i][0] = l;
        g[i][1] = r;
        a[i] = x;
    }

    dfs(1);

    cout << ans;
}
```
</file>

<file path="content/posts/oiClass-puji-P21120-征兵.md">
---
title: oiClass-puji P2112-征兵
tags: [OI, 最小生成树]
category: 题解
description: oiClass-puji P2112-征兵 题解
published: 2023-08-24 12:08:30+08
updated: 2023-08-30 22:45:26+08
---

[原题链接](http://oiclass.com/d/puji/p/P2112/)

Algorithms: `最小生成树`

---

## 一眼看出最小生成树

> 赛时不小心把存边数组开大了，结果 MLE……

依照题意，我们可以把总点数看作是 $N+M$，边数最多有 $R$ 条，边权为 $10000 - V_i$，为了给每个点一个编号，我们把女生编为 $X_i + 1$，男生编为 $Y_i + N + 1$。

因为可能不止一个需要单独征集的士兵，所以我们需要建立一个 0号 **虚拟点**，与全部其他节点相连，权值为 $10000$ ，但这个时候边数最多就有 $R + N + M$ 条了（注意数组大小）。

接下来跑一遍 $Kruskal$ 就可以了。

**PS:** 变量解释：

```cpp
// t: T, x: N, y: M, r: R

// n: 总点数, m: 总边数

// cnt: 统计剩余点数目
```

$Ac Code$

```cpp title="AcCode.cpp"
#include <iostream>
#include <algorithm>

#define endl '\n'

using namespace std;

struct Edge {  // 存边结构体
	int u, v, w;
	
	bool operator < (const Edge &A) const {  // 重载排序运算符
		return w < A.w;
	}
};

const int N = 2e4 + 5;
const int M = 9e4 + 5;
const int ORGL = 1e4;  // 征集士兵原价 10000

int t, x, y, r;
int n, m, cnt, ans;
int fa[N];  // 并查集 fa 数组
struct Edge e[M];  // 存边数组

inline void init() {  // 多组数据，记得重置
	ans = cnt = m = 0;
	
	for (int i = 1; i <= n; ++i) {  // 并查集初始化
		fa[i] = i;
	}
}

inline int find(const int &l) {  // 并查集 find
	return fa[l] == l ? l : fa[l] = find(fa[l]);
}

inline int gid(const int &l, const bool &girl) {  // 获取节点编号
	if (girl) {
		return l + 1;
	} else {
		return l + x + 1;
	}
}

int main() {
	ios::sync_with_stdio(false);
	cin.tie(nullptr), cout.tie(nullptr);
	
	cin >> t;
	while (t--) {
		cin >> x >> y >> r;
		n = x + y;
		init();
		for (int i = 1; i <= r; ++i) {
			int xi, yi, vi;
			cin >> xi >> yi >> vi;
			int xid = gid(xi, true);
			int yid = gid(yi, false);
			e[++m].u = xid;
			e[m].v = yid;
			e[m].w = ORGL - vi; // 边权为 10000 - Vi
		}
		
		// 虚拟 0 号节点
		for (int i = 1; i <= n; ++i) {
			e[++m].u = 0;
			e[m].v = i;
			e[m].w = ORGL;
		}
		
		// Kruskal 最小生成树
		sort(e + 1, e + m + 1);
		for (int i = 1; i <= m; ++i) {
			int fu = find(e[i].u);
			int fv = find(e[i].v);
			if (fu != fv) {
				fa[fu] = fv;
				ans += e[i].w;
				if (++cnt == n - 1) break;
			}
		}
		
		// 最终答案加上 剩余的一个点原价
		cout << ans + ORGL << endl;
	}
}
```
</file>

<file path="content/spec/about.md">
# 关于我 / About Me

*欢迎来到『Horean's Blog』~*

这里是 「Horean's 知识&生活&技术 小栈」.

:::note[Why HXRCH?]

`HXRCH`是博主的一个互联网昵称，虽不组成一个单词，

但是它可以代表：`Horean's X Research CHannel`，

意即“`Horean`的未知探索频道”，

是博主勇于探索新事物的生动诠释呢~

:::

👉[博主个人介绍点此进入](https://www.hxrch.top)👈

## 🛠️ 关于本站

> Spread the Knowledge Wisely & Widely.

> - 本站已加入[开往](https://www.travellings.cn)大家庭，可以点击上方导航栏【接力】下拉菜单（移动端在右上角下拉菜单栏）中的小火车图标进行友链接力！大家也可以在[开往成员列表](https://list.travellings.cn)中搜索到本站~
> - 当当当——本站已被[博客圈](https://bokequan.cn)收录啦！本站专属页面[在这里](https://bokequan.cn/sites/126417.html)，[博客圈主页](https://bokequan.cn)也可以搜索到本站哦~

本站使用 **Astro** 框架构建，采用了 [Firefly](https://github.com/CuteLeaf/Firefly) 模板，Firefly 是基于 [Fuwari](https://github.com/saicaca/fuwari) 的二次开发。

**Firefly** 是一款基于 Astro 框架和 Fuwari 模板开发的清新美观且现代化个人博客主题模板，专为技术爱好者和内容创作者设计。该主题融合了现代 Web 技术栈，提供了丰富的功能模块和高度可定制的界面，让您能够轻松打造出专业且美观的个人博客网站。

**🖥️在线预览： [Firefly - Demo site](https://firefly.cuteleaf.cn/)**

**🏠官方示例博客： [https://blog.cuteleaf.cn](https://blog.cuteleaf.cn/)**

**📝Firefly使用文档： [https://docs-firefly.cuteleaf.cn](https://docs-firefly.cuteleaf.cn/)**

**⭐Firefly开源地址：[https://github.com/CuteLeaf/Firefly](https://github.com/CuteLeaf/Firefly)** 

**⭐Fuwari开源地址：[https://github.com/saicaca/fuwari](https://github.com/saicaca/fuwari)**

::github{repo="CuteLeaf/Firefly"}

::github{repo="saicaca/fuwari"}

:::note[本站的部署]

- 本站使用 [**Vercel**](https://vercel.com) 部署静态博客服务，稳定性较高
- 本站使用 [**Twikoo**](https://twikoo.js.org) 作为评论系统，简洁又方便

:::

:::tip[本站所用字体]

- [HarmonyOS Sans SC](https://developer.huawei.com/consumer/cn/design/resource-V1/)
- [<span style="font-family: JetBrains Mono !important;">JetBrains Mono</span><i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i>](https://www.jetbrains.com/lp/mono/)

:::

[我的个人主页](https://www.hxrch.top) | [我的账号&联系方式](/about/accounts/)

> 想更进一步了解博主？
>
> 快来看看我的[**个人主页**](https://www.hxrch.top)吧~

---

$$
\huge TYOI+=\sum_{i=2022}^{2024}{me_i}
$$




## 📫 联系方式

如果你想和我交流技术问题，分享有趣的想法，或者只是想打个招呼，欢迎通过以下方式联系我：

- 💻 **GitHub**: [Horean0574](https://github.com/Horean0574/)
- ✉️ **Email**: [hi@hxrch.top](mailto:hi@hxrch.top)

---

*感谢你的来访！希望在这里能找到对你有用的内容！*
</file>

<file path="content/spec/friends.md">
---
title: "友情链接"
description: "与优秀的朋友们一起成长"
---

---

## 🍀本站信息

申请友链前请先在自己网站添加本站友链，请使用以下信息：

| 选项   | 内容                                                                       |
|------|--------------------------------------------------------------------------|
| 站点名称 | Horean's Blog                                                            |
| 站点描述 | Spread the knowledge wisely & widely.                                    |
| 站点地址 | [https://blog.hxrch.top](https://blog.hxrch.top)                         |
| 站点图标 | [https://img.hxrch.top/bfav256.webp](https://img.hxrch.top/bfav256.webp) |

## ✉️申请友链

请将您的网站信息发表于本页**评论**区或发送**邮件**至：`support@hxrch.top`

**邮件标题**：`友链申请 - [您的站点名称]`

**评论/邮件内容模板**：

```
(友链申请站点信息)
站点名称：[您的站点名称]
站点描述：[您的站点描述]
站点地址：[您的站点地址]
站点图标：[您的站点图标]
```


## ⚠️注意事项 

1. **互换原则**：请先将本站添加到您的友链页面，我会在确认后添加您的友链
2. **链接维护**：如发现友链网站长期无法访问或内容违规，将会移除友链
3. **网站要求**：
   - 网站内容积极向上，无违法违规信息
   - 不允许含有病毒、木马、恶意代码、弹出广告以及任何危害他人计算机安全的内容。
   - 不能有任何含色情/反动/暴力等不法内容。
   - 网站能够正常访问，加载速度合理
   - 网站有持续的内容更新，不是废弃站点
   - 网站支持HTTPS访问
   - 网站以原创内容为主，非纯采集站
</file>

<file path="content/spec/guestbook.md">
---
title: "留言板"
description: "在这里留下你的足迹"
---

- 请保持友善和尊重，营造良好的交流氛围
- 欢迎分享你的想法，也可以提出对网站的建议
- 你的每一条留言都是对我最大的支持 ✨
</file>

<file path="content/spec/moments.md">
---
title: "片刻"
description: "这里写什么好呢"
---
</file>

<file path="env.d.ts">
/// <reference types="astro/client" />
/// <reference path="../.astro/types.d.ts" />

declare global {
	interface ImportMetaEnv {
		readonly MEILI_MASTER_KEY: string;
	}

	interface ITOCManager {
		init: () => void;
		cleanup: () => void;
	}

	interface Window {
		SidebarTOC: {
			manager: ITOCManager | null;
		};
		FloatingTOC: {
			btn: HTMLElement | null;
			panel: HTMLElement | null;
			manager: ITOCManager | null;
			isPostPage: () => boolean;
		};
		toggleFloatingTOC: () => void;
		tocInternalNavigation: boolean;
		// swup is defined in global.d.ts
		// biome-ignore lint/suspicious/noExplicitAny: External library without types
		spine: any;
		closeAnnouncement: () => void;
		// __fireflyMusic type is defined in global.d.ts
		semifullScrollHandler?: (() => void) | undefined;
		initSemifullScrollDetection?: () => void;
	}
}

export {};
</file>

<file path="global.d.ts">
declare global {
	interface HTMLElementTagNameMap {
		"table-of-contents": HTMLElement & {
			init?: () => void;
		};
	}

	interface Window {
		// biome-ignore lint/suspicious/noExplicitAny: External library
		swup: any;
		live2dModelInitialized?: boolean;
		spineModelInitialized?: boolean;
		floatingTOCListenersInitialized?: boolean;
		// biome-ignore lint/suspicious/noExplicitAny: External library
		spinePlayerInstance?: any;
		pagefind: {
			search: (query: string) => Promise<{
				results: Array<{
					data: () => Promise<SearchResult>;
				}>;
			}>;
		};
		__fireflyMusic?: {
			init: () => Promise<void>;
			getState: () => {
				playlist: Array<{
					name: string;
					artist: string;
					url: string;
					pic: string;
					lrc?: string;
				}>;
				currentIndex: number;
				track: {
					name: string;
					artist: string;
					url: string;
					pic: string;
					lrc?: string;
				} | null;
				isPlaying: boolean;
				playMode: number;
				volume: number;
				isMuted: boolean;
				currentTime: number;
				duration: number;
				progress: number;
				currentTimeStr: string;
				durationStr: string;
				lyrics: Array<{ time: number; text: string }>;
				currentLrcIndex: number;
				initialized: boolean;
				error: string | null;
				config: Record<string, unknown>;
			};
			togglePlay: () => void;
			playNext: () => void;
			playPrev: () => void;
			cyclePlayMode: () => void;
			setVolume: (val: number) => void;
			toggleMute: () => void;
			seek: (percent: number) => void;
			seekToTime: (time: number) => void;
			playTrackByIndex: (index: number) => void;
			loadTrack: (index: number, autoPlay: boolean) => void;
		};
	}

	interface MediaQueryList {
		addListener(listener: (e: MediaQueryListEvent) => void): void;
		removeListener(listener: (e: MediaQueryListEvent) => void): void;
	}
}

interface SearchResult {
	url: string;
	meta: {
		title: string;
	};
	excerpt: string;
	content?: string;
	word_count?: number;
	filters?: Record<string, unknown>;
	anchors?: Array<{
		element: string;
		id: string;
		text: string;
		location: number;
	}>;
	weighted_locations?: Array<{
		weight: number;
		balanced_score: number;
		location: number;
	}>;
	locations?: number[];
	raw_content?: string;
	raw_url?: string;
	sub_results?: SearchResult[];
}

export type { SearchResult };
</file>

<file path="i18n/i18nKey.ts">
enum I18nKey {
	home = "home",
	about = "about",
	archive = "archive",
	search = "search",
	searchNoResults = "searchNoResults",
	searchTypeSomething = "searchTypeSomething",
	searchLoading = "searchLoading",
	searchSummary = "searchSummary",
	searchContent = "searchContent",
	searchViewMore = "searchViewMore",
	other = "other",

	tags = "tags",
	categories = "categories",
	recentPosts = "recentPosts",
	postList = "postList",
	tableOfContents = "tableOfContents",
	music = "music",

	// 公告栏
	announcement = "announcement",
	announcementClose = "announcementClose",

	comments = "comments",
	commentSection = "commentSection",
	commentSubtitle = "commentSubtitle",
	commentNotConfigured = "commentNotConfigured",
	guestbookCommentHint = "guestbookCommentHint",

	untitled = "untitled",
	uncategorized = "uncategorized",
	noTags = "noTags",

	wordCount = "wordCount",
	wordsCount = "wordsCount",
	minuteCount = "minuteCount",
	minutesCount = "minutesCount",
	postCount = "postCount",
	postsCount = "postsCount",

	// Music Widget
	musicNoPlaying = "musicNoPlaying",
	musicLyrics = "musicLyrics",
	musicVolume = "musicVolume",
	musicPlayMode = "musicPlayMode",
	musicPrev = "musicPrev",
	musicNext = "musicNext",
	musicPlaylist = "musicPlaylist",
	musicNoLyrics = "musicNoLyrics",
	musicLoadingLyrics = "musicLoadingLyrics",
	musicFailedLyrics = "musicFailedLyrics",
	musicNoSongs = "musicNoSongs",
	musicError = "musicError",
	musicPlay = "musicPlay",
	musicPause = "musicPause",
	musicProgress = "musicProgress",
	musicCover = "musicCover",
	musicNoCover = "musicNoCover",
	musicAudioPlayer = "musicAudioPlayer",

	themeColor = "themeColor",

	lightMode = "lightMode",
	darkMode = "darkMode",
	systemMode = "systemMode",

	more = "more",
	all = "all",

	author = "author",
	publishedAt = "publishedAt",
	updatedAt = "updatedAt",
	readTime = "readTime",
	license = "license",
	friends = "friends",
	friendsDescription = "friendsDescription",
	guestbook = "guestbook",
	guestbookDescription = "guestbookDescription",
	bangumi = "bangumi",
	moments = "moments",
	momentsDescription = "momentsDescription",

	// 番组计划筛选和状态文本
	bangumiTitle = "bangumiTitle",
	bangumiSubtitle = "bangumiSubtitle",
	bangumiFilterAll = "bangumiFilterAll",
	bangumiFilterWatched = "bangumiFilterWatched",
	bangumiFilterWatching = "bangumiFilterWatching",
	bangumiFilterWish = "bangumiFilterWish",
	bangumiFilterOnHold = "bangumiFilterOnHold",
	bangumiFilterDropped = "bangumiFilterDropped",
	bangumiFilterGamePlayed = "bangumiFilterGamePlayed",
	bangumiFilterGamePlaying = "bangumiFilterGamePlaying",
	bangumiFilterGameWish = "bangumiFilterGameWish",
	bangumiFilterBookRead = "bangumiFilterBookRead",
	bangumiFilterBookReading = "bangumiFilterBookReading",
	bangumiFilterBookWish = "bangumiFilterBookWish",
	bangumiFilterMusicListened = "bangumiFilterMusicListened",
	bangumiFilterMusicListening = "bangumiFilterMusicListening",
	bangumiFilterMusicWish = "bangumiFilterMusicWish",
	bangumiStatusWish = "bangumiStatusWish",
	bangumiStatusWatched = "bangumiStatusWatched",
	bangumiStatusWatching = "bangumiStatusWatching",
	bangumiStatusOnHold = "bangumiStatusOnHold",
	bangumiStatusDropped = "bangumiStatusDropped",
	bangumiStatusGameWish = "bangumiStatusGameWish",
	bangumiStatusGamePlayed = "bangumiStatusGamePlayed",
	bangumiStatusGamePlaying = "bangumiStatusGamePlaying",
	bangumiStatusBookWish = "bangumiStatusBookWish",
	bangumiStatusBookRead = "bangumiStatusBookRead",
	bangumiStatusBookReading = "bangumiStatusBookReading",
	bangumiStatusMusicWish = "bangumiStatusMusicWish",
	bangumiStatusMusicListened = "bangumiStatusMusicListened",
	bangumiStatusMusicListening = "bangumiStatusMusicListening",
	bangumiStatusUnknown = "bangumiStatusUnknown",
	bangumiNoData = "bangumiNoData",
	bangumiNoDataDescription = "bangumiNoDataDescription",
	bangumiEmpty = "bangumiEmpty",
	bangumiEmptyReason = "bangumiEmptyReason",
	bangumiUsername = "bangumiUsername",
	bangumiApi = "bangumiApi",
	bangumiConfigTip = "bangumiConfigTip",
	bangumiPrevPage = "bangumiPrevPage",
	bangumiNextPage = "bangumiNextPage",
	bangumiCurrentPage = "bangumiCurrentPage",
	bangumiTotalPages = "bangumiTotalPages",
	bangumiPage = "bangumiPage",

	// 番组分类
	bangumiCategoryBook = "bangumiCategoryBook",
	bangumiCategoryAnime = "bangumiCategoryAnime",
	bangumiCategoryMusic = "bangumiCategoryMusic",
	bangumiCategoryGame = "bangumiCategoryGame",
	bangumiCategoryReal = "bangumiCategoryReal",

	// 番组数据更新
	bangumiLastUpdated = "bangumiLastUpdated",
	bangumiUpdatedAt = "bangumiUpdatedAt",
	bangumiDataStatic = "bangumiDataStatic",

	// 分页
	paginationFirst = "paginationFirst",
	paginationPrev = "paginationPrev",
	paginationNext = "paginationNext",
	paginationLast = "paginationLast",
	paginationPage = "paginationPage",
	paginationOf = "paginationOf",
	paginationTotal = "paginationTotal",
	paginationRecords = "paginationRecords",

	// 404页面
	notFound = "notFound",
	notFoundTitle = "notFoundTitle",
	notFoundDescription = "notFoundDescription",
	backToHome = "backToHome",

	// RSS页面
	rss = "rss",
	rssDescription = "rssDescription",
	rssSubtitle = "rssSubtitle",
	rssLink = "rssLink",
	rssCopyToReader = "rssCopyToReader",
	rssCopyLink = "rssCopyLink",
	rssLatestPosts = "rssLatestPosts",
	rssWhatIsRSS = "rssWhatIsRSS",
	rssWhatIsRSSDescription = "rssWhatIsRSSDescription",
	rssBenefit1 = "rssBenefit1",
	rssBenefit2 = "rssBenefit2",
	rssBenefit3 = "rssBenefit3",
	rssBenefit4 = "rssBenefit4",
	rssHowToUse = "rssHowToUse",
	rssCopied = "rssCopied",
	rssCopyFailed = "rssCopyFailed",

	//最后编辑时间卡片
	lastModifiedPrefix = "lastModifiedPrefix",
	lastModifiedOutdated = "lastModifiedOutdated",
	lastModifiedDaysAgo = "lastModifiedDaysAgo",
	year = "year",
	month = "month",
	day = "day",
	hour = "hour",
	minute = "minute",
	second = "second",

	// 访问量统计
	pageViews = "pageViews",
	pageViewsLoading = "pageViewsLoading",
	pageViewsError = "pageViewsError",

	// 置顶
	pinned = "pinned",

	// 壁纸模式
	wallpaperMode = "wallpaperMode",
	wallpaperBannerMode = "wallpaperBannerMode",
	wallpaperOverlayMode = "wallpaperOverlayMode",
	wallpaperNoneMode = "wallpaperNoneMode",

	// 横幅设置
	bannerSettings = "bannerSettings",
	bannerTitle = "bannerTitle",
	wavesAnimation = "wavesAnimation",

	// 文章布局
	postListLayout = "postListLayout",
	postListLayoutList = "postListLayoutList",
	postListLayoutGrid = "postListLayoutGrid",

	// 赞助页面
	sponsor = "sponsor",
	sponsorTitle = "sponsorTitle",
	sponsorDescription = "sponsorDescription",
	sponsorMethods = "sponsorMethods",
	sponsorList = "sponsorList",
	sponsorEmpty = "sponsorEmpty",
	sponsorAmount = "sponsorAmount",
	sponsorDate = "sponsorDate",
	sponsorMessage = "sponsorMessage",
	sponsorAnonymous = "sponsorAnonymous",
	scanToSponsor = "scanToSponsor",
	sponsorGoTo = "sponsorGoTo",
	sponsorButton = "sponsorButton",
	sponsorButtonText = "sponsorButtonText",

	shareOnSocial = "shareOnSocial",
	shareOnSocialDescription = "shareOnSocialDescription",

	// 站点统计
	siteStats = "siteStats",
	siteStatsPostCount = "siteStatsPostCount",
	siteStatsCategoryCount = "siteStatsCategoryCount",
	siteStatsTagCount = "siteStatsTagCount",
	siteStatsTotalWords = "siteStatsTotalWords",
	siteStatsRunningDays = "siteStatsRunningDays",
	siteStatsLastUpdate = "siteStatsLastUpdate",
	siteStatsDaysAgo = "siteStatsDaysAgo",
	siteStatsDays = "siteStatsDays",
	today = "today",

	// 日历组件
	calendarSunday = "calendarSunday",
	calendarMonday = "calendarMonday",
	calendarTuesday = "calendarTuesday",
	calendarWednesday = "calendarWednesday",
	calendarThursday = "calendarThursday",
	calendarFriday = "calendarFriday",
	calendarSaturday = "calendarSaturday",
	calendarJanuary = "calendarJanuary",
	calendarFebruary = "calendarFebruary",
	calendarMarch = "calendarMarch",
	calendarApril = "calendarApril",
	calendarMay = "calendarMay",
	calendarJune = "calendarJune",
	calendarJuly = "calendarJuly",
	calendarAugust = "calendarAugust",
	calendarSeptember = "calendarSeptember",
	calendarOctober = "calendarOctober",
	calendarNovember = "calendarNovember",
	calendarDecember = "calendarDecember",

	shareArticle = "shareArticle",
	generatingPoster = "generatingPoster",
	copied = "copied",
	copyLink = "copyLink",
	savePoster = "savePoster",
	scanToRead = "scanToRead",

	// 代码块折叠配置
	codeCollapsibleShowMore = "codeCollapsibleShowMore",
	codeCollapsibleShowLess = "codeCollapsibleShowLess",
	codeCollapsibleExpanded = "codeCollapsibleExpanded",
	codeCollapsibleCollapsed = "codeCollapsibleCollapsed",
}

export default I18nKey;
</file>

<file path="i18n/languages/en.ts">
import Key from "../i18nKey";
import type { Translation } from "../translation";

export const en: Translation = {
	[Key.home]: "Home",
	[Key.about]: "About",
	[Key.archive]: "Archive",
	[Key.search]: "Search",
	[Key.searchNoResults]: "No results found.",
	[Key.searchTypeSomething]: "Type something to search...",
	[Key.searchLoading]: "Searching...",
	[Key.searchSummary]: "Summary",
	[Key.searchContent]: "Content",
	[Key.searchViewMore]: "View more results ({count} more)",
	[Key.other]: "Other",
	[Key.all]: "All",

	[Key.tags]: "Tags",
	[Key.categories]: "Categories",
	[Key.recentPosts]: "Recent Posts",
	[Key.postList]: "Post List",
	[Key.tableOfContents]: "Table of Contents",
	[Key.music]: "Music",
	[Key.musicNoPlaying]: "No playing",
	[Key.musicLyrics]: "Lyrics",
	[Key.musicVolume]: "Volume",
	[Key.musicPlayMode]: "Switch Play Mode",
	[Key.musicPrev]: "Previous",
	[Key.musicNext]: "Next",
	[Key.musicPlaylist]: "Playlist",
	[Key.musicNoLyrics]: "No lyrics available",
	[Key.musicLoadingLyrics]: "Loading lyrics...",
	[Key.musicFailedLyrics]: "Failed to load lyrics",
	[Key.musicNoSongs]: "No songs",
	[Key.musicError]: "Player Error",
	[Key.musicPlay]: "Play",
	[Key.musicPause]: "Pause",
	[Key.musicProgress]: "Playback Progress",
	[Key.musicCover]: "Cover",
	[Key.musicNoCover]: "No cover available",
	[Key.musicAudioPlayer]: "Audio Player",

	// Announcement
	[Key.announcement]: "Announcement",
	[Key.announcementClose]: "Close",

	[Key.comments]: "Comments",
	[Key.commentSection]: "Comments",
	[Key.commentSubtitle]: "Share your thoughts and discuss with everyone",
	[Key.commentNotConfigured]: "Comment system not configured",
	[Key.guestbookCommentHint]:
		"You have not enabled the comment system in the configuration file yet. After enabling it, visitors will be able to leave messages here",
	[Key.friends]: "Friends",
	[Key.friendsDescription]:
		"Here are my friends, welcome to visit and communicate with each other",
	[Key.guestbook]: "Guestbook",
	[Key.guestbookDescription]:
		"Welcome to leave your mark here, share your thoughts and suggestions",
	[Key.untitled]: "Untitled",
	[Key.uncategorized]: "Uncategorized",
	[Key.noTags]: "No Tags",

	[Key.wordCount]: "word",
	[Key.wordsCount]: "words",
	[Key.minuteCount]: "minute",
	[Key.minutesCount]: "minutes",
	[Key.postCount]: "post",
	[Key.postsCount]: "posts",

	[Key.themeColor]: "Theme Color",

	[Key.lightMode]: "Light",
	[Key.darkMode]: "Dark",
	[Key.systemMode]: "System",

	[Key.more]: "More",

	[Key.author]: "Author",
	[Key.publishedAt]: "Published at",
	[Key.updatedAt]: "Updated at",
	[Key.readTime]: "Read time",
	[Key.license]: "License",
	[Key.bangumi]: "Bangumi",

	// Bangumi Filter and Status Text
	[Key.bangumiTitle]: "My Bangumi",
	[Key.bangumiSubtitle]: "Record my ACG journey",
	[Key.bangumiFilterAll]: "All",
	[Key.bangumiFilterWatched]: "Watched",
	[Key.bangumiFilterWatching]: "Watching",
	[Key.bangumiFilterWish]: "Wish",
	[Key.bangumiFilterOnHold]: "On Hold",
	[Key.bangumiFilterDropped]: "Dropped",
	[Key.bangumiFilterGamePlayed]: "Played",
	[Key.bangumiFilterGamePlaying]: "Playing",
	[Key.bangumiFilterGameWish]: "Wish to Play",
	[Key.bangumiFilterBookRead]: "Read",
	[Key.bangumiFilterBookReading]: "Reading",
	[Key.bangumiFilterBookWish]: "Wish to Read",
	[Key.bangumiFilterMusicListened]: "Listened",
	[Key.bangumiFilterMusicListening]: "Listening",
	[Key.bangumiFilterMusicWish]: "Wish to Listen",
	[Key.bangumiStatusWish]: "Wish",
	[Key.bangumiStatusWatched]: "Watched",
	[Key.bangumiStatusWatching]: "Watching",
	[Key.bangumiStatusOnHold]: "On Hold",
	[Key.bangumiStatusDropped]: "Dropped",
	[Key.bangumiStatusGameWish]: "Wish to Play",
	[Key.bangumiStatusGamePlayed]: "Played",
	[Key.bangumiStatusGamePlaying]: "Playing",
	[Key.bangumiStatusBookWish]: "Wish to Read",
	[Key.bangumiStatusBookRead]: "Read",
	[Key.bangumiStatusBookReading]: "Reading",
	[Key.bangumiStatusMusicWish]: "Wish to Listen",
	[Key.bangumiStatusMusicListened]: "Listened",
	[Key.bangumiStatusMusicListening]: "Listening",
	[Key.bangumiStatusUnknown]: "Unknown",
	[Key.bangumiNoData]: "No Data",
	[Key.bangumiNoDataDescription]: "No items in this category",
	[Key.bangumiEmpty]: "No Data",
	[Key.bangumiEmptyReason]:
		"Possible reasons: username does not exist, network connection issue, or API limit",
	[Key.bangumiUsername]: "Username",
	[Key.bangumiApi]: "API",
	[Key.bangumiConfigTip]:
		"Tip: Please set the correct Bangumi username in the page configuration",
	[Key.bangumiPrevPage]: "Previous",
	[Key.bangumiNextPage]: "Next",
	[Key.bangumiCurrentPage]: "Page",
	[Key.bangumiTotalPages]: "of",
	[Key.bangumiPage]: "page",

	// Bangumi Categories
	[Key.bangumiCategoryBook]: "Book",
	[Key.bangumiCategoryAnime]: "Anime",
	[Key.bangumiCategoryMusic]: "Music",
	[Key.bangumiCategoryGame]: "Game",
	[Key.bangumiCategoryReal]: "Real",

	// Bangumi Data Update
	[Key.bangumiLastUpdated]: "Data updated at",
	[Key.bangumiUpdatedAt]: "Build time",
	[Key.bangumiDataStatic]: "Static data",

	// Pagination
	[Key.paginationFirst]: "First",
	[Key.paginationPrev]: "Previous",
	[Key.paginationNext]: "Next",
	[Key.paginationLast]: "Last",
	[Key.paginationPage]: "Page",
	[Key.paginationOf]: "of",
	[Key.paginationTotal]: ", Total",
	[Key.paginationRecords]: " records",

	// 404 Page
	[Key.notFound]: "404",
	[Key.notFoundTitle]: "Page Not Found",
	[Key.notFoundDescription]:
		"Sorry, the page you visited does not exist or has been moved.",
	[Key.backToHome]: "Back to Home",

	// RSS Page
	[Key.rss]: "RSS Feed",
	[Key.rssDescription]: "Subscribe to get latest updates",
	[Key.rssSubtitle]:
		"Subscribe via RSS to get the latest articles and updates imediately",
	[Key.rssLink]: "RSS Link",
	[Key.rssCopyToReader]: "Copy link to your RSS reader",
	[Key.rssCopyLink]: "Copy Link",
	[Key.rssLatestPosts]: "Latest Posts",
	[Key.rssWhatIsRSS]: "What is RSS?",
	[Key.rssWhatIsRSSDescription]:
		"RSS (Really Simple Syndication) is a standard format for publishing frequently updated content. With RSS, you can:",
	[Key.rssBenefit1]:
		"Get the latest website content in time without manually visiting",
	[Key.rssBenefit2]: "Manage subscriptions to multiple websites in one place",
	[Key.rssBenefit3]: "Avoid missing important updates and articles",
	[Key.rssBenefit4]: "Enjoy an ad-free, clean reading experience",
	[Key.rssHowToUse]:
		"It is recommended to use Feedly, Inoreader or other RSS readers to subscribe to this site.",
	[Key.rssCopied]: "RSS link copied to clipboard!",
	[Key.rssCopyFailed]: "Copy failed, please copy the link manually",

	// Last Modified Time Card
	[Key.lastModifiedPrefix]: "Last updated on ",
	[Key.lastModifiedOutdated]: "Some content may be outdated",
	[Key.lastModifiedDaysAgo]: "{days} days ago",
	[Key.year]: "year",
	[Key.month]: "month",
	[Key.day]: "day",
	[Key.hour]: "hour",
	[Key.minute]: "minute",
	[Key.second]: "second",

	// Page Views Statistics
	[Key.pageViews]: "Views",
	[Key.pageViewsLoading]: "Loading...",
	[Key.pageViewsError]: "Stats unavailable",

	// Pinned
	[Key.pinned]: "Pinned",

	// Wallpaper Mode
	[Key.wallpaperMode]: "Wallpaper Mode",
	[Key.wallpaperBannerMode]: "Banner Wallpaper",
	[Key.wallpaperOverlayMode]: "Overlay Wallpaper",
	[Key.wallpaperNoneMode]: "None Wallpaper",

	// Banner Settings
	[Key.bannerSettings]: "Banner Settings",
	[Key.bannerTitle]: "Home Banner Title",
	[Key.wavesAnimation]: "Waves Animation",

	// Post List Layout
	[Key.postListLayout]: "Post List Layout",
	[Key.postListLayoutList]: "List",
	[Key.postListLayoutGrid]: "Grid",

	// Sponsor Page
	[Key.sponsor]: "Sponsor",
	[Key.sponsorTitle]: "Support Me",
	[Key.sponsorDescription]:
		"If my content has been helpful to you, welcome to sponsor me through the following methods. Your support is the driving force for my continued creation!",
	[Key.sponsorMethods]: "Payment Methods",
	[Key.sponsorList]: "Sponsors",
	[Key.sponsorEmpty]: "No sponsors yet",
	[Key.sponsorAmount]: "Amount",
	[Key.sponsorDate]: "Date",
	[Key.sponsorMessage]: "Message",
	[Key.sponsorAnonymous]: "Anonymous",
	[Key.scanToSponsor]: "Scan to Sponsor",
	[Key.sponsorGoTo]: "Go to Sponsor",
	[Key.sponsorButton]: "Support & Share",
	[Key.sponsorButtonText]:
		"If this article helped you, please share or support!",

	[Key.shareOnSocial]: "Share Article",
	[Key.shareOnSocialDescription]:
		"If this article helped you, please share it with others!",

	// Site Statistics
	[Key.siteStats]: "Site Statistics",
	[Key.siteStatsPostCount]: "Posts",
	[Key.siteStatsCategoryCount]: "Categories",
	[Key.siteStatsTagCount]: "Tags",
	[Key.siteStatsTotalWords]: "Total Words",
	[Key.siteStatsRunningDays]: "Running Days",
	[Key.siteStatsLastUpdate]: "Last Activity",
	[Key.siteStatsDaysAgo]: "{days} days ago",
	[Key.siteStatsDays]: "{days} days",
	[Key.today]: "Today",

	// Calendar Component
	[Key.calendarSunday]: "Sun",
	[Key.calendarMonday]: "Mon",
	[Key.calendarTuesday]: "Tue",
	[Key.calendarWednesday]: "Wed",
	[Key.calendarThursday]: "Thu",
	[Key.calendarFriday]: "Fri",
	[Key.calendarSaturday]: "Sat",
	[Key.calendarJanuary]: "Jan",
	[Key.calendarFebruary]: "Feb",
	[Key.calendarMarch]: "Mar",
	[Key.calendarApril]: "Apr",
	[Key.calendarMay]: "May",
	[Key.calendarJune]: "Jun",
	[Key.calendarJuly]: "Jul",
	[Key.calendarAugust]: "Aug",
	[Key.calendarSeptember]: "Sep",
	[Key.calendarOctober]: "Oct",
	[Key.calendarNovember]: "Nov",
	[Key.calendarDecember]: "Dec",

	[Key.shareArticle]: "Share",
	[Key.generatingPoster]: "Generating Poster...",
	[Key.copied]: "Copied",
	[Key.copyLink]: "Copy Link",
	[Key.savePoster]: "Save Poster",
	[Key.scanToRead]: "Scan to Read",

	// Code Block Collapsible Configuration
	[Key.codeCollapsibleShowMore]: "Show more",
	[Key.codeCollapsibleShowLess]: "Show less",
	[Key.codeCollapsibleExpanded]: "Code block expanded",
	[Key.codeCollapsibleCollapsed]: "Code block collapsed",
};
</file>

<file path="i18n/languages/ja.ts">
import Key from "../i18nKey";
import type { Translation } from "../translation";

export const ja: Translation = {
	[Key.home]: "ホーム",
	[Key.about]: "について",
	[Key.archive]: "アーカイブ",
	[Key.search]: "検索",
	[Key.searchNoResults]: "結果が見つかりません。",
	[Key.searchTypeSomething]: "検索キーワードを入力してください。",
	[Key.searchLoading]: "検索中...",
	[Key.searchSummary]: "摘要",
	[Key.searchContent]: "内容",
	[Key.searchViewMore]: "さらに結果を表示 ({count} 件)",
	[Key.other]: "その他",
	[Key.all]: "すべて",

	[Key.tags]: "タグ",
	[Key.categories]: "カテゴリ",
	[Key.recentPosts]: "最近の投稿",
	[Key.postList]: "投稿リスト",
	[Key.tableOfContents]: "目次",
	[Key.music]: "音楽",
	[Key.musicNoPlaying]: "再生中なし",
	[Key.musicLyrics]: "歌詞",
	[Key.musicVolume]: "音量",
	[Key.musicPlayMode]: "再生モードを切り替え",
	[Key.musicPrev]: "前の曲",
	[Key.musicNext]: "次の曲",
	[Key.musicPlaylist]: "プレイリスト",
	[Key.musicNoLyrics]: "歌詞なし",
	[Key.musicLoadingLyrics]: "歌詞を読み込み中...",
	[Key.musicFailedLyrics]: "歌詞の読み込みに失敗しました",
	[Key.musicNoSongs]: "曲なし",
	[Key.musicError]: "プレーヤーエラー",
	[Key.musicPlay]: "再生",
	[Key.musicPause]: "一時停止",
	[Key.musicProgress]: "再生の進捗",
	[Key.musicCover]: "カバー",
	[Key.musicNoCover]: "カバーなし",
	[Key.musicAudioPlayer]: "オーディオプレーヤー",

	// お知らせ
	[Key.announcement]: "お知らせ",
	[Key.announcementClose]: "閉じる",

	[Key.comments]: "コメント",
	[Key.commentSection]: "コメント欄",
	[Key.commentSubtitle]: "あなたの考えを共有し、みんなと議論しましょう",
	[Key.commentNotConfigured]: "コメントシステムが設定されていません",
	[Key.guestbookCommentHint]:
		"設定ファイルでコメントシステムをまだ有効にしていません。有効にすると、訪問者がここにメッセージを残せるようになります",
	[Key.friends]: "友達",
	[Key.friendsDescription]:
		"ここは私の友達です、お互いに訪問して交流することを歓迎します",
	[Key.guestbook]: "ゲストブック",
	[Key.guestbookDescription]:
		"ここに足跡を残して、あなたの考えや提案を共有してください",
	[Key.untitled]: "無題",
	[Key.uncategorized]: "未分類",
	[Key.noTags]: "タグなし",

	[Key.wordCount]: "語",
	[Key.wordsCount]: "語",
	[Key.minuteCount]: "分",
	[Key.minutesCount]: "分",
	[Key.postCount]: "投稿",
	[Key.postsCount]: "投稿",

	[Key.themeColor]: "テーマカラー",

	[Key.lightMode]: "ライト",
	[Key.darkMode]: "ダーク",
	[Key.systemMode]: "システム",

	[Key.more]: "もっと",

	[Key.author]: "著者",
	[Key.publishedAt]: "公開日",
	[Key.updatedAt]: "更新日",
	[Key.readTime]: "読了時間",
	[Key.license]: "ライセンス",
	[Key.bangumi]: "バングミ",

	// バングミフィルターと状態文本
	[Key.bangumiTitle]: "私のバングミ",
	[Key.bangumiSubtitle]: "私の二次元の旅を記録する",
	[Key.bangumiFilterAll]: "すべて",
	[Key.bangumiFilterWatched]: "見た",
	[Key.bangumiFilterWatching]: "視聴中",
	[Key.bangumiFilterWish]: "見たい",
	[Key.bangumiFilterOnHold]: "保留",
	[Key.bangumiFilterDropped]: "中断",
	[Key.bangumiFilterGamePlayed]: "プレイ済み",
	[Key.bangumiFilterGamePlaying]: "プレイ中",
	[Key.bangumiFilterGameWish]: "プレイしたい",
	[Key.bangumiFilterBookRead]: "読んだ",
	[Key.bangumiFilterBookReading]: "読んでいる",
	[Key.bangumiFilterBookWish]: "読みたい",
	[Key.bangumiFilterMusicListened]: "聴いた",
	[Key.bangumiFilterMusicListening]: "聴いている",
	[Key.bangumiFilterMusicWish]: "聴きたい",
	[Key.bangumiStatusWish]: "見たい",
	[Key.bangumiStatusWatched]: "見た",
	[Key.bangumiStatusWatching]: "視聴中",
	[Key.bangumiStatusOnHold]: "保留",
	[Key.bangumiStatusDropped]: "中断",
	[Key.bangumiStatusGameWish]: "プレイしたい",
	[Key.bangumiStatusGamePlayed]: "プレイ済み",
	[Key.bangumiStatusGamePlaying]: "プレイ中",
	[Key.bangumiStatusBookWish]: "読みたい",
	[Key.bangumiStatusBookRead]: "読んだ",
	[Key.bangumiStatusBookReading]: "読んでいる",
	[Key.bangumiStatusMusicWish]: "聴きたい",
	[Key.bangumiStatusMusicListened]: "聴いた",
	[Key.bangumiStatusMusicListening]: "聴いている",
	[Key.bangumiStatusUnknown]: "不明",
	[Key.bangumiNoData]: "データなし",
	[Key.bangumiNoDataDescription]: "このカテゴリに項目がありません",
	[Key.bangumiEmpty]: "データなし",
	[Key.bangumiEmptyReason]:
		"考えられる理由：ユーザー名が存在しない、ネットワーク接続の問題、またはAPI制限",
	[Key.bangumiUsername]: "ユーザー名",
	[Key.bangumiApi]: "API",
	[Key.bangumiConfigTip]:
		"ヒント：ページ設定で正しいBangumiユーザー名を設定してください",
	[Key.bangumiPrevPage]: "前へ",
	[Key.bangumiNextPage]: "次へ",
	[Key.bangumiCurrentPage]: "ページ",
	[Key.bangumiTotalPages]: "の",
	[Key.bangumiPage]: "ページ",

	// バングミカテゴリ
	[Key.bangumiCategoryBook]: "本",
	[Key.bangumiCategoryAnime]: "アニメ",
	[Key.bangumiCategoryMusic]: "音楽",
	[Key.bangumiCategoryGame]: "ゲーム",
	[Key.bangumiCategoryReal]: "実写",

	// バングミデータ更新
	[Key.bangumiLastUpdated]: "データ更新",
	[Key.bangumiUpdatedAt]: "ビルド時間",
	[Key.bangumiDataStatic]: "静的データ",

	// ページネーション
	[Key.paginationFirst]: "最初",
	[Key.paginationPrev]: "前へ",
	[Key.paginationNext]: "次へ",
	[Key.paginationLast]: "最後",
	[Key.paginationPage]: "",
	[Key.paginationOf]: "ページ、全",
	[Key.paginationTotal]: "ページ、合計",
	[Key.paginationRecords]: "件",

	// 404ページ
	[Key.notFound]: "404",
	[Key.notFoundTitle]: "ページが見つかりません",
	[Key.notFoundDescription]:
		"申し訳ありませんが、アクセスしたページは存在しないか、移動されています。",
	[Key.backToHome]: "ホームに戻る",

	// RSSページ
	[Key.rss]: "RSSフィード",
	[Key.rssDescription]: "最新の更新を購読する",
	[Key.rssSubtitle]: "RSSで購読して、最新の記事と更新を第一时间で取得する",
	[Key.rssLink]: "RSSリンク",
	[Key.rssCopyToReader]: "RSSリンクをリーダーにコピー",
	[Key.rssCopyLink]: "リンクをコピー",
	[Key.rssLatestPosts]: "最新の投稿",
	[Key.rssWhatIsRSS]: "RSSとは？",
	[Key.rssWhatIsRSSDescription]:
		"RSS（Really Simple Syndication）は、頻繁に更新されるコンテンツを公開するための標準形式です。RSSを使用すると：",
	[Key.rssBenefit1]:
		"手動で訪問することなく、最新のウェブサイトコンテンツを及时に取得",
	[Key.rssBenefit2]: "1か所で複数のウェブサイトの購読を管理",
	[Key.rssBenefit3]: "重要な更新や記事を見逃すことを回避",
	[Key.rssBenefit4]: "広告なしのクリーンな読書体験を楽しむ",
	[Key.rssHowToUse]:
		"Feedly、Inoreaderまたは他のRSSリーダーを使用してこのサイトを購読することを推奨します。",
	[Key.rssCopied]: "RSSリンクがクリップボードにコピーされました！",
	[Key.rssCopyFailed]: "コピーに失敗しました。手動でリンクをコピーしてください",

	// 最終更新時間カード
	[Key.lastModifiedPrefix]: "最終更新日：",
	[Key.lastModifiedOutdated]: "一部の内容が古くなっている可能性があります",
	[Key.lastModifiedDaysAgo]: "{days}日前",
	[Key.year]: "年",
	[Key.month]: "月",
	[Key.day]: "日",
	[Key.hour]: "時",
	[Key.minute]: "分",
	[Key.second]: "秒",

	// ページビュー統計
	[Key.pageViews]: "閲覧数",
	[Key.pageViewsLoading]: "読み込み中...",
	[Key.pageViewsError]: "統計利用不可",

	// ピン留め
	[Key.pinned]: "ピン留め",

	// 壁紙モード
	[Key.wallpaperMode]: "壁紙モード",
	[Key.wallpaperBannerMode]: "バナー壁紙",
	[Key.wallpaperOverlayMode]: "透明",
	[Key.wallpaperNoneMode]: "単色背景",

	// バナー設定
	[Key.bannerSettings]: "バナー設定",
	[Key.bannerTitle]: "ホームバナータイトル",
	[Key.wavesAnimation]: "波アニメーション",

	// 投稿リストレイアウト
	[Key.postListLayout]: "投稿リストレイアウト",
	[Key.postListLayoutList]: "リスト",
	[Key.postListLayoutGrid]: "グリッド",

	// スポンサーページ
	[Key.sponsor]: "スポンサー",
	[Key.sponsorTitle]: "サポート",
	[Key.sponsorDescription]:
		"私のコンテンツがあなたの役に立ったなら、以下の方法で私をスポンサーしてください。あなたのサポートは私の継続的な創作の原動力です！",
	[Key.sponsorMethods]: "支払い方法",
	[Key.sponsorList]: "スポンサーリスト",
	[Key.sponsorEmpty]: "スポンサー記録なし",
	[Key.sponsorAmount]: "金額",
	[Key.sponsorDate]: "日付",
	[Key.sponsorMessage]: "メッセージ",
	[Key.sponsorAnonymous]: "匿名",
	[Key.scanToSponsor]: "スキャンしてスポンサー",
	[Key.sponsorGoTo]: "スポンサーへ",
	[Key.sponsorButton]: "サポートと共有",
	[Key.sponsorButtonText]:
		"この記事が役に立ったなら、共有またはサポートをお願いします！",

	[Key.shareOnSocial]: "記事を共有",
	[Key.shareOnSocialDescription]:
		"この記事が役に立ったなら、ぜひ他の人と共有してください！",

	// サイト統計
	[Key.siteStats]: "サイト統計",
	[Key.siteStatsPostCount]: "記事",
	[Key.siteStatsCategoryCount]: "カテゴリー",
	[Key.siteStatsTagCount]: "タグ",
	[Key.siteStatsTotalWords]: "総文字数",
	[Key.siteStatsRunningDays]: "運用日数",
	[Key.siteStatsLastUpdate]: "最終活動",
	[Key.siteStatsDaysAgo]: "{days} 日前",
	[Key.siteStatsDays]: "{days} 日",
	[Key.today]: "今日",

	// カレンダーコンポーネント
	[Key.calendarSunday]: "日",
	[Key.calendarMonday]: "月",
	[Key.calendarTuesday]: "火",
	[Key.calendarWednesday]: "水",
	[Key.calendarThursday]: "木",
	[Key.calendarFriday]: "金",
	[Key.calendarSaturday]: "土",
	[Key.calendarJanuary]: "1月",
	[Key.calendarFebruary]: "2月",
	[Key.calendarMarch]: "3月",
	[Key.calendarApril]: "4月",
	[Key.calendarMay]: "5月",
	[Key.calendarJune]: "6月",
	[Key.calendarJuly]: "7月",
	[Key.calendarAugust]: "8月",
	[Key.calendarSeptember]: "9月",
	[Key.calendarOctober]: "10月",
	[Key.calendarNovember]: "11月",
	[Key.calendarDecember]: "12月",

	[Key.shareArticle]: "共有",
	[Key.generatingPoster]: "ポスター生成中...",
	[Key.copied]: "コピーしました",
	[Key.copyLink]: "リンクをコピー",
	[Key.savePoster]: "ポスターを保存",
	[Key.scanToRead]: "QRコードで読む",

	// コードブロック折りたたみ設定
	[Key.codeCollapsibleShowMore]: "もっと表示",
	[Key.codeCollapsibleShowLess]: "少なく表示",
	[Key.codeCollapsibleExpanded]: "コードブロックが展開されました",
	[Key.codeCollapsibleCollapsed]: "コードブロックが折りたたまれました",
};
</file>

<file path="i18n/languages/ru.ts">
import Key from "../i18nKey";
import type { Translation } from "../translation";

export const ru: Translation = {
	[Key.home]: "Главная",
	[Key.about]: "О нас",
	[Key.archive]: "Архив",
	[Key.search]: "Поиск",
	[Key.searchNoResults]: "Результаты не найдены.",
	[Key.searchTypeSomething]: "Введите ключевое слово для поиска...",
	[Key.searchLoading]: "Поиск...",
	[Key.searchSummary]: "Резюме",
	[Key.searchContent]: "Содержание",
	[Key.searchViewMore]: "Показать еще ({count} шт)",
	[Key.other]: "Прочее",
	[Key.all]: "Все",

	[Key.tags]: "Теги",
	[Key.categories]: "Категории",
	[Key.recentPosts]: "Последние посты",
	[Key.postList]: "Список постов",
	[Key.tableOfContents]: "Содержание",
	[Key.music]: "Музыка",
	[Key.musicNoPlaying]: "Ничего не воспроизводится",
	[Key.musicLyrics]: "Текст песни",
	[Key.musicVolume]: "Громкость",
	[Key.musicPlayMode]: "Переключить режим воспроизведения",
	[Key.musicPrev]: "Предыдущий трек",
	[Key.musicNext]: "Следующий трек",
	[Key.musicPlaylist]: "Плейлист",
	[Key.musicNoLyrics]: "Текст песни отсутствует",
	[Key.musicLoadingLyrics]: "Загрузка текста песни...",
	[Key.musicFailedLyrics]: "Ошибка загрузки текста песни",
	[Key.musicNoSongs]: "Нет песен",
	[Key.musicError]: "Ошибка плеера",
	[Key.musicPlay]: "Воспроизвести",
	[Key.musicPause]: "Пауза",
	[Key.musicProgress]: "Прогресс воспроизведения",
	[Key.musicCover]: "Обложка",
	[Key.musicNoCover]: "Нет обложки",
	[Key.musicAudioPlayer]: "Аудиоплеер",

	// Объявление
	[Key.announcement]: "Объявление",
	[Key.announcementClose]: "Закрыть",

	[Key.comments]: "Комментарии",
	[Key.commentSection]: "Комментарии",
	[Key.commentSubtitle]: "Поделитесь своими мыслями и обсудите с остальными",
	[Key.commentNotConfigured]: "Система комментариев не настроена",
	[Key.guestbookCommentHint]:
		"Вы еще не включили систему комментариев в файле конфигурации. После включения посетители смогут оставлять сообщения здесь",
	[Key.friends]: "Ссылки",
	[Key.friendsDescription]:
		"Вот мои друзья, добро пожаловать посетить и общаться друг с другом",
	[Key.guestbook]: "Гостевая книга",
	[Key.guestbookDescription]:
		"Добро пожаловать, оставьте свой след здесь, поделитесь своими мыслями и предложениями",
	[Key.untitled]: "Без названия",
	[Key.uncategorized]: "Без категории",
	[Key.noTags]: "Нет тегов",

	[Key.wordCount]: "слово",
	[Key.wordsCount]: "слова",
	[Key.minuteCount]: "минута",
	[Key.minutesCount]: "минуты",
	[Key.postCount]: "пост",
	[Key.postsCount]: "постов",

	[Key.themeColor]: "Цвет темы",

	[Key.lightMode]: "Светлая",
	[Key.darkMode]: "Тёмная",
	[Key.systemMode]: "Система",

	[Key.more]: "Ещё",

	[Key.author]: "Автор",
	[Key.publishedAt]: "Опубликовано",
	[Key.updatedAt]: "Обновлено",
	[Key.readTime]: "Время чтения",
	[Key.license]: "Лицензия",
	[Key.bangumi]: "Бангуми",

	// Фильтр и статус Бангуми текст
	[Key.bangumiTitle]: "Мой план группы",
	[Key.bangumiSubtitle]: "Запись моего аниме путешествия",
	[Key.bangumiFilterAll]: "Все",
	[Key.bangumiFilterWatched]: "Просмотрено",
	[Key.bangumiFilterWatching]: "Смотрю",
	[Key.bangumiFilterWish]: "Хочу",
	[Key.bangumiFilterOnHold]: "Отложено",
	[Key.bangumiFilterDropped]: "Брошено",
	[Key.bangumiFilterGamePlayed]: "Пройдено",
	[Key.bangumiFilterGamePlaying]: "Играю",
	[Key.bangumiFilterGameWish]: "Хочу сыграть",
	[Key.bangumiFilterBookRead]: "Прочитано",
	[Key.bangumiFilterBookReading]: "Читаю",
	[Key.bangumiFilterBookWish]: "Хочу прочитать",
	[Key.bangumiFilterMusicListened]: "Прослушано",
	[Key.bangumiFilterMusicListening]: "Слушаю",
	[Key.bangumiFilterMusicWish]: "Хочу послушать",
	[Key.bangumiStatusWish]: "Хочу",
	[Key.bangumiStatusWatched]: "Просмотрено",
	[Key.bangumiStatusWatching]: "Смотрю",
	[Key.bangumiStatusOnHold]: "Отложено",
	[Key.bangumiStatusDropped]: "Брошено",
	[Key.bangumiStatusGameWish]: "Хочу сыграть",
	[Key.bangumiStatusGamePlayed]: "Пройдено",
	[Key.bangumiStatusGamePlaying]: "Играю",
	[Key.bangumiStatusBookWish]: "Хочу прочитать",
	[Key.bangumiStatusBookRead]: "Прочитано",
	[Key.bangumiStatusBookReading]: "Читаю",
	[Key.bangumiStatusMusicWish]: "Хочу послушать",
	[Key.bangumiStatusMusicListened]: "Прослушано",
	[Key.bangumiStatusMusicListening]: "Слушаю",
	[Key.bangumiStatusUnknown]: "Неизвестно",
	[Key.bangumiNoData]: "Нет данных",
	[Key.bangumiNoDataDescription]: "В этой категории нет элементов",
	[Key.bangumiEmpty]: "Нет данных",
	[Key.bangumiEmptyReason]:
		"Возможные причины: имя пользователя не существует, проблема с подключением к сети или ограничение API",
	[Key.bangumiUsername]: "Имя пользователя",
	[Key.bangumiApi]: "API",
	[Key.bangumiConfigTip]:
		"Подсказка: установите правильное имя пользователя Bangumi в конфигурации страницы",
	[Key.bangumiPrevPage]: "Предыдущая",
	[Key.bangumiNextPage]: "Следующая",
	[Key.bangumiCurrentPage]: "Страница",
	[Key.bangumiTotalPages]: "из",
	[Key.bangumiPage]: "страница",

	// Категории Бангуми
	[Key.bangumiCategoryBook]: "Книга",
	[Key.bangumiCategoryAnime]: "Аниме",
	[Key.bangumiCategoryMusic]: "Музыка",
	[Key.bangumiCategoryGame]: "Игра",
	[Key.bangumiCategoryReal]: "Реальный",

	// Обновление данных Бангуми
	[Key.bangumiLastUpdated]: "Данные обновлены",
	[Key.bangumiUpdatedAt]: "Время сборки",
	[Key.bangumiDataStatic]: "Статические данные",

	// Пагинация
	[Key.paginationFirst]: "Первая",
	[Key.paginationPrev]: "Предыдущая",
	[Key.paginationNext]: "Следующая",
	[Key.paginationLast]: "Последняя",
	[Key.paginationPage]: "Страница",
	[Key.paginationOf]: "из",
	[Key.paginationTotal]: ", всего",
	[Key.paginationRecords]: " записей",

	// 404 Страница
	[Key.notFound]: "404",
	[Key.notFoundTitle]: "Страница не найдена",
	[Key.notFoundDescription]:
		"Извините, страница, которую вы посетили, не существует или была перемещена.",
	[Key.backToHome]: "Вернуться на главную",

	// RSS Страница
	[Key.rss]: "RSS лента",
	[Key.rssDescription]: "Подпишитесь, чтобы получать последние обновления",
	[Key.rssSubtitle]:
		"Подписаться через RSS, чтобы сразу получать последние статьи и обновления",
	[Key.rssLink]: "RSS ссылка",
	[Key.rssCopyToReader]: "Скопировать ссылку в ваш RSS читатель",
	[Key.rssCopyLink]: "Скопировать ссылку",
	[Key.rssLatestPosts]: "Последние посты",
	[Key.rssWhatIsRSS]: "Что такое RSS?",
	[Key.rssWhatIsRSSDescription]:
		"RSS (Really Simple Syndication) — стандартный формат для публикации часто обновляемого контента. С RSS вы можете:",
	[Key.rssBenefit1]:
		"Получать последний контент сайта вовремя без ручного посещения",
	[Key.rssBenefit2]: "Управлять подписками на несколько сайтов в одном месте",
	[Key.rssBenefit3]: "Не пропускать важные обновления и статьи",
	[Key.rssBenefit4]: "Наслаждаться чистым чтением без рекламы",
	[Key.rssHowToUse]:
		"Рекомендуется использовать Feedly, Inoreader или другие RSS читатели для подписки на этот сайт.",
	[Key.rssCopied]: "RSS ссылка скопирована в буфер обмена!",
	[Key.rssCopyFailed]:
		"Ошибка копирования, пожалуйста, скопируйте ссылку вручную",

	// Последнее изменение
	[Key.lastModifiedPrefix]: "Последнее обновление: ",
	[Key.lastModifiedOutdated]: "Некоторый контент может быть устаревшим",
	[Key.lastModifiedDaysAgo]: "{days} дней назад",
	[Key.year]: "год",
	[Key.month]: "месяц",
	[Key.day]: "день",
	[Key.hour]: "час",
	[Key.minute]: "минута",
	[Key.second]: "секунда",

	// Статистика просмотров
	[Key.pageViews]: "Просмотры",
	[Key.pageViewsLoading]: "Загрузка...",
	[Key.pageViewsError]: "Статистика недоступна",

	// Закреплено
	[Key.pinned]: "Закреплено",

	// Режим обоев
	[Key.wallpaperMode]: "Режим обоев",
	[Key.wallpaperBannerMode]: "Баннер обои",
	[Key.wallpaperOverlayMode]: "Прозрачный",
	[Key.wallpaperNoneMode]: "Однотонный фон",

	// Настройки баннера
	[Key.bannerSettings]: "Настройки баннера",
	[Key.bannerTitle]: "Заголовок главного баннера",
	[Key.wavesAnimation]: "Анимация волн",

	// Макет списка сообщений
	[Key.postListLayout]: "Макет списка сообщений",
	[Key.postListLayoutList]: "Список",
	[Key.postListLayoutGrid]: "Сетка",

	// Страница спонсоров
	[Key.sponsor]: "Спонсор",
	[Key.sponsorTitle]: "Поддержать меня",
	[Key.sponsorDescription]:
		"Если мой контент был полезен для вас, добро пожаловать поддержать меня следующими способами. Ваша поддержка - это движущая сила моего постоянного творчества!",
	[Key.sponsorMethods]: "Способы оплаты",
	[Key.sponsorList]: "Спонсоры",
	[Key.sponsorEmpty]: "Пока нет спонсоров",
	[Key.sponsorAmount]: "Сумма",
	[Key.sponsorDate]: "Дата",
	[Key.sponsorMessage]: "Сообщение",
	[Key.sponsorAnonymous]: "Анонимно",
	[Key.scanToSponsor]: "Сканировать для поддержки",
	[Key.sponsorGoTo]: "Перейти к спонсору",
	[Key.sponsorButton]: "Поддержка и Поделиться",
	[Key.sponsorButtonText]:
		"Если эта статья помогла вам, пожалуйста, поделитесь или поддержите!",

	[Key.shareOnSocial]: "Поделиться статьей",
	[Key.shareOnSocialDescription]:
		"Если эта статья помогла вам, пожалуйста, поделитесь ею с другими!",

	// Статистика сайта
	[Key.siteStats]: "Статистика сайта",
	[Key.siteStatsPostCount]: "Статьи",
	[Key.siteStatsCategoryCount]: "Категории",
	[Key.siteStatsTagCount]: "Теги",
	[Key.siteStatsTotalWords]: "Всего слов",
	[Key.siteStatsRunningDays]: "Дней работы",
	[Key.siteStatsLastUpdate]: "Последняя активность",
	[Key.siteStatsDaysAgo]: "{days} дней назад",
	[Key.siteStatsDays]: "{days} дней",
	[Key.today]: "Сегодня",

	// Компонент календаря
	[Key.calendarSunday]: "Вс",
	[Key.calendarMonday]: "Пн",
	[Key.calendarTuesday]: "Вт",
	[Key.calendarWednesday]: "Ср",
	[Key.calendarThursday]: "Чт",
	[Key.calendarFriday]: "Пт",
	[Key.calendarSaturday]: "Сб",
	[Key.calendarJanuary]: "Янв",
	[Key.calendarFebruary]: "Фев",
	[Key.calendarMarch]: "Мар",
	[Key.calendarApril]: "Апр",
	[Key.calendarMay]: "Май",
	[Key.calendarJune]: "Июн",
	[Key.calendarJuly]: "Июл",
	[Key.calendarAugust]: "Авг",
	[Key.calendarSeptember]: "Сен",
	[Key.calendarOctober]: "Окт",
	[Key.calendarNovember]: "Ноя",
	[Key.calendarDecember]: "Дек",

	[Key.shareArticle]: "Поделиться",
	[Key.generatingPoster]: "Создание постера...",
	[Key.copied]: "Скопировано",
	[Key.copyLink]: "Копировать ссылку",
	[Key.savePoster]: "Сохранить постер",
	[Key.scanToRead]: "Сканируйте, чтобы прочитать",

	// Конфигурация блоков коллапсируемого кода
	[Key.codeCollapsibleShowMore]: "Показать больше",
	[Key.codeCollapsibleShowLess]: "Показать меньше",
	[Key.codeCollapsibleExpanded]: "Блок кода развернут",
	[Key.codeCollapsibleCollapsed]: "Блок кода свернут",
};
</file>

<file path="i18n/languages/zh_CN.ts">
import Key from "../i18nKey";
import type { Translation } from "../translation";

export const zh_CN: Translation = {
	[Key.home]: "主页",
	[Key.about]: "关于我",
	[Key.archive]: "归档",
	[Key.search]: "搜索",
	[Key.searchNoResults]: "找不到相关结果。",
	[Key.searchTypeSomething]: "请输入搜索关键词。",
	[Key.searchLoading]: "正在搜索...",
	[Key.searchSummary]: "摘要",
	[Key.searchContent]: "内容",
	[Key.searchViewMore]: "查看更多结果 ({count} 个更多)",
	[Key.other]: "其他",
	[Key.all]: "全部",

	[Key.tags]: "标签",
	[Key.categories]: "分类",
	[Key.recentPosts]: "最新文章",
	[Key.postList]: "文章列表",
	[Key.tableOfContents]: "目录",
	[Key.music]: "音乐",
	[Key.musicNoPlaying]: "暂未播放",
	[Key.musicLyrics]: "歌词",
	[Key.musicVolume]: "音量",
	[Key.musicPlayMode]: "切换播放模式",
	[Key.musicPrev]: "上一首",
	[Key.musicNext]: "下一首",
	[Key.musicPlaylist]: "列表",
	[Key.musicNoLyrics]: "暂无歌词",
	[Key.musicLoadingLyrics]: "正在加载歌词...",
	[Key.musicFailedLyrics]: "歌词加载失败",
	[Key.musicNoSongs]: "暂无歌曲",
	[Key.musicError]: "播放器错误",
	[Key.musicPlay]: "播放",
	[Key.musicPause]: "暂停",
	[Key.musicProgress]: "播放进度",
	[Key.musicCover]: "封面",
	[Key.musicNoCover]: "暂无封面",
	[Key.musicAudioPlayer]: "音频播放器",

	// 公告栏
	[Key.announcement]: "公告",
	[Key.announcementClose]: "关闭",

	[Key.comments]: "评论",
	[Key.commentSection]: "评论区",
	[Key.commentSubtitle]: "分享你的想法，与大家交流讨论",
	[Key.commentNotConfigured]: "评论系统暂未配置",
	[Key.guestbookCommentHint]:
		"您还未在配置文件中启用评论系统，启用后访客才可在此留言",
	[Key.friends]: "友链",
	[Key.friendsDescription]: "这里是我的朋友们，欢迎互相访问交流",
	[Key.guestbook]: "留言",
	[Key.guestbookDescription]: "欢迎在这里留下你的足迹，分享你的想法和建议",
	[Key.moments]: "片刻",
	[Key.momentsDescription]: "这里记录着我的胡思乱想、闲言碎语，欢迎分享你的看法",
	[Key.untitled]: "无标题",
	[Key.uncategorized]: "未分类",
	[Key.noTags]: "无标签",

	[Key.wordCount]: "字",
	[Key.wordsCount]: "字",
	[Key.minuteCount]: "分钟",
	[Key.minutesCount]: "分钟",
	[Key.postCount]: "篇文章",
	[Key.postsCount]: "篇文章",

	[Key.themeColor]: "主题色相",

	[Key.lightMode]: "亮色",
	[Key.darkMode]: "暗色",
	[Key.systemMode]: "跟随系统",

	[Key.more]: "更多",

	[Key.author]: "作者",
	[Key.publishedAt]: "发布于",
	[Key.updatedAt]: "更新于",
	[Key.readTime]: "阅读时长",
	[Key.license]: "许可协议",
	[Key.bangumi]: "番组计划",

	// 番组计划筛选和状态文本
	[Key.bangumiTitle]: "我的番组计划",
	[Key.bangumiSubtitle]: "记录我的二次元之旅",
	[Key.bangumiFilterAll]: "全部",
	[Key.bangumiFilterWatched]: "看过",
	[Key.bangumiFilterWatching]: "在看",
	[Key.bangumiFilterWish]: "想看",
	[Key.bangumiFilterOnHold]: "搁置",
	[Key.bangumiFilterDropped]: "抛弃",
	[Key.bangumiFilterGamePlayed]: "玩过",
	[Key.bangumiFilterGamePlaying]: "在玩",
	[Key.bangumiFilterGameWish]: "想玩",
	[Key.bangumiFilterBookRead]: "读过",
	[Key.bangumiFilterBookReading]: "在读",
	[Key.bangumiFilterBookWish]: "想读",
	[Key.bangumiFilterMusicListened]: "听过",
	[Key.bangumiFilterMusicListening]: "在听",
	[Key.bangumiFilterMusicWish]: "想听",
	[Key.bangumiStatusWish]: "想看",
	[Key.bangumiStatusWatched]: "看过",
	[Key.bangumiStatusWatching]: "在看",
	[Key.bangumiStatusOnHold]: "搁置",
	[Key.bangumiStatusDropped]: "抛弃",
	[Key.bangumiStatusGameWish]: "想玩",
	[Key.bangumiStatusGamePlayed]: "玩过",
	[Key.bangumiStatusGamePlaying]: "在玩",
	[Key.bangumiStatusBookWish]: "想读",
	[Key.bangumiStatusBookRead]: "读过",
	[Key.bangumiStatusBookReading]: "在读",
	[Key.bangumiStatusMusicWish]: "想听",
	[Key.bangumiStatusMusicListened]: "听过",
	[Key.bangumiStatusMusicListening]: "在听",
	[Key.bangumiStatusUnknown]: "未知",
	[Key.bangumiNoData]: "暂无数据",
	[Key.bangumiNoDataDescription]: "该分类下还没有任何条目",
	[Key.bangumiEmpty]: "暂无数据",
	[Key.bangumiEmptyReason]: "可能的原因：用户名不存在、网络连接问题或API限制",
	[Key.bangumiUsername]: "用户名",
	[Key.bangumiApi]: "API",
	[Key.bangumiConfigTip]: "提示：请在页面配置中设置正确的Bangumi用户名",
	[Key.bangumiPrevPage]: "上一页",
	[Key.bangumiNextPage]: "下一页",
	[Key.bangumiCurrentPage]: "第",
	[Key.bangumiTotalPages]: "页，共",
	[Key.bangumiPage]: "页",

	// 番组分类
	[Key.bangumiCategoryBook]: "书籍",
	[Key.bangumiCategoryAnime]: "动画",
	[Key.bangumiCategoryMusic]: "音乐",
	[Key.bangumiCategoryGame]: "游戏",
	[Key.bangumiCategoryReal]: "三次元",

	// 番组数据更新
	[Key.bangumiLastUpdated]: "数据更新于",
	[Key.bangumiUpdatedAt]: "构建时间",
	[Key.bangumiDataStatic]: "静态数据",

	// 分页
	[Key.paginationFirst]: "首页",
	[Key.paginationPrev]: "上一页",
	[Key.paginationNext]: "下一页",
	[Key.paginationLast]: "末页",
	[Key.paginationPage]: "第",
	[Key.paginationOf]: "页，共",
	[Key.paginationTotal]: "页，总计",
	[Key.paginationRecords]: "条记录",

	// 404页面
	[Key.notFound]: "404",
	[Key.notFoundTitle]: "页面未找到",
	[Key.notFoundDescription]: "抱歉，您访问的页面不存在或已被移动。",
	[Key.backToHome]: "返回首页",

	// RSS页面
	[Key.rss]: "RSS 订阅",
	[Key.rssDescription]: "订阅获取最新更新",
	[Key.rssSubtitle]: "通过 RSS 订阅，第一时间获取最新文章和动态",
	[Key.rssLink]: "RSS 链接",
	[Key.rssCopyToReader]: "复制链接到你的 RSS 阅读器",
	[Key.rssCopyLink]: "复制链接",
	[Key.rssLatestPosts]: "最新文章",
	[Key.rssWhatIsRSS]: "什么是 RSS？",
	[Key.rssWhatIsRSSDescription]:
		"RSS（Really Simple Syndication）是一种用于发布经常更新内容的标准格式。通过 RSS，你可以：",
	[Key.rssBenefit1]: "及时获取网站最新内容，无需手动访问",
	[Key.rssBenefit2]: "在一个地方管理多个网站的订阅",
	[Key.rssBenefit3]: "避免错过重要更新和文章",
	[Key.rssBenefit4]: "享受无广告的纯净阅读体验",
	[Key.rssHowToUse]: "推荐使用 Feedly、Inoreader 或其他 RSS 阅读器来订阅本站。",
	[Key.rssCopied]: "RSS 链接已复制到剪贴板！",
	[Key.rssCopyFailed]: "复制失败，请手动复制链接",

	//最后编辑时间卡片
	[Key.lastModifiedPrefix]: "最后更新于 ",
	[Key.lastModifiedOutdated]: "部分内容可能已过时",
	[Key.lastModifiedDaysAgo]: "距今已过 {days} 天",
	[Key.year]: "年",
	[Key.month]: "月",
	[Key.day]: "日",
	[Key.hour]: "时",
	[Key.minute]: "分",
	[Key.second]: "秒",

	// 访问量统计
	[Key.pageViews]: "浏览量",
	[Key.pageViewsLoading]: "加载中...",
	[Key.pageViewsError]: "统计不可用",

	// 置顶
	[Key.pinned]: "置顶",

	// 壁纸模式
	[Key.wallpaperMode]: "壁纸模式",
	[Key.wallpaperBannerMode]: "横幅壁纸",
	[Key.wallpaperOverlayMode]: "全屏透明",
	[Key.wallpaperNoneMode]: "纯色背景",

	// 横幅设置
	[Key.bannerSettings]: "横幅设置",
	[Key.bannerTitle]: "首页横幅标题",
	[Key.wavesAnimation]: "水波纹动画",

	// 文章布局
	[Key.postListLayout]: "文章布局",
	[Key.postListLayoutList]: "列表",
	[Key.postListLayoutGrid]: "网格",

	// 赞助页面
	[Key.sponsor]: "赞助",
	[Key.sponsorTitle]: "赞助支持",
	[Key.sponsorDescription]:
		"如果我的内容对你有帮助，欢迎通过以下方式赞助我，你的支持是我持续创作的动力！",
	[Key.sponsorMethods]: "赞助方式",
	[Key.sponsorList]: "赞助列表",
	[Key.sponsorEmpty]: "暂无赞助记录",
	[Key.sponsorAmount]: "金额",
	[Key.sponsorDate]: "日期",
	[Key.sponsorMessage]: "留言",
	[Key.sponsorAnonymous]: "匿名",
	[Key.scanToSponsor]: "扫码赞助",
	[Key.sponsorGoTo]: "前往赞助",
	[Key.sponsorButton]: "支持与分享",
	[Key.sponsorButtonText]:
		"如果这篇文章对你有帮助，欢迎分享给更多人或赞助支持！",

	[Key.shareOnSocial]: "文章分享",
	[Key.shareOnSocialDescription]: "如果这篇文章对你有帮助，欢迎分享给更多人！",

	// 站点统计
	[Key.siteStats]: "站点统计",
	[Key.siteStatsPostCount]: "文章",
	[Key.siteStatsCategoryCount]: "分类",
	[Key.siteStatsTagCount]: "标签",
	[Key.siteStatsTotalWords]: "总字数",
	[Key.siteStatsRunningDays]: "运行时长",
	[Key.siteStatsLastUpdate]: "最后活动",
	[Key.siteStatsDaysAgo]: "{days} 天前",
	[Key.siteStatsDays]: "{days} 天",
	[Key.today]: "今天",

	// 日历组件
	[Key.calendarSunday]: "日",
	[Key.calendarMonday]: "一",
	[Key.calendarTuesday]: "二",
	[Key.calendarWednesday]: "三",
	[Key.calendarThursday]: "四",
	[Key.calendarFriday]: "五",
	[Key.calendarSaturday]: "六",
	[Key.calendarJanuary]: "1月",
	[Key.calendarFebruary]: "2月",
	[Key.calendarMarch]: "3月",
	[Key.calendarApril]: "4月",
	[Key.calendarMay]: "5月",
	[Key.calendarJune]: "6月",
	[Key.calendarJuly]: "7月",
	[Key.calendarAugust]: "8月",
	[Key.calendarSeptember]: "9月",
	[Key.calendarOctober]: "10月",
	[Key.calendarNovember]: "11月",
	[Key.calendarDecember]: "12月",

	[Key.shareArticle]: "分享",
	[Key.generatingPoster]: "海报生成中...",
	[Key.copied]: "已复制",
	[Key.copyLink]: "复制链接",
	[Key.savePoster]: "保存海报",
	[Key.scanToRead]: "扫码阅读文章",

	// 代码块折叠配置
	[Key.codeCollapsibleShowMore]: "显示更多",
	[Key.codeCollapsibleShowLess]: "显示更少",
	[Key.codeCollapsibleExpanded]: "代码块已展开",
	[Key.codeCollapsibleCollapsed]: "代码块已折叠",
};
</file>

<file path="i18n/languages/zh_TW.ts">
import Key from "../i18nKey";
import type { Translation } from "../translation";

export const zh_TW: Translation = {
	[Key.home]: "首頁",
	[Key.about]: "關於我",
	[Key.archive]: "歸檔",
	[Key.search]: "搜尋",
	[Key.searchNoResults]: "找不到相關結果。",
	[Key.searchTypeSomething]: "請輸入搜尋關鍵字。",
	[Key.searchLoading]: "搜尋中...",
	[Key.searchSummary]: "摘要",
	[Key.searchContent]: "內容",
	[Key.searchViewMore]: "查看更多結果 ({count} 個更多)",
	[Key.other]: "其他",
	[Key.all]: "全部",

	[Key.tags]: "標籤",
	[Key.categories]: "分類",
	[Key.recentPosts]: "最新文章",
	[Key.postList]: "文章列表",
	[Key.tableOfContents]: "目錄",
	[Key.music]: "音樂",
	[Key.musicNoPlaying]: "暫未播放",
	[Key.musicLyrics]: "歌詞",
	[Key.musicVolume]: "音量",
	[Key.musicPlayMode]: "切換播放模式",
	[Key.musicPrev]: "上一首",
	[Key.musicNext]: "下一首",
	[Key.musicPlaylist]: "列表",
	[Key.musicNoLyrics]: "暫無歌詞",
	[Key.musicLoadingLyrics]: "正在加載歌詞...",
	[Key.musicFailedLyrics]: "歌詞加載失敗",
	[Key.musicNoSongs]: "暫無歌曲",
	[Key.musicError]: "播放器錯誤",
	[Key.musicPlay]: "播放",
	[Key.musicPause]: "暫停",
	[Key.musicProgress]: "播放進度",
	[Key.musicCover]: "封面",
	[Key.musicNoCover]: "暫無封面",
	[Key.musicAudioPlayer]: "音頻播放器",

	// 公告欄
	[Key.announcement]: "公告",
	[Key.announcementClose]: "關閉",

	[Key.comments]: "評論",
	[Key.commentSection]: "評論區",
	[Key.commentSubtitle]: "分享你的想法，與大家交流討論",
	[Key.commentNotConfigured]: "評論系統暫未配置",
	[Key.guestbookCommentHint]:
		"您還未在配置文件中啟用評論系統，啟用後訪客才可在此留言",
	[Key.friends]: "友鏈",
	[Key.friendsDescription]: "這裡是我的朋友們，歡迎互相訪問交流",
	[Key.guestbook]: "留言",
	[Key.guestbookDescription]: "歡迎在這裡留下你的足跡，分享你的想法和建議",
	[Key.untitled]: "無標題",
	[Key.uncategorized]: "未分類",
	[Key.noTags]: "無標籤",

	[Key.wordCount]: "字",
	[Key.wordsCount]: "字",
	[Key.minuteCount]: "分鐘",
	[Key.minutesCount]: "分鐘",
	[Key.postCount]: "篇文章",
	[Key.postsCount]: "篇文章",

	[Key.themeColor]: "主題色相",

	[Key.lightMode]: "亮色",
	[Key.darkMode]: "暗色",
	[Key.systemMode]: "跟隨系統",

	[Key.more]: "更多",

	[Key.author]: "作者",
	[Key.publishedAt]: "發布於",
	[Key.updatedAt]: "更新於",
	[Key.readTime]: "閱讀時長",
	[Key.license]: "許可協議",
	[Key.bangumi]: "番組計劃",

	// 番組計劃
	[Key.bangumiTitle]: "我的番組計劃",
	[Key.bangumiSubtitle]: "記錄我的二次元之旅",

	// 番組計劃篩選和狀態文本
	[Key.bangumiFilterAll]: "全部",
	[Key.bangumiFilterWatched]: "看過",
	[Key.bangumiFilterWatching]: "在看",
	[Key.bangumiFilterWish]: "想看",
	[Key.bangumiFilterOnHold]: "擱置",
	[Key.bangumiFilterDropped]: "拋棄",
	[Key.bangumiFilterGamePlayed]: "玩過",
	[Key.bangumiFilterGamePlaying]: "在玩",
	[Key.bangumiFilterGameWish]: "想玩",
	[Key.bangumiFilterBookRead]: "讀過",
	[Key.bangumiFilterBookReading]: "在讀",
	[Key.bangumiFilterBookWish]: "想讀",
	[Key.bangumiFilterMusicListened]: "聽過",
	[Key.bangumiFilterMusicListening]: "在聽",
	[Key.bangumiFilterMusicWish]: "想聽",
	[Key.bangumiStatusWish]: "想看",
	[Key.bangumiStatusWatched]: "看過",
	[Key.bangumiStatusWatching]: "在看",
	[Key.bangumiStatusOnHold]: "擱置",
	[Key.bangumiStatusDropped]: "拋棄",
	[Key.bangumiStatusGameWish]: "想玩",
	[Key.bangumiStatusGamePlayed]: "玩過",
	[Key.bangumiStatusGamePlaying]: "在玩",
	[Key.bangumiStatusBookWish]: "想讀",
	[Key.bangumiStatusBookRead]: "讀過",
	[Key.bangumiStatusBookReading]: "在讀",
	[Key.bangumiStatusMusicWish]: "想聽",
	[Key.bangumiStatusMusicListened]: "聽過",
	[Key.bangumiStatusMusicListening]: "在聽",
	[Key.bangumiStatusUnknown]: "未知",
	[Key.bangumiNoData]: "暫無數據",
	[Key.bangumiNoDataDescription]: "該分類下還沒有任何條目",
	[Key.bangumiEmpty]: "暫無數據",
	[Key.bangumiEmptyReason]: "可能的原因：用戶名不存在、網絡連接問題或API限制",
	[Key.bangumiUsername]: "用戶名",
	[Key.bangumiApi]: "API",
	[Key.bangumiConfigTip]: "提示：請在頁面配置中設置正確的Bangumi用戶名",
	[Key.bangumiPrevPage]: "上一頁",
	[Key.bangumiNextPage]: "下一頁",
	[Key.bangumiCurrentPage]: "第",
	[Key.bangumiTotalPages]: "頁，共",
	[Key.bangumiPage]: "頁",

	// 番組分類
	[Key.bangumiCategoryBook]: "書籍",
	[Key.bangumiCategoryAnime]: "動畫",
	[Key.bangumiCategoryMusic]: "音樂",
	[Key.bangumiCategoryGame]: "遊戲",
	[Key.bangumiCategoryReal]: "三次元",

	// 番組數據更新
	[Key.bangumiLastUpdated]: "數據更新於",
	[Key.bangumiUpdatedAt]: "構建時間",
	[Key.bangumiDataStatic]: "靜態數據",

	// 分頁
	[Key.paginationFirst]: "首頁",
	[Key.paginationPrev]: "上一頁",
	[Key.paginationNext]: "下一頁",
	[Key.paginationLast]: "末頁",
	[Key.paginationPage]: "第",
	[Key.paginationOf]: "頁，共",
	[Key.paginationTotal]: "頁，總計",
	[Key.paginationRecords]: "條記錄",

	// 404頁面
	[Key.notFound]: "404",
	[Key.notFoundTitle]: "頁面未找到",
	[Key.notFoundDescription]: "抱歉，您訪問的頁面不存在或已被移動。",
	[Key.backToHome]: "返回首頁",

	// RSS頁面
	[Key.rss]: "RSS 訂閱",
	[Key.rssDescription]: "訂閱獲取最新更新",
	[Key.rssSubtitle]: "通過 RSS 訂閱，第一時間獲取最新文章和動態",
	[Key.rssLink]: "RSS 鏈接",
	[Key.rssCopyToReader]: "複製鏈接到你的 RSS 閱讀器",
	[Key.rssCopyLink]: "複製鏈接",
	[Key.rssLatestPosts]: "最新文章",
	[Key.rssWhatIsRSS]: "什麼是 RSS？",
	[Key.rssWhatIsRSSDescription]:
		"RSS（Really Simple Syndication）是一種用於發布經常更新內容的標準格式。通過 RSS，你可以：",
	[Key.rssBenefit1]: "及時獲取網站最新內容，無需手動訪問",
	[Key.rssBenefit2]: "在一個地方管理多個網站的訂閱",
	[Key.rssBenefit3]: "避免錯過重要更新和文章",
	[Key.rssBenefit4]: "享受無廣告的純淨閱讀體驗",
	[Key.rssHowToUse]: "推薦使用 Feedly、Inoreader 或其他 RSS 閱讀器來訂閱本站。",
	[Key.rssCopied]: "RSS 鏈接已複製到剪貼板！",
	[Key.rssCopyFailed]: "複製失敗，請手動複製鏈接",

	//最後編輯時間卡片
	[Key.lastModifiedPrefix]: "最後更新於 ",
	[Key.lastModifiedOutdated]: "部分內容可能已過時",
	[Key.lastModifiedDaysAgo]: "距今已過 {days} 天",
	[Key.year]: "年",
	[Key.month]: "月",
	[Key.day]: "日",
	[Key.hour]: "時",
	[Key.minute]: "分",
	[Key.second]: "秒",

	// 訪問量統計
	[Key.pageViews]: "瀏覽量",
	[Key.pageViewsLoading]: "載入中...",
	[Key.pageViewsError]: "統計不可用",

	// 置頂
	[Key.pinned]: "置頂",

	// 壁紙模式
	[Key.wallpaperMode]: "壁紙模式",
	[Key.wallpaperBannerMode]: "橫幅壁紙",
	[Key.wallpaperOverlayMode]: "全屏透明",
	[Key.wallpaperNoneMode]: "純色背景",

	// 橫幅設置
	[Key.bannerSettings]: "橫幅設置",
	[Key.bannerTitle]: "首頁橫幅標題",
	[Key.wavesAnimation]: "水波紋動畫",

	// 文章佈局
	[Key.postListLayout]: "文章佈局",
	[Key.postListLayoutList]: "清單",
	[Key.postListLayoutGrid]: "網格",

	// 贊助頁面
	[Key.sponsor]: "贊助",
	[Key.sponsorTitle]: "贊助支持",
	[Key.sponsorDescription]:
		"如果我的內容對你有幫助，歡迎通過以下方式贊助我，你的支持是我持續創作的動力！",
	[Key.sponsorMethods]: "贊助方式",
	[Key.sponsorList]: "贊助列表",
	[Key.sponsorEmpty]: "暫無贊助記錄",
	[Key.sponsorAmount]: "金額",
	[Key.sponsorDate]: "日期",
	[Key.sponsorMessage]: "留言",
	[Key.sponsorAnonymous]: "匿名",
	[Key.scanToSponsor]: "掃碼贊助",
	[Key.sponsorGoTo]: "前往贊助",
	[Key.sponsorButton]: "支持與分享",
	[Key.sponsorButtonText]:
		"如果這篇文章對你有幫助，歡迎分享給更多人或贊助支持！",

	[Key.shareOnSocial]: "文章分享",
	[Key.shareOnSocialDescription]: "如果這篇文章對你有幫助，歡迎分享給更多人！",

	// 站點統計
	[Key.siteStats]: "站點統計",
	[Key.siteStatsPostCount]: "文章",
	[Key.siteStatsCategoryCount]: "分類",
	[Key.siteStatsTagCount]: "標籤",
	[Key.siteStatsTotalWords]: "總字數",
	[Key.siteStatsRunningDays]: "運行時長",
	[Key.siteStatsLastUpdate]: "最後活動",
	[Key.siteStatsDaysAgo]: "{days} 天前",
	[Key.siteStatsDays]: "{days} 天",
	[Key.today]: "今天",

	// 日曆組件
	[Key.calendarSunday]: "日",
	[Key.calendarMonday]: "一",
	[Key.calendarTuesday]: "二",
	[Key.calendarWednesday]: "三",
	[Key.calendarThursday]: "四",
	[Key.calendarFriday]: "五",
	[Key.calendarSaturday]: "六",
	[Key.calendarJanuary]: "1月",
	[Key.calendarFebruary]: "2月",
	[Key.calendarMarch]: "3月",
	[Key.calendarApril]: "4月",
	[Key.calendarMay]: "5月",
	[Key.calendarJune]: "6月",
	[Key.calendarJuly]: "7月",
	[Key.calendarAugust]: "8月",
	[Key.calendarSeptember]: "9月",
	[Key.calendarOctober]: "10月",
	[Key.calendarNovember]: "11月",
	[Key.calendarDecember]: "12月",

	[Key.shareArticle]: "分享",
	[Key.generatingPoster]: "海報生成中...",
	[Key.copied]: "已複製",
	[Key.copyLink]: "複製連結",
	[Key.savePoster]: "保存海報",
	[Key.scanToRead]: "掃碼閱讀文章",

	// 代碼區塊折疊配置
	[Key.codeCollapsibleShowMore]: "顯示更多",
	[Key.codeCollapsibleShowLess]: "顯示更少",
	[Key.codeCollapsibleExpanded]: "代碼區塊已展開",
	[Key.codeCollapsibleCollapsed]: "代碼區塊已折疊",
};
</file>

<file path="i18n/translation.ts">
import { siteConfig } from "../config";
import type I18nKey from "./i18nKey";
import { en } from "./languages/en";
import { ja } from "./languages/ja";
import { ru } from "./languages/ru";
import { zh_CN } from "./languages/zh_CN";
import { zh_TW } from "./languages/zh_TW";

export type Translation = {
	[K in I18nKey]: string;
};

const defaultTranslation = en;

const map: { [key: string]: Translation } = {
	en: en,
	en_us: en,
	en_gb: en,
	en_au: en,
	zh_cn: zh_CN,
	zh_tw: zh_TW,
	ja: ja,
	ja_jp: ja,
	ru: ru,
	ru_ru: ru,
};

export function getTranslation(lang: string): Translation {
	return map[lang.toLowerCase()] || defaultTranslation;
}

export function i18n(key: I18nKey): string {
	const lang = siteConfig.lang || "en";
	const currentLang = getTranslation(lang);
	const value = currentLang[key];

	// 如果当前语言没有翻译（或为空），则使用中文作为备选
	if (!value && lang.toLowerCase() !== "zh_cn") {
		const chineseValue = zh_CN[key];
		if (chineseValue) {
			return chineseValue;
		}
	}

	return value || defaultTranslation[key];
}
</file>

<file path="layouts/Layout.astro">
---
import GoogleAnalytics from "@components/analytics/GoogleAnalytics.astro";
import MicrosoftClarity from "@components/analytics/MicrosoftClarity.astro";
import FancyboxManager from "@components/features/FancyboxManager.astro";
import FontManager from "@components/features/FontManager.astro";
import MusicManager from "@components/features/MusicManager.astro";
import SakuraEffect from "@components/features/SakuraEffect.astro";
import ConfigCarrier from "@components/layout/ConfigCarrier.astro";

import {
    backgroundWallpaper,
    expressiveCodeConfig,
    profileConfig,
    siteConfig,
} from "@/config";
import {
    BANNER_HEIGHT,
    BANNER_HEIGHT_EXTEND,
    BANNER_HEIGHT_HOME,
    PAGE_WIDTH,
} from "@/constants/constants";
import { defaultFavicons } from "@/constants/icon";
import type { Favicon } from "@/types/config";
import { getDefaultBackground, isHomePage } from "@/utils/layout-utils";
import { url } from "@/utils/url-utils";

import "@/styles/main.css";
import "@/styles/variables.styl";
import "@/styles/markdown-extend.styl";
import "@rehype-callouts-theme";

interface Props {
    title?: string;
    banner?: string;
    description?: string;
    lang?: string;
    setOGTypeArticle?: boolean;
    postSlug?: string;
}

let { title, banner, description, lang, setOGTypeArticle, postSlug } =
    Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePageCheck = isHomePage(Astro.url.pathname);

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 获取导航栏透明模式配置
const navbarTransparentMode =
    backgroundWallpaper.banner?.navbar?.transparentMode || "semi";
// 判断是否应该显示顶部高光效果（只在full和semifull模式下显示）
const shouldShowTopHighlight =
    navbarTransparentMode === "full" || navbarTransparentMode === "semifull";

if (!banner || typeof banner !== "string" || banner.trim() === "") {
    banner = getDefaultBackground();
}

// TODO don't use post cover as banner for now
banner = getDefaultBackground();

const enableBanner = backgroundWallpaper.mode === "banner";

let pageTitle: string;
if (title) {
    pageTitle = `${title} - ${siteConfig.title}`;
} else {
    pageTitle = siteConfig.subtitle
        ? `${siteConfig.title} - ${siteConfig.subtitle}`
        : siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
    ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
    siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
    lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

// 使用固定的banner偏移量，position配置用于图片定位
---

<!doctype html>
<html lang={siteLang} class="bg-(--page-bg) text-[14px] md:text-[16px]">
<head>
    <meta charset="UTF-8"/>
    {siteConfig.analytics?.googleAnalyticsId && (
            <GoogleAnalytics analyticsId={siteConfig.analytics.googleAnalyticsId}/>
    )}
    {siteConfig.analytics?.microsoftClarityId && (
            <MicrosoftClarity clarityId={siteConfig.analytics.microsoftClarityId}/>
    )}

    <title>{pageTitle}</title>
    <meta
            name="description"
            content={description || siteConfig.description || pageTitle}
    />
    {
        siteConfig.keywords && siteConfig.keywords.length > 0 && (
                    <meta name="keywords" content={siteConfig.keywords.join(", ")}/>
        )
    }
    <meta name="author" content={profileConfig.name}/>

    <meta property="og:site_name" content={siteConfig.title}/>
    <meta property="og:url" content={Astro.url}/>
    <meta property="og:title" content={pageTitle}/>
    <meta
            property="og:description"
            content={description || siteConfig.description || pageTitle}
    />
    {ogImageUrl &&
            <meta property="og:image" content={ogImageUrl}/>}
    {
        setOGTypeArticle ? (
                <meta property="og:type" content="article"/>
        ) : (
                <meta property="og:type" content="website"/>
        )
    }

    <meta name="twitter:card" content="summary_large_image"/>
    <meta property="twitter:url" content={Astro.url}/>
    <meta name="twitter:title" content={pageTitle}/>
    <meta
            name="twitter:description"
            content={description || siteConfig.description || pageTitle}
    />

    <meta name="viewport" content="width=device-width"/>
    <meta name="generator" content={Astro.generator}/>
    {
        favicons.map((favicon) => (
                <link
                        rel="icon"
                        href={favicon.src.startsWith("/") ? url(favicon.src) : favicon.src}
                        sizes={favicon.sizes}
                        media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
                />
        ))
    }

    <!-- Set the theme before the page is rendered to avoid a flash -->
    <script
            is:inline
            define:vars={{
                BANNER_HEIGHT_EXTEND,
                PAGE_WIDTH,
                configHue,
                defaultMode: siteConfig.themeColor.defaultMode ?? "light",
                defaultWallpaperMode: backgroundWallpaper.mode,
                isWallpaperSwitchable:
                    backgroundWallpaper.switchable ?? true,
                darkTheme: expressiveCodeConfig.darkTheme,
                lightTheme: expressiveCodeConfig.lightTheme,
                baseUrl: import.meta.env.BASE_URL,
            }}
    >
        // 主题初始化 - 与setting-utils.ts保持一致
        const LIGHT_MODE = "light";
        const DARK_MODE = "dark";
        const SYSTEM_MODE = "system";

        // 获取存储的主题，如果没有则使用默认值
        const theme = localStorage.getItem("theme") || defaultMode;

        // 获取系统主题
        function getSystemTheme() {
            return window.matchMedia("(prefers-color-scheme: dark)").matches
                ? DARK_MODE
                : LIGHT_MODE;
        }

        // 解析主题（如果是system模式，则获取系统主题）
        function resolveTheme(themeValue) {
            if (themeValue === SYSTEM_MODE) {
                return getSystemTheme();
            }
            return themeValue;
        }

        const resolvedTheme = resolveTheme(theme);
        const isDark = resolvedTheme === DARK_MODE;

        // 应用主题
        if (isDark) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }

        // Set the theme for Expressive Code
        document.documentElement.setAttribute(
            "data-theme",
            isDark ? darkTheme : lightTheme,
        );

        // Load the hue from local storage
        const hue = localStorage.getItem("hue") || configHue;
        document.documentElement.style.setProperty("--hue", hue);

        // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
        // 使用更准确的窗口高度计算
        function calculateBannerHeightExtend() {
            let offset = Math.floor(
                window.innerHeight * (BANNER_HEIGHT_EXTEND / 100),
            );
            offset = offset - (offset % 4);
            document.documentElement.style.setProperty(
                "--banner-height-extend",
                `${offset}px`,
            );
        }

        // 立即设置初始值
        calculateBannerHeightExtend();

        // 在下一帧重新计算精确值（仅在值变化时更新，避免闪烁）
        requestAnimationFrame(() => {
            const oldValue = parseInt(
                document.documentElement.style.getPropertyValue(
                    "--banner-height-extend",
                ),
            );
            calculateBannerHeightExtend();
            const newValue = parseInt(
                document.documentElement.style.getPropertyValue(
                    "--banner-height-extend",
                ),
            );
            // 如果值变化了，再更新一次确保准确
            if (Math.abs(oldValue - newValue) > 4) {
                // 如果有明显变化，延迟一帧再更新，避免闪烁
                requestAnimationFrame(calculateBannerHeightExtend);
            }
        });

        // 初始化壁纸模式 - 在页面渲染前应用
        const WALLPAPER_BANNER = "banner";
        const WALLPAPER_OVERLAY = "overlay";
        const WALLPAPER_NONE = "none";
        const wallpaperMode = isWallpaperSwitchable
            ? localStorage.getItem("wallpaperMode") || defaultWallpaperMode
            : defaultWallpaperMode;

        // 设置data-wallpaper-mode属性
        document.documentElement.setAttribute(
            "data-wallpaper-mode",
            wallpaperMode,
        );

        // 立即执行函数来处理DOM
        (function applyWallpaperMode() {
            // 使用 requestAnimationFrame 确保在下一帧之前执行
            requestAnimationFrame(function () {
                // 根据模式隐藏显示对应元素
                if (
                    wallpaperMode === WALLPAPER_NONE ||
                    wallpaperMode === WALLPAPER_OVERLAY
                ) {
                    // 隐藏横幅
                    if (document.body) {
                        document.body.classList.remove("enable-banner");
                        document.body.classList.add("no-banner-layout");
                    }
                } else {
                    if (document.body) {
                        document.body.classList.add("enable-banner");
                        document.body.classList.remove("no-banner-layout");
                    }
                }

                // 全屏壁纸模式
                if (wallpaperMode === WALLPAPER_OVERLAY) {
                    if (document.body) {
                        document.body.classList.add("wallpaper-transparent");
                    }
                } else {
                    if (document.body) {
                        document.body.classList.remove("wallpaper-transparent");
                    }
                }

                // 处理wallpaper-wrapper的显示
                const wallpaperWrapper = document.getElementById("wallpaper-wrapper");

                // 检查当前是否为首页
                const isHomePage =
                    window.location.pathname === baseUrl ||
                    (baseUrl !== "/" && window.location.pathname === baseUrl.replace(/\/$/, "")) ||
                    window.location.pathname === "/";

                if (wallpaperMode === WALLPAPER_OVERLAY) {
                    // 全屏壁纸透明模式：切换为 overlay 显示
                    if (wallpaperWrapper) {
                        wallpaperWrapper.classList.add("wallpaper-overlay");
                        wallpaperWrapper.style.display = "block";
                        wallpaperWrapper.classList.remove("hidden", "opacity-0", "mobile-hide-banner");
                        wallpaperWrapper.classList.add("opacity-100");
                        wallpaperWrapper.style.top = "";
                    }
                } else if (wallpaperMode === WALLPAPER_NONE) {
                    // 纯色背景：隐藏壁纸
                    if (wallpaperWrapper) {
                        wallpaperWrapper.style.display = "none";
                        wallpaperWrapper.classList.add("hidden", "opacity-0");
                    }
                } else {
                    // banner模式：以 banner 方式显示
                    if (wallpaperWrapper) {
                        wallpaperWrapper.classList.remove("wallpaper-overlay");
                        const isMobile = window.innerWidth < 1024;
                        // 移动端非首页时隐藏banner（初始状态直接隐藏，不需要动画）
                        // 桌面端始终显示banner
                        if (isMobile && !isHomePage) {
                            wallpaperWrapper.style.display = "none";
                            wallpaperWrapper.classList.add("mobile-hide-banner");
                        } else {
                            wallpaperWrapper.style.display = "block";
                            wallpaperWrapper.classList.remove("mobile-hide-banner");
                        }
                    }
                }

                // 处理主内容区域位置
                const mainContentWrapper = document.querySelector(
                    ".absolute.w-full.z-30",
                );
                if (mainContentWrapper) {
                    const isMobile = window.innerWidth < 1024;
                    // 只在移动端非首页时调整主内容位置
                    if (isMobile && !isHomePage) {
                        mainContentWrapper.classList.add("mobile-main-no-banner");
                    } else {
                        mainContentWrapper.classList.remove("mobile-main-no-banner");
                    }
                }

                // 处理credit元素
                const creditDesktop = document.getElementById(
                    "banner-credit-desktop",
                );
                const creditMobile = document.getElementById("banner-credit-mobile");
                if (
                    wallpaperMode === WALLPAPER_OVERLAY ||
                    wallpaperMode === WALLPAPER_NONE
                ) {
                    if (creditDesktop) creditDesktop.style.display = "none";
                    if (creditMobile) creditMobile.style.display = "none";
                } else {
                    if (creditDesktop) creditDesktop.style.display = "";
                    if (creditMobile) creditMobile.style.display = "";
                }

                // 处理banner homeText元素
                const bannerTextOverlay = document.querySelector(
                    ".banner-home-text-overlay",
                );
                if (bannerTextOverlay) {
                    const isHomePage =
                        window.location.pathname === baseUrl ||
                        (baseUrl !== "/" && window.location.pathname === baseUrl.replace(/\/$/, "")) ||
                        window.location.pathname === "/";
                    if (wallpaperMode === WALLPAPER_BANNER && isHomePage) {
                        bannerTextOverlay.classList.remove("hidden");
                    } else {
                        bannerTextOverlay.classList.add("hidden");
                    }
                }
            });
        })();

        // 初始化水波纹动画状态 - 在 html 元素上设置属性，CSS 会立即生效
        (function applyWavesEnabled() {
            const wavesEnabled = localStorage.getItem("wavesEnabled");
            if (wavesEnabled !== null) {
                document.documentElement.setAttribute("data-waves-enabled", wavesEnabled);
            }
        })();

        // 初始化横幅标题显示状态 - 在 html 元素上设置属性，CSS 会立即生效
        (function applyBannerTitleEnabled() {
            const bannerTitleEnabled = localStorage.getItem("bannerTitleEnabled");
            if (bannerTitleEnabled !== null) {
                document.documentElement.setAttribute("data-banner-title-enabled", bannerTitleEnabled);
            }
        })();
    </script>
    <style
            define:vars={{
                configHue,
                "page-width": `${siteConfig.pageWidth ?? PAGE_WIDTH}rem`,
            }}
    ></style>
    <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->

    <slot name="head"/>

    <link
            rel="alternate"
            type="application/rss+xml"
            title={profileConfig.name}
            href={`${Astro.site}rss.xml`}
    />

    <!-- Font Manager -->
    <FontManager/>
</head>
<body
        class="min-h-screen"
        class:list={[
            {
                "lg:is-home": isHomePageCheck,
                "enable-banner": enableBanner,
                "enable-card-border": siteConfig.card?.border,
            },
            ...(siteConfig.font.enable && siteConfig.font.selected
                ? (Array.isArray(siteConfig.font.selected)
                        ? siteConfig.font.selected
                        : [siteConfig.font.selected]
                ).map((fontId) => `font-${fontId}-enabled`)
                : []),
        ]}
>

<div id="progress-bar"></div>

<!-- 页面顶部渐变高光效果 - 只在full和semifull模式下显示 -->
{shouldShowTopHighlight &&
        <div class="top-gradient-highlight"/>}
<ConfigCarrier/>
<MusicManager/>
<slot/>


<!-- Sakura Effect -->
<SakuraEffect/>

<!-- Fancybox Manager -->
<FancyboxManager/>
</body>
</html>

<style
        is:global
        define:vars={{
            "banner-height-home": `${BANNER_HEIGHT_HOME}vh`,
            "banner-height": `${BANNER_HEIGHT}vh`,
        }}
>
    @reference "../styles/main.css";

    @layer components {
        .enable-banner #wallpaper-wrapper {
            height: var(--banner-height-home);
            transform: translateY(var(--banner-height-extend));
        }

        .enable-banner #banner {
            height: var(--banner-height-home);
            transform: translateY(0);
        }

        .enable-banner #main-grid {
            transform: translateY(var(--banner-height-extend));
        }

        .enable-banner #top-row {
            height: calc(var(--banner-height-home) - 4.5rem);
            @apply transition-all duration-300;
        }
    }

    @layer utilities {
        .enable-banner #sidebar-sticky {
            top: calc(1rem - var(--banner-height-extend)) !important;
        }

        .enable-banner #left-sidebar-sticky {
            top: calc(1rem - var(--banner-height-extend)) !important;
        }

        .enable-banner #right-sidebar-sticky {
            top: calc(1rem - var(--banner-height-extend)) !important;
        }

        .navbar-hidden {
            @apply opacity-0 -translate-y-16;
        }
    }

    @media (max-width: 1023px) {
        body.enable-banner:not(.lg\:is-home) #main-grid {
            transform: none !important;
        }

        body.enable-banner:not(.lg\:is-home) #top-row {
            height: auto !important;
        }

        body.enable-banner:not(.lg\:is-home) #sidebar-sticky,
        body.enable-banner:not(.lg\:is-home) #left-sidebar-sticky,
        body.enable-banner:not(.lg\:is-home) #right-sidebar-sticky {
            top: 1rem !important;
        }
    }
</style>

<script>
    import { pathsEqual, url } from "@/utils/url-utils";
    import {
        BANNER_HEIGHT,
        BANNER_HEIGHT_HOME,
        BANNER_HEIGHT_EXTEND,
        // MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
    } from "@/constants/constants";
    import { backgroundWallpaper, expressiveCodeConfig, siteConfig } from "@/config";

    /* Preload fonts */
    // (async function() {
    // 	try {
    // 		await Promise.all([
    // 			document.fonts.load("400 1em Roboto"),
    // 			document.fonts.load("700 1em Roboto"),
    // 		]);
    // 		document.body.classList.remove("hidden");
    // 	} catch (error) {
    // 		console.log("Failed to load fonts:", error);
    // 	}
    // })();

    /* TODO This is a temporary solution for style flicker issue when the transition is activated */
    /* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
    /* update: fixed in Astro 3.2.4 */
    /*
  function disableAnimation() {
      const css = document.createElement('style')
      css.appendChild(
          document.createTextNode(
              `*{
                -webkit-transition:none!important;
                -moz-transition:none!important;
                -o-transition:none!important;
                -ms-transition:none!important;
                transition:none!important
                }`
          )
      )
      document.head.appendChild(css)

      return () => {
          // Force restyle
          ;(() => window.getComputedStyle(document.body))()

          // Wait for next tick before removing
          setTimeout(() => {
              document.head.removeChild(css)
          }, 1)
      }
  }
  */

    const bannerEnabled = !!document.getElementById("wallpaper-wrapper");

    function setClickOutsideToClose(panel: string, ignores: string[]) {
        document.addEventListener("click", (event) => {
            let panelDom = document.getElementById(panel);
            if (!panelDom) return;
            let tDom = event.target;
            if (!(tDom instanceof Node)) return; // Ensure the event target is an HTML Node
            for (let ig of ignores) {
                let ie = document.getElementById(ig);
                if (ie == tDom || ie?.contains(tDom)) {
                    return;
                }
            }
            panelDom.classList.add("float-panel-closed");
        });
    }

    setClickOutsideToClose("display-setting", [
        "display-setting",
        "display-settings-switch",
    ]);
    setClickOutsideToClose("nav-menu-panel", [
        "nav-menu-panel",
        "nav-menu-switch",
    ]);
    setClickOutsideToClose("search-panel", [
        "search-panel",
        "search-bar",
        "search-switch",
    ]);
    setClickOutsideToClose("wallpaper-mode-panel", [
        "wallpaper-mode-panel",
        "wallpaper-mode-switch",
    ]);
    setClickOutsideToClose("theme-mode-panel", [
        "theme-mode-panel",
        "scheme-switch",
    ]);

    function initCustomScrollbar() {
        // 只处理katex元素的滚动条，使用浏览器原生滚动条
        const katexElements = document.querySelectorAll(
            ".katex-display:not([data-scrollbar-initialized])",
        ) as NodeListOf<HTMLElement>;
        katexElements.forEach((element) => {
            if (!element.parentNode) return;

            const container = document.createElement("div");
            container.className = "katex-display-container";
            element.parentNode.insertBefore(container, element);
            container.appendChild(element);

            // 使用浏览器原生滚动条，无自定义样式
            container.style.cssText = `
			overflow-x: auto;
		`;

            element.setAttribute("data-scrollbar-initialized", "true");
        });
    }

    function showBanner() {
        const isBannerMode = backgroundWallpaper.mode === "banner";
        if (!isBannerMode) return;

        // 使用requestAnimationFrame优化DOM操作
        requestAnimationFrame(() => {
            // Handle single image banner (desktop)
            const banner = document.getElementById("banner");
            if (banner) {
                banner.classList.remove("opacity-0", "scale-105");
            }

            // Handle mobile single image banner - 使用与电脑端相同的逻辑
            const mobileBanner = document.querySelector(
                ".block.lg\\:hidden[alt=\"Mobile banner image of the blog\"]",
            );
            if (mobileBanner) {
                // 移动端使用与电脑端相同的初始化逻辑
                mobileBanner.classList.remove("opacity-0", "scale-105");
                mobileBanner.classList.add("opacity-100");
            }
        });
    }

    const setup = () => {
        // TODO: temp solution to change the height of the banner
        /*
        window.swup.hooks.on('animation:out:start', () => {
            const path = window.location.pathname
            const body = document.querySelector('body')
            if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
                body.classList.add('is-home')
            } else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
                body.classList.remove('is-home')
            }
        })
    */
        window.swup.hooks.on("link:click", (_visit: any, { el }: { el: HTMLAnchorElement }) => {
            // Remove the delay for the first time page load
            document.documentElement.style.setProperty("--content-delay", "0ms");

            // 同页链接点击不需要过渡保护
            const targetHref = el.getAttribute("href") || "";
            const targetPathname = (() => {
                try {
                    return new URL(targetHref, window.location.origin).pathname;
                } catch {
                    return targetHref;
                }
            })();
            const isSamePage = pathsEqual(targetPathname, window.location.pathname);
            if (!isSamePage) {
                // 添加页面切换保护，防止导航栏闪烁
                document.documentElement.classList.add("is-page-transitioning");
            }

            // 简化navbar处理逻辑
            if (bannerEnabled) {
                const navbar = document.getElementById("navbar-wrapper");
                if (navbar) {
                    const threshold = window.innerHeight * (BANNER_HEIGHT_HOME / 100) - 88;
                    if (document.documentElement.scrollTop >= threshold) {
                        navbar.classList.add("navbar-hidden");
                    }
                }
            }
        });
        window.swup.hooks.on("content:replace", () => {
            // 更新侧边栏组件的可见性（根据新页面的 URL）
            updateSidebarComponentsVisibility();

            // 只处理katex元素的容器，使用浏览器原生滚动条
            initCustomScrollbar();

            // 重新初始化图标加载器
            import("@/utils/icon-loader").then(({ initIconLoader }) => {
                initIconLoader();
            });

            // 检查当前页面是否为文章页面（有TOC元素）
            const tocWrapper = document.getElementById("toc-wrapper");
            const isArticlePage = tocWrapper !== null;

            // 只在文章页面重新初始化桌面端 TOC 组件
            if (isArticlePage) {
                const tocElement = document.querySelector("table-of-contents");
                if (tocElement && typeof (tocElement as any).init === "function") {
                    setTimeout(() => {
                        (tocElement as any).init();
                    }, 100);
                }
            }

            // 重新初始化semifull模式的滚动检测
            const navbar = document.getElementById("navbar");
            if (navbar) {
                const transparentMode = navbar.getAttribute("data-transparent-mode");

                if (transparentMode === "semifull") {
                    // 重新调用初始化函数来重新绑定滚动事件
                    if (
                        typeof (window as any).initSemifullScrollDetection === "function"
                    ) {
                        (window as any).initSemifullScrollDetection();
                    }
                }
            }

        });
        window.swup.hooks.on("visit:start", (visit: { to: { url: string } }) => {
            // Start progress bar
            const progressBar = document.getElementById("progress-bar");
            if (progressBar) {
                progressBar.classList.remove("finishing", "done");
                // Force reflow so the animation restarts cleanly
                void progressBar.offsetWidth;
                progressBar.classList.add("loading");
            }

            // change banner height immediately when a link is clicked
            const bodyElement = document.querySelector("body");
            const isHomePage = pathsEqual(visit.to.url, url("/"));

            if (isHomePage) {
                bodyElement!.classList.add("lg:is-home");
            } else {
                bodyElement!.classList.remove("lg:is-home");
            }

            // Control banner text visibility based on page
            const bannerTextOverlay = document.querySelector(".banner-home-text-overlay");
            if (bannerTextOverlay) {
                if (isHomePage) {
                    bannerTextOverlay.classList.remove("hidden");
                } else {
                    bannerTextOverlay.classList.add("hidden");
                }
            }

            // Control navbar transparency based on page
            const navbar = document.getElementById("navbar");
            if (navbar) {
                navbar.setAttribute("data-is-home", isHomePage.toString());

                // 重新初始化semifull模式的滚动检测
                const transparentMode = navbar.getAttribute("data-transparent-mode");
                if (transparentMode === "semifull") {
                    // 重新调用初始化函数来重新绑定滚动事件
                    if (
                        typeof (window as any).initSemifullScrollDetection === "function"
                    ) {
                        (window as any).initSemifullScrollDetection();
                    }
                }
            }

            // Control mobile banner visibility based on page with improved staging animation
            // 只在移动端（1024px以下）处理banner隐藏
            const isMobile = window.innerWidth < 1024;

            // 在移动端禁用文章列表容器的过渡动画，防止与主内容区位置变化冲突
            if (isMobile) {
                const postListContainer = document.getElementById("post-list-container");
                if (postListContainer) {
                    postListContainer.style.transition = "none";
                }
            }

            const wallpaperWrapper = document.getElementById("wallpaper-wrapper");
            const mainContentWrapper = document.querySelector(
                ".absolute.w-full.z-30",
            ) as HTMLElement | null;

            if (isMobile && wallpaperWrapper && mainContentWrapper) {
                if (isHomePage) {
                    // 首页：禁用主内容区域的过渡动画，防止文章列表下移
                    mainContentWrapper.style.transition = "none";

                    // 先显示banner，然后移除隐藏类让其优雅出现
                    wallpaperWrapper.style.display = "";
                    setTimeout(() => {
                        wallpaperWrapper.classList.remove("mobile-hide-banner");
                    }, 100);
                    setTimeout(() => {
                        mainContentWrapper.classList.remove("mobile-main-no-banner");
                        // 在移除类之后立即恢复过渡动画（下次导航时使用）
                        setTimeout(() => {
                            mainContentWrapper.style.transition = "";
                        }, 50);
                    }, 150);
                } else {
                    // 非首页：分阶段隐藏，先隐藏banner，再移动内容
                    wallpaperWrapper.classList.add("mobile-hide-banner");
                    // 延迟移动内容，让banner先完全消失
                    setTimeout(() => {
                        mainContentWrapper.classList.add("mobile-main-no-banner");
                    }, 100);
                }
            } else if (!isMobile && wallpaperWrapper) {
                // 桌面端：确保banner正常显示
                wallpaperWrapper.style.display = "";
                wallpaperWrapper.classList.remove("mobile-hide-banner");
                if (mainContentWrapper) {
                    mainContentWrapper.classList.remove("mobile-main-no-banner");
                }
            }

            // increase the page height during page transition to prevent the scrolling animation from jumping
            const heightExtend = document.getElementById("page-height-extend");
            if (heightExtend) {
                heightExtend.classList.remove("hidden");
            }

            // Hide the TOC while scrolling back to top
            let toc = document.getElementById("toc-wrapper");
            if (toc) {
                toc.classList.add("toc-not-ready");
            }
        });
        window.swup.hooks.on("page:view", () => {
            // 更新网格列数和侧边栏组件可见性
            updateMainGridCols();
            updateSidebarComponentsVisibility();

            // hide the temp high element when the transition is done
            const heightExtend = document.getElementById("page-height-extend");
            if (heightExtend) {
                heightExtend.classList.remove("hidden");
            }

            // 确保页面滚动到顶部，使用平滑滚动避免侧边栏闪烁
            window.scrollTo({
                top: 0,
                behavior: "smooth",
            });

            // 在移动端恢复文章列表容器的过渡动画（在主内容区位置动画完成后）
            const isMobile = window.innerWidth < 1024;
            if (isMobile) {
                setTimeout(() => {
                    const postListContainer = document.getElementById("post-list-container");
                    if (postListContainer) {
                        postListContainer.style.transition = "";
                    }
                }, 600); // 等待主内容区动画完成（0.4s + 0.1s delay + 100ms buffer）
            }

            // 同步主题状态 - 解决从首页进入文章页面时代码块渲染问题
            const storedTheme = localStorage.getItem("theme") || siteConfig.themeColor.defaultMode || "light";
            let isDark = false;

            // 处理 system 模式
            if (storedTheme === "system") {
                isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            } else {
                isDark = storedTheme === "dark";
            }

            const expectedTheme = isDark
                ? expressiveCodeConfig.darkTheme
                : expressiveCodeConfig.lightTheme;
            const currentTheme = document.documentElement.getAttribute("data-theme");

            // 如果主题不匹配，静默更新（不触发事件，避免重新加载效果）
            if (currentTheme !== expectedTheme) {
                document.documentElement.setAttribute("data-theme", expectedTheme);
            }

            // 检查当前页面是否为文章页面，如果是则触发自定义事件用于初始化评论系统
            setTimeout(() => {
                if (location.href.includes("/moments/")) {
                    document.dispatchEvent(new CustomEvent("moments:ready"));
                }
                if (document.getElementById("tcomment")) {
                    // 触发自定义事件，通知评论系统页面已完全加载
                    const pageLoadedEvent = new CustomEvent("firefly:page:loaded", {
                        detail: {
                            path: window.location.pathname,
                            timestamp: Date.now(),
                        },
                    });
                    document.dispatchEvent(pageLoadedEvent);
                    console.log(
                        "Layout: 触发 firefly:page:loaded 事件，路径:",
                        window.location.pathname,
                    );
                }
            }, 300);
        });
        window.swup.hooks.on("visit:end", (_visit: { to: { url: string } }) => {
            // Finish progress bar
            const progressBar = document.getElementById("progress-bar");
            if (progressBar) {
                progressBar.classList.remove("loading");
                progressBar.classList.add("finishing");
                setTimeout(() => {
                    progressBar.classList.remove("finishing");
                    progressBar.classList.add("done");
                    setTimeout(() => {
                        progressBar.classList.remove("done");
                    }, 300);
                }, 200);
            }

            setTimeout(() => {
                const heightExtend = document.getElementById("page-height-extend");
                if (heightExtend) {
                    heightExtend.classList.add("hidden");
                }

                // Just make the transition looks better
                const toc = document.getElementById("toc-wrapper");
                if (toc) {
                    toc.classList.remove("toc-not-ready");
                }

                // 移除页面切换保护，恢复过渡动画
                document.documentElement.classList.remove("is-page-transitioning");
            }, 200);
        });


    };
    if (window?.swup?.hooks) {
        setup();
    } else {
        document.addEventListener("swup:enable", setup);
    }

    let backToTopBtn = document.getElementById("back-to-top-btn");
    let toc = document.getElementById("toc-wrapper");
    let navbar = document.getElementById("navbar-wrapper");

    // 优化的滚动处理函数
    function scrollFunction() {
        const scrollTop = document.documentElement.scrollTop;
        const bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100);

        // 使用批量DOM操作优化性能
        const operations: (() => void)[] = [];

        if (backToTopBtn) {
            operations.push(() => {
                if (scrollTop > bannerHeight) {
                    backToTopBtn.classList.remove("hide");
                } else {
                    backToTopBtn.classList.add("hide");
                }
            });
        }

        if (bannerEnabled && toc) {
            operations.push(() => {
                if (scrollTop > bannerHeight) {
                    toc.classList.remove("toc-hide");
                } else {
                    toc.classList.add("toc-hide");
                }
            });
        }

        if (bannerEnabled && navbar) {
            operations.push(() => {
                const threshold = window.innerHeight * (BANNER_HEIGHT_HOME / 100) - 88;

                if (scrollTop >= threshold) {
                    navbar.classList.add("navbar-hidden");
                } else {
                    navbar.classList.remove("navbar-hidden");
                }
            });
        }

        // 批量执行DOM操作
        if (operations.length > 0) {
            requestAnimationFrame(() => {
                operations.forEach((op) => op());
            });
        }
    }

    // 使用优化的滚动性能处理
    let scrollTimeout: number;
    window.addEventListener(
        "scroll",
        () => {
            if (scrollTimeout) {
                cancelAnimationFrame(scrollTimeout);
            }
            scrollTimeout = requestAnimationFrame(scrollFunction);
        },
        { passive: true },
    );

    window.onresize = () => {
        // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
        let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
        offset = offset - (offset % 4);
        document.documentElement.style.setProperty(
            "--banner-height-extend",
            `${offset}px`,
        );
    };

    // 页面加载完成后初始化banner和katex容器
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
            showBanner();
            initCustomScrollbar();
        });
    } else {
        showBanner();
        initCustomScrollbar();
    }

    // 检查当前页面是否为文章详情页
    const isCurrentPagePost = () =>
        window.location.pathname.includes("/posts/") || window.location.pathname.includes("/post/");

    // 更新主网格的网格列数
    function updateMainGridCols() {
        const mainGrid = document.getElementById("main-grid");
        if (!mainGrid) return;

        const isPostPage = isCurrentPagePost();
        const sidebarPosition = mainGrid.getAttribute("data-sidebar-position") || "left";
        const tabletSidebar = mainGrid.getAttribute("data-tablet-sidebar") || "left";
        const showBothSidebarsOnPostPage = mainGrid.getAttribute("data-show-both-sidebars-on-post") === "true";

        const shouldBothSidebars = isPostPage && sidebarPosition !== "both" && showBothSidebarsOnPostPage;

        let newGridClasses: string;

        if (sidebarPosition === "both" || shouldBothSidebars) {
            // 双侧栏（含文章页临时双侧栏）
            // 从right临时扩展为both时，平板端保持显示右侧栏
            const effectiveTabletSidebar = (shouldBothSidebars && sidebarPosition === "right") ? "right" : tabletSidebar;
            if (effectiveTabletSidebar === "right") {
                newGridClasses = "grid-cols-1 md:grid-cols-[1fr_17.5rem] xl:grid-cols-[17.5rem_1fr_17.5rem]";
            } else {
                newGridClasses = "grid-cols-1 md:grid-cols-[17.5rem_1fr] xl:grid-cols-[17.5rem_1fr_17.5rem]";
            }
        } else if (sidebarPosition === "right") {
            // 仅右侧栏
            newGridClasses = "grid-cols-1 md:grid-cols-[1fr_17.5rem]";
        } else {
            // 仅左侧栏
            newGridClasses = "grid-cols-1 md:grid-cols-[17.5rem_1fr]";
        }

        // 移除旧类并添加新类
        ["grid-cols-1", "md:grid-cols-[17.5rem_1fr]", "md:grid-cols-[1fr_17.5rem]", "xl:grid-cols-[17.5rem_1fr_17.5rem]"].forEach(
            cls => mainGrid.classList.remove(cls),
        );

        newGridClasses.split(" ").forEach(cls => cls && mainGrid.classList.add(cls));

        // position为right时，swup导航不会替换静态元素(右侧栏、主内容容器、页脚)的class
        // 需要在JS中手动更新这些元素的网格定位类，以匹配2列/3列布局的切换
        if (sidebarPosition === "right") {
            const rightSidebar = document.getElementById("right-sidebar");
            const swupContainer = document.getElementById("swup-container");
            const footer = mainGrid.querySelector(".footer");

            if (shouldBothSidebars) {
                // 文章页临时双侧栏：右侧栏移到第3列，主内容移到第2列，页脚居中
                rightSidebar?.classList.add("xl:col-start-3");
                swupContainer?.classList.add("xl:col-start-2", "xl:col-end-3");
                if (footer) {
                    footer.classList.remove("md:col-start-1", "xl:col-start-1");
                    footer.classList.add("xl:col-start-2");
                }
            } else {
                // 非文章页：恢复2列布局定位
                rightSidebar?.classList.remove("xl:col-start-3");
                swupContainer?.classList.remove("xl:col-start-2", "xl:col-end-3");
                if (footer) {
                    footer.classList.add("md:col-start-1", "xl:col-start-1");
                    footer.classList.remove("xl:col-start-2");
                }
            }
        }
    }

    // 更新侧边栏组件的可见性
    function updateSidebarComponentsVisibility() {
        const isPostPage = isCurrentPagePost();

        // 处理 showOnPostPage === false 的组件
        document.querySelectorAll(".widget-hide-on-post").forEach((widget) => {
            isPostPage ? widget.classList.add("hidden") : widget.classList.remove("hidden");
        });

        // 处理 showOnNonPostPage === false 的组件
        document.querySelectorAll(".widget-hide-on-non-post").forEach((widget) => {
            !isPostPage ? widget.classList.add("hidden") : widget.classList.remove("hidden");
        });
    }

    // Initialize wallpaper mode
    import { initWallpaperMode, initThemeListener } from "@/utils/setting-utils";
    import { initIconLoader } from "@/utils/icon-loader";

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
            updateMainGridCols();
            updateSidebarComponentsVisibility();
            initWallpaperMode();
            initThemeListener();
            initIconLoader();
        });
    } else {
        updateMainGridCols();
        updateSidebarComponentsVisibility();
        initWallpaperMode();
        initThemeListener();
        initIconLoader();
    }
    </script>;
</file>

<file path="layouts/MainGridLayout.astro">
---
import Live2DWidget from "@components/features/Live2DWidget.astro";

import SpineModel from "@components/features/SpineModel.astro";
import Footer from "@components/layout/Footer.astro";
import Navbar from "@components/layout/Navbar.astro";
import SideBar from "@components/layout/SideBar.astro";
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";
import ImageWrapper from "@/components/common/ImageWrapper.astro";
import FloatingControls from "@/components/controls/FloatingControls.astro";
import TypewriterText from "@/components/features/TypewriterText.astro";
import CategoryBar from "@/components/layout/CategoryBar.astro";
import {
    backgroundWallpaper,
    live2dModelConfig,
    sidebarLayoutConfig,
    siteConfig,
} from "@/config";
import {
    BANNER_HEIGHT,
    BANNER_HEIGHT_EXTEND,
    MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
} from "@/constants/constants";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { formatDateToYYYYMMDD } from "@/utils/date-utils";
import { getImageQuality } from "@/utils/image-utils";
import { getBackgroundImages, isHomePage } from "@/utils/layout-utils";
import {
    generateGridClasses,
    generateMainContentClasses,
    generateRightSidebarClasses,
    generateSidebarClasses,
    getResponsiveSidebarConfig,
    type ResponsiveSidebarConfig,
} from "@/utils/responsive-utils";
import Layout from "./Layout.astro";

import "@/styles/markdown.css";
import "@/styles/expressive-code.css";

interface Props {
    title?: string;
    banner?: string;
    description?: string;
    lang?: string;
    setOGTypeArticle?: boolean;
    postSlug?: string;
    headings?: MarkdownHeading[];
    bannerPostMeta?: {
        title: string;
        published: Date;
        updated?: Date;
        words?: number;
        minutes?: number;
    };
}

const backgroundImages = getBackgroundImages();
const backgroundImagesDark = backgroundWallpaper.src as { desktopDark: string; mobileDark: string; };

const {
    title,
    banner,
    description,
    lang,
    setOGTypeArticle,
    postSlug,
    headings = [],
    bannerPostMeta,
} = Astro.props;

// 检查背景壁纸模式和是否允许切换
const isBannerMode = backgroundWallpaper.mode === "banner";
const isOverlayMode = backgroundWallpaper.mode === "overlay";
const isBackgroundEnabled = backgroundWallpaper.mode !== "none";
const isWallpaperSwitchable = backgroundWallpaper.switchable ?? true;

// 检查是否启用水波纹动画效果
const wavesConfig = backgroundWallpaper.banner?.waves?.enable;
const wavesSwitchable = backgroundWallpaper.banner?.waves?.switchable ?? false;
// 处理分设备控制的水波纹动画
const wavesEnabledOnDesktop =
    typeof wavesConfig === "object" ? wavesConfig.desktop : wavesConfig;
const wavesEnabledOnMobile =
    typeof wavesConfig === "object" ? wavesConfig.mobile : wavesConfig;
// 是否需要渲染水波纹元素（任一设备启用 或 允许用户切换）
const shouldRenderWaves =
    wavesEnabledOnDesktop || wavesEnabledOnMobile || wavesSwitchable;

// 处理分设备控制的横幅信贷显示
const creditEnableConfig = backgroundWallpaper.banner?.credit?.enable;
const creditEnabledOnDesktop =
    typeof creditEnableConfig === "object"
        ? creditEnableConfig.desktop
        : creditEnableConfig;
const creditEnabledOnMobile =
    typeof creditEnableConfig === "object"
        ? creditEnableConfig.mobile
        : creditEnableConfig;

const hasBannerCredit =
    isBannerMode && isBackgroundEnabled && creditEnableConfig;

// 处理分设备控制的横幅信贷文本和链接
const creditTextConfig = backgroundWallpaper.banner?.credit?.text;
const creditTextDesktop =
    typeof creditTextConfig === "object"
        ? creditTextConfig.desktop
        : creditTextConfig;
const creditTextMobile =
    typeof creditTextConfig === "object"
        ? creditTextConfig.mobile
        : creditTextConfig;

const creditUrlConfig = backgroundWallpaper.banner?.credit?.url;
const creditUrlDesktop =
    typeof creditUrlConfig === "object"
        ? creditUrlConfig.desktop
        : creditUrlConfig;
const creditUrlMobile =
    typeof creditUrlConfig === "object"
        ? creditUrlConfig.mobile
        : creditUrlConfig;

// 检查是否为首页
const isHomePageCheck = isHomePage(Astro.url.pathname);

// 检查是否在文章详情页
const isPostPage = !!postSlug;

// 随机选择副标题（当打字机关闭且为数组时）
const getRandomSubtitle = () => {
    const subtitle = backgroundWallpaper.banner?.homeText?.subtitle;
    if (Array.isArray(subtitle)) {
        const randomIndex = Math.floor(Math.random() * subtitle.length);
        return subtitle[randomIndex];
    }
    return subtitle;
};
const randomSubtitle = getRandomSubtitle();

// 主页横幅文本只在首页且全局开关为 true 时显示，不区分设备
const homeTextEnable = backgroundWallpaper.banner?.homeText?.enable;
const showHomeText = isBannerMode && !!homeTextEnable && isHomePageCheck;

const showBannerPostMeta =
    isBannerMode &&
    isBackgroundEnabled &&
    !isHomePageCheck &&
    isPostPage &&
    !!bannerPostMeta;

const showBannerDim = isBannerMode && isBackgroundEnabled;

const showBannerPageTitle =
    isBannerMode &&
    isBackgroundEnabled &&
    !isHomePageCheck &&
    !isPostPage &&
    !!title;
// 手机端非首页不显示banner的CSS类
const mobileNonHomeBannerClass = !isHomePageCheck ? "mobile-hide-banner" : "";

// 计算主内容区域位置，考虑手机端非首页时banner被隐藏
const mainPanelTop =
    isBannerMode && isBackgroundEnabled
        ? `calc(${BANNER_HEIGHT}vh - ${MAIN_PANEL_OVERLAPS_BANNER_HEIGHT}rem)`
        : "5.5rem";

// 当banner模式被禁用时，主内容区域应该始终从顶栏下面开始
// 非首页在小于1024px时会通过 mobile-main-no-banner CSS类覆盖top值为5.5rem
const finalMainPanelTop =
    isBannerMode && isBackgroundEnabled ? mainPanelTop : "5.5rem";

// 获取响应式侧边栏配置
const sidebarConfig = getResponsiveSidebarConfig();

// 在文章页面且启用了showBothSidebarsOnPostPage时，确保对侧组件参与网格计算
const shouldShowBothSidebarsOnPostPage: boolean =
    isPostPage &&
    sidebarLayoutConfig.position !== "both" &&
    !!sidebarLayoutConfig.showBothSidebarsOnPostPage;

// position为left时，对侧为右侧；position为right时，对侧为左侧
const shouldAddRightSidebar: boolean =
    shouldShowBothSidebarsOnPostPage && sidebarLayoutConfig.position === "left";
const shouldAddLeftSidebar: boolean =
    shouldShowBothSidebarsOnPostPage && sidebarLayoutConfig.position === "right";

const effectiveIsBothSidebars: boolean =
    sidebarConfig.isBothSidebars || shouldShowBothSidebarsOnPostPage;
const effectiveHasRightComponents: boolean =
    sidebarConfig.hasRightComponents ||
    (shouldAddRightSidebar &&
        sidebarLayoutConfig.rightComponents.some((comp) => comp.enable));
const effectiveHasLeftComponents: boolean =
    sidebarConfig.hasLeftComponents ||
    (shouldAddLeftSidebar &&
        sidebarLayoutConfig.leftComponents.some((comp) => comp.enable));

// 使用effective值重新生成网格类
// 当position为right且文章页临时显示左侧栏时，tabletSidebar应为right（保持显示主侧栏）
const effectiveTabletSidebar = shouldAddLeftSidebar
    ? ("right" as const)
    : sidebarConfig.tabletSidebar;

const updatedGridConfig: ResponsiveSidebarConfig = {
    ...sidebarConfig,
    isBothSidebars: effectiveIsBothSidebars,
    hasLeftComponents: effectiveHasLeftComponents,
    hasRightComponents: effectiveHasRightComponents,
    tabletSidebar: effectiveTabletSidebar,
};

const { gridCols } = generateGridClasses(updatedGridConfig);
const sidebarClass = generateSidebarClasses(updatedGridConfig);
const rightSidebarClass =
    effectiveIsBothSidebars || sidebarLayoutConfig.position === "right"
        ? generateRightSidebarClasses(updatedGridConfig)
        : "";
const mainContentClass = generateMainContentClasses(updatedGridConfig);
const staticBarClass = mainContentClass.replace("transition-main", "").trim();

const footerClass = ["footer", "col-span-1", "onload-animation"];

if (
    updatedGridConfig.isBothSidebars &&
    updatedGridConfig.hasLeftComponents &&
    updatedGridConfig.hasRightComponents
) {
    // 双侧栏：平板端跨2列，桌面端在中间列
    footerClass.push("md:col-span-2 xl:col-start-2 xl:col-span-1");
} else if (
    updatedGridConfig.hasLeftComponents &&
    !updatedGridConfig.hasRightComponents
) {
    footerClass.push("md:col-span-2 xl:col-start-2 xl:col-span-1");
} else if (
    !updatedGridConfig.hasLeftComponents &&
    updatedGridConfig.hasRightComponents
) {
    // 仅右侧栏：平板端跨2列，内容在第1列
    footerClass.push("md:col-span-2 md:col-start-1 xl:col-start-1 xl:col-span-1");
} else {
    footerClass.push("xl:col-start-1 xl:col-span-1");
}

const footerClassName = footerClass.join(" ");

// 检查是否应该启用半透明效果
const shouldEnableTransparency = isOverlayMode && isBackgroundEnabled;

// 为组件添加半透明效果的CSS类
const transparentClass = shouldEnableTransparency
    ? "wallpaper-transparent"
    : "";

const navbarWidthFull = siteConfig.navbar.widthFull ?? false;

// 获取图片质量配置
const configQuality = getImageQuality();
const mobileQuality = Math.round(configQuality * 0.9);
---

<style is:inline>
    [data-theme*="light"] .dark-theme-wallpaper {
        display: none;
    }

    [data-theme*="dark"] .light-theme-wallpaper {
        display: none;
    }
</style>
<Layout title={title} banner={banner} description={description} lang={lang} setOGTypeArticle={setOGTypeArticle}
        postSlug={postSlug}>


    <!-- 为全屏壁纸模式添加body类 -->
    {shouldEnableTransparency && (
        <script>
            document.body.classList.add("wallpaper-transparent");
            </script>
    )}

    <!-- Navbar -->
    <slot slot="head" name="head"></slot>
    <div id="top-row" class="z-50 pointer-events-none relative transition-all duration-700 mx-auto"
         class:list={[navbarWidthFull ? "" : "max-w-(--page-width) px-0 md:px-4"]}>
        <div id="navbar-wrapper" class="pointer-events-auto sticky top-0 transition-all">
            <Navbar></Navbar>
        </div>
    </div>

    <!-- Wallpaper - 如果允许切换则始终渲染，否则只渲染当前模式 -->
    {(isWallpaperSwitchable || isBannerMode || isOverlayMode) && (
            <div id="wallpaper-wrapper" class:list={[
                `absolute z-10 w-full transition duration-700 overflow-hidden ${mobileNonHomeBannerClass}`,
                (isOverlayMode && !isWallpaperSwitchable) || (isWallpaperSwitchable && !isBannerMode) ? "wallpaper-overlay" : "",
            ]} style={
                isWallpaperSwitchable
                    ? `top: -${BANNER_HEIGHT_EXTEND}vh; display: none; --overlay-opacity: ${backgroundWallpaper.overlay?.opacity ?? 0.8}; --overlay-z-index: ${backgroundWallpaper.overlay?.zIndex ?? -1}; --overlay-blur: ${backgroundWallpaper.overlay?.blur ?? 0}px;`
                    : isOverlayMode
                        ? `--overlay-opacity: ${backgroundWallpaper.overlay?.opacity ?? 0.8}; --overlay-z-index: ${backgroundWallpaper.overlay?.zIndex ?? -1}; --overlay-blur: ${backgroundWallpaper.overlay?.blur ?? 0}px;`
                        : `top: -${BANNER_HEIGHT_EXTEND}vh`
            }>
                <!-- 背景图片显示 -->
                <div class="relative h-full w-full" id="banner-images-container"
                     data-mobile-count={backgroundImages.mobile.length}
                     data-desktop-count={backgroundImages.desktop.length}>
                    <!-- Mobile: 默认渲染第一张，其余放入 template 避免浏览器预加载 -->
                    {backgroundImages.mobile.length > 0 && (
                            <div class="banner-image-slot-mobile absolute inset-0 block lg:hidden">
                                <ImageWrapper
                                        alt="Mobile background image of the blog"
                                        class="light-theme-wallpaper object-cover h-full w-full"
                                        src={backgroundImages.mobile[0]}
                                        position={backgroundWallpaper.banner?.position}
                                        widths={[640, 750, 1080]}
                                        sizes="100vw"
                                        loading="eager"
                                        fetchpriority="high"
                                        quality={mobileQuality}
                                />
                                <ImageWrapper
                                        alt="Mobile background image of the blog"
                                        class="dark-theme-wallpaper object-cover h-full w-full"
                                        src={backgroundImagesDark.mobileDark}
                                        position={backgroundWallpaper.banner?.position}
                                        widths={[640, 750, 1080]}
                                        sizes="100vw"
                                        loading="eager"
                                        fetchpriority="high"
                                        quality={mobileQuality}
                                />
                            </div>
                    )}
                    {backgroundImages.mobile.slice(1).map((src) => (
                            <template class="banner-tpl-mobile">
                                <ImageWrapper
                                        alt="Mobile background image of the blog"
                                        class="object-cover h-full w-full"
                                        src={src}
                                        position={backgroundWallpaper.banner?.position}
                                        widths={[640, 750, 1080]}
                                        sizes="100vw"
                                        loading="eager"
                                        fetchpriority="high"
                                        quality={mobileQuality}
                                />
                            </template>
                    ))}
                    <!-- Desktop: 默认渲染第一张，其余放入 template -->
                    {backgroundImages.desktop.length > 0 && (
                            <div class="banner-image-slot-desktop absolute inset-0 hidden lg:block">
                                <ImageWrapper
                                        id="banner"
                                        alt="Desktop background image of the blog"
                                        class="light-theme-wallpaper object-cover h-full"
                                        src={backgroundImages.desktop[0]}
                                        position={backgroundWallpaper.banner?.position}
                                        widths={[1280, 1920, 2560]}
                                        sizes="100vw"
                                        loading="eager"
                                        fetchpriority="high"
                                        quality={configQuality}
                                />
                                <ImageWrapper
                                        id="banner"
                                        alt="Desktop background image of the blog"
                                        class="dark-theme-wallpaper object-cover h-full"
                                        src={backgroundImagesDark.desktopDark}
                                        position={backgroundWallpaper.banner?.position}
                                        widths={[1280, 1920, 2560]}
                                        sizes="100vw"
                                        loading="eager"
                                        fetchpriority="high"
                                        quality={configQuality}
                                />
                            </div>
                    )}
                    {backgroundImages.desktop.slice(1).map((src) => (
                            <template class="banner-tpl-desktop">
                                <ImageWrapper
                                        id="banner"
                                        alt="Desktop background image of the blog"
                                        class="object-cover h-full"
                                        src={src}
                                        position={backgroundWallpaper.banner?.position}
                                        widths={[1280, 1920, 2560]}
                                        sizes="100vw"
                                        loading="eager"
                                        fetchpriority="high"
                                        quality={configQuality}
                                />
                            </template>
                    ))}
                </div>

                <!-- 客户端随机选择图片脚本 -->
                <script is:inline data-swup-ignore-script>
                    (function randomizeBannerImage() {
                        var container = document.getElementById("banner-images-container");
                        if (!container) return;

                        var mobileCount = parseInt(container.dataset.mobileCount || "0", 10);
                        var desktopCount = parseInt(container.dataset.desktopCount || "0", 10);

                        if (mobileCount <= 1 && desktopCount <= 1) return;

                        // F5 刷新重置，Swup 切换保留
                        if (typeof window.__bannerRandomIndex === "undefined") {
                            window.__bannerRandomIndex = {
                                mobile: mobileCount > 1 ? Math.floor(Math.random() * mobileCount) : 0,
                                desktop: desktopCount > 1 ? Math.floor(Math.random() * desktopCount) : 0,
                            };
                        }

                        // 从 template 替换默认图片（index 0 = 已渲染的默认图，>0 = template）
                        function applyRandom(slotClass, tplClass, randomIndex) {
                            if (randomIndex === 0) return;
                            var slot = container.querySelector("." + slotClass);
                            var templates = container.querySelectorAll("." + tplClass);
                            if (!slot || !templates.length) return;
                            var tpl = templates[randomIndex - 1];
                            if (!tpl) return;
                            slot.innerHTML = "";
                            slot.appendChild(tpl.content.cloneNode(true));
                        }

                        applyRandom("banner-image-slot-mobile", "banner-tpl-mobile", window.__bannerRandomIndex.mobile);
                        applyRandom("banner-image-slot-desktop", "banner-tpl-desktop", window.__bannerRandomIndex.desktop);
                    })();
                </script>

                <div id="banner-dim-container" class="absolute inset-0 z-0 pointer-events-none">
                    {showBannerDim &&
                            <div class="banner-dim-overlay absolute inset-0"></div>}
                </div>

                <div id="banner-overlay-container"
                     class="absolute inset-0 z-20 pointer-events-none transition-swup-fade">
                    <!-- Home page text overlay - 始终渲染以便切换模式时控制显示 -->
                    {homeTextEnable && (
                            <div class={`banner-home-text-overlay absolute inset-0 z-20 flex items-center justify-center ${!showHomeText ? "hidden" : ""}`}>
                                <div class="w-4/5 lg:w-3/4 text-center mb-0">
                                    <div class="flex flex-col">
                                        {backgroundWallpaper.banner?.homeText?.title && (
                                                <h1 class="banner-title font-bold text-white mb-2 lg:mb-4 leading-tight"
                                                    style={{ fontSize: backgroundWallpaper.banner.homeText.titleSize || "3rem" }}>
                                                    {backgroundWallpaper.banner.homeText.title}
                                                </h1>
                                        )}
                                        {backgroundWallpaper.banner?.homeText?.subtitle && (
                                                <h2 id="banner-subtitle"
                                                    class="banner-subtitle text-white/90 leading-snug"
                                                    style={{ fontSize: backgroundWallpaper.banner.homeText.subtitleSize || "1.5rem" }}
                                                    data-subtitles={JSON.stringify(backgroundWallpaper.banner.homeText.subtitle)}>
                                                    {backgroundWallpaper.banner.homeText.typewriter?.enable ? (
                                                            <TypewriterText
                                                                    text={backgroundWallpaper.banner.homeText.subtitle}
                                                                    speed={backgroundWallpaper.banner.homeText.typewriter.speed}
                                                                    deleteSpeed={backgroundWallpaper.banner.homeText.typewriter.deleteSpeed}
                                                                    pauseTime={backgroundWallpaper.banner.homeText.typewriter.pauseTime}
                                                            />
                                                    ) : (
                                                        randomSubtitle
                                                    )}
                                                </h2>
                                        )}
                                    </div>
                                </div>
                            </div>
                    )}

                    <script is:inline>
                        function setRandomSubtitle() {
                            const subtitleElement = document.getElementById("banner-subtitle");
                            if (!subtitleElement) return;

                            const subtitlesData = subtitleElement.dataset.subtitles;
                            if (!subtitlesData) return;

                            try {
                                const subtitles = JSON.parse(subtitlesData);
                                // Only randomize if it's an array and typewriter is NOT enabled (check for typewriter class)
                                if (Array.isArray(subtitles) && subtitles.length > 0 && !subtitleElement.querySelector(".typewriter")) {
                                    // Use a global variable to persist the subtitle across Swup navigations
                                    // This variable will be reset on full page reload (F5), meeting the requirement
                                    if (!window.fireflyCachedSubtitle) {
                                        const randomIndex = Math.floor(Math.random() * subtitles.length);
                                        window.fireflyCachedSubtitle = subtitles[randomIndex];
                                    }
                                    subtitleElement.textContent = window.fireflyCachedSubtitle;
                                }
                            } catch (e) {
                                console.error("Failed to parse subtitles", e);
                            }
                        }

                        // Run on initial load
                        setRandomSubtitle();
                    </script>

                    <!-- Non-home non-post page title overlay (desktop only) -->
                    {showBannerPageTitle && (
                            <div class="banner-page-title-overlay absolute inset-0 z-20 hidden lg:flex items-center justify-center pointer-events-none">
                                <div class="w-4/5 lg:w-3/4 text-center mb-0">
                                    <h1 class="banner-page-title font-bold text-white leading-tight inline-flex items-center justify-center gap-3">
                                        {/* <Icon name="material-symbols:bookmark-rounded" class="banner-page-title-icon" /> */}
                                        <span class="banner-page-title-text">{title}</span>
                                    </h1>
                                </div>
                            </div>
                    )}

                    <!-- Non-home post banner meta overlay (desktop only) -->
                    {showBannerPostMeta && bannerPostMeta && (
                            <div class="banner-post-meta-overlay absolute inset-0 z-20 hidden lg:flex items-center justify-center pointer-events-none">
                                <div class="w-4/5 lg:w-3/4 text-center mb-0">
                                    <div class="flex flex-col items-center gap-3">
                                        <h1 class="banner-post-title font-bold text-white leading-tight">
                                            {bannerPostMeta.title}
                                        </h1>
                                        <div class="banner-post-meta-list flex flex-wrap items-center justify-center gap-x-5 gap-y-2 text-white/90 text-sm md:text-base">
                        <span class="inline-flex items-center gap-1.5">
                            <Icon name="material-symbols:calendar-month-outline-rounded" class="text-[1.05em]"/>
                            <span>{i18n(I18nKey.publishedAt)} {formatDateToYYYYMMDD(bannerPostMeta.published)}</span>
                        </span>
                                            {bannerPostMeta.updated &&
                                                bannerPostMeta.updated.getTime() !== bannerPostMeta.published.getTime() && (
                                                            <span class="inline-flex items-center gap-1.5">
                                    <Icon name="material-symbols:update-rounded" class="text-[1.05em]"/>
                                    <span>{i18n(I18nKey.updatedAt)} {formatDateToYYYYMMDD(bannerPostMeta.updated)}</span>
                                </span>
                                                )}
                                            {typeof bannerPostMeta.words === "number" && (
                                                    <span class="inline-flex items-center gap-1.5">
                                <Icon name="material-symbols:ink-pen-outline-rounded" class="text-[1.05em]"/>
                                <span>
                                    {bannerPostMeta.words} {i18n(bannerPostMeta.words === 1 ? I18nKey.wordCount : I18nKey.wordsCount)}
                                </span>
                            </span>
                                            )}
                                            {typeof bannerPostMeta.minutes === "number" && (
                                                    <span class="inline-flex items-center gap-1.5">
                                <Icon name="material-symbols:schedule-outline-rounded" class="text-[1.05em]"/>
                                <span>
                                    {bannerPostMeta.minutes} {i18n(bannerPostMeta.minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
                                    · {i18n(I18nKey.readTime)}
                                </span>
                            </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                    )}
                </div>

                <!-- Water waves effect - 如果允许切换或任一设备启用则渲染 -->
                {shouldRenderWaves ? (
                        <div class={`waves absolute -bottom-px h-[10vh] max-h-37.5 min-h-12.5 w-full md:h-[15vh]
        ${!wavesEnabledOnMobile ? "hidden" : ""} ${!wavesEnabledOnDesktop ? "md:hidden" : ""} ${wavesEnabledOnDesktop ? "md:block" : ""}`}
                             id="header-waves"
                             style="transform: translateZ(0); will-change: fill;">
                            <svg
                                    class="waves"
                                    xmlns="http://www.w3.org/2000/svg"
                                    xmlns:xlink="http://www.w3.org/1999/xlink"
                                    viewBox="0 24 150 28"
                                    preserveAspectRatio="none"
                                    shape-rendering="geometricPrecision"
                            >
                                <defs>
                                    <path
                                            id="gentle-wave"
                                            d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v48h-352z"
                                    >
                                    </path>
                                </defs>
                                <g class="parallax">
                                    <use
                                            xlink:href="#gentle-wave"
                                            x="48"
                                            y="0"
                                            class="opacity-25 fill-(--page-bg)"
                                    ></use>
                                    <use
                                            xlink:href="#gentle-wave"
                                            x="48"
                                            y="3"
                                            class="opacity-50 fill-(--page-bg)"
                                    ></use>
                                    <use
                                            xlink:href="#gentle-wave"
                                            x="48"
                                            y="5"
                                            class="opacity-65 fill-(--page-bg)"
                                    ></use>
                                    <use
                                            xlink:href="#gentle-wave"
                                            x="48"
                                            y="7"
                                            class=" opacity-75 fill-(--page-bg)"
                                    ></use>
                                </g>
                            </svg>
                        </div>
                ) : null}
            </div>
    )}

    {/* 当壁纸未渲染时，添加空的 Swup 占位容器，避免 Swup 找不到容器而回退为整页加载 */}
    {!(isWallpaperSwitchable || isBannerMode || isOverlayMode) && (
            <>
                <div id="banner-overlay-container" class="hidden"></div>
                <div id="banner-dim-container" class="hidden"></div>
            </>
    )}

    <!-- Main content -->
    <div class={`absolute w-full z-30 pointer-events-none ${mobileNonHomeBannerClass ? "mobile-main-no-banner" : ""} ${!(isBannerMode && isBackgroundEnabled) ? "no-banner-layout" : ""} ${transparentClass}`}
         style={`top: ${finalMainPanelTop}`}>
        <!-- The pointer-events-none here prevent blocking the click event of the TOC -->
        <div class="relative max-w-(--page-width) mx-auto pointer-events-auto">
            <div id="main-grid"
                 class={`transition duration-700 w-full left-0 right-0 grid ${gridCols} grid-rows-[auto_1fr_auto] lg:grid-rows-[auto] mx-auto gap-4 px-2 md:px-4 ${!sidebarConfig.mobileShowSidebar ? "mobile-no-sidebar" : ""}`}
                 data-sidebar-position={sidebarLayoutConfig.position}
                 data-tablet-sidebar={sidebarLayoutConfig.tabletSidebar ?? "left"}
                 data-show-both-sidebars-on-post={sidebarLayoutConfig.showBothSidebarsOnPostPage ? "true" : "false"}
            >
                <!-- Background image credit - Desktop -->
                {hasBannerCredit && creditEnabledOnDesktop && <a
                        href={creditUrlDesktop || "#"}
                        id="banner-credit-desktop"
                        target={creditUrlDesktop ? "_blank" : "_self"}
                        rel={creditUrlDesktop ? "noopener" : ""}
                        aria-label="Visit image source"
                        class:list={[
                            "group onload-animation transition-all absolute justify-center items-center rounded-full " +
                            "px-3 right-4 -top-13 bg-black/60 hover:bg-black/70 h-9 hidden md:flex",
                            { "hover:pr-9 active:bg-black/80": creditUrlDesktop },
                        ]}
                >
                    <Icon class="text-white/75 text-[1.25rem] mr-1"
                          name="material-symbols:copyright-outline-rounded"></Icon>
                    <div class="text-white/75 text-xs">{creditTextDesktop}</div>
                    {creditUrlDesktop &&
                            <Icon class:list={["transition absolute text-[oklch(0.75_0.14_var(--hue))] right-4 text-[0.75rem] opacity-0 group-hover:opacity-100"]}
                                  name="fa7-solid:arrow-up-right-from-square">
                            </Icon>}
                </a>}

                <!-- Background image credit - Mobile -->
                {hasBannerCredit && creditEnabledOnMobile && <a
                        href={creditUrlMobile || "#"}
                        id="banner-credit-mobile"
                        target={creditUrlMobile ? "_blank" : "_self"}
                        rel={creditUrlMobile ? "noopener" : ""}
                        aria-label="Visit image source"
                        class:list={[
                            "group onload-animation transition-all absolute justify-center items-center rounded-full " +
                            "px-3 right-4 -top-13 bg-black/60 hover:bg-black/70 h-9 flex md:hidden",
                            { "hover:pr-9 active:bg-black/80": creditUrlMobile },
                        ]}
                >
                    <Icon class="text-white/75 text-[1.25rem] mr-1"
                          name="material-symbols:copyright-outline-rounded"></Icon>
                    <div class="text-white/75 text-xs">{creditTextMobile}</div>
                    {creditUrlMobile &&
                            <Icon class:list={["transition absolute text-[oklch(0.75_0.14_var(--hue))] right-4 text-[0.75rem] opacity-0 group-hover:opacity-100"]}
                                  name="fa7-solid:arrow-up-right-from-square">
                            </Icon>}
                </a>}


                {/* 渲染左侧边栏 - 根据position和tabletSidebar配置显示 */}
                {/*
                如果全局配置为双侧栏(position: both)或仅左侧栏(position: left)，则使用静态容器(不被swup替换)，避免闪烁。
                如果全局配置为仅右侧栏(position: right)，则使用动态容器(被swup替换)，以便在文章页显示左侧栏。
                注意：为了满足swup要求所有containers必须存在，我们在所有模式下都必须渲染 #left-sidebar-dynamic。
            */}
                {sidebarLayoutConfig.position !== "right" ? (
                        <>
                            <div id="left-sidebar-wrapper" class="contents" style="contain: layout style paint;">
                                {effectiveHasLeftComponents && (
                                        <SideBar
                                                side={effectiveIsBothSidebars ? "left" : undefined}
                                                class={`${sidebarClass} ${transparentClass}`}
                                                headings={headings}
                                        />
                                )}
                            </div>
                            <div id="left-sidebar-dynamic" class="hidden transition-swup-fade"></div>
                        </>
                ) : (
                        <div id="left-sidebar-dynamic" class="contents transition-swup-fade">
                            {effectiveIsBothSidebars && effectiveHasLeftComponents && (
                                    <SideBar side="left" class={`${sidebarClass} ${transparentClass}`}
                                             headings={headings}></SideBar>
                            )}
                        </div>
                )}

                {/* 主内容区包装器 - 包含静态栏位和swup容器，作为单个grid item */}
                <div class={staticBarClass}>
                    {/* 分类导航栏 - 在所有页面渲染，由客户端JS控制显隐 */}
                    {siteConfig.categoryBar &&
                            <CategoryBar/>}

                    {/* 主内容区 - 始终渲染，确保 Swup 容器存在 */}
                    <main id="swup-container" class="transition-main">
                        {/* 携带网格布局类名，用于JS更新父容器 */}
                        <div id="grid-class-carrier" data-grid-class={gridCols} class="hidden"></div>
                        {/* 备用 h1 标题 - 当主页横幅文本未启用时，提供隐藏的主标题 */}
                        {isHomePageCheck && !showHomeText && (
                                <h1 class="sr-only">{siteConfig.title}</h1>
                        )}
                        <div id="content-wrapper" class="onload-animation transition-leaving">
                            <slot></slot>

                        </div>
                    </main>
                </div>

                {/* 右侧边栏 - 双侧边栏模式或仅右侧栏模式 */}
                {/*
                如果全局配置为双侧栏(position: both)或仅右侧栏(position: right)，则使用静态容器(不被swup替换)，避免闪烁。
                如果全局配置为单侧栏(position: left)，则使用动态容器(被swup替换)，以便在文章页显示右侧栏。
                注意：为了满足swup要求所有containers必须存在，我们在所有模式下都必须渲染 #right-sidebar-dynamic。
                右侧边栏的显示由CSS类控制。
            */}
                {(sidebarLayoutConfig.position === "both" || sidebarLayoutConfig.position === "right") ? (
                        <>
                            <div id="right-sidebar-static" class="contents">
                                {(effectiveIsBothSidebars || sidebarLayoutConfig.position === "right") && effectiveHasRightComponents && (
                                        <SideBar side="right" class={`${rightSidebarClass} ${transparentClass}`}
                                                 headings={headings}></SideBar>
                                )}
                            </div>
                            <div id="right-sidebar-dynamic" class="hidden transition-swup-fade"></div>
                        </>
                ) : (
                        <div id="right-sidebar-dynamic" class="contents transition-swup-fade">
                            {effectiveIsBothSidebars && effectiveHasRightComponents && (
                                    <SideBar side="right" class={`${rightSidebarClass} ${transparentClass}`}
                                             headings={headings}></SideBar>
                            )}
                        </div>
                )}

                {/* 移动端底部组件 - 768px及以下显示 */}
                {sidebarLayoutConfig.mobileBottomComponents && sidebarLayoutConfig.mobileBottomComponents.length > 0 && (
                        <div id="mobile-bottom-sidebar" class="col-span-1 block md:hidden mt-4">
                            <SideBar side="bottom" class={`${transparentClass}`} headings={headings}></SideBar>
                        </div>
                )}

                <div class={footerClassName}>
                    <Footer></Footer>
                </div>
            </div>

            <SpineModel></SpineModel>
            {live2dModelConfig.enable &&
                    <Live2DWidget config={live2dModelConfig}/>}
        </div>
    </div>

    <FloatingControls headings={headings}/>


</Layout>

<style is:global>
    /* 右侧栏平滑过渡 */
    #right-sidebar {
        transition: opacity 0.35s ease-in-out,
        transform 0.35s ease-in-out;
    }

    @keyframes swupFadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0.95;
        }
    }

</style>
</file>

<file path="pages/[...page].astro">
---
import type { GetStaticPaths } from "astro";
import Pagination from "@/components/common/Pagination.astro";
import PostPage from "@/components/layout/PostPage.astro";
import { siteConfig } from "@/config";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getSortedPosts } from "@/utils/content-utils";
export const getStaticPaths = (async ({ paginate }) => {
	const allBlogPosts = await getSortedPosts();
	// 使用配置中的文章数量
	const pageSize = siteConfig.pagination.postsPerPage;
	return paginate(allBlogPosts, { pageSize });
}) satisfies GetStaticPaths;
// https://github.com/withastro/astro/issues/6507#issuecomment-1489916992

const { page } = Astro.props;

const len = page.data.length;
---

<MainGridLayout>
  <PostPage page={page} />
  {
    page.total > page.size && (
      <Pagination
        class="mx-auto onload-animation"
        page={page}
        style={`animation-delay: calc(var(--content-delay) + ${len * 50}ms)`}
      />
    )
  }
</MainGridLayout>

<script>
  // 响应式分页处理脚本
  document.addEventListener("DOMContentLoaded", function () {
    // 如果启用了响应式分页，添加相应的CSS类
    const responsiveEnabled = true; // ${siteConfig.pagination.responsive}
    if (responsiveEnabled) {
      const deviceType = getDeviceType();
      document.body.classList.add(`device-${deviceType}`);

      // 监听窗口大小变化
      let resizeTimeout: any;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          const newDeviceType = getDeviceType();
          const currentDeviceType = document.body.className.match(
            /device-(mobile|tablet|desktop)/
          )?.[1];

          if (currentDeviceType !== newDeviceType) {
            document.body.classList.remove(`device-${currentDeviceType}`);
            document.body.classList.add(`device-${newDeviceType}`);
          }
        }, 250);
      });
    }
  });

  function getDeviceType() {
    if (typeof window === "undefined") return "desktop";

    const width = window.innerWidth;
    if (width < 768) return "mobile";
    if (width < 1024) return "tablet";
    return "desktop";
  }
</script>
</file>

<file path="pages/404.astro">
---
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { url } from "@/utils/url-utils";
---

<MainGridLayout title={i18n(I18nKey.notFound)} description={i18n(I18nKey.notFoundDescription)}>
    <div class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-96">
        <div class="card-base z-10 px-9 py-12 relative w-full flex flex-col items-center justify-center text-center">
            <!-- 404 大号数字 -->
            <div class="text-8xl md:text-9xl font-bold text-(--primary) opacity-20 mb-4">
                {i18n(I18nKey.notFound)}
            </div>
            
            <!-- 404 图标 -->
            <div class="mb-6">
                <Icon name="material-symbols:error-outline" class="text-6xl text-(--primary)" />
            </div>
            
            <!-- 标题 -->
            <h1 class="text-3xl md:text-4xl font-bold mb-4 text-90">
                {i18n(I18nKey.notFoundTitle)}
            </h1>
            
            <!-- 描述 -->
            <p class="text-lg text-75 mb-8 max-w-md">
                {i18n(I18nKey.notFoundDescription)}
            </p>
            
            <!-- 返回首页按钮 -->
            <a 
                href={url("/")}
                class="inline-flex items-center gap-2 px-6 py-3 bg-(--primary) text-white rounded-(--radius-large) hover:bg-(--btn-content) transition-colors duration-200 font-medium"
            >
                <Icon name="material-symbols:home" class="text-xl" />
                {i18n(I18nKey.backToHome)}
            </a>
            
            <!-- 装饰性元素 -->
            <div class="absolute top-4 left-4 opacity-10">
                <Icon name="material-symbols:sentiment-sad" class="text-4xl text-(--primary)" />
            </div>
            <div class="absolute bottom-4 right-4 opacity-10">
                <Icon name="material-symbols:search-off" class="text-4xl text-(--primary)" />
            </div>
        </div>
    </div>
</MainGridLayout>

<style>
    /* 添加一些动画效果 */
    .card-base {
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* 按钮悬停效果 */
    a:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
    }
</style>
</file>

<file path="pages/about.astro">
---

import { getEntry, render } from "astro:content";
import Markdown from "@components/common/Markdown.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";

const aboutPost = await getEntry("spec", "about");

if (!aboutPost) {
	throw new Error("About page content not found");
}

const { Content } = await render(aboutPost);
---
<MainGridLayout title={i18n(I18nKey.about)} description={i18n(I18nKey.about)}>
    <div class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
            <Markdown class="mt-2">
                <Content />
            </Markdown>
        </div>
    </div>
</MainGridLayout>
</file>

<file path="pages/api/calendar.json.ts">
import { getSortedPosts } from "@/utils/content-utils";

export async function GET() {
	const posts = await getSortedPosts();

	const allPostsData = posts
		.map((post) => ({
			id: post.id,
			title: post.data.title,
			published: post.data.published.getTime(),
		}))
		// 日历按纯日期排序，忽略置顶
		.sort((a, b) => b.published - a.published);

	return new Response(JSON.stringify(allPostsData));
}
</file>

<file path="pages/archive.astro">
---
import ArchivePanel from "@components/controls/ArchivePanel.svelte";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPostsList } from "@/utils/content-utils";

const sortedPostsList = await getSortedPostsList();
---

<MainGridLayout title={i18n(I18nKey.archive)}>
  <ArchivePanel sortedPosts={sortedPostsList} client:only="svelte" />
</MainGridLayout>
</file>

<file path="pages/bangumi.astro">
---
import { Icon } from "astro-icon/components";
import BangumiSection from "@/components/pages/bangumi/BangumiSection.astro";
import TabNav from "@/components/pages/bangumi/TabNav.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import type {
	UserSubjectCollection,
	UserSubjectCollectionResponse,
} from "@/types/bangumi";
import { formatDateI18nWithTime } from "@/utils/date-utils";

//参考：霞葉 https://kasuha.com/posts/fuwari-enhance-ep2/

// 检查页面是否启用
if (!siteConfig.pages.bangumi) {
	return Astro.redirect("/404/");
}

// 获取构建时间
const buildTime = formatDateI18nWithTime(new Date());

////////////// Bangumi 配置 ////////////////////////
const bangumiConfig = {
	username: siteConfig.bangumi?.userId, // 在这里配置你的Bangumi用户名
	apiUrl: "https://api.bgm.tv",
	categories: {
		book: true,
		anime: true,
		music: true,
		game: true,
		real: false,
	},
	// 数据获取设置
	pagination: {
		limit: 50, // 每页获取数量
		delay: 50, // 请求间隔毫秒数，避免频率限制
		maxTotal: 1000, // 最大获取总数，防止无限循环（0=无限制）
	},
};
//////////////////////////////////////////////////

// 分类映射
const categoryMap = {
	book: { id: "book", name: i18n(I18nKey.bangumiCategoryBook), subjectType: 1 },
	anime: {
		id: "anime",
		name: i18n(I18nKey.bangumiCategoryAnime),
		subjectType: 2,
	},
	music: {
		id: "music",
		name: i18n(I18nKey.bangumiCategoryMusic),
		subjectType: 3,
	},
	game: { id: "game", name: i18n(I18nKey.bangumiCategoryGame), subjectType: 4 },
	real: { id: "real", name: i18n(I18nKey.bangumiCategoryReal), subjectType: 6 },
};

// 获取Bangumi数据的函数 - 支持分页获取所有数据
async function fetchBangumiData(username: string, subjectType: number) {
	try {
		const { limit, delay, maxTotal } = bangumiConfig.pagination;
		let offset = 0;
		let allData: UserSubjectCollection[] = [];
		let hasMore = true;

		// 开发模式下只获取一页数据，加快调试速度
		const isDev = import.meta.env.DEV;
		const maxPages = isDev ? 1 : 0; // 0 表示不限制

		console.log(
			`[Bangumi] ${isDev ? "🔧 开发模式" : "🌐 生产模式"} - 开始获取用户 ${username} 的 subjectType ${subjectType} 数据...`,
		);

		while (hasMore) {
			// 开发模式限制：只获取一页
			if (isDev && maxPages > 0 && allData.length >= limit * maxPages) {
				console.log(`[Bangumi] 开发模式：已获取 ${maxPages} 页数据，停止获取`);
				break;
			}

			// 检查是否超过最大获取限制
			if (maxTotal > 0 && allData.length >= maxTotal) {
				console.log(`[Bangumi] 已达到最大获取限制 ${maxTotal}，停止获取`);
				break;
			}

			const url = `${bangumiConfig.apiUrl}/v0/users/${username}/collections?subject_type=${subjectType}&limit=${limit}&offset=${offset}`;

			console.log(`[Bangumi] 正在获取数据: ${url} (已获取: ${allData.length})`);

			const response = await fetch(url, {
				headers: {
					"User-Agent": "YuuOuRou Blog",
					Accept: "application/json",
				},
			});

			if (!response.ok) {
				console.warn(
					`[Bangumi] 无法获取数据 (状态码: ${response.status}):`,
					url,
				);
				break;
			}

			const data = (await response.json()) as UserSubjectCollectionResponse;
			const currentBatch = data.data || [];

			if (currentBatch.length > 0) {
				allData = allData.concat(currentBatch);
				offset += limit;

				// 如果本次获取的数据少于limit，说明已经是最后一页
				if (currentBatch.length < limit) {
					hasMore = false;
				}
			} else {
				hasMore = false;
			}

			// 添加延迟避免请求过于频繁
			if (hasMore) {
				await new Promise((resolve) => setTimeout(resolve, delay));
			}
		}

		console.log(`[Bangumi] 总共获取到 ${allData.length} 条数据`);
		return allData;
	} catch (error) {
		console.error("[Bangumi] 获取数据时出错:", error);
		return [];
	}
}

// 获取所有启用分类的数据
const bangumiData: Record<string, UserSubjectCollection[]> = {};
const tabs: Array<{ id: string; name: string; count: number }> = [];

// 检查是否已配置 Bangumi 用户ID
const isUserIdConfigured =
	bangumiConfig.username &&
	bangumiConfig.username !== "you-user-id" &&
	bangumiConfig.username.trim() !== "";

if (!isUserIdConfigured) {
	console.log("[Bangumi] ⚠️ 未配置 Bangumi 用户ID，跳过数据获取");
} else {
	console.log("[Bangumi] 🌐 从 API 获取数据");
}

for (const [categoryKey, enabled] of Object.entries(bangumiConfig.categories)) {
	// 如果未配置用户ID，跳过数据获取
	if (!isUserIdConfigured) {
		break;
	}
	if (enabled && categoryMap[categoryKey as keyof typeof categoryMap]) {
		const categoryInfo = categoryMap[categoryKey as keyof typeof categoryMap];
		try {
			const data = await fetchBangumiData(
				// biome-ignore lint/style/noNonNullAssertion: Checked by isUserIdConfigured
				bangumiConfig.username!,
				categoryInfo.subjectType,
			);
			bangumiData[categoryKey] = data;
			tabs.push({
				id: categoryKey,
				name: categoryInfo.name,
				count: data.length,
			});
		} catch (error) {
			console.error(`[Bangumi] 获取 ${categoryInfo.name} 数据失败:`, error);
			bangumiData[categoryKey] = [];
			tabs.push({
				id: categoryKey,
				name: categoryInfo.name,
				count: 0,
			});
		}
	}
}

const activeTab = tabs[0]?.id || "anime";
---

<MainGridLayout title={i18n(I18nKey.bangumi)} description={i18n(I18nKey.bangumiSubtitle)}>
  <div class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
        <!-- 页面标题 -->
        <div class="relative w-full mb-8">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70">
                        <Icon name="material-symbols:movie" class="text-[1.5rem]"></Icon>
                    </div>
                    <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
                        {i18n(I18nKey.bangumi)}
                    </h1>
                </div>
                <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed">
                    {i18n(I18nKey.bangumiSubtitle)}
                </p>
                <p class="text-xs text-neutral-500 dark:text-neutral-500 mt-2">
                    {i18n(I18nKey.bangumiLastUpdated)} {buildTime}
                </p>
            </div>

      <!-- Tab 导航和内容 -->
      {tabs.length > 0 ? (
        <>
          <TabNav tabs={tabs} activeTab={activeTab} />

          <!-- 内容区域 -->
          {tabs.map((tab) => (
                      <BangumiSection
            sectionId={tab.id}
            items={bangumiData[tab.id] || []}
            isActive={tab.id === activeTab}
            itemsPerPage={6}
          />
          ))}
        </>
      ) : (
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-(--btn-regular-bg) rounded-full mb-6 border border-(--line-divider)">
            <Icon name="material-symbols:settings" class="text-[2rem] text-(--btn-content)" />
          </div>
          <h2 class="text-xl font-semibold text-black/80 dark:text-white/80 mb-3">
            {isUserIdConfigured ? i18n(I18nKey.bangumiEmpty) : "未配置 Bangumi 用户ID"}
          </h2>
          <p class="text-black/60 dark:text-white/60 mb-4 max-w-md mx-auto">
            {isUserIdConfigured ? i18n(I18nKey.bangumiEmptyReason) : "请在 src/config/siteConfig.ts 中配置你的 Bangumi 用户ID"}
          </p>
        </div>
      )}
    </div>
  </div>
</MainGridLayout>

<style>
  /* 自定义样式 */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
</file>

<file path="pages/friends.astro">
---
import { getEntry, render } from "astro:content";
import Comment from "@components/comment/index.astro";
import Markdown from "@components/common/Markdown.astro";
import { Icon } from "astro-icon/components";
import { friendsPageConfig, getEnabledFriends } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
	throw new Error("friends page content not found");
}

const { Content } = await render(friendsPost);

// 使用配置文件中的友链数据，按权重排序
const items = getEnabledFriends();
const allTags = [...new Set(items.flatMap((item) => item.tags || []))].sort();

// 页面标题和描述
const title = i18n(I18nKey.friends);
const description = i18n(I18nKey.friendsDescription);
---

<MainGridLayout title={title} description={description}>
  <div
    class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32"
  >
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-4">
        <div class="flex items-center gap-3 mb-3">
          <div
            class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70"
          >
            <Icon name="material-symbols:group" class="text-[1.5rem]" />
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {
          description && (
            <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
              {description}
            </p>
          )
        }
		<div class="mb-8 p-4 rounded-lg bg-(--primary)/8 dark:bg-(--btn-regular-bg) border border-(--primary)/30 dark:border-none backdrop-blur-xs shadow-xs usage-info-box">
		  <div class="flex items-start gap-2">
		    <Icon name="material-symbols:info-outline" class="text-(--primary) text-lg shrink-0 mt-0.5" />
		    <p class="text-sm text-neutral-700 dark:text-neutral-200 leading-relaxed">
		  	  <span class="font-semibold text-(--primary)"></span>
			  此处的友情链接均以添加至本站的时间先后顺序排列~
		    </p>
		  </div>
	    </div>
      </div>

      <!-- 标签筛选 -->
      {
        items.length > 0 && (
          <friend-filter class="flex flex-wrap gap-2 mb-6">
            <button
              data-tag="all"
              class="btn-regular px-3 py-1.5 rounded-lg bg-(--primary) text-white hover:bg-(--primary) transition-colors duration-200 text-sm font-medium"
            >
              {i18n(I18nKey.all)}
            </button>
            {allTags.map((tag) => (
              <button
                data-tag={tag}
                class="btn-regular px-3 py-1.5 rounded-lg bg-(--btn-regular-bg) text-(--btn-content) hover:bg-(--btn-regular-bg-hover) transition-colors duration-200 text-sm font-medium"
              >
                {tag}
              </button>
            ))}
          </friend-filter>
        )
      }

      <div class={`grid grid-cols-1 sm:grid-cols-2 ${friendsPageConfig.columns === 2 ? 'lg:grid-cols-2' : 'lg:grid-cols-3'} gap-3 my-4`}>
        {
          items.map((item) => (
            <a
              href={item.siteurl}
              target="_blank"
              rel="noopener"
              data-tags={item.tags?.join(",")}
              class="friend-card group flex items-center gap-3 p-2.5 rounded-xl border border-(--line-divider) hover:border-(--primary) hover:bg-(--card-bg) transition-all duration-300 hover:shadow-lg relative overflow-hidden"
            >
              {/* 背景装饰 - 仅悬停显示 */}
              <div class="absolute inset-0 bg-(--primary) opacity-0 group-hover:opacity-5 transition-opacity duration-300 pointer-events-none" />

              {/* 头像 */}
              <div class="relative w-16 h-16 shrink-0 rounded-xl overflow-hidden bg-zinc-100 dark:bg-zinc-800 border border-black/5 dark:border-white/5 group-hover:scale-105 transition-transform duration-300">
                <img
                  src={item.imgurl}
                  alt={item.title}
                  class="w-full h-full object-cover"
                />
              </div>

              {/* 内容 */}
              <div class="grow min-w-0 flex flex-col justify-center gap-0.5">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-base text-neutral-900 dark:text-neutral-100 group-hover:text-(--primary) transition-colors truncate pr-4">
                    {item.title}
                  </div>
                  {/* 外部链接图标 */}
                  <Icon
                    name="material-symbols:arrow-outward-rounded"
                    class="text-(--primary) text-lg opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300"
                  />
                </div>

                <div
                  class="text-sm text-neutral-500 dark:text-neutral-400 line-clamp-1"
                  title={item.desc}
                >
                  {item.desc}
                </div>

                {/* 标签 */}
                <div class="flex flex-wrap gap-1 mt-1">
                  {item.tags && item.tags.length > 0
                    ? item.tags
                        .slice(0, 3)
                        .map((tag) => (
                          <span class="text-[0.65rem] px-1.5 py-0.5 rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 transition-colors duration-300">
                            {tag}
                          </span>
                        ))
                    : null}
                </div>
              </div>
            </a>
          ))
        }
      </div>
      <Markdown class="mt-2">
        <Content />
      </Markdown>
    </div>
  </div>

  <!-- 评论区 -->
  <div class="mt-4">
    <Comment post={friendsPost} customPath="/friends/" />
  </div>

  <script slot="head" is:inline>
    if (!customElements.get("friend-filter")) {
      class FriendFilter extends HTMLElement {
        constructor() {
          super();
        }

        connectedCallback() {
          this.addEventListener("click", this.handleClick);
        }

        disconnectedCallback() {
          this.removeEventListener("click", this.handleClick);
        }

        handleClick(e) {
          const target = e.target;
          const button = target.closest("button");
          if (!button) return;

          const selectedTag = button.dataset.tag;
          const filters = this.querySelectorAll("button");
          const container = this.closest(".card-base");
          if (!container) return;

          const cards = container.querySelectorAll(".friend-card");

          filters.forEach((f) => {
            f.classList.remove("bg-(--primary)", "text-white");
            f.classList.remove("hover:bg-(--primary)");
            f.classList.add(
              "bg-(--btn-regular-bg)",
              "text-(--btn-content)"
            );
            f.classList.add("hover:bg-(--btn-regular-bg-hover)");

            if (f === button) {
              f.classList.remove(
                "bg-(--btn-regular-bg)",
                "text-(--btn-content)"
              );
              f.classList.remove("hover:bg-(--btn-regular-bg-hover)");
              f.classList.add("bg-(--primary)", "text-white");
              f.classList.add("hover:bg-(--primary)");
            }
          });

          cards.forEach((card) => {
            const cardEl = card;
            const tags = (cardEl.dataset.tags || "").split(",");
            if (
              selectedTag === "all" ||
              (selectedTag && tags.includes(selectedTag))
            ) {
              cardEl.style.display = "";
              cardEl.classList.add("animate-fade-in-up");
            } else {
              cardEl.style.display = "none";
              cardEl.classList.remove("animate-fade-in-up");
            }
          });
        }
      }
      customElements.define("friend-filter", FriendFilter);
    }
  </script>
</MainGridLayout>
</file>

<file path="pages/guestbook.astro">
---
import { getEntry, render } from "astro:content";
import Comment from "@components/comment/index.astro";
import Markdown from "@components/common/Markdown.astro";
import { Icon } from "astro-icon/components";
import { commentConfig, siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";

// 检查页面是否启用
if (!siteConfig.pages.guestbook) {
	return Astro.redirect("/404/");
}

const guestbookPost = await getEntry("spec", "guestbook");

if (!guestbookPost) {
	throw new Error("guestbook page content not found");
}

const { Content } = await render(guestbookPost);

// 检查评论系统是否启用
const isCommentEnabled = commentConfig?.type && commentConfig.type !== "none";

// 页面标题和描述
const title = i18n(I18nKey.guestbook);
const description = i18n(I18nKey.guestbookDescription);
---

<MainGridLayout title={title} description={description}>
  <div
    class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32"
  >
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-3">
          <div class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70">
            <Icon name="material-symbols:chat" class="text-[1.5rem]"></Icon>
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {description && (
          <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
            {description}
          </p>
        )}
      </div>
      
      <Markdown class="mt-2">
        <Content />
      </Markdown>
    </div>
  </div>

  <!-- 评论区 -->
  <div class="mt-4">
    {isCommentEnabled ? (
      <Comment post={guestbookPost} customPath="/guestbook/" />
    ) : (
      <div class="card-base p-8 mb-6 relative overflow-hidden">
        <div class="text-center py-8 text-(--content-meta)">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-(--btn-regular-bg) flex items-center justify-center">
            <svg
              class="w-8 h-8 text-(--primary)"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
              ></path>
            </svg>
          </div>
          <p class="text-base mb-2">{i18n(I18nKey.commentNotConfigured)}</p>
          <p class="text-sm text-(--content-meta) opacity-75">
            {i18n(I18nKey.guestbookCommentHint)}
          </p>
        </div>
      </div>
    )}
  </div>
</MainGridLayout>
</file>

<file path="pages/moments.astro">
---
import { getEntry, render } from "astro:content";
import Markdown from "@components/common/Markdown.astro";
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { url } from "@/utils/url-utils";

const momentsPost = await getEntry("spec", "moments");

if (!momentsPost) {
    throw new Error("moments page content not found");
}

const { Content } = await render(momentsPost);

// 页面标题和描述
const title = i18n(I18nKey.moments);
const description = i18n(I18nKey.momentsDescription);
---

<link rel="stylesheet" href={url("/assets/css/twikoo.css")}>
<link rel="stylesheet" href={url("/assets/css/moments-twikoo.css")}>
<MainGridLayout title={title} description={description}>
    <div
            class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32"
    >
        <div class="card-base z-10 px-9 py-6 relative w-full">
            <!-- 页面标题和描述 -->
            <div class="mb-4">
                <div class="flex items-center gap-3 mb-3">
                    <div
                            class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70"
                    >
                        <Icon name="material-symbols:android-chat-outline" class="text-[1.5rem]"/>
                    </div>
                    <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
                        {title}
                    </h1>
                </div>
                {
                    description && (
                                <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
                                    {description}
                                </p>
                    )
                }
            </div>

            <Icon name="fa7-solid:comment-dots" class="hidden text-[1.1rem] mr-2"/>
            <div id="moments-container" class="mt-12">
                <style>
                    @keyframes loading-placeholder-flame {
                        0% {
                            filter: brightness(100%);
                        }
                        50% {
                            filter: brightness(92%);
                        }
                        100% {
                            filter: brightness(100%);
                        }
                    }

                    .loading-placeholder {
                        color: transparent;
                        background: linear-gradient(to right, #E5E7EB, #E5E7EB) no-repeat center center;
                        background-size: auto 1.1em;
                        border-radius: 0.3rem;
                        animation: loading-placeholder-flame 1.5s infinite;
                    }
                </style>
                {
                    [1, 2, 3].map((i) => (
                            <>
                                {i > 1 &&
                                        <hr class="my-6 border-dashed" style="border-color: var(--line-divider);">}
                                <div class="flex gap-3.5 select-none">
                                <span class="inline-block w-10 h-10 rounded-md text-transparent bg-gray-200"
                                      style="animation: loading-placeholder-flame 1.5s infinite;">Lorem.</span>
                                    <section>
                                        <p class="text-base">
                                            <span class="loading-placeholder">Horean</span>
                                        </p>
                                        <p class="text-sm">
                                            <span class="loading-placeholder">3&nbsp;个月前</span>
                                        </p>
                                        <span class="mt-2.5 loading-placeholder">Lorem ipsum dolor sit amet, consectetur adipisicing elit.
                                        Adipisci, aliquid architecto at aut beatae cumque debitis dolor dolore esse fugiat odit quas
                                        quia repellat soluta veniam, voluptates voluptatibus. Iure, reiciendis.</span>
                                    </section>
                                </div>
                            </>
                    ))
                }
            </div>

            <div id="load-more-container" class="mt-10 text-center"></div>

            <Markdown class="mt-2">
                <Content/>
            </Markdown>
        </div>
    </div>

    <script is:inline src={url("/assets/js/firefly-twikoo-1.6.44.all.min.js")}></script>
    <script>
        import {
            dayjsInit,
            getMoments,
            loadMoreMoments,
            getMomentsHTML,
            getLoadMoreBtnHTML,
        } from "@/config";
        import { commentConfig } from "@/config/commentConfig";

        interface ITwikooConfig {
            envId: string;
            lang: string;
            visitorCount: boolean;
            el: string;
            path: string;
        }

        class MomentsTwikoo extends HTMLElement {
            private readonly tname: string;
            private tel: HTMLDivElement;

            constructor() {
                super();
                this.tname = this.dataset.name ?? "";
            }

            connectedCallback() {
                this.render();
                this.initTwikoo();
            }

            initTwikoo() {
                if (typeof twikoo !== "undefined") {
                    this.tel.innerHTML = "";
                    const cfg = this.createConfig();
                    // console.log("[Twikoo] 初始化配置:", cfg);
                    twikoo.init(cfg);
                    // .then(() => {
                    // console.log("[Twikoo] 初始化完成");
                    // })
                    // .catch((error) => {
                    // console.error("[Twikoo] 初始化失败:", error);
                    // });
                } else {
                    setTimeout(this.initTwikoo.bind(this), 500);
                }
            }

            private createConfig(): ITwikooConfig {
                return {
                    ...commentConfig.twikoo,
                    visitorCount: false,
                    el: `#tcomment-${this.tname}`,
                    path: `/moments/${this.tname}/`,
                } as ITwikooConfig;
            }

            private render() {
                this.tel = document.createElement("div");
                this.tel.id = `tcomment-${this.tname}`;
                this.appendChild(this.tel);
            }
        }

        customElements.define("mm-twikoo", MomentsTwikoo);


        const momentsEventHandler = async () => {
            dayjsInit();
            const momentsContainer = document.querySelector("#moments-container") as HTMLDivElement;
            const loadMoreContainer = document.querySelector("#load-more-container") as HTMLDivElement;
            let { items, nextToken } = await getMoments();
            momentsContainer.innerHTML = getMomentsHTML(items);
            loadMoreContainer.innerHTML = getLoadMoreBtnHTML(nextToken);
            let loadMoreBtn = document.querySelector("#load-more-btn") as HTMLButtonElement;
            let currentComments: string = "";
            let previousComments: string = "";
            let loadMoreTimes = 0;

            const newMomentsThreshold = (mm: HTMLDivElement, i: number) => {
                if (i < loadMoreTimes * 10) return;
                const btn = mm.querySelector(".toggle-comments-btn") as HTMLButtonElement;
                const tname = btn.dataset.name ?? "";
                const commentsWrapper = mm.querySelector(".mm-comments-wrapper") as HTMLElement;
                btn.addEventListener("click", () => {
                    btn.classList.toggle("bg-transparent");
                    btn.classList.toggle("bg-(--btn-regular-bg-hover)");
                    let orgCommentsWrapper: HTMLElement | null = null;
                    if (currentComments !== "" && currentComments !== tname) {
                        const orgBtn = momentsContainer.querySelector(`.toggle-comments-btn[data-name='${currentComments}']`) as HTMLButtonElement;
                        orgCommentsWrapper = momentsContainer.querySelector(`.mm-comments-wrapper[data-name='${currentComments}']`) as HTMLElement;
                        orgBtn.click();
                    }
                    let mmTwikoo: MomentsTwikoo | null = mm.querySelector("mm-twikoo");
                    if (mmTwikoo === null) {
                        currentComments = tname;
                        commentsWrapper.innerHTML = `<mm-twikoo data-name="${tname}" style="display: block;
                            height: calc-size(auto, size); overflow: hidden; transition: all 0.3s;"></mm-twikoo>`;
                    } else {
                        if (mmTwikoo.style.height.includes("0")) {
                            currentComments = tname;
                            if (previousComments !== tname) {
                                mmTwikoo.initTwikoo();
                                (mmTwikoo.querySelector("span.tk-icon.__comments") as HTMLSpanElement).click();
                            }
                            mmTwikoo.style.height = "calc-size(auto, size)";
                        } else {
                            previousComments = currentComments;
                            currentComments = "";
                            mmTwikoo.style.height = "0";
                        }
                    }
                    if (orgCommentsWrapper !== null) {
                        const position = orgCommentsWrapper.compareDocumentPosition(commentsWrapper);
                        if (position & Node.DOCUMENT_POSITION_FOLLOWING) {
                            setTimeout(() => {
                                window.scrollBy(0, orgCommentsWrapper.clientHeight - commentsWrapper.clientHeight);
                            }, 300);
                        }
                    }
                });
            };

            momentsContainer.childNodes.forEach(newMomentsThreshold);

            loadMoreBtn?.addEventListener("click", async () => {
                if (nextToken === "") return;
                ++loadMoreTimes;
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = "加载中……";
                loadMoreBtn.classList.remove("hover:bg-(--btn-regular-bg-hover)");
                loadMoreBtn.classList.remove("active:bg-(--btn-regular-bg-active)");
                loadMoreBtn.classList.add("text-(--content-meta)");
                loadMoreBtn.classList.add("cursor-not-allowed");
                const { items: items1, nextToken: nextToken1 } = await loadMoreMoments(nextToken);
                momentsContainer.insertAdjacentHTML("beforeend", getMomentsHTML(items1, false));
                if (nextToken1 === "") {
                    loadMoreContainer.innerHTML = getLoadMoreBtnHTML("");
                } else {
                    nextToken = nextToken1;
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = "加载更多……";
                    loadMoreBtn.classList.add("hover:bg-(--btn-regular-bg-hover)");
                    loadMoreBtn.classList.add("active:bg-(--btn-regular-bg-active)");
                    loadMoreBtn.classList.remove("text-(--content-meta)");
                    loadMoreBtn.classList.remove("cursor-not-allowed");
                }
                momentsContainer.childNodes.forEach(newMomentsThreshold);
            });
        };

        document.addEventListener("moments:ready", () => {
            console.log("moments:ready");
            momentsEventHandler();
        });
        window.addEventListener("DOMContentLoaded", () => {
            console.log("DOMContentLoaded");
            momentsEventHandler();
        });
    </script>
</MainGridLayout>
</file>

<file path="pages/og/[...slug].png.ts">
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import * as fs from "node:fs";
import type { APIContext, GetStaticPaths } from "astro";
import satori from "satori";
import sharp from "sharp";
import { removeFileExtension } from "@/utils/url-utils";

import { profileConfig } from "../../config/profileConfig";
import { siteConfig } from "../../config/siteConfig";

type Weight = 100 | 200 | 300 | 400 | 500 | 600 | 700 | 800 | 900;

type FontStyle = "normal" | "italic";
interface FontOptions {
	data: Buffer | ArrayBuffer;
	name: string;
	weight?: Weight;
	style?: FontStyle;
	lang?: string;
}
export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () => {
	if (!siteConfig.generateOgImages) {
		return [];
	}

	const allPosts = await getCollection("posts");
	const publishedPosts = allPosts.filter((post) => !post.data.draft);

	return publishedPosts.map((post) => {
		// 将 id 转换为 slug（移除扩展名）以匹配路由参数
		const slug = removeFileExtension(post.id);
		return {
			params: { slug },
			props: { post },
		};
	});
};

let fontCache: { regular: Buffer | null; bold: Buffer | null } | null = null;

async function fetchNotoSansSCFonts() {
	if (fontCache) return fontCache;
	try {
		const cssResp = await fetch(
			"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap",
		);
		if (!cssResp.ok) throw new Error("Failed to fetch Google Fonts CSS");
		const cssText = await cssResp.text();

		const getUrlForWeight = (weight: number) => {
			const blockRe = new RegExp(
				`@font-face\\s*{[^}]*font-weight:\\s*${weight}[^}]*}`,
				"g",
			);
			const match = cssText.match(blockRe);
			if (!match || match.length === 0) return null;
			const urlMatch = match[0].match(/url\((https:[^)]+)\)/);
			return urlMatch ? urlMatch[1] : null;
		};

		const regularUrl = getUrlForWeight(400);
		const boldUrl = getUrlForWeight(700);

		if (!regularUrl || !boldUrl) {
			console.warn(
				"Could not find font urls in Google Fonts CSS; falling back to no fonts.",
			);
			fontCache = { regular: null, bold: null };
			return { regular: null, bold: null };
		}

		const [rResp, bResp] = await Promise.all([
			fetch(regularUrl),
			fetch(boldUrl),
		]);
		if (!rResp.ok || !bResp.ok) {
			console.warn(
				"Failed to download font files from Google; falling back to no fonts.",
			);
			fontCache = { regular: null, bold: null };
			return { regular: null, bold: null };
		}

		const rBuf = Buffer.from(await rResp.arrayBuffer());
		const bBuf = Buffer.from(await bResp.arrayBuffer());
		fontCache = { regular: rBuf, bold: bBuf };
		return fontCache;
	} catch (err) {
		console.warn("Error fetching fonts:", err);
		fontCache = { regular: null, bold: null };
		return { regular: null, bold: null };
	}
}

export async function GET({
	props,
}: APIContext<{ post: CollectionEntry<"posts"> }>) {
	const { post } = props;

	// Try to fetch fonts from Google Fonts (woff2) at runtime.
	const { regular: fontRegular, bold: fontBold } = await fetchNotoSansSCFonts();

	// Avatar + icon: still read from disk (small assets)
	let avatarBase64: string;

	// 检查头像是否为 URL
	if (profileConfig.avatar?.startsWith("http")) {
		// 如果是 URL，直接使用
		avatarBase64 = profileConfig.avatar;
	} else {
		// 如果是本地路径，从 public 目录读取
		const avatarPath = profileConfig.avatar?.startsWith("/")
			? `./public${profileConfig.avatar}`
			: `./src/${profileConfig.avatar}`;
		const avatarBuffer = fs.readFileSync(avatarPath);
		avatarBase64 = `data:image/png;base64,${avatarBuffer.toString("base64")}`;
	}

	let iconPath = "./public/favicon/favicon-dark-192.png";
	if (siteConfig.favicon.length > 0) {
		iconPath = `./public${siteConfig.favicon[0].src}`;
	}
	const iconBuffer = fs.readFileSync(iconPath);
	const iconBase64 = `data:image/png;base64,${iconBuffer.toString("base64")}`;

	const hue = siteConfig.themeColor.hue;
	const primaryColor = `hsl(${hue}, 90%, 65%)`;
	const textColor = "hsl(0, 0%, 95%)";

	const subtleTextColor = `hsl(${hue}, 10%, 75%)`;
	const backgroundColor = `hsl(${hue}, 15%, 12%)`;

	const pubDate = post.data.published.toLocaleDateString("en-US", {
		year: "numeric",
		month: "short",
		day: "numeric",
	});

	const description = post.data.description;

	const template = {
		type: "div",
		props: {
			style: {
				height: "100%",
				width: "100%",
				display: "flex",
				flexDirection: "column",
				backgroundColor: backgroundColor,
				fontFamily:
					'"Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
				padding: "60px",
			},
			children: [
				{
					type: "div",
					props: {
						style: {
							width: "100%",
							display: "flex",
							alignItems: "center",
							gap: "20px",
						},
						children: [
							{
								type: "img",
								props: {
									src: iconBase64,
									width: 48,
									height: 48,
									style: { borderRadius: "10px" },
								},
							},
							{
								type: "div",
								props: {
									style: {
										fontSize: "36px",
										fontWeight: 600,
										color: subtleTextColor,
									},
									children: siteConfig.title,
								},
							},
						],
					},
				},

				{
					type: "div",
					props: {
						style: {
							display: "flex",
							flexDirection: "column",
							justifyContent: "center",
							flexGrow: 1,
							gap: "20px",
						},
						children: [
							{
								type: "div",
								props: {
									style: {
										display: "flex",
										alignItems: "flex-start",
									},
									children: [
										{
											type: "div",
											props: {
												style: {
													width: "10px",
													height: "68px",
													backgroundColor: primaryColor,
													borderRadius: "6px",
													marginTop: "14px",
												},
											},
										},
										{
											type: "div",
											props: {
												style: {
													fontSize: "72px",
													fontWeight: 700,
													lineHeight: 1.2,
													color: textColor,
													marginLeft: "25px",
													display: "-webkit-box",
													overflow: "hidden",
													textOverflow: "ellipsis",
													lineClamp: 3,
													WebkitLineClamp: 3,
													WebkitBoxOrient: "vertical",
												},
												children: post.data.title,
											},
										},
									],
								},
							},
							description && {
								type: "div",
								props: {
									style: {
										fontSize: "32px",
										lineHeight: 1.5,
										color: subtleTextColor,
										paddingLeft: "35px",
										display: "-webkit-box",
										overflow: "hidden",
										textOverflow: "ellipsis",
										lineClamp: 2,
										WebkitLineClamp: 2,
										WebkitBoxOrient: "vertical",
									},
									children: description,
								},
							},
						],
					},
				},
				{
					type: "div",
					props: {
						style: {
							display: "flex",
							justifyContent: "space-between",
							alignItems: "center",
							width: "100%",
						},
						children: [
							{
								type: "div",
								props: {
									style: {
										display: "flex",
										alignItems: "center",
										gap: "20px",
									},
									children: [
										{
											type: "img",
											props: {
												src: avatarBase64,
												width: 60,
												height: 60,
												style: { borderRadius: "50%" },
											},
										},
										{
											type: "div",
											props: {
												style: {
													fontSize: "28px",
													fontWeight: 600,
													color: textColor,
												},
												children: profileConfig.name,
											},
										},
									],
								},
							},
							{
								type: "div",
								props: {
									style: { fontSize: "28px", color: subtleTextColor },
									children: pubDate,
								},
							},
						],
					},
				},
			],
		},
	};

	const fonts: FontOptions[] = [];
	if (fontRegular) {
		fonts.push({
			name: "Noto Sans SC",
			data: fontRegular,
			weight: 400,
			style: "normal",
		});
	}
	if (fontBold) {
		fonts.push({
			name: "Noto Sans SC",
			data: fontBold,
			weight: 700,
			style: "normal",
		});
	}

	const svg = await satori(template, {
		width: 1200,
		height: 630,
		fonts,
	});

	const png = await sharp(Buffer.from(svg)).png().toBuffer();

	return new Response(new Uint8Array(png), {
		headers: {
			"Content-Type": "image/png",
			"Cache-Control": "public, max-age=31536000, immutable",
		},
	});
}
</file>

<file path="pages/posts/[...slug].astro">
---
import { render } from "astro:content";
import * as path from "node:path";
import Comment from "@components/comment/index.astro";
import Markdown from "@components/common/Markdown.astro";
import KatexManager from "@components/features/KatexManager.astro";
import License from "@components/misc/License.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import {
	getFileDirFromPath,
	getPostUrlBySlug,
	removeFileExtension,
} from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import CoverImage from "@/components/common/CoverImage.astro";
import PostMetadata from "@/components/layout/PostMeta.astro";
import SharePoster from "@/components/misc/SharePoster.svelte";
import { coverImageConfig } from "@/config/coverImageConfig";
import { licenseConfig } from "@/config/licenseConfig";
import { profileConfig } from "@/config/profileConfig";
import { siteConfig } from "@/config/siteConfig";
import { sponsorConfig } from "@/config/sponsorConfig";
import { formatDateToYYYYMMDD } from "@/utils/date-utils";
import { getApiUrlList, processCoverImageSync } from "@/utils/image-utils";
import { url } from "@/utils/url-utils";

export async function getStaticPaths() {
	const blogEntries = await getSortedPosts();
	return blogEntries.map((entry) => {
		// 将 id 转换为 slug（移除扩展名）以匹配路由参数
		const slug = removeFileExtension(entry.id);
		return {
			params: { slug },
			props: { entry },
		};
	});
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

const { remarkPluginFrontmatter } = await render(entry);

const bannerPostMeta = {
	title: entry.data.title,
	published: entry.data.published,
	updated: entry.data.updated,
	words: remarkPluginFrontmatter.words,
	minutes: remarkPluginFrontmatter.minutes,
};

// 处理随机图：如果image为"api"，则从配置的API获取随机图
const processedImage = processCoverImageSync(entry.data.image, entry.id);
const apiUrls = getApiUrlList(entry.data.image, entry.id);

let posterCoverUrl = processedImage;
if (processedImage) {
	const isLocal = !(
		processedImage.startsWith("/") ||
		processedImage.startsWith("http") ||
		processedImage.startsWith("https") ||
		processedImage.startsWith("data:")
	);
	if (isLocal) {
		const basePath = getFileDirFromPath(entry.filePath || "");
		const files = import.meta.glob<ImageMetadata>("../../**", {
			import: "default",
		});
		let normalizedPath = path
			.normalize(path.join("../../", basePath, processedImage))
			.replace(/\\/g, "/");
		const file = files[normalizedPath];
		if (file) {
			const img = await file();
			posterCoverUrl = img.src;
		}
	}
}

// 处理头像URL
let posterAvatarUrl: string | null = profileConfig.avatar || null;
if (posterAvatarUrl) {
	const isLocalAvatar = !(
		posterAvatarUrl.startsWith("/") ||
		posterAvatarUrl.startsWith("http") ||
		posterAvatarUrl.startsWith("https") ||
		posterAvatarUrl.startsWith("data:")
	);
	if (isLocalAvatar) {
		const files = import.meta.glob<ImageMetadata>("../../**", {
			import: "default",
		});
		const normalizedPath = path
			.normalize(path.join("../../", posterAvatarUrl))
			.replace(/\\/g, "/");
		const file = files[normalizedPath];
		if (file) {
			const img = await file();
			posterAvatarUrl = img.src;
		}
	}
}

dayjs.extend(utc);

const jsonLd = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	headline: entry.data.title,
	description: entry.data.description || entry.data.title,
	keywords: entry.data.tags,
	author: {
		"@type": "Person",
		name: profileConfig.name,
		url: Astro.site,
	},
	datePublished: formatDateToYYYYMMDD(entry.data.published),
	inLanguage: entry.data.lang
		? entry.data.lang.replace("_", "-")
		: siteConfig.lang.replace("_", "-"),
	// TODO include cover image here
};
---

<MainGridLayout
  banner={processedImage}
  title={entry.data.title}
  description={entry.data.description}
  lang={entry.data.lang}
  setOGTypeArticle={true}
  postSlug={entry.id}
  headings={headings}
  bannerPostMeta={bannerPostMeta}
>
  <!-- KaTeX 按需加载 - 仅在文章页面 -->
  <KatexManager slot="head" />
  
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(jsonLd)}
  />
  <div
    class="flex w-full rounded-(--radius-large) overflow-hidden relative mb-4"
  >
    <div
      id="post-container"
      class:list={[
        "card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full ",
        {},
      ]}
    >
      <!-- word count and reading time -->
      <div
        class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation"
      >
        <div class="flex flex-row items-center">
          <div
            class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
          >
            <Icon name="material-symbols:notes-rounded" />
          </div>
          <div class="text-sm">
            {remarkPluginFrontmatter.words}
            {" " + i18n(I18nKey.wordsCount)}
          </div>
        </div>
        <div class="flex flex-row items-center">
          <div
            class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
          >
            <Icon name="material-symbols:schedule-outline-rounded" />
          </div>
          <div class="text-sm">
            {remarkPluginFrontmatter.minutes}
            {
              " " +
                i18n(
                  remarkPluginFrontmatter.minutes === 1
                    ? I18nKey.minuteCount
                    : I18nKey.minutesCount
                )
            }
          </div>
        </div>
      </div>

      <!-- title -->
      <div class="relative onload-animation">
        <h1
          data-pagefind-body
          data-pagefind-weight="10"
          data-pagefind-meta="title"
          class="transition w-full block font-bold mb-3
                    text-3xl md:text-[2.25rem]/[2.75rem]
                    text-black/90 dark:text-white/90
                    md:before:w-1 before:h-5 before:rounded-md before:bg-(--primary)
                    before:absolute before:top-3 before:-left-4.5"
        >
          {entry.data.title}
        </h1>
      </div>

      <!-- metadata -->
      <div class="onload-animation">
        <PostMetadata
          className="mb-5"
          published={entry.data.published}
          updated={entry.data.updated}
          tags={entry.data.tags}
          category={entry.data.category || undefined}
          id={entry.id}
        />
        {
          !processedImage && (
            <div class="border-(--line-divider) border-dashed border-b mt-3 mb-5" />
          )
        }
      </div>

      <!-- always show cover as long as it has one -->

      {
        processedImage && coverImageConfig.enableInPost && (
          <div style="margin-top:1rem;">
            <CoverImage
              id="post-cover"
              src={processedImage}
              basePath={getFileDirFromPath(entry.filePath || '')}
              class="mb-8 rounded-xl banner-container onload-animation"
              preview={false}
              apiUrls={apiUrls}
            />
          </div>
        )
      }

      <Markdown class="mb-6 markdown-content onload-animation">
        <Content />
      </Markdown>

      {/* 赞助按钮 & 分享按钮 */}
      {
        (siteConfig.sharePoster || (sponsorConfig.showButtonInPost && siteConfig.pages.sponsor)) && (
          <div class="mb-6 rounded-xl onload-animation">
            <div class="p-6 bg-(--license-block-bg) rounded-xl">
              <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3 flex-1">
                  <div class="h-12 w-12 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70 shrink-0">
                    <Icon
                      name={sponsorConfig.showButtonInPost &&
                      siteConfig.pages.sponsor
                        ? "material-symbols:favorite"
                        : "material-symbols:share"}
                      class="text-2xl"
                    />
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-1">
                      {
                        sponsorConfig.showButtonInPost && siteConfig.pages.sponsor
                          ? i18n(I18nKey.sponsorButton)
                          : i18n(I18nKey.shareOnSocial)
                      }
                    </h3>
                    <p class="text-sm text-neutral-600 dark:text-neutral-400">
                      {
                        sponsorConfig.showButtonInPost && siteConfig.pages.sponsor
                          ? i18n(I18nKey.sponsorButtonText)
                          : i18n(I18nKey.shareOnSocialDescription)
                      }
                    </p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  {
                    siteConfig.sharePoster && (
                      <SharePoster
                        client:load
                        title={entry.data.title}
                        author={profileConfig.name}
                        description={entry.data.description || entry.data.title}
                        pubDate={formatDateToYYYYMMDD(entry.data.published)}
                        coverImage={posterCoverUrl}
                        url={Astro.url.href}
                        siteTitle={siteConfig.title}
                        avatar={posterAvatarUrl}
                      />
                    )
                  }
                  {
                    sponsorConfig.showButtonInPost && siteConfig.pages.sponsor && (
                      <a
                        href={url("/sponsor/")}
                        class="inline-flex items-center gap-2 px-6 py-3 bg-(--primary) text-white dark:text-black/70 rounded-lg font-medium hover:bg-(--primary)/80 hover:scale-105 active:scale-95 transition-all whitespace-nowrap"
                      >
                        <span>{i18n(I18nKey.sponsor)}</span>
                        <Icon name="fa7-solid:arrow-right" class="text-sm" />
                      </a>
                    )
                  }
                </div>
              </div>
            </div>
          </div>
        )
      }

      {
        licenseConfig.enable && (
          <License
            title={entry.data.title}
            id={entry.id}
            pubDate={entry.data.published}
            author={entry.data.author}
            sourceLink={entry.data.sourceLink}
            licenseName={entry.data.licenseName}
            licenseUrl={entry.data.licenseUrl}
            class="mb-6 rounded-xl license-container onload-animation"
          />
        )
      }
    </div>
  </div>

  <!-- 上次编辑时间 -->
  {
    siteConfig.showLastModified && (() => {
      const lastModified = dayjs(
        entry.data.updated || entry.data.published
      );
      const now = dayjs();
      const daysDiff = now.diff(lastModified, "day");
      // 使用用户定义的阈值，如果没有定义则默认为1天
      const outdatedThreshold = siteConfig.outdatedThreshold ?? 1;
      const shouldShowOutdatedCard = daysDiff >= outdatedThreshold;

      return shouldShowOutdatedCard ? (
        <div class="card-base p-6 mb-4">
          <div class="flex items-center gap-2">
            <div class="transition h-9 w-9 rounded-lg overflow-hidden relative flex items-center justify-center mr-0">
              <Icon
                name="material-symbols:history-rounded"
                class="text-4xl text-(--primary) transition-transform group-hover:translate-x-0.5 bg-(--enter-btn-bg) p-2 rounded-md"
              />
            </div>

            {(() => {
              const dateStr = lastModified.format("YYYY-MM-DD");
              const isOutdated = daysDiff >= 1;

              return (
                <div class="flex flex-col gap-0.1">
                  <div class="text-[1.0rem] leading-tight text-black/75 dark:text-white/75">
                    {`${i18n(I18nKey.lastModifiedPrefix)}${dateStr}${
                      isOutdated
                        ? `，${i18n(I18nKey.lastModifiedDaysAgo).replace("{days}", daysDiff.toString())}`
                        : ""
                    }`}
                  </div>
                  {isOutdated && (
                    <p class="text-[0.8rem] leading-tight text-black/75 dark:text-white/75">
                      {i18n(I18nKey.lastModifiedOutdated)}
                    </p>
                  )}
                </div>
              );
            })()}
          </div>
        </div>
      ) : null;
    })()
  }

  <div
    class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full"
  >
    <a
      href={entry.data.nextSlug ? getPostUrlBySlug(entry.data.nextSlug) : "#"}
      class:list={[
        "w-full font-bold overflow-hidden active:scale-95",
        { "pointer-events-none": !entry.data.nextSlug },
      ]}
    >
      {
        entry.data.nextSlug && (
          <div class="btn-card rounded-2xl w-full h-15 max-w-full px-4 flex items-center justify-start! gap-4">
            <Icon
              name="material-symbols:chevron-left-rounded"
              class="text-[2rem] text-(--primary)"
            />
            <div class="overflow-hidden transition text-ellipsis whitespace-nowrap max-w-[calc(100%-3rem)] text-black/75 dark:text-white/75">
              {entry.data.nextTitle}
            </div>
          </div>
        )
      }
    </a>

    <a
      href={entry.data.prevSlug ? getPostUrlBySlug(entry.data.prevSlug) : "#"}
      class:list={[
        "w-full font-bold overflow-hidden active:scale-95",
        { "pointer-events-none": !entry.data.prevSlug },
      ]}
    >
      {
        entry.data.prevSlug && (
          <div class="btn-card rounded-2xl w-full h-15 max-w-full px-4 flex items-center justify-end! gap-4">
            <div class="overflow-hidden transition text-ellipsis whitespace-nowrap max-w-[calc(100%-3rem)] text-black/75 dark:text-white/75">
              {entry.data.prevTitle}
            </div>
            <Icon
              name="material-symbols:chevron-right-rounded"
              class="text-[2rem] text-(--primary)"
            />
          </div>
        )
      }
    </a>
  </div>

  <!-- 评论 -->
  {entry.data.comment && <Comment post={entry} />}
</MainGridLayout>
</file>

<file path="pages/robots.txt.ts">
import type { APIRoute } from "astro";

const robotsTxt = `
User-agent: *
Disallow: /_astro/

Sitemap: ${new URL("sitemap-index.xml", import.meta.env.SITE).href}
`.trim();

export const GET: APIRoute = () => {
	return new Response(robotsTxt, {
		headers: {
			"Content-Type": "text/plain; charset=utf-8",
		},
	});
};
</file>

<file path="pages/rss.astro">
---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import { formatDateToYYYYMMDD } from "@utils/date-utils";
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

const posts = await getSortedPosts();
const recentPosts = posts.slice(0, 6);
---

<MainGridLayout title={i18n(I18nKey.rss)} description={i18n(I18nKey.rssDescription)}>
    <div class="onload-animation">
        <!-- RSS 标题和介绍 -->
        <div class="card-base rounded-(--radius-large) p-8 mb-6">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-(--primary) rounded-2xl mb-4">
                    <Icon name="material-symbols:rss-feed" class="text-white text-3xl" />
                </div>
                <h1 class="text-3xl font-bold text-(--primary) mb-3">{i18n(I18nKey.rss)}</h1>
                <p class="text-75 max-w-2xl mx-auto">
                    {i18n(I18nKey.rssSubtitle)}
                </p>
            </div>
        </div>

        <!-- RSS 链接复制区域 -->
        <div class="card-base rounded-(--radius-large) p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-(--primary) rounded-xl flex items-center justify-center mr-4">
                        <Icon name="material-symbols:link" class="text-white text-xl" />
                    </div>
                    <div>
                        <h3 class="font-semibold text-90 mb-1">{i18n(I18nKey.rssLink)}</h3>
                        <p class="text-sm text-75">{i18n(I18nKey.rssCopyToReader)}</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <code class="bg-(--card-bg) px-3 py-2 rounded-lg text-sm font-mono text-75 border border-(--line-divider) break-all">
                        {Astro.site}rss.xml
                    </code>
                    <button 
                        id="copy-rss-btn"
                        class="px-4 py-2 bg-(--primary) text-white rounded-lg hover:opacity-80 transition-all duration-200 font-medium text-sm whitespace-nowrap"
                        data-url={`${Astro.site}rss.xml`}
                        data-copied-text={i18n(I18nKey.rssCopied)}
                        data-failed-text={i18n(I18nKey.rssCopyFailed)}
                    >
                        {i18n(I18nKey.rssCopyLink)}
                    </button>
                </div>
            </div>
        </div>

        <!-- 最新文章预览 -->
        <div class="card-base rounded-(--radius-large) p-6 mb-6">
            <h2 class="text-xl font-bold text-90 mb-4 flex items-center">
                <Icon name="material-symbols:article" class="mr-2 text-(--primary)" />
                {i18n(I18nKey.rssLatestPosts)}
            </h2>
            <div class="space-y-4">
                {recentPosts.map((post) => (
                    <article class="bg-(--card-bg) rounded-xl p-4 border border-(--line-divider) hover:border-(--primary) transition-all duration-300">
                        <h3 class="text-lg font-semibold text-90 mb-2 hover:text-(--primary) transition-colors">
                            <a href={`/posts/${post.id}/`} class="hover:underline">
                                {post.data.title}
                            </a>
                        </h3>
                        {post.data.description && (
                            <p class="text-75 mb-3 line-clamp-2">
                                {post.data.description}
                            </p>
                        )}
                        <div class="flex items-center gap-4 text-sm text-60">
                            <time datetime={post.data.published.toISOString()} class="text-75">
                                {formatDateToYYYYMMDD(post.data.published)}
                            </time>
                        </div>
                    </article>
                ))}
            </div>
        </div>

        <!-- RSS 说明 -->
        <div class="card-base rounded-(--radius-large) p-6">
            <h2 class="text-xl font-bold text-90 mb-4 flex items-center">
                <Icon name="material-symbols:help-outline" class="mr-2 text-(--primary)" />
                {i18n(I18nKey.rssWhatIsRSS)}
            </h2>
            <div class="text-75 space-y-3">
                <p>
                    {i18n(I18nKey.rssWhatIsRSSDescription)}
                </p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>{i18n(I18nKey.rssBenefit1)}</li>
                    <li>{i18n(I18nKey.rssBenefit2)}</li>
                    <li>{i18n(I18nKey.rssBenefit3)}</li>
                    <li>{i18n(I18nKey.rssBenefit4)}</li>
                </ul>
                <p class="text-sm">
                    {i18n(I18nKey.rssHowToUse)}
                </p>
            </div>
        </div>
    </div>

    <script>
        function initRssCopy() {
            const copyBtn = document.getElementById('copy-rss-btn');
            if (!copyBtn) return;
            
            // 移除旧的事件监听器（通过克隆节点的方式）
            const newBtn = copyBtn.cloneNode(true);
            copyBtn.parentNode?.replaceChild(newBtn, copyBtn);
            
            // 绑定新的事件监听器
            newBtn.addEventListener('click', async function() {
                const url = this.getAttribute('data-url');
                if (!url) return;
                try {
                    await navigator.clipboard.writeText(url);
                    const originalText = this.textContent;
                    this.textContent = this.getAttribute('data-copied-text') || '';
                    this.style.backgroundColor = 'var(--success-color, #10b981)';
                    
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.style.backgroundColor = '';
                    }, 2000);
                } catch (err) {
                    console.error('复制失败:', err);
                    const originalText = this.textContent;
                    this.textContent = this.getAttribute('data-failed-text') || '';
                    setTimeout(() => {
                        this.textContent = originalText;
                    }, 2000);
                }
            });
        }
        
        // 立即初始化（支持直接访问页面和刷新）
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initRssCopy);
        } else {
            // DOM 已加载，直接初始化
            setTimeout(initRssCopy, 0);
        }
        
        // 支持 Swup 客户端路由（如果存在）
        if (typeof window !== 'undefined' && (window as any).swup) {
            (window as any).swup.hooks.on('content:replace', () => {
                // 延迟执行以确保 DOM 已更新
                setTimeout(initRssCopy, 100);
            });
        }
    </script>
</MainGridLayout>
</file>

<file path="pages/rss.xml.ts">
import { loadRenderers } from "astro:container";
import { render } from "astro:content";
import { getContainerRenderer as getMDXRenderer } from "@astrojs/mdx";
import rss, { type RSSFeedItem } from "@astrojs/rss";
import { getSortedPosts } from "@utils/content-utils";
import { formatDateI18nWithTime } from "@utils/date-utils";
import { url } from "@utils/url-utils";
import type { APIContext } from "astro";
import { experimental_AstroContainer as AstroContainer } from "astro/container";
import sanitizeHtml from "sanitize-html";
import { siteConfig } from "@/config";
import pkg from "../../package.json";

function stripInvalidXmlChars(str: string): string {
	return str.replace(
		// biome-ignore lint/suspicious/noControlCharactersInRegex: https://www.w3.org/TR/xml/#charsets
		/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F\uFDD0-\uFDEF\uFFFE\uFFFF]/g,
		"",
	);
}

export async function GET(context: APIContext) {
	const blog = await getSortedPosts();
	const renderers = await loadRenderers([getMDXRenderer()]);
	const container = await AstroContainer.create({ renderers });
	const feedItems: RSSFeedItem[] = [];
	for (const post of blog) {
		const { Content } = await render(post);
		const rawContent = await container.renderToString(Content);
		const cleanedContent = stripInvalidXmlChars(rawContent);
		feedItems.push({
			title: post.data.title,
			pubDate: post.data.published,
			description: post.data.description || "",
			link: url(`/posts/${post.id}/`),
			content: sanitizeHtml(cleanedContent, {
				allowedTags: sanitizeHtml.defaults.allowedTags.concat(["img"]),
			}),
		});
	}
	return rss({
		title: siteConfig.title,
		description: siteConfig.subtitle || "No description",
		site: context.site ?? "https://fuwari.vercel.app",
		customData: `<templateTheme>Firefly</templateTheme>
		<templateThemeVersion>${pkg.version}</templateThemeVersion>
		<templateThemeUrl>https://github.com/CuteLeaf/Firefly</templateThemeUrl>
		<lastBuildDate>${formatDateI18nWithTime(new Date())}</lastBuildDate>`,
		items: feedItems,
	});
}
</file>

<file path="pages/search.astro">
---
import AdvancedSearch from "@components/pages/AdvancedSearch.svelte";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { url } from "@/utils/url-utils";

const title = i18n(I18nKey.search);
const description = "";
---

<MainGridLayout title={title} description={description}>
    <div class="min-h-[80vh]">
        <AdvancedSearch client:load title={title} description={description} />
    </div>
</MainGridLayout>

{import.meta.env.PROD && (
<script is:inline define:vars={{ scriptUrl: url('/pagefind/pagefind.js') }}>
    if (!window.pagefind) {
        async function loadPagefind() {
            const url = scriptUrl.replace(/\/$/, "")
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.status !== 200) {
                    return;
                }
                const pagefind = await import(scriptUrl);
                await pagefind.options({
                    "excerptLength": 20
                });
                window.pagefind = pagefind;
                window.dispatchEvent(new Event('pagefindready'));
            } catch (error) {
                console.warn("Pagefind script not found or failed to load.");
                window.dispatchEvent(new Event('pagefindloaderror'));
            }
        }
        loadPagefind();
    }
</script>
)}
</file>

<file path="pages/sponsor.astro">
---
import { Icon } from "astro-icon/components";
import { siteConfig, sponsorConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { url } from "@/utils/url-utils";

// 检查页面是否启用
if (!siteConfig.pages.sponsor) {
	return Astro.redirect("/404/");
}

const title = sponsorConfig.title || i18n(I18nKey.sponsorTitle);
const description =
	sponsorConfig.description || i18n(I18nKey.sponsorDescription);
const enabledMethods = sponsorConfig.methods.filter((method) => method.enabled);
const sponsors = sponsorConfig.sponsors || [];
const showSponsorsList = sponsorConfig.showSponsorsList !== false;
---

<MainGridLayout title={title} description={description}>
  <div class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-3">
            <div class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70">
                <Icon name="material-symbols:favorite" class="text-[1.5rem]"></Icon>
            </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {description && (
          <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
            {description}
          </p>
        )}
        {sponsorConfig.usage && (
          <div class="mb-8 p-4 rounded-lg bg-(--primary)/8 dark:bg-(--btn-regular-bg) border border-(--primary)/30 dark:border-none backdrop-blur-xs shadow-xs usage-info-box">
            <div class="flex items-start gap-2">
              <Icon name="material-symbols:info-outline" class="text-(--primary) text-lg shrink-0 mt-0.5" />
              <p class="text-sm text-neutral-700 dark:text-neutral-200 leading-relaxed">
                <span class="font-semibold text-(--primary)"></span>
                {sponsorConfig.usage}
              </p>
            </div>
          </div>
        )}
      </div>

      <!-- 赞助方式 -->
      <div class="mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    {enabledMethods.map((method) => (
                      <div class="flex flex-col items-center p-6 rounded-lg bg-neutral-50 dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 hover:border-(--primary) transition-colors">
                        <!-- 图标和名称 -->
                        <div class="flex items-center gap-3 mb-4">
                          {method.icon && (
                            <Icon name={method.icon} class="text-2xl text-neutral-900 dark:text-neutral-100 transition-colors" />
                          )}
                          <h3 class="text-xl font-semibold text-neutral-900 dark:text-neutral-100">
                            {method.name}
                          </h3>
                        </div>
          
                        <!-- 描述 -->
                        {method.description && (
                          <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-4 text-center">
                            {method.description}
                          </p>
                        )}
          
                        <!-- 二维码或链接 -->
                        {method.qrCode && (
                          <div class="relative w-full max-w-[200px] aspect-square bg-white rounded-lg p-4 shadow-md mb-4">
                            <img
                              src={url(method.qrCode)}
                              alt={`${method.name} ${i18n(I18nKey.scanToSponsor)}`}
                              class="w-full h-full object-contain"
                              loading="lazy"
                            />
                          </div>
                        )}
                        
                        {method.link && (
                          <a
                            href={method.link}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="inline-flex items-center gap-2 px-4 py-2 bg-(--primary) text-white dark:text-black/70 rounded-lg font-medium hover:bg-(--primary)/90 active:scale-95 transition-all"
                          >
                            <span>{i18n(I18nKey.sponsorGoTo)}</span>
                            <Icon name="fa7-solid:arrow-up-right-from-square" class="text-sm" />
                          </a>
                        )}
                      </div>
                    ))}
        </div>
      </div>


      <!-- 赞助者列表 -->
      {showSponsorsList && (
        <div>
          <div class="flex items-center gap-3 mb-6">
            <Icon name="material-symbols:emoji-people-rounded" class="text-xl text-(--primary)" />
            <h2 class="text-2xl font-bold text-neutral-900 dark:text-neutral-100">
              {i18n(I18nKey.sponsorList)}
            </h2>
          </div>
          {sponsors.length > 0 ? (
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {sponsors.map((sponsor) => (
                <div class="relative p-5 rounded-lg bg-neutral-50 dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 hover:border-(--primary) transition-all duration-200 hover:shadow-md">
                  <!-- 内容 -->
                  <div class="flex flex-col h-full">
                    <!-- 头部：姓名和金额 -->
                    <div class="flex items-center justify-between mb-3">
                      <span class="font-semibold text-lg text-neutral-900 dark:text-neutral-100">
                        {sponsor.name}
                      </span>
                      {sponsor.amount && (
                        <span class="inline-flex items-center px-3 py-1 text-sm font-bold text-(--primary) bg-(--primary)/10 dark:bg-(--primary)/20 rounded-full">
                          {sponsor.amount}
                        </span>
                      )}
                    </div>

                    <!-- 留言 -->
                    {sponsor.message && (
                      <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3 leading-relaxed flex-1">
                        {sponsor.message}
                      </p>
                    )}

                    <!-- 底部：日期 -->
                    {sponsor.date && (
                      <div class="flex items-center gap-1.5 mt-auto pt-3 border-t border-neutral-200 dark:border-neutral-800">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-4 h-4 text-neutral-400 dark:text-neutral-500"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                          />
                        </svg>
                        <span class="text-xs text-neutral-500 dark:text-neutral-500">
                          {new Date(sponsor.date).toLocaleDateString()}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-12 text-neutral-500 dark:text-neutral-500">
              <p>{i18n(I18nKey.sponsorEmpty)}</p>
            </div>
          )}
        </div>
      )}
    </div>
  </div>
</MainGridLayout>

<style>
  /* 透明模式下使用半透明背景 */
  :global(body.wallpaper-transparent .usage-info-box) {
    background-color: rgba(var(--primary-rgb, 70, 130, 180), 0.15) !important;
  }
  
  :global(:root.dark body.wallpaper-transparent .usage-info-box) {
    background-color: oklch(from var(--primary) l c h / 0.15) !important;
  }
</style>
</file>

<file path="plugins/mermaid-render-script.js">
(() => {
	// 单例模式：检查是否已经初始化过
	if (window.mermaidInitialized) {
		return;
	}

	window.mermaidInitialized = true;

	// 记录当前主题状态，避免不必要的重新渲染
	let currentTheme = null;
	let isRendering = false; // 防止并发渲染
	let retryCount = 0;
	const MAX_RETRIES = 3;
	const RETRY_DELAY = 1000; // 1秒

	// 检查主题是否真的发生了变化
	function hasThemeChanged() {
		const isDark = document.documentElement.classList.contains("dark");
		const newTheme = isDark ? "dark" : "default";

		if (currentTheme !== newTheme) {
			currentTheme = newTheme;
			return true;
		}
		return false;
	}

	// 等待 Mermaid 库加载完成
	function waitForMermaid(timeout = 10000) {
		return new Promise((resolve, reject) => {
			const startTime = Date.now();

			function check() {
				if (window.mermaid && typeof window.mermaid.initialize === "function") {
					resolve(window.mermaid);
				} else if (Date.now() - startTime > timeout) {
					reject(new Error("Mermaid library failed to load within timeout"));
				} else {
					setTimeout(check, 100);
				}
			}

			check();
		});
	}

	// 设置 MutationObserver 监听 html 元素的 class 属性变化
	function setupMutationObserver() {
		const observer = new MutationObserver((mutations) => {
			mutations.forEach((mutation) => {
				if (
					mutation.type === "attributes" &&
					mutation.attributeName === "class"
				) {
					// 检查是否是 dark 类的变化
					const target = mutation.target;
					const wasDark = mutation.oldValue
						? mutation.oldValue.includes("dark")
						: false;
					const isDark = target.classList.contains("dark");

					if (wasDark !== isDark) {
						if (hasThemeChanged()) {
							// 延迟渲染，避免主题切换时的闪烁
							setTimeout(() => renderMermaidDiagrams(), 150);
						}
					}
				}
			});
		});

		// 开始观察 html 元素的 class 属性变化
		observer.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ["class"],
			attributeOldValue: true,
		});
	}

	// 设置其他事件监听器
	function setupEventListeners() {
		// 监听页面切换
		document.addEventListener("astro:page-load", () => {
			// 重新初始化主题状态
			currentTheme = null;
			retryCount = 0; // 重置重试计数
			if (hasThemeChanged()) {
				setTimeout(() => renderMermaidDiagrams(), 100);
			}
		});

		// 监听页面可见性变化，页面重新可见时重新渲染
		document.addEventListener("visibilitychange", () => {
			if (!document.hidden) {
				setTimeout(() => renderMermaidDiagrams(), 200);
			}
		});
	}

	async function initializeMermaid() {
		try {
			await waitForMermaid();

			// 初始化 Mermaid 配置
			window.mermaid.initialize({
				startOnLoad: false,
				theme: "default",
				themeVariables: {
					fontFamily: "inherit",
					fontSize: "16px",
				},
				securityLevel: "loose",
				// 添加错误处理配置
				errorLevel: "warn",
				logLevel: "error",
			});

			// 渲染所有 Mermaid 图表
			await renderMermaidDiagrams();
		} catch (error) {
			console.error("Failed to initialize Mermaid:", error);
			// 如果初始化失败，尝试重新加载
			if (retryCount < MAX_RETRIES) {
				retryCount++;
				setTimeout(() => initializeMermaid(), RETRY_DELAY * retryCount);
			}
		}
	}

	async function renderMermaidDiagrams() {
		// 防止并发渲染
		if (isRendering) {
			return;
		}

		// 检查 Mermaid 是否可用
		if (!window.mermaid || typeof window.mermaid.render !== "function") {
			console.warn("Mermaid not available, skipping render");
			return;
		}

		isRendering = true;

		try {
			const mermaidElements = document.querySelectorAll(
				".mermaid[data-mermaid-code]",
			);

			if (mermaidElements.length === 0) {
				isRendering = false;
				return;
			}

			// 延迟检测主题，确保 DOM 已经更新
			await new Promise((resolve) => setTimeout(resolve, 100));

			const htmlElement = document.documentElement;
			const isDark = htmlElement.classList.contains("dark");
			const theme = isDark ? "dark" : "default";

			// 更新 Mermaid 主题（只需要更新一次）
			window.mermaid.initialize({
				startOnLoad: false,
				theme: theme,
				themeVariables: {
					fontFamily: "inherit",
					fontSize: "16px",
					// 强制应用主题变量
					primaryColor: isDark ? "#ffffff" : "#000000",
					primaryTextColor: isDark ? "#ffffff" : "#000000",
					primaryBorderColor: isDark ? "#ffffff" : "#000000",
					lineColor: isDark ? "#ffffff" : "#000000",
					secondaryColor: isDark ? "#333333" : "#f0f0f0",
					tertiaryColor: isDark ? "#555555" : "#e0e0e0",
				},
				securityLevel: "loose",
				errorLevel: "warn",
				logLevel: "error",
			});

			// 批量渲染所有图表，添加重试机制
			const renderPromises = Array.from(mermaidElements).map(
				async (element, index) => {
					let attempts = 0;
					const maxAttempts = 3;

					while (attempts < maxAttempts) {
						try {
							const code = element.getAttribute("data-mermaid-code");

							if (!code) {
								break;
							}

							// 显示加载状态
							element.innerHTML =
								'<div class="mermaid-loading">Rendering diagram...</div>';

							// 渲染图表
							const { svg } = await window.mermaid.render(
								`mermaid-${Date.now()}-${index}-${attempts}`,
								code,
							);

							element.innerHTML = svg;

							// 添加响应式支持
							const svgElement = element.querySelector("svg");
							if (svgElement) {
								svgElement.setAttribute("width", "100%");
								svgElement.removeAttribute("height");
								svgElement.style.maxWidth = "100%";
								svgElement.style.height = "auto";

								// 强制应用样式
								if (isDark) {
									svgElement.style.filter = "brightness(0.9) contrast(1.1)";
								} else {
									svgElement.style.filter = "none";
								}
							}

							// 渲染成功，跳出重试循环
							break;
						} catch (error) {
							attempts++;
							console.warn(
								`Mermaid rendering attempt ${attempts} failed for element ${index}:`,
								error,
							);

							if (attempts >= maxAttempts) {
								console.error(
									`Failed to render Mermaid diagram after ${maxAttempts} attempts:`,
									error,
								);
								element.innerHTML = `
									<div class="mermaid-error">
										<p>Failed to render diagram after ${maxAttempts} attempts.</p>
										<button onclick="location.reload()" style="margin-top: 8px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
											Retry Page
										</button>
									</div>
								`;
							} else {
								// 等待一段时间后重试
								await new Promise((resolve) =>
									setTimeout(resolve, 500 * attempts),
								);
							}
						}
					}
				},
			);

			// 等待所有渲染完成
			await Promise.all(renderPromises);
			retryCount = 0; // 重置重试计数
		} catch (error) {
			console.error("Error in renderMermaidDiagrams:", error);

			// 如果渲染失败，尝试重新渲染
			if (retryCount < MAX_RETRIES) {
				retryCount++;
				setTimeout(() => renderMermaidDiagrams(), RETRY_DELAY * retryCount);
			}
		} finally {
			isRendering = false;
		}
	}

	// 初始化主题状态
	function initializeThemeState() {
		const isDark = document.documentElement.classList.contains("dark");
		currentTheme = isDark ? "dark" : "default";
	}

	// 加载 Mermaid 库
	async function loadMermaid() {
		if (typeof window.mermaid !== "undefined") {
			return Promise.resolve();
		}

		return new Promise((resolve, reject) => {
			const script = document.createElement("script");
			script.src =
				"https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js";

			script.onload = () => {
				console.log("Mermaid library loaded successfully");
				resolve();
			};

			script.onerror = (error) => {
				console.error("Failed to load Mermaid library:", error);
				// 尝试备用 CDN
				const fallbackScript = document.createElement("script");
				fallbackScript.src = "https://unpkg.com/mermaid@11/dist/mermaid.min.js";

				fallbackScript.onload = () => {
					console.log("Mermaid library loaded from fallback CDN");
					resolve();
				};

				fallbackScript.onerror = () => {
					reject(
						new Error(
							"Failed to load Mermaid from both primary and fallback CDNs",
						),
					);
				};

				document.head.appendChild(fallbackScript);
			};

			document.head.appendChild(script);
		});
	}

	// 主初始化函数
	async function initialize() {
		try {
			// 设置监听器
			setupMutationObserver();
			setupEventListeners();

			// 初始化主题状态
			initializeThemeState();

			// 加载并初始化 Mermaid
			await loadMermaid();
			await initializeMermaid();
		} catch (error) {
			console.error("Failed to initialize Mermaid system:", error);
		}
	}

	// 启动初始化
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initialize);
	} else {
		initialize();
	}
})();
</file>

<file path="plugins/rehype-component-github-card.mjs">
/// <reference types="mdast" />
import { h } from "hastscript";

/**
 * Creates a GitHub Card component.
 *
 * @param {Object} properties - The properties of the component.
 * @param {string} properties.repo - The GitHub repository in the format "owner/repo".
 * @param {import('mdast').RootContent[]} children - The children elements of the component.
 * @returns {import('mdast').Parent} The created GitHub Card component.
 */
export function GithubCardComponent(properties, children) {
	if (Array.isArray(children) && children.length !== 0)
		return h("div", { class: "hidden" }, [
			'Invalid directive. ("github" directive must be leaf type "::github{repo="owner/repo"}")',
		]);

	if (!properties.repo || !properties.repo.includes("/"))
		return h(
			"div",
			{ class: "hidden" },
			'Invalid repository. ("repo" attributte must be in the format "owner/repo")',
		);

	const repo = properties.repo;
	const cardUuid = `GC${Math.random().toString(36).slice(-6)}`; // Collisions are not important

	const nAvatar = h(`div#${cardUuid}-avatar`, { class: "gc-avatar" });
	const nLanguage = h(
		`span#${cardUuid}-language`,
		{ class: "gc-language" },
		"Waiting...",
	);

	const nTitle = h("div", { class: "gc-titlebar" }, [
		h("div", { class: "gc-titlebar-left" }, [
			h("div", { class: "gc-owner" }, [
				nAvatar,
				h("div", { class: "gc-user" }, repo.split("/")[0]),
			]),
			h("div", { class: "gc-divider" }, "/"),
			h("div", { class: "gc-repo" }, repo.split("/")[1]),
		]),
		h("div", { class: "github-logo" }),
	]);

	const nDescription = h(
		`div#${cardUuid}-description`,
		{ class: "gc-description" },
		"Waiting for api.github.com...",
	);

	const nStars = h(`div#${cardUuid}-stars`, { class: "gc-stars" }, "00K");
	const nForks = h(`div#${cardUuid}-forks`, { class: "gc-forks" }, "0K");
	const nLicense = h(`div#${cardUuid}-license`, { class: "gc-license" }, "0K");

	const nScript = h(
		`script#${cardUuid}-script`,
		{ type: "text/javascript", defer: true },
		`
      fetch('https://api.github.com/repos/${repo}', { referrerPolicy: "no-referrer" }).then(response => response.json()).then(data => {
        document.getElementById('${cardUuid}-description').innerText = data.description?.replace(/:[a-zA-Z0-9_]+:/g, '') || "Description not set";
        document.getElementById('${cardUuid}-language').innerText = data.language;
        document.getElementById('${cardUuid}-forks').innerText = Intl.NumberFormat('en-us', { notation: "compact", maximumFractionDigits: 1 }).format(data.forks).replaceAll("\u202f", '');
        document.getElementById('${cardUuid}-stars').innerText = Intl.NumberFormat('en-us', { notation: "compact", maximumFractionDigits: 1 }).format(data.stargazers_count).replaceAll("\u202f", '');
        const avatarEl = document.getElementById('${cardUuid}-avatar');
        avatarEl.style.backgroundImage = 'url(' + data.owner.avatar_url + '&s=32' + ')';
        avatarEl.style.backgroundColor = 'transparent';
        document.getElementById('${cardUuid}-license').innerText = data.license?.spdx_id || "no-license";
        document.getElementById('${cardUuid}-card').classList.remove("fetch-waiting");
        console.log("[GITHUB-CARD] Loaded card for ${repo} | ${cardUuid}.")
      }).catch(err => {
        const c = document.getElementById('${cardUuid}-card');
        c?.classList.add("fetch-error");
        console.warn("[GITHUB-CARD] (Error) Loading card for ${repo} | ${cardUuid}.")
      })
    `,
	);

	return h(
		`a#${cardUuid}-card`,
		{
			class: "card-github fetch-waiting no-styling",
			href: `https://github.com/${repo}`,
			target: "_blank",
			repo,
		},
		[
			nTitle,
			nDescription,
			h("div", { class: "gc-infobar" }, [nStars, nForks, nLicense, nLanguage]),
			nScript,
		],
	);
}
</file>

<file path="plugins/rehype-email-protection.mjs">
import { h } from "hastscript";
import { visit } from "unist-util-visit";

// 来自霞葉： https://kasuha.com/posts/fuwari-enhance-ep1/

/**
 * 加密 mailto 链接以保护邮箱地址免受爬虫抓取的 rehype 插件
 *
 * @param {Object} options - 插件选项
 * @param {string} [options.method='base64'] - 编码方式: 'base64' or 'rot13'
 * @returns {Function} A transformer function for the rehype plugin
 */
export default function rehypeEmailProtection(options = {}) {
	const { method = "base64" } = options;

	// Base64 编码函数
	const base64Encode = (str) => {
		return btoa(str);
	};

	// ROT13 编码函数
	const rot13Encode = (str) => {
		return str.replace(/[a-zA-Z]/g, (char) => {
			const start = char <= "Z" ? 65 : 97;
			return String.fromCharCode(
				((char.charCodeAt(0) - start + 13) % 26) + start,
			);
		});
	};

	// 根据选择的方法进行编码
	const encode = (str) => {
		return method === "rot13" ? rot13Encode(str) : base64Encode(str);
	};

	// 生成解码 JavaScript 代码
	const generateDecodeScript = () => {
		if (method === "rot13") {
			return `
        function decodeRot13(str) {
          return str.replace(/[a-zA-Z]/g, function(char) {
            const start = char <= 'Z' ? 65 : 97;
            return String.fromCharCode(((char.charCodeAt(0) - start + 13) % 26) + start);
          });
        }
        const decodedEmail = decodeRot13(encodedEmail);
      `;
		}
		return `
      const decodedEmail = atob(encodedEmail);
    `;
	};

	return (tree) => {
		let hasEmailLinks = false;

		visit(tree, "element", (node, index, parent) => {
			// 只处理 a 元素
			if (node.tagName !== "a") {
				return;
			}

			// 检查是否是 mailto 链接
			const href = node.properties?.href;
			if (!href || !href.startsWith("mailto:")) {
				return;
			}

			hasEmailLinks = true;

			// 提取邮箱地址
			const email = href.replace("mailto:", "");
			const encodedEmail = encode(email);

			// 创建加密的链接元素（移除原始的 href 属性，避免重复定义）
			const otherProperties = { ...node.properties };
			delete otherProperties.href;
			const protectedLink = h(
				"a",
				{
					...otherProperties,
					href: "#",
					"data-encoded-email": encodedEmail,
					onclick: `
          (function() {
            const encodedEmail = this.getAttribute('data-encoded-email');
            ${generateDecodeScript()}
            this.href = 'mailto:' + decodedEmail;
            this.removeAttribute('data-encoded-email');
            this.removeAttribute('onclick');
            this.click();
            return false;
          }).call(this);
        `
						.replace(/\s+/g, " ")
						.trim(),
				},
				node.children,
			);

			// 替换当前的 a 节点
			if (parent && typeof index === "number") {
				parent.children[index] = protectedLink;
			}
		});

		// 如果页面中有邮箱链接，添加样式
		if (hasEmailLinks) {
			visit(tree, "element", (node) => {
				if (node.tagName === "head") {
					const style = h(
						"style",
						`
            a[data-encoded-email] {
              cursor: pointer;
              text-decoration: underline;
              color: inherit;
            }
            a[data-encoded-email]:hover {
              text-decoration: underline;
            }
          `.trim(),
					);
					node.children.push(style);
				}
			});
		}
	};
}
</file>

<file path="plugins/rehype-external-links.mjs">
import { visit } from "unist-util-visit";

/**
 * 为文章中的外部链接添加 target="_blank" 和 rel="noopener noreferrer"
 * 仅处理以 http:// 或 https:// 开头且不属于本站的链接
 *
 * @param {Object} options
 * @param {string} [options.siteUrl] - 站点URL，用于判断是否为内部链接
 * @returns {Function} rehype transformer
 */
export default function rehypeExternalLinks(options = {}) {
	const siteUrl = options.siteUrl || "";
	let siteHost = "";
	try {
		siteHost = new URL(siteUrl).host;
	} catch (_e) {
		/* ignore */
	}

	return (tree) => {
		visit(tree, "element", (node) => {
			if (node.tagName !== "a") return;

			const href = node.properties?.href;
			if (typeof href !== "string") return;

			// 只处理 http/https 绝对链接
			if (!href.startsWith("http://") && !href.startsWith("https://")) return;

			// 跳过本站链接
			if (siteHost) {
				try {
					if (new URL(href).host === siteHost) return;
				} catch (_e) {
					/* ignore */
				}
			}

			node.properties.target = "_blank";
			node.properties.rel = "noopener";
		});
	};
}
</file>

<file path="plugins/rehype-figure.mjs">
import { h } from "hastscript";
import { visit } from "unist-util-visit";

// 来自霞葉： https://kasuha.com/posts/fuwari-enhance-ep1/

/**
 * 将带有 alt 文本的图片转换为包含 figcaption 的 figure 元素的 rehype 插件
 *
 * @returns {Function} A transformer function for the rehype plugin
 */
export default function rehypeFigure() {
	return (tree) => {
		visit(tree, "element", (node, index, parent) => {
			// 只处理 img 元素
			if (node.tagName !== "img") {
				return;
			}

			// 获取 alt 属性
			const alt = node.properties?.alt;

			// 如果没有 alt 属性或 alt 为空字符串，则保持原样
			if (!alt || alt.trim() === "") {
				return;
			}

			// 创建 figure 元素，包含原始的 img 和居中的 figcaption
			const figure = h("figure", [
				// 复制原始的 img 节点，但移除 alt 属性避免重复显示
				h("img", {
					...node.properties,
					alt: "", // 清空 alt 属性，因为现在有 figcaption 了
				}),
				h("figcaption", alt),
			]);

			// 居中显示
			const centerFigure = h("center", figure);

			// 替换当前的 img 节点为 figure 节点
			if (parent && typeof index === "number") {
				parent.children[index] = centerFigure;
			}
		});
	};
}
</file>

<file path="plugins/rehype-mermaid.mjs">
import { h } from "hastscript";
import { visit } from "unist-util-visit";
import mermaidRenderScript from "./mermaid-render-script.js?raw";

export function rehypeMermaid() {
	return (tree) => {
		visit(tree, "element", (node) => {
			if (
				node.tagName === "div" &&
				node.properties &&
				node.properties.className &&
				node.properties.className.includes("mermaid-container")
			) {
				const mermaidCode = node.properties["data-mermaid-code"] || "";
				const mermaidId = `mermaid-${Math.random().toString(36).slice(-6)}`;

				// 创建 Mermaid 容器
				const mermaidContainer = h(
					"div",
					{
						class: "mermaid-wrapper",
						id: mermaidId,
					},
					[
						h(
							"div",
							{
								class: "mermaid",
								"data-mermaid-code": mermaidCode,
							},
							mermaidCode,
						),
					],
				);

				// 创建客户端渲染脚本
				const renderScript = h(
					"script",
					{
						type: "text/javascript",
					},
					mermaidRenderScript,
				);

				// 替换原始节点
				node.tagName = "div";
				node.properties = { class: "mermaid-diagram-container" };
				node.children = [mermaidContainer, renderScript];
			}
		});
	};
}
</file>

<file path="plugins/remark-directive-rehype.js">
import { h } from "hastscript";
import { visit } from "unist-util-visit";

const ADMONITION_TYPES = [
	"note",
	"tip",
	"important",
	"warning",
	"caution",
	"abstract",
	"summary",
	"tldr",
	"info",
	"todo",
	"success",
	"check",
	"done",
	"question",
	"help",
	"faq",
	"attention",
	"failure",
	"missing",
	"fail",
	"danger",
	"error",
	"bug",
	"example",
	"quote",
	"cite",
];

export function parseDirectiveNode() {
	return (tree) => {
		visit(tree, (node) => {
			if (
				node.type === "containerDirective" ||
				node.type === "leafDirective" ||
				node.type === "textDirective"
			) {
				const name = node.name ? node.name.toLowerCase() : "";

				// 检查是否是 Admonition 类型
				// 仅对 containerDirective 进行 Admonition 转换
				if (
					node.type === "containerDirective" &&
					ADMONITION_TYPES.includes(name)
				) {
					const type = name.toUpperCase();

					// 处理 label (自定义标题)
					const firstChild = node.children[0];
					if (firstChild?.data?.directiveLabel) {
						// 如果有 label，注入 [!TYPE] 到 label 开头
						if (
							firstChild.children.length > 0 &&
							firstChild.children[0].type === "text"
						) {
							firstChild.children[0].value = `[!${type}] ${firstChild.children[0].value}`;
						} else {
							firstChild.children.unshift({
								type: "text",
								value: `[!${type}] `,
							});
						}
					} else {
						// 没有 label，插入包含 [!TYPE] 的新段落作为第一个子节点
						node.children.unshift({
							type: "paragraph",
							children: [{ type: "text", value: `[!${type}]` }],
						});
					}

					// 转换为 Blockquote
					node.type = "blockquote";
					node.data = node.data || {};
					node.data.hName = "blockquote";
					// 关键：清除可能存在的 hProperties，防止变为自定义标签
					delete node.data.hProperties;
				} else {
					// 其他 Directive，保留原有逻辑：转换为自定义 HTML 标签
					const data = node.data || {};
					node.data = data;
					node.attributes = node.attributes || {};

					// Add specific attributes for directive labels
					if (
						node.children.length > 0 &&
						node.children[0].data &&
						node.children[0].data.directiveLabel
					) {
						node.attributes["has-directive-label"] = true;
					}

					const hast = h(node.name, node.attributes);
					data.hName = hast.tagName;
					data.hProperties = hast.properties;
				}
			}
		});
	};
}
</file>

<file path="plugins/remark-excerpt.js">
// biome-ignore lint/suspicious/noShadowRestrictedNames: <toString from mdast-util-to-string>
import { toString } from "mdast-util-to-string";

/* Use the post's first paragraph as the excerpt */
export function remarkExcerpt() {
	return (tree, { data }) => {
		let excerpt = "";
		for (const node of tree.children) {
			if (node.type !== "paragraph") {
				continue;
			}
			excerpt = toString(node);
			break;
		}
		data.astro.frontmatter.excerpt = excerpt;
	};
}
</file>

<file path="plugins/remark-mermaid.js">
import { visit } from "unist-util-visit";

export function remarkMermaid() {
	return (tree) => {
		visit(tree, "code", (node) => {
			if (node.lang === "mermaid") {
				// 将 mermaid 代码块转换为自定义节点类型
				node.type = "mermaid";
				node.data = {
					hName: "div",
					hProperties: {
						className: ["mermaid-container"],
						"data-mermaid-code": node.value,
					},
				};
			}
		});
	};
}
</file>

<file path="plugins/remark-reading-time.mjs">
// biome-ignore lint/suspicious/noShadowRestrictedNames: <toString from mdast-util-to-string>
import { toString } from "mdast-util-to-string";
import getReadingTime from "reading-time";

export function remarkReadingTime() {
	return (tree, { data }) => {
		const textOnPage = toString(tree);
		const readingTime = getReadingTime(textOnPage);
		data.astro.frontmatter.minutes = Math.max(
			1,
			Math.round(readingTime.minutes),
		);
		data.astro.frontmatter.words = readingTime.words;
	};
}
</file>

<file path="styles/banner-title.css">
/* 横幅文字阴影 - 更柔和的扩散效果 */
.banner-title {
    text-shadow: 0 4px 24px rgba(0, 0, 0, 0.6);
}

.banner-subtitle {
    text-shadow: 0 2px 16px rgba(0, 0, 0, 0.6);
}

/* 横幅背景暗层透明度 */
.banner-dim-overlay {
    background: rgba(0, 0, 0, 0.15);
}

.banner-post-title {
    font-size: clamp(2rem, 4vw, 3rem);
    text-shadow: 0 4px 24px rgba(0, 0, 0, 0.65);
}

.banner-page-title {
    font-size: clamp(2rem, 4vw, 3rem);
    text-shadow: 0 4px 24px rgba(0, 0, 0, 0.65);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1.2;
}

/* .banner-page-title-icon {
    font-size: 1.2em;
    line-height: 1;
    vertical-align: middle;
    transform: translateY(0.08em);
  } */

.banner-page-title-text {
    line-height: 1.2;
}

.banner-post-meta-list {
    text-shadow: 0 2px 16px rgba(0, 0, 0, 0.6);
}
</file>

<file path="styles/custom-scrollbar.css">
/* 通用自定义滚动条样式 */
.custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.dark .custom-scrollbar {
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.2) 100%);
    border-radius: 3px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.3) 100%);
    border-color: rgba(255, 255, 255, 0.2);
}

.custom-scrollbar::-webkit-scrollbar-thumb:active {
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.4) 100%);
}

/* 暗色模式滚动条 - Webkit */
.dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.2) 100%);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.3) 100%);
    border-color: rgba(0, 0, 0, 0.2);
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb:active {
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.4) 100%);
}
</file>

<file path="styles/expressive-code.css">
.expressive-code {
  .frame {
    @apply shadow-none!;
  }

  .title {
    font-family:
      "JetBrains Mono Variable", ui-monospace, SFMono-Regular, Menlo, Monaco,
      Consolas, "Liberation Mono", "Courier New", monospace;
  }

  /* Language Badge 样式适配主题色和亮暗色 */
  /* 覆盖 expressive-code-language-badge 插件的默认样式 */
  [data-language]::before {
    color: var(--btn-content) !important;
    background: var(--btn-regular-bg) !important;
  }

  /* 折叠按钮样式适配主题色和亮暗色 */
  /* 只针对底部的toggle按钮，不改header-toggle */
  .ec-collapse__toggle {
    color: var(--btn-content) !important;
    background-color: var(--btn-regular-bg) !important;
    border-color: var(--line-color) !important;
    opacity: var(--opacity-80) !important;

    &:hover {
      background-color: var(--btn-regular-bg-hover) !important;
    }

    &:active {
      background-color: var(--btn-regular-bg-active) !important;
    }
  }
}

/* 透明模式下的代码块样式 */
body.wallpaper-transparent .expressive-code,
body.wallpaper-transparent .expressive-code *:not(.ec-collapse__toggle) {
  background-color: transparent !important;
  background: transparent !important;
}

body.wallpaper-transparent .expressive-code .frame {
  background-color: var(--card-bg-transparent) !important;
  background: var(--card-bg-transparent) !important;
}
</file>

<file path="styles/fancybox-custom.css">
/* Fancybox 自定义样式 */
.fancybox__container {
  --fancybox-bg: rgba(0, 0, 0, 0.9);
  --fancybox-thumbs-width: 64px;
  --fancybox-thumbs-ratio: 1;
  --fancybox-thumbs-border-radius: 4px;
}

.fancybox__toolbar {
  background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), transparent);
  padding: 8px;
  backdrop-filter: blur(4px);
}

.fancybox__caption {
  background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  color: white;
  font-size: 1rem;
  padding: 1rem;
  text-align: center;
  backdrop-filter: blur(4px);
  border-radius: 8px;
  margin: 0 1rem 1rem 1rem;
}

.fancybox__nav {
  --carousel-button-svg-width: 24px;
  --carousel-button-svg-height: 24px;
}

.fancybox__thumbs {
  background: rgba(0, 0, 0, 0.7);
  padding: 2px;
  border-radius: 8px;
  backdrop-filter: blur(4px);
}

.fancybox__thumb {
  border-radius: 4px;
  overflow: hidden;
  border: 2px solid transparent;
  transition: all 0.2s ease;
}

.fancybox__thumb.is-loading {
  background: rgba(255, 255, 255, 0.1);
}

.fancybox__thumb:hover {
  border-color: rgba(255, 255, 255, 0.5);
  transform: scale(1.05);
}

.fancybox__thumb.is-active {
  border-color: #fff;
}

/* 按钮样式 */
.fancybox__button {
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  width: 44px;
  height: 44px;
  transition: all 0.2s ease;
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.fancybox__button:hover {
  background: rgba(0, 0, 0, 0.7);
  transform: scale(1.1);
  border-color: rgba(255, 255, 255, 0.3);
}

.fancybox__button svg {
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
}

.fancybox__infobar {
  color: white;
  font-size: 0.9rem;
  padding: 0 8px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .fancybox__toolbar {
    padding: 4px;
  }
  
  .fancybox__button {
    width: 36px;
    height: 36px;
  }
  
  .fancybox__caption {
    font-size: 0.9rem;
    padding: 0.5rem;
    margin: 0 0.5rem 0.5rem 0.5rem;
  }
  
  .fancybox__thumbs {
    --fancybox-thumbs-width: 48px;
  }
}

@media (max-width: 480px) {
  .fancybox__button {
    width: 32px;
    height: 32px;
  }
  
  .fancybox__caption {
    font-size: 0.8rem;
    padding: 0.4rem;
  }
  
  .fancybox__thumbs {
    --fancybox-thumbs-width: 40px;
  }
}
</file>

<file path="styles/layout-styles.css">
/* Layout specific styles */

/* User controlled visibility - 通过 html 属性控制，在渲染前就生效 */
/* 用户关闭时隐藏水波纹 */
html[data-waves-enabled="false"] #header-waves {
    display: none !important;
}

/* 用户开启时显示水波纹（覆盖默认的 hidden 类） */
html[data-waves-enabled="true"] #header-waves {
    display: block !important;
}

/* 用户关闭时隐藏横幅标题 */
html[data-banner-title-enabled="false"] .banner-home-text-overlay {
    display: none !important;
}

/* 注意：不使用 data-banner-title-enabled="true" 强制显示，
   因为横幅标题只应在首页显示，由页面本身的 hidden 类控制 */

.banner-home-text-overlay.user-hidden {
    display: none !important;
}

/* 页面切换期间隐藏首页横幅文案，避免与文章元信息层重叠闪现 */
html.is-page-transitioning .banner-home-text-overlay {
    display: none !important;
}

/* Banner text styles */
.banner-title {
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    animation: banner-fadeInUp 0.3s ease-out;
    font-weight: bold;
}

.banner-subtitle {
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
    animation: banner-fadeInUp 0.3s ease-out 0.3s both;
}

@keyframes banner-fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 移动端无侧边栏布局优化 */
@media (max-width: 768px) {
    .mobile-no-sidebar {
        display: block !important;
        width: 100% !important;
    }
    
    .mobile-no-sidebar main {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    .mobile-no-sidebar #content-wrapper {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
    }
}

/* 移动端横幅优化 - 小屏手机 (320px - 480px) */
@media (max-width: 480px) {
    /* Banner wrapper 高度优化 - 优先保持banner显示 - 仅在首页应用 */
    #wallpaper-wrapper:not(.mobile-hide-banner) {
        height: 70vh !important; /* 保持较大高度优先显示banner */
        min-height: 450px;
        max-height: none; /* 移除最大高度限制 */
        top: 0 !important; /* 移动端从顶部开始，避免被导航栏覆盖 */
    }
    
    /* 主内容区域位置调整 - 向上移动以部分遮挡banner */
    /* 仅在 banner 模式下应用，其他模式（全屏壁纸/纯色）使用默认的 5.5rem */
    body.enable-banner .absolute.w-full.z-30:not(.no-banner-layout):not(.mobile-main-no-banner) {
        top: 35vh !important; /* 小屏手机，提升至与水波纹平行 */
        min-height: calc(100vh - 35vh) !important;
    }
    
    /* 横幅文本覆盖层优化 */
    .banner-home-text-overlay {
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        padding: 1rem !important;
        text-align: center !important; /* 文字居中对齐 */
    }
    
    /* 文本容器优化 */
    .banner-home-text-overlay > div {
        margin-bottom: 0 !important; /* 移除底部边距，保持居中 */
        width: 95% !important; /* 增加文本宽度利用率 */
        text-align: center !important; /* 确保文字居中 */
    }
    
    /* 标题字体优化 */
    .banner-title {
        font-size: 3.2rem !important; /* 增大字体大小 */
        line-height: 1.1 !important;
        margin-bottom: 0.5rem !important;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8) !important; /* 增强阴影 */
    }
    
    /* 副标题字体优化 */
    .banner-subtitle {
        font-size: 1rem !important;
        line-height: 1.3 !important;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7) !important;
    }
    
    /* 水波纹效果高度调整 - 与文章列表提升同步 */
    .waves {
        height: 13vh !important;
        min-height: 100px !important;
        max-height: 176px !important;
    }
}

/* 移动端横幅优化 - 大屏手机 (481px - 640px) */
@media (min-width: 481px) and (max-width: 640px) {
    /* Banner wrapper 高度优化 - 优先保持banner显示 - 仅在首页应用 */
    #wallpaper-wrapper:not(.mobile-hide-banner) {
        height: 75vh !important;
        min-height: 500px;
        max-height: none; /* 移除最大高度限制 */
        top: 0 !important; /* 移动端从顶部开始，避免被导航栏覆盖 */
    }
    
    /* 主内容区域位置调整 - 向上移动以部分遮挡banner */
    /* 仅在 banner 模式下应用，其他模式（全屏壁纸/纯色）使用默认的 5.5rem */
    body.enable-banner .absolute.w-full.z-30:not(.no-banner-layout):not(.mobile-main-no-banner) {
        top: 38vh !important; /* 大屏手机，提升至与水波纹平行 */
        min-height: calc(100vh - 38vh) !important;
    }
    
    /* 横幅文本覆盖层优化 */
    .banner-home-text-overlay {
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        padding: 1.5rem !important;
        text-align: center !important; /* 文字居中对齐 */
    }
    
    /* 文本容器优化 */
    .banner-home-text-overlay > div {
        margin-bottom: 0 !important; /* 移除底部边距，保持居中 */
        width: 90% !important;
        text-align: center !important; /* 确保文字居中 */
    }
    
    /* 标题字体优化 */
    .banner-title {
        font-size: 3.8rem !important; /* 增大字体大小 */
        line-height: 1.1 !important;
        margin-bottom: 0.75rem !important;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8) !important;
    }
    
    /* 副标题字体优化 */
    .banner-subtitle {
        font-size: 1.125rem !important;
        line-height: 1.4 !important;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7) !important;
    }
    
    /* 水波纹效果高度调整 - 与文章列表提升同步 */
    .waves {
        height: 15vh !important;
        min-height: 110px !important;
        max-height: 166px !important;
    }
}

/* 移动端横幅优化 - 超大屏手机/小平板 (641px - 767px) */
@media (min-width: 641px) and (max-width: 767px) {
    /* Banner wrapper 高度优化 - 仅在首页应用 */
    #wallpaper-wrapper:not(.mobile-hide-banner) {
        height: 72vh !important;
        min-height: 520px;
        max-height: none; /* 移除最大高度限制 */
        top: 0 !important; /* 移动端从顶部开始，避免被导航栏覆盖 */
    }
    
    /* 主内容区域位置调整 - 向上移动以部分遮挡banner */
    /* 仅在 banner 模式下应用，其他模式（全屏壁纸/纯色）使用默认的 5.5rem */
    body.enable-banner .absolute.w-full.z-30:not(.no-banner-layout):not(.mobile-main-no-banner) {
        top: 36vh !important; /* 小平板，提升至与水波纹平行 */
        min-height: calc(100vh - 36vh) !important;
    }
    
    /* 横幅文本覆盖层优化 */
    .banner-home-text-overlay {
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        padding: 1.75rem !important;
        text-align: center !important; /* 文字居中对齐 */
    }
    
    /* 文本容器优化 */
    .banner-home-text-overlay > div {
        margin-bottom: 0 !important; /* 移除底部边距，保持居中 */
        width: 88% !important;
        text-align: center !important; /* 确保文字居中 */
    }
    
    /* 标题字体优化 */
    .banner-title {
        font-size: 3.9rem !important;
        line-height: 1.1 !important;
        margin-bottom: 0.85rem !important;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8) !important;
    }
    
    /* 副标题字体优化 */
    .banner-subtitle {
        font-size: 1.25rem !important;
        line-height: 1.4 !important;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7) !important;
    }
    
    /* 水波纹效果高度调整 - 与文章列表提升同步 */
    .waves {
        height: 16vh !important;
        min-height: 115px !important;
        max-height: 190px !important;
    }
}

/* 平板设备横幅优化 (768px - 1023px) - Tailwind md 断点 */
@media (min-width: 768px) and (max-width: 1023px) {
    /* Banner wrapper 高度优化 - 仅在首页应用 */
    #wallpaper-wrapper:not(.mobile-hide-banner) {
        height: 70vh !important;
        min-height: 500px;
        top: 0 !important; /* 移动端从顶部开始，避免被导航栏覆盖 */
    }
    
    /* 主内容区域位置调整 - 向上移动以部分遮挡banner */
    /* 仅在 banner 模式下应用，其他模式（全屏壁纸/纯色）使用默认的 5.5rem */
    body.enable-banner .absolute.w-full.z-30:not(.no-banner-layout):not(.mobile-main-no-banner) {
        top: 33vh !important; /* 平板端，提升至与水波纹平行 */
        min-height: calc(100vh - 33vh) !important;
    }
    
    /* 横幅文本覆盖层优化 */
    .banner-home-text-overlay {
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        padding: 2rem !important;
        text-align: center !important; /* 文字居中对齐 */
    }
    
    /* 文本容器优化 */
    .banner-home-text-overlay > div {
        margin-bottom: 0 !important; /* 移除底部边距，保持居中 */
        width: 85% !important;
        text-align: center !important; /* 确保文字居中 */
    }
    
    /* 标题字体优化 */
    .banner-title {
        font-size: 4rem !important;
        line-height: 1.1 !important;
        margin-bottom: 1rem !important;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8) !important;
    }
    
    /* 副标题字体优化 */
    .banner-subtitle {
        font-size: 1.5rem !important;
        line-height: 1.4 !important;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7) !important;
    }
    
    /* 水波纹效果高度调整 - 与文章列表提升同步 */
    .waves {
        height: 17vh !important;
        min-height: 120px !important;
        max-height: 216px !important;
    }
}

/* 桌面端保持居中 (1024px+) - Tailwind lg 断点 */
@media (min-width: 1024px) {
    .banner-home-text-overlay {
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        padding: 2rem !important;
        text-align: center !important; /* 文字居中对齐 */
    }
    
    .banner-home-text-overlay > div {
        margin-bottom: 0 !important;
        width: 75% !important;
        text-align: center !important; /* 确保文字居中 */
    }
    
    /* 背景图片优化 */
    #banner img {
        transition: transform 1s ease-out !important;
    }
    
    /* 水波纹效果恢复默认 */
    .waves {
        height: 15vh !important;
        min-height: 80px !important;
        max-height: 150px !important;
    }
}

/* 移动端图片优化 */
@media (max-width: 1023px) {
    /* 移动端背景图片优化 */
    #banner img {
        transition: transform 0.5s ease-out !important;
    }
}

/* 平板和手机端非首页隐藏banner - 改进的分阶段动画 (1024px以下) */
@media (max-width: 1023px) {
    #wallpaper-wrapper {
        transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease-out;
        transform-origin: top center;
        /* 硬件加速优化 */
        will-change: transform, opacity;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
    }
    
    .mobile-hide-banner {
        transform: translateY(-100%) translateZ(0) !important;
        opacity: 0 !important;
        pointer-events: none !important;
        /* 快速消失 */
        transition: transform 0.3s ease-in, opacity 0.2s ease-in !important;
    }
    
    /* 手机端非首页时主内容区域从顶部开始 - 延迟出现的动画 */
    .absolute.w-full.z-30 {
        transition: top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.1s;
        /* 硬件加速优化 */
        will-change: top;
        /* 禁用transform以保证back to top 按钮可以显示
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        */
    }
    
    .absolute.w-full.z-30.mobile-main-no-banner {
        top: 5.5rem !important;
        min-height: calc(100vh - 5.5rem) !important;
        /* 内容区域快速上移 */
        transition: top 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s !important;
    }
}

/* 移动端banner性能优化 */
@media (max-width: 1023px) {
    .banner-container {
        /* 启用硬件加速 */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform, opacity;
        
        /* 优化渲染性能 */
        contain: layout style paint;
        
        /* 减少重绘 */
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }

    .carousel-item {
        /* 硬件加速 */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform, opacity;
        
        /* 优化触摸响应 */
        touch-action: pan-y;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }

    .banner-home-text-overlay {
        /* 文字渲染优化 */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        
        /* 减少重排 */
        contain: layout style;
    }

    /* 移动端图片优化 - 只针对装饰性图片 */
    .banner-container img:not(.interactive):not([onclick]):not([data-clickable]) {
        /* 图片渲染优化 */
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        
        /* 防止图片拖拽 */
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        
        /* 触摸优化 - 只针对装饰性图片 */
        pointer-events: none;
    }
    
    /* 交互式图片保持可点击 */
    .banner-container img.interactive,
    .banner-container img[onclick],
    .banner-container img[data-clickable] {
        pointer-events: auto;
        cursor: pointer;
    }
}

/* 当banner被禁用时的布局样式 */
.no-banner-layout {
    top: 5.5rem !important;
    min-height: calc(100vh - 5.5rem) !important;
}

/* 移动端当banner被禁用时的布局样式 */
@media (max-width: 1023px) {
    .absolute.w-full.z-30.no-banner-layout {
        top: 5.5rem !important;
        min-height: calc(100vh - 5.5rem) !important;
        transition: none !important; /* 移除过渡动画，立即应用位置 */
    }
}

/* 小屏手机当banner被禁用时的布局样式 */
@media (max-width: 480px) {
    .absolute.w-full.z-30.no-banner-layout {
        top: 5.5rem !important;
        min-height: calc(100vh - 5.5rem) !important;
        transition: none !important;
    }
}

/* 平板设备当banner被禁用时的布局样式 */
@media (min-width: 768px) and (max-width: 1023px) {
    .absolute.w-full.z-30.no-banner-layout {
        top: 5.5rem !important;
        min-height: calc(100vh - 5.5rem) !important;
        transition: none !important;
    }
}

/* 移动端横屏优化 */
@media (max-width: 1023px) and (orientation: landscape) {
    #wallpaper-wrapper:not(.mobile-hide-banner) {
        top: 0 !important; /* 横屏模式从顶部开始，避免被导航栏覆盖 */
        height: 60vh !important;
    }
    
    /* 主内容区域位置调整 - 确保在banner下面，但不影响非首页 */
    /* 仅在 banner 模式下应用，其他模式（全屏壁纸/纯色）使用默认的 5.5rem */
    body.enable-banner .absolute.w-full.z-30:not(.mobile-main-no-banner):not(.no-banner-layout) {
        top: 32vh !important; /* 横屏模式，提升至与水波纹平行 */
        min-height: calc(100vh - 32vh) !important;
    }
    
    .banner-container {
        height: 60vh;
        min-height: 300px;
    }

    .banner-home-text-overlay {
        padding: 1rem 1.5rem;
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        text-align: center !important; /* 文字居中对齐 */
    }

    .banner-title {
        font-size: 2.2rem !important; /* 增大字体大小 */
        line-height: 1.3;
    }

    .banner-subtitle {
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
}

/* 移动端暗色模式优化 */
@media (max-width: 1023px) and (prefers-color-scheme: dark) {
    .banner-home-text-overlay {
        background: linear-gradient(
            to top,
            rgba(0, 0, 0, 0.8) 0%,
            rgba(0, 0, 0, 0.4) 50%,
            transparent 100%
        );
    }

    .banner-title {
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
    }

    .banner-subtitle {
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7);
    }
}

/* 水波纹显示优化 */
.waves {
    /* 确保水波纹完整显示 */
    overflow: visible;
    z-index: 5;
    /* 硬件加速，确保与背景同步渲染 */
    transform: translateZ(0);
    will-change: transform;
    /* 移除contain属性，避免限制动画渲染范围 */
    contain: none;
}

.waves svg {
    /* 确保SVG完整渲染 */
    width: 100%;
    height: 100%;
    display: block;
    /* SVG硬件加速 */
    transform: translateZ(0);
    backface-visibility: hidden;
}

/* 水波纹填充色主题切换优化 */
.waves use {
    /* 确保填充色与页面背景同步更新 */
    will-change: fill;
}

/* 水波纹与背景同步切换优化 - 解决交界线闪烁 */
#header-waves {
    /* 确保水波纹容器与页面背景在同一合成层 */
    isolation: isolate;
    /* 移除contain属性，避免限制水波纹动画 */
    contain: none;
    /* 精确对齐 */
    margin-bottom: -1px;
}

/* 主题切换时的额外保护 */
.theme-changing #header-waves,
.theme-changing #header-waves svg,
.theme-changing #header-waves use {
    /* 在主题切换期间禁用所有可能的渲染延迟 */
    will-change: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
}

/* 移动端水波纹特殊优化 */
@media (max-width: 1023px) {
    #header-waves {
        /* 确保水波纹容器不被裁剪 */
        overflow: visible;
        z-index: 5;
        /* 水波纹快速消失动画 */
        transition: transform 0.3s ease-in, opacity 0.2s ease-in;
    }
    
    /* 当banner隐藏时，水波纹也隐藏 */
    .mobile-hide-banner #header-waves {
        display: none !important;
        transform: translateY(-100%);
        opacity: 0;
        /* 水波纹比banner更快消失 */
        transition: transform 0.25s ease-in, opacity 0.15s ease-in;
    }
    
    .waves svg {
        /* 移动端SVG优化 */
        min-height: 60px;
    }
    
    /* 确保水波纹在banner底部正确定位 */
    .waves {
        bottom: -1px !important;
        position: absolute !important;
    }
}

/* 超小屏幕水波纹优化 */
@media (max-width: 360px) {
    .waves {
        height: 6vh !important;
        min-height: 50px !important;
        max-height: 70px !important;
    }
}

/* 基于屏幕高度的banner优化 - 优先显示banner */
/* 极小高度屏幕 (高度 ≤ 500px) */
@media (max-height: 500px) {
    #wallpaper-wrapper {
        height: 85vh !important; /* 占用更多高度确保banner显示 */
        min-height: 350px !important;
    }
    
    .banner-home-text-overlay {
        padding: 1rem !important;
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        text-align: center !important; /* 文字居中对齐 */
    }
    
    .banner-title {
        font-size: 2.8rem !important; /* 增大字体大小 */
        line-height: 1.1 !important;
        margin-bottom: 0.5rem !important;
    }
    
    .banner-subtitle {
        font-size: 0.9rem !important;
        line-height: 1.2 !important;
    }
    
    .waves {
        height: 10vh !important;
        min-height: 60px !important;
    }
}

/* 小高度屏幕 (高度 501px - 600px) */
@media (min-height: 501px) and (max-height: 600px) {
    #wallpaper-wrapper {
        height: 80vh !important;
        min-height: 400px !important;
    }
    
    .banner-home-text-overlay {
        padding: 1.5rem !important;
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        text-align: center !important; /* 文字居中对齐 */
    }
    
    .banner-title {
        font-size: 3.2rem !important; /* 增大字体大小 */
        line-height: 1.1 !important;
        margin-bottom: 0.75rem !important;
    }
    
    .banner-subtitle {
        font-size: 1rem !important;
        line-height: 1.3 !important;
    }
    
    .waves {
        height: 17vh !important;
        min-height: 250px !important;
    }
}

/* 中等高度屏幕 (高度 601px - 700px) */
@media (min-height: 601px) and (max-height: 700px) {
    #wallpaper-wrapper {
        height: 75vh !important;
        min-height: 450px !important;
    }
    
    .banner-home-text-overlay {
        padding: 2rem !important;
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        text-align: center !important; /* 文字居中对齐 */
    }
    
    .banner-title {
        font-size: 3.8rem !important; /* 增大字体大小 */
        line-height: 1.1 !important;
        margin-bottom: 1rem !important;
    }
    
    .banner-subtitle {
        font-size: 1.125rem !important;
        line-height: 1.4 !important;
    }
    
    .waves {
        height: 15vh !important;
        min-height: 200px !important;
    }
}

/* 横屏模式特殊处理 - 优先显示banner */
@media (orientation: landscape) and (max-height: 500px) {
    #wallpaper-wrapper {
        height: 90vh !important; /* 横屏时占用更多高度 */
        min-height: 300px !important;
    }
    
    .banner-home-text-overlay {
        padding: 1rem 2rem !important;
        align-items: center !important; /* 垂直居中 */
        justify-content: center !important; /* 水平居中 */
        text-align: center !important; /* 文字居中对齐 */
    }
    
    .banner-title {
        font-size: 2.8rem !important; /* 增大字体大小 */
        line-height: 1.1 !important;
        margin-bottom: 0.5rem !important;
    }
    
    .banner-subtitle {
        font-size: 1rem !important;
        line-height: 1.2 !important;
    }
    
    .waves {
        height: 10vh !important;
        min-height: 50px !important;
    }
}

/* ============================================
 * Overlay 模式 - 全屏壁纸
 * 通过 .wallpaper-overlay 类切换显示模式
 * ============================================ */
#wallpaper-wrapper.wallpaper-overlay {
    position: fixed !important;
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: var(--overlay-z-index, -1) !important;
    opacity: var(--overlay-opacity, 0.8) !important;
    pointer-events: none !important;
    overflow: hidden !important;
    top: 0 !important;
    min-height: unset !important;
    max-height: unset !important;
    transform: none !important;
    transition: opacity 0.6s ease !important;
}

/* Overlay 模式下图片模糊效果 */
#wallpaper-wrapper.wallpaper-overlay img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    object-position: center !important;
    filter: blur(var(--overlay-blur, 0px));
}

/* Overlay 模式隐藏 Banner 专属元素 */
#wallpaper-wrapper.wallpaper-overlay .banner-home-text-overlay,
#wallpaper-wrapper.wallpaper-overlay .banner-page-title-overlay,
#wallpaper-wrapper.wallpaper-overlay .banner-post-meta-overlay,
#wallpaper-wrapper.wallpaper-overlay .waves,
#wallpaper-wrapper.wallpaper-overlay #header-waves {
    display: none !important;
}
</file>

<file path="styles/main.css">
@import 'tailwindcss';
@import './layout-styles.css';
@import './navbar.css';
@import './banner-title.css';
@import './waves.css';
@import './transition.css'; 
@import './custom-scrollbar.css';


@plugin '@tailwindcss/typography';

/* 暗色模式选择器配置 */
@custom-variant dark (&:where(.dark, .dark *));

/* Tailwind v4 配置 - 从 tailwind.config.cjs 迁移 */
@theme {
  --font-sans:
    'Roboto', 'sans-serif', ui-sans-serif, system-ui, sans-serif,
    'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
}

/* 自定义工具类 - Tailwind v4 使用 @utility 定义 */
@utility expand-animation {
  position: relative;
  z-index: 0;
  &::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    scale: 0.85;
    z-index: -10;
    transition: all 0.15s ease-out;
  }
  &:hover::before {
    background-color: var(--btn-plain-bg-hover);
    scale: 1;
  }
  &:active::before {
    background-color: var(--btn-plain-bg-active);
  }
  &:active {
    background: none;
  }
}

/* 确保平滑滚动 */
html {
    scroll-behavior: smooth;
}

/* 页面顶部渐变高光效果 */
.top-gradient-highlight {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 180px;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0.3) 30%, rgba(255, 255, 255, 0.15) 60%, rgba(255, 255, 255, 0.05) 80%, transparent 100%);
    pointer-events: none;
    z-index: 20;
    transition: all var(--duration-medium) var(--ease-standard);
}

/* 暗色主题下的渐变高光效果 */
:root.dark .top-gradient-highlight {
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0.3) 30%, rgba(0, 0, 0, 0.15) 60%, rgba(0, 0, 0, 0.05) 80%, transparent 100%);
}

@layer components {
    /* View Transitions API 主题切换动画 */
    /* 为整个文档根元素设置视图过渡 */
    ::view-transition-old(root),
    ::view-transition-new(root) {
        animation-duration: 0.5s;
        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        /* 使用混合模式使颜色过渡更平滑 */
        mix-blend-mode: normal;
    }
    
    /* 视图过渡组 - 使用交叉淡化效果 */
    ::view-transition-group(root) {
        animation-duration: 0.5s;
        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* 淡出旧视图 - 使用更平滑的曲线 */
    ::view-transition-old(root) {
        animation-name: theme-fade-out;
        /* 确保背景色同步切换 */
        z-index: 2;
    }
    
    /* 淡入新视图 - 使用更平滑的曲线 */
    ::view-transition-new(root) {
        animation-name: theme-fade-in;
        /* 确保新视图在上层 */
        z-index: 1;
    }
    
    /* 定义淡出动画 - 使用更平滑的缓动函数 */
    @keyframes theme-fade-out {
        0% {
            opacity: 1;
        }
        100% {
            opacity: 0;
        }
    }
    
    /* 定义淡入动画 - 从下层淡入 */
    @keyframes theme-fade-in {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
    
    /* 确保边框和分隔线元素在主题切换时有更明确的过渡时长 */
    .transition,
    [class*="border"],
    [class*="transition"] {
        transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 0.15s;
    }
    
    /* 主题过渡保护类 - 仅在非 View Transitions 模式下使用 */
    /* 当使用 View Transitions API 时，浏览器会自动处理过渡，不需要禁用 transition */
    .is-theme-transitioning:not(.use-view-transition) *,
    .is-theme-transitioning:not(.use-view-transition) *::before,
    .is-theme-transitioning:not(.use-view-transition) *::after {
        transition: none !important;
        animation: none !important;
    }
    
    /* 在主题切换时禁用代码块的复杂效果以提升性能 */
    /* 使用 View Transitions 时也需要禁用代码块动画，因为它们太多了 */
    .is-theme-transitioning .expressive-code,
    .is-theme-transitioning .expressive-code * {
        transition: none !important;
        animation: none !important;
        will-change: auto !important;
    }
    
    /* 禁用复杂选择器元素的过渡 - 仅在非 View Transitions 模式下 */
    .is-theme-transitioning:not(.use-view-transition) .float-panel,
    .is-theme-transitioning:not(.use-view-transition) .float-panel *,
    .is-theme-transitioning:not(.use-view-transition) .music-player,
    .is-theme-transitioning:not(.use-view-transition) .music-player *,
    .is-theme-transitioning:not(.use-view-transition) .widget,
    .is-theme-transitioning:not(.use-view-transition) .widget *,
    .is-theme-transitioning:not(.use-view-transition) .dropdown-content,
    .is-theme-transitioning:not(.use-view-transition) .dropdown-content * {
        transition: none !important;
        animation: none !important;
    }
    
    /* 强制使用 contain 隔离渲染上下文 - 仅在非 View Transitions 模式下 */
    .is-theme-transitioning:not(.use-view-transition) .post-card,
    .is-theme-transitioning:not(.use-view-transition) .widget,
    .is-theme-transitioning:not(.use-view-transition) .float-panel {
        contain: layout style paint !important;
    }
    
    /* 水波纹效果精确同步处理 - 仅在非 View Transitions 模式下 */
    .is-theme-transitioning:not(.use-view-transition) svg use {
        /* 禁用过渡但保持动画 */
        transition: none;
        /* 强制立即继承页面背景色 */
        fill: currentColor;
    }
    
    /* 导航栏主题切换保护 - 仅在非 View Transitions 模式下禁用过渡 */
    .is-theme-transitioning:not(.use-view-transition) #navbar > div,
    .is-theme-transitioning:not(.use-view-transition) #navbar[data-transparent-mode] > div,
    .is-theme-transitioning:not(.use-view-transition) #navbar[data-transparent-mode].scrolled > div,
    .is-theme-transitioning:not(.use-view-transition) body.wallpaper-transparent #navbar > div,
    .is-theme-transitioning:not(.use-view-transition) body.wallpaper-transparent #navbar[data-transparent-mode] > div,
    .is-theme-transitioning:not(.use-view-transition) body.wallpaper-transparent #navbar[data-transparent-mode].scrolled > div,
    .is-theme-transitioning:not(.use-view-transition) #wallpaper-wrapper ~ * #navbar > div,
    .is-theme-transitioning:not(.use-view-transition) #wallpaper-wrapper ~ * #navbar[data-transparent-mode] > div,
    .is-theme-transitioning:not(.use-view-transition) body:has(#wallpaper-wrapper) #navbar > div,
    .is-theme-transitioning:not(.use-view-transition) body:has(#wallpaper-wrapper) #navbar[data-transparent-mode] > div {
        transition: none !important;
        backdrop-filter: none !important;
    }
    
    /* 导航栏相关浮动面板的过渡禁用 */
    .is-theme-transitioning .dropdown-content,
    .is-theme-transitioning .float-panel,
    .is-theme-transitioning #display-setting,
    .is-theme-transitioning #nav-menu-panel,
    .is-theme-transitioning #translate-panel,
    .is-theme-transitioning #mobile-toc-panel,
    .is-theme-transitioning #search-panel {
        transition: none !important;
        backdrop-filter: none !important;
    }
    
    /* 水波纹容器的颜色传递 */
    .is-theme-transitioning #header-waves {
        /* 设置当前颜色为页面背景色，供SVG继承 */
        color: var(--page-bg);
        /* 确保与页面在同一合成层 */
        isolation: isolate;
        /* 优化渲染性能 */
        contain: layout style paint;
        /* GPU层合成 */
        transform: translateZ(0);
        /* 确保没有背景色 */
        background: transparent;
    }
    
    .is-theme-transitioning #header-waves use {
        /* 保持动画连续性 */
        will-change: transform;
        /* GPU优化 */
        transform: translateZ(0);
    }
    
    .card-base {
        @apply rounded-(--radius-large) overflow-hidden bg-(--card-bg) transition-colors duration-150;
    }
    .card-base-transparent {
        @apply rounded-(--radius-large) overflow-hidden bg-(--card-bg-transparent) transition-colors duration-150;
    }

    /* 开启边框和阴影效果时的样式 */
    .enable-card-border .card-base {
        @apply transition-all duration-300 border border-(--line-divider) shadow-xs;
    }
    .enable-card-border .card-base-transparent {
        @apply transition-all duration-300 border border-(--line-divider) shadow-xs;
    }

    /* 导航栏样式适配 */
    .enable-card-border #navbar > div:not(.absolute) {
        @apply transition-all duration-300 border shadow-xs;
        border-color: var(--line-divider) !important;
    }
    
    /* 全屏壁纸模式下的半透明效果 */
    .wallpaper-transparent .card-base {
        background-color: var(--card-bg-transparent) !important;
    }
 
    
    .wallpaper-transparent #navbar > div {
        background-color: var(--card-bg-transparent) !important;
    }
    
    .wallpaper-transparent .btn-card {
        background-color: var(--card-bg-transparent) !important;
    }
    
    h1, h2, h3, h4, h5, h6, p, a, span, li, ul, ol, blockquote, code, pre, table, th, td, strong {
        @apply transition-colors duration-150;
    }
    .card-shadow {
        @apply drop-shadow-[0_2px_4px_rgba(0,0,0,0.005)]
    }
    .link {
        @apply transition-colors duration-150 rounded-md p-1 -m-1 expand-animation;
    }
    .link-lg {
        @apply transition-colors duration-150 rounded-md p-1.5 -m-1.5 expand-animation;
    }
    .float-panel {
        @apply top-21 rounded-(--radius-large) overflow-hidden bg-(--card-bg) transition-colors duration-150 shadow-xl border border-black/5 dark:border-white/10
    }
    .float-panel-closed {
        @apply -translate-y-1 opacity-0 pointer-events-none
    }
    .float-panel-closed * {
        @apply pointer-events-none
    }
    .search-panel mark {
        @apply bg-transparent text-(--primary)
    }

    .btn-card {
        @apply transition-colors duration-150 flex items-center justify-center bg-(--card-bg) hover:bg-(--btn-card-bg-hover)
        active:bg-(--btn-card-bg-active)
    }
    .btn-card.disabled {
        @apply pointer-events-none text-black/10 dark:text-white/10
    }
    .btn-plain {
        @apply transition-colors duration-150 relative flex items-center justify-center bg-none
        text-black/75 hover:text-(--primary) dark:text-white/75 dark:hover:text-(--primary);
        &:not(.scale-animation) {
            @apply hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active)
        }
        &.scale-animation {
            @apply expand-animation;
        }
    }
    .current-theme-btn {
        @apply bg-(--btn-plain-bg-hover) text-(--primary);
    }
    .btn-regular {
        @apply transition-colors duration-150 flex items-center justify-center bg-(--btn-regular-bg) hover:bg-(--btn-regular-bg-hover) active:bg-(--btn-regular-bg-active)
        text-(--btn-content) dark:text-white/75
    }

    .link-underline {
        @apply transition-colors duration-150 underline decoration-2 decoration-dashed decoration-(--link-underline)
        hover:decoration-(--link-hover) active:decoration-(--link-active) underline-offset-[0.25rem]
    }

    .toc-hide,
    .toc-not-ready {
        @apply opacity-0 pointer-events-none
    }

    /* #toc-inner-wrapper {
        mask-image: linear-gradient(to bottom, transparent 0%, black 2rem, black calc(100% - 2rem), transparent 100%);
    } */

    .hide-scrollbar {
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .text-90 {
        @apply text-black/90 dark:text-white/90
    }
    .text-75 {
        @apply text-black/75 dark:text-white/75
    }
    .text-50 {
        @apply text-black/50 dark:text-white/50
    }
    .text-30 {
        @apply text-black/30 dark:text-white/30
    }
    .text-25 {
        @apply text-black/25 dark:text-white/25
    }

    /* 下拉菜单样式 */
    .dropdown-container {
        @apply relative;
    }

    .dropdown-menu {
        @apply absolute top-full left-0 pt-2 opacity-0 invisible pointer-events-none transition-all duration-200 ease-out transform translate-y-[-8px] z-50;
    }

    .dropdown-container:hover .dropdown-menu,
    .dropdown-container:focus-within .dropdown-menu {
        @apply opacity-100 visible pointer-events-auto translate-y-0;
    }

    .dropdown-container:hover .dropdown-arrow,
    .dropdown-container:focus-within .dropdown-arrow {
        @apply rotate-180;
    }

    .dropdown-content {
        @apply bg-(--card-bg) rounded-(--radius-large) shadow-xl border border-black/5 dark:border-white/10 py-2 min-w-48;
    }

    .dropdown-item {
        @apply flex items-center justify-between px-4 py-2.5 text-black/75 dark:text-white/75 hover:text-(--primary) hover:bg-(--btn-plain-bg-hover) transition-colors duration-150 font-medium;
    }

    .dropdown-item:first-child {
        @apply rounded-t-[calc(var(--radius-large)-0.5rem)];
    }

    .dropdown-item:last-child {
        @apply rounded-b-[calc(var(--radius-large)-0.5rem)];
    }

    /* 移动端菜单样式 */
    .mobile-submenu {
        @apply max-h-0 overflow-hidden transition-all duration-300 ease-in-out;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-submenu {
        @apply max-h-96;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-dropdown-arrow {
        @apply rotate-180;
    }

    /* 响应式隐藏 */
    @media (max-width: 768px) {
        .dropdown-container {
            @apply hidden;
        }
    }

    /* 无障碍支持 */
    .dropdown-container:focus-within .dropdown-menu {
        @apply opacity-100 visible pointer-events-auto translate-y-0;
    }

    .dropdown-item:focus {
        @apply outline-hidden;
    }

    .mobile-dropdown button:focus {
        @apply outline-hidden;
    }

    .meta-icon {
        @apply w-8 h-8 transition-colors duration-150 rounded-md flex items-center justify-center bg-(--btn-regular-bg)
        text-(--btn-content) mr-2
    }
    .with-divider {
        @apply before:content-['/'] before:ml-1.5 before:mr-1.5 before:text-(--meta-divider) before:text-sm
        before:font-medium before:first-of-type:hidden before:transition-colors before:duration-150
    }

    .btn-regular-dark {
        @apply flex items-center justify-center
        bg-[oklch(0.45_0.01_var(--hue))] hover:bg-[oklch(0.50_0.01_var(--hue))] active:bg-[oklch(0.55_0.01_var(--hue))]
        dark:bg-[oklch(0.30_0.02_var(--hue))] dark:hover:bg-[oklch(0.35_0.03_var(--hue))] dark:active:bg-[oklch(0.40_0.03_var(--hue))]
    }
    .btn-regular-dark.success {
        @apply bg-[oklch(0.75_0.14_var(--hue))] dark:bg-[oklch(0.75_0.14_var(--hue))]
    }
}

.custom-md img, #post-cover img {
    @apply cursor-zoom-in
}

::selection {
    background-color: var(--selection-bg)
}

.dash-line {
    position: relative;
}

.dash-line::before {
    content: "";
    position: absolute;
    width: 10%;
    height: 100%;
    left: calc(50% - 1px);
    border-left: 2px dashed var(--line-color);
    pointer-events: none;
    transition: all 0.3s;
    transform: translateY(-50%);
}


/*剧透效果*/
.custom-md spoiler {
  --_spoiler-mask: var(--primary);
  @apply hover:bg-transparent px-1 py-0.5 overflow-hidden rounded-md transition-all duration-150;
  background-color: var(--_spoiler-mask);
  box-decoration-break: clone;
  &:not(:hover) {
    color: var(--_spoiler-mask);
    * {
        color: var(--_spoiler-mask);
    }
  }
}

/* 浅色模式：使用更浅的主题色且完全不透明 */
:root:not(.dark) .custom-md spoiler {
  --_spoiler-mask: color-mix(in oklch, var(--primary) 55%, white 45%);
}

/* 文章列表布局切换样式 */
.post-list-layout-switch {
  @apply flex items-center gap-2 mb-6 p-3 bg-(--card-bg) rounded-lg border border-(--line-divider);
}

.post-list-layout-switch span {
  @apply text-sm text-(--text-secondary);
}

.post-list-layout-switch .layout-buttons {
  @apply flex gap-1;
}

.post-list-layout-switch button {
  @apply px-3 py-1.5 text-sm rounded-md transition-colors;
}

.post-list-layout-switch button.active {
  @apply bg-(--primary) text-white;
}

.post-list-layout-switch button:not(.active) {
  @apply bg-(--bg-secondary) text-(--text-secondary) hover:bg-(--bg-hover);
}

/* 网格模式下的文章卡片样式调整 */
.post-list-container.grid-mode .post-card-item {
  @apply w-full;
}

.post-list-container.grid-mode .post-card-item a[href] {
  @apply text-xl before:h-4 before:top-[28px] before:left-[-18px] truncate;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
  max-height: 2.8em; /* 2行的高度 */
}

.post-list-container.grid-mode .post-card-item a[aria-label] {
  @apply hidden;
}

.post-list-container.grid-mode .post-card-item .btn-regular {
  @apply hidden;
}

.post-list-container.grid-mode .post-card-item .line-clamp-1 {
  @apply line-clamp-2;
}

/* 网格模式下的卡片内容区域调整 */
.post-list-container.grid-mode .post-card-item > div {
  @apply p-4;
}

/* 网格模式下的元数据样式调整 */
.post-list-container.grid-mode .post-card-item .post-meta {
  @apply mb-2;
}

/* 网格模式下的描述文本调整 */
.post-list-container.grid-mode .post-card-item .description {
  @apply text-sm mb-2 line-clamp-2;
}

/* 网格模式下的统计信息调整 */
.post-list-container.grid-mode .post-card-item .stats {
  @apply text-xs;
}

/* 响应式分页样式 */
.device-mobile .pagination-info {
  @apply text-xs;
}

.device-tablet .pagination-info {
  @apply text-sm;
}

.device-desktop .pagination-info {
  @apply text-base;
}

/* 分页信息样式 */
.pagination-info {
  @apply text-sm text-(--text-secondary) text-center mb-2;
}
</file>

<file path="styles/markdown-extend.styl">
.custom-md

  blockquote.admonition
    .bdm-title
      display: flex
      align-items: center
      margin-bottom: -.9rem
      font-weight: bold

      &:before
        content: ' '
        display: inline-block
        font-size: inherit
        overflow: visible
        margin-right: .6rem
        height: 1em
        width: 1em
        vertical-align: -.126em
        mask-size: contain
        mask-position: center
        mask-repeat: no-repeat
        transform: translateY(-0.0625rem)
    &.bdm-tip
      .bdm-title
        color: var(--admonitions-color-tip)

        &:before
          background: var(--admonitions-color-tip)
          mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z'%3E%3C/path%3E%3C/svg%3E")

      &:before
        background: var(--admonitions-color-tip)
    &.bdm-note
      .bdm-title
        color: var(--admonitions-color-note)

        &:before
          background: var(--admonitions-color-note)
          mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath fill='var(--admonitions-color-tip)' d='M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E")

      &:before
        background: var(--admonitions-color-note)
    &.bdm-important
      .bdm-title
        color: var(--admonitions-color-important)

        &:before
          background: var(--admonitions-color-important)
          mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z'%3E%3C/path%3E%3C/svg%3E")

      &:before
        background: var(--admonitions-color-important)
    &.bdm-warning
      .bdm-title
        color: var(--admonitions-color-warning)

        &:before
          background: var(--admonitions-color-warning)
          mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z'%3E%3C/path%3E%3C/svg%3E")

      &:before
        background: var(--admonitions-color-warning)
    &.bdm-caution
      .bdm-title
        color: var(--admonitions-color-caution)

        &:before
          background: var(--admonitions-color-caution)
          mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E")

      &:before
        background: var(--admonitions-color-caution)

  img
    border-radius: 0.75rem

  hr
    border-color: var(--line-divider)
    border-style: dashed

  iframe
    border-radius: 0.75rem
    margin-left: auto
    margin-right: auto
    max-width: 100%

a.card-github
  display: block
  background: var(--license-block-bg)
  position: relative
  margin: 0.5rem 0
  padding: 1.1rem 1.5rem 1.1rem 1.5rem
  color: var(--tw-prose-body)
  border-radius: var(--radius-large)
  text-decoration-thickness: 0px
  text-decoration-line: none

  &:hover
    background-color: var(--btn-regular-bg-hover)

    .gc-titlebar
      color: var(--btn-content)

    .gc-stars, .gc-forks, .gc-license, .gc-description
      color: var(--tw-prose-headings)

      &:before
        background-color: var(--tw-prose-headings)

  &:active
    scale: .98
    background-color: var(--btn-regular-bg-active);

  .gc-titlebar
    display: flex
    align-items: center
    justify-content: space-between
    margin-bottom: 0.5rem
    color: var(--tw-prose-headings)
    font-size: 1.25rem
    font-weight: 500

    .gc-titlebar-left
      display: flex
      flex-flow: row nowrap
      gap: 0.5rem

    .gc-repo
      font-weight: bold

    .gc-owner
      font-weight: 300
      position: relative
      display: flex
      flex-flow: row nowrap
      gap: 0.5rem
      align-items: center

    .gc-avatar
      display: block
      overflow: hidden
      width: 1.5rem
      height: 1.5rem
      margin-top: -0.1rem
      background-color: var(--primary)
      background-size: cover
      border-radius: 50%

  .gc-description
    margin-bottom: 0.7rem
    font-size: 1rem
    font-weight: 300
    line-height: 1.5rem
    color: var(--tw-prose-body)

  .gc-infobar
    display: flex
    flex-flow: row nowrap
    gap: 1.5rem
    color: var(--tw-prose-body)
    width: fit-content

  .gc-language
    display: none

  .gc-stars, .gc-forks, .gc-license, .github-logo
    font-weight: 500
    font-size: 0.875rem
    opacity: 0.9;

    &:before
      content: ' '
      display: inline-block
      height: 1.3em
      width: 1.3em
      margin-right: .4rem
      vertical-align: -.24em
      font-size: inherit
      background-color: var(--tw-prose-body)
      overflow: visible
      mask-size: contain
      mask-position: center
      mask-repeat: no-repeat
      transition-property: background-color, background;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1)
      transition-duration: 0.15s

  .gc-stars
    &:before
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' aria-hidden='true' height='16' viewBox='0 0 16 16' version='1.1' width='16'%3E%3Cpath d='M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z'%3E%3C/path%3E%3C/svg%3E")

  .gc-license
    &:before
      margin-right: .5rem
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' aria-hidden='true' height='16' viewBox='0 0 16 16' version='1.1' width='16'%3E%3Cpath d='M8.75.75V2h.985c.304 0 .603.08.867.231l1.29.736c.038.022.08.033.124.033h2.234a.75.75 0 0 1 0 1.5h-.427l2.111 4.692a.75.75 0 0 1-.154.838l-.53-.53.529.531-.001.002-.002.002-.006.006-.006.005-.01.01-.045.04c-.21.176-.441.327-.686.45C14.556 10.78 13.88 11 13 11a4.498 4.498 0 0 1-2.023-.454 3.544 3.544 0 0 1-.686-.45l-.045-.04-.016-.015-.006-.006-.004-.004v-.001a.75.75 0 0 1-.154-.838L12.178 4.5h-.162c-.305 0-.604-.079-.868-.231l-1.29-.736a.245.245 0 0 0-.124-.033H8.75V13h2.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5h2.5V3.5h-.984a.245.245 0 0 0-.124.033l-1.289.737c-.265.15-.564.23-.869.23h-.162l2.112 4.692a.75.75 0 0 1-.154.838l-.53-.53.529.531-.001.002-.002.002-.006.006-.016.015-.045.04c-.21.176-.441.327-.686.45C4.556 10.78 3.88 11 3 11a4.498 4.498 0 0 1-2.023-.454 3.544 3.544 0 0 1-.686-.45l-.045-.04-.016-.015-.006-.006-.004-.004v-.001a.75.75 0 0 1-.154-.838L2.178 4.5H1.75a.75.75 0 0 1 0-1.5h2.234a.249.249 0 0 0 .125-.033l1.288-.737c.265-.15.564-.23.869-.23h.984V.75a.75.75 0 0 1 1.5 0Zm2.945 8.477c.285.135.718.273 1.305.273s1.02-.138 1.305-.273L13 6.327Zm-10 0c.285.135.718.273 1.305.273s1.02-.138 1.305-.273L3 6.327Z'%3E%3C/path%3E%3C/svg%3E")

  .gc-forks
    &:before
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' aria-hidden='true' height='16' viewBox='0 0 16 16' version='1.1' width='16'%3E%3Cpath d='M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z'%3E%3C/path%3E%3C/svg%3E")

  .github-logo
    font-size: 1.25rem

    &:before
      background-color: var(--tw-prose-headings)
      margin-right: 0
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='31' height='32' viewBox='0 0 496 512'%3E%3Cpath fill='%23a1f7cb' d='M165.9 397.4c0 2-2.3 3.6-5.2 3.6c-3.3.3-5.6-1.3-5.6-3.6c0-2 2.3-3.6 5.2-3.6c3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9c2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9c.3 2 2.9 3.3 5.9 2.6c2.9-.7 4.9-2.6 4.6-4.6c-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2c12.8 2.3 17.3-5.6 17.3-12.1c0-6.2-.3-40.4-.3-61.4c0 0-70 15-84.7-29.8c0 0-11.4-29.1-27.8-36.6c0 0-22.9-15.7 1.6-15.4c0 0 24.9 2 38.6 25.8c21.9 38.6 58.6 27.5 72.9 20.9c2.3-16 8.8-27.1 16-33.7c-55.9-6.2-112.3-14.3-112.3-110.5c0-27.5 7.6-41.3 23.6-58.9c-2.6-6.5-11.1-33.3 2.6-67.9c20.9-6.5 69 27 69 27c20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27c13.7 34.7 5.2 61.4 2.6 67.9c16 17.7 25.8 31.5 25.8 58.9c0 96.5-58.9 104.2-114.8 110.5c9.2 7.9 17 22.9 17 46.4c0 33.7-.3 75.4-.3 83.6c0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252C496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2c1.6 1.6 3.9 2.3 5.2 1c1.3-1 1-3.3-.7-5.2c-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9c1.6 1 3.6.7 4.3-.7c.7-1.3-.3-2.9-2.3-3.9c-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2c2.3 2.3 5.2 2.6 6.5 1c1.3-1.3.7-4.3-1.3-6.2c-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9c1.6 2.3 4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2c-1.4-2.3-4-3.3-5.6-2'/%3E%3C/svg%3E")

a.card-github.fetch-waiting
  pointer-events: none
  opacity: 0.7
  transition: opacity 0.15s ease-in-out

  .gc-description, .gc-infobar, .gc-avatar
    background-color: var(--tw-prose-body)
    color: transparent
    opacity: 0.5;
    animation: pulsate 2s infinite linear
    user-select: none

    &:before
      background-color: transparent

  .gc-repo
    margin-left: -0.1rem

  .gc-description, .gc-infobar
    border-radius: 0.5rem

a.card-github.fetch-error
  pointer-events: all
  opacity: 1

@keyframes pulsate
  0%
    opacity: 0.15
  50%
    opacity: 0.25
  100%
    opacity: 0.15

.card-github, .gc-description, .gc-titlebar, .gc-stars, .gc-forks, .gc-license, .gc-avatar, .github-logo
  transition-property: all
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1)
  transition-duration: 0.15s

// Mermaid 图表样式
.mermaid-diagram-container
  margin: 1rem 0
  border-radius: 0.75rem
  overflow: hidden
  background: var(--card-bg)
  transition: all 0.3s ease

  &:hover
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1)

.mermaid-wrapper
  padding: 1.5rem
  text-align: center

.mermaid
  display: flex
  justify-content: center
  align-items: center
  min-height: 100px
  font-family: inherit

  svg
    max-width: 100%
    height: auto
    border-radius: 0.5rem

.mermaid-loading
  display: flex
  align-items: center
  justify-content: center
  padding: 2rem
  color: var(--text-color-secondary)
  font-style: italic
  
  &::before
    content: ""
    width: 20px
    height: 20px
    border: 2px solid var(--primary)
    border-top: 2px solid transparent
    border-radius: 50%
    animation: spin 1s linear infinite
    margin-right: 0.5rem

@keyframes spin
  0%
    transform: rotate(0deg)
  100%
    transform: rotate(360deg)

.mermaid-error
  color: var(--admonitions-color-warning)
  background: rgba(239, 68, 68, 0.1)
  border: 1px solid var(--admonitions-color-warning)
  border-radius: 0.5rem
  padding: 1rem
  margin: 1rem 0
  text-align: center
  font-weight: 500
  
  p
    margin: 0 0 0.5rem 0
    
  button
    transition: all 0.2s ease
    
    &:hover
      background: var(--primary-hover) !important
      transform: translateY(-1px)

// 深色模式下的 Mermaid 样式
.dark .mermaid-diagram-container
  background: var(--card-bg)

  svg
    filter: brightness(0.9) contrast(1.1)

// 响应式设计
@media (max-width: 768px)
  .mermaid-wrapper
    padding: 1rem

  .mermaid svg
    max-height: 400px
</file>

<file path="styles/markdown.css">
@reference "tailwindcss";

.custom-md {
  h1 {
    @apply text-3xl;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    .anchor {
      @apply !transition !-m-0.5 !ml-[0.2ch] !p-0.5 !select-none !opacity-0 !no-underline;

      .anchor-icon {
        @apply !mx-[0.45ch];
      }
    }

    &:hover {
      .anchor {
        @apply !opacity-100;
      }
    }
  }

  a:not(.no-styling) {
    @apply relative bg-none font-medium text-(--primary) underline decoration-(--link-underline) decoration-1 decoration-dashed underline-offset-4;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;

    &:hover,
    &:active {
      @apply decoration-transparent;
      background: var(--btn-plain-bg-hover);
      border-bottom: 1px dashed var(--link-hover);
      text-decoration: none;
    }
  }

  code {
    @apply bg-(--inline-code-bg) text-(--inline-code-color) px-1 py-0.5 rounded-md overflow-hidden;

    font-family:
      "JetBrains Mono Variable",
      ui-monospace,
      SFMono-Regular,
      Menlo,
      Monaco,
      Consolas,
      Liberation Mono,
      Courier New,
      monospace;

    &:before {
      content: none;
    }

    &:after {
      content: none;
    }

    counter-reset: line;

    span.line {
      &:before {
        @apply text-white/25 mr-4 w-4 inline-block;
        content: counter(line);
        counter-increment: line;
        direction: rtl;
      }

      &:last-child:empty,
      &:last-child:has(> span:empty:only-child) {
        display: none;
      }
    }
  }

  .expressive-code {
    @apply my-4;
  }

  ul,
  ol {
    li::marker {
      @apply text-(--primary);
    }
  }

  blockquote {
    @apply not-italic border-transparent relative;
    font-weight: inherit;

    &:before {
      @apply content-[''] absolute -left-1 block transition bg-(--btn-regular-bg) h-full w-1 rounded-full;
    }

    /* Remove the double quotes from default styles */
    p:before,
    p:after {
      @apply content-none;
    }
  }

  .katex-display-container {
    max-width: 100%;
    overflow-x: auto;
    margin: 1em 0;
  }
}
</file>

<file path="styles/navbar.css">
/**
 * 统一导航栏样式
 * 
 * 模式说明：
 * ============================================
 * 1. 壁纸模式 (backgroundWallpaper.mode):
 *    - "banner": 横幅壁纸模式 (有 #wallpaper-wrapper)
 *    - "overlay": 全屏壁纸模式 (body.wallpaper-transparent)
 *    - "none": 纯色背景无壁纸
 * 
 * 2. 导航栏配置 (banner.navbar):
 *    - transparentMode: "semi" | "full" | "semifull" (仅在 Banner 模式下生效)
 *    - enableBlur: true/false (仅在 Banner 模式下生效)
 * 
 * 注意：Overlay 模式下的导航栏始终跟随卡片样式 (var(--card-bg-transparent) + blur)，
 * 不受 Banner 配置 (transparentMode, enableBlur) 的影响。
 * ============================================
 */

/* ============================================
 * 基础导航栏样式
 * 适用: 所有模式，所有设备
 * ============================================ */
#navbar>div {
    background: var(--card-bg);
    border: 1px solid transparent;
    border-radius: 0 0 0.75rem 0.75rem;
    transition: all var(--duration-medium) var(--ease-standard);
}

/* ============================================
 * 桌面端 - 亮色主题 - Banner模式
 * 适用: 桌面端(≥1024px) + Banner模式 + 亮色主题
 * 遵循: transparentMode, enableBlur 配置
 * ============================================ */
@media (min-width: 1024px) {

    /* "semi" */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="semi"]>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semi"]>div {
        backdrop-filter: blur(var(--navbar-glass-blur, 20px)) !important;
        background: rgba(255, 255, 255, var(--opacity-55)) !important;
        border: 1px solid rgba(255, 255, 255, var(--opacity-55)) !important;
        border-radius: 0 0 0.75rem 0.75rem !important;
        box-shadow: var(--shadow-navbar) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* "full" */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="full"]>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="full"]>div {
        backdrop-filter: none !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* "semifull" (static) */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"]>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"]>div {
        backdrop-filter: none !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 0 0.75rem 0.75rem !important;
        box-shadow: none !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* "semifull" (scrolled) */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"].scrolled>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"].scrolled>div {
        backdrop-filter: blur(var(--navbar-glass-blur, 20px)) !important;
        background: rgba(255, 255, 255, var(--opacity-55)) !important;
        border: 1px solid rgba(255, 255, 255, var(--opacity-55)) !important;
        border-radius: 0 0 0.75rem 0.75rem !important;
        box-shadow: var(--shadow-navbar) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
}

/* ============================================
 * 移动端 - 亮色主题 - Banner模式
 * 适用: 移动端(≤1023px) + Banner模式 + 亮色主题 + 仅首页生效
 * ============================================ */
@media (max-width: 1023px) {

    /* "semi" */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="semi"][data-is-home="true"]>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semi"][data-is-home="true"]>div {
        backdrop-filter: blur(var(--navbar-glass-blur, 20px)) !important;
        background: rgba(255, 255, 255, var(--opacity-55)) !important;
        border: 1px solid rgba(255, 255, 255, var(--opacity-55)) !important;
        border-radius: 0 0 0.75rem 0.75rem !important;
        box-shadow: var(--shadow-navbar) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* "full" */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="full"][data-is-home="true"]>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="full"][data-is-home="true"]>div {
        backdrop-filter: none !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* "semifull" (static) */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"][data-is-home="true"]>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"][data-is-home="true"]>div {
        backdrop-filter: none !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 0 0.75rem 0.75rem !important;
        box-shadow: none !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* "semifull" (scrolled) */
    #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"][data-is-home="true"].scrolled>div,
    body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"][data-is-home="true"].scrolled>div {
        backdrop-filter: blur(var(--navbar-glass-blur, 20px)) !important;
        background: rgba(255, 255, 255, var(--opacity-55)) !important;
        border: 1px solid rgba(255, 255, 255, var(--opacity-55)) !important;
        border-radius: 0 0 0.75rem 0.75rem !important;
        box-shadow: var(--shadow-navbar) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
}

/* ============================================
 * 桌面端 - 暗色主题 - Banner模式
 * ============================================ */
@media (min-width: 1024px) {

    /* "semi" */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="semi"]>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semi"]>div {
        background: rgba(0, 0, 0, var(--opacity-55)) !important;
        border: 1px solid rgba(0, 0, 0, var(--opacity-55)) !important;
        box-shadow: var(--shadow-navbar-dark) !important;
    }

    /* "full" */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="full"]>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="full"]>div {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* "semifull" (static) */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"]>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"]>div {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* "semifull" (scrolled) */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"].scrolled>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"].scrolled>div {
        background: rgba(0, 0, 0, var(--opacity-55)) !important;
        border: 1px solid rgba(0, 0, 0, var(--opacity-55)) !important;
        box-shadow: var(--shadow-navbar-dark) !important;
    }
}

/* ============================================
 * 移动端 - 暗色主题 - Banner模式
 * ============================================ */
@media (max-width: 1023px) {

    /* "semi" */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="semi"][data-is-home="true"]>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semi"][data-is-home="true"]>div {
        background: rgba(0, 0, 0, var(--opacity-55)) !important;
        border: 1px solid rgba(0, 0, 0, var(--opacity-55)) !important;
        box-shadow: var(--shadow-navbar-dark) !important;
    }

    /* "full" */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="full"][data-is-home="true"]>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="full"][data-is-home="true"]>div {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* "semifull" (static) */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"][data-is-home="true"]>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"][data-is-home="true"]>div {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* "semifull" (scrolled) */
    :root.dark #wallpaper-wrapper~* #navbar[data-transparent-mode="semifull"][data-is-home="true"].scrolled>div,
    :root.dark body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"][data-is-home="true"].scrolled>div {
        background: rgba(0, 0, 0, var(--opacity-55)) !important;
        border: 1px solid rgba(0, 0, 0, var(--opacity-55)) !important;
        box-shadow: var(--shadow-navbar-dark) !important;
    }
}


/* ============================================
 * 关闭毛玻璃模糊效果 - Banner模式
 * ============================================ */
body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semi"][data-enable-blur="false"]>div,
body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semi"][data-enable-blur="false"].scrolled>div {
    backdrop-filter: none !important;
}

body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="full"][data-enable-blur="false"]>div,
body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="full"][data-enable-blur="false"].scrolled>div {
    backdrop-filter: none !important;
}

body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"][data-enable-blur="false"]>div,
body:has(#wallpaper-wrapper) #navbar[data-transparent-mode="semifull"][data-enable-blur="false"].scrolled>div {
    backdrop-filter: none !important;
}


/* 调整下拉菜单和浮动面板的背景透明度 */
/* 亮色主题 */
#wallpaper-wrapper~* .dropdown-content,
#wallpaper-wrapper~* .float-panel,
body:has(#wallpaper-wrapper) .dropdown-content,
body:has(#wallpaper-wrapper) .float-panel,
body.wallpaper-transparent .dropdown-content,
body.wallpaper-transparent .float-panel {
    background: rgba(255, 255, 255, 0.95) !important;
    box-shadow: var(--shadow-md) !important;
    border: 1px solid rgba(0, 0, 0, 0.05) !important;
}

/* 暗色主题 */
:root.dark #wallpaper-wrapper~* .dropdown-content,
:root.dark #wallpaper-wrapper~* .float-panel,
:root.dark body:has(#wallpaper-wrapper) .dropdown-content,
:root.dark body:has(#wallpaper-wrapper) .float-panel,
:root.dark body.wallpaper-transparent .dropdown-content,
:root.dark body.wallpaper-transparent .float-panel {
    background: rgba(23, 23, 23, 0.95) !important;
    box-shadow: var(--shadow-md) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

/* ============================================
 * 全宽导航栏适配 (Full Width Navbar)
 * 确保在开启全宽模式时覆盖所有圆角和宽度限制
 * 针对所有模式（Banner模式、壁纸模式、透明模式）统一去除圆角
 * 使用高优先级选择器确保覆盖原主题样式
 * 仅在桌面端 (min-width: 1024px) 生效，移动端保留圆角
 * ============================================ */
@media (min-width: 1024px) {
    #navbar-wrapper #navbar[data-full-width="true"] > div,
    body:has(#wallpaper-wrapper) #navbar-wrapper #navbar[data-full-width="true"] > div,
    body.wallpaper-transparent #navbar-wrapper #navbar[data-full-width="true"] > div,
    #navbar-wrapper #navbar[data-full-width="true"].scrolled > div {
        border-radius: 0 !important;
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
    }
}

/* ============================================
 * 小于1200px时隐藏导航栏菜单图标
 * ============================================ */
@media (max-width: 1199px) {
    .navbar-icon {
        display: none !important;
    }
}
</file>

<file path="styles/photoswipe.css">
@reference "tailwindcss";

/* PhotoSwipe 按钮样式 */
.pswp__button {
    transition: all 0.2s ease !important;
    background-color: rgba(0, 0, 0, 0.4) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin-right: 0 !important;
    width: 3rem !important;
    height: 3rem !important;
}
.pswp__button:hover {
    background-color: rgba(0, 0, 0, 0.5) !important;
}
.pswp__button:active {
    background-color: rgba(0, 0, 0, 0.6) !important;
}
.pswp__button--zoom, .pswp__button--close {
    margin-top: 1rem !important;
    border-radius: 0.75rem !important;
}
.pswp__button--zoom:active, .pswp__button--close:active {
    transform: scale(0.9) !important;
}
.pswp__button--zoom {
    margin-right: 0.625rem !important;
}
.pswp__button--close {
    margin-right: 1rem !important;
}
</file>

<file path="styles/scrollbar.css">
.scrollbar-base.os-scrollbar {
  transition:
    width 0.15s ease-in-out,
    height 0.15s ease-in-out,
    opacity 0.15s,
    visibility 0.15s,
    top 0.15s,
    right 0.15s,
    bottom 0.15s,
    left 0.15s;
  pointer-events: unset;
}

.scrollbar-base.os-scrollbar.os-scrollbar-horizontal {
  padding-top: 4px;
  padding-bottom: 4px;
  height: 16px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-horizontal
  .os-scrollbar-track
  .os-scrollbar-handle {
  height: 4px;
  border-radius: 4px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-horizontal:hover
  .os-scrollbar-track
  .os-scrollbar-handle {
  height: 8px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-horizontal.px-2 {
  padding-left: 8px;
  padding-right: 8px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-vertical {
  padding-left: 4px;
  padding-right: 4px;
  width: 16px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-vertical
  .os-scrollbar-track
  .os-scrollbar-handle {
  width: 4px;
  border-radius: 4px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-vertical:hover
  .os-scrollbar-track
  .os-scrollbar-handle {
  width: 8px;
}

.scrollbar-base.os-scrollbar.os-scrollbar-vertical.py-1 {
  padding-top: 4px;
  padding-bottom: 4px;
}

:root {
  --os-handle-bg-custom: rgba(0, 0, 0, 0.3);
  --os-handle-bg-custom-hover: rgba(0, 0, 0, 0.5);
  --os-handle-bg-custom-active: rgba(0, 0, 0, 0.6);
}

:root.dark {
  --os-handle-bg-custom: rgba(255, 255, 255, 0.4);
  --os-handle-bg-custom-hover: rgba(255, 255, 255, 0.6);
  --os-handle-bg-custom-active: rgba(255, 255, 255, 0.7);
}

.scrollbar-auto.os-scrollbar {
  --os-handle-bg: var(--os-handle-bg-custom);
  --os-handle-bg-hover: var(--os-handle-bg-custom-hover);
  --os-handle-bg-active: var(--os-handle-bg-custom-active);
}

.scrollbar-dark.os-scrollbar {
  --os-handle-bg: rgba(255, 255, 255, 0.4);
  --os-handle-bg-hover: rgba(255, 255, 255, 0.6);
  --os-handle-bg-active: rgba(255, 255, 255, 0.7);
}
</file>

<file path="styles/toc.css">
/* TOC 共享样式 */

/* TOC 滚动容器 */
.toc-scroll-container {
	overflow-y: auto;
	overflow-x: hidden;
	-webkit-overflow-scrolling: touch;
	scroll-behavior: smooth;
}

/* TOC 内容容器 */
.toc-content {
	display: flex;
	flex-direction: column;
	gap: 2px;
	position: relative;
	overflow: visible;
	width: 100%;
	max-width: 100%;
	box-sizing: border-box;
	contain: layout;
	align-items: flex-start;
}

/* TOC 链接样式 */
.toc-content a {
	display: flex;
	align-items: center;
	text-decoration: none;
	color: inherit;
	border-radius: 0.75rem;
	transition: all 0.2s ease;
	width: 100%;
	min-width: 0;
	flex-shrink: 0;
	max-width: 100%;
	overflow: hidden;
	box-sizing: border-box;
	position: relative;
}

.toc-content a:hover {
	background: var(--toc-btn-hover);
}

/* 文本内容防溢出 */
.toc-content a div:last-child {
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	min-width: 0;
	flex: 1;
	max-width: calc(100% - 2rem);
	box-sizing: border-box;
}

/* 徽章容器固定宽度 */
.toc-content a div:first-child {
	flex-shrink: 0;
	width: 1.25rem;
	height: 1.25rem;
}

/* 活动指示器基础样式 */
.toc-active-indicator {
	position: absolute;
	left: 0;
	right: 0;
	background: var(--toc-btn-hover);
	border-radius: 0.75rem;
	transition: all 0.2s ease;
	z-index: -1;
}
</file>

<file path="styles/transition.css">
/* ==========================================================================
   Page Transition Animations (Swup) & Global Animations
   ========================================================================== */

/* --------------------------------------------------------------------------
   1. Swup Page Transitions
   -------------------------------------------------------------------------- */

/* Main Content Transition */
.transition-main {
    transition: 
        opacity 120ms cubic-bezier(0.25, 0.46, 0.45, 0.94),
        transform 120ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Leaving Animation */
.transition-leaving {
    transition:
        transform 120ms cubic-bezier(0.55, 0.055, 0.675, 0.19),
        opacity 120ms cubic-bezier(0.55, 0.055, 0.675, 0.19);
}

/* State: Changing (Swup) */
html.is-changing .transition-main {
    transition: 
        opacity 120ms cubic-bezier(0.25, 0.46, 0.45, 0.94),
        transform 120ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

html.is-leaving .transition-main {
    transition: 
        opacity 120ms cubic-bezier(0.55, 0.055, 0.675, 0.19),
        transform 120ms cubic-bezier(0.55, 0.055, 0.675, 0.19);
}

/* State: Animating (Entering) */
html.is-animating .transition-main {
    opacity: 0;
    transform: translateY(1.5rem) translateX(0.5rem);
}

/* State: Leaving */
html.is-animating.is-leaving .transition-leaving {
    transform: translateY(-1rem) translateX(-0.5rem);
    opacity: 0;
}

/* Swup Fade Fallback */
html.is-changing .transition-swup-fade {
    transition: all 120ms ease-out;
}

html.is-animating .transition-swup-fade {
    opacity: 0;
    transform: translateY(1.5rem);
}

/* --------------------------------------------------------------------------
   2. Keyframes
   -------------------------------------------------------------------------- */

@keyframes fade-in-up {
    from {
        opacity: 0;
        transform: translateY(1.5rem) translateX(0.5rem);
    }
    to {
        opacity: 1;
        transform: translateY(0) translateX(0);
    }
}

/* --------------------------------------------------------------------------
   3. Onload Animations
   -------------------------------------------------------------------------- */

.onload-animation {
    opacity: 0;
    animation: fade-in-up 120ms ease-out forwards;
}

/* 渐进式动画延迟 */
.onload-animation:nth-child(1) { animation-delay: 0ms; }
.onload-animation:nth-child(2) { animation-delay: 30ms; }
.onload-animation:nth-child(3) { animation-delay: 60ms; }
.onload-animation:nth-child(4) { animation-delay: 90ms; }
.onload-animation:nth-child(5) { animation-delay: 120ms; }

/* --------------------------------------------------------------------------
   4. Navigation Progress Bar
   -------------------------------------------------------------------------- */

#progress-bar {
    --progress-height: 3px;
    --progress-duration: 8s;

    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: var(--progress-height);
    z-index: 9999;
    pointer-events: none;
    background: var(--primary);
    box-shadow: 0 0 8px color-mix(in oklch, var(--primary) 60%, transparent);
    opacity: 0;
}

@keyframes progress-loading {
    0% { width: 0; }
    100% { width: 95%; }
}

#progress-bar.loading {
    opacity: 1;
    width: 0;
    animation: progress-loading var(--progress-duration) cubic-bezier(0.1, 0.05, 0.1, 1) forwards;
}

#progress-bar.finishing {
    animation: none;
    width: 100%;
    opacity: 1;
    transition: width 200ms ease-out;
}

#progress-bar.done {
    width: 100%;
    opacity: 0;
    transition: opacity 300ms ease-out;
}
</file>

<file path="styles/twikoo.css">
@reference "tailwindcss";

:root {
  --tk-text: black;
  --code-block-text: #333; /* 调整为深色但在浅色背景下仍然舒适的值 */
}

html.dark {
  --tk-text: #d1d5db;
  --code-block-text: #d1d5db; /* 在深色模式下使用更亮的颜色 */
}

.tk-comments {
  @apply text-(--tk-text);
}

.tk-submit {
  .tk-avatar {
    @apply hidden;
  }
}

/* Text Area */
.tk-row {
  .tk-col {
    @apply flex-col-reverse;
    .tk-input {
      textarea {
        @apply rounded-(--radius-large) py-4 px-6 min-h-[150px]! focus:border-(--primary)
               border-(--line-divider) bg-(--card-bg) text-(--btn-content)
               placeholder:text-(--content-meta) transition-all duration-300
               focus:ring-2 focus:ring-(--primary)/20;
        resize: vertical;
      }
    }
  }
}

/* 表情和图片按钮位置调整 */
.tk-row .tk-col .tk-actions {
  @apply order-1 mt-4 mb-2 flex gap-2;
}

.tk-row .tk-col .tk-meta-input {
  @apply order-2;
}

/* 表情和图片按钮样式优化 */
.tk-owo,
.tk-upload {
  @apply rounded-lg p-2 hover:bg-(--btn-plain-bg-hover) transition-colors duration-200
         border border-(--line-divider) bg-(--card-bg) text-(--btn-content)
         hover:border-(--primary) hover:shadow-xs;
}

.tk-owo:hover,
.tk-upload:hover {
  @apply bg-(--btn-plain-bg-hover) border-(--primary) shadow-xs;
}

/* Meta */
.tk-meta-input {
  @apply relative mt-4;
  div {
    @apply min-h-12 rounded-lg border border-(--line-divider) bg-(--card-bg) overflow-hidden
           hover:border-(--primary) hover:shadow-xs transition-all duration-200 flex items-center;

    .el-input-group__prepend {
      @apply bg-(--btn-regular-bg)! text-(--btn-content)! px-4 font-medium text-sm
             border-r border-(--line-divider) flex items-center justify-center min-w-[80px] shrink-0
             rounded-l-lg rounded-r-none;
      min-height: inherit;
    }

    input {
      @apply px-4 bg-transparent text-(--btn-content) placeholder:text-(--content-meta)
             focus:!border-(--primary) transition-all duration-200 flex-1
             rounded-r-lg rounded-l-none;
      min-height: inherit;

      &::placeholder {
        @apply text-(--content-meta) opacity-70;
      }

      &:focus {
        @apply outline-hidden;
      }
    }

    &:focus-within {
      @apply border-(--primary) shadow-md;
    }
  }
}

/* Button */
.tk-row.actions {
  @apply w-full ml-0! mt-6! flex gap-3 justify-end;
  .__markdown {
    @apply !hidden;
  }
  .tk-send,
  .tk-cancel {
    @apply border-none rounded-lg px-6 py-2 h-10 font-medium transition-all duration-300
           bg-(--btn-regular-bg)! hover:bg-(--btn-regular-bg-hover)!
           active:bg-(--btn-regular-bg-active)! disabled:bg-(--btn-regular-bg)!
           text-(--btn-content)! disabled:text-(--content-meta)!
           hover:scale-105 active:scale-95 shadow-xs hover:shadow-md;
  }
}

/* 隐藏预览按钮 */
.tk-preview {
  display: none !important;
}

/* 强制统一按钮样式 */
.tk-send,
.tk-cancel {
  background: var(--btn-regular-bg) !important;
  color: var(--btn-content) !important;
  border: none !important;
  border-radius: 0.5rem !important;
  padding: 0.5rem 1.5rem !important;
  height: 2.5rem !important;
  font-weight: 500 !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
}

.tk-send:hover,
.tk-cancel:hover {
  background: var(--btn-regular-bg-hover) !important;
  transform: scale(1.05) !important;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
}

.tk-send:active,
.tk-cancel:active {
  background: var(--btn-regular-bg-active) !important;
  transform: scale(0.95) !important;
}

.tk-send:disabled,
.tk-cancel:disabled {
  background: var(--btn-regular-bg) !important;
  color: var(--content-meta) !important;
  transform: none !important;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
}

/* Comment title */
.tk-comments-title {
  @apply hidden; /* 隐藏默认标题，使用自定义标题 */

  .__comments svg {
    @apply fill-(--primary);
  }
}

.tk-comment {
  @apply border-[1px] border-(--line-divider) p-4 rounded-2xl hover:shadow-lg hover:border-(--primary) transition-all duration-300;
  background: linear-gradient(135deg, var(--card-bg) 0%, rgba(var(--primary), 0.02) 100%);

  .tk-action-icon {
    @apply text-(--primary)!;
    
    svg {
      @apply fill-(--primary) hover:scale-110 transition-transform duration-200;
    }
  }

  .tk-action-count {
    @apply text-(--primary)!;
  }

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    z-index: 2;
  }
}

.tk-meta {
  .tk-tag {
    @apply border-none rounded-lg text-(--btn-content);
  }

  .tk-tag-green {
    @apply bg-(--btn-regular-bg) dark:bg-(--primary) dark:text-(--deep-text);
  }
}

/* Content & Preview */
.tk-content,
.tk-preview-container {
  /* by @microsic
    Make the picture type emoticons display without wrapping
  */
  img {
    @apply inline align-bottom!;
  }

  a {
    @apply underline text-(--primary) font-medium;
  }

  .tk-ruser {
    @apply no-underline;
  }

  :not(pre) > code {
    @apply bg-(--inline-code-bg) rounded-md text-(--inline-code-color) px-1 py-0.5 font-semibold;
  }

  li {
    @apply before:content-["•"] before:text-(--primary);
  }
}

/* Replies */
.tk-replies {


  .tk-comment {
    @apply border-l-4 border-l-(--btn-regular-bg)/30 p-3 hover:border-(--primary) transition-all duration-300;
    .tk-content {
      > span:first-of-type {
        @apply text-xs text-(--content-meta);
      }
    }
  }

  /* 回复层级指示器 */
  &::before {
    content: '';
    @apply absolute left-0 top-0 w-0.5 h-full bg-gradient-to-b  to-transparent opacity-30;
  }
}

.twikoo .code-block {
  pre {
    @apply rounded-xl!;
  }

  /* Code block fall back */
  pre:not([class]) {
    @apply bg-(--codeblock-bg) overflow-auto p-2 text-(--code-block-text);
  }

  .copy-btn-icon {
    width: inherit !important;
    height: inherit !important;
  }
}

.tk-expand-wrap .tk-expand,
.tk-collapse-wrap .tk-expand {
  @apply border-[1px] border-(--line-divider) rounded-lg mt-1 bg-(--btn-regular-bg) text-(--btn-content) hover:text-(--primary) hover:bg-(--btn-regular-bg-hover);
}

/* by @SirTamago
Make the emoji component display correctly when there are too many emoji packs
*/
.card-base {
  overflow: visible;
}

/* 防止 Twikoo 操作时的意外滚动 */
.tk-action-icon,
.tk-owo,
.tk-submit,
.tk-cancel,
.tk-admin,
.tk-delete,
.tk-edit {
  cursor: pointer;
  transition: all 0.2s ease;
}

/* 确保点击区域足够大 */
.tk-action {
  min-height: 24px;
  display: flex;
  align-items: center;
}

/* 防止表单提交时的意外跳转 */
.tk-submit-wrapper {
  position: relative;
}

/* 管理面板样式优化 */
.tk-admin-panel {
  position: relative;
  z-index: 100;
}



.el-loading-spinner {
  display: flex !important;
  justify-content: center !important;

}

/* Transparent Mode Adaption */
body.wallpaper-transparent .tk-input textarea,
body.wallpaper-transparent .tk-meta-input div,
body.wallpaper-transparent .tk-owo,
body.wallpaper-transparent .tk-upload,
body.wallpaper-transparent .tk-expand-wrap .tk-expand,
body.wallpaper-transparent .tk-collapse-wrap .tk-expand {
  background-color: var(--card-bg-transparent) !important;
}
</file>

<file path="styles/variables.styl">
/* ===== 基础变量定义 ===== */
:root
  --radius-large: 1rem
  --content-delay: 150ms

/* ===== 主题相关变量 ===== */
:root
  --primary: oklch(0.70 0.14 var(--hue))
  --page-bg: oklch(0.95 0.01 var(--hue))
  --card-bg: white
  --card-bg-transparent: rgba(255, 255, 255, 0.6)
  
  --btn-content: oklch(0.55 0.12 var(--hue))
  --btn-regular-bg: oklch(0.95 0.025 var(--hue))
  --btn-regular-bg-hover: oklch(0.9 0.05 var(--hue))
  --btn-regular-bg-active: oklch(0.85 0.08 var(--hue))
  
  --btn-plain-bg-hover: oklch(0.95 0.025 var(--hue))
  --btn-plain-bg-active: oklch(0.98 0.01 var(--hue))
  
  --btn-card-bg-hover: oklch(0.98 0.005 var(--hue))
  --btn-card-bg-active: oklch(0.9 0.03 var(--hue))
  
  --enter-btn-bg: var(--btn-regular-bg)
  --enter-btn-bg-hover: var(--btn-regular-bg-hover)
  --enter-btn-bg-active: var(--btn-regular-bg-active)
  
  --deep-text: oklch(0.25 0.02 var(--hue))
  --title-active: oklch(0.6 0.1 var(--hue))
  
  --line-divider: rgba(0, 0, 0, 0.08)
  --line-color: rgba(0, 0, 0, 0.1)
  --meta-divider: rgba(0, 0, 0, 0.2)
  --content-meta: rgba(0, 0, 0, 0.7)
  
  --inline-code-bg: var(--btn-regular-bg)
  --inline-code-color: var(--btn-content)
  --selection-bg: oklch(0.90 0.05 var(--hue))
  --codeblock-bg: oklch(0.17 0.015 var(--hue))
  --codeblock-topbar-bg: oklch(0.3 0.02 var(--hue))
  
  --license-block-bg: rgba(0, 0, 0, 0.03)
  
  --link-underline: oklch(0.93 0.04 var(--hue))
  --link-hover: oklch(0.95 0.025 var(--hue))
  --link-active: oklch(0.90 0.05 var(--hue))
  
  --float-panel-bg: white
  
  --scrollbar-bg-light: rgba(0, 0, 0, 0.4)
  --scrollbar-bg-hover-light: rgba(0, 0, 0, 0.5)
  --scrollbar-bg-active-light: rgba(0, 0, 0, 0.6)
  
  --scrollbar-bg-dark: rgba(255, 255, 255, 0.4)
  --scrollbar-bg-hover-dark: rgba(255, 255, 255, 0.5)
  --scrollbar-bg-active-dark: rgba(255, 255, 255, 0.6)
  
  --scrollbar-bg: var(--scrollbar-bg-light)
  --scrollbar-bg-hover: var(--scrollbar-bg-hover-light)
  --scrollbar-bg-active: var(--scrollbar-bg-active-light)
  
  --display-light-icon: 1
  --display-dark-icon: 0
  
  --admonitions-color-tip: oklch(0.7 0.14 180)
  --admonitions-color-note: oklch(0.7 0.14 250)
  --admonitions-color-important: oklch(0.7 0.14 310)
  --admonitions-color-warning: oklch(0.7 0.14 60)
  --admonitions-color-caution: oklch(0.6 0.2 25)
  
  /* TOC相关变量 */
  --toc-badge-bg: oklch(0.9 0.045 var(--hue))
  --toc-btn-hover: oklch(0.92 0.015 var(--hue))
  --toc-btn-active: oklch(0.90 0.015 var(--hue))
  --toc-width: calc((100vw - var(--page-width)) / 2 - 1rem)
  --toc-item-active: oklch(0.70 0.13 var(--hue))
  
  /* 主题色选择条渐变 */
  --color-selection-bar: linear-gradient(to right, oklch(0.80 0.10 0), oklch(0.80 0.10 30), oklch(0.80 0.10 60), oklch(0.80 0.10 90), oklch(0.80 0.10 120), oklch(0.80 0.10 150), oklch(0.80 0.10 180), oklch(0.80 0.10 210), oklch(0.80 0.10 240), oklch(0.80 0.10 270), oklch(0.80 0.10 300), oklch(0.80 0.10 330), oklch(0.80 0.10 360))

/* 暗色主题变量 */
:root.dark
  --primary: oklch(0.75 0.14 var(--hue))
  --page-bg: oklch(0.16 0.014 var(--hue))
  --card-bg: oklch(0.23 0.015 var(--hue))
  --card-bg-transparent: rgba(23, 23, 23, 0.6)
  
  --btn-content: oklch(0.75 0.1 var(--hue))
  --btn-regular-bg: oklch(0.33 0.035 var(--hue))
  --btn-regular-bg-hover: oklch(0.38 0.04 var(--hue))
  --btn-regular-bg-active: oklch(0.43 0.045 var(--hue))
  
  --btn-plain-bg-hover: oklch(0.30 0.035 var(--hue))
  --btn-plain-bg-active: oklch(0.27 0.025 var(--hue))
  
  --btn-card-bg-hover: oklch(0.3 0.03 var(--hue))
  --btn-card-bg-active: oklch(0.35 0.035 var(--hue))
  
  --line-divider: rgba(255, 255, 255, 0.08)
  --line-color: rgba(255, 255, 255, 0.1)
  --meta-divider: rgba(255, 255, 255, 0.2)
  --content-meta: rgba(255, 255, 255, 0.6)
  
  --selection-bg: oklch(0.40 0.08 var(--hue))
  --codeblock-bg: oklch(0.17 0.015 var(--hue))
  --codeblock-topbar-bg: oklch(0.12 0.015 var(--hue))
  
  --license-block-bg: var(--codeblock-bg)
  
  --link-underline: oklch(0.40 0.08 var(--hue))
  --link-hover: oklch(0.40 0.08 var(--hue))
  --link-active: oklch(0.35 0.07 var(--hue))
  
  --float-panel-bg: oklch(0.19 0.015 var(--hue))
  
  --scrollbar-bg: var(--scrollbar-bg-dark)
  --scrollbar-bg-hover: var(--scrollbar-bg-hover-dark)
  --scrollbar-bg-active: var(--scrollbar-bg-active-dark)
  
  --display-light-icon: 0
  --display-dark-icon: 1
  
  --admonitions-color-tip: oklch(0.75 0.14 180)
  --admonitions-color-note: oklch(0.75 0.14 250)
  --admonitions-color-important: oklch(0.75 0.14 310)
  --admonitions-color-warning: oklch(0.75 0.14 60)
  --admonitions-color-caution: oklch(0.65 0.2 25)
  
  /* TOC相关变量 - 暗色主题 */
  --toc-badge-bg: var(--btn-regular-bg)
  --toc-btn-hover: oklch(0.28 0.04 var(--hue))
  --toc-btn-active: oklch(0.32 0.05 var(--hue))
  --toc-item-active: oklch(0.35 0.07 var(--hue))
  
  /* 主题色选择条渐变 - 暗色主题 */
  --color-selection-bar: linear-gradient(to right, oklch(0.70 0.10 0), oklch(0.70 0.10 30), oklch(0.70 0.10 60), oklch(0.70 0.10 90), oklch(0.70 0.10 120), oklch(0.70 0.10 150), oklch(0.70 0.10 180), oklch(0.70 0.10 210), oklch(0.70 0.10 240), oklch(0.70 0.10 270), oklch(0.70 0.10 300), oklch(0.70 0.10 330), oklch(0.70 0.10 360))

/* ===== 响应式断点变量 ===== */
:root
  /* 断点定义 */
  --breakpoint-xs: 320px
  --breakpoint-sm: 480px
  --breakpoint-md: 768px
  --breakpoint-lg: 1024px
  --breakpoint-xl: 1280px
  --breakpoint-2xl: 1536px
  
  /* 容器宽度 */
  --container-xs: 100%
  --container-sm: 100%
  --container-md: 100%
  --container-lg: 1024px
  --container-xl: 1280px
  --container-2xl: 1536px

/* ===== 动画变量 ===== */
:root
  /* 缓动函数 */
  --ease-standard: cubic-bezier(0.4, 0, 0.2, 1)
  --ease-decelerate: cubic-bezier(0.25, 0.46, 0.45, 0.94)
  --ease-accelerate: cubic-bezier(0.55, 0.055, 0.675, 0.19)
  --ease-sharp: cubic-bezier(0.4, 0, 0.6, 1)
  
  /* 动画时长 */
  --duration-fast: 100ms
  --duration-normal: 150ms
  --duration-medium: 200ms
  --duration-slow: 250ms
  --duration-slower: 300ms
  
  /* 动画延迟 */
  --delay-none: 0ms
  --delay-short: 30ms
  --delay-medium: 60ms
  --delay-long: 90ms
  --delay-longer: 120ms

/* ===== 间距变量 ===== */
:root
  /* 基础间距 */
  --spacing-xs: 0.25rem    /* 4px */
  --spacing-sm: 0.5rem     /* 8px */
  --spacing-md: 0.75rem    /* 12px */
  --spacing-lg: 1rem       /* 16px */
  --spacing-xl: 1.25rem    /* 20px */
  --spacing-2xl: 1.5rem    /* 24px */
  --spacing-3xl: 2rem      /* 32px */
  --spacing-4xl: 2.5rem    /* 40px */
  --spacing-5xl: 3rem      /* 48px */
  
  /* 组件间距 */
  --widget-gap-mobile: var(--spacing-md)
  --widget-gap-tablet: var(--spacing-lg)
  --widget-gap-desktop: var(--spacing-xl)
  
  /* 侧边栏宽度 */
  --sidebar-width-mobile: 100%
  --sidebar-width-tablet: 280px
  --sidebar-width-desktop: 320px

/* ===== 阴影变量 ===== */
:root
  /* 基础阴影 */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05)
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1)
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1)
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1)
  --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.25)
  
  /* 特殊阴影 */
  --shadow-navbar: 0 4px 16px rgba(0, 0, 0, 0.1)
  --shadow-navbar-dark: 0 4px 16px rgba(0, 0, 0, 0.2)
  --shadow-button: 0 4px 12px rgba(0, 0, 0, 0.15)
  --shadow-button-dark: 0 4px 12px rgba(255, 255, 255, 0.1)

/* ===== 边框半径变量 ===== */
:root
  --radius-sm: 0.25rem     /* 4px */
  --radius-md: 0.375rem    /* 6px */
  --radius-lg: 0.5rem      /* 8px */
  --radius-xl: 0.75rem     /* 12px */
  --radius-2xl: 1rem       /* 16px */
  --radius-3xl: 1.5rem     /* 24px */
  --radius-full: 9999px

/* ===== 透明度变量 ===== */
:root
  --opacity-0: 0
  --opacity-5: 0.05
  --opacity-10: 0.1
  --opacity-20: 0.2
  --opacity-25: 0.25
  --opacity-30: 0.3
  --opacity-40: 0.4
  --opacity-50: 0.5
  --opacity-55: 0.55
  --opacity-60: 0.6
  --opacity-70: 0.7
  --opacity-75: 0.75
  --opacity-80: 0.8
  --opacity-85: 0.85
  --opacity-90: 0.9
  --opacity-95: 0.95
  --opacity-100: 1

/* ===== 模糊效果变量 ===== */
:root
  --blur-sm: 4px
  --blur-md: 8px
  --blur-lg: 12px
  --blur-xl: 16px
  --blur-2xl: 20px
  --blur-3xl: 24px

/* ===== 变换变量 ===== */
:root
  /* 平移 */
  --translate-xs: 0.125rem   /* 2px */
  --translate-sm: 0.25rem     /* 4px */
  --translate-md: 0.5rem      /* 8px */
  --translate-lg: 0.75rem     /* 12px */
  --translate-xl: 1rem        /* 16px */
  --translate-2xl: 1.5rem      /* 24px */
  --translate-3xl: 2rem       /* 32px */
  
  /* 缩放 */
  --scale-95: 0.95
  --scale-98: 0.98
  --scale-100: 1
  --scale-105: 1.05
  --scale-110: 1.1

/* ===== 层级变量 ===== */
:root
  --z-dropdown: 1000
  --z-sticky: 1020
  --z-fixed: 1030
  --z-modal-backdrop: 1040
  --z-modal: 1050
  --z-popover: 1060
  --z-tooltip: 1070
  --z-toast: 1080
  --z-navbar: 20
  --z-banner: 10
  --z-content: 30

/* ===== 性能优化变量 ===== */
:root
  /* GPU加速 */
  --gpu-transform: translateZ(0)
  --gpu-backface: hidden
  
  /* 动画性能 */
  --animation-fill-mode: both
  --animation-timing: var(--ease-standard)
  --animation-duration: var(--duration-medium)

/* ===== 响应式工具类 ===== */
@media (max-width: 767px)
  :root
    --container-width: var(--container-sm)
    --widget-gap: var(--widget-gap-mobile)
    --sidebar-width: var(--sidebar-width-mobile)

@media (min-width: 768px) and (max-width: 1279px)
  :root
    --container-width: var(--container-md)
    --widget-gap: var(--widget-gap-tablet)
    --sidebar-width: var(--sidebar-width-tablet)

@media (min-width: 1280px)
  :root
    --container-width: var(--container-lg)
    --widget-gap: var(--widget-gap-desktop)
    --sidebar-width: var(--sidebar-width-desktop)
</file>

<file path="styles/waves.css">
/* Water waves animation */
.waves > .parallax use {
animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
transform: translateZ(0);
will-change: transform;
backface-visibility: hidden;
}

.waves > .parallax use:nth-child(1) {
animation-delay: -2s;
animation-duration: 7s;
}

.waves > .parallax use:nth-child(2) {
animation-delay: -3s;
animation-duration: 10s;
}

.waves > .parallax use:nth-child(3) {
animation-delay: -4s;
animation-duration: 13s;
}

.waves > .parallax use:nth-child(4) {
animation-delay: -5s;
animation-duration: 20s;
}

@keyframes wave {
0% {
transform: translate3d(-90px, 0, 0);
}
100% {
transform: translate3d(85px, 0, 0);
}
}

.waves {
contain: none;
}
</file>

<file path="styles/widget-responsive.css">
/**
 * 组件响应式布局样式
 * Widget Responsive Layout Styles
 */

/* CSS 自定义属性定义 */
:root {
  /* 断点变量 */
  --breakpoint-mobile: 768px;
  --breakpoint-tablet: 1024px;
  --breakpoint-desktop: 1025px;
  
  /* 间距变量 */
  --widget-gap-mobile: 0.75rem;
  --widget-gap-tablet: 1rem;
  --widget-gap-desktop: 1.25rem;
  
  /* 动画变量 */
  --widget-animation-duration: 0.3s;
  --widget-animation-timing: ease-in-out;
  
  /* 侧边栏宽度 */
  --sidebar-width-mobile: 100%;
  --sidebar-width-tablet: 280px;
  --sidebar-width-desktop: 320px;
  
  /* 组件最小高度 */
  --widget-min-height: 60px;
  --widget-max-height-mobile: 200px;
  --widget-max-height-tablet: 300px;
  --widget-max-height-desktop: 400px;
}

/* 基础侧边栏样式 */
#dynamic-sidebar {
  width: var(--sidebar-width-desktop);
  transition: all var(--widget-animation-duration) var(--widget-animation-timing);
  position: relative;
}

/* 组件容器基础样式 */
.widget-container {
  min-height: var(--widget-min-height);
  transition: all var(--widget-animation-duration) var(--widget-animation-timing);
  overflow: hidden;
}

/* 组件悬停效果 */
.widget-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.widget-container.widget-hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* 移动端样式 (< 768px) */
@media (max-width: 767px) {
  #dynamic-sidebar {
    width: var(--sidebar-width-mobile);
    padding: 0.5rem;
  }
  
  .sidebar-top-section,
  .sidebar-sticky-section {
    gap: var(--widget-gap-mobile);
  }
  
  .widget-container {
    max-height: var(--widget-max-height-mobile);
  }
  
  /* 移动端隐藏的组件 */
  .widget-container[data-mobile-hidden="true"] {
    display: none;
  }
  
  /* 移动端特殊布局 */
  .sidebar-sticky-section {
    position: static !important;
    top: auto !important;
  }
  
  /* 移动端组件简化显示 */
  .widget-container[data-widget-type="announcement"] {
    order: -1; /* 公告优先显示 */
  }
  
  .widget-container[data-widget-type="categories"],
  .widget-container[data-widget-type="tags"] {
    /* 分类和标签在移动端可折叠 */
    max-height: 120px;
    overflow-y: auto;
  }
}

/* 平板端样式 (768px - 1023px) */
@media (min-width: 768px) and (max-width: 1023px) {
  #dynamic-sidebar {
    width: var(--sidebar-width-tablet);
    padding: 0.75rem;
  }
  
  .sidebar-top-section,
  .sidebar-sticky-section {
    gap: var(--widget-gap-tablet);
  }
  
  .widget-container {
    max-height: var(--widget-max-height-tablet);
  }
  
  /* 平板端隐藏的组件 */
  .widget-container[data-tablet-hidden="true"] {
    display: none;
  }
  

}

/* 桌面端样式 (>= 1024px) */
@media (min-width: 1024px) {
  #dynamic-sidebar {
    width: var(--sidebar-width-desktop);
    padding: 1rem;
  }
  
  .sidebar-top-section,
  .sidebar-sticky-section {
    gap: var(--widget-gap-desktop);
  }
  
  .widget-container {
    max-height: var(--widget-max-height-desktop);
  }
  
  /* 桌面端隐藏的组件 */
  .widget-container[data-desktop-hidden="true"] {
    display: none;
  }
  
  /* 桌面端增强效果 */
  .widget-container:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }
}

/* 超宽屏样式 (> 1440px) */
@media (min-width: 1441px) {
  #dynamic-sidebar {
    width: 360px;
  }
  
  .widget-container {
    max-height: 500px;
  }
}

/* 组件位置特定样式 */
.sidebar-top-section {
  /* 顶部组件区域 */
  margin-bottom: 1rem;
}

.sidebar-sticky-section {
  /* 粘性组件区域 */
  position: sticky;
  top: 1rem;
  z-index: 10;
}

/* 组件类型特定的响应式样式 */

/* Profile 组件 */
.widget-container[data-widget-type="profile"] {
  /* 用户资料组件始终保持固定高度 */
  min-height: 120px;
}

@media (max-width: 767px) {
  .widget-container[data-widget-type="profile"] {
    min-height: 100px;
  }
}

/* Announcement 组件 */
.widget-container[data-widget-type="announcement"] {
  /* 公告组件可以动态调整高度 */
  min-height: 80px;
}

@media (max-width: 767px) {
  .widget-container[data-widget-type="announcement"] {
    min-height: 60px;
    font-size: 0.875rem;
  }
}

/* Categories 和 Tags 组件 */
.widget-container[data-widget-type="categories"],
.widget-container[data-widget-type="tags"] {
  /* 分类和标签组件支持滚动 */
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
}

.widget-container[data-widget-type="categories"]::-webkit-scrollbar,
.widget-container[data-widget-type="tags"]::-webkit-scrollbar {
  width: 4px;
}

.widget-container[data-widget-type="categories"]::-webkit-scrollbar-track,
.widget-container[data-widget-type="tags"]::-webkit-scrollbar-track {
  background: transparent;
}

.widget-container[data-widget-type="categories"]::-webkit-scrollbar-thumb,
.widget-container[data-widget-type="tags"]::-webkit-scrollbar-thumb {
  background-color: rgba(156, 163, 175, 0.5);
  border-radius: 2px;
}

/* TOC 组件 */
.widget-container[data-widget-type="toc"] {
  /* 目录组件在移动端隐藏 */
  max-height: 400px;
  overflow-y: auto;
}

@media (max-width: 767px) {
  .widget-container[data-widget-type="toc"] {
    display: none;
  }
}



/* 动画效果 */

/* 淡入动画 */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 滑入动画 */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* 缩放动画 */
@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* 动画类 */
.widget-animation-fade {
  animation: fadeIn var(--widget-animation-duration) var(--widget-animation-timing) forwards;
}

.widget-animation-slide {
  animation: slideIn var(--widget-animation-duration) var(--widget-animation-timing) forwards;
}

.widget-animation-scale {
  animation: scaleIn var(--widget-animation-duration) var(--widget-animation-timing) forwards;
}

/* 初始状态 */
.widget-container {
  opacity: 0;
}

.widget-container.widget-animated {
  opacity: 1;
}

/* 加载状态 */
.widget-loading {
  position: relative;
  overflow: hidden;
}

.widget-loading::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.2),
    transparent
  );
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% {
    left: -100%;
  }
  100% {
    left: 100%;
  }
}

/* 错误状态 */
.widget-error {
  border: 2px dashed #ef4444;
  background-color: #fef2f2;
  color: #dc2626;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 80px;
  text-align: center;
  font-size: 0.875rem;
}

/* 空状态 */
.widget-empty {
  border: 2px dashed #d1d5db;
  background-color: #f9fafb;
  color: #6b7280;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 80px;
  text-align: center;
  font-size: 0.875rem;
}

/* 暗色主题适配 */
@media (prefers-color-scheme: dark) {
  .widget-container:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .widget-container.widget-hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }
  
  .widget-error {
    border-color: #f87171;
    background-color: #450a0a;
    color: #fca5a5;
  }
  
  .widget-empty {
    border-color: #4b5563;
    background-color: #111827;
    color: #9ca3af;
  }
  
  .widget-loading::before {
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.1),
      transparent
    );
  }
}

/* 高对比度模式 */
@media (prefers-contrast: high) {
  .widget-container {
    border: 2px solid currentColor;
  }
  
  .widget-container:hover {
    border-width: 3px;
  }
}

/* 减少动画模式 */
@media (prefers-reduced-motion: reduce) {
  .widget-container,
  .widget-animation-fade,
  .widget-animation-slide,
  .widget-animation-scale {
    animation: none;
    transition: none;
  }
  
  .widget-container {
    opacity: 1;
    transform: none;
  }
  
  .widget-container:hover {
    transform: none;
  }
}

/* 打印样式 */
@media print {
  #dynamic-sidebar {
    display: none;
  }
}

/* 容器查询支持 (现代浏览器) */
@supports (container-type: inline-size) {
  #dynamic-sidebar {
    container-type: inline-size;
  }
  
  @container (max-width: 280px) {
    .widget-container {
      font-size: 0.875rem;
    }
    
    .widget-container[data-widget-type="categories"],
    .widget-container[data-widget-type="tags"] {
      max-height: 150px;
    }
  }
  
  @container (min-width: 360px) {
    .widget-container {
      padding: 1.25rem;
    }
  }
}

/* 工具类 */
.widget-hidden {
  display: none !important;
}

.widget-visible {
  display: block !important;
}

.widget-compact {
  padding: 0.5rem !important;
  font-size: 0.875rem !important;
}

.widget-expanded {
  padding: 1.5rem !important;
  font-size: 1rem !important;
}

/* 调试样式 (开发环境) */
[data-debug="true"] .widget-container {
  border: 1px solid #3b82f6;
  position: relative;
}

[data-debug="true"] .widget-container::before {
  content: attr(data-widget-type) ' [' attr(data-widget-order) ']';
  position: absolute;
  top: -1px;
  left: -1px;
  background: #3b82f6;
  color: white;
  font-size: 10px;
  padding: 2px 4px;
  z-index: 1000;
}
</file>

<file path="types/bangumi.ts">
export type UserSubjectCollectionResponse = {
	data: UserSubjectCollection[];
	total: number;
	limit: number;
	offset: number;
};

export type UserSubjectCollection = {
	subject_id: number; // 条目 ID
	subject_type: SubjectType; // 条目类型
	rate: number; // 评分
	type: CollectionType; // 收藏类型
	comment?: string | null; // 评价
	tags: string[]; // 标签
	ep_status: number; // 章节进度
	vol_status: number; // 卷进度
	updated_at: string; // 更新时间（ISO 8601 格式）
	private: boolean; // 是否私有
	subject: SlimSubject; // 条目信息
};

// 1: 想看，2: 看过，3: 在看，4: 搁置，5: 抛弃
export type CollectionType = 1 | 2 | 3 | 4 | 5;

export type SlimSubject = {
	id: number; // ID
	type: SubjectType; // 类型
	name: string; // 名称
	name_cn: string; // 中文名
	short_summary: string; // 简介
	date?: string | null; // 日期 YYYY-MM-DD
	images: SubjectImages; // 图片
	volumes: number; // 卷数
	eps: number; // 集数
	collection_total: number; // 收藏人数
	score: number; // 评分
	rank: number; // 排名
	tags: SubjectTag[]; // 标签
};

// 1: 书籍，2: 动画，3: 音乐，4: 游戏，6: 三次元
export type SubjectType = 1 | 2 | 3 | 4 | 6;

export type SubjectTag = {
	name: string;
	count: number;
	total_cont: number;
};

export type SubjectImages = {
	large: string;
	common: string;
	medium: string;
	small: string;
	grid: string;
};
</file>

<file path="types/config.ts">
import type {
    DARK_MODE,
    LIGHT_MODE,
    SYSTEM_MODE,
    WALLPAPER_BANNER,
    WALLPAPER_NONE,
    WALLPAPER_OVERLAY,
} from "../constants/constants";

export type SiteConfig = {
    title: string;
    subtitle: string;
    site_url: string;
    description?: string; // 网站描述，用于生成 <meta name="description">
    keywords?: string[]; // 站点关键词，用于生成 <meta name="keywords">

    lang: "en" | "zh_CN" | "zh_TW" | "ja" | "ru";

    themeColor: {
        hue: number;
        fixed: boolean;
        defaultMode?: LIGHT_DARK_MODE; // 默认模式：浅色、深色或跟随系统
    };

    // 页面整体宽度（单位：rem）
    pageWidth?: number;

    // 卡片样式配置
    card: {
        // 是否开启卡片边框和阴影立体效果
        border: boolean;
    };

    // 字体配置
    font: FontConfig;

    // 站点开始日期，用于计算运行天数
    siteStartDate?: string; // 格式: "YYYY-MM-DD"

    // 可选：站点时区，使用 IANA 时区标识，例如 "Asia/Shanghai"、"UTC"
    timezone?: string;

    // 提醒框配置
    rehypeCallouts: {
        theme: "github" | "obsidian" | "vitepress";
    };

    // 添加bangumi配置
    bangumi?: {
        userId?: string; // Bangumi用户ID
    };

    generateOgImages: boolean;
    favicon: Array<{
        src: string;
        theme?: "light" | "dark";
        sizes?: string;
    }>;

    navbar: {
        /** 导航栏Logo图标，可选类型：icon库、本地图片、网络图片链接 */
        logo?: {
            type: "icon" | "image" | "url";
            value: string; // icon名、本地图片路径或网络图片url
            alt?: string; // 图片alt文本
        };
        title?: string; // 导航栏标题，如果不设置则使用 title
        widthFull?: boolean; // 导航栏是否占满屏幕宽度
        followTheme?: boolean; // 导航栏图标和标题是否跟随主题色
    };

    showLastModified: boolean; // 控制"上次编辑"卡片显示的开关
    outdatedThreshold?: number; // 文章过期阈值（天数），超过此天数才显示"上次编辑"卡片
    sharePoster?: boolean; // 是否显示分享海报按钮

    // 页面开关配置
    pages: {
        sponsor: boolean; // 赞助页面开关
        guestbook: boolean; // 留言板页面开关
        bangumi: boolean;
    };

    // 分类导航栏开关
    categoryBar?: boolean;

    // 文章列表布局配置
    postListLayout: {
        defaultMode: "list" | "grid"; // 默认布局模式：list=列表模式，grid=网格模式
        allowSwitch: boolean; // 是否允许用户切换布局
        grid: {
            // 网格布局配置，仅在 defaultMode 为 "grid" 或允许切换布局时生效
            // 是否开启瀑布流布局
            masonry: boolean;
            // 网格模式列数：2 或 3，默认为 2。注意：3列模式仅在单侧边栏（或无侧边栏）且屏幕宽度足够时生效
            columns?: 2 | 3;
        };
    };

    // 分页配置
    pagination: {
        postsPerPage: number; // 每页显示的文章数量
    };

    // 统计分析
    analytics?: {
        googleAnalyticsId?: string; // Google Analytics ID
        microsoftClarityId?: string; // Microsoft Clarity ID
    };

    // 图片优化配置
    imageOptimization?: {
        /**
         * 输出图片格式
         * - "avif": 仅输出 AVIF 格式（最小体积，兼容性较低）
         * - "webp": 仅输出 WebP 格式（体积适中，兼容性好）
         * - "both": 同时输出 AVIF 和 WebP（推荐，浏览器自动选择最佳格式）
         */
        formats?: "avif" | "webp" | "both";
        /**
         * 图片压缩质量 (1-100)
         * 值越低体积越小但质量越差，推荐 70-85
         */
        quality?: number;
    };
};

export type Favicon = {
    src: string;
    theme?: "light" | "dark";
    sizes?: string;
};

export enum LinkPreset {
    Home = 0,
    Archive = 1,
    About = 2,
    Friends = 3,
    Sponsor = 4,
    Guestbook = 5,
    Bangumi = 6,
    Moments = 7,
}

export type NavBarLink = {
    name: string;
    url: string;
    external?: boolean;
    icon?: string; // 菜单项图标
    children?: (NavBarLink | LinkPreset)[]; // 支持子菜单，可以是NavBarLink或LinkPreset
};

export enum NavBarSearchMethod {
    PageFind = 0,
}

export type NavBarSearchConfig = {
    method: NavBarSearchMethod;
};

export type NavBarConfig = {
    links: (NavBarLink | LinkPreset)[];
};

export type ProfileConfig = {
    avatar?: string;
    name: string;
    bio?: string;
    links: {
        name: string;
        url: string;
        icon: string;
        showName?: boolean;
    }[];
};

export type LicenseConfig = {
    enable: boolean;
    name: string;
    url: string;
};
// 评论配置

export type CommentConfig = {
    /**
     * 当前启用的评论系统类型
     * "none" | "twikoo" | "waline" | "giscus" | "disqus" | 'artalk'
     */
    type: "none" | "twikoo" | "waline" | "giscus" | "disqus" | "artalk";
    twikoo?: {
        envId: string;
        region?: string;
        lang?: string;
        visitorCount?: boolean;
    };
    waline?: {
        serverURL: string;
        lang?: string;
        login?: "enable" | "force" | "disable";
        visitorCount?: boolean; // 是否统计访问量，true 启用访问量，false 关闭
    };
    artalk?: {
        // 后端程序 API 地址
        server: string;
        /**
         * 语言，支持语言如下：
         * - "en" (English)
         * - "zh-CN" (简体中文)
         * - "zh-TW" (繁体中文)
         * - "ja" (日本語)
         * - "ko" (한국어)
         * - "fr" (Français)
         * - "ru" (Русский)
         * */
        locale: string | "auto";
        // 是否统计访问量，true 启用访问量，false 关闭
        visitorCount?: boolean;
    };
    giscus?: {
        repo: string;
        repoId: string;
        category: string;
        categoryId: string;
        mapping: string;
        strict: string;
        reactionsEnabled: string;
        emitMetadata: string;
        inputPosition: string;
        lang: string;
        loading: string;
    };
    disqus?: {
        shortname: string;
    };
};

export type LIGHT_DARK_MODE =
    | typeof LIGHT_MODE
    | typeof DARK_MODE
    | typeof SYSTEM_MODE;

export type WALLPAPER_MODE =
    | typeof WALLPAPER_BANNER
    | typeof WALLPAPER_OVERLAY
    | typeof WALLPAPER_NONE;

export type BlogPostData = {
    body: string;
    title: string;
    published: Date;
    description: string;
    tags: string[];
    draft?: boolean;
    image?: string;
    category?: string;
    pinned?: boolean;
    prevTitle?: string;
    prevSlug?: string;
    nextTitle?: string;
    nextSlug?: string;
};

export type ExpressiveCodeConfig = {
    /** @deprecated 使用 darkTheme 和 lightTheme 代替 */
    theme?: string;
    /** 暗色主题名称（用于暗色模式） */
    darkTheme: string;
    /** 亮色主题名称（用于亮色模式） */
    lightTheme: string;
    /** 代码块折叠插件配置 */
    pluginCollapsible?: PluginCollapsibleConfig;
};

export type PluginCollapsibleConfig = {
    enable: boolean; // 是否启用代码块折叠功能
    lineThreshold: number; // 触发折叠的行数阈值
    previewLines: number; // 折叠时显示的预览行数
    defaultCollapsed: boolean; // 默认是否折叠
};

export type AnnouncementConfig = {
    // enable属性已移除，现在通过sidebarLayoutConfig统一控制
    title?: string; // 公告栏标题
    content: string; // 公告栏内容
    icon?: string; // 公告栏图标
    type?: "info" | "warning" | "success" | "error"; // 公告类型
    closable?: boolean; // 是否可关闭
    link?: {
        enable: boolean; // 是否启用链接
        text: string; // 链接文字
        url: string; // 链接地址
        external?: boolean; // 是否外部链接
    };
};

// 单个字体配置
export type FontItem = {
    id: string; // 字体唯一标识符
    name: string; // 字体显示名称
    src: string; // 字体文件路径或URL链接
    family: string; // CSS font-family 名称
    weight?: string | number; // 字体粗细，如 "normal", "bold", 400, 700 等
    style?: "normal" | "italic" | "oblique"; // 字体样式
    display?: "auto" | "block" | "swap" | "fallback" | "optional"; // font-display 属性
    unicodeRange?: string; // Unicode 范围，用于字体子集化
    format?:
        | "woff"
        | "woff2"
        | "truetype"
        | "opentype"
        | "embedded-opentype"
        | "svg"; // 字体格式，仅当 src 为本地文件时需要
};

// 字体配置
export type FontConfig = {
    enable: boolean; // 是否启用自定义字体功能
    selected: string | string[]; // 当前选择的字体ID，支持单个或多个字体组合
    fonts: Record<string, FontItem>; // 字体库，以ID为键的对象
    fallback?: string[]; // 全局字体回退列表
    preload?: boolean; // 是否预加载字体文件以提高性能
};

export type FooterConfig = {
    enable: boolean; // 是否启用Footer HTML注入功能
    customHtml?: string; // 自定义HTML内容，用于添加备案号等信息
};

export type CoverImageConfig = {
    enableInPost: boolean; // 是否在文章详情页显示封面图
    randomCoverImage: {
        enable: boolean; // 是否启用随机图功能
        apis: string[]; // 随机图API列表
        fallback?: string; // API失败时的回退图片路径（相对于src目录或以/开头的public目录路径）
        showLoading?: boolean; // 是否显示加载动画
    };
};

// 组件配置类型定义
export type WidgetComponentType =
    | "profile"
    | "announcement"
    | "categories"
    | "tags"
    | "sidebarToc"
    | "advertisement"
    | "stats"
    | "calendar"
    | "music";

export type WidgetComponentConfig = {
    type: WidgetComponentType; // 组件类型
    enable: boolean; // 是否启用该组件
    position: "top" | "sticky"; // 组件位置：top=固定在顶部，sticky=粘性定位（可滚动）
    configId?: string; // 配置ID，用于广告组件指定使用哪个配置
    showOnPostPage?: boolean; // 是否在文章详情页显示
    showOnNonPostPage?: boolean; // 是否在非文章详情页显示
    responsive?: {
        hidden?: ("mobile" | "tablet" | "desktop")[]; // 在指定设备上隐藏
        collapseThreshold?: number; // 折叠阈值
    };
    customProps?: Record<string, unknown>; // 自定义属性，用于扩展组件功能
};

export type MobileBottomComponentConfig = {
    type: WidgetComponentType; // 组件类型
    enable: boolean; // 是否启用该组件
    configId?: string; // 配置ID，用于广告组件指定使用哪个配置
    showOnPostPage?: boolean; // 是否在文章详情页显示
    showOnNonPostPage?: boolean; // 是否在非文章详情页显示
    responsive?: {
        hidden?: ("mobile" | "tablet" | "desktop")[]; // 在指定设备上隐藏
        collapseThreshold?: number; // 折叠阈值
    };
    customProps?: Record<string, unknown>; // 自定义属性，用于扩展组件功能
};

export type SidebarLayoutConfig = {
    enable: boolean; // 是否启用侧边栏
    position: "left" | "right" | "both"; // 侧边栏位置：左侧、右侧或双侧
    tabletSidebar?: "left" | "right"; // 平板端(769-1279px)显示哪侧侧边栏，仅position为both时生效，默认left
    showBothSidebarsOnPostPage?: boolean; // 当position为left或right时，是否在文章详情页显示双侧边栏
    leftComponents: WidgetComponentConfig[]; // 左侧边栏组件配置列表
    rightComponents: WidgetComponentConfig[]; // 右侧边栏组件配置列表
    mobileBottomComponents: MobileBottomComponentConfig[]; // 移动端底部组件配置列表（<768px显示）
};

export type SakuraConfig = {
    enable: boolean; // 是否启用樱花特效
    sakuraNum: number; // 樱花数量，默认21
    limitTimes: number; // 樱花越界限制次数，-1为无限循环
    size: {
        min: number; // 樱花最小尺寸倍数
        max: number; // 樱花最大尺寸倍数
    };
    opacity: {
        min: number; // 樱花最小不透明度
        max: number; // 樱花最大不透明度
    };
    speed: {
        horizontal: {
            min: number; // 水平移动速度最小值
            max: number; // 水平移动速度最大值
        };
        vertical: {
            min: number; // 垂直移动速度最小值
            max: number; // 垂直移动速度最大值
        };
        rotation: number; // 旋转速度
        fadeSpeed: number; // 消失速度，不应大于最小不透明度
    };
    zIndex: number; // 层级，确保樱花在合适的层级显示
};

// Spine 看板娘配置
export type SpineModelConfig = {
    enable: boolean; // 是否启用 Spine 看板娘
    model: {
        path: string; // 模型文件路径 (.json)
        scale?: number; // 模型缩放比例，默认1.0
        x?: number; // X轴偏移，默认0
        y?: number; // Y轴偏移，默认0
    };
    position: {
        corner: "bottom-left" | "bottom-right" | "top-left" | "top-right"; // 显示位置
        offsetX?: number; // 水平偏移量，默认20px
        offsetY?: number; // 垂直偏移量，默认20px
    };
    size: {
        width?: number; // 容器宽度，默认280px
        height?: number; // 容器高度，默认400px
    };
    interactive?: {
        enabled?: boolean; // 是否启用交互功能，默认true
        clickAnimations?: string[]; // 点击时随机播放的动画列表
        clickMessages?: string[]; // 点击时随机显示的文字消息
        messageDisplayTime?: number; // 文字显示时间（毫秒），默认3000
        idleAnimations?: string[]; // 待机动画列表
        idleInterval?: number; // 待机动画切换间隔（毫秒），默认10000
    };
    responsive?: {
        hideOnMobile?: boolean; // 是否在移动端隐藏，默认false
        mobileBreakpoint?: number; // 移动端断点，默认768px
    };
    zIndex?: number; // 层级，默认1000
    opacity?: number; // 透明度，0-1，默认1.0
};

// Live2D 看板娘配置
export type Live2DModelConfig = {
    enable: boolean; // 是否启用 Live2D 看板娘
    model: {
        path: string; // 模型文件夹路径或model3.json文件路径
    };
    position?: {
        corner?: "bottom-left" | "bottom-right" | "top-left" | "top-right"; // 显示位置，默认bottom-right
        offsetX?: number; // 水平偏移量，默认20px
        offsetY?: number; // 垂直偏移量，默认20px
    };
    size?: {
        width?: number; // 容器宽度，默认280px
        height?: number; // 容器高度，默认250px
    };
    interactive?: {
        enabled?: boolean; // 是否启用交互功能，默认true
        // motions 和 expressions 将从模型 JSON 文件中自动读取
        clickMessages?: string[]; // 点击时随机显示的文字消息
        messageDisplayTime?: number; // 文字显示时间（毫秒），默认3000
    };
    responsive?: {
        hideOnMobile?: boolean; // 是否在移动端隐藏，默认false
        mobileBreakpoint?: number; // 移动端断点，默认768px
    };
};

export type BackgroundWallpaperConfig = {
    mode: "banner" | "overlay" | "none"; // 壁纸模式：banner横幅模式、overlay全屏透明覆盖模式或none纯色背景
    switchable?: boolean; // 是否允许用户通过导航栏切换壁纸模式，默认true
    src:
        | string
        | string[]
        | {
        desktop?: string | string[];
        desktopDark?: string | string[];
        mobile?: string | string[];
        mobileDark?: string | string[];
    }; // 支持单个图片、图片数组或分别设置桌面端和移动端图片

    // Banner模式特有配置
    banner?: {
        position?:
            | "top"
            | "center"
            | "bottom"
            | "top left"
            | "top center"
            | "top right"
            | "center left"
            | "center center"
            | "center right"
            | "bottom left"
            | "bottom center"
            | "bottom right"
            | "left top"
            | "left center"
            | "left bottom"
            | "right top"
            | "right center"
            | "right bottom"
            | string; // 壁纸位置，支持CSS object-position的所有值，包括百分比和像素值
        homeText?: {
            enable: boolean; // 是否在首页显示自定义文字（全局开关）
            switchable?: boolean; // 是否允许用户通过控制面板切换横幅标题显示
            title?: string; // 主标题
            subtitle?: string | string[]; // 副标题，支持单个字符串或字符串数组
            titleSize?: string; // 主标题字体大小，如 "3.5rem"
            subtitleSize?: string; // 副标题字体大小，如 "1.5rem"
            typewriter?: {
                enable: boolean; // 是否启用打字机效果
                speed: number; // 打字速度（毫秒）
                deleteSpeed: number; // 删除速度（毫秒）
                pauseTime: number; // 完整显示后的暂停时间（毫秒）
            };
        };
        credit?: {
            enable:
                | boolean
                | {
                desktop: boolean; // 桌面端是否显示横幅图片来源文本
                mobile: boolean; // 移动端是否显示横幅图片来源文本
            }; // 是否显示横幅图片来源文本，支持布尔值或分别设置桌面端和移动端
            text:
                | string
                | {
                desktop: string; // 桌面端显示的来源文本
                mobile: string; // 移动端显示的来源文本
            }; // 横幅图片来源文本，支持字符串或分别设置桌面端和移动端
            url?:
                | string
                | {
                desktop: string; // 桌面端原始艺术品或艺术家页面的 URL 链接
                mobile: string; // 移动端原始艺术品或艺术家页面的 URL 链接
            }; // 原始艺术品或艺术家页面的 URL 链接，支持字符串或分别设置桌面端和移动端
        };
        navbar?: {
            transparentMode?: "semi" | "full" | "semifull"; // 导航栏透明模式
            enableBlur?: boolean; // 是否开启毛玻璃模糊效果
            blur?: number; // 毛玻璃模糊度
        };
        waves?: {
            enable:
                | boolean
                | {
                desktop: boolean; // 桌面端是否启用水波纹动画效果
                mobile: boolean; // 移动端是否启用水波纹动画效果
            }; // 是否启用水波纹动画效果，支持布尔值或分别设置桌面端和移动端
            switchable?: boolean; // 是否允许用户通过控制面板切换水波纹动画
        };
    };
    // 全屏透明覆盖模式特有配置
    overlay?: {
        zIndex?: number; // 层级，确保壁纸在合适的层级显示
        opacity?: number; // 壁纸透明度，0-1之间
        blur?: number; // 背景模糊程度，单位px
    };
};

// 广告栏配置
export type AdConfig = {
    title?: string; // 广告栏标题
    content?: string; // 广告栏文本内容
    image?: {
        src: string; // 图片地址
        alt?: string; // 图片描述
        link?: string; // 图片点击链接
        external?: boolean; // 是否外部链接
    };
    link?: {
        text: string; // 链接文本
        url: string; // 链接地址
        external?: boolean; // 是否外部链接
    };
    padding?: {
        top?: string; // 上边距，如 "0", "1rem", "16px"
        right?: string; // 右边距
        bottom?: string; // 下边距
        left?: string; // 左边距
        all?: string; // 统一边距，会覆盖单独设置
    };
    closable?: boolean; // 是否可关闭
    displayCount?: number; // 显示次数限制，-1为无限制
    expireDate?: string; // 过期时间 (ISO 8601 格式)
};

// 友链配置
export type FriendLink = {
    title: string; // 友链标题
    imgurl: string; // 头像图片URL
    desc: string; // 友链描述
    siteurl: string; // 友链地址
    tags?: string[]; // 标签数组
    weight: number; // 权重，数字越大排序越靠前
    enabled: boolean; // 是否启用
};

export type FriendsPageConfig = {
    columns: 2 | 3; // 显示列数：2列或3列
};

// 片刻配置
export type MomentItem = {
    name: string;
    content: string;
    created: string;
};

export type MomentsLoadResult = {
    items: MomentItem[],
    nextToken: string,
};

export type MemosConfig = {
    host: string;
    pageLimit: number;
};

// 音乐播放器配置
export type MusicPlayerConfig = {
    // 使用方式：'meting' 或 'local'
    mode?: "meting" | "local"; // "meting" 使用 Meting API，"local" 使用本地音乐列表

    // 默认音量 (0-1)
    volume?: number;

    // 播放模式：'list'=列表循环, 'one'=单曲循环, 'random'=随机播放
    playMode?: "list" | "one" | "random";

    // 是否显示歌词
    showLyrics?: boolean;

    // 是否在导航栏显示音乐播放器
    showInNavbar?: boolean;

    // Meting API 配置
    meting?: {
        // Meting API 地址
        api?: string;

        // 音乐平台：netease=网易云音乐, tencent=QQ音乐, kugou=酷狗音乐, xiami=虾米音乐, baidu=百度音乐
        server?: "netease" | "tencent" | "kugou" | "xiami" | "baidu";

        // 类型：song=单曲, playlist=歌单, album=专辑, search=搜索, artist=艺术家
        type?: "song" | "playlist" | "album" | "search" | "artist";

        // 歌单/专辑/单曲 ID 或搜索关键词
        id?: string;

        // 认证 token（可选）
        auth?: string;

        // 备用 API 配置（当主 API 失败时使用）
        fallbackApis?: string[];
    };

    // 本地音乐配置（当 mode 为 'local' 时使用）
    local?: {
        playlist?: Array<{
            name: string; // 歌曲名称
            artist: string; // 艺术家
            url: string; // 音乐文件路径（相对于 public 目录）
            cover?: string; // 封面图片路径（相对于 public 目录）
            lrc?: string; // 歌词内容，支持 LRC 格式
        }>;
    };
};

// 赞助方式类型
export type SponsorMethod = {
    name: string; // 赞助方式名称，如 "支付宝"、"微信"、"PayPal"
    icon?: string; // 图标名称（Iconify 格式），如 "fa7-brands:alipay"
    qrCode?: string; // 收款码图片路径（相对于 public 目录），可选
    link?: string; // 赞助链接 URL，可选。如果提供，会显示跳转按钮
    description?: string; // 描述文本
    enabled: boolean; // 是否启用
};

// 赞助者列表项
export type SponsorItem = {
    name: string; // 赞助者名称，如果想显示匿名，可以直接设置为"匿名"或使用 i18n
    amount?: string; // 赞助金额（可选）
    date?: string; // 赞助日期（可选，ISO 格式）
    message?: string; // 留言（可选）
};

// 赞助配置
export type SponsorConfig = {
    title?: string; // 页面标题，默认使用 i18n
    description?: string; // 页面描述文本
    usage?: string; // 赞助用途说明
    methods: SponsorMethod[]; // 赞助方式列表
    sponsors?: SponsorItem[]; // 赞助者列表（可选）
    showSponsorsList?: boolean; // 是否显示赞助者列表，默认 true
    showButtonInPost?: boolean; // 是否在文章详情页底部显示赞助按钮，默认 true
};

// 响应式图像布局类型
export type ResponsiveImageLayout = "constrained" | "full-width" | "none";

// 图像格式类型
export type ImageFormat = "avif" | "webp" | "png" | "jpg" | "jpeg" | "gif";
</file>

<file path="utils/content-utils.ts">
import { type CollectionEntry, getCollection } from "astro:content";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { getCategoryUrl } from "@utils/url-utils";

// // Retrieve posts and sort them by publication date
async function getRawSortedPosts() {
	const allBlogPosts = await getCollection("posts", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});

	const sorted = allBlogPosts.sort((a, b) => {
		// 首先按置顶状态排序，置顶文章在前
		if (a.data.pinned && !b.data.pinned) return -1;
		if (!a.data.pinned && b.data.pinned) return 1;

		// 如果置顶状态相同，则按发布日期排序
		const dateA = new Date(a.data.published);
		const dateB = new Date(b.data.published);
		return dateA > dateB ? -1 : 1;
	});
	return sorted;
}

export async function getSortedPosts() {
	const sorted = await getRawSortedPosts();

	for (let i = 1; i < sorted.length; i++) {
		sorted[i].data.nextSlug = sorted[i - 1].id;
		sorted[i].data.nextTitle = sorted[i - 1].data.title;
	}
	for (let i = 0; i < sorted.length - 1; i++) {
		sorted[i].data.prevSlug = sorted[i + 1].id;
		sorted[i].data.prevTitle = sorted[i + 1].data.title;
	}

	return sorted;
}
export type PostForList = {
	id: string;
	data: CollectionEntry<"posts">["data"];
};
export async function getSortedPostsList(): Promise<PostForList[]> {
	const sortedFullPosts = await getRawSortedPosts();

	// delete post.body
	const sortedPostsList = sortedFullPosts.map((post) => ({
		id: post.id,
		data: post.data,
	}));

	return sortedPostsList;
}
export type Tag = {
	name: string;
	count: number;
};

export async function getTagList(): Promise<Tag[]> {
	const allBlogPosts = await getCollection<"posts">("posts", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});

	const countMap: { [key: string]: number } = {};
	allBlogPosts.forEach((post: { data: { tags: string[] } }) => {
		post.data.tags.forEach((tag: string) => {
			if (!countMap[tag]) countMap[tag] = 0;
			countMap[tag]++;
		});
	});

	// sort tags
	const keys: string[] = Object.keys(countMap).sort((a, b) => {
		return a.toLowerCase().localeCompare(b.toLowerCase());
	});

	return keys.map((key) => ({ name: key, count: countMap[key] }));
}

export type Category = {
	name: string;
	count: number;
	url: string;
};

export async function getCategoryList(): Promise<Category[]> {
	const allBlogPosts = await getCollection<"posts">("posts", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});
	const count: { [key: string]: number } = {};
	allBlogPosts.forEach((post: { data: { category: string | null } }) => {
		if (!post.data.category) {
			const ucKey = i18n(I18nKey.uncategorized);
			count[ucKey] = count[ucKey] ? count[ucKey] + 1 : 1;
			return;
		}

		const categoryName =
			typeof post.data.category === "string"
				? post.data.category.trim()
				: String(post.data.category).trim();

		count[categoryName] = count[categoryName] ? count[categoryName] + 1 : 1;
	});

	const lst = Object.keys(count).sort((a, b) => {
		return (
			count[b] - count[a] || a.toLowerCase().localeCompare(b.toLowerCase())
		);
	});

	const ret: Category[] = [];
	for (const c of lst) {
		ret.push({
			name: c,
			count: count[c],
			url: getCategoryUrl(c),
		});
	}
	return ret;
}
</file>

<file path="utils/date-utils.ts">
import { siteConfig } from "../config";

export function formatDateToYYYYMMDD(date: Date): string {
	return date.toISOString().substring(0, 10);
}

// 国际化日期格式化函数
export function formatDateI18n(
	dateInput: Date | string,
	includeTime?: boolean,
): string {
	const date = typeof dateInput === "string" ? new Date(dateInput) : dateInput;
	const lang = siteConfig.lang || "en";

	// 根据语言设置不同的日期格式
	const options: Intl.DateTimeFormatOptions = {
		year: "numeric",
		month: "long",
		day: "numeric",
	};

	if (includeTime) {
		options.hour = "2-digit";
		options.minute = "2-digit";
		options.second = "2-digit";
	}

	// 如果配置了时区，则将其用于格式化（IANA 时区字符串）
	if (siteConfig.timezone) {
		(options as Intl.DateTimeFormatOptions).timeZone = siteConfig.timezone;
	}

	// 语言代码映射
	const localeMap: Record<string, string> = {
		zh_CN: "zh-CN",
		zh_TW: "zh-TW",
		en: "en-US",
		ja: "ja-JP",
		ko: "ko-KR",
		es: "es-ES",
		th: "th-TH",
		vi: "vi-VN",
		tr: "tr-TR",
		id: "id-ID",
		fr: "fr-FR",
		de: "de-DE",
		ru: "ru-RU",
		ar: "ar-SA",
	};

	const locale = localeMap[lang] || "en-US";
	return includeTime
		? date.toLocaleString(locale, options)
		: date.toLocaleDateString(locale, options);
}

// 国际化日期时间格式化函数（带时分秒）
export function formatDateI18nWithTime(dateInput: Date | string): string {
	return formatDateI18n(dateInput, true);
}

// 统一格式为 YYYY-MM-DD HH:mm，支持站点时区
export function formatDateTimeToYYYYMMDDHHmm(dateInput: Date | string): string {
	const date = typeof dateInput === "string" ? new Date(dateInput) : dateInput;

	const options: Intl.DateTimeFormatOptions = {
		year: "numeric",
		month: "2-digit",
		day: "2-digit",
		hour: "2-digit",
		minute: "2-digit",
		hour12: false,
	};

	if (siteConfig.timezone) {
		options.timeZone = siteConfig.timezone;
	}

	const parts = new Intl.DateTimeFormat("en-CA", options).formatToParts(date);
	const get = (type: Intl.DateTimeFormatPartTypes) =>
		parts.find((p) => p.type === type)?.value || "";

	return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}`;
}
</file>

<file path="utils/icon-loader.ts">
/**
 * 图标加载管理器
 * 负责处理图标的加载状态显示
 */

export function initIconLoader() {
	// 初始化单个图标容器
	function initContainer(container: Element) {
		if (container.hasAttribute("data-icon-initialized")) return;
		container.setAttribute("data-icon-initialized", "true");

		const loadingIndicator = container.querySelector(
			"[data-loading-indicator]",
		) as HTMLElement;
		const iconElement = container.querySelector(
			"[data-icon-element]",
		) as HTMLElement;
		const iconName = iconElement?.getAttribute("icon");

		if (!loadingIndicator || !iconElement) return;

		// 检查图标是否已经加载
		function checkIconLoaded() {
			const hasContent =
				iconElement.shadowRoot && iconElement.shadowRoot.children.length > 0;

			if (hasContent) {
				showIcon();
				return true;
			}
			return false;
		}

		// 显示图标，隐藏加载指示器
		function showIcon() {
			loadingIndicator.style.display = "none";
			iconElement.classList.remove("opacity-0");
			iconElement.classList.add("opacity-100");
		}

		// 显示加载指示器，隐藏图标
		function showLoading() {
			loadingIndicator.style.display = "inline-flex";
			iconElement.classList.remove("opacity-100");
			iconElement.classList.add("opacity-0");
		}

		// 初始状态
		showLoading();

		// 监听图标加载事件
		iconElement.addEventListener("load", () => {
			showIcon();
		});

		// 监听图标加载错误
		iconElement.addEventListener("error", () => {
			// 保持显示fallback
			if (iconName) {
				console.warn(`Failed to load icon: ${iconName}`);
			}
		});

		// 使用MutationObserver监听shadow DOM变化
		if (window.MutationObserver) {
			const observer = new MutationObserver(() => {
				if (checkIconLoaded()) {
					observer.disconnect();
				}
			});

			// 监听iconify-icon元素的变化
			observer.observe(iconElement, {
				childList: true,
				subtree: true,
				attributes: true,
			});

			// 设置超时，避免无限等待
			setTimeout(() => {
				observer.disconnect();
				if (!checkIconLoaded()) {
					// console.warn(`Icon load timeout: ${iconName}`);
				}
			}, 5000);
		}

		// 立即检查一次（可能已经加载完成）
		setTimeout(() => {
			checkIconLoaded();
		}, 100);
	}

	// 初始化页面上现有的图标
	document.querySelectorAll("[data-icon-container]").forEach(initContainer);

	// 监听新添加的图标
	if (window.MutationObserver) {
		const observer = new MutationObserver((mutations) => {
			mutations.forEach((mutation) => {
				mutation.addedNodes.forEach((node) => {
					if (node.nodeType === Node.ELEMENT_NODE) {
						const el = node as Element;
						if (el.hasAttribute?.("data-icon-container")) {
							initContainer(el);
						} else {
							el.querySelectorAll("[data-icon-container]").forEach(
								initContainer,
							);
						}
					}
				});
			});
		});

		observer.observe(document.body, {
			childList: true,
			subtree: true,
		});
	}
}
</file>

<file path="utils/image-utils.ts">
import { coverImageConfig } from "@/config/coverImageConfig";
import { siteConfig } from "@/config/siteConfig";
import type { ImageFormat } from "@/types/config";

const { randomCoverImage } = coverImageConfig;

/**
 * 根据seed生成确定性hash值
 */
function getSeedHash(seed?: string): number {
	return seed
		? Math.abs(
				seed.split("").reduce((acc, char) => {
					return ((acc << 5) - acc + char.charCodeAt(0)) | 0;
				}, 0),
			)
		: 0;
}

/**
 * 为API URL添加seed参数，确保每篇文章获取不同图片
 */
function appendSeedParam(apiUrl: string, hash: number): string {
	if (hash === 0) return apiUrl;
	const separator = apiUrl.includes("?") ? "&" : "?";
	return `${apiUrl}${separator}v=${hash}`;
}

/**
 * 处理文章封面图
 * 当image字段为"api"时，返回第一个API的URL（客户端会按顺序尝试所有API）
 * @param image - 文章frontmatter中的image字段值
 * @param seed - 用于生成唯一URL的种子（文章id或slug）
 */
export function processCoverImageSync(
	image: string | undefined,
	seed?: string,
): string {
	if (!image || image === "") {
		return "";
	}

	if (image !== "api") {
		return image;
	}

	if (
		!randomCoverImage.enable ||
		!randomCoverImage.apis ||
		randomCoverImage.apis.length === 0
	) {
		return "";
	}

	// 始终使用第一个API，失败时由客户端按顺序尝试后续API
	const hash = getSeedHash(seed);
	return appendSeedParam(randomCoverImage.apis[0], hash);
}

/**
 * 获取所有随机封面图API URL列表（带seed参数）
 * 用于客户端按顺序尝试，第一个成功即使用，全部失败则显示回退图片
 * @param image - 文章frontmatter中的image字段值
 * @param seed - 用于生成唯一URL的种子（文章id或slug）
 */
export function getApiUrlList(
	image: string | undefined,
	seed?: string,
): string[] {
	if (image !== "api" || !randomCoverImage.enable || !randomCoverImage.apis) {
		return [];
	}

	const hash = getSeedHash(seed);
	return randomCoverImage.apis.map((api) => appendSeedParam(api, hash));
}

/**
 * 获取图片优化格式配置
 */
export function getImageFormats(): ImageFormat[] {
	const formatConfig = siteConfig.imageOptimization?.formats ?? "both";
	switch (formatConfig) {
		case "avif":
			return ["avif"];
		case "webp":
			return ["webp"];
		default:
			return ["avif", "webp"];
	}
}

/**
 * 获取图片优化质量配置
 */
export function getImageQuality(): number {
	return siteConfig.imageOptimization?.quality ?? 80;
}

/**
 * 获取图片回退格式
 */
export function getFallbackFormat(): "avif" | "webp" {
	const formatConfig = siteConfig.imageOptimization?.formats ?? "both";
	return formatConfig === "avif" ? "avif" : "webp";
}
</file>

<file path="utils/language-utils.ts">
/**
 * 获取语言的显示名称
 * @param langCode 语言代码（配置文件格式或翻译服务格式）
 * @returns 语言的显示名称
 */
export function getLanguageDisplayName(langCode: string): string {
	const languageNames: Record<string, string> = {
		zh_CN: "简体中文",
		zh_TW: "繁體中文",
		en: "English",
		ja: "日本語",
		ko: "한국어",
		es: "Español",
		th: "ไทย",
		vi: "Tiếng Việt",
		tr: "Türkçe",
		id: "Bahasa Indonesia",
		fr: "Français",
		de: "Deutsch",
		ru: "Русский",
		ar: "العربية",
		// 翻译服务格式
		chinese_simplified: "简体中文",
		chinese_traditional: "繁體中文",
		english: "English",
		japanese: "日本語",
		korean: "한국어",
		spanish: "Español",
		thai: "ไทย",
		vietnamese: "Tiếng Việt",
		turkish: "Türkçe",
		indonesian: "Bahasa Indonesia",
		french: "Français",
		german: "Deutsch",
		russian: "Русский",
		arabic: "العربية",
	};

	return languageNames[langCode] || langCode;
}
</file>

<file path="utils/layout-utils.ts">
import { backgroundWallpaper } from "../config";

// 将单个值或数组统一为数组
const toArray = (src: string | string[] | undefined): string[] => {
    if (!src) return [];
    if (Array.isArray(src)) return src;
    return [src];
};

// 背景图片处理工具函数
// 返回所有配置的图片（用于构建时渲染所有图片）
export const getBackgroundImages = () => {
    const bgSrc = backgroundWallpaper.src;

    if (
        typeof bgSrc === "object" &&
        bgSrc !== null &&
        !Array.isArray(bgSrc) &&
        ("desktop" in bgSrc || "mobile" in bgSrc)
    ) {
        const srcObj = bgSrc as {
            desktop?: string | string[];
            mobile?: string | string[];
        };
        const desktopImages = toArray(srcObj.desktop);
        const mobileImages = toArray(srcObj.mobile);
        return {
            desktop: desktopImages.length > 0 ? desktopImages : mobileImages,
            mobile: mobileImages.length > 0 ? mobileImages : desktopImages,
            isMultiple: desktopImages.length > 1 || mobileImages.length > 1,
        };
    }
    // 如果是字符串或数组，同时用于桌面端和移动端
    const images = toArray(bgSrc as string | string[]);
    return {
        desktop: images,
        mobile: images,
        isMultiple: images.length > 1,
    };
};

// 类型守卫函数
export const isBannerSrcObject = (
    src:
        | string
        | string[]
        | { desktop?: string | string[]; mobile?: string | string[] },
): src is { desktop?: string | string[]; mobile?: string | string[] } => {
    return (
        typeof src === "object" &&
        src !== null &&
        !Array.isArray(src) &&
        ("desktop" in src || "mobile" in src)
    );
};

// 获取默认背景图片（返回第一张，用于 SEO 等场景）
export const getDefaultBackground = (): string => {
    const images = getBackgroundImages();
    return images.desktop[0] || images.mobile[0] || "";
};

// 检查是否为首页
export const isHomePage = (pathname: string): boolean => {
    // 获取 base URL
    const baseUrl = import.meta.env.BASE_URL || "/";
    const baseUrlNoSlash = baseUrl.endsWith("/") ? baseUrl.slice(0, -1) : baseUrl;

    if (pathname === baseUrl) return true;
    if (pathname === baseUrlNoSlash) return true;
    if (pathname === "/") return true;

    return false;
};

// 获取横幅偏移量
export const getBannerOffset = (position = "center") => {
    const bannerOffsetByPosition = {
        top: "100vh",
        center: "50vh",
        bottom: "0",
    };
    return (
        bannerOffsetByPosition[position as keyof typeof bannerOffsetByPosition] ||
        "50vh"
    );
};
</file>

<file path="utils/navigation-utils.ts">
import { url } from "@/utils/url-utils";
/**
 * 导航工具函数
 * 提供统一的页面导航功能，支持 Swup 无刷新跳转
 */

/**
 * 导航到指定页面
 * @param url 目标页面URL
 * @param options 导航选项
 */
export function navigateToPage(
	url: string,
	options?: {
		replace?: boolean;
		force?: boolean;
	},
): void {
	// 检查 URL 是否有效
	if (!url || typeof url !== "string") {
		console.warn("navigateToPage: Invalid URL provided");
		return;
	}

	// 如果是外部链接，直接跳转
	if (
		url.startsWith("http://") ||
		url.startsWith("https://") ||
		url.startsWith("//")
	) {
		window.open(url, "_blank");
		return;
	}

	// 如果是锚点链接，滚动到对应位置
	if (url.startsWith("#")) {
		const element = document.getElementById(url.slice(1));
		if (element) {
			element.scrollIntoView({ behavior: "smooth" });
		}
		return;
	}

	// 检查 Swup 是否可用
	if (typeof window !== "undefined" && window.swup) {
		try {
			// 使用 Swup 进行无刷新跳转
			if (options?.replace) {
				window.swup.navigate(url, { history: false });
			} else {
				window.swup.navigate(url);
			}
		} catch (error) {
			console.error("Swup navigation failed:", error);
			// 降级到普通跳转
			fallbackNavigation(url, options);
		}
	} else {
		// Swup 不可用时的降级处理
		fallbackNavigation(url, options);
	}
}

/**
 * 降级导航函数
 * 当 Swup 不可用时使用普通的页面跳转
 */
function fallbackNavigation(
	url: string,
	options?: {
		replace?: boolean;
		force?: boolean;
	},
): void {
	if (options?.replace) {
		window.location.replace(url);
	} else {
		window.location.href = url;
	}
}

/**
 * 检查 Swup 是否已准备就绪
 */
export function isSwupReady(): boolean {
	return typeof window !== "undefined" && !!window.swup;
}

/**
 * 等待 Swup 准备就绪
 * @param timeout 超时时间（毫秒）
 */
export function waitForSwup(timeout = 5000): Promise<boolean> {
	return new Promise((resolve) => {
		if (isSwupReady()) {
			resolve(true);
			return;
		}

		let timeoutId: NodeJS.Timeout;

		const checkSwup = () => {
			if (isSwupReady()) {
				clearTimeout(timeoutId);
				document.removeEventListener("swup:enable", checkSwup);
				resolve(true);
			}
		};

		// 监听 Swup 启用事件
		document.addEventListener("swup:enable", checkSwup);

		// 设置超时
		timeoutId = setTimeout(() => {
			document.removeEventListener("swup:enable", checkSwup);
			resolve(false);
		}, timeout);
	});
}

/**
 * 预加载页面
 * @param url 要预加载的页面URL
 */
export function preloadPage(url: string): void {
	if (!url || typeof url !== "string") {
		return;
	}

	// 如果 Swup 可用，使用其预加载功能
	if (isSwupReady() && window.swup.preload) {
		try {
			window.swup.preload(url);
		} catch (error) {
			console.warn("Failed to preload page:", error);
		}
	}
}

/**
 * 获取当前页面路径
 */
export function getCurrentPath(): string {
	return typeof window !== "undefined" ? window.location.pathname : "";
}

/**
 * 检查是否为首页
 */
export function isHomePage(): boolean {
	const path = getCurrentPath();
	return path === url("/") || path === url("");
}

/**
 * 检查是否为文章页面
 */
export function isPostPage(): boolean {
	const path = getCurrentPath();
	return path.startsWith(url("/posts/"));
}

/**
 * 检查两个路径是否相等
 */
export function pathsEqual(path1: string, path2: string): boolean {
	// 标准化路径（移除末尾斜杠）
	const normalize = (path: string) => {
		return path.endsWith("/") && path.length > 1 ? path.slice(0, -1) : path;
	};

	return normalize(path1) === normalize(path2);
}
</file>

<file path="utils/responsive-utils.ts">
import { sidebarLayoutConfig } from "@/config";

export interface ResponsiveSidebarConfig {
	isBothSidebars: boolean;
	hasLeftComponents: boolean;
	hasRightComponents: boolean;
	mobileShowSidebar: boolean;
	tabletShowSidebar: boolean;
	desktopShowSidebar: boolean;
	position: "left" | "right" | "both";
	tabletSidebar: "left" | "right";
}

/**
 * 获取响应式侧边栏配置
 *
 * 响应式布局（硬编码）：
 * - 768px及以下: 隐藏侧栏，显示底部mobileBottomComponents
 * - 769px-1279px: 根据position和tabletSidebar配置显示侧栏
 * - 1280px及以上: 根据position配置显示侧栏
 */
export function getResponsiveSidebarConfig(): ResponsiveSidebarConfig {
	const position = sidebarLayoutConfig.position;
	const tabletSidebar = sidebarLayoutConfig.tabletSidebar ?? "left";

	const isBothSidebars = sidebarLayoutConfig.enable && position === "both";

	// position为right时，左侧组件不参与布局计算
	const hasLeftComponents =
		sidebarLayoutConfig.enable &&
		position !== "right" &&
		sidebarLayoutConfig.leftComponents.some((comp) => comp.enable);

	// position为left时，右侧组件不参与布局计算（即使启用也会被CSS隐藏）
	const hasRightComponents =
		sidebarLayoutConfig.enable &&
		position !== "left" &&
		sidebarLayoutConfig.rightComponents.some((comp) => comp.enable);

	// 响应式布局由 CSS 处理，这里仅用于判断是否有组件
	const mobileShowSidebar = false; // 768px及以下不显示侧边栏
	const tabletShowSidebar = sidebarLayoutConfig.enable; // 769px及以上显示
	const desktopShowSidebar = sidebarLayoutConfig.enable; // 1280px及以上显示

	return {
		isBothSidebars,
		hasLeftComponents,
		hasRightComponents,
		mobileShowSidebar,
		tabletShowSidebar,
		desktopShowSidebar,
		position,
		tabletSidebar,
	};
}

/**
 * 生成网格列数CSS类
 *
 * 响应式设计：
 * - 768px及以下: 单列布局（grid-cols-1），隐藏侧栏，显示底部组件
 * - 769px-1279px: 根据position和tabletSidebar配置决定2列布局方向
 * - 1280px及以上: 根据position配置决定2列或3列布局
 */
export function generateGridClasses(config: ResponsiveSidebarConfig): {
	gridCols: string;
} {
	let gridCols = "grid-cols-1";

	if (
		config.isBothSidebars &&
		config.hasLeftComponents &&
		config.hasRightComponents
	) {
		// 双侧边栏
		if (config.tabletSidebar === "right") {
			// 平板端显示右侧栏: 769-1279px [内容+右侧栏], 1280px+ [左+中+右]
			gridCols =
				"grid-cols-1 md:grid-cols-[1fr_17.5rem] xl:grid-cols-[17.5rem_1fr_17.5rem]";
		} else {
			// 平板端显示左侧栏（默认）: 769-1279px [左侧栏+内容], 1280px+ [左+中+右]
			gridCols =
				"grid-cols-1 md:grid-cols-[17.5rem_1fr] xl:grid-cols-[17.5rem_1fr_17.5rem]";
		}
	} else if (config.hasLeftComponents && !config.hasRightComponents) {
		// 仅左侧边栏: 769px+显示左+中，768-以下单列
		gridCols = "grid-cols-1 md:grid-cols-[17.5rem_1fr]";
	} else if (!config.hasLeftComponents && config.hasRightComponents) {
		// 仅右侧边栏: 769px+显示中+右，768-以下单列
		gridCols = "grid-cols-1 md:grid-cols-[1fr_17.5rem]";
	}

	return { gridCols };
}

/**
 * 生成左侧边栏容器CSS类
 */
export function generateSidebarClasses(
	config: ResponsiveSidebarConfig,
): string {
	const classes = [
		"mb-4",
		"hidden",
		"md:col-span-1",
		"md:max-w-70",
		"md:row-start-1",
		"md:row-end-2",
		"md:col-start-1",
		"onload-animation",
	];

	if (config.isBothSidebars && config.tabletSidebar === "right") {
		// 双侧栏+平板端显示右侧栏：左侧栏仅在1280px+显示
		classes.push("xl:block");
	} else {
		// 默认：左侧栏769px+显示
		classes.push("md:block");
	}

	return classes.join(" ");
}

/**
 * 生成右侧边栏CSS类
 */
export function generateRightSidebarClasses(
	config: ResponsiveSidebarConfig,
): string {
	const classes = ["mb-4", "hidden", "onload-animation"];

	if (config.isBothSidebars && config.tabletSidebar === "right") {
		// 双侧栏+平板端显示右侧栏：769px+显示右侧栏
		classes.push(
			"md:block",
			"md:row-start-1",
			"md:row-end-2",
			"md:col-span-1",
			"md:max-w-70",
			"md:col-start-2", // 平板端在第2列
			"xl:col-start-3", // 桌面端在第3列
		);
	} else if (config.isBothSidebars) {
		// 双侧栏+平板端显示左侧栏（默认）：仅1280px+显示
		classes.push(
			"xl:block",
			"xl:row-start-1",
			"xl:row-end-2",
			"xl:col-span-1",
			"xl:max-w-70",
			"xl:col-start-3",
		);
	} else if (config.position === "right") {
		// 仅右侧栏模式（非双侧栏）：769px+显示，在第2列
		classes.push(
			"md:block",
			"md:row-start-1",
			"md:row-end-2",
			"md:col-span-1",
			"md:max-w-70",
			"md:col-start-2",
		);
	} else {
		// 其他情况：仅1280px+显示
		classes.push(
			"xl:block",
			"xl:row-start-1",
			"xl:row-end-2",
			"xl:col-span-1",
			"xl:max-w-70",
			"xl:col-start-3",
		);
	}

	return classes.join(" ");
}

/**
 * 生成主内容区CSS类
 */
export function generateMainContentClasses(
	config: ResponsiveSidebarConfig,
): string {
	const classes = [
		"transition-main",
		// 768px及以下: 单列布局
		"col-span-1",
	];

	if (
		config.isBothSidebars &&
		config.hasLeftComponents &&
		config.hasRightComponents
	) {
		if (config.tabletSidebar === "right") {
			// 双侧栏+平板端右侧栏: 平板端内容在第1列，桌面端内容在第2列
			classes.push("md:col-span-1");
			classes.push("md:col-start-1");
			classes.push("xl:col-span-1");
			classes.push("xl:col-start-2");
			classes.push("xl:col-end-3");
		} else {
			// 双侧栏+平板端左侧栏（默认）: 内容始终在第2列
			classes.push("md:col-span-1");
			classes.push("md:col-start-2");
			classes.push("xl:col-span-1");
			classes.push("xl:col-start-2");
			classes.push("xl:col-end-3");
		}
	} else if (config.hasLeftComponents && !config.hasRightComponents) {
		// 仅左侧边栏: 内容在第2列
		classes.push("md:col-span-1");
		classes.push("md:col-start-2");
	} else if (!config.hasLeftComponents && config.hasRightComponents) {
		// 仅右侧边栏: 内容在第1列
		classes.push("md:col-span-1");
		classes.push("md:col-start-1");
	} else {
		classes.push("col-span-1");
	}

	classes.push("min-w-0");
	classes.push("overflow-hidden");

	return classes.join(" ");
}
</file>

<file path="utils/sakura-manager.ts">
import type { SakuraConfig } from "../types/config";

// 樱花对象类
class Sakura {
	x: number;
	y: number;
	s: number;
	r: number;
	a: number;
	fn: {
		x: (x: number, y: number) => number;
		y: (x: number, y: number) => number;
		r: (r: number) => number;
		a: (a: number) => number;
	};
	idx: number;
	img: HTMLImageElement;
	limitArray: number[];
	config: SakuraConfig;

	constructor(
		x: number,
		y: number,
		s: number,
		r: number,
		a: number,
		fn: {
			x: (x: number, y: number) => number;
			y: (x: number, y: number) => number;
			r: (r: number) => number;
			a: (a: number) => number;
		},
		idx: number,
		img: HTMLImageElement,
		limitArray: number[],
		config: SakuraConfig,
	) {
		this.x = x;
		this.y = y;
		this.s = s;
		this.r = r;
		this.a = a;
		this.fn = fn;
		this.idx = idx;
		this.img = img;
		this.limitArray = limitArray;
		this.config = config;
	}

	draw(cxt: CanvasRenderingContext2D) {
		cxt.save();
		cxt.translate(this.x, this.y);
		cxt.rotate(this.r);
		cxt.globalAlpha = this.a;
		cxt.drawImage(this.img, 0, 0, 40 * this.s, 40 * this.s);
		cxt.restore();
	}

	update() {
		this.x = this.fn.x(this.x, this.y);
		this.y = this.fn.y(this.y, this.y);
		this.r = this.fn.r(this.r);
		this.a = this.fn.a(this.a);

		// 如果樱花越界或完全透明，重新调整位置
		if (
			this.x > window.innerWidth ||
			this.x < 0 ||
			this.y > window.innerHeight ||
			this.y < 0 ||
			this.a <= 0
		) {
			// 如果樱花不做限制
			if (this.limitArray[this.idx] === -1) {
				this.resetPosition();
			}
			// 否则樱花有限制
			else {
				if (this.limitArray[this.idx] > 0) {
					this.resetPosition();
					this.limitArray[this.idx]--;
				}
			}
		}
	}

	private resetPosition() {
		this.fn.r = getRandom("fnr", this.config);
		if (Math.random() > 0.4) {
			this.x = getRandom("x", this.config);
			this.y = 0;
			this.s = getRandom("s", this.config);
			this.r = getRandom("r", this.config);
			this.a = getRandom("a", this.config);
		} else {
			this.x = window.innerWidth;
			this.y = getRandom("y", this.config);
			this.s = getRandom("s", this.config);
			this.r = getRandom("r", this.config);
			this.a = getRandom("a", this.config);
		}
	}
}

// 樱花列表类
class SakuraList {
	list: Sakura[];

	constructor() {
		this.list = [];
	}

	push(sakura: Sakura) {
		this.list.push(sakura);
	}

	update() {
		for (let i = 0, len = this.list.length; i < len; i++) {
			this.list[i].update();
		}
	}

	draw(cxt: CanvasRenderingContext2D) {
		for (let i = 0, len = this.list.length; i < len; i++) {
			this.list[i].draw(cxt);
		}
	}

	get(i: number) {
		return this.list[i];
	}

	size() {
		return this.list.length;
	}
}

// 获取随机值的函数
function getRandom(
	option: "x" | "y" | "s" | "r" | "a",
	config: SakuraConfig,
): number;
function getRandom(
	option: "fnx" | "fny" | "fnr" | "fna",
	config: SakuraConfig,
): (...args: number[]) => number;
function getRandom(
	option: string,
	config: SakuraConfig,
): number | ((...args: number[]) => number) {
	let ret: number | ((...args: number[]) => number) = 0;
	let random: number;

	switch (option) {
		case "x":
			ret = Math.random() * window.innerWidth;
			break;
		case "y":
			ret = Math.random() * window.innerHeight;
			break;
		case "s":
			ret =
				config.size.min + Math.random() * (config.size.max - config.size.min);
			break;
		case "r":
			ret = Math.random() * 6;
			break;
		case "a":
			ret =
				config.opacity.min +
				Math.random() * (config.opacity.max - config.opacity.min);
			break;
		case "fnx":
			random =
				config.speed.horizontal.min +
				Math.random() *
					(config.speed.horizontal.max - config.speed.horizontal.min);
			ret = (x: number, _y: number) => x + random;
			break;
		case "fny":
			random =
				config.speed.vertical.min +
				Math.random() * (config.speed.vertical.max - config.speed.vertical.min);
			ret = (_x: number, y: number) => y + random;
			break;
		case "fnr":
			ret = (r: number) => r + config.speed.rotation;
			break;
		case "fna":
			ret = (alpha: number) => alpha - config.speed.fadeSpeed * 0.01;
			break;
	}
	return ret;
}

// 樱花管理器类
export class SakuraManager {
	private config: SakuraConfig;
	private canvas: HTMLCanvasElement | null = null;
	private ctx: CanvasRenderingContext2D | null = null;
	private sakuraList: SakuraList | null = null;
	private animationId: number | null = null;
	private img: HTMLImageElement | null = null;
	private isRunning = false;

	constructor(config: SakuraConfig) {
		this.config = config;
	}

	// 初始化樱花特效
	async init(): Promise<void> {
		if (!this.config.enable || this.isRunning) {
			return;
		}

		// 创建图片对象
		this.img = new Image();
		this.img.src = "/sakura.png"; // 使用樱花图片

		// 等待图片加载完成
		await new Promise<void>((resolve, reject) => {
			if (this.img) {
				this.img.onload = () => resolve();
				this.img.onerror = () =>
					reject(new Error("Failed to load sakura image"));
			}
		});

		this.createCanvas();
		this.createSakuraList();
		this.startAnimation();
		this.isRunning = true;
	}

	// 创建画布
	private createCanvas(): void {
		this.canvas = document.createElement("canvas");
		this.canvas.height = window.innerHeight;
		this.canvas.width = window.innerWidth;
		this.canvas.setAttribute(
			"style",
			`position: fixed; left: 0; top: 0; pointer-events: none; z-index: ${this.config.zIndex};`,
		);
		this.canvas.setAttribute("id", "canvas_sakura");
		document.body.appendChild(this.canvas);
		this.ctx = this.canvas.getContext("2d");

		// 监听窗口大小变化
		window.addEventListener("resize", this.handleResize.bind(this));
	}

	// 创建樱花列表
	private createSakuraList(): void {
		if (!this.img || !this.ctx) return;

		this.sakuraList = new SakuraList();
		const limitArray = new Array(this.config.sakuraNum).fill(
			this.config.limitTimes,
		);

		for (let i = 0; i < this.config.sakuraNum; i++) {
			const randomX = getRandom("x", this.config);
			const randomY = getRandom("y", this.config);
			const randomS = getRandom("s", this.config);
			const randomR = getRandom("r", this.config);
			const randomA = getRandom("a", this.config);
			const randomFnx = getRandom("fnx", this.config);
			const randomFny = getRandom("fny", this.config);
			const randomFnR = getRandom("fnr", this.config);
			const randomFnA = getRandom("fna", this.config);

			const sakura = new Sakura(
				randomX,
				randomY,
				randomS,
				randomR,
				randomA,
				{
					x: randomFnx,
					y: randomFny,
					r: randomFnR,
					a: randomFnA,
				},
				i,
				this.img,
				limitArray,
				this.config,
			);

			sakura.draw(this.ctx);
			this.sakuraList.push(sakura);
		}
	}

	// 开始动画
	private startAnimation(): void {
		if (!this.ctx || !this.canvas || !this.sakuraList) return;

		const animate = () => {
			if (!this.ctx || !this.canvas || !this.sakuraList) return;

			this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
			this.sakuraList.update();
			this.sakuraList.draw(this.ctx);
			this.animationId = requestAnimationFrame(animate);
		};

		this.animationId = requestAnimationFrame(animate);
	}

	// 处理窗口大小变化
	private handleResize(): void {
		if (this.canvas) {
			this.canvas.width = window.innerWidth;
			this.canvas.height = window.innerHeight;
		}
	}

	// 停止樱花特效
	stop(): void {
		if (this.animationId) {
			cancelAnimationFrame(this.animationId);
			this.animationId = null;
		}

		if (this.canvas) {
			document.body.removeChild(this.canvas);
			this.canvas = null;
		}

		window.removeEventListener("resize", this.handleResize.bind(this));
		this.isRunning = false;
	}

	// 切换樱花特效
	toggle(): void {
		if (this.isRunning) {
			this.stop();
		} else {
			this.init();
		}
	}

	// 更新配置
	updateConfig(newConfig: SakuraConfig): void {
		const wasRunning = this.isRunning;
		if (wasRunning) {
			this.stop();
		}
		this.config = newConfig;
		if (wasRunning && newConfig.enable) {
			this.init();
		}
	}

	// 获取运行状态
	getIsRunning(): boolean {
		return this.isRunning;
	}
}

// 创建全局樱花管理器实例
let globalSakuraManager: SakuraManager | null = null;

// 初始化樱花特效
export function initSakura(config: SakuraConfig): void {
	if (globalSakuraManager) {
		globalSakuraManager.updateConfig(config);
	} else {
		globalSakuraManager = new SakuraManager(config);
		if (config.enable) {
			globalSakuraManager.init();
		}
	}
}

// 切换樱花特效
export function toggleSakura(): void {
	if (globalSakuraManager) {
		globalSakuraManager.toggle();
	}
}

// 停止樱花特效
export function stopSakura(): void {
	if (globalSakuraManager) {
		globalSakuraManager.stop();
		globalSakuraManager = null;
	}
}

// 获取樱花特效运行状态
export function getSakuraStatus(): boolean {
	return globalSakuraManager ? globalSakuraManager.getIsRunning() : false;
}
</file>

<file path="utils/setting-utils.ts">
import {
    BANNER_HEIGHT_EXTEND,
    DARK_MODE,
    DEFAULT_THEME,
    LIGHT_MODE,
    SYSTEM_MODE,
    WALLPAPER_BANNER,
    WALLPAPER_NONE,
    WALLPAPER_OVERLAY,
} from "@constants/constants";
import type { BackgroundWallpaperConfig, LIGHT_DARK_MODE, WALLPAPER_MODE } from "@/types/config";
import {
    backgroundWallpaper,
    expressiveCodeConfig,
    siteConfig,
} from "../config";
import { isHomePage as checkIsHomePage } from "./layout-utils";

// Declare global functions
declare global {
    interface Window {
        initSemifullScrollDetection?: () => void;
        semifullScrollHandler?: () => void;
    }
}

export function getDefaultHue(): number {
    const fallback = "250";
    // 检查是否在浏览器环境中
    if (typeof document === "undefined") {
        return Number.parseInt(fallback, 10);
    }
    const configCarrier = document.getElementById("config-carrier");
    return Number.parseInt(configCarrier?.dataset.hue || fallback, 10);
}

export function getDefaultTheme(): LIGHT_DARK_MODE {
    // 如果配置文件中设置了 defaultMode，使用配置的值
    // 否则使用 DEFAULT_THEME（向后兼容）
    return siteConfig.themeColor.defaultMode ?? DEFAULT_THEME;
}

// 获取系统主题
export function getSystemTheme(): LIGHT_DARK_MODE {
    if (typeof window === "undefined") {
        return LIGHT_MODE;
    }
    return window.matchMedia("(prefers-color-scheme: dark)").matches
        ? DARK_MODE
        : LIGHT_MODE;
}

// 解析主题（如果是system模式，则获取系统主题）
export function resolveTheme(theme: LIGHT_DARK_MODE): LIGHT_DARK_MODE {
    if (theme === SYSTEM_MODE) {
        return getSystemTheme();
    }
    return theme;
}

export function getHue(): number {
    // 先检查全局对象
    if (typeof window === "undefined" || !window.localStorage) {
        return getDefaultHue();
    }
    const stored = localStorage.getItem("hue");
    return stored ? Number.parseInt(stored, 10) : getDefaultHue();
}

export function setHue(hue: number): void {
    // 先检查是否在浏览器环境
    if (
        typeof window === "undefined" ||
        !window.localStorage ||
        typeof document === "undefined"
    ) {
        return;
    }
    localStorage.setItem("hue", String(hue));
    const r = document.querySelector(":root") as HTMLElement;
    if (!r) {
        return;
    }
    r.style.setProperty("--hue", String(hue));
}

export function applyThemeToDocument(theme: LIGHT_DARK_MODE) {
    // 检查是否在浏览器环境中
    if (typeof document === "undefined") {
        return;
    }

    // 解析主题
    const resolvedTheme = resolveTheme(theme);

    // 获取当前主题状态的完整信息
    const currentIsDark = document.documentElement.classList.contains("dark");
    const currentTheme = document.documentElement.getAttribute("data-theme");

    // 计算目标主题状态
    let targetIsDark = false; // 初始化默认值
    switch (resolvedTheme) {
        case LIGHT_MODE:
            targetIsDark = false;
            break;
        case DARK_MODE:
            targetIsDark = true;
            break;
        default:
            // 处理默认情况，使用当前主题状态
            targetIsDark = currentIsDark;
            break;
    }

    // 检测是否真的需要主题切换：
    // 1. dark类状态是否改变
    // 2. expressiveCode主题是否需要更新
    const needsThemeChange = currentIsDark !== targetIsDark;
    const expectedTheme = targetIsDark
        ? expressiveCodeConfig.darkTheme
        : expressiveCodeConfig.lightTheme;
    const needsCodeThemeUpdate = currentTheme !== expectedTheme;

    // 如果既不需要主题切换也不需要代码主题更新，直接返回
    if (!needsThemeChange && !needsCodeThemeUpdate) {
        return;
    }

    // 批量 DOM 操作，减少重绘
    if (needsThemeChange) {
        // 添加过渡保护类（但会导致大量重绘，所以使用更轻量的方式）
        // document.documentElement.classList.add("is-theme-transitioning");

        // 直接切换主题，利用 CSS 变量的特性让浏览器优化过渡
        if (targetIsDark) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }
    }

    // Set the theme for Expressive Code based on current mode
    if (needsCodeThemeUpdate) {
        document.documentElement.setAttribute("data-theme", expectedTheme);
    }
}

// 系统主题监听器引用
let systemThemeListener:
    | ((e: MediaQueryListEvent | MediaQueryList) => void)
    | null = null;

export function setTheme(theme: LIGHT_DARK_MODE): void {
    // 检查是否在浏览器环境中
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.setItem !== "function"
    ) {
        return;
    }

    // 先应用主题
    applyThemeToDocument(theme);

    // 保存到localStorage
    localStorage.setItem("theme", theme);

    // 如果切换到 system 模式，需要监听系统主题变化
    if (theme === SYSTEM_MODE) {
        setupSystemThemeListener();
    } else {
        // 如果切换其他模式，移除系统主题监听
        cleanupSystemThemeListener();
    }
}

// 设置系统主题监听器
export function setupSystemThemeListener() {
    // 先清理之前的监听器
    cleanupSystemThemeListener();

    if (typeof window === "undefined") {
        return;
    }

    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");

    // 处理系统主题变化的回调
    const handleSystemThemeChange = (e: MediaQueryListEvent | MediaQueryList) => {
        const isDark = e.matches;
        const currentIsDark = document.documentElement.classList.contains("dark");

        // 如果主题状态没有变化，直接返回
        if (currentIsDark === isDark) {
            return;
        }

        // 直接应用系统主题，不使用过渡保护类以避免大量重绘
        if (isDark) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }

        // Set the theme for Expressive Code
        const expressiveTheme = isDark
            ? expressiveCodeConfig.darkTheme
            : expressiveCodeConfig.lightTheme;
        document.documentElement.setAttribute("data-theme", expressiveTheme);

        // 触发自定义事件通知其他组件（仅在真正切换时触发）
        window.dispatchEvent(new CustomEvent("theme-change"));
    };

    // 立即调用一次以设置初始状态
    handleSystemThemeChange(mediaQuery);

    // 监听系统主题变化（现代浏览器）
    if (mediaQuery.addEventListener) {
        mediaQuery.addEventListener("change", handleSystemThemeChange);
    } else {
        // 兼容旧浏览器
        mediaQuery.addListener(handleSystemThemeChange);
    }

    systemThemeListener = handleSystemThemeChange;
}

// 清理系统主题监听器
function cleanupSystemThemeListener() {
    if (typeof window === "undefined" || !systemThemeListener) {
        return;
    }

    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");

    if (mediaQuery.removeEventListener) {
        mediaQuery.removeEventListener("change", systemThemeListener);
    } else {
        // 兼容旧浏览器
        mediaQuery.removeListener(systemThemeListener);
    }

    systemThemeListener = null;
}

export function getStoredTheme(): LIGHT_DARK_MODE {
    // 检查是否在浏览器环境中
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.getItem !== "function"
    ) {
        return getDefaultTheme();
    }
    return (
        (localStorage.getItem("theme") as LIGHT_DARK_MODE) || getDefaultTheme()
    );
}

// 初始化主题监听器（用于页面加载后）
export function initThemeListener() {
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.getItem !== "function"
    ) {
        return;
    }

    const theme = getStoredTheme();

    // 如果主题是 system 模式，需要监听系统主题变化
    if (theme === SYSTEM_MODE) {
        setupSystemThemeListener();
    }
}

// Wallpaper mode functions
export function applyWallpaperModeToDocument(mode: WALLPAPER_MODE) {
    // 检查是否允许切换壁纸模式
    const isSwitchable = backgroundWallpaper.switchable ?? true;
    if (!isSwitchable) {
        // 如果不允许切换，直接返回，不执行任何操作
        return;
    }

    // 获取当前的壁纸模式
    const currentMode =
        (document.documentElement.getAttribute(
            "data-wallpaper-mode",
        ) as WALLPAPER_MODE) || backgroundWallpaper.mode;

    // 如果模式没有变化，直接返回
    if (currentMode === mode) {
        // 即使是相同模式，也要确保UI状态正确
        ensureWallpaperState(mode);
        return;
    }

    // 添加过渡保护类
    document.documentElement.classList.add("is-wallpaper-transitioning");

    // 更新数据属性
    document.documentElement.setAttribute("data-wallpaper-mode", mode);

    // 使用 requestAnimationFrame 确保在下一帧执行，避免闪屏
    requestAnimationFrame(() => {
        const body = document.body;

        // 移除所有壁纸相关的CSS类
        body.classList.remove("enable-banner", "wallpaper-transparent");

        // 根据模式添加相应的CSS类
        switch (mode) {
            case WALLPAPER_BANNER:
                body.classList.add("enable-banner");
                showBannerMode();
                break;
            case WALLPAPER_OVERLAY:
                body.classList.add("wallpaper-transparent");
                showOverlayMode();
                break;
            case WALLPAPER_NONE:
                hideAllWallpapers();
                break;
            default:
                hideAllWallpapers();
                break;
        }

        // 更新导航栏透明模式
        updateNavbarTransparency(mode);

        // 在下一帧移除过渡保护类
        requestAnimationFrame(() => {
            document.documentElement.classList.remove("is-wallpaper-transitioning");
        });
    });
}

// 确保壁纸状态正确
function ensureWallpaperState(mode: WALLPAPER_MODE) {
    const body = document.body;

    // 移除所有壁纸相关的CSS类
    body.classList.remove("enable-banner", "wallpaper-transparent");

    // 根据模式添加相应的CSS类
    switch (mode) {
        case WALLPAPER_BANNER:
            body.classList.add("enable-banner");
            showBannerMode();
            break;
        case WALLPAPER_OVERLAY:
            body.classList.add("wallpaper-transparent");
            showOverlayMode();
            break;
        case WALLPAPER_NONE:
            hideAllWallpapers();
            break;
    }

    // 更新导航栏透明模式
    updateNavbarTransparency(mode);
}

function showBannerMode() {
    // 显示 wallpaper-wrapper 并切换为 banner 模式
    const wallpaperWrapper = document.getElementById("wallpaper-wrapper");
    if (wallpaperWrapper) {
        // 移除 overlay 模式类
        wallpaperWrapper.classList.remove("wallpaper-overlay");

        // 恢复 banner 模式的 top 定位
        wallpaperWrapper.style.top = `-${BANNER_HEIGHT_EXTEND}vh`;

        // 检查当前是否为首页
        const isHomePage = checkIsHomePage(window.location.pathname);
        const isMobile = window.innerWidth < 1024;

        // 移动端非首页时，不显示banner；桌面端始终显示
        if (isMobile && !isHomePage) {
            wallpaperWrapper.style.display = "none";
            wallpaperWrapper.classList.add("mobile-hide-banner");
        } else {
            // 首页或桌面端：先设置display，然后使用requestAnimationFrame确保渲染
            wallpaperWrapper.style.display = "block";
            wallpaperWrapper.style.setProperty("display", "block", "important");
            requestAnimationFrame(() => {
                wallpaperWrapper.classList.remove("hidden");
                wallpaperWrapper.classList.remove("opacity-0");
                wallpaperWrapper.classList.add("opacity-100");
                wallpaperWrapper.classList.remove("mobile-hide-banner");
            });
        }
    }

    // 显示横幅图片来源文本
    const creditDesktop = document.getElementById("banner-credit-desktop");
    const creditMobile = document.getElementById("banner-credit-mobile");
    if (creditDesktop) creditDesktop.style.display = "";
    if (creditMobile) creditMobile.style.display = "";

    // 显示横幅首页文本（如果启用且是首页）
    const bannerTextOverlay = document.querySelector(".banner-home-text-overlay");
    if (bannerTextOverlay) {
        // 检查是否启用 homeText
        const homeTextEnabled = backgroundWallpaper.banner?.homeText?.enable;

        // 检查当前是否为首页
        const isHomePage = checkIsHomePage(window.location.pathname);

        // 只有在启用且在首页时才显示
        if (homeTextEnabled && isHomePage) {
            bannerTextOverlay.classList.remove("hidden");
        } else {
            bannerTextOverlay.classList.add("hidden");
        }
    }

    // 调整主内容位置
    adjustMainContentPosition("banner");

    // 处理移动端非首页主内容区域位置
    const mainContentWrapper = document.querySelector(".absolute.w-full.z-30");
    if (mainContentWrapper) {
        const isHomePage = checkIsHomePage(window.location.pathname);
        const isMobile = window.innerWidth < 1024;
        // 只在移动端非首页时调整主内容位置
        if (isMobile && !isHomePage) {
            mainContentWrapper.classList.add("mobile-main-no-banner");
        } else {
            mainContentWrapper.classList.remove("mobile-main-no-banner");
        }
    }

    // 移除透明效果（横幅模式不使用半透明）
    adjustMainContentTransparency(false);

    // 调整导航栏透明度
    const navbar = document.getElementById("navbar");
    if (navbar) {
        // 获取导航栏透明模式配置（banner模式）
        const transparentMode =
            backgroundWallpaper.banner?.navbar?.transparentMode || "semi";
        navbar.setAttribute("data-transparent-mode", transparentMode);

        // 重新初始化半透明模式滚动检测（如果需要）
        if (
            transparentMode === "semifull" &&
            typeof window.initSemifullScrollDetection === "function"
        ) {
            window.initSemifullScrollDetection();
        }
    }
}

function showOverlayMode() {
    // 切换 wallpaper-wrapper 为 overlay 模式
    const wallpaperWrapper = document.getElementById("wallpaper-wrapper");
    if (wallpaperWrapper) {
        // 添加 overlay 模式类
        wallpaperWrapper.classList.add("wallpaper-overlay");
        // 显示壁纸
        wallpaperWrapper.style.display = "block";
        wallpaperWrapper.style.setProperty("display", "block", "important");
        wallpaperWrapper.style.top = "";
        requestAnimationFrame(() => {
            wallpaperWrapper.classList.remove("hidden");
            wallpaperWrapper.classList.remove("opacity-0");
            wallpaperWrapper.classList.add("opacity-100");
            wallpaperWrapper.classList.remove("mobile-hide-banner");
        });
    }

    // 隐藏横幅图片来源文本
    const creditDesktop = document.getElementById("banner-credit-desktop");
    const creditMobile = document.getElementById("banner-credit-mobile");
    if (creditDesktop) creditDesktop.style.display = "none";
    if (creditMobile) creditMobile.style.display = "none";

    // 隐藏横幅首页文本
    const bannerTextOverlay = document.querySelector(".banner-home-text-overlay");
    if (bannerTextOverlay) {
        bannerTextOverlay.classList.add("hidden");
    }

    // 调整主内容透明度
    adjustMainContentTransparency(true);

    // 调整布局为紧凑模式
    adjustMainContentPosition("overlay");
}

function hideAllWallpapers() {
    // 隐藏壁纸
    const wallpaperWrapper = document.getElementById("wallpaper-wrapper");

    if (wallpaperWrapper) {
        wallpaperWrapper.style.display = "none";
        wallpaperWrapper.classList.add("hidden");
        wallpaperWrapper.classList.add("opacity-0");
        wallpaperWrapper.classList.remove("wallpaper-overlay");
    }

    // 隐藏横幅图片来源文本
    const creditDesktop = document.getElementById("banner-credit-desktop");
    const creditMobile = document.getElementById("banner-credit-mobile");
    if (creditDesktop) creditDesktop.style.display = "none";
    if (creditMobile) creditMobile.style.display = "none";

    // 隐藏横幅首页文本
    const bannerTextOverlay = document.querySelector(".banner-home-text-overlay");
    if (bannerTextOverlay) {
        bannerTextOverlay.classList.add("hidden");
    }

    // 调整主内容位置和透明度
    adjustMainContentPosition("none");
    adjustMainContentTransparency(false);
}

function updateNavbarTransparency(mode: WALLPAPER_MODE) {
    const navbar = document.getElementById("navbar");
    if (!navbar) return;

    let transparentMode: string;
    let enableBlur: boolean;

    // 根据当前壁纸模式设置导航栏透明模式和模糊效果
    if (mode === WALLPAPER_OVERLAY) {
        // 全屏壁纸模式
        transparentMode = "none";
        enableBlur = false;
    } else if (mode === WALLPAPER_NONE) {
        // 纯色背景模式
        transparentMode = "none";
        enableBlur = false;
    } else {
        // Banner模式：使用配置的透明模式和模糊效果
        transparentMode =
            backgroundWallpaper.banner?.navbar?.transparentMode || "semi";
        enableBlur = backgroundWallpaper.banner?.navbar?.enableBlur ?? true;
    }

    // 更新导航栏的透明模式属性
    navbar.setAttribute("data-transparent-mode", transparentMode);
    navbar.setAttribute("data-enable-blur", String(enableBlur));

    // 移除现有的透明模式类
    navbar.classList.remove(
        "navbar-transparent-semi",
        "navbar-transparent-full",
        "navbar-transparent-semifull",
    );

    // 移除scrolled类
    navbar.classList.remove("scrolled");

    // 滚动检测功能
    if (
        transparentMode === "semifull" &&
        mode === WALLPAPER_BANNER &&
        typeof window.initSemifullScrollDetection === "function"
    ) {
        // 仅在Banner模式的semifull下启用滚动检测
        window.initSemifullScrollDetection();
    } else if (window.semifullScrollHandler) {
        // 移除滚动监听器
        window.removeEventListener("scroll", window.semifullScrollHandler);
        delete window.semifullScrollHandler;
    }
}

function adjustMainContentPosition(
    mode: WALLPAPER_MODE | "banner" | "none" | "overlay",
) {
    const mainContent = document.querySelector(
        ".absolute.w-full.z-30",
    ) as HTMLElement;
    if (!mainContent) return;

    // 移除现有的位置类
    mainContent.classList.remove("mobile-main-no-banner", "no-banner-layout");

    switch (mode) {
        case "banner":
            // Banner模式：主内容在banner下方
            mainContent.style.top = "calc(var(--banner-height) - 3rem)";
            break;
        case "overlay":
            // Overlay模式：使用紧凑布局，主内容从导航栏下方开始
            mainContent.classList.add("no-banner-layout");
            mainContent.style.top = "5.5rem";
            break;
        case "none":
            // 无壁纸模式：主内容从导航栏下方开始
            mainContent.classList.add("no-banner-layout");
            mainContent.style.top = "5.5rem";
            break;
        default:
            mainContent.style.top = "5.5rem";
            break;
    }
}

function adjustMainContentTransparency(enable: boolean) {
    const mainContent = document.querySelector(".absolute.w-full.z-30");
    const body = document.body;

    if (!mainContent || !body) return;

    if (enable) {
        mainContent.classList.add("wallpaper-transparent");
        body.classList.add("wallpaper-transparent");
    } else {
        mainContent.classList.remove("wallpaper-transparent");
        body.classList.remove("wallpaper-transparent");
    }
}

export function setWallpaperMode(mode: WALLPAPER_MODE): void {
    // 检查是否在浏览器环境中
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.setItem !== "function"
    ) {
        return;
    }
    localStorage.setItem("wallpaperMode", mode);
    applyWallpaperModeToDocument(mode);
}

export function initWallpaperMode(): void {
    const storedMode = getStoredWallpaperMode();
    applyWallpaperModeToDocument(storedMode);
}

export function getStoredWallpaperMode(): WALLPAPER_MODE {
    // 检查是否在浏览器环境中
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.getItem !== "function"
    ) {
        return backgroundWallpaper.mode;
    }
    return (
        (localStorage.getItem("wallpaperMode") as WALLPAPER_MODE) ||
        backgroundWallpaper.mode
    );
}

// Waves animation functions
export function getDefaultWavesEnabled(): boolean {
    const wavesConfig = backgroundWallpaper.banner?.waves?.enable;
    if (typeof wavesConfig === "object") {
        // 如果是分设备配置，检查当前设备
        const isMobile =
            typeof window !== "undefined" ? window.innerWidth < 768 : false;
        return isMobile
            ? (wavesConfig.mobile ?? false)
            : (wavesConfig.desktop ?? false);
    }
    return wavesConfig ?? false;
}

export function getStoredWavesEnabled(): boolean {
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.getItem !== "function"
    ) {
        return getDefaultWavesEnabled();
    }
    const stored = localStorage.getItem("wavesEnabled");
    if (stored === null) {
        return getDefaultWavesEnabled();
    }
    return stored === "true";
}

export function setWavesEnabled(enabled: boolean): void {
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.setItem !== "function"
    ) {
        return;
    }
    localStorage.setItem("wavesEnabled", String(enabled));
    applyWavesEnabledToDocument(enabled);
}

export function applyWavesEnabledToDocument(enabled: boolean): void {
    if (typeof document === "undefined") {
        return;
    }
    // 更新 html 属性，CSS 会立即生效
    document.documentElement.setAttribute("data-waves-enabled", String(enabled));
    // 同时更新元素样式（兼容性）
    const wavesElement = document.getElementById("header-waves");
    if (wavesElement) {
        if (enabled) {
            wavesElement.style.display = "";
            wavesElement.classList.remove("waves-disabled");
        } else {
            wavesElement.style.display = "none";
            wavesElement.classList.add("waves-disabled");
        }
    }
}

// Banner title functions
export function getDefaultBannerTitleEnabled(): boolean {
    return backgroundWallpaper.banner?.homeText?.enable ?? true;
}

export function getStoredBannerTitleEnabled(): boolean {
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.getItem !== "function"
    ) {
        return getDefaultBannerTitleEnabled();
    }
    const stored = localStorage.getItem("bannerTitleEnabled");
    if (stored === null) {
        return getDefaultBannerTitleEnabled();
    }
    return stored === "true";
}

export function setBannerTitleEnabled(enabled: boolean): void {
    if (
        typeof localStorage === "undefined" ||
        typeof localStorage.setItem !== "function"
    ) {
        return;
    }
    localStorage.setItem("bannerTitleEnabled", String(enabled));
    applyBannerTitleEnabledToDocument(enabled);
}

export function applyBannerTitleEnabledToDocument(enabled: boolean): void {
    if (typeof document === "undefined") {
        return;
    }
    // 更新 html 属性，CSS 会立即生效
    document.documentElement.setAttribute(
        "data-banner-title-enabled",
        String(enabled),
    );
    // 同时更新元素样式（兼容性）
    const bannerTextOverlay = document.querySelector(
        ".banner-home-text-overlay",
    ) as HTMLElement;
    if (bannerTextOverlay) {
        if (enabled) {
            bannerTextOverlay.classList.remove("user-hidden");
        } else {
            bannerTextOverlay.classList.add("user-hidden");
        }
    }
}
</file>

<file path="utils/tocUtils.ts">
/**
 * TOC (Table of Contents) 工具类
 * 用于 SidebarTOC 和 FloatingTOC 的共享逻辑
 */

export interface TOCConfig {
	contentId: string;
	indicatorId: string;
	maxLevel?: number;
	scrollOffset?: number;
}

export class TOCManager {
	private tocItems: HTMLElement[] = [];
	private observer: IntersectionObserver | null = null;
	private minDepth = 10;
	private maxLevel: number;
	private scrollTimeout: number | null = null;
	private contentId: string;
	private indicatorId: string;
	private scrollOffset: number;

	constructor(config: TOCConfig) {
		this.contentId = config.contentId;
		this.indicatorId = config.indicatorId;
		this.maxLevel = config.maxLevel || 3;
		this.scrollOffset = config.scrollOffset || 80;
	}

	/**
	 * 查找文章内容容器
	 */
	private getContentContainer(): Element | null {
		return (
			document.querySelector(".custom-md") ||
			document.querySelector(".prose") ||
			document.querySelector(".markdown-content")
		);
	}

	/**
	 * 查找所有标题
	 */
	private getAllHeadings(): HTMLElement[] {
		const contentContainer = this.getContentContainer();
		if (!contentContainer) {
			return [];
		}
		return Array.from(
			contentContainer.querySelectorAll("h1, h2, h3, h4, h5, h6"),
		);
	}

	/**
	 * 计算最小深度
	 */
	private calculateMinDepth(headings: HTMLElement[]): number {
		let minDepth = 10;
		headings.forEach((heading) => {
			const depth = Number.parseInt(heading.tagName.charAt(1), 10);
			minDepth = Math.min(minDepth, depth);
		});
		return minDepth;
	}

	/**
	 * 过滤标题
	 */
	private filterHeadings(headings: HTMLElement[]): HTMLElement[] {
		return Array.from(headings).filter((heading) => {
			const depth = Number.parseInt(heading.tagName.charAt(1), 10);
			return depth < this.minDepth + this.maxLevel;
		});
	}

	/**
	 * 获取标题的纯文本内容（排除 script/style 标签的文本）
	 */
	private getCleanTextContent(element: HTMLElement): string {
		const clone = element.cloneNode(true) as HTMLElement;
		for (const el of clone.querySelectorAll("script, style")) {
			el.remove();
		}
		return clone.textContent || "";
	}

	/**
	 * 生成徽章内容
	 */
	private generateBadgeContent(depth: number, heading1Count: number): string {
		if (depth === this.minDepth) {
			return heading1Count.toString();
		}
		if (depth === this.minDepth + 1) {
			return '<div class="transition w-2 h-2 rounded-[0.1875rem] bg-(--toc-badge-bg)"></div>';
		}
		return '<div class="transition w-1.5 h-1.5 rounded-xs bg-black/5 dark:bg-white/10"></div>';
	}

	/**
	 * 生成TOC HTML
	 */
	public generateTOCHTML(): string {
		const headings = this.getAllHeadings();

		if (headings.length === 0) {
			return '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p>当前页面没有目录</p></div>';
		}

		this.minDepth = this.calculateMinDepth(headings);
		const filteredHeadings = this.filterHeadings(headings);

		if (filteredHeadings.length === 0) {
			return '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p>当前页面没有目录</p></div>';
		}

		let tocHTML = "";
		let heading1Count = 1;

		filteredHeadings.forEach((heading) => {
			const depth = Number.parseInt(heading.tagName.charAt(1), 10);
			const depthClass =
				depth === this.minDepth
					? ""
					: depth === this.minDepth + 1
						? "pl-4"
						: "pl-8";

			if (!heading.id) {
				return;
			}

			const badgeContent = this.generateBadgeContent(depth, heading1Count);
			if (depth === this.minDepth) {
				heading1Count++;
			}

			let headingText = this.getCleanTextContent(heading)
				.replace(/#+\s*$/, "")
				.trim();

			// Fallback for empty text (e.g. dynamic subtitle)
			if (!headingText) {
				const dataSubtitles = heading.getAttribute("data-subtitles");
				if (dataSubtitles) {
					try {
						const subtitles = JSON.parse(dataSubtitles);
						headingText = Array.isArray(subtitles) ? subtitles[0] : subtitles;
					} catch {
						// ignore
					}
				}
			}

			if (!headingText) {
				headingText =
					heading.id === "banner-subtitle"
						? "Banner Subtitle"
						: heading.id || "Heading";
			}

			tocHTML += `
        <a 
          href="#${heading.id}" 
          class="px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-(--toc-btn-hover) active:bg-(--toc-btn-active) py-2 ${depthClass}"
          data-heading-id="${heading.id}"
          aria-label="${headingText}"
        >
          <div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ${depth === this.minDepth ? "bg-(--toc-badge-bg) text-(--btn-content)" : ""}">
            ${badgeContent}
          </div>
          <div class="transition text-sm ${depth <= this.minDepth + 1 ? "text-50" : "text-30"} flex-1 min-w-0 overflow-hidden text-ellipsis whitespace-nowrap">${headingText}</div>
        </a>
      `;
		});

		tocHTML += `<div id="${this.indicatorId}" style="opacity: 0;" class="-z-10 absolute bg-(--toc-btn-hover) left-0 right-0 rounded-xl transition-all"></div>`;

		return tocHTML;
	}

	/**
	 * 更新TOC内容
	 */
	public updateTOCContent(): void {
		const tocContent = document.getElementById(this.contentId);
		if (!tocContent) return;

		tocContent.innerHTML = this.generateTOCHTML();
		this.tocItems = Array.from(
			document.querySelectorAll(`#${this.contentId} a`),
		);
	}

	/**
	 * 获取可见的标题ID
	 */
	private getVisibleHeadingIds(): string[] {
		const headings = this.getAllHeadings();
		const visibleHeadingIds: string[] = [];

		headings.forEach((heading) => {
			if (heading.id) {
				const rect = heading.getBoundingClientRect();
				const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

				if (isVisible) {
					visibleHeadingIds.push(heading.id);
				}
			}
		});

		// 如果没有可见标题，选择最接近屏幕顶部的标题
		if (visibleHeadingIds.length === 0 && headings.length > 0) {
			let closestHeading: string | null = null;
			let minDistance = Number.POSITIVE_INFINITY;

			headings.forEach((heading) => {
				if (heading.id) {
					const rect = heading.getBoundingClientRect();
					const distance = Math.abs(rect.top);

					if (distance < minDistance) {
						minDistance = distance;
						closestHeading = heading.id;
					}
				}
			});

			if (closestHeading) {
				visibleHeadingIds.push(closestHeading);
			}
		}

		return visibleHeadingIds;
	}

	/**
	 * 更新活动状态
	 */
	public updateActiveState(): void {
		if (!this.tocItems || this.tocItems.length === 0) return;

		// 移除所有活动状态
		this.tocItems.forEach((item) => {
			item.classList.remove("visible");
		});

		const visibleHeadingIds = this.getVisibleHeadingIds();

		// 找到对应的TOC项并添加活动状态
		const activeItems = this.tocItems.filter((item) => {
			const headingId = item.dataset.headingId;
			return headingId && visibleHeadingIds.includes(headingId);
		});

		// 添加活动状态
		activeItems.forEach((item) => {
			item.classList.add("visible");
		});

		// 更新活动指示器
		this.updateActiveIndicator(activeItems);
	}

	/**
	 * 更新活动指示器
	 */
	private updateActiveIndicator(activeItems: HTMLElement[]): void {
		const indicator = document.getElementById(this.indicatorId);
		if (!indicator || !this.tocItems.length) return;

		if (activeItems.length === 0) {
			indicator.style.opacity = "0";
			return;
		}

		const tocContent = document.getElementById(this.contentId);
		if (!tocContent) return;

		const contentRect = tocContent.getBoundingClientRect();
		const firstActive = activeItems[0];
		const lastActive = activeItems[activeItems.length - 1];

		const firstRect = firstActive.getBoundingClientRect();
		const lastRect = lastActive.getBoundingClientRect();

		const top = firstRect.top - contentRect.top;
		const height = lastRect.bottom - firstRect.top;

		indicator.style.top = `${top}px`;
		indicator.style.height = `${height}px`;
		indicator.style.opacity = "1";

		// 自动滚动到活动项
		if (firstActive) {
			this.scrollToActiveItem(firstActive);
		}
	}

	/**
	 * 滚动到活动项
	 */
	private scrollToActiveItem(activeItem: HTMLElement): void {
		if (!activeItem) return;

		const tocContainer = document
			.querySelector(`#${this.contentId}`)
			?.closest(".toc-scroll-container");
		if (!tocContainer) return;

		// 清除之前的定时器
		if (this.scrollTimeout) {
			clearTimeout(this.scrollTimeout);
		}

		// 使用节流机制
		this.scrollTimeout = window.setTimeout(() => {
			const containerRect = tocContainer.getBoundingClientRect();
			const itemRect = activeItem.getBoundingClientRect();

			// 只在元素不在可视区域时才滚动
			const isVisible =
				itemRect.top >= containerRect.top &&
				itemRect.bottom <= containerRect.bottom;

			if (!isVisible) {
				const itemOffsetTop = (activeItem as HTMLElement).offsetTop;
				const containerHeight = tocContainer.clientHeight;
				const itemHeight = activeItem.clientHeight;

				// 计算目标滚动位置，将元素居中显示
				const targetScroll =
					itemOffsetTop - containerHeight / 2 + itemHeight / 2;

				tocContainer.scrollTo({
					top: targetScroll,
					behavior: "smooth",
				});
			}
		}, 100);
	}

	/**
	 * 处理点击事件
	 */
	public handleClick(event: Event): void {
		event.preventDefault();
		const target = event.currentTarget as HTMLAnchorElement;
		const id = decodeURIComponent(
			target.getAttribute("href")?.substring(1) || "",
		);
		const targetElement = document.getElementById(id);

		if (targetElement) {
			const targetTop =
				targetElement.getBoundingClientRect().top +
				window.pageYOffset -
				this.scrollOffset;

			window.scrollTo({
				top: targetTop,
				behavior: "smooth",
			});
		}
	}

	/**
	 * 设置IntersectionObserver
	 */
	public setupObserver(): void {
		const headings = this.getAllHeadings();

		if (this.observer) {
			this.observer.disconnect();
		}

		this.observer = new IntersectionObserver(
			() => {
				this.updateActiveState();
			},
			{
				rootMargin: "0px 0px 0px 0px",
				threshold: 0,
			},
		);

		headings.forEach((heading) => {
			if (heading.id) {
				this.observer?.observe(heading);
			}
		});
	}

	/**
	 * 绑定点击事件
	 */
	public bindClickEvents(): void {
		this.tocItems.forEach((item) => {
			item.addEventListener("click", this.handleClick.bind(this));
		});
	}

	/**
	 * 清理
	 */
	public cleanup(): void {
		if (this.observer) {
			this.observer.disconnect();
			this.observer = null;
		}
		if (this.scrollTimeout) {
			clearTimeout(this.scrollTimeout);
			this.scrollTimeout = null;
		}
	}

	/**
	 * 初始化
	 */
	public init(): void {
		this.updateTOCContent();
		this.bindClickEvents();
		this.setupObserver();
		this.updateActiveState();
	}
}

/**
 * 检查是否为文章页面
 */
export function isPostPage(): boolean {
	return window.location.pathname.includes("/posts/");
}
</file>

<file path="utils/url-utils.ts">
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";

/**
 * 移除文件扩展名（.md, .mdx, .markdown）
 * 用于将 Astro v5 Content Layer API 的 id 转换为 URL 友好的 slug
 */
export function removeFileExtension(id: string): string {
	return id.replace(/\.(md|mdx|markdown)$/i, "");
}

export function pathsEqual(path1: string, path2: string) {
	const normalizedPath1 = path1.replace(/^\/|\/$/g, "").toLowerCase();
	const normalizedPath2 = path2.replace(/^\/|\/$/g, "").toLowerCase();
	return normalizedPath1 === normalizedPath2;
}

function joinUrl(...parts: string[]): string {
	const joined = parts.join("/");
	return joined.replace(/\/+/g, "/");
}

export function getPostUrlBySlug(slug: string): string {
	// 移除文件扩展名（如 .md, .mdx 等）
	const slugWithoutExt = removeFileExtension(slug);
	return url(`/posts/${slugWithoutExt}/`);
}

export function getTagUrl(tag: string): string {
	if (!tag) return url("/archive/");
	return url(`/archive/?tag=${encodeURIComponent(tag.trim())}`);
}

export function getCategoryUrl(category: string | null): string {
	if (
		!category ||
		category.trim() === "" ||
		category.trim().toLowerCase() === i18n(I18nKey.uncategorized).toLowerCase()
	)
		return url("/archive/?uncategorized=true");
	return url(`/archive/?category=${encodeURIComponent(category.trim())}`);
}

export function getDir(path: string): string {
	// 移除文件扩展名
	const pathWithoutExt = removeFileExtension(path);
	const lastSlashIndex = pathWithoutExt.lastIndexOf("/");
	if (lastSlashIndex < 0) {
		return "/";
	}
	return pathWithoutExt.substring(0, lastSlashIndex + 1);
}

export function getFileDirFromPath(filePath: string): string {
	return filePath.replace(/^src\//, "").replace(/\/[^/]+$/, "");
}

export function getSearchUrl(query: string): string {
	return url(`/search/?q=${encodeURIComponent(query.trim())}`);
}

export function url(path: string) {
	return joinUrl("", import.meta.env.BASE_URL, path);
}
</file>

</files>
